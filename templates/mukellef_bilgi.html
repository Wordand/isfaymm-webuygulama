{% extends "layout.html" %}
{% block title %}MÃ¼kellef Bilgileri{% endblock %}

{% block content %}
<div class="container py-4">
  <h4 class="text-center mb-4">ğŸ‘¤ MÃ¼kellef Bilgileri</h4>

  <table class="table table-striped table-hover align-middle mt-4 shadow-sm">
    <thead class="table-primary text-center">
      <tr>
        <th scope="col">Vergi Kimlik No</th>
        <th scope="col">Unvan</th>
        <th scope="col">Ä°ÅŸlemler</th>
      </tr>
    </thead>
    <tbody>
      {% for m in mukellefler %}
      <tr>
        <td>{{ m.vergi_kimlik_no }}</td>
        <td>{{ m.unvan }}</td>
        <td class="text-center">
          <button class="btn btn-success btn-sm" onclick="selectMukellef({{ m.id }}, '{{ m.unvan }}')">SeÃ§</button>
          <button class="btn btn-warning btn-sm"
            onclick="editMukellef({{ m.id }}, '{{ m.vergi_kimlik_no }}', '{{ m.unvan }}')">DÃ¼zenle</button>
          <button class="btn btn-danger btn-sm" onclick="deleteMukellef({{ m.id }})">Sil</button>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="3" class="text-center text-muted">HenÃ¼z mÃ¼kellef kaydÄ± bulunamadÄ±</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#mukellefModal">
    + Yeni MÃ¼kellef Ekle
  </button>
</div>

<!-- ğŸ§¾ MÃ¼kellef Modal -->
<div class="modal fade" id="mukellefModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">MÃ¼kellef Bilgisi</h5>
      </div>
      <div class="modal-body">
        <form id="mukellefForm">
          <input type="hidden" name="id" id="mukellef_id">
          <div class="mb-3">
            <label class="form-label">Vergi Kimlik No</label>
            <input type="text" name="vergi_kimlik_no" id="vkn" class="form-control" maxlength="11" required
              inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, '');">

          </div>
          <div class="mb-3">
            <label class="form-label">Unvan</label>
            <input type="text" name="unvan" id="unvan" class="form-control" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Ä°ptal</button>
        <button class="btn btn-primary" id="saveMukellef">Kaydet</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ğŸŸ© MÃ¼kellef seÃ§imi
  async function selectMukellef(id, unvan) {
    try {
      const resp = await fetch("/indirimlikurumlar/mukellef-sec", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
      });
      const res = await resp.json();

      if (res.status !== "success") {
        Swal.fire("Hata", res.message || "MÃ¼kellef seÃ§ilemedi.", "error");
        return;
      }

      const mukellefUnvan = unvan || res.unvan || "SeÃ§ilen MÃ¼kellef";

      // ğŸ”¹ Yeni belge mi mevcut belge mi?
      const result = await Swal.fire({
        title: `${mukellefUnvan}`,
        text: "Bu mÃ¼kellef iÃ§in yeni bir teÅŸvik belgesi mi oluÅŸturmak istiyorsunuz, yoksa mevcut bir belge Ã¼zerinde mi iÅŸlem yapacaksÄ±nÄ±z?",
        icon: "question",
        showDenyButton: true,
        confirmButtonText: "ğŸ†• Yeni Belge",
        denyButtonText: "ğŸ“„ Var Olan Belge"
      });

      if (result.isConfirmed) {
        // ğŸ†• Yeni belge oluÅŸturma akÄ±ÅŸÄ±
        const { value: formValues } = await Swal.fire({
          title: "Yeni Belge Bilgileri",
          html: `
            <input id="belgeNo" class="swal2-input" placeholder="Belge No giriniz">
            <input id="belgeTarihi" type="date" class="swal2-input">
          `,
          focusConfirm: false,
          preConfirm: () => {
            const belge_no = document.getElementById("belgeNo").value.trim();
            const belge_tarihi = document.getElementById("belgeTarihi").value.trim();
            if (!belge_no || !belge_tarihi) {
              Swal.showValidationMessage("âš ï¸ LÃ¼tfen hem Belge No hem de Belge Tarihi giriniz!");
              return false;
            }
            return { belge_no, belge_tarihi };
          },
          confirmButtonText: "OluÅŸtur",
          showCancelButton: true
        });

        if (formValues) {
          const newDoc = await fetch("/indirimlikurumlar/new_tesvik", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formValues)
          }).then(r => r.json());

          if (newDoc.status === "success") {
            sessionStorage.setItem("belge_no", formValues.belge_no);
            sessionStorage.setItem("belge_tarihi", formValues.belge_tarihi);

            Swal.fire({
              icon: "success",
              title: "Yeni Belge OluÅŸturuldu",
              text: "AÅŸama 1 ekranÄ±na yÃ¶nlendiriliyorsunuz...",
              showConfirmButton: false,
              timer: 1200
            });

            setTimeout(() => {
              location.href = `/indirimlikurumlar/?sekme=form&view=${newDoc.id}`;
            }, 1200);
          } else {
            Swal.fire("Hata", newDoc.message || "Belge oluÅŸturulamadÄ±.", "error");
          }
        }
      }

      else if (result.isDenied) {
        const docsResp = await fetch("/indirimlikurumlar/list_tesvik_docs");
        const docsData = await docsResp.json();

        if (!docsData.docs?.length) {
          Swal.fire("Bilgi", "Bu mÃ¼kellefe ait mevcut teÅŸvik belgesi bulunamadÄ±.", "info");
          return;
        }

        const inputOptions = {};
        docsData.docs.forEach(d => {
          inputOptions[d.id] = `${d.belge_no} (${d.belge_tarihi})`;
        });

        const { value: selectedId } = await Swal.fire({
          title: "Belge SeÃ§in",
          input: "select",
          inputOptions,
          inputPlaceholder: "Bir teÅŸvik belgesi seÃ§in",
          showCancelButton: true
        });

        if (selectedId) {
          location.href = `/indirimlikurumlar/?sekme=form&view=${selectedId}`;
        }
      }
    } catch (err) {
      console.error("âŒ MÃ¼kellef seÃ§me hatasÄ±:", err);
      Swal.fire("Hata", "Sunucu ile iletiÅŸim kurulamadÄ±.", "error");
    }
  }

  // ğŸ—‘ï¸ MÃ¼kellef silme
  function deleteMukellef(id) {
    Swal.fire({
      title: "Emin misiniz?",
      text: "Bu mÃ¼kellef tamamen silinecek!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Evet, sil",
      cancelButtonText: "Ä°ptal"
    }).then(r => {
      if (r.isConfirmed) {
        fetch("/indirimlikurumlar/mukellef-sil", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id })
        })
          .then(resp => resp.json())
          .then(data => {
            Swal.fire({
              icon: data.status,
              title: data.title || "MÃ¼kellef baÅŸarÄ±yla silindi.",
              text: data.message || ""
            }).then(() => {
              if (data.status === "success") {
                location.reload();
              }
            });
          })
          .catch(err => {
            console.error("Silme hatasÄ±:", err);
            Swal.fire("Hata", "Sunucuya baÄŸlanÄ±lamadÄ±.", "error");
          });
      }
    });
  }

  // âœï¸ MÃ¼kellef dÃ¼zenleme
  function editMukellef(id, vkn, unvan) {
    document.getElementById("mukellef_id").value = id;
    document.getElementById("vkn").value = vkn;
    document.getElementById("unvan").value = unvan;
    new bootstrap.Modal(document.getElementById("mukellefModal")).show();
  }

  // ğŸ’¾ Kaydet
  document.getElementById("saveMukellef").addEventListener("click", () => {
    // ğŸ’¡ 1. YÃ¼kleniyor durumunu gÃ¶ster
    Swal.fire({
      title: 'Kaydediliyor...',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    const data = {
      id: document.getElementById("mukellef_id").value,
      vergi_kimlik_no: document.getElementById("vkn").value,
      unvan: document.getElementById("unvan").value
    };

    const url = data.id
      ? "/indirimlikurumlar/mukellef-guncelle"
      : "/indirimlikurumlar/mukellef-ekle";


    // --- DoÄŸrulama Kontrolleri ---
    const vknValue = data.vergi_kimlik_no.trim();
    const unvanValue = data.unvan.trim();

    // VKN/TCKN KontrolÃ¼
    if (vknValue.length !== 10 && vknValue.length !== 11) {
      Swal.fire("UyarÄ±", "Vergi Kimlik No (VKN) veya T.C. Kimlik No (TCKN) 10 veya 11 haneli olmalÄ±dÄ±r.", "warning");
      return; // Ä°ÅŸlemi burada durdur.
    }

    // Unvan KontrolÃ¼
    if (unvanValue === "") {
      Swal.fire("UyarÄ±", "Unvan alanÄ± boÅŸ bÄ±rakÄ±lamaz.", "warning");
      return;
    }
    // --- DoÄŸrulama Kontrolleri Bitti ---


    fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    })
      .then(resp => {
        // Hata durumunda (400, 500) bile JSON okumaya Ã§alÄ±ÅŸ
        if (!resp.ok) {
          return resp.json().then(errorData => {
            throw new Error(errorData.message || `Sunucu HatasÄ±: ${resp.status}`);
          });
        }
        return resp.json();
      })
      .then(data => {
        // Modal'Ä± kapat
        const modalElement = document.getElementById("mukellefModal");
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (modalInstance) {
          modalInstance.hide();
        }

        // SweetAlert ile sonucu gÃ¶ster
        Swal.fire({
          icon: data.status, // Sunucudan gelen status: 'success' veya 'error'
          title: data.title || (data.status === "success" ? "Ä°ÅŸlem BaÅŸarÄ±lÄ±" : "Hata"),
          text: data.message || (data.status === "success" ? "MÃ¼kellef bilgisi baÅŸarÄ±yla kaydedildi." : "KayÄ±t iÅŸlemi sÄ±rasÄ±nda bir sorun oluÅŸtu."),
          showConfirmButton: false,
          timer: 1500
        }).then(() => {
          // BaÅŸarÄ±lÄ±ysa sayfayÄ± yenile
          if (data.status === "success") {
            location.reload();
          }
        });
      })
      .catch(err => {
        // AÄŸ, JSON parse veya sunucu tarafÄ±ndan fÄ±rlatÄ±lan hatayÄ± yakala
        Swal.fire("Hata", err.message || "Sunucu ile iletiÅŸim hatasÄ± oluÅŸtu.", "error");
        console.error("Kaydetme hatasÄ±:", err);
      });
  });
</script>

{% endblock %}