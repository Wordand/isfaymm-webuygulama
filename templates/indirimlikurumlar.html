{% extends "layout.html" %}
{% block title %}Ä°ndirimli Kurumlar Vergisi{% endblock %}

{% block content %}
<h3 class="text-center my-4">
  <i class="bi bi-bar-chart-fill"></i> Ä°ndirimli Kurumlar Vergisi
</h3>

<!-- ğŸ§¾ Aktif MÃ¼kellef Bilgisi -->
{% if session.get('aktif_mukellef_unvan') %}
<div id="aktifMukellefBox" class="alert alert-info mb-3 shadow-sm border-start border-3 border-primary">
  <strong>Aktif MÃ¼kellef:</strong>
  {{ session.get('aktif_mukellef_unvan') }}
  (<span>{{ session.get('aktif_mukellef_vkn') }}</span>)
</div>
{% else %}
<div id="aktifMukellefBox" class="alert alert-warning mb-3 shadow-sm border-start border-3 border-warning">
  HenÃ¼z bir mÃ¼kellef seÃ§ilmedi.
  <a href="{{ url_for('indirimlikurumlar.mukellef_bilgi') }}" class="alert-link">MÃ¼kellef SeÃ§</a>
</div>
{% endif %}


<ul class="nav nav-tabs mt-4 justify-content-center">

  <li class="nav-item">
    <a class="nav-link {% if sekme == 'form' %}active{% endif %}" href="?sekme=form">ğŸ§¾ Form GiriÅŸi</a>
  </li>

  <li class="nav-item">
    <a class="nav-link {% if sekme == 'ayrintili' %}active{% endif %}" href="?sekme=ayrintili">
      ğŸ“ˆ AyrÄ±ntÄ±lÄ± KazanÃ§ Hesaplama
    </a>
  </li>

  <li class="nav-item">
    <a class="nav-link {% if sekme=='tesvik' %}active{% endif %}" href="?sekme=tesvik">ğŸ“‚ TeÅŸvik Belgelerim</a>
  </li>


  <li class="nav-item">
    <a class="nav-link {% if sekme == 'mevzuat' %}active{% endif %}" href="?sekme=mevzuat">ğŸ“š Mevzuat</a>
  </li>
</ul>



<div class="mt-4">
  {% if sekme == 'tesvik' %}
  {% include 'tesvik.html' %}


  {% elif sekme == 'mevzuat' %}
  {% include 'mevzuat.html' %}


  {% elif sekme == 'form' %}
  <form id="form-giris" method="POST" action="{{ url_for('indirimlikurumlar.form_kaydet') }}" novalidate class="mx-auto"
    style="max-width: 600px;">

    <input type="hidden" name="mukellef_id" id="mukellef_id" value="{{ session.get('aktif_mukellef_id', '') }}">

    <input type="hidden" name="tesvik_id" id="tesvik_id"
      value="{{ edit_doc.id if edit_doc else (current_belge.id if current_belge else '') }}">

    <input type="hidden" name="belge_no_hidden" id="belge_no_hidden"
      value="{{ current_belge.belge_no if current_belge else '' }}">

    <input type="hidden" name="belge_tarihi_hidden" id="belge_tarihi_hidden"
      value="{{ current_belge.belge_tarihi if current_belge else '' }}">

    <input type="hidden" name="bolge_hidden" id="bolge_hidden"
      value="{{ current_belge.bolge if current_belge else '' }}">





    <!-- ğŸ§° Form Ä°ÅŸlem ButonlarÄ± -->
    <div class="mb-3 text-end">
      <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('kvUploadInput').click()">
        ğŸ“‚ PDFâ€™den Ä°Ã§e Aktar
      </button>
      <button type="button" class="btn btn-outline-danger ms-2" onclick="clearAllFormData()">
        ğŸ—‘ï¸ Verileri Temizle
      </button>
      <a href="{{ url_for('indirimlikurumlar.mukellef_bilgi') }}" class="btn btn-outline-secondary ms-2">
        â†©ï¸ MÃ¼kellef SeÃ§imine DÃ¶n
      </a>
    </div>

    <!-- ğŸ”„ AÅŸama Progress Bar -->
    <div class="progress mb-4" style="height: 25px;">
      <div id="progressBar" class="progress-bar progress-bar-striped bg-info" role="progressbar" style="width: 20%;"
        aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">
        AÅŸama <span id="current-stage-text">1</span>/7
      </div>
    </div>

    <input id="kvUploadInput" type="file" accept="application/pdf" style="display: none">

    <div id="step1" class="hidden-step" {% if session.get('aktif_mukellef_unvan') %} style="display:block;" {% else %}
      style="display:none;" {% endif %}>

      <h5>AÅŸama 1 - Temel Bilgiler</h5>

      <div class="mb-3">
        <label>YatÄ±rÄ±m TeÅŸvik Belgesi NumarasÄ±</label>
        <input type="text" id="belge_no" name="belge_no" class="form-control" required>
      </div>

      <div class="mb-3">
        <label>YatÄ±rÄ±ma BaÅŸlama Tarihi</label>
        <input type="date" id="baslangic_yili" name="belge_tarihi" class="form-control" required>
      </div>

      <div class="mb-3">
        <label>TeÅŸvik Belgesi Hangi Karara GÃ¶re DÃ¼zenlendi</label>
        <select id="karar" name="karar" onchange="handleKarar9903()" class="form-select" required>
          <option value="">SeÃ§iniz</option>
          <option value="2009/15199">2009/15199</option>
          <option value="2012/3305">2012/3305</option>
          <option value="2009/15199 (2012/3305 sayÄ±lÄ± BKK GeÃ§ici 2. Md.)">
            2009/15199 (2012/3305 sayÄ±lÄ± BKK GeÃ§ici 2. Md.)
          </option>
          <option value="2012/3305 (GeÃ§ici 8. Madde - 1950 sayÄ±lÄ± CumhurbaÅŸkanÄ± KararÄ±)">
            2012/3305 (GeÃ§ici 8. Madde - 1950 sayÄ±lÄ± CumhurbaÅŸkanÄ± KararÄ±)
          </option>
          <option value="2016/9495 (YatÄ±rÄ±mlara Proje BazlÄ± Devlet YardÄ±mÄ± Verilmesine Ä°liÅŸkin Karar)">
            2016/9495 (YatÄ±rÄ±mlara Proje BazlÄ± Devlet YardÄ±mÄ± Verilmesine Ä°liÅŸkin Karar)
          </option>
          <option value="2025/9903">2025/9903</option>
        </select>
      </div>


      <div class="mb-3">
        <label>YatÄ±rÄ±m TÃ¼rÃ¼nÃ¼ SeÃ§iniz (1)</label>
        <select id="yatirim_turu1" name="yatirim_turu1" class="form-select" onchange="toggleInvestmentIncomeInputs()"
          required>
          <option value="">SeÃ§iniz</option>
          <option value="Komple">Komple</option>
          <option value="Tevsi">Tevsi</option>
          <option value="Modernizasyon">Modernizasyon</option>
          <option value="Entegrasyon">Entegrasyon</option>
          <option value="ÃœrÃ¼n GeliÅŸtirme">ÃœrÃ¼n GeliÅŸtirme</option>
          <option value="DiÄŸer">DiÄŸer</option>
        </select>
      </div>

      <div class="mb-3">
        <label>YatÄ±rÄ±m TÃ¼rÃ¼nÃ¼ SeÃ§iniz (2)</label>
        <select id="yatirim_turu2" name="yatirim_turu2" class="form-select" required>
          <option value="">SeÃ§iniz</option>
          <option value="BÃ¶lgesel">BÃ¶lgesel</option>
          <option value="BÃ¼yÃ¼k Ã–lÃ§ekli">BÃ¼yÃ¼k Ã–lÃ§ekli</option>
          <option value="Stratejik">Stratejik</option>
          <option value="Ã–ncelikli YatÄ±rÄ±m">Ã–ncelikli YatÄ±rÄ±m</option>
          <option value="Proje BazÄ±nda Desteklenen YatÄ±rÄ±mlar (6745 SayÄ±lÄ± Kanun)">Proje BazÄ±nda Desteklenen YatÄ±rÄ±mlar
            (6745 SayÄ±lÄ± Kanun)</option>
        </select>
      </div>

      <div class="mb-4">
        <label>Program TÃ¼rÃ¼</label>
        <div class="input-group">
          <span class="input-group-text info-icon-styled" onclick="showInfo('programTuru')">
            <i class="bi bi-info-circle"></i>
          </span>
          <select name="program_turu" id="program_turu" class="form-select">
            <option value="">SeÃ§iniz</option>
            <option value="Teknoloji Hamlesi ProgramÄ±">Teknoloji Hamlesi ProgramÄ±</option>
            <option value="Yerel KalkÄ±nma Hamlesi ProgramÄ±">Yerel KalkÄ±nma Hamlesi ProgramÄ±</option>
            <option value="Stratejik Hamle ProgramÄ±">Stratejik Hamle ProgramÄ±</option>
            <option value="Ã–ncelikli YatÄ±rÄ±mlar TeÅŸvik Sistemi">Ã–ncelikli YatÄ±rÄ±mlar TeÅŸvik Sistemi</option>
            <option value="Hedef YatÄ±rÄ±mlar TeÅŸvik Sistemi">Hedef YatÄ±rÄ±mlar TeÅŸvik Sistemi</option>
          </select>
        </div>
      </div>





      <div class="mb-3">
        <label>Tamamlama Vizesi YapÄ±ldÄ± mÄ±?</label>
        <select name="vize_durumu" id="vize_durumu" class="form-select" required onchange="setOranlar()">
          <option value="">SeÃ§iniz</option>
          <option value="Evet - Ä°ÅŸletme DÃ¶neminde">Evet - Ä°ÅŸletme DÃ¶neminde</option>
          <option value="HayÄ±r - YatÄ±rÄ±m DÃ¶neminde">HayÄ±r - YatÄ±rÄ±m DÃ¶neminde</option>
        </select>
      </div>
      <button type="button" class="btn btn-primary" id="btn-step1-next">Devam â†’</button>
    </div>

    <div id="step2" class="hidden-step">
      <hr>
      <h5>AÅŸama 2 - Detaylar</h5>

      <div class="mb-3">
        <label>DÃ¶nem SeÃ§iniz</label>
        <select name="donem" id="donem" class="form-select" required onchange="setOranlar()">
          {% for yil in range(2025, 2014, -1) %}
          <optgroup label="{{ yil }}">
            <option value="{{ yil }} - 1. GEÃ‡Ä°CÄ°">{{ yil }} - 1. GEÃ‡Ä°CÄ°</option>
            <option value="{{ yil }} - 2. GEÃ‡Ä°CÄ°">{{ yil }} - 2. GEÃ‡Ä°CÄ°</option>
            <option value="{{ yil }} - 3. GEÃ‡Ä°CÄ°">{{ yil }} - 3. GEÃ‡Ä°CÄ°</option>
            <option value="{{ yil }} - KURUMLAR">{{ yil }} - KURUMLAR</option>
          </optgroup>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label>Yeniden DeÄŸerleme OranÄ± (%)</label>
        <input type="text" name="yeniden_degerleme_orani" id="yeniden_degerleme_orani" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Ä°li SeÃ§iniz</label>
        <select name="il" id="il" class="form-select" required onchange="setBolge()">
          {% for il in iller %}
          <option value="{{ il }}">{{ il }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label>BÃ¶lge</label>
        <input type="text" name="bolge" id="bolge" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>OSB Durumu</label>
        <select name="osb" id="osb" class="form-select" onchange="setOranlar()">
          <option value="OSB Ä°Ã§inde">OSB Ä°Ã§inde</option>
          <option value="OSB DÄ±ÅŸÄ±nda">OSB DÄ±ÅŸÄ±nda</option>
        </select>
      </div>

      <div class="row g-3 align-items-stretch mb-3">

        <!-- SOL BÄ°LGÄ° KUTUSU -->
        <div class="col-md-5 d-flex">
          <div class="ikv-info-box p-3 bg-light rounded-3 border flex-fill">
            <div class="fw-semibold mb-2">Ä°ndirimli KV OranlarÄ±</div>
            <ul class="list-unstyled small mb-0">
              <li class="d-flex justify-content-between">
                <span>Ä°hracat iÃ§in</span>
                <span id="ind_kv_ihr" class="fw-semibold">â€”%</span>
              </li>
              <li class="d-flex justify-content-between">
                <span>Ä°malat iÃ§in</span>
                <span id="ind_kv_iml" class="fw-semibold">â€”%</span>
              </li>
              <li class="d-flex justify-content-between">
                <span>DiÄŸer Gelirler iÃ§in</span>
                <span id="ind_kv_dig" class="fw-semibold">â€”%</span>
              </li>
            </ul>
          </div>
        </div>

        <!-- SAÄ KONTROLLER -->
        <div class="col-md-7">
          <div class="row g-3 h-100">
            <div class="col-12">
              <label class="form-label">YatÄ±rÄ±ma KatkÄ± OranÄ± (%)</label>
              <div class="input-group fullheight-group">
                <input type="text" name="katki_orani" id="katki_orani" class="form-control" readonly>
                <span class="input-group-text">%</span>
                <button type="button" class="btn btn-outline-secondary" id="btn-manual-katki">Manuel Belirle</button>
              </div>
            </div>

            <div class="col-12">
              <label class="form-label">Vergi Ä°ndirim OranÄ± (%)</label>
              <div class="input-group fullheight-group">
                <input type="text" name="vergi_orani" id="vergi_orani" class="form-control" readonly>
                <span class="input-group-text">%</span>
                <button type="button" class="btn btn-outline-secondary" id="btn-manual-vergi">Manuel Belirle</button>
              </div>
            </div>
          </div>
        </div>

      </div>


      <div class="mb-4">
        <label>DiÄŸer KazanÃ§lara Uygulanacak Oran (%)</label>
        <div class="input-group">
          <span class="input-group-text info-icon-styled" onclick="showInfo('digeroran')">
            <i class="bi bi-info-circle"></i>
          </span>
          <input type="text" name="diger_oran" id="diger_oran" class="form-control" readonly>
        </div>
      </div>

      <!-- ğŸ”¹ ButonlarÄ± ayrÄ± bir satÄ±ra al -->
      <div class="mt-3">
        <button type="button" class="btn btn-secondary me-2" onclick="goToStep1()">â† Geri</button>
        <button type="button" class="btn btn-primary" onclick="goToStep3()">Devam</button>
      </div>
    </div>






    <div id="step3" class="hidden-step">
      <h5>AÅŸama 3 - YatÄ±rÄ±m Bilgileri</h5>

      <div class="mb-3">
        <label>Toplam YatÄ±rÄ±m TutarÄ±nÄ± Giriniz</label>
        <input type="text" name="toplam_tutar" id="toplam_tutar" class="form-control" placeholder="Tutar Giriniz">
      </div>

      <div class="mb-3">
        <label>Toplam YatÄ±rÄ±ma KatkÄ± TutarÄ±</label>
        <input type="text" name="katki_tutari" id="katki_tutari" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>DiÄŸer Faaliyetlerden Elde Edilen KazanÃ§lar Ä°Ã§in KatkÄ± TutarÄ±</label>
        <div class="input-group">
          <span class="input-group-text info-icon-styled" onclick="showInfo('digerkatkitutari')">
            <i class="bi bi-info-circle"></i>
          </span>
          <input type="text" name="diger_katki_tutari" id="diger_katki_tutari" class="form-control" readonly>
        </div>
      </div>

      <div class="mb-3">
        <label>Cari YÄ±lda Fiilen GerÃ§ekleÅŸtirilen YatÄ±rÄ±m HarcamasÄ± TutarÄ±nÄ± Giriniz</label>
        <input type="text" name="cari_harcama_tutari" id="cari_harcama_tutari" class="form-control"
          placeholder="Tutar Giriniz">
      </div>

      <div class="mb-3">
        <label>YatÄ±rÄ±mÄ±n BaÅŸlangÄ±cÄ±ndan Ä°tibaren Fiilen GerÃ§ekleÅŸtirilen YatÄ±rÄ±m HarcamasÄ± TutarÄ±nÄ± Giriniz</label>
        <input type="text" name="toplam_harcama_tutari" id="toplam_harcama_tutari" class="form-control"
          placeholder="Tutar Giriniz">
      </div>

      <div class="mb-3">
        <label>Fiili YatÄ±rÄ±m HarcamasÄ± Nedeniyle Hak KazanÄ±lan YatÄ±rÄ±ma KatkÄ± TutarÄ±</label>
        <input type="text" name="fiili_katki_tutari" id="fiili_katki_tutari" class="form-control" readonly>
      </div>

      <button type="button" class="btn btn-secondary me-2" onclick="goToStep2()">â† Geri</button>
      <button type="button" class="btn btn-primary" onclick="goToStep4()">Devam</button>

    </div>

    <div id="step4" class="hidden-step">
      <h5>AÅŸama 4 - Hesaplamalar</h5>

      <div class="mb-3">
        <label>Ã–nceki DÃ¶nemlerde YararlanÄ±lan YatÄ±rÄ±ma KatkÄ± TutarÄ±nÄ± Giriniz<br>
          (<span class="text-primary fw-bold">YatÄ±rÄ±mdan Elde Edilen KazanÃ§ DolayÄ±sÄ±yla</span>)
          <input type="text" name="onceki_yatirim_katki_tutari" id="onceki_yatirim_katki_tutari" class="form-control"
            placeholder="Tutar Giriniz">
      </div>

      <div class="mb-3">
        <label>Ã–nceki DÃ¶nemlerde YararlanÄ±lan YatÄ±rÄ±ma KatkÄ± TutarÄ±nÄ± Giriniz<br>
          (<span class="text-success fw-bold">DiÄŸer Faaliyetlerden Elde Edilen KazanÃ§ DolayÄ±sÄ±yla</span>)
          <input type="text" name="onceki_diger_katki_tutari" id="onceki_diger_katki_tutari" class="form-control"
            placeholder="Tutar Giriniz">
      </div>

      <div class="mb-3">
        <label>Ã–nceki DÃ¶nemlerde YararlanÄ±lan Toplam YatÄ±rÄ±ma KatkÄ± TutarÄ±</label>
        <input type="text" name="onceki_katki_tutari" id="onceki_katki_tutari" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Cari Hesaplama Ã–ncesi Kalan KatkÄ± TutarÄ±</label>
        <input type="text" name="kalan_katki_tutari" id="kalan_katki_tutari" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>EndekslenmiÅŸ Tutarlar Dahil Fiili YatÄ±rÄ±m HarcamasÄ± Nedeniyle<br>
          Hak KazanÄ±lan YatÄ±rÄ±ma KatkÄ± TutarÄ±</label>
        <input type="text" name="endeks_katki_tutari" id="endeks_katki_tutari" class="form-control" readonly>
      </div>

      <button type="button" class="btn btn-secondary me-2" onclick="goToStep3()">â† Geri</button>
      <button type="button" class="btn btn-primary" onclick="goToStep5()">Devam</button>
    </div>

    <div id="step5" class="hidden-step">
      <h5 class="mb-4">AÅŸama 5 - YatÄ±rÄ±m Bilgileri</h5>

      <div class="mb-3">
        <label>YatÄ±rÄ±mdan Elde Edilen KazanÃ§ (TL):</label>
        <input type="text" name="yatirimdan_elde_edilen_kazanc" id="yatirimdan_elde_edilen_kazanc" class="form-control"
          placeholder="0,00 TL">
      </div>




      <div class="mb-3">
        <label>Ticari BilanÃ§o KarÄ±nÄ± Giriniz (TL):</label>
        <input type="text" name="ticari_bilanco_kari" id="ticari_bilanco_kari" class="form-control"
          placeholder="0,00 TL" oninput="calculateTevsiKazancAutomatically()">

      </div>

      <div class="mb-3">
        <label>KKEG Giriniz (TL):</label>
        <input type="text" name="kkeg" id="kkeg" class="form-control" placeholder="0,00 TL">
      </div>

      <div class="mb-3">
        <label>Kurumlar Vergisi MatrahÄ± (TL)</label>
        <div class="input-group">
          <input type="text" name="kv_matrah" id="kv_matrah" class="form-control" placeholder="0,00 TL" readonly>
          <button type="button" class="btn btn-outline-secondary" id="btn-manual-matrah">
            Manuel Belirle
          </button>
        </div>
      </div>




      <div class="mb-3">
        <label>GerÃ§ekleÅŸen Tevsi YatÄ±rÄ±m TutarÄ±nÄ± Giriniz (TL):</label>
        <input type="text" name="gerceklesen_tevsi_yatirim_tutari" id="gerceklesen_tevsi_yatirim_tutari"
          class="form-control" placeholder="0,00 TL" oninput="calculateTevsiKazancAutomatically()">
      </div>



      <div class="mb-3">
        <label>Toplam Sabit KÄ±ymet TutarÄ±nÄ± Giriniz (TL):</label>
        <div class="input-group">
          <span class="input-group-text info-icon-styled" onclick="showInfo('toplamSabitKiymetTutari')">
            <i class="bi bi-info-circle"></i>
          </span>
          <input type="text" name="toplam_sabit_kiymet_tutari" id="toplam_sabit_kiymet_tutari" class="form-control"
            placeholder="0,00 TL" oninput="calculateTevsiKazancAutomatically()">
        </div>
      </div>


      <div class="mb-3">
        <label>Tevsi YatÄ±rÄ±mlardan Elde Edilen KazanÃ§ TutarÄ± (TL):</label>
        <div class="input-group">
          <span class="input-group-text info-icon-styled" onclick="showInfo('tevsiYatirimdanEldeEdilenKazancTutari')">
            <i class="bi bi-info-circle"></i>
          </span>
          <input type="text" name="tevsi_yatirim_kazanci" id="tevsi_yatirim_kazanci" class="form-control"
            placeholder="0,00 TL" readonly>
        </div>
      </div>

      <button type="button" class="btn btn-secondary me-2" onclick="goToStep4()">â† Geri</button>
      <button type="button" class="btn btn-primary" onclick="goToStep6()">Devam</button>
    </div>

    <div id="step6" class="hidden-step">
      <h5>AÅŸama 6 â€“ SatÄ±ÅŸ & Faaliyet DaÄŸÄ±lÄ±mÄ±</h5>

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="useDetailedProfitRatios" name="use_detailed_profit_ratios"
          onchange="toggleDetailedProfitInput()">
        <label class="form-check-label" for="useDetailedProfitRatios">
          ğŸ“ˆ AyrÄ±ntÄ±lÄ± KazanÃ§ DaÄŸÄ±lÄ±mÄ±nÄ± Kullan
        </label>
      </div>

      <div class="mb-3">
        <label>BrÃ¼t SatÄ±ÅŸlar</label>
        <input type="text" name="brut_satis" id="brut_satis" class="form-control" placeholder="Tutar Giriniz">
      </div>
      <div class="mb-3 row">
        <div class="col">
          <label>Ä°hracat Faaliyeti</label>
          <input type="text" name="ihracat" id="ihracat" class="form-control" placeholder="Tutar Giriniz"
            oninput="calculateRatios()">
        </div>
        <div class="col-auto align-self-end">
          <span id="ratio_ihracat">â€”%</span>
        </div>
      </div>
      <div class="mb-3 row">
        <div class="col">
          <label>Ä°malat Faaliyeti</label>
          <input type="text" name="imalat" id="imalat" class="form-control" placeholder="Tutar Giriniz"
            oninput="calculateRatios()">
        </div>
        <div class="col-auto align-self-end">
          <span id="ratio_imalat">â€”%</span>
        </div>
      </div>
      <div class="mb-3 row">
        <div class="col">
          <label>DiÄŸer Faaliyetler</label>
          <input type="text" name="diger_faaliyet" id="diger_faaliyet" class="form-control" placeholder="Tutar Giriniz"
            oninput="calculateRatios()">
        </div>
        <div class="col-auto align-self-end">
          <span id="ratio_diger">â€”%</span>
        </div>
      </div>



      <button type="button" class="btn btn-secondary me-2" onclick="goToStep5('from6')">â† Geri</button>
      <button id="calculateCariBtn" type="button" class="btn btn-primary">
        CARÄ° KATKI TUTARINI HESAPLA
      </button>

      <div class="mt-5 d-flex justify-content-center">
        <a href="?sekme=ayrintili" class="btn btn-lg text-white text-decoration-none
                                        px-5 py-3 rounded-pill btn-gradient-hover shadow-lg">
          <i class="bi bi-pie-chart-fill me-2"></i>
          KazanÃ§ DaÄŸÄ±lÄ±mÄ±nÄ± <br class="d-none d-md-block">
          AyrÄ±ntÄ±lÄ± Olarak Hesaplamak Ä°stiyorum
          <i class="bi bi-arrow-right ms-2"></i>
        </a>
      </div>
    </div>

    <div id="step7" class="hidden-step">
      <h5>AÅŸama 7 - SonuÃ§lar & Kaydet</h5>


      <div class="mb-3">
        <label>Cari DÃ¶nemde YararlanÄ±lan YatÄ±rÄ±ma KatkÄ± TutarÄ± (YatÄ±rÄ±mdan Elde Edilen KazanÃ§ DolayÄ±sÄ±yla)</label>
        <input type="text" id="cari_yatirim_katki" name="cari_yatirim_katki" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Cari DÃ¶nemde YararlanÄ±lan YatÄ±rÄ±ma KatkÄ± TutarÄ± (DiÄŸer Faaliyetlerden Elde Edilen Gelirler
          DolayÄ±sÄ±yla)</label>
        <input type="text" id="cari_diger_katki" name="cari_diger_katki" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Cari DÃ¶nemde YararlanÄ±lan Toplam YatÄ±rÄ±ma KatkÄ± TutarÄ±</label>
        <input type="text" id="cari_toplam_katki" name="cari_toplam_katki" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Cari DÃ¶nem Dahil Olmak Ãœzere YararlanÄ±lan Toplam YatÄ±rÄ±ma KatkÄ± TutarÄ±</label>
        <input type="text" id="genel_toplam_katki" name="genel_toplam_katki" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Ä°ndirimli Kurumlar Vergisi MatrahÄ±</label>
        <input type="text" id="indirimli_matrah" name="indirimli_matrah" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Ä°ndirimli Kurumlar Vergisi</label>
        <input type="text" id="indirimli_kv" name="indirimli_kv" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Ä°ndirimli Kurumlar Vergisi OranÄ± %</label>
        <input type="text" id="indirimli_kv_oran" name="indirimli_kv_oran" class="form-control" readonly>
      </div>


      <div class="d-flex justify-content-start gap-2 mt-4">
        <button type="button" class="btn btn-secondary" onclick="goToStep6()">â† Geri</button>

        <button type="submit" class="btn btn-primary" onclick="submitFullFormAndDonem()">
          ğŸ’¾ Kaydet / GÃ¼ncelle
        </button>
      </div>

    </div>
  </form>

  {% elif sekme == 'ayrintili' %}
  <div class="text-center my-4">
    <a href="?sekme=form#step6" class="btn btn-outline-secondary btn-lg text-decoration-none">
      â† AÅŸama 6â€™ya Geri DÃ¶n
    </a>
  </div>

  <h3 class="text-center my-4">ğŸ“Š AyrÄ±ntÄ±lÄ± KazanÃ§ Hesaplama</h3>

  <form method="POST" class="mb-4" id="ayrintili-kazanc-form"
    action="{{ url_for('indirimlikurumlar.ayrintili_kazanc') }}">
    <div class="d-flex justify-content-between mb-3">
      <button name="export" class="btn btn-success" type="submit" value="1">
        ğŸ“¤ DÄ±ÅŸa Aktar
      </button>
    </div>

    <table class="table table-striped table-bordered" id="ayrintili-kazanc-table">
      <thead class="table-light">
        <tr>
          <th>AÃ§Ä±klama</th>
          <th>Toplam HasÄ±lat (B)</th>
          <th>Ä°hracat (C)</th>
          <th>Ä°malat (D)</th>
          <th>DiÄŸer (E)</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        {# parantez iÃ§indeki kodu al #}
        {% set code = row['AÃ§Ä±klama'].split('(')[-1].split(')')[0] %}
        <tr>
          <td class="
                                {% if code|length == 3 %}
                                    text-end
                                {% else %}
                                    text-start fw-bold
                                {% endif %}
                            ">
            {{ row['AÃ§Ä±klama'] }}
          </td>

          <td><input name="B_{{ loop.index0 }}" class="form-control form-control-sm text-end" value="{{ row['B'] }}"
              placeholder="Tutar Giriniz" {% if loop.index0 in
              [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54]
              %}readonly{% endif %}></td>
          <td><input name="C_{{ loop.index0 }}" class="form-control form-control-sm text-end" value="{{ row['C'] }}"
              placeholder="Tutar Giriniz" {% if loop.index0 in [0,1,5,9,10,15,16,20,21,22,23,34,42,45,46,49,53,54]
              %}readonly{% endif %}></td>
          <td><input name="D_{{ loop.index0 }}" class="form-control form-control-sm text-end" value="{{ row['D'] }}"
              placeholder="Tutar Giriniz" {% if loop.index0 in [0,1,5,9,10,15,16,20,21,22,23,34,42,45,46,49,53,54]
              %}readonly{% endif %}></td>
          <td><input name="E_{{ loop.index0 }}" class="form-control form-control-sm text-end" value="{{ row['E'] }}"
              placeholder="Tutar Giriniz" {% if loop.index0 in [0,1,5,9,10,15,16,20,21,22,23,34,42,45,46,49,53,54]
              %}readonly{% endif %}></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="text-center mt-4">
      <button type="submit" class="btn btn-lg btn-outline-primary" id="save-ayrintili-kazanc">ğŸ’¾ Kaydet</button> {# ID
      eklendi #}
      <button type="button" class="btn btn-lg btn-danger ms-2" id="clearProfitData">ğŸ—‘ï¸ TÃ¼mÃ¼nÃ¼ Temizle</button>
    </div>
  </form>
  {% endif %}
</div>


<style>
  #step1,
  #step2,
  #step3,
  #step4,
  #step5,
  #step6,
  #step7 {
    transition: opacity 0.4s ease-in-out, visibility 0.4s ease-in-out;
    opacity: 1;
    visibility: visible;
  }

  .hidden-step {
    display: none !important;
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none;
    position: absolute;
  }

  .fullheight-group .form-control,
  .fullheight-group .input-group-text,
  .fullheight-group .btn {
    height: 44px;
  }

  .ikv-info-box {
    display: flex;
    flex-direction: column;
    justify-content: center;
    /* kutu iÃ§eriÄŸini ortala */
  }
</style>

<script>


  let programmaticMaskUpdate = false;
  let RESTORE_MODE = false;

  const maskMap = {};
  const userTyped = {};

  // 2) MASK INPUT CONFIG
  const idConfig = {
    "toplam_tutar": "katki",
    "cari_harcama_tutari": "katki",
    "toplam_harcama_tutari": "katki",
    "brut_satis": "ratios",
    "ihracat": "ratios",
    "imalat": "ratios",
    "diger_faaliyet": "ratios",
    "gerceklesen_tevsi_yatirim_tutari": "tevsi",
    "toplam_sabit_kiymet_tutari": "tevsi",
    "ticari_bilanco_kari": "kv",
    "kkeg": "kv",

    // SAFE OUTPUTS â†’ hesaplayÄ±cÄ±lar tarafÄ±ndan yazÄ±lÄ±r, mask tetiklemez
    "tevsi_yatirim_kazanci": "none",
    "katki_tutari": "none",
    "diger_katki_tutari": "none",
    "fiili_katki_tutari": "none",
    "onceki_katki_tutari": "none",
    "kalan_katki_tutari": "none",
    "endeks_katki_tutari": "none",
  };





  // 5) Tevsi IMask referansÄ±
  let tevsiMask = null;


  const bolgeMap = {{ bolge_json | tojson }};
  const katkilar = {{ katkilar_json | tojson }};
  const vergiler = {{ vergiler_json | tojson }};
  const initialRatios = {{ initial_ayrintili_ratios | tojson }};
  const bolgeMap9903 = {{ BOLGE_MAP_9903 | tojson | safe }};
  const katkilar9903 = {{ TESVIK_KATKILAR_9903 | tojson | safe }};
  const yenidenDegerlemeOranlari = {
    "2025 - 3. GEÃ‡Ä°CÄ°": 0,
    "2025 - 2. GEÃ‡Ä°CÄ°": 9.23,
    "2025 - 1. GEÃ‡Ä°CÄ°": 3.30,
    "2025 - KURUMLAR": 0,
    "2024 - 3. GEÃ‡Ä°CÄ°": 34.14,
    "2024 - 2. GEÃ‡Ä°CÄ°": 22.20,
    "2024 - 1. GEÃ‡Ä°CÄ°": 7.55,
    "2024 - KURUMLAR": 43.93,
    "2023 - KURUMLAR": 58.46,
    "2022 - KURUMLAR": 122.93,
    "2021 - KURUMLAR": 36.20,
    "2020 - KURUMLAR": 9.11
  };

  let debounceTimeout = null;
  let isProgrammaticChange = false; // Yeni bayrak: Programatik deÄŸiÅŸiklik mi?


  // AÅŸamalarÄ± temsil eden dizi (global olarak tanÄ±mlÄ±, bu kod bloÄŸunun baÅŸÄ±nda olmalÄ±)
  const ALL_STEPS_IDS = ["step1", "step2", "step3", "step4", "step5", "step6", "step7"];
  const TOTAL_STEPS = 7; // Toplam aÅŸama sayÄ±sÄ±

  let CURRENT_STEP = 1; // Nereden geldiÄŸimizi takip etmek iÃ§in



  function safeSet(id, val) {
    const el = document.getElementById(id);
    if (!el) return;

    const mask = maskMap[id];

    // ğŸš« MASK Eventâ€™lerini kapat
    programmaticMaskUpdate = true;

    if (mask) {
      mask.unmaskedValue = String(val);
      mask.updateValue();
    } else {
      el.value = Number(val).toLocaleString("tr-TR", {
        minimumFractionDigits: 2
      });
    }

    // âœ” MASK Eventâ€™lerini aÃ§
    setTimeout(() => {
      programmaticMaskUpdate = false;
    }, 0);
  }



  // === Global Format FonksiyonlarÄ± ===
  function formatTL(num) {
    if (isNaN(num) || num === null) return "0,00";
    return Number(num)
      .toFixed(2)
      .replace(".", ",")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  // ğŸ”¹ Binlik ve ondalÄ±k ayraÃ§larÄ± doÄŸru analiz eden versiyon
  function parseFormattedNumber(value) {
    if (!value) return 0;
    let v = value.toString().trim();

    // % veya TL simgelerini temizle
    v = v.replace(/[%â‚º\s]/g, '');

    const dotCount = (v.match(/\./g) || []).length;
    const commaCount = (v.match(/,/g) || []).length;

    // ğŸ”¹ 1) Hem . hem , varsa â†’ nokta binlik, virgÃ¼l ondalÄ±k
    if (dotCount > 0 && commaCount > 0) {
      v = v.replace(/\./g, '').replace(',', '.');
    }
    // ğŸ”¹ 2) Sadece virgÃ¼l varsa â†’ ondalÄ±k
    else if (commaCount > 0) {
      v = v.replace(',', '.');
    }
    // ğŸ”¹ 3) Sadece nokta varsa ama birden fazla nokta varsa â†’ binlik
    else if (dotCount > 1) {
      v = v.replace(/\./g, '');
    }
    // ğŸ”¹ 4) Tek nokta var ama sonunda 3 hane varsa â†’ binlik (Ã¶r: 10.000)
    else if (dotCount === 1 && v.match(/\.\d{3}$/)) {
      v = v.replace(/\./g, '');
    }
    // ğŸ”¹ 5) Tek nokta + 1-2 hane varsa â†’ ondalÄ±k (Ã¶r: 10.25)
    // else if -> no change

    const num = parseFloat(v);
    return isNaN(num) ? 0 : num;
  }


  function normalizeBN(s) { return (s || '').replace(/\D/g, ''); }

  function convertToInputDateFormat(t) {
    const p = (t || '').split('/');
    return p.length === 3 ? `${p[2]}-${p[1].padStart(2, '0')}-${p[0].padStart(2, '0')}` : t;
  }




  function showSwalMessage(type, title, text) {
    Swal.fire({
      icon: type,
      title: title,
      text: text,
      timer: 3000,
      toast: true,
      position: "top-end",
      showConfirmButton: false
    });
  }

  function showInfo(key) {
    let title = "Bilgilendirme";
    let message = "Bilgi mesajÄ± mevcut deÄŸil.";
    let icon = "info";
    const createJustifiedMessage = (text) => `<div style='text-align: justify;'>${text}</div>`;
    switch (key) {
      case 'yatirimaBaslamaTarihi':
        message = createJustifiedMessage(
          "<b>YatÄ±rÄ±ma BaÅŸlama Tarihi</b> olarak, YatÄ±rÄ±m TeÅŸvik Belgesi ekinde yer alan 'yatÄ±rÄ±ma baÅŸlama tarihi' esas alÄ±nmalÄ±dÄ±r. <br><br>" +
          "<i>Ã–nemli Not:</i> EÄŸer belgede birden fazla tarih varsa, genellikle yatÄ±rÄ±mÄ±n fiilen baÅŸladÄ±ÄŸÄ± veya belgenin onaylandÄ±ÄŸÄ± tarih kullanÄ±lÄ±r."
        );
        break;

      case 'programTuru':
        title = "2025/9903 GÃ¼ncel Karara Ä°liÅŸkin Bilgilendirme";
        message = createJustifiedMessage(
          "<b>NOT:</b> Kurumlar vergisi oranÄ±, yatÄ±rÄ±m teÅŸvik belgesi kapsamÄ±nda gerÃ§ekleÅŸtirilen yatÄ±rÄ±mlardan elde edilen kazanÃ§lara, " +
          "yatÄ±rÄ±mÄ±n kÄ±smen veya tamamen iÅŸletilmesine baÅŸlanÄ±lan hesap dÃ¶neminden itibaren " +
          "yatÄ±rÄ±ma katkÄ± tutarÄ±na ulaÅŸÄ±ncaya kadar, indirim hakkÄ±nÄ±n kullanÄ±labileceÄŸi ilk hesap dÃ¶nemi dahil " +
          "en fazla <b>10 hesap dÃ¶nemi</b> boyunca <b>%60 indirimli</b> olarak uygulanÄ±r.<br><br>" +

          "Ä°ndirim hakkÄ±nÄ±n kullanÄ±labileceÄŸi ilk hesap dÃ¶nemi dahil en fazla on hesap dÃ¶nemine iliÅŸkin sÄ±nÄ±rlama, " +
          "<b>16/6/2025</b> tarihinden Ã¶nce baÅŸvurusu yapÄ±lmÄ±ÅŸ ve reddedilmemiÅŸ olanlar hariÃ§, " +
          "<b>24/7/2025</b> tarihinden itibaren (bu tarih dahil) alÄ±nan yatÄ±rÄ±m teÅŸvik belgeleri yÃ¶nÃ¼nden geÃ§erli olacaktÄ±r.<br><br>" +

          "<b>NOT:</b> KazanÃ§ bulunmasÄ±na raÄŸmen yararlanÄ±lmayan yatÄ±rÄ±ma katkÄ± tutarlarÄ± mÃ¼teakip dÃ¶nemlerde dikkate alÄ±nmaz.<br><br>" +
          "Buna gÃ¶re, ilgili hesap dÃ¶nemlerinde faydalanma imkÃ¢nÄ± bulunmakta iken, " +
          "<b>faydalanÄ±lmayan yatÄ±rÄ±ma katkÄ± tutarlarÄ±nÄ±n izleyen dÃ¶nemlerde kullanÄ±lmasÄ± mÃ¼mkÃ¼n deÄŸildir.</b>"
        );
        break;

      case 'digeroran':
        message = createJustifiedMessage(
          "YatÄ±rÄ±m dÃ¶neminde diÄŸer faaliyetlerden elde edilen kazanÃ§larda indirimli kurumlar vergisi uygulanmasÄ± mÃ¼mkÃ¼ndÃ¼r."
        );
        break;


      case 'digerkatkitutari':
        message = createJustifiedMessage(
          "MÃ¼kellefler, yatÄ±rÄ±m teÅŸvik belgeleri kapsamÄ±ndaki yatÄ±rÄ±mlarÄ±na fiilen baÅŸladÄ±klarÄ± tarihten itibaren, hesaplanacak yatÄ±rÄ±ma katkÄ± tutarÄ±na mahsuben; <br><br>" +
          "a) Toplam yatÄ±rÄ±ma katkÄ± tutarÄ±nÄ±n Bakanlar Kurulu KararÄ± ile belirlenen oranÄ±nÄ± geÃ§memek ve <br><br>" +
          "b) GerÃ§ekleÅŸtirilen yatÄ±rÄ±m harcamasÄ± tutarÄ±nÄ± aÅŸmamak <br><br>" +
          "Ã¼zere, yatÄ±rÄ±m dÃ¶neminde diÄŸer faaliyetlerinden elde ettikleri kazanÃ§larÄ±na indirimli kurumlar vergisi uygulanabilecektir."
        );
        break;


      case 'toplamSabitKiymetTutari':
        message = createJustifiedMessage(
          "<b>Toplam Sabit KÄ±ymet TutarÄ±</b> ifadesinden, Amortisman mevzuunu oluÅŸturan iktisadi kÄ±ymetlerin anlaÅŸÄ±lmasÄ± gerekir.<br><br>" +
          "DolayÄ±sÄ±yla boÅŸ arazi-arsa ve amortismana tabi olmayan diÄŸer kÄ±ymetlerle ilgili tutarlar bu hesaplamada dikkate alÄ±nmaz.<br><br>" +
          "Sabit KÄ±ymet tutarÄ±nÄ±n hesabÄ±nda bu kÄ±ymetlerin BÄ°RÄ°KMÄ°Å AMORTÄ°SMAN DÃœÅÃœLMEDEN Ã¶nceki brÃ¼t tutarlarÄ±nÄ±n dikkate alÄ±nmasÄ± gerekmektedir.<br><br>" +
          "Bu hesaplama sÄ±rasÄ±nda iÅŸletme aktifinde yer alan sabit kÄ±ymetlerin kayÄ±tlÄ± deÄŸeri olarak, yapÄ±lan ENFLASYON DÃœZELTMESÄ° SONUCU oluÅŸan deÄŸerleri dikkate alÄ±nacaktÄ±r."
        );
        break;

      case 'tevsiYatirimdanEldeEdilenKazancTutari':
        message = createJustifiedMessage(
          "Tevsi yatÄ±rÄ±mlardan elde edilen kazancÄ±n ayrÄ± hesaplarda izlenmek suretiyle tespit edilebilmesi halinde, bu kazanca indirimli vergi oranÄ± uygulanacaktÄ±r. <br><br>" +
          "KazancÄ±n ayrÄ± bir ÅŸekilde tespit edilememesi halinde ise; <br><br>" +
          "Tevsi yatÄ±rÄ±m dolayÄ±sÄ±yla indirimli vergi oranÄ± uygulanacak kazanÃ§ = (GerÃ§ekleÅŸen Tevsi YatÄ±rÄ±m TutarÄ± / Toplam Sabit KÄ±ymet TutarÄ±) X Ticari bilanÃ§o KarÄ± <br><br>" +
          "Tevsi yatÄ±rÄ±mlardan elde edilen kazancÄ±n bu ÅŸekilde oranlama yapÄ±lmak suretiyle belirlenmesi seÃ§imlik bir hak olmayÄ±p, indirimli kurumlar vergisi uygulanacak kazancÄ±n ayrÄ± hesaplarda izlenmek suretiyle mÃ¼kellefÃ§e tespit edilmesi esastÄ±r."
        );
        break;

      default: // VarsayÄ±lan durum: EÄŸer tanÄ±msÄ±z bir anahtar gelirse
        message = "Bu alan hakkÄ±nda bilgi bulunmamaktadÄ±r.";
        icon = "warning"; // VarsayÄ±lan durum iÃ§in uyarÄ± ikonu
        break;
    }
    // SweetAlert mesajÄ±nÄ± gÃ¶ster
    Swal.fire({
      icon: icon, // 'info' ikonu kullanÄ±lacak
      title: title,
      html: message,
      position: 'center', // EkranÄ±n ortasÄ±nda gÃ¶ster
      showCloseButton: true, // Kapatma butonu gÃ¶ster
      showConfirmButton: true, // "Tamam" butonu gÃ¶sterme
      timer: undefined, // Otomatik kapanma kapalÄ±
      toast: false, // Toast modu kapalÄ±
      allowOutsideClick: true, // DÄ±ÅŸarÄ±ya tÄ±klayÄ±nca kapanmasÄ±na izin ver
      allowEscapeKey: true, // ESC tuÅŸuyla kapanmasÄ±na izin ver

      width: '55em',              // Kutuyu geniÅŸletir
      scrollbarPadding: false,    // Sayfa kaymasÄ±nÄ± Ã¶nler
      heightAuto: false,

      // YENÄ° EKLENEN customClass Ã–ZELLÄ°KLERÄ°
      customClass: {
        popup: 'swal2-green-theme-popup', // TÃ¼m kutu iÃ§in
        header: 'swal2-green-theme-header', // BaÅŸlÄ±k alanÄ± iÃ§in
        title: 'swal2-green-theme-title', // BaÅŸlÄ±k metni iÃ§in
        icon: 'swal2-green-theme-icon', // Ä°kon iÃ§in
        closeButton: 'swal2-green-theme-close-button', // Kapatma butonu iÃ§in
        htmlContainer: 'swal2-green-theme-html-container'
      }
    });
  }







  function toggleInvestmentIncomeInputs() {
    const karar = (document.getElementById('karar')?.value || "").trim();
    const yatirimTuru = (document.getElementById('yatirim_turu1')?.value || "").trim().toLowerCase();

    const yatirimKazanciInput = document.getElementById('yatirimdan_elde_edilen_kazanc');
    const tevsiKazanciInput = document.getElementById('tevsi_yatirim_kazanci');
    const toplamSabitInput = document.getElementById('toplam_sabit_kiymet_tutari');
    const gerceklesenTevsiInput = document.getElementById('gerceklesen_tevsi_yatirim_tutari');

    if (!yatirimKazanciInput || !tevsiKazanciInput) return;

    // 1) Her ÅŸeyi kapat
    [yatirimKazanciInput, tevsiKazanciInput, toplamSabitInput, gerceklesenTevsiInput].forEach(el => {
      if (el) {
        el.setAttribute('readonly', true);
        el.classList.add('disabled-input');
      }
    });

    // â­ 2) 2025/9903 â†’ sadece yatÄ±rÄ±m kazancÄ± aÃ§Ä±k (TEVSI ASLA YOK)
    if (karar === "2025/9903") {
      yatirimKazanciInput.removeAttribute('readonly');
      yatirimKazanciInput.classList.remove('disabled-input');
      return; // â— tevsi kontrolÃ¼ne hiÃ§ girme!
    }

    // 3) Klasik karar + tevsi tÃ¼rÃ¼ â†’ tevsi kazancÄ± aktif
    if (yatirimTuru === "tevsi") {
      tevsiKazanciInput.removeAttribute('readonly');
      tevsiKazanciInput.classList.remove('disabled-input');

      if (toplamSabitInput) {
        toplamSabitInput.removeAttribute('readonly');
        toplamSabitInput.classList.remove('disabled-input');
      }
      if (gerceklesenTevsiInput) {
        gerceklesenTevsiInput.removeAttribute('readonly');
        gerceklesenTevsiInput.classList.remove('disabled-input');
      }
      return;
    }

    // 4) Klasik karar + tevsiden farklÄ± â†’ yatÄ±rÄ±m kazancÄ± aktif
    yatirimKazanciInput.removeAttribute('readonly');
    yatirimKazanciInput.classList.remove('disabled-input');
  }




  // setBolge(): Ä°l seÃ§imine gÃ¶re bÃ¶lge alanÄ±nÄ± otomatik doldurur. 
  // 2025/9903 kararÄ± seÃ§iliyse bÃ¶lgeyi deÄŸiÅŸtirmez, yalnÄ±zca bilgi amaÃ§lÄ± log yazar.
  function setBolge() {
    const karar = document.getElementById("karar")?.value;
    if (karar === "2025/9903") {
      console.log("ğŸ“ 2025/9903 aktif â€” bÃ¶lge ayarÄ± yapÄ±ldÄ± ama katkÄ± oranÄ± deÄŸiÅŸtirilmedi.");
      return;
    }

    const ilSelect = document.getElementById("il");
    const bolgeInput = document.getElementById("bolge");
    if (ilSelect && bolgeInput) {
      const il = ilSelect.value;
      const bolge = bolgeMap[il];
      bolgeInput.value = bolge;

    }
  }



  // setOranlar(): BÃ¶lge, OSB durumu, vize ve dÃ¶nem bilgilerine gÃ¶re katkÄ±, vergi ve diÄŸer oranlarÄ±nÄ± hesaplayÄ±p alanlara yazar. 
  // Manuel girilen deÄŸerleri korur, 2025/9903 iÃ§in Ã§alÄ±ÅŸmaz ve baÄŸlÄ± hesaplamalarÄ± otomatik tetikler.
  function setOranlar() {
    const karar = document.getElementById("karar")?.value;
    if (karar === "2025/9903") return;
    const bolgeInput = document.getElementById("bolge");
    const osbSelect = document.getElementById("osb");
    const vizeSelect = document.getElementById("vize_durumu");
    const donemSelect = document.getElementById("donem");
    if (!bolgeInput || !osbSelect || !vizeSelect || !donemSelect) return;

    const bolge = bolgeInput.value;
    const osb = osbSelect.value;
    const key = bolge + "|" + osb;

    const vize = vizeSelect.value;
    const donem = donemSelect.value;
    const donemYil = parseInt(donem.split(" - ")[0]);



    // 1) YDO yaz/temizle
    const yenidenDegerlemeOraniEl = document.getElementById("yeniden_degerleme_orani");
    if (yenidenDegerlemeOraniEl) {
      if (vize.includes("HayÄ±r")) {
        yenidenDegerlemeOraniEl.value = "YATIRIM DÃ–NEMÄ°NDE OLDUÄUNUZ Ä°Ã‡Ä°N ENDEKSLEME YAPILMAZ";
        yenidenDegerlemeOraniEl.classList.add("text-muted");   // opsiyonel: gri gÃ¶ster
      } else {
        const oranAnahtari = donem;
        yenidenDegerlemeOraniEl.value = (yenidenDegerlemeOranlari[oranAnahtari] ?? "");
        yenidenDegerlemeOraniEl.classList.remove("text-muted");
      }
    }

    // 2) KatkÄ± oranÄ±
    const katkiOraniEl = document.getElementById("katki_orani");
    const manualKatki = sessionStorage.getItem('manual_katki') === 'true';
    const manualKatkiVal = sessionStorage.getItem('manual_katki_value');
    if (katkiOraniEl) {
      if (manualKatki && manualKatkiVal !== null) {
        katkiOraniEl.value = manualKatkiVal; // manuel deÄŸeri koru
      } else {
        let v = katkilar[key] ?? "";
        if (v !== "") v = Math.max(0, Math.min(100, Number(v)));
        katkiOraniEl.value = v;
      }
    }

    // 3) Vergi indirim oranÄ±
    const vergiOraniEl = document.getElementById("vergi_orani");
    const manualVergi = sessionStorage.getItem('manual_vergi') === 'true';
    const manualVergiVal = sessionStorage.getItem('manual_vergi_value');
    if (vergiOraniEl) {
      if (manualVergi && manualVergiVal !== null) {
        vergiOraniEl.value = manualVergiVal; // manuel deÄŸeri koru
      } else {
        let v = (donemYil >= 2017 && donemYil <= 2022) ? 100 : (vergiler[key] ?? "");
        if (v !== "") v = Math.max(0, Math.min(100, Number(v)));
        vergiOraniEl.value = v;
      }
    }

    // 4) DiÄŸer kazanÃ§ oranÄ± (manuel deÄŸiÅŸmiyorsa olduÄŸu gibi bÄ±rak)
    const digerOranEl = document.getElementById("diger_oran");
    if (digerOranEl) {
      if (vize.includes("Evet")) {
        digerOranEl.value = "Ä°ÅLETME DÃ–NEMÄ°NDE HESAPLANMAZ";
      } else {
        let v = (donemYil >= 2017 && donemYil <= 2022) ? 100 : 80;
        v = Math.max(0, Math.min(100, Number(v)));
        digerOranEl.value = v;
      }
    }


    // 5) Sol â€œÄ°ndirimli KV OranlarÄ± (bilgi)â€ kutusunu gÃ¼ncelle
    updateDiscountedRatesUI();

    // 6) AÅŸama 3/4â€™te isek baÄŸlÄ± hesaplamalarÄ± tetikle
    const step3El = document.getElementById("step3");
    if (step3El && !step3El.classList.contains("hidden-step")) {
      hesaplaKatkiTutari();
      hesaplaDigerKatkiTutari();
      hesaplaFiiliKatkiTutari();
    }
    const step4El = document.getElementById("step4");
    if (step4El && !step4El.classList.contains("hidden-step")) {
      hesaplaOncekiKatkiTutari();
      hesaplaKalanVeEndeks();
    }
  }


  window.handleKarar9903 = function () {

    const kararSelect = document.getElementById("karar");
    const programSelect = document.getElementById("program_turu");
    const ilSelect = document.getElementById("il");
    const osbSelect = document.getElementById("osb");
    const bolgeInput = document.getElementById("bolge");

    const katkiInput = document.getElementById("katki_orani");
    const vergiInput = document.getElementById("vergi_orani");
    const digerInput = document.getElementById("diger_oran");

    const tur1 = document.getElementById("yatirim_turu1");
    const tur2 = document.getElementById("yatirim_turu2");

    if (!kararSelect) return;

    const karar = kararSelect.value;
    const sabitMetin = "2025/9903 NOLU KARAR OLDUÄU Ä°Ã‡Ä°N SEÃ‡Ä°LEMEZ";

    // -------------------------------
    //     YARDIMCI â€” READONLY SELECT
    // -------------------------------
    const makeSelectReadonly = (sel) => {
      sel.dataset.readonly = "1";
      sel.addEventListener("mousedown", e => {
        if (sel.dataset.readonly === "1") e.preventDefault();
      });
      sel.style.pointerEvents = "none";
      sel.classList.add("bg-light");
    };

    const makeSelectWritable = (sel) => {
      sel.dataset.readonly = "0";
      sel.style.pointerEvents = "auto";
      sel.classList.remove("bg-light");
    };

    // ===============================
    //   2025/9903 Ã–ZEL MODU
    // ===============================
    if (karar === "2025/9903") {

      console.log("â†’ 2025/9903 modu aktif!");

      // il / osb / bolge readonly
      makeSelectReadonly(ilSelect);
      makeSelectReadonly(osbSelect);
      bolgeInput.readOnly = true;
      bolgeInput.classList.add("bg-light");

      // Sabit metin / mevcut seÃ§enek Ã¼zerine yaz
      ilSelect.value = sabitMetin;
      osbSelect.value = sabitMetin;
      bolgeInput.value = sabitMetin;

      // Program tÃ¼rÃ¼ aktif
      programSelect.readOnly = false;
      programSelect.style.pointerEvents = "auto";
      programSelect.classList.remove("bg-light");

      // YatÄ±rÄ±m tÃ¼rleri kilit
      tur1.readOnly = true;
      tur2.readOnly = true;
      tur1.style.pointerEvents = "none";
      tur2.style.pointerEvents = "none";
      tur1.classList.add("bg-light");
      tur2.classList.add("bg-light");

      // Sabit oranlar
      vergiInput.value = 60;
      digerInput.value = 50;

      const program = programSelect.value;
      if (typeof katkilar9903 !== 'undefined') {
        katkiInput.value = katkilar9903[program] || "";
      }

    }
    // ===============================
    //      Klasik TeÅŸvik Modu
    // ===============================
    else {

      console.log("â†’ Normal teÅŸvik modu aktif");

      // AlanlarÄ± tekrar yazÄ±labilir yap
      makeSelectWritable(ilSelect);
      makeSelectWritable(osbSelect);
      bolgeInput.readOnly = false;

      // Sabit metni kaldÄ±r (varsa deÄŸiÅŸtirmeden bÄ±rak)
      if (ilSelect.value === sabitMetin) ilSelect.value = "";
      if (osbSelect.value === sabitMetin) osbSelect.value = "";
      if (bolgeInput.value === sabitMetin) bolgeInput.value = "";

      // Program tÃ¼rÃ¼ kilitlenir
      programSelect.readOnly = true;
      programSelect.style.pointerEvents = "none";
      programSelect.classList.add("bg-light");

      // YatÄ±rÄ±m tÃ¼rleri aÃ§Ä±lÄ±r
      tur1.readOnly = false;
      tur2.readOnly = false;
      tur1.style.pointerEvents = "auto";
      tur2.style.pointerEvents = "auto";
      tur1.classList.remove("bg-light");
      tur2.classList.remove("bg-light");

      // OranlarÄ±n klasik hesapla gÃ¼ncellenmesi
      katkiInput.value = "";
      vergiInput.value = "";
      digerInput.value = "";

      if (typeof setBolge === 'function') setBolge();
      if (typeof setOranlar === 'function') setOranlar();
    }

    toggleInvestmentIncomeInputs();
  };





  // updateProgress(): Ä°lerleme Ã§ubuÄŸunu ve mevcut aÅŸama sayÄ±sÄ±nÄ± gÃ¼nceller. 
  // GeÃ§erli aÅŸamaya gÃ¶re progress bar geniÅŸliÄŸini ve "AÅŸama X / Y" gÃ¶stergesini senkronize eder.
  function updateProgress(step) {
    const progressBar = document.getElementById("progressBar");
    const currentStageText = document.getElementById("current-stage-text"); // current-stage-text id'li span'i doÄŸru al

    if (progressBar && currentStageText) {
      const percent = (step / TOTAL_STEPS) * 100;
      progressBar.style.width = percent + "%";
      progressBar.setAttribute("aria-valuenow", percent);
      currentStageText.textContent = step; // Sadece sayÄ±yÄ± gÃ¼nceller, "AÅŸama X / Y" metni HTML'de sabit kalÄ±r
    }
  }


  function _updateStepDisplay(stepNum) {
    ALL_STEPS_IDS.forEach((id, idx) => {
      const el = document.getElementById(id);
      if (!el) return;

      // aktif step
      if (idx + 1 === stepNum) {
        el.classList.remove("hidden-step");
      }
      // pasif step
      else {
        el.classList.add("hidden-step");
      }
    });

    updateProgress(stepNum);
    sessionStorage.setItem('last_step', stepNum);

    // Step-specific triggers
    if (stepNum === 2) {
      setBolge();
      setOranlar();
    }
    else if (stepNum === 4) {
      hesaplaOncekiKatkiTutari();
      hesaplaKalanVeEndeks();
    }
    else if (stepNum === 6) {
      toggleDetailedProfitInput();

      const belgeNoInput = document.querySelector('input[name="belge_no"]');
      const belgeTarihiInput = document.querySelector('input[name="belge_tarihi"]');
      const bolgeInput = document.getElementById('bolge');

      if (belgeNoInput) {
        const h = document.querySelector('input[name="belge_no_hidden"]');
        if (h) h.value = belgeNoInput.value;
      }
      if (belgeTarihiInput) {
        const h = document.querySelector('input[name="belge_tarihi_hidden"]');
        if (h) h.value = belgeTarihiInput.value;
      }
      if (bolgeInput) {
        const h = document.getElementById('bolge_hidden');
        if (h) h.value = bolgeInput.value;
      }
    }

    CURRENT_STEP = stepNum;

    if (typeof blinkAllInfoIcons === "function") blinkAllInfoIcons();
  }





  // updateDiscountedRatesUI(): Vergi indirim oranÄ±na gÃ¶re ihracat, imalat ve diÄŸer kazanÃ§lara ait indirimli KV oranlarÄ±nÄ± hesaplayÄ±p bilgi alanÄ±nda gÃ¶sterir.
  function updateDiscountedRatesUI() {
    const vergiOraniEl = document.getElementById("vergi_orani");
    const spanIhr = document.getElementById("ind_kv_ihr");
    const spanIml = document.getElementById("ind_kv_iml");
    const spanDig = document.getElementById("ind_kv_dig");
    if (!vergiOraniEl || !spanIhr || !spanIml || !spanDig) return;

    const p = parseFormattedNumber(vergiOraniEl.value) / 100; // 0..1
    if (isNaN(p)) {
      spanIhr.textContent = "â€”";
      spanIml.textContent = "â€”";
      spanDig.textContent = "â€”";
      return;
    }
    const rIhr = 0.20 - (0.20 * p);
    const rIml = 0.24 - (0.24 * p);
    const rDig = 0.25 - (0.25 * p);

    const fmtPct = (x) => (x * 100).toFixed(2).replace('.', ',') + '%';
    spanIhr.textContent = fmtPct(rIhr);
    spanIml.textContent = fmtPct(rIml);
    spanDig.textContent = fmtPct(rDig);
  }



  function calculateRatios() {
    const useDetailedCheckbox = document.getElementById("useDetailedProfitRatios");
    const useDetailed = useDetailedCheckbox ? useDetailedCheckbox.checked : false;
    const brutInput = document.getElementById("brut_satis");
    const ihracatInput = document.getElementById("ihracat");
    const imalatInput = document.getElementById("imalat");
    const digerFaaliyetInput = document.getElementById("diger_faaliyet");
    const spanIhr = document.getElementById("ratio_ihracat");
    const spanIml = document.getElementById("ratio_imalat");
    const spanDig = document.getElementById("ratio_diger");
    if (!brutInput || !ihracatInput || !imalatInput || !digerFaaliyetInput || !spanIhr || !spanIml || !spanDig) return;
    if (useDetailed) {
      const savedC54 = sessionStorage.getItem('ayrintili_C54');
      const savedD54 = sessionStorage.getItem('ayrintili_D54');
      const savedE54 = sessionStorage.getItem('ayrintili_E54');
      if (savedC54 !== null && savedD54 !== null && savedE54 !== null) {
        spanIhr.textContent = savedC54;
        spanIml.textContent = savedD54;
        spanDig.textContent = savedE54;
      } else {
        spanIhr.textContent = initialRatios.C;
        spanIml.textContent = initialRatios.D;
        spanDig.textContent = initialRatios.E;
      }
    } else {
      const brut = parseFormattedNumber(brutInput.value) || 0;
      const ihracat = parseFormattedNumber(ihracatInput.value) || 0;
      const imalat = parseFormattedNumber(imalatInput.value) || 0;
      const diger = parseFormattedNumber(digerFaaliyetInput.value) || 0;
      let pctIhr = 0,
        pctIml = 0,
        pctDig = 0;
      if (brut > 0) {
        pctIhr = (ihracat / brut) * 100;
        pctIml = (imalat / brut) * 100;
        pctDig = (diger / brut) * 100;
      }
      spanIhr.textContent = brut ? pctIhr.toFixed(2).replace(".", ",") + "%" : "â€”%";
      spanIml.textContent = brut ? pctIml.toFixed(2).replace(".", ",") + "%" : "â€”%";
      spanDig.textContent = brut ? pctDig.toFixed(2).replace(".", ",") + "%" : "â€”%";
    }
    const ayrTable = document.getElementById('ayrintili-kazanc-table');
    if (ayrTable) {
      const updateCell = (rowIndex, col, text) => {
        const selector = `#ayrintili-kazanc-table tbody tr:nth-child(${rowIndex + 1}) input[name="${col}_${rowIndex}"]`;
        const inp = document.querySelector(selector);
        if (inp && inp.readOnly) {
          isProgrammaticChange = true;
          inp.value = text;
          isProgrammaticChange = false;
        }
      };
      updateCell(0, "B", "100%");
      updateCell(0, "C", spanIhr.textContent);
      updateCell(0, "D", spanIml.textContent);
      updateCell(0, "E", spanDig.textContent);
      const b53Input = document.querySelector(`input[name="B_53"]`);
      if (b53Input) {
        const C53 = parseFormattedNumber(document.querySelector(`input[name="C_53"]`).value) || 0;
        const D53 = parseFormattedNumber(document.querySelector(`input[name="D_53"]`).value) || 0;
        const E53 = parseFormattedNumber(document.querySelector(`input[name="E_53"]`).value) || 0;
        const B53 = parseFormattedNumber(b53Input.value) || 0;
        let pct2C = 0,
          pct2D = 0,
          pct2E = 0;
        if (B53 > 0) {
          pct2C = (C53 / B53) * 100;
          pct2D = (D53 / B53) * 100;
          pct2E = (E53 / B53) * 100;
        }
        updateCell(54, "B", "100%");
        updateCell(54, "C", pct2C.toFixed(2).replace(".", ",") + "%");
        updateCell(54, "D", pct2D.toFixed(2).replace(".", ",") + "%");
        updateCell(54, "E", pct2E.toFixed(2).replace(".", ",") + "%");
      }
    }
  }




  // --- AyrÄ±ntÄ±lÄ± KazanÃ§ Tablosu HesaplamasÄ± ---
  function calculateTable(event) {
    const ayrTable = document.getElementById('ayrintili-kazanc-table');
    if (!ayrTable) return;

    const tableData = [];
    ayrTable.querySelectorAll('tbody tr').forEach((rowEl, rowIndex) => {
      const rowVals = {};
      rowEl.querySelectorAll('input').forEach(input => {
        const [col] = input.name.split('_');
        rowVals[col] = parseFormattedNumber(input.value);
      });
      tableData[rowIndex] = rowVals;
    });

    if (event && event.target) {
      const [col, rowStr] = event.target.name.split('_');
      const rowIdx = parseInt(rowStr, 10);
      if ((rowIdx === 20 || rowIdx === 21) && col === 'B') {
        const b = tableData[rowIdx].B;
        const pctC = tableData[0].C / 100;
        const pctD = tableData[0].D / 100;
        const pctE = tableData[0].E / 100;
        ['C', 'D', 'E'].forEach((c, i) => {
          const v = b * [pctC, pctD, pctE][i];
          tableData[rowIdx][c] = v;
          // Programatik atamada sonsuz dÃ¶ngÃ¼yÃ¼ Ã¶nleyin
          const inp = document.querySelector(`input[name="${c}_${rowIdx}"]`);
          if (inp) {
            isProgrammaticChange = true; // BayraÄŸÄ± ayarla
            inp.value = v.toLocaleString('tr-TR', {
              minimumFractionDigits: 2
            });
            isProgrammaticChange = false; // BayraÄŸÄ± sÄ±fÄ±rla
          }
        });
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(saveDetailedProfitData, 1500);
        return;
      }
    }

    for (let i = 2; i <= 4; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[1][col] = tableData[2][col] + tableData[3][col] + tableData[4][col];
    });
    const toplamH = tableData[1].B;

    if (toplamH > 0) {
      tableData[0].B = 100;
      ['C', 'D', 'E'].forEach(col => {
        tableData[0][col] = parseFloat(((tableData[1][col] / toplamH) * 100).toFixed(2));
      });
    } else {
      tableData[0] = {
        B: 100,
        C: 0,
        D: 0,
        E: 0
      };
    }

    for (let i = 6; i <= 8; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[5][col] = tableData[6][col] + tableData[7][col] + tableData[8][col];
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[9][col] = tableData[1][col] - tableData[5][col];
    });

    for (let i = 11; i <= 14; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[10][col] =
        tableData[11][col] +
        tableData[12][col] +
        tableData[13][col] +
        tableData[14][col];
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[15][col] = tableData[9][col] - tableData[10][col];
    });

    for (let i = 17; i <= 19; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[16][col] = tableData[17][col] + tableData[18][col] + tableData[19][col];
    });

    [20, 21].forEach(r => {
      const b = tableData[r].B;
      tableData[r].C = b * (tableData[0].C / 100);
      tableData[r].D = b * (tableData[0].D / 100);
      tableData[r].E = b * (tableData[0].E / 100);
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[16][col] =
        tableData[17][col] +
        tableData[18][col] +
        tableData[19][col] +
        tableData[20][col] +
        tableData[21][col];
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[22][col] = tableData[15][col] - tableData[16][col];
    });

    for (let i = 24; i <= 33; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      let sum = 0;
      for (let i = 24; i <= 33; i++) sum += tableData[i][col];
      tableData[23][col] = sum;
    });

    for (let i = 35; i <= 41; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      let sum = 0;
      for (let i = 35; i <= 41; i++) sum += tableData[i][col];
      tableData[34][col] = sum;
    });

    for (let i = 43; i <= 44; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[42][col] = tableData[43][col] + tableData[44][col];
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[45][col] =
        tableData[22][col] +
        tableData[23][col] -
        tableData[34][col] -
        tableData[42][col];
    });

    for (let i = 47; i <= 48; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[46][col] = tableData[47][col] + tableData[48][col];
    });

    for (let i = 50; i <= 52; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[49][col] = tableData[50][col] + tableData[51][col] + tableData[52][col];
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[53][col] =
        tableData[45][col] +
        tableData[46][col] -
        tableData[49][col];
    });

    const B53 = tableData[53].B,
      C53 = tableData[53].C,
      D53 = tableData[53].D,
      E53 = tableData[53].E;
    let pct2C = 0,
      pct2D = 0,
      pct2E = 0;
    if (B53 > 0) {
      pct2C = (C53 / B53) * 100;
      pct2D = (D53 / B53) * 100;
      pct2E = (E53 / B53) * 100;
    }
    tableData[54].B = 100;
    tableData[54].C = parseFloat(pct2C.toFixed(2));
    tableData[54].D = parseFloat(pct2D.toFixed(2));
    tableData[54].E = parseFloat(pct2E.toFixed(2));

    ayrTable.querySelectorAll('tbody tr').forEach((rowEl, idx) => {
      rowEl.querySelectorAll('input').forEach(input => {
        const [col] = input.name.split('_');
        if (input.readOnly) {
          // isProgrammaticChange bayraÄŸÄ±nÄ± kullanarak sonsuz dÃ¶ngÃ¼yÃ¼ Ã¶nleyin
          isProgrammaticChange = true;
          let v = tableData[idx][col];
          if (idx === 0 || idx === 54) {
            v = v.toFixed(2).replace('.', ',') + '%';
            if (col === 'B') v = '100%';
          } else {
            v = v.toLocaleString('tr-TR', {
              minimumFractionDigits: 2
            });
          }
          input.value = v; // DeÄŸer atamasÄ±
          isProgrammaticChange = false; // BayraÄŸÄ± sÄ±fÄ±rla
        }
      });
    });

    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(saveDetailedProfitData, 1500);
  }


  // AyrÄ±ntÄ±lÄ± kazanÃ§ tablosunu sunucuya kaydetmek iÃ§in AJAX fonksiyonu
  async function saveDetailedProfitData() {
    const ayrTable = document.getElementById('ayrintili-kazanc-table');
    if (!ayrTable) {
      return;
    }
    const formData = new FormData();
    let dataChanged = false;
    ayrTable.querySelectorAll('tbody tr').forEach((rowEl) => {
      rowEl.querySelectorAll('input').forEach(input => {
        if (!input.readOnly) {
          const originalValue = input.getAttribute('data-original-value');
          const currentValue = input.value;
          if (originalValue !== currentValue) {
            formData.append(input.name, currentValue);
            dataChanged = true;
          }
        }
      });
    });
    if (!dataChanged) {
      return;
    }
    try {
      const response = await fetch("{{ url_for('indirimlikurumlar.ayrintili_kazanc') }}", {
        method: "POST",
        body: formData
      });
      if (response.ok) {
        ayrTable.querySelectorAll('tbody input').forEach(input => {
          input.setAttribute('data-original-value', input.value);
        });
        updateSessionStorageRatios();
      } else {
        console.error("Otomatik kaydetme baÅŸarÄ±sÄ±z oldu:", response.status, response.statusText);
      }
    } catch (error) {
      console.error("Otomatik kaydetme sÄ±rasÄ±nda hata oluÅŸtu:", error);
    }
  }

  function updateSessionStorageRatios() {
    const ayrTable = document.getElementById('ayrintili-kazanc-table');
    if (!ayrTable) {
      return;
    }
    const C54_input = ayrTable.querySelector('input[name="C_54"]');
    const D54_input = ayrTable.querySelector('input[name="D_54"]');
    const E54_input = ayrTable.querySelector('input[name="E_54"]');
    if (C54_input && D54_input && E54_input) {
      sessionStorage.setItem('ayrintili_C54', C54_input.value);
      sessionStorage.setItem('ayrintili_D54', D54_input.value);
      sessionStorage.setItem('ayrintili_E54', E54_input.value);
    }
  }

  function toggleDetailedProfitInput() {
    const useDetailedCheckbox = document.getElementById("useDetailedProfitRatios");
    if (!useDetailedCheckbox) return;
    const useDetailed = useDetailedCheckbox.checked;
    const brutInput = document.getElementById("brut_satis");
    const ihracatInput = document.getElementById("ihracat");
    const imalatInput = document.getElementById("imalat");
    const digerFaaliyetInput = document.getElementById("diger_faaliyet");
    if (!brutInput || !ihracatInput || !imalatInput || !digerFaaliyetInput) return;
    if (useDetailed) {
      brutInput.setAttribute('readonly', true);
      ihracatInput.setAttribute('readonly', true);
      imalatInput.setAttribute('readonly', true);
      digerFaaliyetInput.setAttribute('readonly', true);
      brutInput.value = '';
      ihracatInput.value = '';
      imalatInput.value = '';
      digerFaaliyetInput.value = '';
      calculateRatios();
    } else {
      brutInput.removeAttribute('readonly');
      ihracatInput.removeAttribute('readonly');
      imalatInput.removeAttribute('readonly');
      digerFaaliyetInput.removeAttribute('readonly');
      calculateRatios();
    }
  }

  function clearProfitTable() {
    Swal.fire({
      title: "Emin misiniz?",
      text: "TÃ¼m ayrÄ±ntÄ±lÄ± kazanÃ§ verilerini silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Evet, sil!",
      cancelButtonText: "Ä°ptal"
    }).then((result) => {
      if (result.isConfirmed) {
        const ayrTable = document.getElementById('ayrintili-kazanc-table');
        if (ayrTable) {
          // input deÄŸerlerini temizle
          ayrTable.querySelectorAll('tbody input').forEach(input => {
            if (!input.readOnly) {
              isProgrammaticChange = true;
              input.value = '';
              input.setAttribute('data-original-value', '');
              isProgrammaticChange = false;
            }
          });
          // Session Storage'Ä± temizle
          sessionStorage.removeItem('ayrintili_C54');
          sessionStorage.removeItem('ayrintili_D54');
          sessionStorage.removeItem('ayrintili_E54');

          // VeritabanÄ±ndan temizlemek iÃ§in AJAX isteÄŸi gÃ¶nder
          // Bu Ã¶rnekte, Python tarafÄ±ndan Ã¶zel bir 'temizle' endpoint'i olmadÄ±ÄŸÄ±nÄ± varsayÄ±yorum.
          // EÄŸer Flask'ta bir 'temizle' endpoint'i varsa, onu burada Ã§aÄŸÄ±rÄ±rdÄ±k.
          // Åimdilik sadece frontend'i temizledik ve bir mesaj gÃ¶sterdik.
          showSwalMessage("success", "Temizlendi!", "AyrÄ±ntÄ±lÄ± kazanÃ§ verileri temizlendi.");
          calculateTable(); // Tabloyu yeniden hesapla ve boÅŸ deÄŸerleri gÃ¶ster
        }
      }
    });
  }




  function fillFormWithParsedData(data) {
    const map = {
      belge_no: 'belge_no',
      karar: 'karar',
      baslama_tarihi: 'belge_tarihi',   // parser 'baslama_tarihi' dÃ¶ndÃ¼rÃ¼yorsa
      belge_tarihi: 'belge_tarihi',     // parser 'belge_tarihi' dÃ¶ndÃ¼rÃ¼yorsa
      yatirim_turu1: 'yatirim_turu1',
      yatirim_turu2: 'yatirim_turu2',
      bolge: 'bolge',

      // oran ve tutarlar
      katki_orani: 'katki_orani',
      vergi_orani: 'vergi_orani',
      ikv_orani: 'diger_oran',
      diger_oran: 'diger_oran',

      toplam_tutar: 'toplam_tutar',
      katki_tutari: 'katki_tutari',
      diger_katki_tutari: 'diger_katki_tutari',
      cari_harcama_tutari: 'cari_harcama_tutari',
      toplam_harcama_tutari: 'toplam_harcama_tutari',
      fiili_katki_tutari: 'fiili_katki_tutari',
      endeks_katki_tutari: 'endeks_katki_tutari',

      onceki_yatirim_katki_tutari: 'onceki_yatirim_katki_tutari',
      onceki_diger_katki_tutari: 'onceki_diger_katki_tutari',
      onceki_katki_tutari: 'onceki_katki_tutari',

      // cari alanlar
      cari_yatirim_katki: 'cari_yatirim_katki',
      cari_diger_katki: 'cari_diger_katki',
      cari_toplam_katki: 'cari_toplam_katki',
      genel_toplam_katki: 'genel_toplam_katki'
    };

    Object.entries(map).forEach(([src, destName]) => {
      const el = document.querySelector(`[name="${destName}"]`);
      if (!el) return;
      const val = data[src];
      const v = (el.type === 'date')
        ? convertToInputDateFormat(val || '')
        : (val ?? '');
      el.value = v;

      // â• PDFâ€™den geleni kalÄ±cÄ±laÅŸtÄ±r
      sessionStorage.setItem(`form_${destName}`, v);
    });

    // BÃ¶lge gizli alanÄ±
    const b = document.getElementById('bolge');
    if (b) {
      b.dispatchEvent(new Event('change'));
      const bh = document.getElementById('bolge_hidden');
      if (bh) {
        bh.value = b.value;
        sessionStorage.setItem('form_bolge', b.value);
        sessionStorage.setItem('form_bolge_hidden', b.value);
      }
    }

    // KaldÄ±ÄŸÄ±n adÄ±mÄ± da kaydet (Ã¶r: otomatik Step 2â€™ye geÃ§eceksen)
    sessionStorage.setItem('last_step', '2');

    if (typeof goToStep2 === 'function') goToStep2();
  }


  // PDF yÃ¼kleme ve parse iÅŸlemi: KullanÄ±cÄ±nÄ±n seÃ§tiÄŸi KV beyannamesi PDF'ini backend'e gÃ¶nderir,
  // gelen verileri kontrol eder ve uygun form alanlarÄ±na otomatik olarak doldurur.
  // Ã‡oklu belge varsa seÃ§im yaptÄ±rÄ±r, hata veya eksik durumlarÄ±nda uyarÄ± gÃ¶sterir.
  async function handleKVUpload(ev) {
    const file = ev.target.files?.[0];
    if (!file) return;

    // aynÄ± dosyayÄ± tekrar seÃ§ebilin
    ev.target.value = '';

    const fd = new FormData();
    fd.append('kv_pdf', file);

    // 1) Loading
    Swal.fire({
      title: 'YÃ¼kleniyor...',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    let resp;
    try {
      // (opsiyonel) timeout
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), 20000);

      const r = await fetch('{{ url_for("indirimlikurumlar.upload_kv_beyan") }}', {
        method: 'POST',
        body: fd,
        signal: ctrl.signal
      });

      clearTimeout(t);

      const ct = r.headers.get('content-type') || '';
      if (!ct.includes('application/json')) {
        const text = await r.text();
        throw new Error('Beklenmeyen yanÄ±t: ' + ct + ' / ' + text.slice(0, 200));
      }

      resp = await r.json();
    } catch (e) {
      Swal.close();
      Swal.fire('Hata', 'PDF yÃ¼klenirken aÄŸ/yanÄ±t hatasÄ± oluÅŸtu.', 'error');
      return;
    } finally {
      Swal.close();
    }

    console.log('KV upload resp:', resp);

    // 2) Mutlu yollar
    if (resp?.status === 'ok' && resp?.parsed) {
      fillFormWithParsedData(resp.parsed);
      await Swal.fire('Tamam', 'PDFâ€™den bilgiler aktarÄ±ldÄ±.', 'success');
      return;
    }

    if (resp.status === 'multiple' && Array.isArray(resp.raw_data) && resp.raw_data.length) {
      // SeÃ§enekleri hazÄ±rla
      const inputOptions = {};
      resp.raw_data.forEach((item, i) => {
        const no = (item.belge_no || `Belge ${i + 1}`).toString().trim();
        const karar = item.karar ? ` â€¢ ${item.karar}` : '';
        const tarih = item.belge_tarihi ? ` â€¢ ${item.belge_tarihi}` : '';
        inputOptions[i] = `${no}${karar}${tarih}`;
      });

      // KullanÄ±cÄ±ya sor
      const { value: idx } = await Swal.fire({
        title: 'Hangi teÅŸvik belgesini iÃ§e aktarmak istersiniz?',
        input: 'select',
        inputOptions,
        inputPlaceholder: 'SeÃ§iniz',
        showCancelButton: true,
        confirmButtonText: 'SeÃ§',
        cancelButtonText: 'Ä°ptal'
      });

      if (idx !== undefined) {
        fillFormWithParsedData(resp.raw_data[Number(idx)]);
        Swal.fire('Tamam', 'PDFâ€™den bilgiler aktarÄ±ldÄ±.', 'success');
      }
      return;
    }


    // 3) Ã–zel: KV sayfasÄ±/tablosu bulunamadÄ± senaryosu
    if (
      resp.status === 'not_found' ||     // backend bÃ¶yle dÃ¶nÃ¼yorsa
      resp.status === 'no_kv' ||     // â€¦veya bu
      resp.status === 'empty' ||     // â€¦veya bu
      (resp.status === 'multiple' && (!resp.raw_data || !resp.raw_data.length || !resp.tablolar || !resp.tablolar.length)) ||
      (resp.status === 'ok' && !resp.parsed)
    ) {
      Swal.fire('BulunamadÄ±', 'YÃ¼klediÄŸiniz PDFâ€™de â€œÄ°ndirimli Kurumlarâ€ bÃ¶lÃ¼mÃ¼ tespit edilemedi.', 'warning');
      return;
    }

    // 4) DiÄŸer tÃ¼m hatalar
    Swal.fire('Hata', resp.message || 'PDF verisi iÅŸlenemedi.', 'error');

  }








  function hesaplaKatkiTutari9903({ advance = false } = {}) {

    const karar = document.getElementById("karar")?.value;
    if (karar !== "2025/9903") return;

    console.log("ğŸ”¹ hesaplaKatkiTutari9903() BAÅLADI");

    const safe = (x) => (isNaN(x) ? 0 : x);
    const val = (id) => safe(parseFormattedNumber(document.getElementById(id)?.value));

    // 1ï¸âƒ£ Girdiler
    let yatirimKazanci = 0;
    const yatirimKazancInput = document.getElementById("yatirimdan_elde_edilen_kazanc");
    const tevsiKazancInput = document.getElementById("tevsi_yatirim_kazanci");

    if (yatirimKazancInput && parseFormattedNumber(yatirimKazancInput.value) > 0) {
      yatirimKazanci = val("yatirimdan_elde_edilen_kazanc");
    } else if (tevsiKazancInput && parseFormattedNumber(tevsiKazancInput.value) > 0) {
      yatirimKazanci = val("tevsi_yatirim_kazanci");
    }

    const digerKazanc = val("kv_matrah");

    // ğŸ”¸ KullanÄ±cÄ± seÃ§imine gÃ¶re diÄŸer kazancÄ± devre dÄ±ÅŸÄ± bÄ±rak
    const gelirTipi = sessionStorage.getItem("gelir_uygulama_tipi");
    let digerKazancFinal = digerKazanc;

    if (gelirTipi === "yatirim") {
      digerKazancFinal = 0;
      console.log("ğŸ¯ YalnÄ±z yatÄ±rÄ±m kazancÄ± seÃ§ildi â€” diÄŸer faaliyet kazancÄ± hesap dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±.");
    }

    const toplamYatirim = val("toplam_tutar");
    const harcamaYatirim = val("toplam_harcama_tutari");
    const katkiOrani = val("katki_orani") / 100;
    const vergiIndirimOrani = val("vergi_orani") / 100;
    const digerOran = val("diger_oran") / 100;
    const oncekiToplamKatki = val("onceki_katki_tutari");

    // 2ï¸âƒ£ KV oranlarÄ±
    const kvOranIhracat = safe(val("kv_oran_ihracat") / 100) || 0.20;
    const kvOranImalat = safe(val("kv_oran_imalat") / 100) || 0.24;
    const kvOranDiger = safe(val("kv_oran_diger") / 100) || 0.25;

    const farkIhr = kvOranIhracat - kvOranIhracat * (1 - vergiIndirimOrani);
    const farkIml = kvOranImalat - kvOranImalat * (1 - vergiIndirimOrani);
    const farkDig = kvOranDiger - kvOranDiger * (1 - vergiIndirimOrani);

    // 3ï¸âƒ£ Oran kaynaÄŸÄ±
    const useDetailedRatios = document.getElementById("useDetailedProfitRatios")?.checked || false;

    let ihracatOraniFinal = 0,
      imalatOraniFinal = 0,
      digerOraniFinal = 0;

    if (useDetailedRatios) {
      ihracatOraniFinal =
        safe(parseFloat(document.getElementById("ratio_ihracat")?.textContent.replace("%", "").replace(",", "."))) / 100;
      imalatOraniFinal =
        safe(parseFloat(document.getElementById("ratio_imalat")?.textContent.replace("%", "").replace(",", "."))) / 100;
      digerOraniFinal =
        safe(parseFloat(document.getElementById("ratio_diger")?.textContent.replace("%", "").replace(",", "."))) / 100;
    } else {
      const brutSatis = val("brut_satis");
      const ihracatSatis = val("ihracat");
      const imalatSatis = val("imalat");
      const digerSatis = val("diger_faaliyet");

      if (brutSatis > 0) {
        ihracatOraniFinal = ihracatSatis / brutSatis;
        imalatOraniFinal = imalatSatis / brutSatis;
        digerOraniFinal = digerSatis / brutSatis;
      } else {
        digerOraniFinal = 1;
      }
    }

    // 5ï¸âƒ£ KatkÄ± tabanlarÄ±
    const toplamKatki9903 = toplamYatirim * katkiOrani;
    const hakEdilenKatki9903 = harcamaYatirim * katkiOrani;
    const ustSinirDiger9903 = toplamKatki9903 * digerOran;
    const digerKullanilabilir9903 = Math.min(hakEdilenKatki9903, ustSinirDiger9903);

    // 6ï¸âƒ£ Hesap dÃ¶nemi farkÄ±
    const donemYil = parseInt((document.getElementById("donem")?.value || "").split(" - ")[0]) || 0;
    const baslangicYil = parseInt(document.getElementById("baslangic_yili")?.value || "0");
    const donemFarki = baslangicYil && donemYil ? donemYil - baslangicYil : 0;

    console.log("ğŸ§® Nihai DeÄŸerler:", {
      toplamKatki9903,
      hakEdilenKatki9903,
      ustSinirDiger9903,
      yatirimKazanci,
      digerKazanc: digerKazancFinal,
      donemFarki,
    });

    // 7ï¸âƒ£ Cari dÃ¶nem katkÄ±larÄ±
    let cariYatirimKatkisi9903 = 0;
    let cariDigerKatkisi9903 = 0;

    if (yatirimKazanci > 0 && digerKazancFinal <= 0) {
      // YalnÄ±z yatÄ±rÄ±m kazancÄ±
      if (donemFarki >= 10) {
        Swal.fire({
          icon: "warning",
          title: "10 Hesap DÃ¶nemi SÄ±nÄ±rÄ±",
          html: "YatÄ±rÄ±mdan elde edilen kazanÃ§larda indirimli kurumlar vergisi uygulanabilecek sÃ¼re dolmuÅŸtur.",
          confirmButtonText: "Tamam",
        });
      } else {
        cariYatirimKatkisi9903 =
          yatirimKazanci * ihracatOraniFinal * farkIhr +
          yatirimKazanci * imalatOraniFinal * farkIml +
          yatirimKazanci * digerOraniFinal * farkDig;
      }
    }

    else if (yatirimKazanci <= 0 && digerKazancFinal > 0) {
      // YalnÄ±z diÄŸer kazanÃ§
      if (donemFarki >= 4) {
        Swal.fire({
          icon: "info",
          title: "4 Hesap DÃ¶nemi SÄ±nÄ±rÄ±",
          html: "DiÄŸer faaliyet kazanÃ§larÄ±na indirimli kurumlar vergisi uygulama sÃ¼resi dolmuÅŸtur.",
          confirmButtonText: "Tamam",
        });
      } else {
        cariDigerKatkisi9903 = digerKullanilabilir9903;
      }
    }

    else if (yatirimKazanci > 0 && digerKazancFinal > 0) {
      // Karma durum
      const yatirimKismi =
        yatirimKazanci * ihracatOraniFinal * farkIhr +
        yatirimKazanci * imalatOraniFinal * farkIml +
        yatirimKazanci * digerOraniFinal * farkDig;

      const digerKismi = donemFarki < 4 ? digerKullanilabilir9903 : 0;

      cariYatirimKatkisi9903 = yatirimKismi;
      cariDigerKatkisi9903 = digerKismi;
    }

    // 8ï¸âƒ£ Toplam katkÄ±lar
    const cariToplamKatki9903 = cariYatirimKatkisi9903 + cariDigerKatkisi9903;
    const genelToplamKatki9903 = oncekiToplamKatki + cariToplamKatki9903;
    const kalanKatki9903 = Math.max(0, toplamKatki9903 - genelToplamKatki9903);

    // 9ï¸âƒ£ UI gÃ¼ncelleme (sadece safeSet!)
    safeSet("cari_yatirim_katki", cariYatirimKatkisi9903);
    safeSet("cari_diger_katki", cariDigerKatkisi9903);
    safeSet("cari_toplam_katki", cariToplamKatki9903);
    safeSet("genel_toplam_katki", genelToplamKatki9903);
    safeSet("kalan_katki_tutari", kalanKatki9903);
    safeSet("katki_tutari", toplamKatki9903);
    safeSet("diger_katki_tutari", ustSinirDiger9903);
    safeSet("fiili_katki_tutari", hakEdilenKatki9903);

    // ğŸ’° Ä°ndirimli KV matrahÄ± ve vergisi
    const toplamOran = ihracatOraniFinal + imalatOraniFinal + digerOraniFinal || 1;

    const katkIhr = cariDigerKatkisi9903 * (ihracatOraniFinal / toplamOran);
    const katkIml = cariDigerKatkisi9903 * (imalatOraniFinal / toplamOran);
    const katkDig = cariDigerKatkisi9903 * (digerOraniFinal / toplamOran);

    const matrahOtherIhr =
      farkIhr > 0 ? katkIhr / farkIhr : 0;
    const matrahOtherIml =
      farkIml > 0 ? katkIml / farkIml : 0;
    const matrahOtherDig =
      farkDig > 0 ? katkDig / farkDig : 0;

    const matrahOther = matrahOtherIhr + matrahOtherIml + matrahOtherDig;
    const matrahInvest = Math.max(0, yatirimKazanci);
    const indirimliMatrah9903 = matrahOther + matrahInvest;

    const reducedRate = kvOranDiger * (1 - vergiIndirimOrani);
    const indirimliKV9903 = indirimliMatrah9903 * reducedRate;
    const efektifOran = (indirimliKV9903 / indirimliMatrah9903) * 100 || 0;

    safeSet("indirimli_matrah", indirimliMatrah9903);
    safeSet("indirimli_kv", indirimliKV9903);
    safeSet("indirimli_kv_oran", efektifOran);

    console.log("âœ… hesaplaKatkiTutari9903() tamamlandÄ±", {
      cariYatirimKatkisi9903,
      cariDigerKatkisi9903,
      genelToplamKatki9903,
      kalanKatki9903,
    });

    if (advance && typeof _updateStepDisplay === "function") {
      _updateStepDisplay(7);
      console.log("â¡ï¸ AÅŸama 7â€™ye geÃ§ildi (manual trigger)");
    }
  }


  function hesaplaKatkiTutari() {
    const karar = document.getElementById("karar")?.value;

    if (karar === "2025/9903") {
      if (typeof hesaplaKatkiTutari9903 === "function") {
        hesaplaKatkiTutari9903();
      }
      return;
    }

    const toplamInput = document.getElementById("toplam_tutar");
    const oranInput = document.getElementById("katki_orani");
    const outputId = "katki_tutari";

    if (!toplamInput || !oranInput) {
      safeSet(outputId, 0);
      return;
    }

    const toplam = parseFormattedNumber(toplamInput.value);
    const oran = parseFormattedNumber(oranInput.value);

    const invalid = (v) => v === null || isNaN(v) || v === undefined;

    if (invalid(toplam) || invalid(oran)) {
      safeSet(outputId, 0);
      return;
    }

    const tutar = (toplam * oran) / 100;
    safeSet(outputId, tutar);

    if (typeof hesaplaDigerKatkiTutari === "function") hesaplaDigerKatkiTutari();
    if (typeof hesaplaFiiliKatkiTutari === "function") hesaplaFiiliKatkiTutari();
    if (typeof hesaplaOncekiKatkiTutari === "function") hesaplaOncekiKatkiTutari();
    if (typeof hesaplaKalanVeEndeks === "function") hesaplaKalanVeEndeks();
  }



  function hesaplaDigerKatkiTutari() {
    // 9903 ise â€” Ã¶zel hesaplamaya geÃ§
    if (document.getElementById("karar")?.value === "2025/9903") {
      hesaplaKatkiTutari9903();
      return;
    }

    const katki = parseFormattedNumber(document.getElementById("katki_tutari")?.value);
    const digerOranText = document.getElementById("diger_oran")?.value || "";
    const digerOran = parseFormattedNumber(digerOranText);
    const input = document.getElementById("diger_katki_tutari");

    // 1ï¸âƒ£ Normal sayÄ± hesabÄ±
    if (!isNaN(katki) && !isNaN(digerOran)) {

      // EÄŸer mask daha Ã¶nce kaldÄ±rÄ±lmÄ±ÅŸsa, maskeyi geri yÃ¼kle
      if (!maskMap["diger_katki_tutari"]) {
        maskMap["diger_katki_tutari"] = IMask(input, {
          mask: Number,
          scale: 2,
          thousandsSeparator: ".",
          radix: ",",
          mapToRadix: ["."],
          lazy: false  // ğŸ”¥ CRITICAL FIX â€” event fÄ±rlatma sorununu engeller
        });
      }

      const sonuc = (katki * digerOran) / 100;
      safeSet("diger_katki_tutari", sonuc);
      return;
    }

    // 2ï¸âƒ£ â€œÄ°ÅŸletme DÃ¶neminde Hesaplanmazâ€
    if (digerOranText.includes("Ä°ÅLETME DÃ–NEMÄ°NDE HESAPLANMAZ")) {

      // Maskeyi kaldÄ±r
      if (maskMap["diger_katki_tutari"]) {
        maskMap["diger_katki_tutari"].destroy();
        delete maskMap["diger_katki_tutari"];
      }

      // Metni serbestÃ§e yaz
      input.value = "Ä°ÅLETME DÃ–NEMÄ°NDE HESAPLANMAZ";
      return;
    }

    // 3ï¸âƒ£ BoÅŸ / geÃ§ersiz durumda 0 yaz
    if (!maskMap["diger_katki_tutari"]) {
      maskMap["diger_katki_tutari"] = IMask(input, {
        mask: Number,
        scale: 2,
        thousandsSeparator: ".",
        radix: ",",
        mapToRadix: ["."],
        lazy: false  // ğŸ”¥ Tekrar aynÄ± dÃ¼zeltme
      });
    }

    safeSet("diger_katki_tutari", 0);
  }




  function hesaplaDigerKatkiTutari() {
    // 9903 ise â€” Ã¶zel hesaplamaya geÃ§
    if (document.getElementById("karar")?.value === "2025/9903") {
      hesaplaKatkiTutari9903();
      return;
    }

    const katki = parseFormattedNumber(document.getElementById("katki_tutari")?.value);
    const digerOranText = document.getElementById("diger_oran")?.value || "";
    const digerOran = parseFormattedNumber(digerOranText);
    const input = document.getElementById("diger_katki_tutari");

    // 1ï¸âƒ£ Normal sayÄ± hesabÄ±
    if (!isNaN(katki) && !isNaN(digerOran)) {

      // EÄŸer mask daha Ã¶nce kaldÄ±rÄ±lmÄ±ÅŸsa, maskeyi geri yÃ¼kle
      if (!maskMap["diger_katki_tutari"]) {
        maskMap["diger_katki_tutari"] = IMask(input, {
          mask: Number,
          scale: 2,
          thousandsSeparator: ".",
          radix: ",",
          mapToRadix: ["."],
          lazy: false
        });
      }

      const sonuc = (katki * digerOran) / 100;
      safeSet("diger_katki_tutari", sonuc);
      return;
    }

    // 2ï¸âƒ£ â€œÄ°ÅŸletme DÃ¶neminde Hesaplanmazâ€
    if (digerOranText.includes("Ä°ÅLETME DÃ–NEMÄ°NDE HESAPLANMAZ")) {

      // Maskeyi kaldÄ±r
      if (maskMap["diger_katki_tutari"]) {
        maskMap["diger_katki_tutari"].destroy();
        delete maskMap["diger_katki_tutari"];
      }

      // Metni serbestÃ§e yaz
      input.value = "Ä°ÅLETME DÃ–NEMÄ°NDE HESAPLANMAZ";
      return;
    }

    // 3ï¸âƒ£ BoÅŸ / geÃ§ersiz durumda 0 yaz
    if (!maskMap["diger_katki_tutari"]) {
      maskMap["diger_katki_tutari"] = IMask(input, {
        mask: Number,
        scale: 2,
        thousandsSeparator: ".",
        radix: ",",
        mapToRadix: ["."],
        lazy: false
      });
    }

    safeSet("diger_katki_tutari", 0);
  }





  function hesaplaFiiliKatkiTutari() {

    // 9903 modunda fiili katkÄ± hesaplanmaz
    if (document.getElementById("karar")?.value === "2025/9903") {
      return;
    }

    const karar = document.getElementById("karar")?.value;
    const toplamHarcamaInput = document.getElementById("toplam_harcama_tutari");
    const katkiOraniInput = document.getElementById("katki_orani");

    if (!toplamHarcamaInput || !katkiOraniInput) return;

    const toplamHarcama = parseFormattedNumber(toplamHarcamaInput.value);
    const oran = parseFormattedNumber(katkiOraniInput.value);

    // â— NaN kontrolÃ¼ â€” 0'a asla yanlÄ±ÅŸ iÅŸlem yapÄ±lmaz
    if (isNaN(toplamHarcama) || isNaN(oran)) {
      safeSet("fiili_katki_tutari", 0);
      return;
    }

    // ğŸ§® Fiili KatkÄ± = Harcama Ã— Oran / 100
    const fiiliKatki = (toplamHarcama * oran) / 100;

    // â›‘ IMask uyumlu ÅŸekilde yaz
    safeSet("fiili_katki_tutari", fiiliKatki);

    console.log(
      `ğŸ“Š [${karar}] Fiili KatkÄ± HesaplandÄ±: ${formatTL(toplamHarcama)} Ã— ${oran}% = ${formatTL(fiiliKatki)}`
    );
  }





  function hesaplaOncekiKatkiTutari() {
    // 9903 modunda bu hesaplama yapÄ±lmaz
    if (document.getElementById("karar")?.value === "2025/9903") {
      return;
    }

    const oncekiYatirimInput = document.getElementById("onceki_yatirim_katki_tutari");
    const oncekiDigerInput = document.getElementById("onceki_diger_katki_tutari");

    if (!oncekiYatirimInput || !oncekiDigerInput) return;

    const oncekiYatirim = parseFormattedNumber(oncekiYatirimInput.value);
    const oncekiDiger = parseFormattedNumber(oncekiDigerInput.value);

    const y = isNaN(oncekiYatirim) ? 0 : oncekiYatirim;
    const d = isNaN(oncekiDiger) ? 0 : oncekiDiger;

    safeSet("onceki_katki_tutari", y + d);

    hesaplaKalanVeEndeks();
  }





  function hesaplaKalanVeEndeks() {
    const karar = document.getElementById("karar")?.value || "";

    const toplamKatkiInput = document.getElementById("katki_tutari");
    const oncekiKatkiInput = document.getElementById("onceki_katki_tutari");
    const vizeSelect = document.getElementById("vize_durumu");
    const ydoInput = document.getElementById("yeniden_degerleme_orani");
    const endeksInput = document.getElementById("endeks_katki_tutari");

    if (!toplamKatkiInput || !oncekiKatkiInput || !endeksInput) return;

    const toplam = parseFormattedNumber(toplamKatkiInput.value);
    const onceki = parseFormattedNumber(oncekiKatkiInput.value);
    const kalan = (!isNaN(toplam) && !isNaN(onceki)) ? (toplam - onceki) : 0;

    // ğŸ“Œ Kalan katkÄ± NUMERÄ°K olarak yazÄ±lÄ±r
    safeSet("kalan_katki_tutari", kalan);

    // ============================================================
    // ğŸŸ¥ 2025/9903 â†’ Endeksleme yok â†’ maskeyi kaldÄ±r, text yaz
    // ============================================================
    if (karar === "2025/9903") {

      if (maskMap["endeks_katki_tutari"]) {
        maskMap["endeks_katki_tutari"].destroy();
        delete maskMap["endeks_katki_tutari"];
      }

      endeksInput.value = "2025/9903 KAPSAMINDA ENDEKSLEME YOKTUR";
      return;
    }

    // ============================================================
    // ğŸŸ¦ 3305 / 15199 â†’ Endeksleme kontrolÃ¼
    // ============================================================
    const vize = vizeSelect?.value || "";
    const ydo = parseFloat((ydoInput?.value || "").replace(",", "."));

    // ------------------------------------------------------------
    // âœ” Ä°ÅŸletme DÃ¶nemi (Evet) â†’ Endeksleme VAR â†’ SayÄ±sal hesap
    // ------------------------------------------------------------
    if (vize.includes("Evet")) {

      // maske yoksa geri kur
      if (!maskMap["endeks_katki_tutari"]) {
        maskMap["endeks_katki_tutari"] = IMask(endeksInput, {
          mask: Number,
          scale: 2,
          thousandsSeparator: ".",
          radix: ",",
          mapToRadix: ["."],
          lazy: false
        });
      }

      if (!isNaN(kalan) && !isNaN(ydo)) {
        const endeksli = (kalan * ydo) / 100;
        safeSet("endeks_katki_tutari", endeksli);
      } else {
        safeSet("endeks_katki_tutari", 0);
      }

      return;
    }

    // ------------------------------------------------------------
    // âœ” YatÄ±rÄ±m DÃ¶nemi (HayÄ±r) â†’ Endeksleme YOK â†’ Text yaz
    // ------------------------------------------------------------
    if (maskMap["endeks_katki_tutari"]) {
      maskMap["endeks_katki_tutari"].destroy();
      delete maskMap["endeks_katki_tutari"];
    }

    endeksInput.value = "YATIRIM DÃ–NEMÄ°NDE ENDEKSLEME YAPILMAZ";
  }



  function calculateKVMatrah() {
    const tRaw = parseFormattedNumber(document.getElementById('ticari_bilanco_kari')?.value);
    const kRaw = parseFormattedNumber(document.getElementById('kkeg')?.value);

    const t = isNaN(tRaw) ? 0 : tRaw;
    const k = isNaN(kRaw) ? 0 : kRaw;

    const val = t + k;

    safeSet("kv_matrah", val);
  }

  function updateIKVAmountAndRate(ikvMatrah, ihrPct, imlPct, digPct, vergiIndirimOraniFraction) {

    // ğŸ”¹ GÃ¼venli matrah (negatifse 0)
    const matrahRaw = Number(ikvMatrah) || 0;
    const matrah = matrahRaw < 0 ? 0 : matrahRaw;

    // ğŸ”¹ Oranlar 0â€“1 formatÄ±na zorla
    const pIhr = (Number(ihrPct) > 1) ? (Number(ihrPct) / 100) : Number(ihrPct) || 0;
    const pIml = (Number(imlPct) > 1) ? (Number(imlPct) / 100) : Number(imlPct) || 0;
    const pDig = (Number(digPct) > 1) ? (Number(digPct) / 100) : Number(digPct) || 0;

    // ğŸ”¹ Vergi indirim oranÄ± 0â€“1
    const pDisc = Number(vergiIndirimOraniFraction) || 0;

    // ğŸ”¹ Matrah kÄ±rÄ±lÄ±mÄ± (AÅŸama 6â€™ya uyumlu)
    const bespuan_matrah = matrah * pIhr;
    const birpuan_matrah = matrah * pIml;
    const normal_matrah = matrah * pDig;

    // ğŸ”¹ Genel KV oranlarÄ±
    const rIhrGen = 0.20;
    const rImlGen = 0.24;
    const rDigGen = 0.25;

    // ğŸ”¹ Ä°ndirimli oranlar
    const rIhrInd = rIhrGen * (1 - pDisc);
    const rImlInd = rImlGen * (1 - pDisc);
    const rDigInd = rDigGen * (1 - pDisc);

    // ğŸ”¹ AÄŸÄ±rlÄ±klÄ± efektif vergi oranÄ±
    const effRate =
      (pIhr * rIhrInd) +
      (pIml * rImlInd) +
      (pDig * rDigInd);

    // ğŸ”¹ Ä°ndirimli KV (Ã¶denecek vergi)
    const ikvAmount = matrah * effRate;

    // ğŸ”¹ Ä°ndirimli KV olmasaydÄ± Ã¶denecek vergi
    const vergi_olsaydi =
      (bespuan_matrah * rIhrGen) +
      (birpuan_matrah * rImlGen) +
      (normal_matrah * rDigGen);

    // ğŸ”¹ UI YAZ (IMask uyumlu)
    safeSet("indirimli_kv", ikvAmount);
    safeSet("indirimli_kv_oran", effRate * 100);

    const kvOlsaydiEl = document.getElementById('kv_olsaydi');
    if (kvOlsaydiEl) {
      kvOlsaydiEl.value = vergi_olsaydi.toLocaleString("tr-TR", {
        minimumFractionDigits: 2
      });
    }

    return {
      bespuan_matrah,
      birpuan_matrah,
      normal_matrah,
      vergi_olsaydi,
      effRate,
      ikvAmount
    };
  }




  function calculateCariAndNext() {
    const karar = document.getElementById("karar")?.value;

    // ============================================================
    // ğŸŸ¥ 2025/9903 Ã–ZEL AKIÅ
    // ============================================================
    if (karar === "2025/9903") {
      console.log("âš™ï¸ 2025/9903 aktif â€” Ã¶zel hesap fonksiyonu Ã§alÄ±ÅŸÄ±yor");

      if (typeof hesaplaKatkiTutari9903 === "function") {
        hesaplaKatkiTutari9903({ advance: true });
      } else {
        console.warn("âš ï¸ hesaplaKatkiTutari9903() bulunamadÄ±!");
      }

      return; // klasik hesaplama yok
    }

    // ============================================================
    // ğŸŸ¦ 3305 / 15199 KLASÄ°K AKIÅ BAÅLANGICI
    // ============================================================
    console.log("--- calculateCariAndNext() BAÅLADI ---");

    const vizeDurumuTercihi =
      document.getElementById("vize_durumu")?.value || "";

    const digerKazancUygulama =
      sessionStorage.getItem("diger_kazanc_uygulama") || "hayir";

    const kucukOlanDigerFaaliyetTutari =
      parseFormattedNumber(sessionStorage.getItem("kucuk_olan_diger_faaliyet")) || 0;

    // ------------------------------------------------------------
    // YATIRIM KAZANCI / TEVSÄ° KAZANCI OKUMA
    // ------------------------------------------------------------
    let tevsiYatirimKazanci = 0;

    const tevsiEl = document.getElementById("tevsi_yatirim_kazanci");
    const klasikEl = document.getElementById("yatirimdan_elde_edilen_kazanc");

    const tevsiVal = tevsiEl ? parseFormattedNumber(tevsiEl.value) : 0;
    const klasikVal = klasikEl ? parseFormattedNumber(klasikEl.value) : 0;

    if (tevsiVal > 0) tevsiYatirimKazanci = tevsiVal;
    else if (klasikVal > 0) tevsiYatirimKazanci = klasikVal;

    tevsiYatirimKazanci = Math.max(0, tevsiYatirimKazanci); // negatif Ã¶nleme

    const vergiIndirimOrani =
      (parseFormattedNumber(document.getElementById("vergi_orani").value) || 0) /
      100;

    const oncekiToplamKatki =
      parseFormattedNumber(document.getElementById("onceki_katki_tutari").value) || 0;

    // ------------------------------------------------------------
    // ORAN KAYNAKLARI (AyrÄ±ntÄ±lÄ± tablodan veya manuel giriÅŸten)
    // ------------------------------------------------------------
    const useDetailedRatios =
      document.getElementById("useDetailedProfitRatios")?.checked || false;

    let ihracatOraniFinal = 0;
    let imalatOraniFinal = 0;
    let digerOraniFinal = 0;

    if (useDetailedRatios) {
      ihracatOraniFinal =
        parseFloat(
          document
            .getElementById("ratio_ihracat")
            .textContent.replace("%", "")
            .replace(",", ".")
        ) /
        100 || 0;

      imalatOraniFinal =
        parseFloat(
          document
            .getElementById("ratio_imalat")
            .textContent.replace("%", "")
            .replace(",", ".")
        ) /
        100 || 0;

      digerOraniFinal =
        parseFloat(
          document
            .getElementById("ratio_diger")
            .textContent.replace("%", "")
            .replace(",", ".")
        ) /
        100 || 0;
    } else {
      const brutSatis =
        parseFormattedNumber(document.getElementById("brut_satis").value) || 0;
      const ihracatSatis =
        parseFormattedNumber(document.getElementById("ihracat").value) || 0;
      const imalatSatis =
        parseFormattedNumber(document.getElementById("imalat").value) || 0;
      const digerSatis =
        parseFormattedNumber(document.getElementById("diger_faaliyet").value) || 0;

      if (brutSatis > 0) {
        ihracatOraniFinal = ihracatSatis / brutSatis;
        imalatOraniFinal = imalatSatis / brutSatis;
        digerOraniFinal = digerSatis / brutSatis;
      }
    }

    // ------------------------------------------------------------
    // KURUMLAR VERGÄ°SÄ° ORANLARI
    // ------------------------------------------------------------
    const kvOranIhracat = 0.20;
    const kvOranImalat = 0.24;
    const kvOranDiger = 0.25;

    let cariYatirimKatkisi = 0;
    let cariDigerKatkisi = 0;
    let indirimliKurumlarVergisiMatrahi = 0;

    // ------------------------------------------------------------
    // SENARYOLAR
    // ------------------------------------------------------------

    // ğŸŸ© 1) Tamamlama Vizesi â†’ EVET (Ä°ÅŸletme DÃ¶nemi)
    if (vizeDurumuTercihi.includes("Evet")) {
      indirimliKurumlarVergisiMatrahi = tevsiYatirimKazanci;

      cariYatirimKatkisi =
        tevsiYatirimKazanci *
        (ihracatOraniFinal * kvOranIhracat +
          imalatOraniFinal * kvOranImalat +
          digerOraniFinal * kvOranDiger) *
        vergiIndirimOrani;

      cariDigerKatkisi = 0;
    }

    // ğŸŸ¨ 2) Tamamlama Vizesi â†’ HAYIR (YatÄ±rÄ±m DÃ¶nemi)
    else if (vizeDurumuTercihi.includes("HayÄ±r")) {
      // ğŸŸ¨ Alt Senaryo A â†’ DiÄŸer faaliyetlerden yararlanÄ±lacak
      if (digerKazancUygulama === "evet") {
        const kvMatrah =
          parseFormattedNumber(document.getElementById("kv_matrah")?.value) || 0;

        const kalanKatki =
          parseFormattedNumber(document.getElementById("kalan_katki_tutari")?.value) || 0;

        const mevzuatTavani = kucukOlanDigerFaaliyetTutari || 0;

        const effRate =
          ihracatOraniFinal * (0.20 * (1 - vergiIndirimOrani)) +
          imalatOraniFinal * (0.24 * (1 - vergiIndirimOrani)) +
          digerOraniFinal * (0.25 * (1 - vergiIndirimOrani));

        const kvTavanVergi = effRate > 0 ? kvMatrah * effRate : 0;

        const cariDigerKatkisiHesap = Math.min(kalanKatki, mevzuatTavani, kvTavanVergi);

        cariDigerKatkisi = Math.max(0, cariDigerKatkisiHesap);

        indirimliKurumlarVergisiMatrahi =
          effRate > 0 ? cariDigerKatkisi / effRate : 0;

        cariYatirimKatkisi = 0;
      }

      // ğŸŸ¨ Alt Senaryo B â†’ DiÄŸer faaliyetlerden yararlanÄ±lmayacak
      else {
        indirimliKurumlarVergisiMatrahi = tevsiYatirimKazanci;

        cariYatirimKatkisi =
          tevsiYatirimKazanci *
          (ihracatOraniFinal * kvOranIhracat +
            imalatOraniFinal * kvOranImalat +
            digerOraniFinal * kvOranDiger) *
          vergiIndirimOrani;

        cariDigerKatkisi = 0;
      }
    }

    // ============================================================
    // ğŸ“Œ SONUÃ‡ YAZIMLARI â€” SAFESET zorunlu
    // ============================================================
    const cariToplamKatki = cariYatirimKatkisi + cariDigerKatkisi;
    const genelToplamKatki = oncekiToplamKatki + cariToplamKatki;

    safeSet("cari_yatirim_katki", cariYatirimKatkisi);
    safeSet("cari_diger_katki", cariDigerKatkisi);
    safeSet("cari_toplam_katki", cariToplamKatki);
    safeSet("genel_toplam_katki", genelToplamKatki);
    safeSet("indirimli_matrah", indirimliKurumlarVergisiMatrahi);

    // KV HesabÄ±
    updateIKVAmountAndRate(
      indirimliKurumlarVergisiMatrahi,
      ihracatOraniFinal,
      imalatOraniFinal,
      digerOraniFinal,
      vergiIndirimOrani
    );

    console.log("--- calculateCariAndNext() BÄ°TTÄ°, _updateStepDisplay(7) Ã§aÄŸrÄ±lÄ±yor ---");
    _updateStepDisplay(7);
  }









  async function askWhichIncomeToApplyDiscount() {
    const karar = (document.getElementById('karar')?.value || "").trim();
    const vizeRaw = (document.getElementById('vize_durumu')?.value || '').trim().toLowerCase();
    const isIsletme = vizeRaw.includes('evet') || vizeRaw.includes('iÅŸletme');

    let html = `
    <div style="display: flex; flex-direction: column; gap: 12px;">
      <button id="btn-yatirim" class="swal-choice-btn">
        ğŸ’¼ <b>Sadece YatÄ±rÄ±mdan Elde Edilen KazanÃ§lar iÃ§in</b><br>
        <small>(TeÅŸvik belgesi kapsamÄ±ndaki yatÄ±rÄ±m kazanÃ§larÄ±na uygulanÄ±r)</small>
      </button>

      <button id="btn-diger" class="swal-choice-btn ${isIsletme && karar !== '2025/9903' ? 'disabled-btn' : ''}">
        ğŸ¢ <b>Sadece DiÄŸer Faaliyetlerden Elde Edilen KazanÃ§lar iÃ§in</b><br>
        <small>(Mevzuatta belirtilen sÃ¼re ve oran sÄ±nÄ±rlamalarÄ±yla)</small>
      </button>

      <button id="btn-herikisi" class="swal-choice-btn ${isIsletme && karar !== '2025/9903' ? 'disabled-btn' : ''}">
        âš–ï¸ <b>Her Ä°kisi Ä°Ã§in de Uygulamak Ä°stiyorum</b><br>
        <small>(Hem yatÄ±rÄ±m hem de diÄŸer kazanÃ§lara indirim uygulanacak)</small>
      </button>
    </div>
  `;

    Swal.fire({
      title: 'Ä°ndirimli kurumlar vergisini hangi kazanÃ§ iÃ§in hesaplamak istediÄŸinizi seÃ§iniz.',
      html,
      showConfirmButton: false,
      showCancelButton: true,
      cancelButtonText: 'Ä°ptal',
      width: 600,
      customClass: {
        popup: 'swal2-green-theme-popup',
        header: 'swal2-green-theme-header',
        title: 'swal2-green-theme-title',
        htmlContainer: 'swal2-green-theme-html-container',
        cancelButton: 'swal2-green-theme-cancel-button'
      },
      didOpen: () => {
        const style = document.createElement('style');
        style.innerHTML = `
        .swal-choice-btn {
          background-color: #f8f9fa;
          border: 1px solid #d1d1d1;
          border-radius: 8px;
          padding: 12px 14px;
          text-align: left;
          font-size: 14px;
          transition: all 0.2s ease;
          cursor: pointer;
        }
        .swal-choice-btn:hover {
          background-color: #e9f7ef;
          border-color: #28a745;
          transform: scale(1.02);
        }
        .swal-choice-btn small { color: #555; }

        /* ğŸ”’ Pasif buton stili */
        .disabled-btn {
          background-color: #f0f0f0 !important;
          color: #999 !important;
          border-color: #ccc !important;
          cursor: not-allowed !important;
          pointer-events: none !important;
          opacity: 0.7 !important;
        }
      `;
        document.head.appendChild(style);

        const waitForButtons = () => new Promise(resolve => {
          const check = () => {
            const btnY = document.getElementById('btn-yatirim');
            const btnD = document.getElementById('btn-diger');
            const btnH = document.getElementById('btn-herikisi');
            if (btnY && btnD && btnH) resolve({ btnY, btnD, btnH });
            else setTimeout(check, 50);
          };
          check();
        });

        (async () => {
          const { btnY, btnD, btnH } = await waitForButtons();
          if (btnY) btnY.addEventListener('click', async () => await handleIncomeSelection('yatirim'));
          if (btnD && !btnD.classList.contains('disabled-btn')) btnD.addEventListener('click', async () => await handleIncomeSelection('diger'));
          if (btnH && !btnH.classList.contains('disabled-btn')) btnH.addEventListener('click', async () => await handleIncomeSelection('herikisi'));
        })();
      }
    });

    // ğŸ”¹ SeÃ§im sonrasÄ± yÃ¶nlendirme
    async function handleIncomeSelection(choice) {
      Swal.close();
      await new Promise(r => setTimeout(r, 100));

      if (choice === 'yatirim') {
        await handleInvestmentIncomeFlow(); // âœ… yeni fonksiyon burada Ã§aÄŸrÄ±lÄ±r
        return;
      }

      if (choice === 'diger') {
        startOtherActivitiesFlow9903();
        return;
      }

      if (choice === 'herikisi') {
        if (karar === "2025/9903") {
          await await handleInvestmentIncomeFlow();
        } else {
          await askTevsiKazancQuestion();
        }
        await startOtherActivitiesFlow9903();
        return;
      }
    }
  }





  async function handleInvestmentIncomeFlow() {
    const karar = (document.getElementById('karar')?.value || "").trim();
    const yatirimTuru = (document.getElementById('yatirim_turu1')?.value || "").trim().toLowerCase();

    console.log("ğŸ”¹ handleInvestmentIncomeFlow() Ã§alÄ±ÅŸtÄ±:", { karar, yatirimTuru });

    const yatirimKazancInput = document.getElementById('yatirimdan_elde_edilen_kazanc');
    const tevsiKazancInput = document.getElementById('tevsi_yatirim_kazanci');

    const formatTL = (num) => num.toLocaleString('tr-TR', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });

    // --- 1ï¸âƒ£ KARAR 2025/9903 ---
    if (karar === "2025/9903") {
      const result = await Swal.fire({
        title: 'YatÄ±rÄ±mdan Elde Edilen KazanÃ§ (2025/9903)',
        input: 'text',
        inputPlaceholder: '0,00 TL',
        showCancelButton: true,
        confirmButtonText: 'Kaydet',
        cancelButtonText: 'VazgeÃ§',
        reverseButtons: true
      });

      if (result.isConfirmed && result.value && yatirimKazancInput) {
        const val = parseFormattedNumber(result.value);
        yatirimKazancInput.value = formatTL(val);
        Swal.fire('âœ… Kaydedildi', 'YatÄ±rÄ±m kazancÄ± AÅŸama 5â€™e aktarÄ±ldÄ±.', 'success');
      }
    }

    // --- 2ï¸âƒ£ 2025/9903 DEÄÄ°L VE YATIRIM TÃœRÃœ TEVSÄ° ---
    else if (yatirimTuru === "tevsi") {
      const result = await Swal.fire({
        title: 'Tevsi YatÄ±rÄ±m Bilgisi',
        html: '<div style="text-align: justify;">Tevsi yatÄ±rÄ±mlardan elde edilen kazancÄ± ayrÄ± bir ÅŸekilde tespit edebiliyor musunuz?</div>',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Evet',
        cancelButtonText: 'HayÄ±r',
        reverseButtons: true
      });

      if (result.isConfirmed) {
        // âœ… EVET â†’ elle giriÅŸ
        const inputResult = await Swal.fire({
          title: 'Tevsi YatÄ±rÄ±mlardan Elde Edilen KazanÃ§ TutarÄ± (TL)',
          input: 'text',
          inputPlaceholder: '0,00 TL',
          showCancelButton: true,
          confirmButtonText: 'Kaydet',
          cancelButtonText: 'VazgeÃ§',
          reverseButtons: true
        });

        if (inputResult.isConfirmed && inputResult.value && tevsiKazancInput) {
          const val = parseFormattedNumber(inputResult.value);
          tevsiKazancInput.value = formatTL(val);
          Swal.fire('âœ… Kaydedildi', 'Tevsi kazancÄ± ilgili satÄ±ra aktarÄ±ldÄ±.', 'success');

          // ğŸ”¹ EVET denirse aÅŸaÄŸÄ±daki iki alanÄ± pasif + gri yap
          const sabitInput = document.getElementById('toplam_sabit_kiymet_tutari');
          const tevsiInput = document.getElementById('gerceklesen_tevsi_yatirim_tutari');

          [sabitInput, tevsiInput].forEach(el => {
            if (el) {
              el.setAttribute('readonly', true);
              el.classList.add('disabled-input');
            }
          });
        }
      } else {
        // âŒ HAYIR â†’ otomatik hesaplanacak
        await Swal.fire({
          title: 'Bilgilendirme',
          html: '<div style="text-align: justify;">GerÃ§ekleÅŸen tevsi yatÄ±rÄ±m tutarÄ±na, toplam sabit kÄ±ymet tutarÄ±na ve ticari bilanÃ§o kÃ¢rÄ±na gÃ¶re kazanÃ§ otomatik hesaplanacaktÄ±r.</div>',
          icon: 'info',
          confirmButtonText: 'Tamam'
        });
        if (typeof calculateTevsiKazancAutomatically === 'function') {
          calculateTevsiKazancAutomatically();
        }
      }
    }

    // --- 3ï¸âƒ£ 2025/9903 DEÄÄ°L VE TEVSÄ° DEÄÄ°L ---
    else {
      const result = await Swal.fire({
        title: 'YatÄ±rÄ±mdan Elde Edilen KazanÃ§',
        input: 'text',
        inputPlaceholder: '0,00 TL',
        showCancelButton: true,
        confirmButtonText: 'Kaydet',
        cancelButtonText: 'VazgeÃ§',
        reverseButtons: true
      });

      if (result.isConfirmed && result.value && yatirimKazancInput) {
        const val = parseFormattedNumber(result.value);
        yatirimKazancInput.value = formatTL(val);
        Swal.fire('âœ… Kaydedildi', 'YatÄ±rÄ±m kazancÄ± AÅŸama 5â€™e aktarÄ±ldÄ±.', 'success');
      }
    }

    // --- Ortak adÄ±m ---
    if (typeof promptTicariKariVeKKEGThenGoTo6 === 'function') {
      promptTicariKariVeKKEGThenGoTo6();
    }
    _updateStepDisplay(5);
  }







  function calculateTevsiKazancAutomatically(attempt = 0) {
    const tur1Select = document.getElementById("yatirim_turu1");

    // YatÄ±rÄ±m tÃ¼rÃ¼ tevsi deÄŸilse Ã§Ä±k
    if (!tur1Select || tur1Select.value.toLowerCase() !== "tevsi") {
      return;
    }

    const elGerceklesen = document.getElementById("gerceklesen_tevsi_yatirim_tutari");
    const elSabit = document.getElementById("toplam_sabit_kiymet_tutari");
    const elKar = document.getElementById("ticari_bilanco_kari");
    const elTarget = document.getElementById("tevsi_yatirim_kazanci");

    // Elementler eksikse retry
    if (!elGerceklesen || !elSabit || !elKar || !elTarget) {
      if (attempt < 10) {
        setTimeout(() => calculateTevsiKazancAutomatically(attempt + 1), 300);
      }
      return;
    }

    const gerceklesen = parseFormattedNumber(elGerceklesen.value);
    const sabit = parseFormattedNumber(elSabit.value);
    const kar = parseFormattedNumber(elKar.value);

    let kazanc = 0;
    if (!isNaN(gerceklesen) && !isNaN(sabit) && !isNaN(kar) && sabit !== 0) {
      kazanc = (gerceklesen / sabit) * kar;
    }

    // EÄŸer IMask yoksa oluÅŸtur
    if (!maskMap["tevsi_yatirim_kazanci"]) {
      maskMap["tevsi_yatirim_kazanci"] = IMask(elTarget, {
        mask: Number,
        scale: 2,
        thousandsSeparator: ".",
        radix: ",",
        mapToRadix: ["."],
        lazy: false
      });
    }

    // DeÄŸeri sadece safeSet ile yaz â†’ tam uyumlu
    safeSet("tevsi_yatirim_kazanci", kazanc);
  }









  function startOtherActivitiesFlow9903() {
    sessionStorage.setItem('diger_kazanc_uygulama', 'evet');

    const digerKatkiEl = document.getElementById('diger_katki_tutari');
    const harcamaEl = document.getElementById('toplam_harcama_tutari');

    const digerKatki = digerKatkiEl ? parseFormattedNumber(digerKatkiEl.value) : 0;
    const harcama = harcamaEl ? parseFormattedNumber(harcamaEl.value) : 0;
    const kucukOlan = Math.min(digerKatki || 0, harcama || 0);

    sessionStorage.setItem('kucuk_olan_diger_faaliyet', kucukOlan);

    Swal.fire({
      title: 'DiÄŸer Faaliyetler Ä°Ã§in Ãœst SÄ±nÄ±r',
      html: `Bu dÃ¶nemde diÄŸer faaliyet kazanÃ§larÄ±na uygulanabilecek azami katkÄ± tutarÄ±:<br><br>
       <b>${kucukOlan.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} TL</b>`,
      icon: 'info',
      confirmButtonText: 'Tamam'
    }).then(() => {
      // ğŸ”¹ Ticari bilanÃ§o + KKEG popupâ€™Ä±nÄ± gÃ¶ster, ardÄ±ndan Step 5â€™e geÃ§
      if (typeof promptTicariKariVeKKEGThenGoTo6 === 'function') {
        // popupâ€™Ä± yine aÃ§, ama yÃ¶nlendirme 5â€™e
        promptTicariKariVeKKEGThenGoTo6();
      }
      _updateStepDisplay(5);
    });
  }



  function askSmallestAmountQuestionForOtherActivities() {
    // Gerekli deÄŸerleri DOM'dan veya mevcut hesaplamalardan alalÄ±m
    const digerKatkiTutariElement = document.getElementById('diger_katki_tutari');
    const toplamHarcamaTutariElement = document.getElementById('toplam_harcama_tutari');

    // Elementlerin varlÄ±ÄŸÄ±nÄ± kontrol et, yoksa varsayÄ±lan deÄŸer kullan
    const digerKatkiTutari = digerKatkiTutariElement ? parseFormattedNumber(digerKatkiTutariElement.value) : 0;
    const toplamHarcamaTutari = toplamHarcamaTutariElement ? parseFormattedNumber(toplamHarcamaTutariElement.value) : 0;

    let kucukOlanDeger;

    // KÃ¼Ã§Ã¼k olan deÄŸeri bulma mantÄ±ÄŸÄ±
    if (digerKatkiTutari === 0 && toplamHarcamaTutari === 0) {
      kucukOlanDeger = 0; // Her iki deÄŸer de sÄ±fÄ±rsa kÃ¼Ã§Ã¼k olan da sÄ±fÄ±rdÄ±r.
    } else if (digerKatkiTutari === 0) {
      kucukOlanDeger = toplamHarcamaTutari; // DiÄŸer katkÄ± sÄ±fÄ±rsa, toplam harcama kÃ¼Ã§Ã¼ktÃ¼r.
    } else if (toplamHarcamaTutari === 0) {
      kucukOlanDeger = digerKatkiTutari; // Toplam harcama sÄ±fÄ±rsa, diÄŸer katkÄ± kÃ¼Ã§Ã¼ktÃ¼r.
    } else {
      kucukOlanDeger = Math.min(digerKatkiTutari, toplamHarcamaTutari); // Ä°ki deÄŸerden kÃ¼Ã§Ã¼k olanÄ± seÃ§.
    }

    // Hesaplanan kÃ¼Ã§Ã¼k deÄŸeri sessionStorage'a kaydet
    sessionStorage.setItem('kucuk_olan_diger_faaliyet', kucukOlanDeger);

    // DiÄŸer faaliyetlere indirim uygulanacaksa tevsi yatÄ±rÄ±m alanlarÄ±nÄ± sÄ±fÄ±rla
    // Bu, Ã¶nceki SweetAlert zincirinde de yapÄ±lÄ±yordu, burada tekrar edilmesi garanti saÄŸlar.
    document.getElementById('gerceklesen_tevsi_yatirim_tutari').value = '';
    document.getElementById('toplam_sabit_kiymet_tutari').value = '';
    document.getElementById('ticari_bilanco_kari').value = '';
    document.getElementById('tevsi_yatirim_kazanci').value = '';

    // KullanÄ±cÄ±ya SweetAlert ile bilgilendirme mesajÄ± gÃ¶ster
    Swal.fire({
      title: 'Otomatik Hesaplama YapÄ±ldÄ±!',
      html: `<div style="text-align: justify;">DiÄŸer faaliyetlerinizden elde ettiÄŸiz kazanÃ§larÄ±nÄ±za uygulanabilecek maksimum indirimli kurumlar vergisi tutarÄ±:<br><br><b>${kucukOlanDeger.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} TL</b></div>`,
      icon: 'info', // Bilgilendirme ikonu kullan
      showConfirmButton: true, // "Tamam" butonu gÃ¶ster
      confirmButtonText: 'Tamam',
      customClass: {
        popup: 'swal2-green-theme-popup',
        header: 'swal2-green-theme-header',
        title: 'swal2-green-theme-title',
        icon: 'swal2-green-theme-icon',
        confirmButton: 'swal2-green-theme-confirm-button',
        htmlContainer: 'swal2-green-theme-html-container'
      }
    }).then(() => {
      // 6â€™ya geÃ§meden Ã¶nce Ticari KÃ¢r + KKEGâ€™yi iste
      if (typeof promptTicariKariVeKKEGThenGoTo6 === 'function') {
        promptTicariKariVeKKEGThenGoTo6();
      }
      _updateStepDisplay(5); // gÃ¼venlik iÃ§in

    });
  }



  async function promptTicariKariVeKKEGThenGoTo6() {
    // ğŸ”¹ TÃ¼rk formatÄ±nda TL yazdÄ±ran fonksiyon (Python'daki tlformat eÅŸdeÄŸeri)
    const formatTL = (num) => {
      if (isNaN(num) || num === null) return "0,00";
      return num
        .toFixed(2)
        .replace(".", ",")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    };

    // ğŸ”¹ VirgÃ¼l/nokta iÃ§eren string'i parse eden fonksiyon
    const parseFormattedNumber = (val) => {
      if (!val) return 0;
      return parseFloat(val.replace(/\./g, "").replace(",", "."));
    };

    const { value: vals, isConfirmed, isDismissed } = await Swal.fire({
      title: 'Cari DÃ¶nem Verileri',
      html: `
      <div style="text-align:left">
        <!-- Ticari BilanÃ§o KÃ¢rÄ± -->
        <div style="margin-bottom:14px;">
          <label style="font-size:13px; color:#555;">Ticari BilanÃ§o KÃ¢rÄ± (TL)</label>
          <input id="swal_ticari" class="swal2-input" placeholder="0,00" inputmode="decimal" style="margin:0; width:100%;">
        </div>

        <!-- KKEG -->
        <div style="margin-bottom:14px;">
          <label style="font-size:13px; color:#555;">KKEG (TL)</label>
          <input id="swal_kkeg" class="swal2-input" placeholder="0,00" inputmode="decimal" style="margin:0; width:100%;">
        </div>

        <!-- Matrah kutusu -->
        <div style="margin-top:6px; padding:14px; background:#f6faf6; border:1px solid #d5ead5; border-radius:10px;">
          <div style="font-weight:700; font-size:14px; margin-bottom:6px;">Kurumlar Vergisi MatrahÄ±</div>
          <div style="font-size:13px; color:#444; margin-bottom:8px;">
            Matrah = <b>Ticari BilanÃ§o KÃ¢rÄ±</b> + <b>KKEG</b>
          </div>
          <input id="swal_matrah" class="swal2-input" placeholder="0,00" readonly
                 style="margin:0; background:#f0f0f0; width:100%;">
        </div>
      </div>
    `,
      focusConfirm: false,
      showCancelButton: true, // ğŸ”¹ Ä°PTAL butonu eklendi
      cancelButtonText: 'Ä°ptal',
      confirmButtonText: 'Kaydet ve devam et',
      allowOutsideClick: false,
      allowEscapeKey: true,
      reverseButtons: true, // ğŸ”¹ buton sÄ±rasÄ±nÄ± ters Ã§evir: Ä°ptal solda, Kaydet saÄŸda
      customClass: {
        popup: 'swal2-green-theme-popup',
        confirmButton: 'swal2-green-theme-confirm-button',
        cancelButton: 'swal2-green-theme-cancel-button'
      },
      didOpen: () => {
        const tEl = document.getElementById('swal_ticari');
        const kEl = document.getElementById('swal_kkeg');
        const mEl = document.getElementById('swal_matrah');

        const update = () => {
          const t = parseFormattedNumber(tEl.value);
          const k = parseFormattedNumber(kEl.value);
          const sum = (t || 0) + (k || 0);
          mEl.value = formatTL(sum);
        };

        // ğŸ”¹ AnlÄ±k formatlama
        [tEl, kEl].forEach(el => {
          el.addEventListener("input", (e) => {
            const caretPos = el.selectionStart;
            const val = parseFormattedNumber(e.target.value);
            e.target.value = formatTL(val);
            el.setSelectionRange(caretPos, caretPos);
            update();
          });
        });

        update();
      },
      preConfirm: () => {
        const t = parseFormattedNumber(document.getElementById('swal_ticari').value);
        const k = parseFormattedNumber(document.getElementById('swal_kkeg').value);
        if (isNaN(t) || isNaN(k)) {
          Swal.showValidationMessage('LÃ¼tfen geÃ§erli sayÄ±lar girin.');
          return false;
        }
        return { t, k, m: (t || 0) + (k || 0) };
      }
    });

    // ğŸ”¹ Ä°ptal durumunda hiÃ§bir ÅŸey yapÄ±lmaz
    if (isDismissed) {
      console.log("âŒ KullanÄ±cÄ± cari dÃ¶nem giriÅŸini iptal etti.");
      return;
    }

    if (isConfirmed && vals) {
      const tOut = document.getElementById('ticari_bilanco_kari');
      const kOut = document.getElementById('kkeg');
      const mOut = document.getElementById('kv_matrah');

      if (tOut) tOut.value = formatTL(vals.t);
      if (kOut) kOut.value = formatTL(vals.k);
      if (mOut) mOut.value = formatTL(vals.m);

      if (typeof calculateKVMatrah === 'function') calculateKVMatrah();

      _updateStepDisplay(5);
    }
  }



  function goToStep1() { _updateStepDisplay(1); }

  function goToStep2() {
    // ğŸ”¹ AlanlarÄ± al
    const karar = document.getElementById("karar")?.value.trim();
    const programTuru = document.getElementById("program_turu")?.value.trim();
    const vizeDurumu = (document.getElementById("vize_durumu")?.value || "").trim();

    // ğŸ”¹ Genel zorunlu kontroller
    if (!karar) {
      Swal.fire({
        icon: "warning",
        title: "Eksik Bilgi",
        text: "LÃ¼tfen 'TeÅŸvik Belgesi Hangi Karara GÃ¶re DÃ¼zenlendi' alanÄ±nÄ± seÃ§iniz.",
        confirmButtonText: "Tamam"
      });
      return;
    }

    if (!vizeDurumu || vizeDurumu === "SeÃ§iniz") {
      Swal.fire({
        icon: "warning",
        title: "Eksik Bilgi",
        text: "LÃ¼tfen 'Tamamlama Vizesi YapÄ±ldÄ± mÄ±?' alanÄ±nÄ± seÃ§iniz.",
        confirmButtonText: "Tamam"
      });
      return;
    }

    // ğŸ”¹ 2025/9903 iÃ§in ek zorunluluk
    if (karar === "2025/9903" && !programTuru) {
      Swal.fire({
        icon: "warning",
        title: "Eksik Bilgi",
        text: "Bu karar iÃ§in 'Program TÃ¼rÃ¼' seÃ§imi zorunludur.",
        confirmButtonText: "Tamam"
      });
      return;
    }

    // ğŸ”¹ AÅŸama 1â€™deki deÄŸerleri gizli alanlara kopyala
    const belgeNo = document.querySelector('[name="belge_no"]')?.value || '';
    const belgeTarihi = document.querySelector('[name="belge_tarihi"]')?.value || '';
    const bolge = document.querySelector('[name="bolge"]')?.value || '';

    const hiddenBelgeNo = document.querySelector('[name="belge_no_hidden"]');
    const hiddenBelgeTarihi = document.querySelector('[name="belge_tarihi_hidden"]');
    const hiddenBolge = document.querySelector('[name="bolge_hidden"]');

    if (hiddenBelgeNo) hiddenBelgeNo.value = belgeNo;
    if (hiddenBelgeTarihi) hiddenBelgeTarihi.value = belgeTarihi;
    if (hiddenBolge) hiddenBolge.value = bolge;

    console.log("ğŸŸ¢ Gizli alanlar gÃ¼ncellendi:", { belgeNo, belgeTarihi, bolge });

    // ğŸ”¹ Her ÅŸey tamamsa bir sonraki adÄ±ma geÃ§
    _updateStepDisplay(2);
    setTimeout(() => {
      setBolge();
      setOranlar();
    }, 50);
  }

  function goToStep3() {
    const donem = document.getElementById("donem")?.value;

    if (!donem) {
      Swal.fire("Eksik Bilgi", "LÃ¼tfen hesap dÃ¶nemi seÃ§iniz.", "warning");
      return; // step3'e geÃ§me!
    }

    _updateStepDisplay(3);
  }

  function goToStep4() { _updateStepDisplay(4); }

  async function goToStep5(source) {
    if (source === 'from6') {
      _updateStepDisplay(5);
      return;
    }

    setTimeout(async () => {
      const karar = (document.getElementById('karar')?.value || "").trim();
      const vizeDurumu = (document.getElementById('vize_durumu')?.value || "").trim().toLowerCase();

      try {
        if (karar === "2025/9903") {
          console.log("âœ… 2025/9903 kararÄ±: yeni kazanÃ§ seÃ§imi sorusu gÃ¶steriliyor.");
          await askWhichIncomeToApplyDiscount();
        } else if (vizeDurumu.includes("evet") || vizeDurumu.includes("hayÄ±r") || vizeDurumu.includes("hayir")) {
          console.log("ğŸ“˜ 2025/9903 dÄ±ÅŸÄ± karar: klasik kazanÃ§ seÃ§imi sorusu gÃ¶steriliyor.");
          await askWhichIncomeToApplyDiscount();
        } else {
          console.log("âšª Vize durumu boÅŸ, doÄŸrudan aÅŸama 5â€™e geÃ§iliyor.");
        }
      } catch (e) {
        console.warn("âš ï¸ Soru akÄ±ÅŸÄ± hata verdi:", e);
      } finally {
        // ğŸŸ© Her durumda aÅŸama 5â€™e geÃ§
        _updateStepDisplay(5);
      }
    }, 100);
  }




  function goToStep6() {
    // ğŸŸ© EÄŸer mevcut aÅŸama 4'ten geliniyorsa (sorularÄ±n ardÄ±ndan),
    // otomatik olarak 5. aÅŸamaya geÃ§
    if (CURRENT_STEP === 4) {
      console.log("ğŸ” AÅŸama 4'ten gelindi â†’ 6 yerine 5'e yÃ¶nlendiriliyor.");
      _updateStepDisplay(5);
      return;
    }

    // DiÄŸer durumlarda (Ã¶r. 5 â†’ 6 veya 6 â†’ 7) normal akÄ±ÅŸta ilerle
    _updateStepDisplay(6);
  }

  function goToStep7() { _updateStepDisplay(7); }



  const currentBelgeJSData = {{ current_belge | tojson | safe
  }};

  function clearAllFormData() {
    Swal.fire({
      title: "TÃ¼m veriler temizlensin mi?",
      text: "Belge numarasÄ± ve belge tarihi korunacaktÄ±r.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Evet, temizle",
      cancelButtonText: "VazgeÃ§",
    }).then((result) => {
      if (!result.isConfirmed) return;

      // ğŸ›‘ Ã–nce korunacak deÄŸerleri al
      const belgeNoVal =
        document.getElementById("belge_no")?.value ||
        document.getElementById("belge_no_hidden")?.value ||
        "";
      const belgeTarihiVal =
        document.getElementById("belge_tarihi")?.value ||
        document.getElementById("belge_tarihi_hidden")?.value ||
        "";

      // ğŸ”’ SessionStorage'da da saklÄ±yoruz ki restore sÄ±rasÄ±nda kaybolmasÄ±n
      sessionStorage.setItem("KEEP_belge_no", belgeNoVal);
      sessionStorage.setItem("KEEP_belge_tarihi", belgeTarihiVal);

      // ğŸ”„ TÃ¼m inputlarÄ± temizle ama belge no + tarihi HARÄ°Ã‡
      document.querySelectorAll("input, select, textarea").forEach(el => {
        if (el.type === "file") return;

        const name = el.name || el.id;
        if (!name) return;

        const safeNames = [
          "belge_no",
          "belge_no_hidden",
          "belge_tarihi",
          "belge_tarihi_hidden"
        ];

        if (safeNames.includes(name) || safeNames.includes(el.id)) {
          return; // dokunma
        }

        // âœ”ï¸ DiÄŸer alanlarÄ± temizle
        if (el.type === "checkbox" || el.type === "radio") el.checked = false;
        else el.value = "";

        // Session'dan da temizle
        sessionStorage.removeItem(`form_${name}`);
      });

      // ğŸ”„ SessionStorage'dan tÃ¼m aÅŸama verilerini sil
      sessionStorage.removeItem("last_step");
      sessionStorage.removeItem("manual_katki");
      sessionStorage.removeItem("manual_katki_value");
      sessionStorage.removeItem("manual_vergi");
      sessionStorage.removeItem("manual_vergi_value");
      sessionStorage.removeItem("manual_kv_matrah");
      sessionStorage.removeItem("manual_kv_matrah_value");
      sessionStorage.removeItem("use_detailed_profit_ratios");

      Swal.fire({
        icon: "success",
        title: "Form temizlendi (Belge No ve Tarihi korundu)",
        showConfirmButton: false,
        timer: 1200,
        toast: true,
        position: "top-end"
      });

      // ğŸ“Œ Temizleme sonrasÄ± Step 1'e dÃ¶n
      if (typeof _updateStepDisplay === "function") {
        _updateStepDisplay(1);
      }
    });
  }




  function getBelgeNo() {
    // 1ï¸âƒ£ Step 1'deki input
    const fromInput = document.getElementById("belge_no")?.value?.trim();
    if (fromInput) return fromInput;

    // 2ï¸âƒ£ Hidden input â†’ mevcut belgeyi dÃ¼zenlerken
    const fromHidden = document.getElementById("belge_no_hidden")?.value?.trim();
    if (fromHidden) return fromHidden;

    // 3ï¸âƒ£ SessionStorage (restore iÃ§in)
    const fromFormSession = sessionStorage.getItem("form_belge_no");
    if (fromFormSession) return fromFormSession;

    // 4ï¸âƒ£ AÅŸamalar arasÄ± geÃ§iÅŸte kullanÄ±lan deÄŸer
    const fromSession = sessionStorage.getItem("belge_no");
    if (fromSession) return fromSession;

    return "";
  }






  function collectDonemUsageData() {
    const belgeNo = getBelgeNo();
    const donemSecimi = document.getElementById("donem")?.value || "";

    let hesap_donemi = null;
    let donem_turu = null;

    const match = donemSecimi.match(/(\d{4})\s*-\s*(.+)/);
    if (match) {
      hesap_donemi = parseInt(match[1]);
      donem_turu = match[2].trim().toUpperCase();
    }

    return {
      belge_no: belgeNo || "",
      hesap_donemi,
      donem_turu,


      // ğŸ”µ Sadece tesvik_kullanim tablosunda OLAN kolonlar
      yatirimdan_elde_edilen_kazanc: parseFormattedNumber(document.getElementById("yatirimdan_elde_edilen_kazanc")?.value),
      tevsi_yatirim_kazanci: parseFormattedNumber(document.getElementById("tevsi_yatirim_kazanci")?.value),
      diger_faaliyet: parseFormattedNumber(document.getElementById("diger_faaliyet")?.value),

      cari_yatirim_katki: parseFormattedNumber(document.getElementById("cari_yatirim_katki")?.value),
      cari_diger_katki: parseFormattedNumber(document.getElementById("cari_diger_katki")?.value),
      cari_toplam_katki: parseFormattedNumber(document.getElementById("cari_toplam_katki")?.value),

      genel_toplam_katki: parseFormattedNumber(document.getElementById("genel_toplam_katki")?.value),
      kalan_katki_tutari: parseFormattedNumber(document.getElementById("kalan_katki_tutari")?.value),

      indirimli_matrah: parseFormattedNumber(document.getElementById("indirimli_matrah")?.value),
      indirimli_kv: parseFormattedNumber(document.getElementById("indirimli_kv")?.value),
      indirimli_kv_oran: parseFormattedNumber(document.getElementById("indirimli_kv_oran")?.value),
    };
  }



  async function submitFullFormAndDonem() {
    const form = document.getElementById('form-giris');

    Swal.fire({
      title: 'Kaydediliyor...',
      html: 'LÃ¼tfen bekleyin.',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    // ============================================
    // 1) TESVIK ID'YI DOÄRU AL
    // ============================================
    const tesvikFromInput = document.getElementById("tesvik_id")?.value?.trim();
    const tesvikFromSession = sessionStorage.getItem("current_tesvik_id");

    const tesvikId = tesvikFromInput || tesvikFromSession;

    if (!tesvikId) {
      Swal.fire("Hata", "TeÅŸvik ID bulunamadÄ±!", "error");
      return;
    }

    // ============================================
    // 2) ANA BELGEYÄ° KAYDET
    // ============================================
    let belgeId = null;
    const formData = new FormData(form);

    try {
      const res = await fetch(form.action + `?view=${tesvikId}`, {
        method: "POST",
        body: formData
      });

      const data = await res.json();

      if (data.status !== "success") {
        Swal.fire(data.title || "Hata", data.message, "error");
        return;
      }

      // Backendâ€™in gÃ¶nderdiÄŸi gÃ¼ncel teÅŸvik ID
      belgeId = data.tesvik_id;
      document.getElementById("tesvik_id").value = belgeId;

      // Sessionâ€™da da gÃ¼ncelle
      sessionStorage.setItem("current_tesvik_id", belgeId);

    } catch (e) {
      Swal.fire("Sunucu HatasÄ±", "Ana belge kaydÄ± baÅŸarÄ±sÄ±z oldu.", "error");
      return;
    }

    // ============================================
    // 3) DÃ–NEMÄ° KAYDET
    // ============================================
    try {
      const donemData = collectDonemUsageData();

      const donemRes = await fetch("/indirimlikurumlar/save_tesvik_kullanim", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(donemData)
      });

      const result = await donemRes.json();

      Swal.fire({
        icon: "success",
        title: "Kaydedildi!",
        html: "Belge ve dÃ¶nem baÅŸarÄ±yla kaydedildi. Liste gÃ¼ncelleniyor...",
        timer: 2000,
        showConfirmButton: false
      });

      sessionStorage.removeItem("last_step");

      setTimeout(() => {
        window.location.href = "/indirimlikurumlar/?sekme=tesvik";
      }, 1500);

    } catch (e) {
      Swal.fire("Hata", "DÃ¶nem kaydÄ± sÄ±rasÄ±nda bir hata oluÅŸtu.", "error");
    }
  }



  function restoreFormFromSession() {
    RESTORE_MODE = true;

    document.querySelectorAll("input, select, textarea").forEach(el => {
      if (el.type === "file") return;
      const name = el.name || el.id;
      if (!name) return;

      const saved = sessionStorage.getItem(`form_${name}`);
      if (saved !== null) {
        el.value = saved;
      }
    });

    // ğŸ”„ Gecikmeli tetiklemeler (MASK â†’ ORANLAR â†’ HESAPLAR)
    setTimeout(() => {
      if (typeof loadAllMasks === "function") loadAllMasks();
      setBolge();
      setOranlar();
      calculateRatios();
      calculateKVMatrah();
      calculateTevsiKazancAutomatically();

      RESTORE_MODE = false;  // âœ” doÄŸru yer
    }, 300);
  }






  document.addEventListener("DOMContentLoaded", () => {

    // ============================================================
    // 0) MODÃœL 0 â€” FORM MODU GUARD
    // ============================================================
    function initGuard() {
      if (!window.location.search.includes("sekme=form")) {
        console.log("â†© Form sekmesi deÄŸil, DOM modÃ¼lleri yÃ¼klenmedi.");
        return false;
      }
      return true;
    }
    if (!initGuard()) return;



    // ============================================================
    // 1) MODÃœL 1 â€” ELEMENT REFERANSLARI (TEK MERKEZ)
    // ============================================================
    const refs = {
      kararSelect: document.getElementById("karar"),
      ilSelect: document.getElementById("il"),
      programSelect: document.getElementById("program_turu"),
      bolgeInput: document.getElementById("bolge"),
      katkiInput: document.getElementById("katki_orani"),
      vergiInput: document.getElementById("vergi_orani"),
      digerInput: document.getElementById("diger_oran"),
      tur1: document.getElementById("yatirim_turu1"),
      tur2: document.getElementById("yatirim_turu2"),
      form: document.getElementById("form-giris"),
      calculateBtn: document.getElementById("calculateCariBtn"),
      ayrTable: document.getElementById("ayrintili-kazanc-table"),
      clearButton: document.getElementById("clearProfitData")
    };



    // ============================================================
    // 2) MODÃœL 2 â€” DEFAULT DEÄERLER
    // ============================================================
    function initDefaultValues() {
      const karar = refs.kararSelect?.value;
      if (karar === "2025/9903") return;

      const il = document.getElementById("il");
      const osb = document.getElementById("osb");
      const donem = document.getElementById("donem");

      if (il && (!il.value || il.value === "")) il.value = "Ä°stanbul";
      if (osb && (!osb.value || osb.value === "")) osb.value = "OSB Ä°Ã§inde";

      if (donem && (!donem.value || donem.value === "")) {
        const y = new Date().getFullYear();
        donem.value = `${y} - 1. GEÃ‡Ä°CÄ°`;
      }

      if (typeof setBolge === "function") setBolge();
      if (typeof setOranlar === "function") setOranlar();
    }



    // ============================================================
    // 3) MODÃœL 3 â€” 9903 KARARI Ã–ZEL DAVRANIÅLARI
    // ============================================================
    function init9903Logic() {
      const { kararSelect, ilSelect, programSelect, katkiInput } = refs;

      if (!kararSelect) return;

      kararSelect.addEventListener("change", handleKarar9903);
      handleKarar9903();

      if (ilSelect) {
        ilSelect.addEventListener("change", () => {
          const karar = kararSelect.value;
          const il = ilSelect.value;

          if (karar === "2025/9903") {
            refs.bolgeInput.value = bolgeMap9903[il] || "";
          } else if (typeof setBolge === "function") {
            setBolge();
          }
        });
      }

      programSelect.addEventListener("change", () => {
        const karar = kararSelect.value;
        const program = programSelect.value;

        if (karar === "2025/9903") {
          katkiInput.value = katkilar9903?.[program] || 0;
        } else if (typeof setOranlar === "function") {
          setOranlar();
        }
      });
    }



    // ============================================================
    // 4) MODÃœL 4 â€” KLASÄ°K KARARLAR (3305 / 15199)
    // ============================================================
    function initClassicLogic() {
      // Åu anda ek Ã¶zel iÅŸlem yok.
      // Gerekirse buraya ekleriz.
    }



    // ============================================================
    // 5) MODÃœL 5 â€” TEVSÄ° HESAPLAMA BLOÄU
    // ============================================================
    function initTevsiLogic() {
      const { tur1 } = refs;

      if (tur1) {
        tur1.addEventListener("change", () => {
          if (tur1.value.toLowerCase() === "tevsi") {
            setTimeout(calculateTevsiKazancAutomatically, 500);
          } else {
            const el = document.getElementById("tevsi_yatirim_kazanci");
            if (el) el.value = "";
          }
        });
      }

      ["gerceklesen_tevsi_yatirim_tutari", "toplam_sabit_kiymet_tutari", "ticari_bilanco_kari"]
        .forEach(id => {
          const el = document.getElementById(id);
          if (el) el.addEventListener("input", calculateTevsiKazancAutomatically);
        });

      const tevsiInput = document.getElementById("tevsi_yatirim_kazanci");
      if (tevsiInput) {
        tevsiMask = IMask(tevsiInput, {
          mask: Number,
          scale: 2,
          thousandsSeparator: '.',
          radix: ',',
          mapToRadix: [','],
          normalizeZeros: false,
          padFractionalZeros: false
        });
      }
    }



    // ============================================================
    // 6) MODÃœL 6 â€” MASK SÄ°STEMÄ°
    // ============================================================
    function initMaskSystem() {
      Object.keys(idConfig).forEach(id => {
        const field = document.getElementById(id);
        if (!field) return;

        try {
          const mask = IMask(field, {
            mask: Number,
            scale: 2,
            thousandsSeparator: '.',
            radix: ',',
            mapToRadix: [','],
            normalizeZeros: false,
            padFractionalZeros: false
          });

          maskMap[id] = mask;

          field.addEventListener("input", () => {
            userTyped[id] = true;
          });

          mask.on("complete", () => {
            if (RESTORE_MODE) return;
            if (programmaticMaskUpdate) return;
            if (!userTyped[id]) return;

            const karar = refs.kararSelect?.value;
            const type = idConfig[id];

            if (type === "none") return;

            if (karar === "2025/9903") {
              if (type === "katki") hesaplaKatkiTutari9903();
              if (type === "ratios") calculateRatios();
              if (type === "kv") calculateKVMatrah();
              return;
            }

            if (type === "katki") {
              hesaplaKatkiTutari();
              hesaplaDigerKatkiTutari();
              hesaplaFiiliKatkiTutari();
              hesaplaOncekiKatkiTutari();
              hesaplaKalanVeEndeks();
            }

            else if (type === "ratios") calculateRatios();
            else if (type === "tevsi") calculateTevsiKazancAutomatically();
            else if (type === "kv") calculateKVMatrah();
          });

        } catch (err) {
          console.warn(`IMask oluÅŸturulamadÄ± (#${id}):`, err);
        }
      });
    }



    // ============================================================
    // 7) MODÃœL 7 â€” FORM RESTORE / SESSION SYSTEM
    // ============================================================
    function initRestoreSystem() {

      document.querySelectorAll("input, select, textarea").forEach(el => {
        if (el.type === "file") return;
        const name = el.name || el.id;
        const saved = sessionStorage.getItem(`form_${name}`);
        if (saved !== null) el.value = saved;
      });

      document.querySelectorAll("input, select, textarea").forEach(el => {
        if (el.type === "file") return;
        el.addEventListener("input", () => {
          const name = el.name || el.id;
          if (name) sessionStorage.setItem(`form_${name}`, el.value);
        });
      });

      // mukellef_bilgi â†’ belge no & tarih restore
      const bNo = sessionStorage.getItem("belge_no");
      const bTarih = sessionStorage.getItem("belge_tarihi");

      if (bNo) {
        const el = document.querySelector("input[name='belge_no']");
        if (el) el.value = bNo;
      }
      if (bTarih) {
        const el = document.querySelector("input[name='belge_tarihi']");
        if (el) el.value = bTarih;
      }

      if (bNo || bTarih) {
        sessionStorage.removeItem("belge_no");
        sessionStorage.removeItem("belge_tarihi");
      }
    }



    // ============================================================
    // 8) MODÃœL 8 â€” INFO BLINK
    // ============================================================
    function initInfoBlink() {
      function blink(attempt = 0) {
        const icons = document.querySelectorAll(".info-icon-styled");
        if (icons.length > 0) {
          setTimeout(() => {
            icons.forEach(icon => icon.classList.add("blink"));
            setTimeout(() => icons.forEach(i => i.classList.remove("blink")), 7500);
          }, 800);
        } else if (attempt < 10) {
          setTimeout(() => blink(attempt + 1), 300);
        }
      }
      blink();
    }



    // ============================================================
    // 9) PROFIT TABLE MODÃœLÃœ
    // ============================================================
    function initProfitTable() {
      const { ayrTable, clearButton } = refs;
      if (ayrTable) {
        ayrTable.querySelectorAll('tbody input').forEach(input => {
          input.setAttribute('data-original-value', input.value);
          input.addEventListener('input', e => {
            if (!isProgrammaticChange) {
              if (typeof calculateTable === "function") calculateTable(e);
            }
          });
        });
        if (typeof calculateTable === "function") calculateTable();
      }
      if (clearButton) clearButton.addEventListener('click', clearProfitTable);
    }



    // ============================================================
    // 10) HESAPLA BUTONU
    // ============================================================
    function initCalculateButton() {
      const { calculateBtn } = refs;
      if (!calculateBtn) return;

      calculateBtn.addEventListener("click", () => {

        if (typeof calculateRatios === "function") calculateRatios();
        if (typeof calculateKVMatrah === "function") calculateKVMatrah();

        const karar = refs.kararSelect?.value || "";

        if (karar === "2025/9903") {
          if (typeof hesaplaKatkiTutari9903 === "function")
            hesaplaKatkiTutari9903({ advance: true });

          if (typeof goToStep7 === "function") goToStep7();
          return;
        }

        if (typeof calculateCariAndNext === "function") calculateCariAndNext();
      });
    }



    // ============================================================
    // 11) FORM SUBMIT MODÃœLÃœ
    // ============================================================
    function initFormSubmit() {
      const { form } = refs;
      if (!form) return;

      form.addEventListener("submit", e => {
        e.preventDefault();

        const map = [
          ["belge_no", "belge_no_hidden"],
          ["belge_tarihi", "belge_tarihi_hidden"],
          ["bolge", "bolge_hidden"]
        ];

        map.forEach(([name, hiddenId]) => {
          const input = form.querySelector(`[name="${name}"]`);
          const hidden = document.getElementById(hiddenId);
          if (input && hidden) input.value = hidden.value || input.value;
        });

        fetch(form.action, {
          method: "POST",
          body: new FormData(form)
        })
          .then(r => r.json())
          .then(data => {
            Swal.fire({
              icon: data.status,
              title: data.title,
              text: data.message,
              timer: 1500,
              showConfirmButton: false
            }).then(() => {
              if (data.status === "success" && data.redirect) {
                window.location.href = data.redirect;
              }
            });
          })
          .catch(err => {
            Swal.fire("Hata", "KayÄ±t sÄ±rasÄ±nda bir hata oluÅŸtu.", "error");
            console.error("Kaydetme hatasÄ±:", err);
          });
      });
    }



    // ============================================================
    // 12) AÅAMA YÃ–NETÄ°CÄ°SÄ°
    // ============================================================
    function initStepManager() {
      const params = new URLSearchParams(window.location.search);
      const isEditingDonem = params.get("editdonem") === "1";
      const viewId = params.get("view");
      const hash = window.location.hash;
      const cameFromNewDoc = sessionStorage.getItem("belge_no") !== null;

      let targetStep = parseInt(sessionStorage.getItem("last_step") || "1");

      if (isEditingDonem || cameFromNewDoc) {
        targetStep = 1;
        sessionStorage.removeItem("last_step");
      }

      else if (hash.startsWith("#step")) {
        const sn = hash.replace("#step", "");
        const fn = window["goToStep" + sn];

        if (typeof fn === "function") {
          fn();
          document.getElementById("step" + sn)?.scrollIntoView({ behavior: "smooth" });
          return;
        }
      }

      _updateStepDisplay(targetStep);
    }



    // ============================================================
    // 13) GLOBAL EVENT LÄ°STENERLAR (YARDIMCI)
    // ============================================================
    function initGlobalListeners() {
      const btn = document.getElementById("btn-step1-next");
      if (btn) btn.addEventListener("click", () => goToStep2());
    }



    // ============================================================
    // 14) TÃœM MODÃœLLERÄ° BAÅLAT
    // ============================================================
    toggleInvestmentIncomeInputs();
    ALL_STEPS_IDS.forEach(id => document.getElementById(id)?.classList.add("hidden-step"));

    restoreFormFromSession();
    initRestoreSystem();
    initDefaultValues();
    init9903Logic();
    initClassicLogic();
    initTevsiLogic();
    initMaskSystem();
    initProfitTable();
    initCalculateButton();
    initFormSubmit();
    initStepManager();
    initInfoBlink();
    initGlobalListeners();

  });



  // âª KullanÄ±cÄ± geri tuÅŸuyla dÃ¶nmÃ¼ÅŸse son aÅŸamaya otomatik dÃ¶n
  window.addEventListener('pageshow', (event) => {
    if (event.persisted) {
      restoreFormFromSession();
      const lastStep = parseInt(sessionStorage.getItem('last_step') || '1');
      _updateStepDisplay(lastStep);
    }
  });


  // Mevcut belge verisini forma bas (isteÄŸe baÄŸlÄ± kÄ±sa yardÄ±mcÄ±lar)
  const setVal = (sel, v) => { const el = document.querySelector(sel); if (el) el.value = v ?? ''; };
  const fmt = n => (n || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2 });



  // Gizli file input â†’ PDF parser
  const kvInput = document.getElementById('kvUploadInput');
  if (kvInput) kvInput.addEventListener('change', handleKVUpload);


  // currentBelge varsa forma doldur
  if (currentBelgeJSData && window.location.search.includes('sekme=form')) {
    // Step 1
    setVal('input[name="belge_tarihi"]', currentBelgeJSData.belge_tarihi);
    setVal('select[name="karar"]', currentBelgeJSData.karar);
    setVal('select[name="yatirim_turu1"]', currentBelgeJSData.yatirim_turu1);
    setVal('select[name="yatirim_turu2"]', currentBelgeJSData.yatirim_turu2);
    setVal('input[name="belge_no"]', currentBelgeJSData.belge_no);
    setVal('select[name="vize_durumu"]', currentBelgeJSData.vize_durumu);

    // Step 2 (otomatik oranlar iÃ§in tetikleyelim)
    setVal('select[name="donem"]', currentBelgeJSData.donem);
    setVal('select[name="il"]', currentBelgeJSData.il);
    setVal('select[name="osb"]', currentBelgeJSData.osb);
    setBolge();
    setOranlar();

    // Step 3
    const s3 = id => document.getElementById(id);
    if (s3('toplam_tutar')) s3('toplam_tutar').value = fmt(currentBelgeJSData.toplam_tutar);
    if (s3('cari_harcama_tutari')) s3('cari_harcama_tutari').value = fmt(currentBelgeJSData.cari_harcama_tutari);
    if (s3('toplam_harcama_tutari')) s3('toplam_harcama_tutari').value = fmt(currentBelgeJSData.toplam_harcama_tutari);

    // Step 4
    if (s3('onceki_yatirim_katki_tutari')) s3('onceki_yatirim_katki_tutari').value = fmt(currentBelgeJSData.onceki_yatirim_katki_tutari);
    if (s3('onceki_diger_katki_tutari')) s3('onceki_diger_katki_tutari').value = fmt(currentBelgeJSData.onceki_diger_katki_tutari);

    // Step 6 (satÄ±ÅŸ/daÄŸÄ±lÄ±m)
    const chk = document.getElementById('useDetailedProfitRatios');
    if (chk) chk.checked = !!currentBelgeJSData.use_detailed_profit_ratios;
    ['brut_satis', 'ihracat', 'imalat', 'diger_faaliyet'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = fmt(currentBelgeJSData[id]);
    });
    toggleDetailedProfitInput();
  }



  // AyrÄ±ntÄ±lÄ± KazanÃ§ Formu (gÃ¼venli dÄ±ÅŸa aktar + AJAX kayÄ±t)
  const ayrintiliKazancForm = document.getElementById('ayrintili-kazanc-form');
  if (ayrintiliKazancForm) {
    const exportButton = ayrintiliKazancForm.querySelector('button[name="export"]');

    ayrintiliKazancForm.addEventListener('submit', async (event) => {
      // EÄŸer "DÄ±ÅŸa Aktar" butonuna basÄ±ldÄ±ysa, normal form gÃ¶nderimine izin ver
      if (document.activeElement === exportButton) {
        ayrintiliKazancForm.removeAttribute('data-action');
        return; // preventDefault yapma â†’ tarayÄ±cÄ± indirmeyi baÅŸlatÄ±r
      }

      // ğŸ’¾ Normal kayÄ±t iÅŸlemi iÃ§in AJAX kullan
      event.preventDefault();
      const formData = new FormData(ayrintiliKazancForm);
      formData.append("action", "save");

      try {
        const response = await fetch(ayrintiliKazancForm.action, {
          method: 'POST',
          body: formData
        });

        const contentType = response.headers.get("content-type");
        if (response.ok && contentType && contentType.includes("application/json")) {
          const data = await response.json();
          if (typeof showSwalMessage === "function")
            showSwalMessage(data.status, data.title, data.message);
        } else {
          console.error('AyrÄ±ntÄ±lÄ± kazanÃ§ kaydetme hatasÄ±:', response.statusText);
          if (typeof showSwalMessage === "function")
            showSwalMessage('error', 'Hata!', 'Sunucu hatasÄ± oluÅŸtu.');
        }
      } catch (err) {
        console.error('AyrÄ±ntÄ±lÄ± kazanÃ§ kaydetme hatasÄ±:', err);
        if (typeof showSwalMessage === "function")
          showSwalMessage('error', 'Hata!', 'AÄŸ hatasÄ± oluÅŸtu.');
      }
    });
  }



  // MANUEL BELÄ°RLE: YatÄ±rÄ±ma KatkÄ± OranÄ±
  document.getElementById('btn-manual-katki')?.addEventListener('click', async () => {
    const { value: val } = await Swal.fire({
      title: 'YatÄ±rÄ±ma KatkÄ± OranÄ±nÄ± giriniz (%)',
      input: 'text',
      inputPlaceholder: 'Ã¶rn: 40',
      showCancelButton: true,
      confirmButtonText: 'Tamam',
      cancelButtonText: 'VazgeÃ§',
      inputValidator: (v) => {
        const n = parseFormattedNumber(v);
        if (isNaN(n) || n < 0 || n > 100) return '0-100 arasÄ±nda bir yÃ¼zde girin';
        return null;
      }
    });
    if (val !== undefined) {
      const n = parseFormattedNumber(val);
      document.getElementById('katki_orani').value = n.toString().replace('.', ',');
      sessionStorage.setItem('manual_katki', 'true');
      sessionStorage.setItem('manual_katki_value', String(n));
      // aÅŸaÄŸÄ±dakiler mevcut hesaplara dokunsun
      hesaplaKatkiTutari(); hesaplaDigerKatkiTutari(); hesaplaFiiliKatkiTutari(); hesaplaOncekiKatkiTutari(); hesaplaKalanVeEndeks();
    }
  });

  // MANUEL BELÄ°RLE: Vergi Ä°ndirim OranÄ±
  document.getElementById('btn-manual-vergi')?.addEventListener('click', async () => {
    const { value: val } = await Swal.fire({
      title: 'Vergi Ä°ndirim OranÄ±nÄ± giriniz (%)',
      input: 'text',
      inputPlaceholder: 'Ã¶rn: 80',
      showCancelButton: true,
      confirmButtonText: 'Tamam',
      cancelButtonText: 'VazgeÃ§',
      inputValidator: (v) => {
        const n = parseFormattedNumber(v);
        if (isNaN(n) || n < 0 || n > 100) return '0-100 arasÄ±nda bir yÃ¼zde girin';
        return null;
      }
    });
    if (val !== undefined) {
      const n = parseFormattedNumber(val);
      document.getElementById('vergi_orani').value = n.toString().replace('.', ',');
      sessionStorage.setItem('manual_vergi', 'true');
      sessionStorage.setItem('manual_vergi_value', String(n));
      updateDiscountedRatesUI();
    }
  });



  // === MANUEL BELÄ°RLE: Kurumlar Vergisi MatrahÄ± ===
  document.getElementById('btn-manual-matrah')?.addEventListener('click', async () => {
    const { value: val } = await Swal.fire({
      title: 'Kurumlar Vergisi MatrahÄ±nÄ± giriniz (TL)',
      input: 'text',
      inputPlaceholder: 'Ã¶rn: 2.500.000,00',
      showCancelButton: true,
      confirmButtonText: 'Kaydet',
      cancelButtonText: 'VazgeÃ§',
      reverseButtons: true,
      allowOutsideClick: false,
      customClass: {
        popup: 'swal2-green-theme-popup',
        confirmButton: 'swal2-green-theme-confirm-button',
        cancelButton: 'swal2-green-theme-cancel-button'
      },
      didOpen: () => {
        const inputEl = Swal.getInput();
        // Yazarken sadece sayÄ±, nokta ve virgÃ¼l izin ver
        inputEl.addEventListener('input', (e) => {
          e.target.value = e.target.value.replace(/[^\d.,]/g, '');
        });
      },
      inputValidator: (v) => {
        const n = parseFormattedNumber(v);
        if (isNaN(n) || n <= 0) return 'GeÃ§erli bir tutar giriniz.';
        return null;
      }
    });

    // --- KaydedildiÄŸinde biÃ§imlendir ---
    if (val !== undefined) {
      const n = parseFormattedNumber(val);
      const formatted = n
        .toFixed(2)
        .replace('.', ',')
        .replace(/\B(?=(\d{3})+(?!\d))/g, '.');

      document.getElementById('kv_matrah').value = formatted;
      sessionStorage.setItem('manual_kv_matrah', 'true');
      sessionStorage.setItem('manual_kv_matrah_value', String(n));

      Swal.fire('âœ… Kaydedildi', `Kurumlar Vergisi MatrahÄ±: <b>${formatted} TL</b> olarak gÃ¼ncellendi.`, 'success');
    }
  });







  // TeÅŸvik belgeleri silme (AJAX)
  document.querySelectorAll('.delete-tesvik-form').forEach(formElement => {
    formElement.addEventListener('submit', async (event) => {
      event.preventDefault();
      Swal.fire({
        title: "Emin misiniz?",
        text: "Bu belge silinecek. Bu iÅŸlem geri alÄ±namaz!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "Evet, sil!",
        cancelButtonText: "Ä°ptal"
      }).then(async (result) => {
        if (!result.isConfirmed) return;
        try {
          const response = await fetch(formElement.action, {
            method: 'POST',
            body: new FormData(formElement)
          });
          const data = await response.json();
          showSwalMessage(data.status, data.title, data.message);
          if (data.status === "success") {
            formElement.closest('tr')?.remove();
          }
        } catch (err) {
          console.error('Belge silme hatasÄ±:', err);
          showSwalMessage('error', 'Hata!', 'Belge silinirken bir sorun oluÅŸtu.');
        }
      });
    });
  });
</script>
{% endblock %}