{% extends "layout.html" %}
{% block title %}Geli≈ümi≈ü Analiz{% endblock %}

{% block content %}
<div class="container py-4">

  <h4 class="mb-3">
    üìä Geli≈ümi≈ü Finansal Analiz ‚Äì {{ unvan or "Se√ßilmemi≈ü" }}
  </h4>

  {% if swal_warning %}
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    Swal.fire({
      title: "Eksik Veri",
      text: "{{ swal_warning }}",
      icon: "warning",
      confirmButtonText: "Tamam"
    });
  </script>
  {% endif %}

  {% if analiz.oran_analizleri %}
  <!-- Lejant -->
  <div class="d-flex align-items-center gap-3 mb-2 small">
    <span class="badge" style="background:#198754;">G√º√ßl√º</span>
    <span class="badge" style="background:#ffc107;color:#000;">Yeterli</span>
    <span class="badge" style="background:#dc3545;">Zayƒ±f</span>
  </div>

  <!-- Sekmeli g√∂r√ºn√ºm -->
  <style>
    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
    }

    .tab-button {
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      transition: all .2s;
    }

    .tab-button:hover {
      background: #e9ecef;
    }

    .tab-button.active {
      background: #0d6efd;
      color: #fff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .table-wrap {
      position: relative;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, .06);
      overflow: auto;
      background: #fff
    }

    .table-sticky thead th {
      position: sticky;
      top: 0;
      z-index: 3;
      background: #f8f9fa
    }

    .table-sticky td.first-col,
    .table-sticky th.first-col {
      position: sticky;
      left: 0;
      z-index: 2;
      background: #fff;
      box-shadow: inset -1px 0 #eee
    }

    .table-elegant tbody tr:hover {
      background: #fafcff
    }

    .cell-safe {
      background: linear-gradient(90deg, #E9F7EF, #ffffff 60%)
    }

    .cell-warn {
      background: linear-gradient(90deg, #FFF5E6, #ffffff 60%)
    }

    .cell-risk {
      background: linear-gradient(90deg, #FDECEC, #ffffff 60%)
    }

    .trend-pill {
      font-size: .75rem;
      padding: .3rem .55rem;
      border-radius: 999px
    }

    .trend-up {
      background: #E9F7EF;
      color: #157347
    }

    .trend-flat {
      background: #EEF1F6;
      color: #495057
    }

    .trend-down {
      background: #FDECEC;
      color: #B02A37
    }

    .is-last {
      border: 2px solid #e9ecef
    }

    .sonuc {
      font-size: .88rem;
      color: #4d4d4d
    }

    .ratio-info .name {
      border-bottom: 1px dotted #adb5bd;
      cursor: help;
    }
  </style>

  <div class="tabs">
    <button class="tab-button active" data-target="oranlar">Oran Analizleri</button>
  </div>

  <!-- üîπ Oran Analizleri -->
  <div id="oranlar" class="tab-content active">
    <div class="table-wrap my-3">
      <table class="table table-sm table-elegant table-sticky mb-0">
        <thead class="table-light">
          <tr>
            <th class="first-col text-start">Oran Adƒ±</th>
            {% for y in donemler %}<th class="text-end">{{ y }}</th>{% endfor %}
            <th class="text-center">Trend</th>
            <th>Sonu√ß</th>
          </tr>
        </thead>
        <tbody>
          {% set last_y = donemler[-1] if donemler else None %}
          {% set prev_y = donemler[-2] if donemler|length > 1 else None %}
          {% for oran_adi, oran_detay in analiz.oran_analizleri.items() %}
          {% set defn = (raporlar.get(last_y, {}) or {}).get(oran_adi) %}
          {% set m = defn.meaning if defn else '' %}
          {% set f = defn.formula if defn else '' %}
          {% set title_txt = (m ~ (f and (' ‚Äî Form√ºl: ' ~ f) or '')) %}
          <tr>
            <td class="first-col fw-medium ratio-info" title="{{ title_txt|e }}">
              <span class="name">{{ oran_adi }}</span>
            </td>
            {% for y in donemler %}
            {% set oran = (raporlar.get(y, {}) or {}).get(oran_adi) %}
            {% set val = oran.deger if oran else None %}
            {% set th = oran.thresholds if oran else {} %}
            {% set cls = '' %}
            {% if val is not none and th %}
            {% if th.safe is not none and val >= th.safe %}{% set cls='cell-safe' %}
            {% elif th.adequate is not none and val >= th.adequate %}{% set cls='cell-warn' %}
            {% else %}{% set cls='cell-risk' %}{% endif %}
            {% endif %}
            <td class="text-end {{ cls }} {% if y==last_y %}is-last{% endif %}">
              {{ val if val is not none else '-' }}
            </td>
            {% endfor %}
            {% set t = (oran_detay.trend or '')|lower %}
            {% set tcls = 'trend-flat' %}
            {% if 'g√º√ßl√º art' in t or 'art' in t %}{% set tcls='trend-up' %}
            {% elif 'd√º≈ü' in t %}{% set tcls='trend-down' %}{% endif %}
            <td class="text-center">
              <span class="trend-pill {{ tcls }}">
                {% if tcls=='trend-up' %}‚¨à{% elif tcls=='trend-down' %}‚¨ä{% else %}‚ñ¨{% endif %}
                {{ oran_detay.trend }}
              </span>
            </td>
            <td class="sonuc">{{ oran_detay.sonucu }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>



  {% else %}
  <div class="alert alert-warning">
    Oran tablosu olu≈üturmak i√ßin ilgili yƒ±llarƒ±n bilan√ßo ve gelir PDF‚Äôleri gerekli.
  </div>
  {% endif %}

  <hr class="my-4" />

  <!-- üîç Arama & Grafik alanƒ± -->
  <div class="row g-3 align-items-end">
    <div class="col-12 col-lg-6">
      <label class="form-label">Kalem veya Oran Ara</label>
      <input id="searchBox" class="form-control" placeholder="√∂rn: cari oran, net satƒ±≈ülar, √∂zkaynaklar..." />
    </div>
    <div class="col-12 col-lg-6 d-flex gap-2">
      <div class="ms-auto d-flex gap-2">
        <button id="last3" class="btn btn-outline-primary">Son 3</button>
        <button id="last5" class="btn btn-outline-primary">Son 5</button>
        <button id="allY" class="btn btn-outline-primary">T√ºm√º</button>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-3">
    <div class="col-12 col-lg-6">
      <div class="border rounded p-2">
        <div class="small text-muted mb-2">Arama sonu√ßlarƒ±</div>
        <div id="resultList" class="vstack gap-2" style="max-height:320px;overflow:auto;"></div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="border rounded p-2">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="small text-muted">Se√ßilen Kalemler / Oranlar</div>
          <button id="clearSel" class="btn btn-sm btn-outline-danger">Temizle</button>
        </div>
        <div id="selectedArea" class="d-flex flex-wrap gap-2"></div>
      </div>
    </div>
  </div>

  <div class="mt-4">
    <div class="d-flex align-items-center gap-2 mb-2">
      <h5 class="mb-0">üìà Grafik</h5>
      <div class="ms-auto btn-group">
        <button class="btn btn-outline-secondary active" data-ctype="line">Line</button>
        <button class="btn btn-outline-secondary" data-ctype="bar">Bar</button>
      </div>
    </div>
    <canvas id="mainChart" height="110"></canvas>

    <!-- üîô Geri D√∂n butonu -->
    <div class="text-center mt-4">
      <a href="{{ url_for('raporlama', vkn=vkn, unvan=unvan, fa_years=fa_years) }}"
        class="btn btn-lg btn-outline-secondary">
        ‚¨ÖÔ∏è Raporlamaya Geri D√∂n
      </a>
    </div>
  </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // Backend verileri
  const YEARS = {{ donemler | default ([]) | tojson }};
  const INDEX = {{ kalem_index | default ([]) | tojson }};
  const SERILER = {{ kalem_series | default ({}) | tojson }};
  const ORANLAR = Object.keys({{ analiz.oran_analizleri | default({ }) | tojson }});

  // üîç Arama: kalem + oran isimleri birlikte
  const qInput = document.getElementById('searchBox');
  const resultList = document.getElementById('resultList');
  const selected = new Set();
  const selectedArea = document.getElementById('selectedArea');

  function renderResults() {
    const q = (qInput.value || '').toLowerCase().trim();
    resultList.innerHTML = '';
    const results = [];

    // 1Ô∏è‚É£ Kalem indexinden
    INDEX.forEach(it => {
      if (!q || it.label.toLowerCase().includes(q))
        results.push({ type: 'kalem', key: it.key, label: it.label });
    });

    // 2Ô∏è‚É£ Oranlardan
    ORANLAR.forEach(o => {
      if (!q || o.toLowerCase().includes(q))
        results.push({ type: 'oran', key: o, label: o });
    });

    if (!results.length) {
      resultList.innerHTML = '<div class="text-muted small">Sonu√ß yok.</div>';
      return;
    }

    results.slice(0, 200).forEach(it => {
      const row = document.createElement('div');
      row.className = 'd-flex justify-content-between align-items-center border rounded px-2 py-1';
      row.innerHTML = `<div class="small">${it.label}</div><button class="btn btn-sm btn-outline-primary">Ekle</button>`;
      row.querySelector('button').addEventListener('click', () => addKey(it.key));
      resultList.appendChild(row);
    });
  }

  function renderSelected() {
    selectedArea.innerHTML = '';
    if (!selected.size) {
      selectedArea.innerHTML = '<div class="text-muted small">Hen√ºz se√ßim yapmadƒ±nƒ±z.</div>';
      return;
    }
    [...selected].forEach(key => {
      const chip = document.createElement('div');
      chip.className = 'badge text-bg-secondary d-flex align-items-center gap-1';
      chip.style.fontSize = '0.9rem';
      chip.innerHTML = `<span>${key}</span><a href="#" class="text-white text-decoration-none">&times;</a>`;
      chip.querySelector('a').addEventListener('click', e => {
        e.preventDefault(); removeKey(key);
      });
      selectedArea.appendChild(chip);
    });
  }

  function addKey(key) { selected.add(key); renderSelected(); draw(); }
  function removeKey(key) { selected.delete(key); renderSelected(); draw(); }
  document.getElementById('clearSel').addEventListener('click', () => {
    selected.clear(); renderSelected(); draw();
  });

  // üîÑ Yƒ±l aralƒ±ƒüƒ± butonlarƒ±
  let yearsWindow = [...YEARS];
  document.getElementById('last3').addEventListener('click', () => { yearsWindow = YEARS.slice(-3); draw(); });
  document.getElementById('last5').addEventListener('click', () => { yearsWindow = YEARS.slice(-5); draw(); });
  document.getElementById('allY').addEventListener('click', () => { yearsWindow = [...YEARS]; draw(); });

  // üîÑ Grafik tipi
  let chartType = 'line';
  const cbtns = [...document.querySelectorAll('[data-ctype]')];
  cbtns.forEach(b => {
    b.addEventListener('click', () => {
      cbtns.forEach(x => x.classList.remove('active'));
      b.classList.add('active');
      chartType = b.dataset.ctype;
      draw();
    });
  });

  // üìä Chart.js √ßizimi
  const ctx = document.getElementById('mainChart').getContext('2d');
  let chart = null;

  function buildDataset(key, idx) {
    const hue = (idx * 67) % 360;
    const color = `hsl(${hue} 70% 45%)`;
    const vals = yearsWindow.map(y => {
      const v = (SERILER[key] || {})[y];
      return Number.isFinite(v) ? v : null;
    });
    return { label: key, data: vals, borderWidth: 2, tension: 0.25, spanGaps: true, borderColor: color, backgroundColor: `hsl(${hue} 70% 85%)` };
  }

  function draw() {
    if (chart) chart.destroy();
    const datasets = [...selected].map((k, i) => buildDataset(k, i));
    chart = new Chart(ctx, {
      type: chartType,
      data: { labels: yearsWindow, datasets },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y == null ? '‚Äî' : Intl.NumberFormat('tr-TR').format(ctx.parsed.y)}`
            }
          }
        },
        scales: { y: { beginAtZero: false } }
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    const eksik = {{ (eksik_yillar or[]) | tojson }};
  if (eksik && eksik.length > 0) {
    Swal.fire({
      icon: 'warning',
      title: 'Eksik Veri',
      html: 'A≈üaƒüƒ±daki yƒ±llara ait PDF verileri bulunamadƒ±:<br><b>' + eksik.join(', ') + '</b>',
    });
  }
  });

  // üöÄ Ba≈ülangƒ±√ß
  renderResults();
  renderSelected();
  draw();
  qInput.addEventListener('input', renderResults);
</script>

{% endblock %}