{% extends "layout.html" %}
{% block title %}Vergi Hesaplamaları{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4 text-center">Vergi Hesaplama Araçları</h2>

    <!-- Sekme başlıkları -->
    <ul class="nav nav-tabs flex-wrap" id="vergiTab" role="tablist">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#gelir" role="tab">Gelir Vergisi</a>
        </li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#gecikme" role="tab">Gecikme Zammı</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#ymm" role="tab">YMM Tarifesi</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#damga" role="tab">Damga Vergisi</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#kdv" role="tab">KDV Hesaplama</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#stopaj" role="tab">Stopaj Hesaplama</a>
        </li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#mtv" role="tab">MTV Hesaplama</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#takvim" role="tab">Vergi Takvimi</a></li>
    </ul>

    <!-- Sekme içerikleri -->
    <div class="tab-content border p-4 bg-light rounded-bottom" id="vergiTabContent">
        <div class="tab-pane fade show active" id="gelir" role="tabpanel">



            <!-- 🔽 GELİR VERGİSİ HESAPLAMA (Brüt maaş, ay sayısı, istisna) -->
            <hr>
            <h4>Gelir Vergisi Hesaplama</h4>
            <form id="gelirVergisiForm" class="mb-4">
                <div class="card p-4">
                    <div class="mb-3">
                        <label for="yilInput" class="form-label">Hesaplama Yılı</label>
                        <select class="form-select" id="yilInput" required>
                            <option value="2020">2020</option>
                            <option value="2021">2021</option>
                            <option value="2022">2022</option>
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="gelirTuru" class="form-label">Gelir Türü</label>
                        <select class="form-select" id="gelirTuru" required>
                            <option value="ucret" selected>Ücret Geliri</option>
                            <option value="normal">Ücret Dışı Gelir</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="brutUcret" class="form-label">Vergi Matrahını Giriniz (₺)</label>
                        <input type="text" class="form-control" id="brutUcret" required>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="asgariIstisna" checked>
                        <label class="form-check-label" for="asgariIstisna">
                            Asgari Ücret İstisnası Uygulansın
                        </label>
                    </div>

                    <div class="mb-3">
                        <label for="aySecimi" class="form-label">Hangi Ay İçin Hesaplama Yapılacak?</label>
                        <select class="form-select" id="aySecimi" required>
                            <option value="0" selected>Yıllık</option>
                            {% set aylar = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos",
                            "Eylül", "Ekim", "Kasım", "Aralık"] %}
                            {% for ay in aylar %}
                            <option value="{{ loop.index }}">{{ ay }}</option>
                            {% endfor %}
                        </select>
                    </div>



                    <button type="submit" class="btn btn-gradient-hover">Hesapla</button>
                </div>
            </form>
        </div>

        <!-- Diğer sekmeler (kısa placeholder) -->
        <div class="tab-pane fade" id="gecikme" role="tabpanel">
            <h4>Gecikme Zammı Hesaplama</h4>
            <p class="text-muted">Bu araç yakında kullanıma sunulacaktır.</p>
        </div>
        <div class="tab-pane fade" id="ymm" role="tabpanel">
            <h4>YMM Tarifesi</h4>
            <p class="text-muted">Bu araç yakında kullanıma sunulacaktır.</p>
        </div>
        <div class="tab-pane fade" id="damga" role="tabpanel">
            <h4>Damga Vergisi Hesaplama</h4>
            <p class="text-muted">Bu araç yakında kullanıma sunulacaktır.</p>
        </div>
        <div class="tab-pane fade" id="kdv" role="tabpanel">
            <h4>KDV Hesaplama</h4>
            <p class="text-muted">Bu araç yakında kullanıma sunulacaktır.</p>
        </div>
        <div class="tab-pane fade" id="stopaj" role="tabpanel">
            <h4>Stopaj Hesaplama</h4>
            <p class="text-muted">Bu araç yakında kullanıma sunulacaktır.</p>
        </div>
        <div class="tab-pane fade" id="mtv" role="tabpanel">
            <h4>MTV Hesaplama</h4>
            <p class="text-muted">Bu araç yakında kullanıma sunulacaktır.</p>
        </div>
        <div class="tab-pane fade" id="takvim" role="tabpanel">
            <h4>Vergi Takvimi ve Son Günler</h4>
            <p class="text-muted">Bu araç yakında kullanıma sunulacaktır.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const brutUcretInput = document.getElementById("brutUcret");
    const aySecimi = document.getElementById("aySecimi");
    const gelirTuruInput = document.getElementById("gelirTuru");

    // TL formatlı input
    brutUcretInput.addEventListener("input", function (e) {
        let val = e.target.value.replace(/[^\d]/g, "");
        if (val) {
            const number = parseFloat(val);
            if (!isNaN(number)) {
                const formatted = (number / 100).toLocaleString("tr-TR", {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                e.target.value = formatted;
            }
        }
    });

    gelirTuruInput.addEventListener("change", function () {
        const isUcret = this.value === "ucret";
        const istisnaCheckbox = document.getElementById("asgariIstisna");

        istisnaCheckbox.disabled = !isUcret;
        if (!isUcret) istisnaCheckbox.checked = false;

        // Asgari istisna pasifse, ay seçimi devre dışı ve Yıllık (0) yapılır
        if (!isUcret || !istisnaCheckbox.checked) {
            aySecimi.value = "0";
            aySecimi.disabled = true;
        } else {
            aySecimi.disabled = false;
        }
    });

    // Sayfa yüklenince tetikle
    window.addEventListener("DOMContentLoaded", () => {
        gelirTuruInput.dispatchEvent(new Event("change"));
    });


    document.getElementById("asgariIstisna").addEventListener("change", function () {
        const istisnaAktif = this.checked;
        const isUcret = gelirTuruInput.value === "ucret";

        if (!istisnaAktif || !isUcret) {
            aySecimi.value = "0"; // Yıllık
            aySecimi.disabled = true;
        } else {
            aySecimi.disabled = false;
        }
    });
    // Form gönderimi
    document.getElementById("gelirVergisiForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const formatted = brutUcretInput.value;
        const temiz = parseFloat(formatted.replace(/\./g, "").replace(",", ".")) || 0;
        const secilenAy = parseInt(aySecimi.value);
        const yil = parseInt(document.getElementById("yilInput").value);
        const gelirTuru = gelirTuruInput.value;
        const istisnaVarMi = document.getElementById("asgariIstisna").checked;

        let oncekiMatrahlar = {};

        // Ücret geliri ve yıllık dışı bir ay seçilmişse popup ile matrah al
        if (secilenAy > 1 && gelirTuru === "ucret") {
            const ayAdlari = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
            let html = '<div style="text-align:left;"><form id="oncekiForm">';

            for (let i = 0; i < secilenAy - 1; i++) {
                const defaultVal = temiz.toLocaleString("tr-TR", {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });

                html += `
                    <div class="mb-2">
                        <label><strong>${ayAdlari[i]}</strong></label>
                        <input type="text" class="swal2-input onceki-matrah-swal" value="${defaultVal}" data-ay="${i + 1}">
                    </div>`;
            }

            html += '</form></div>';

            const { value: formValues } = await Swal.fire({
                title: "Önceki Ayların Matrahları",
                html: html,
                confirmButtonText: "Tamam",
                showCancelButton: true,
                focusConfirm: false,
                preConfirm: () => {
                    const inputs = document.querySelectorAll(".onceki-matrah-swal");
                    let matrahlar = {};
                    for (let input of inputs) {
                        const ay = input.dataset.ay;
                        const val = parseFloat(input.value.replace(/\./g, "").replace(",", ".")) || 0;
                        matrahlar[ay] = val;
                    }
                    return matrahlar;
                },
                didOpen: () => {
                    Swal.getConfirmButton().focus();
                }
            });

            if (formValues === undefined) return;
            oncekiMatrahlar = formValues;
        }

        // API'ye gönder
        fetch("/vergi-hesapla", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                brut: temiz,
                ay: secilenAy,
                yil: yil,
                gelir_turu: gelirTuru,
                istisna: istisnaVarMi,
                onceki_matrahlar: oncekiMatrahlar
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    Swal.fire("Hata", data.error, "error");
                    return;
                }

                const vergi = data.vergi.toLocaleString("tr-TR", { style: "currency", currency: "TRY" });
                const istisna = data.istisna?.toLocaleString("tr-TR", { style: "currency", currency: "TRY" }) || null;
                const istisnaAy = data.istisna_ay;
                const tamIstisna = data.tam_istisna?.toLocaleString("tr-TR", { style: "currency", currency: "TRY" }) || null;
                const istisnaMatrah = data.istisna_matrah?.toLocaleString("tr-TR", { style: "currency", currency: "TRY" });
                const tekAyIstisna = data.tek_ay_istisna?.toLocaleString("tr-TR", { style: "currency", currency: "TRY" });


                Swal.fire({
                    title: "Hesaplama Tamamlandı",
                    html: `
                        <strong>Toplam Gelir Vergisi:</strong> ${vergi}<br>
                        ${secilenAy === 0 && tamIstisna ? `
                            <div class="text-success mt-2">
                                <strong>12 Aylık Toplam İstisna:</strong> ${tamIstisna}
                            </div>
                        ` : istisna ? `
                            <div class="text-success mt-2">
                                <strong>${istisnaAy} Aylık Toplam İstisna:</strong> ${istisna}<br>
                                <strong>Bu Aya Ait İstisna:</strong> ${tekAyIstisna}
                            </div>
                        ` : ""}
                    `,
                    icon: "info"
                });
            })
            .catch(() => {
                Swal.fire("Hata", "Hesaplama yapılırken sunucu hatası oluştu.", "error");
            });
    });
</script>
{% endblock %}