{% extends "layout.html" %}
{% block title %}Vergi HesaplamalarÄ±{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4 text-center">Vergi Hesaplama AraÃ§larÄ±</h2>

    <!-- Sekme baÅŸlÄ±klarÄ± -->
    <ul class="nav nav-tabs flex-wrap" id="vergiTab" role="tablist">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#gelir" role="tab">Gelir Vergisi</a>
        </li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#gecikme" role="tab">Gecikme ZammÄ±</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#ymm" role="tab">YMM Tarifesi</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#damga" role="tab">Damga Vergisi</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#kdv" role="tab">KDV Hesaplama</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#stopaj" role="tab">Stopaj Hesaplama</a>
        </li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#mtv" role="tab">MTV Hesaplama</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#takvim" role="tab">Vergi Takvimi</a></li>
    </ul>

    <!-- Sekme iÃ§erikleri -->
    <div class="tab-content border p-4 bg-light rounded-bottom" id="vergiTabContent">
        <div class="tab-pane fade show active" id="gelir" role="tabpanel">



            <!-- ğŸ”½ GELÄ°R VERGÄ°SÄ° HESAPLAMA (BrÃ¼t maaÅŸ, ay sayÄ±sÄ±, istisna) -->
            <hr>
            <h4>Gelir Vergisi Hesaplama</h4>
            <form id="gelirVergisiForm" class="mb-4">
                <div class="card p-4">
                    <div class="mb-3">
                        <label for="yilInput" class="form-label">Hesaplama YÄ±lÄ±</label>
                        <select class="form-select" id="yilInput" required>
                            <option value="2020">2020</option>
                            <option value="2021">2021</option>
                            <option value="2022">2022</option>
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026" selected>2026</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="gelirTuru" class="form-label">Gelir TÃ¼rÃ¼</label>
                        <select class="form-select" id="gelirTuru" required>
                            <option value="ucret" selected>Ãœcret Geliri</option>
                            <option value="normal">Ãœcret DÄ±ÅŸÄ± Gelir</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="brutUcret" class="form-label">Vergi MatrahÄ±nÄ± Giriniz (â‚º)</label>
                        <input type="text" class="form-control" id="brutUcret" required>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="asgariIstisna" checked>
                        <label class="form-check-label" for="asgariIstisna">
                            Asgari Ãœcret Ä°stisnasÄ± UygulansÄ±n
                        </label>
                    </div>

                    <div class="mb-3">
                        <label for="aySecimi" class="form-label">Hangi Ay Ä°Ã§in Hesaplama YapÄ±lacak?</label>
                        <select class="form-select" id="aySecimi" required>
                            <option value="0" selected>YÄ±llÄ±k</option>
                            {% set aylar = ["Ocak", "Åubat", "Mart", "Nisan", "MayÄ±s", "Haziran", "Temmuz", "AÄŸustos",
                            "EylÃ¼l", "Ekim", "KasÄ±m", "AralÄ±k"] %}
                            {% for ay in aylar %}
                            <option value="{{ loop.index }}">{{ ay }}</option>
                            {% endfor %}
                        </select>
                    </div>



                    <button type="submit" class="btn btn-gradient-hover">Hesapla</button>
                </div>
            </form>
            <hr class="my-4">

            <h5>ğŸ“‹ YapÄ±lan Hesaplamalar</h5>

            <div class="table-responsive">
                <table class="table table-sm table-bordered align-middle" id="logTable">
                    <thead class="table-light">
                        <tr>
                            <th>YÄ±l</th>
                            <th>Gelir TÃ¼rÃ¼</th>
                            <th>Vergi MatrahÄ±</th>
                            <th>Asgari Ãœcret Ä°stisnasÄ±</th>
                            <th>Ay</th>
                            <th>Gelir Vergisi</th>
                            <th>Ä°stisna TutarÄ±</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>


        <div class="tab-pane fade" id="gecikme" role="tabpanel">
            <h4>Gecikme ZammÄ± Hesaplama</h4>
            <div class="card p-4">
                <input type="number" id="borc" class="form-control mb-2" placeholder="BorÃ§ TutarÄ±">

                <select id="borcTuru" class="form-select mb-2">
                    <option value="vergi_asli">Vergi AslÄ±</option>
                    <option value="vergi_ziyasi">Vergi ZiyaÄ± CezasÄ±</option>
                    <option value="mahkeme_cezasi">Mahkeme CezasÄ±</option>
                    <option value="usulsuzluk">UsulsÃ¼zlÃ¼k CezasÄ±</option>
                </select>

                <label>Vade Tarihi</label>
                <input type="date" id="vade" class="form-control mb-2">

                <label>Ã–deme Tarihi</label>
                <input type="date" id="odeme" class="form-control mb-3">

                <button class="btn btn-danger" onclick="hesaplaGecikme()">Hesapla</button>
            </div>
            <hr class="my-4">
            <h5>ğŸ“‹ YapÄ±lan Gecikme ZammÄ± HesaplamalarÄ±</h5>

            <div class="table-responsive">
                <table class="table table-sm table-bordered align-middle" id="gecikmeLogTable">
                    <thead class="table-light">
                        <tr>
                            <th>BorÃ§ TÃ¼rÃ¼</th>
                            <th>BorÃ§ TutarÄ±</th>
                            <th>Vade</th>
                            <th>Ã–deme</th>
                            <th>Gecikme ZammÄ±</th>
                            <th>Toplam BorÃ§</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="ymm" role="tabpanel">
            <h4>YMM Tarifesi</h4>
            <p class="text-muted">Bu araÃ§ yakÄ±nda kullanÄ±ma sunulacaktÄ±r.</p>
        </div>

        <div class="tab-pane fade" id="damga" role="tabpanel">
            <h4>Damga Vergisi Hesaplama</h4>
            <p class="text-muted">Bu araÃ§ yakÄ±nda kullanÄ±ma sunulacaktÄ±r.</p>
        </div>

        <div class="tab-pane fade" id="kdv" role="tabpanel">
            <h4>KDV Hesaplama</h4>
            <p class="text-muted">Bu araÃ§ yakÄ±nda kullanÄ±ma sunulacaktÄ±r.</p>
        </div>

        <div class="tab-pane fade" id="stopaj" role="tabpanel">
            <h4>Stopaj Hesaplama</h4>
            <p class="text-muted">Bu araÃ§ yakÄ±nda kullanÄ±ma sunulacaktÄ±r.</p>
        </div>

        <div class="tab-pane fade" id="mtv" role="tabpanel">
            <h4>MTV Hesaplama</h4>
            <p class="text-muted">Bu araÃ§ yakÄ±nda kullanÄ±ma sunulacaktÄ±r.</p>
        </div>

        <div class="tab-pane fade" id="takvim" role="tabpanel">
            <h4>Vergi Takvimi ve Son GÃ¼nler</h4>
            <p class="text-muted">Bu araÃ§ yakÄ±nda kullanÄ±ma sunulacaktÄ±r.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const brutUcretInput = document.getElementById("brutUcret");
    const aySecimi = document.getElementById("aySecimi");
    const gelirTuruInput = document.getElementById("gelirTuru");

    // TL formatlÄ± input
    brutUcretInput.addEventListener("input", function (e) {
        let val = e.target.value.replace(/[^\d]/g, "");
        if (val) {
            const number = parseFloat(val);
            if (!isNaN(number)) {
                const formatted = (number / 100).toLocaleString("tr-TR", {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                e.target.value = formatted;
            }
        }
    });

    gelirTuruInput.addEventListener("change", function () {
        const isUcret = this.value === "ucret";
        const istisnaCheckbox = document.getElementById("asgariIstisna");

        istisnaCheckbox.disabled = !isUcret;
        if (!isUcret) istisnaCheckbox.checked = false;

        // Asgari istisna pasifse, ay seÃ§imi devre dÄ±ÅŸÄ± ve YÄ±llÄ±k (0) yapÄ±lÄ±r
        if (!isUcret || !istisnaCheckbox.checked) {
            aySecimi.value = "0";
            aySecimi.disabled = true;
        } else {
            aySecimi.disabled = false;
        }
    });

    // Sayfa yÃ¼klenince tetikle
    window.addEventListener("DOMContentLoaded", () => {
        gelirTuruInput.dispatchEvent(new Event("change"));
    });


    document.getElementById("asgariIstisna").addEventListener("change", function () {
        const istisnaAktif = this.checked;
        const isUcret = gelirTuruInput.value === "ucret";

        if (!istisnaAktif || !isUcret) {
            aySecimi.value = "0"; // YÄ±llÄ±k
            aySecimi.disabled = true;
        } else {
            aySecimi.disabled = false;
        }
    });
    // Form gÃ¶nderimi
    document.getElementById("gelirVergisiForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const formatted = brutUcretInput.value;
        const temiz = parseFloat(formatted.replace(/\./g, "").replace(",", ".")) || 0;
        const secilenAy = parseInt(aySecimi.value);
        const yil = parseInt(document.getElementById("yilInput").value);
        const gelirTuru = gelirTuruInput.value;
        const istisnaVarMi = document.getElementById("asgariIstisna").checked;

        let oncekiMatrahlar = {};

        // Ãœcret geliri ve yÄ±llÄ±k dÄ±ÅŸÄ± bir ay seÃ§ilmiÅŸse popup ile matrah al
        if (secilenAy > 1 && gelirTuru === "ucret") {
            const ayAdlari = ["Ocak", "Åubat", "Mart", "Nisan", "MayÄ±s", "Haziran", "Temmuz", "AÄŸustos", "EylÃ¼l", "Ekim", "KasÄ±m", "AralÄ±k"];
            let html = '<div style="text-align:left;"><form id="oncekiForm">';

            for (let i = 0; i < secilenAy - 1; i++) {
                const defaultVal = temiz.toLocaleString("tr-TR", {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });

                html += `
                    <div class="mb-2">
                        <label><strong>${ayAdlari[i]}</strong></label>
                        <input type="text" class="swal2-input onceki-matrah-swal" value="${defaultVal}" data-ay="${i + 1}">
                    </div>`;
            }

            html += '</form></div>';

            const { value: formValues } = await Swal.fire({
                title: "Ã–nceki AylarÄ±n MatrahlarÄ±",
                html: html,
                confirmButtonText: "Tamam",
                showCancelButton: true,
                focusConfirm: false,
                preConfirm: () => {
                    const inputs = document.querySelectorAll(".onceki-matrah-swal");
                    let matrahlar = {};
                    for (let input of inputs) {
                        const ay = input.dataset.ay;
                        const val = parseFloat(input.value.replace(/\./g, "").replace(",", ".")) || 0;
                        matrahlar[ay] = val;
                    }
                    return matrahlar;
                },
                didOpen: () => {
                    Swal.getConfirmButton().focus();
                }
            });

            if (formValues === undefined) return;
            oncekiMatrahlar = formValues;
        }

        // API'ye gÃ¶nder
        fetch("/vergi-hesapla", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                brut: temiz,
                ay: secilenAy,
                yil: yil,
                gelir_turu: gelirTuru,
                istisna: istisnaVarMi,
                onceki_matrahlar: oncekiMatrahlar
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    Swal.fire("Hata", data.error, "error");
                    return;
                }

                const vergi = data.vergi.toLocaleString("tr-TR", { style: "currency", currency: "TRY" });
                const istisna = data.istisna?.toLocaleString("tr-TR", { style: "currency", currency: "TRY" }) || null;
                const istisnaAy = data.istisna_ay;
                const tamIstisna = data.tam_istisna?.toLocaleString("tr-TR", { style: "currency", currency: "TRY" }) || null;
                const istisnaMatrah = data.istisna_matrah?.toLocaleString("tr-TR", { style: "currency", currency: "TRY" });
                const tekAyIstisna = data.tek_ay_istisna?.toLocaleString("tr-TR", { style: "currency", currency: "TRY" });


                Swal.fire({
                    title: "Hesaplama TamamlandÄ±",
                    html: `
                        <strong>Toplam Gelir Vergisi:</strong> ${vergi}<br>
                        ${secilenAy === 0 && tamIstisna ? `
                            <div class="text-success mt-2">
                                <strong>12 AylÄ±k Toplam Ä°stisna:</strong> ${tamIstisna}
                            </div>
                        ` : istisna ? `
                            <div class="text-success mt-2">
                                <strong>${istisnaAy} AylÄ±k Toplam Ä°stisna:</strong> ${istisna}<br>
                                <strong>Bu Aya Ait Ä°stisna:</strong> ${tekAyIstisna}
                            </div>
                        ` : ""}
                    `,
                    icon: "info"
                });



                const logTableBody = document.querySelector("#logTable tbody");

                const ayText = secilenAy === 0
                    ? "YÄ±llÄ±k"
                    : document.querySelector(`#aySecimi option[value="${secilenAy}"]`).text;

                const logRow = document.createElement("tr");

                logRow.innerHTML = `
                    <td>${yil}</td>
                    <td>${gelirTuru === "ucret" ? "Ãœcret" : "Ãœcret DÄ±ÅŸÄ±"}</td>
                    <td>${temiz.toLocaleString("tr-TR", { style: "currency", currency: "TRY" })}</td>
                    <td class="text-center">${istisnaVarMi ? "âœ”ï¸" : "âŒ"}</td>
                    <td>${ayText}</td>
                    <td class="text-danger fw-bold">${vergi}</td>
                    <td class="text-success">${istisna || "-"}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-danger">Sil</button>
                    </td>
        `   ;

                // Silme butonu
                logRow.querySelector("button").addEventListener("click", () => {
                    logRow.remove();
                    saveLogs();
                });

                logTableBody.prepend(logRow);
                saveLogs();
            })
            .catch(() => {
                Swal.fire("Hata", "Hesaplama yapÄ±lÄ±rken sunucu hatasÄ± oluÅŸtu.", "error");
            });

    });

    function saveLogs() {
        const rows = [];
        document.querySelectorAll("#logTable tbody tr").forEach(tr => {
            rows.push(tr.innerHTML);
        });
        localStorage.setItem("vergi_loglari", JSON.stringify(rows));
    }

    function loadLogs() {
        const saved = JSON.parse(localStorage.getItem("vergi_loglari") || "[]");
        const tbody = document.querySelector("#logTable tbody");
        saved.forEach(html => {
            const tr = document.createElement("tr");
            tr.innerHTML = html;

            tr.querySelector("button")?.addEventListener("click", () => {
                tr.remove();
                saveLogs();
            });

            tbody.appendChild(tr);
        });
    }

    document.addEventListener("DOMContentLoaded", loadLogs);

    function hesaplaGecikme() {
        const borc = parseFloat(
            document.getElementById("borc").value.replace(",", ".")
        );
        const vade = document.getElementById("vade").value;
        const odeme = document.getElementById("odeme").value;
        const borcTuru = document.getElementById("borcTuru").value;

        if (isNaN(borc) || borc <= 0 || !vade || !odeme) {
            Swal.fire("UyarÄ±", "BorÃ§ tutarÄ± ve tarihler geÃ§erli olmalÄ±dÄ±r", "warning");
            return;
        }

        if (borcTuru === "usulsuzluk") {
            Swal.fire(
                "Bilgi",
                "UsulsÃ¼zlÃ¼k cezalarÄ±nda gecikme zammÄ± uygulanmaz (6183 md.51).",
                "info"
            );
            return;
        }

        fetch("/gecikme-zammi-hesapla", {
            method: "POST",
            credentials: "same-origin",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                borc: borc,
                vade: vade,
                odeme: odeme,
                borc_turu: borcTuru
            })
        })
            .then(r => {
                if (!r.ok) throw new Error("HTTP hata");
                return r.json();
            })
            .then(d => {

                const gecikme = Number(d.gecikme_zammi).toLocaleString("tr-TR", {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });

                const toplam = Number(d.toplam_borc).toLocaleString("tr-TR", {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });

                Swal.fire(
                    "SonuÃ§",
                    `
                Gecikme ZammÄ±: <b>${gecikme} TL</b><br>
                Toplam BorÃ§: <b>${toplam} TL</b>
                `,
                    "info"
                );

                /* ğŸ”½ LOG EKLEME TAM BURADA ğŸ”½ */

                const logTableBody = document.querySelector("#gecikmeLogTable tbody");

                const borcText = borc.toLocaleString("tr-TR", {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });

                const logRow = document.createElement("tr");

                logRow.innerHTML = `
                <td>${borcTuru.replace("_", " ").toUpperCase()}</td>
                <td>${borcText} TL</td>
                <td>${vade}</td>
                <td>${odeme}</td>
                <td class="text-danger fw-bold">${gecikme} TL</td>
                <td class="text-success fw-bold">${toplam} TL</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-danger">Sil</button>
                </td>
            `;

                logRow.querySelector("button").addEventListener("click", () => {
                    logRow.remove();
                    saveGecikmeLogs();
                });

                logTableBody.prepend(logRow);
                saveGecikmeLogs();
            })
            .catch(err => {
                Swal.fire("Hata", "Sunucu hatasÄ± / veri hatasÄ± oluÅŸtu", "error");
                console.error(err);
            });
    }

    function saveGecikmeLogs() {
        const rows = [];
        document.querySelectorAll("#gecikmeLogTable tbody tr").forEach(tr => {
            rows.push(tr.innerHTML);
        });
        localStorage.setItem("gecikme_loglari", JSON.stringify(rows));
    }


</script>
{% endblock %}