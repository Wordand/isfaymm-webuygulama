{% extends "layout.html" %}
{% block title %}İndirimli Kurumlar Vergisi{% endblock %}

{% block content %}
<h3 class="text-center my-4">
  <i class="bi bi-bar-chart-fill"></i> İndirimli Kurumlar Vergisi
</h3>

<ul class="nav nav-tabs mt-4 justify-content-center">
  <li class="nav-item">
    <a class="nav-link {% if sekme == 'form' %}active{% endif %}" href="?sekme=form">🧾 Form Girişi</a>
  </li>

  <li class="nav-item">
    <a class="nav-link {% if sekme == 'ayrintili' %}active{% endif %}" href="?sekme=ayrintili">
      📈 Ayrıntılı Kazanç Hesaplama
    </a>
  </li>

  <li class="nav-item">
    <a class="nav-link {% if sekme=='tesvik' %}active{% endif %}" href="?sekme=tesvik">📂 Teşvik Belgelerim</a>
  </li>


  <li class="nav-item">
    <a class="nav-link {% if sekme == 'mevzuat' %}active{% endif %}" href="?sekme=mevzuat">📚 Mevzuat</a>
  </li>
</ul>

<div class="mt-4">
  {% if sekme == 'tesvik' %}
  {% include 'tesvik.html' %}


  {% elif sekme == 'mevzuat' %}
  <ul>
    <li>5520 sayılı Kurumlar Vergisi Kanunu Madde 32/A</li>
    <li>Yatırım Teşvik Belgesi Tebliğleri</li>
    <li>Resmi Gazete Kararları ve Yönetmelikler</li>
  </ul>

  {% elif sekme == 'form' %}
  <form id="form-giris" method="POST" action="{{ url_for('indirimlikurumlar.form_kaydet') }}" novalidate class="mx-auto"
    style="max-width: 600px;">

    <input type="hidden" name="tesvik_id" value="{{ current_belge.id if current_belge else '' }}">
    <input type="hidden" name="belge_no_hidden" value="{{ current_belge.belge_no if current_belge else '' }}">
    <input type="hidden" name="belge_tarihi_hidden" value="{{ current_belge.belge_tarihi if current_belge else '' }}">
    <input type="hidden" name="bolge_hidden" id="bolge_hidden"
      value="{{ current_belge.bolge if current_belge else '' }}">


    <div class="progress mb-4" style="height: 25px;">
      <div id="progressBar" class="progress-bar progress-bar-striped bg-info" role="progressbar" style="width: 20%;"
        aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">
        Aşama <span id="current-stage-text">1</span>/7
      </div>
    </div>


    <input id="kvUploadInput" type="file" accept="application/pdf" style="display: none">


    <div id="step1">
      <h5>Aşama 1 - Temel Bilgiler</h5>

      <div class="mb-3 text-end">
        <button type="button" class="btn btn-outline-primary"
          onclick="document.getElementById('kvUploadInput').click()">
          📂 PDF’den İçe Aktar
        </button>
      </div>

      <div class="mb-3">
        <label>Yatırıma Başlama Tarihi</label>
        <input type="date" name="belge_tarihi" class="form-control" required>
      </div>

      <div class="mb-3">
        <label>Teşvik Belgesi Hangi Karara Göre Düzenlendi</label>
        <select id="karar" name="karar" class="form-select" required>
          <option value="">Seçiniz</option>
          <option value="2009/15199">2009/15199</option>
          <option value="2012/3305">2012/3305</option>
          <option value="2009/15199 (2012/3305 sayılı BKK Geçici 2. Md.)">
            2009/15199 (2012/3305 sayılı BKK Geçici 2. Md.)
          </option>
          <option value="2012/3305 (Geçici 8. Madde - 1950 sayılı Cumhurbaşkanı Kararı)">
            2012/3305 (Geçici 8. Madde - 1950 sayılı Cumhurbaşkanı Kararı)
          </option>
          <option value="2016/9495 (Yatırımlara Proje Bazlı Devlet Yardımı Verilmesine İlişkin Karar)">
            2016/9495 (Yatırımlara Proje Bazlı Devlet Yardımı Verilmesine İlişkin Karar)
          </option>
          <option value="2025/9903">2025/9903</option>
        </select>
      </div>


      <div class="mb-3">
        <label>Yatırım Türünü Seçiniz (1)</label>
        <select id="yatirim_turu1" name="yatirim_turu1" class="form-select" required>
          <option value="">Seçiniz</option>
          <option value="Komple">Komple</option>
          <option value="Tevsi">Tevsi</option>
          <option value="Modernizasyon">Modernizasyon</option>
          <option value="Entegrasyon">Entegrasyon</option>
          <option value="Ürün Geliştirme">Ürün Geliştirme</option>
          <option value="Diğer">Diğer</option>
        </select>
      </div>

      <div class="mb-3">
        <label>Yatırım Türünü Seçiniz (2)</label>
        <select id="yatirim_turu2" name="yatirim_turu2" class="form-select" required>
          <option value="">Seçiniz</option>
          <option value="Bölgesel">Bölgesel</option>
          <option value="Büyük Ölçekli">Büyük Ölçekli</option>
          <option value="Stratejik">Stratejik</option>
          <option value="Öncelikli Yatırım">Öncelikli Yatırım</option>
          <option value="Proje Bazında Desteklenen Yatırımlar (6745 Sayılı Kanun)">Proje Bazında Desteklenen Yatırımlar
            (6745 Sayılı Kanun)</option>
        </select>
      </div>

      <div class="mb-4">
        <label>Program Türü</label>
        <div class="input-group">
          <span class="input-group-text info-icon-styled" onclick="showInfo('programTuru')">
            <i class="bi bi-info-circle"></i>
          </span>
          <select name="program_turu" id="program_turu" class="form-select" disabled>
            <option value="">Seçiniz</option>
            <option value="Teknoloji Hamlesi Programı">Teknoloji Hamlesi Programı</option>
            <option value="Yerel Kalkınma Hamlesi Programı">Yerel Kalkınma Hamlesi Programı</option>
            <option value="Stratejik Hamle Programı">Stratejik Hamle Programı</option>
            <option value="Öncelikli Yatırımlar Teşvik Sistemi">Öncelikli Yatırımlar Teşvik Sistemi</option>
            <option value="Hedef Yatırımlar Teşvik Sistemi">Hedef Yatırımlar Teşvik Sistemi</option>
          </select>
        </div>
      </div>



      <div class="mb-3">
        <label>Yatırım Teşvik Belgesi Numarası</label>
        <input type="text" name="belge_no" class="form-control" required>
      </div>

      <div class="mb-3">
        <label>Tamamlama Vizesi Yapıldı mı?</label>
        <select name="vize_durumu" id="vize_durumu" class="form-select" required onchange="setOranlar()">
          <option value="">Seçiniz</option>
          <option value="Evet - İşletme Döneminde">Evet - İşletme Döneminde</option>
          <option value="Hayır - Yatırım Döneminde">Hayır - Yatırım Döneminde</option>
        </select>
      </div>
      <button type="button" class="btn btn-primary" onclick="goToStep2()">Devam</button>
    </div>

    <div id="step2" class="hidden-step">
      <hr>
      <h5>Aşama 2 - Detaylar</h5>

      <div class="mb-3">
        <label>Dönem Seçiniz</label>
        <select name="donem" id="donem" class="form-select" required onchange="setOranlar()">
          {% for yil in range(2025, 2014, -1) %}
          <optgroup label="{{ yil }}">
            <option value="{{ yil }} - 1. GEÇİCİ">{{ yil }} - 1. GEÇİCİ</option>
            <option value="{{ yil }} - 2. GEÇİCİ">{{ yil }} - 2. GEÇİCİ</option>
            <option value="{{ yil }} - 3. GEÇİCİ">{{ yil }} - 3. GEÇİCİ</option>
            <option value="{{ yil }} - KURUMLAR">{{ yil }} - KURUMLAR</option>
          </optgroup>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label>Yeniden Değerleme Oranı (%)</label>
        <input type="text" name="yeniden_degerleme_orani" id="yeniden_degerleme_orani" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>İli Seçiniz</label>
        <select name="il" id="il" class="form-select" required onchange="setBolge()">
          {% for il in iller %}
          <option value="{{ il }}">{{ il }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label>Bölge</label>
        <input type="text" name="bolge" id="bolge" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>OSB Durumu</label>
        <select name="osb" id="osb" class="form-select" onchange="setOranlar()">
          <option value="OSB İçinde">OSB İçinde</option>
          <option value="OSB Dışında">OSB Dışında</option>
        </select>
      </div>

      <div class="row g-3 align-items-stretch mb-3">

        <!-- SOL BİLGİ KUTUSU -->
        <div class="col-md-5 d-flex">
          <div class="ikv-info-box p-3 bg-light rounded-3 border flex-fill">
            <div class="fw-semibold mb-2">İndirimli KV Oranları</div>
            <ul class="list-unstyled small mb-0">
              <li class="d-flex justify-content-between">
                <span>İhracat için</span>
                <span id="ind_kv_ihr" class="fw-semibold">—%</span>
              </li>
              <li class="d-flex justify-content-between">
                <span>İmalat için</span>
                <span id="ind_kv_iml" class="fw-semibold">—%</span>
              </li>
              <li class="d-flex justify-content-between">
                <span>Diğer Gelirler için</span>
                <span id="ind_kv_dig" class="fw-semibold">—%</span>
              </li>
            </ul>
          </div>
        </div>

        <!-- SAĞ KONTROLLER -->
        <div class="col-md-7">
          <div class="row g-3 h-100">
            <div class="col-12">
              <label class="form-label">Yatırıma Katkı Oranı (%)</label>
              <div class="input-group fullheight-group">
                <input type="text" name="katki_orani" id="katki_orani" class="form-control" readonly>
                <span class="input-group-text">%</span>
                <button type="button" class="btn btn-outline-secondary" id="btn-manual-katki">Manuel Belirle</button>
              </div>
            </div>

            <div class="col-12">
              <label class="form-label">Vergi İndirim Oranı (%)</label>
              <div class="input-group fullheight-group">
                <input type="text" name="vergi_orani" id="vergi_orani" class="form-control" readonly>
                <span class="input-group-text">%</span>
                <button type="button" class="btn btn-outline-secondary" id="btn-manual-vergi">Manuel Belirle</button>
              </div>
            </div>
          </div>
        </div>

      </div>


      <div class="mb-4">
        <label>Diğer Kazançlara Uygulanacak Oran (%)</label>
        <div class="input-group">
          <span class="input-group-text info-icon-styled" onclick="showInfo('digeroran')">
            <i class="bi bi-info-circle"></i>
          </span>
          <input type="text" name="diger_oran" id="diger_oran" class="form-control" readonly>
        </div>
      </div>

      <!-- 🔹 Butonları ayrı bir satıra al -->
      <div class="mt-3">
        <button type="button" class="btn btn-secondary me-2" onclick="goToStep1()">← Geri</button>
        <button type="button" class="btn btn-primary" onclick="goToStep3()">Devam</button>
      </div>
    </div>






    <div id="step3" class="hidden-step">
      <h5>Aşama 3 - Yatırım Bilgileri</h5>

      <div class="mb-3">
        <label>Toplam Yatırım Tutarını Giriniz</label>
        <input type="text" name="toplam_tutar" id="toplam_tutar" class="form-control" placeholder="Tutar Giriniz">
      </div>

      <div class="mb-3">
        <label>Toplam Yatırıma Katkı Tutarı</label>
        <input type="text" name="katki_tutari" id="katki_tutari" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Diğer Faaliyetlerden Elde Edilen Kazançlar İçin Katkı Tutarı</label>
        <div class="input-group">
          <span class="input-group-text info-icon-styled" onclick="showInfo('digerkatkitutari')">
            <i class="bi bi-info-circle"></i>
          </span>
          <input type="text" name="diger_katki_tutari" id="diger_katki_tutari" class="form-control" readonly>
        </div>
      </div>

      <div class="mb-3">
        <label>Cari Yılda Fiilen Gerçekleştirilen Yatırım Harcaması Tutarını Giriniz</label>
        <input type="text" name="cari_harcama_tutari" id="cari_harcama_tutari" class="form-control"
          placeholder="Tutar Giriniz">
      </div>

      <div class="mb-3">
        <label>Yatırımın Başlangıcından İtibaren Fiilen Gerçekleştirilen Yatırım Harcaması Tutarını Giriniz</label>
        <input type="text" name="toplam_harcama_tutari" id="toplam_harcama_tutari" class="form-control"
          placeholder="Tutar Giriniz">
      </div>

      <div class="mb-3">
        <label>Fiili Yatırım Harcaması Nedeniyle Hak Kazanılan Yatırıma Katkı Tutarı</label>
        <input type="text" name="fiili_katki_tutari" id="fiili_katki_tutari" class="form-control" readonly>
      </div>

      <button type="button" class="btn btn-secondary me-2" onclick="goToStep2()">← Geri</button>
      <button type="button" class="btn btn-primary" onclick="goToStep4()">Devam</button>

    </div>

    <div id="step4" class="hidden-step">
      <h5>Aşama 4 - Hesaplamalar</h5>

      <div class="mb-3">
        <label>Önceki Dönemlerde Yararlanılan Yatırıma Katkı Tutarını Giriniz<br>
          (<span class="text-primary fw-bold">Yatırımdan Elde Edilen Kazanç Dolayısıyla</span>)
          <input type="text" name="onceki_yatirim_katki_tutari" id="onceki_yatirim_katki_tutari" class="form-control"
            placeholder="Tutar Giriniz">
      </div>

      <div class="mb-3">
        <label>Önceki Dönemlerde Yararlanılan Yatırıma Katkı Tutarını Giriniz<br>
          (<span class="text-success fw-bold">Diğer Faaliyetlerden Elde Edilen Kazanç Dolayısıyla</span>)
          <input type="text" name="onceki_diger_katki_tutari" id="onceki_diger_katki_tutari" class="form-control"
            placeholder="Tutar Giriniz">
      </div>

      <div class="mb-3">
        <label>Önceki Dönemlerde Yararlanılan Toplam Yatırıma Katkı Tutarı</label>
        <input type="text" name="onceki_katki_tutari" id="onceki_katki_tutari" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Cari Hesaplama Öncesi Kalan Katkı Tutarı</label>
        <input type="text" name="kalan_katki_tutari" id="kalan_katki_tutari" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Endekslenmiş Tutarlar Dahil Fiili Yatırım Harcaması Nedeniyle<br>
          Hak Kazanılan Yatırıma Katkı Tutarı</label>
        <input type="text" name="endeks_katki_tutari" id="endeks_katki_tutari" class="form-control" readonly>
      </div>

      <button type="button" class="btn btn-secondary me-2" onclick="goToStep3()">← Geri</button>
      <button type="button" class="btn btn-primary" onclick="goToStep5()">Devam</button>
    </div>

    <div id="step5" class="hidden-step">
      <h5 class="mb-4">Aşama 5 - Tevsi Yatırım Bilgileri</h5>

      <div class="mb-3">
        <label>Gerçekleşen Tevsi Yatırım Tutarını Giriniz (TL):</label>
        <input type="text" name="gerceklesen_tevsi_yatirim_tutari" id="gerceklesen_tevsi_yatirim_tutari"
          class="form-control" placeholder="0,00 TL" oninput="calculateTevsiKazancAutomatically()">
      </div>

      <div class="mb-3">

        <label>Toplam Sabit Kıymet Tutarını Giriniz (TL):</label>
        <div class="input-group">
          <span class="input-group-text info-icon-styled" onclick="showInfo('toplamSabitKiymetTutari')">
            <i class="bi bi-info-circle"></i>
          </span>
          <input type="text" name="toplam_sabit_kiymet_tutari" id="toplam_sabit_kiymet_tutari" class="form-control"
            placeholder="0,00 TL" oninput="calculateTevsiKazancAutomatically()">
        </div>
      </div>

      <div class="mb-3">
        <label>Ticari Bilanço Karını Giriniz (TL):</label>
        <input type="text" name="ticari_bilanco_kari" id="ticari_bilanco_kari" class="form-control"
          placeholder="0,00 TL" oninput="calculateTevsiKazancAutomatically()">

      </div>

      <div class="mb-3">
        <label>KKEG Giriniz (TL):</label>
        <input type="text" name="kkeg" id="kkeg" class="form-control" placeholder="0,00 TL">
      </div>

      <div class="mb-3">
        <label>Kurumlar Vergisi Matrahı (TL)</label>
        <input type="text" name="kv_matrah" id="kv_matrah" class="form-control" placeholder="0,00 TL" readonly>
      </div>

      <div class="mb-3">
        <label>Tevsi Yatırımlardan Elde Edilen Kazanç Tutarı (TL):</label>
        <div class="input-group">
          <span class="input-group-text info-icon-styled" onclick="showInfo('tevsiYatirimdanEldeEdilenKazancTutari')">
            <i class="bi bi-info-circle"></i>
          </span>
          <input type="text" name="tevsi_yatirim_kazanci" id="tevsi_yatirim_kazanci" class="form-control"
            placeholder="0,00 TL" readonly>
        </div>
      </div>

      <button type="button" class="btn btn-secondary me-2" onclick="goToStep4()">← Geri</button>
      <button type="button" class="btn btn-primary" onclick="goToStep6()">Devam</button>
    </div>

    <div id="step6" class="hidden-step">
      <h5>Aşama 6 – Satış & Faaliyet Dağılımı</h5>

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="useDetailedProfitRatios" name="use_detailed_profit_ratios"
          onchange="toggleDetailedProfitInput()">
        <label class="form-check-label" for="useDetailedProfitRatios">
          📈 Ayrıntılı Kazanç Dağılımını Kullan
        </label>
      </div>

      <div class="mb-3">
        <label>Brüt Satışlar</label>
        <input type="text" name="brut_satis" id="brut_satis" class="form-control" placeholder="Tutar Giriniz">
      </div>
      <div class="mb-3 row">
        <div class="col">
          <label>İhracat Faaliyeti</label>
          <input type="text" name="ihracat" id="ihracat" class="form-control" placeholder="Tutar Giriniz"
            oninput="calculateRatios()">
        </div>
        <div class="col-auto align-self-end">
          <span id="ratio_ihracat">—%</span>
        </div>
      </div>
      <div class="mb-3 row">
        <div class="col">
          <label>İmalat Faaliyeti</label>
          <input type="text" name="imalat" id="imalat" class="form-control" placeholder="Tutar Giriniz"
            oninput="calculateRatios()">
        </div>
        <div class="col-auto align-self-end">
          <span id="ratio_imalat">—%</span>
        </div>
      </div>
      <div class="mb-3 row">
        <div class="col">
          <label>Diğer Faaliyetler</label>
          <input type="text" name="diger_faaliyet" id="diger_faaliyet" class="form-control" placeholder="Tutar Giriniz"
            oninput="calculateRatios()">
        </div>
        <div class="col-auto align-self-end">
          <span id="ratio_diger">—%</span>
        </div>
      </div>



      <button type="button" class="btn btn-secondary me-2" onclick="goToStep5('from6')">← Geri</button>
      <button id="calculateCariBtn" type="button" class="btn btn-primary">
        CARİ KATKI TUTARINI HESAPLA
      </button>

      <div class="mt-5 d-flex justify-content-center">
        <a href="?sekme=ayrintili" class="btn btn-lg text-white text-decoration-none
                                      px-5 py-3 rounded-pill btn-gradient-hover shadow-lg">
          <i class="bi bi-pie-chart-fill me-2"></i>
          Kazanç Dağılımını <br class="d-none d-md-block">
          Ayrıntılı Olarak Hesaplamak İstiyorum
          <i class="bi bi-arrow-right ms-2"></i>
        </a>
      </div>
    </div>

    <div id="step7" class="hidden-step">
      <h5>Aşama 7 - Sonuçlar & Kaydet</h5>


      <div class="mb-3">
        <label>Cari Dönemde Yararlanılan Yatırıma Katkı Tutarı (Yatırımdan Elde Edilen Kazanç Dolayısıyla)</label>
        <input type="text" id="cari_yatirim_katki" name="cari_yatirim_katki" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Cari Dönemde Yararlanılan Yatırıma Katkı Tutarı (Diğer Faaliyetlerden Elde Edilen Gelirler
          Dolayısıyla)</label>
        <input type="text" id="cari_diger_katki" name="cari_diger_katki" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Cari Dönemde Yararlanılan Toplam Yatırıma Katkı Tutarı</label>
        <input type="text" id="cari_toplam_katki" name="cari_toplam_katki" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Cari Dönem Dahil Olmak Üzere Yararlanılan Toplam Yatırıma Katkı Tutarı</label>
        <input type="text" id="genel_toplam_katki" name="genel_toplam_katki" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>İndirimli Kurumlar Vergisi Matrahı</label>
        <input type="text" id="indirimli_matrah" name="indirimli_matrah" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>İndirimli Kurumlar Vergisi</label>
        <input type="text" id="indirimli_kv" name="indirimli_kv" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>İndirimli Kurumlar Vergisi Oranı %</label>
        <input type="text" id="indirimli_kv_oran" name="indirimli_kv_oran" class="form-control" readonly>
      </div>


      <div class="d-flex justify-content-start gap-2 mt-4">
        <button type="button" class="btn btn-secondary" onclick="goToStep6()">← Geri</button>

        <button type="submit" id="btn-save-step7" name="submit_action" value="new_save" class="btn btn-success">
          💾 Yeni Belge Kaydet
        </button>

        {% if current_belge %}
        <button type="submit" id="btn-guncelle-step7" name="submit_action" value="update" class="btn btn-warning">
          🔄 Güncelle
        </button>
        {% endif %}

      </div>
    </div>
  </form>

  {% elif sekme == 'ayrintili' %}
  <div class="text-center my-4">
    <a href="?sekme=form#step6" class="btn btn-outline-secondary btn-lg text-decoration-none">
      ← Aşama 6’ya Geri Dön
    </a>
  </div>

  <h3 class="text-center my-4">📊 Ayrıntılı Kazanç Hesaplama</h3>

  <form method="POST" class="mb-4" id="ayrintili-kazanc-form"
    action="{{ url_for('indirimlikurumlar.ayrintili_kazanc') }}">
    <div class="d-flex justify-content-between mb-3">
      <button name="import" class="btn btn-primary" type="button" id="import-ayrintili">
        📂 İçe Aktar
      </button>
      <button name="export" class="btn btn-success">
        📤 Dışa Aktar
      </button>
    </div>

    <table class="table table-striped table-bordered" id="ayrintili-kazanc-table">
      <thead class="table-light">
        <tr>
          <th>Açıklama</th>
          <th>Toplam Hasılat (B)</th>
          <th>İhracat (C)</th>
          <th>İmalat (D)</th>
          <th>Diğer (E)</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        {# parantez içindeki kodu al #}
        {% set code = row['Açıklama'].split('(')[-1].split(')')[0] %}
        <tr>
          <td class="
                                {% if code|length == 3 %}
                                    text-end
                                {% else %}
                                    text-start fw-bold
                                {% endif %}
                            ">
            {{ row['Açıklama'] }}
          </td>

          <td><input name="B_{{ loop.index0 }}" class="form-control form-control-sm text-end" value="{{ row['B'] }}"
              placeholder="Tutar Giriniz" {% if loop.index0 in
              [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54]
              %}readonly{% endif %}></td>
          <td><input name="C_{{ loop.index0 }}" class="form-control form-control-sm text-end" value="{{ row['C'] }}"
              placeholder="Tutar Giriniz" {% if loop.index0 in [0,1,5,9,10,15,16,20,21,22,23,34,42,45,46,49,53,54]
              %}readonly{% endif %}></td>
          <td><input name="D_{{ loop.index0 }}" class="form-control form-control-sm text-end" value="{{ row['D'] }}"
              placeholder="Tutar Giriniz" {% if loop.index0 in [0,1,5,9,10,15,16,20,21,22,23,34,42,45,46,49,53,54]
              %}readonly{% endif %}></td>
          <td><input name="E_{{ loop.index0 }}" class="form-control form-control-sm text-end" value="{{ row['E'] }}"
              placeholder="Tutar Giriniz" {% if loop.index0 in [0,1,5,9,10,15,16,20,21,22,23,34,42,45,46,49,53,54]
              %}readonly{% endif %}></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="text-center mt-4">
      <button type="submit" class="btn btn-lg btn-outline-primary" id="save-ayrintili-kazanc">💾 Kaydet</button> {# ID
      eklendi #}
      <button type="button" class="btn btn-lg btn-danger ms-2" id="clearProfitData">🗑️ Tümünü Temizle</button>
    </div>
  </form>
  {% endif %}
</div>


<style>
  #step1,
  #step2,
  #step3,
  #step4,
  #step5,
  #step6,
  #step7 {
    transition: opacity 0.4s ease-in-out, visibility 0.4s ease-in-out;
    opacity: 1;
    visibility: visible;
  }

  .hidden-step {
    display: none !important;
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none;
    position: absolute;
  }

  .fullheight-group .form-control,
  .fullheight-group .input-group-text,
  .fullheight-group .btn {
    height: 44px;
  }

  .ikv-info-box {
    display: flex;
    flex-direction: column;
    justify-content: center;
    /* kutu içeriğini ortala */
  }
</style>

<script>
  const bolgeMap = {{ bolge_json | tojson }};
  const katkilar = {{ katkilar_json | tojson }};
  const vergiler = {{ vergiler_json | tojson }};
  const initialRatios = {{ initial_ayrintili_ratios | tojson }};
  const bolgeMap9903 = {{ BOLGE_MAP_9903 | tojson | safe }};
  const katkilar9903 = {{ TESVIK_KATKILAR_9903 | tojson | safe }};

  const yenidenDegerlemeOranlari = {
    "2025 - 3. GEÇİCİ": 0,
    "2025 - 2. GEÇİCİ": 9.23,
    "2025 - 1. GEÇİCİ": 3.30,
    "2025 - KURUMLAR": 0,
    "2024 - 3. GEÇİCİ": 34.14,
    "2024 - 2. GEÇİCİ": 22.20,
    "2024 - 1. GEÇİCİ": 7.55,
    "2024 - KURUMLAR": 43.93,
    "2023 - KURUMLAR": 58.46,
    "2022 - KURUMLAR": 122.93,
    "2021 - KURUMLAR": 36.20,
    "2020 - KURUMLAR": 9.11
  };

  let debounceTimeout = null;
  let isProgrammaticChange = false; // Yeni bayrak: Programatik değişiklik mi?


  // Aşamaları temsil eden dizi (global olarak tanımlı, bu kod bloğunun başında olmalı)
  const ALL_STEPS_IDS = ["step1", "step2", "step3", "step4", "step5", "step6", "step7"];
  const TOTAL_STEPS = 7; // Toplam aşama sayısı

  let CURRENT_STEP = 1; // Nereden geldiğimizi takip etmek için

  let tevsiMask;





  function parseFormattedNumber(value) {
    if (!value) return 0;
    const normalized = value.toString()
      .replace(/\s+/g, '')
      .replace('%', '')
      .replace(/\./g, '')
      .replace(',', '.');
    const num = parseFloat(normalized);
    return isNaN(num) ? 0 : num;
  }

  function normalizeBN(s) { return (s || '').replace(/\D/g, ''); }

  function convertToInputDateFormat(t) {
    const p = (t || '').split('/');
    return p.length === 3 ? `${p[2]}-${p[1].padStart(2, '0')}-${p[0].padStart(2, '0')}` : t;
  }




  function kararDegisti() {
    const karar = document.getElementById("karar")?.value;
    const programSelect = document.getElementById("program_turu");
    const yatirimTuru1 = document.getElementById("yatirim_turu1");
    const yatirimTuru2 = document.getElementById("yatirim_turu2");
    const katkiInput = document.getElementById("katki_orani");
    const vergiInput = document.getElementById("vergi_orani");
    const digerInput = document.getElementById("diger_oran");

    if (karar === "2025/9903") {
      console.log("→ 2025/9903 modu aktif!");

      // Program aktif hale getir
      programSelect.removeAttribute("disabled");
      programSelect.disabled = false;
      programSelect.classList.remove("bg-light");

      // Yatırım türleri pasif
      yatirimTuru1.disabled = true;
      yatirimTuru2.disabled = true;
      yatirimTuru1.value = "";
      yatirimTuru2.value = "";
      yatirimTuru1.classList.add("bg-light");
      yatirimTuru2.classList.add("bg-light");

      // Sabit oranlar
      vergiInput.value = 60;
      digerInput.value = 50;

    } else {
      console.log("→ Normal teşvik modu.");

      // Program türü tekrar kapat
      programSelect.setAttribute("disabled", "disabled");
      programSelect.classList.add("bg-light");

      // Yatırım türleri tekrar aktif
      yatirimTuru1.disabled = false;
      yatirimTuru2.disabled = false;
      yatirimTuru1.classList.remove("bg-light");
      yatirimTuru2.classList.remove("bg-light");

      // Oranları sıfırla
      vergiInput.value = "";
      digerInput.value = "";
      katkiInput.value = "";

      setBolge();
      setOranlar();
    }
  }



  function setBolge() {
    const karar = document.getElementById("karar")?.value;
    if (karar === "2025/9903") {
      console.log("📍 2025/9903 aktif — bölge ayarı yapıldı ama katkı oranı değiştirilmedi.");
      return;
    }

    const ilSelect = document.getElementById("il");
    const bolgeInput = document.getElementById("bolge");
    if (ilSelect && bolgeInput) {
      const il = ilSelect.value;
      const bolge = bolgeMap[il];
      bolgeInput.value = bolge;

    }
  }

  function setOranlar() {
    const karar = document.getElementById("karar")?.value;
    if (karar === "2025/9903") return;
    const bolgeInput = document.getElementById("bolge");
    const osbSelect = document.getElementById("osb");
    const vizeSelect = document.getElementById("vize_durumu");
    const donemSelect = document.getElementById("donem");
    if (!bolgeInput || !osbSelect || !vizeSelect || !donemSelect) return;

    const bolge = bolgeInput.value;
    const osb = osbSelect.value;
    const key = bolge + "|" + osb;

    const vize = vizeSelect.value;
    const donem = donemSelect.value;
    const donemYil = parseInt(donem.split(" - ")[0]);

    // 1) YDO yaz/temizle
    const yenidenDegerlemeOraniEl = document.getElementById("yeniden_degerleme_orani");
    if (yenidenDegerlemeOraniEl) {
      if (vize.includes("Hayır")) {
        yenidenDegerlemeOraniEl.value = "YATIRIM DÖNEMİNDE OLDUĞUNUZ İÇİN ENDEKSLEME YAPILMAZ";
        yenidenDegerlemeOraniEl.classList.add("text-muted");   // opsiyonel: gri göster
      } else {
        const oranAnahtari = donem;
        yenidenDegerlemeOraniEl.value = (yenidenDegerlemeOranlari[oranAnahtari] ?? "");
        yenidenDegerlemeOraniEl.classList.remove("text-muted");
      }
    }

    // 2) Katkı oranı
    const katkiOraniEl = document.getElementById("katki_orani");
    const manualKatki = sessionStorage.getItem('manual_katki') === 'true';
    const manualKatkiVal = sessionStorage.getItem('manual_katki_value');
    if (katkiOraniEl) {
      if (manualKatki && manualKatkiVal !== null) {
        katkiOraniEl.value = manualKatkiVal; // manuel değeri koru
      } else {
        let v = katkilar[key] ?? "";
        if (v !== "") v = Math.max(0, Math.min(100, Number(v)));
        katkiOraniEl.value = v;
      }
    }

    // 3) Vergi indirim oranı
    const vergiOraniEl = document.getElementById("vergi_orani");
    const manualVergi = sessionStorage.getItem('manual_vergi') === 'true';
    const manualVergiVal = sessionStorage.getItem('manual_vergi_value');
    if (vergiOraniEl) {
      if (manualVergi && manualVergiVal !== null) {
        vergiOraniEl.value = manualVergiVal; // manuel değeri koru
      } else {
        let v = (donemYil >= 2017 && donemYil <= 2022) ? 100 : (vergiler[key] ?? "");
        if (v !== "") v = Math.max(0, Math.min(100, Number(v)));
        vergiOraniEl.value = v;
      }
    }

    // 4) Diğer kazanç oranı (manuel değişmiyorsa olduğu gibi bırak)
    const digerOranEl = document.getElementById("diger_oran");
    if (digerOranEl) {
      if (vize.includes("Evet")) {
        digerOranEl.value = "İŞLETME DÖNEMİNDE HESAPLANMAZ";
      } else {
        let v = (donemYil >= 2017 && donemYil <= 2022) ? 100 : 80;
        v = Math.max(0, Math.min(100, Number(v)));
        digerOranEl.value = v;
      }
    }


    // 5) Sol “İndirimli KV Oranları (bilgi)” kutusunu güncelle
    updateDiscountedRatesUI();

    // 6) Aşama 3/4’te isek bağlı hesaplamaları tetikle
    const step3El = document.getElementById("step3");
    if (step3El && !step3El.classList.contains("hidden-step")) {
      hesaplaKatkiTutari();
      hesaplaDigerKatkiTutari();
      hesaplaFiiliKatkiTutari();
    }
    const step4El = document.getElementById("step4");
    if (step4El && !step4El.classList.contains("hidden-step")) {
      hesaplaOncekiKatkiTutari();
      hesaplaKalanVeEndeks();
    }
  }





  function showSwalMessage(type, title, text) {
    Swal.fire({
      icon: type,
      title: title,
      text: text,
      timer: 3000,
      toast: true,
      position: "top-end",
      showConfirmButton: false
    });
  }

  function showInfo(key) {
    let title = "Bilgilendirme";
    let message = "Bilgi mesajı mevcut değil.";
    let icon = "info";
    const createJustifiedMessage = (text) => `<div style='text-align: justify;'>${text}</div>`;
    switch (key) {
      case 'yatirimaBaslamaTarihi':
        message = createJustifiedMessage(
          "<b>Yatırıma Başlama Tarihi</b> olarak, Yatırım Teşvik Belgesi ekinde yer alan 'yatırıma başlama tarihi' esas alınmalıdır. <br><br>" +
          "<i>Önemli Not:</i> Eğer belgede birden fazla tarih varsa, genellikle yatırımın fiilen başladığı veya belgenin onaylandığı tarih kullanılır."
        );
        break;

      case 'programTuru':
        title = "2025/9903 Güncel Karara İlişkin Bilgilendirme";
        message = createJustifiedMessage(
          "<b>NOT:</b> Kurumlar vergisi oranı, yatırım teşvik belgesi kapsamında gerçekleştirilen yatırımlardan elde edilen kazançlara, " +
          "yatırımın kısmen veya tamamen işletilmesine başlanılan hesap döneminden itibaren " +
          "yatırıma katkı tutarına ulaşıncaya kadar, indirim hakkının kullanılabileceği ilk hesap dönemi dahil " +
          "en fazla <b>10 hesap dönemi</b> boyunca <b>%60 indirimli</b> olarak uygulanır.<br><br>" +

          "İndirim hakkının kullanılabileceği ilk hesap dönemi dahil en fazla on hesap dönemine ilişkin sınırlama, " +
          "<b>16/6/2025</b> tarihinden önce başvurusu yapılmış ve reddedilmemiş olanlar hariç, " +
          "<b>24/7/2025</b> tarihinden itibaren (bu tarih dahil) alınan yatırım teşvik belgeleri yönünden geçerli olacaktır.<br><br>" +

          "<b>NOT:</b> Kazanç bulunmasına rağmen yararlanılmayan yatırıma katkı tutarları müteakip dönemlerde dikkate alınmaz.<br><br>" +
          "Buna göre, ilgili hesap dönemlerinde faydalanma imkânı bulunmakta iken, " +
          "<b>faydalanılmayan yatırıma katkı tutarlarının izleyen dönemlerde kullanılması mümkün değildir.</b>"
        );
        break;

      case 'digeroran':
        message = createJustifiedMessage(
          "Yatırım döneminde diğer faaliyetlerden elde edilen kazançlarda indirimli kurumlar vergisi uygulanması mümkündür."
        );
        break;


      case 'digerkatkitutari':
        message = createJustifiedMessage(
          "Mükellefler, yatırım teşvik belgeleri kapsamındaki yatırımlarına fiilen başladıkları tarihten itibaren, hesaplanacak yatırıma katkı tutarına mahsuben; <br><br>" +
          "a) Toplam yatırıma katkı tutarının Bakanlar Kurulu Kararı ile belirlenen oranını geçmemek ve <br><br>" +
          "b) Gerçekleştirilen yatırım harcaması tutarını aşmamak <br><br>" +
          "üzere, yatırım döneminde diğer faaliyetlerinden elde ettikleri kazançlarına indirimli kurumlar vergisi uygulanabilecektir."
        );
        break;


      case 'toplamSabitKiymetTutari':
        message = createJustifiedMessage(
          "<b>Toplam Sabit Kıymet Tutarı</b> ifadesinden, Amortisman mevzuunu oluşturan iktisadi kıymetlerin anlaşılması gerekir.<br><br>" +
          "Dolayısıyla boş arazi-arsa ve amortismana tabi olmayan diğer kıymetlerle ilgili tutarlar bu hesaplamada dikkate alınmaz.<br><br>" +
          "Sabit Kıymet tutarının hesabında bu kıymetlerin BİRİKMİŞ AMORTİSMAN DÜŞÜLMEDEN önceki brüt tutarlarının dikkate alınması gerekmektedir.<br><br>" +
          "Bu hesaplama sırasında işletme aktifinde yer alan sabit kıymetlerin kayıtlı değeri olarak, yapılan ENFLASYON DÜZELTMESİ SONUCU oluşan değerleri dikkate alınacaktır."
        );
        break;

      case 'tevsiYatirimdanEldeEdilenKazancTutari':
        message = createJustifiedMessage(
          "Tevsi yatırımlardan elde edilen kazancın ayrı hesaplarda izlenmek suretiyle tespit edilebilmesi halinde, bu kazanca indirimli vergi oranı uygulanacaktır. <br><br>" +
          "Kazancın ayrı bir şekilde tespit edilememesi halinde ise; <br><br>" +
          "Tevsi yatırım dolayısıyla indirimli vergi oranı uygulanacak kazanç = (Gerçekleşen Tevsi Yatırım Tutarı / Toplam Sabit Kıymet Tutarı) X Ticari bilanço Karı <br><br>" +
          "Tevsi yatırımlardan elde edilen kazancın bu şekilde oranlama yapılmak suretiyle belirlenmesi seçimlik bir hak olmayıp, indirimli kurumlar vergisi uygulanacak kazancın ayrı hesaplarda izlenmek suretiyle mükellefçe tespit edilmesi esastır."
        );
        break;

      default: // Varsayılan durum: Eğer tanımsız bir anahtar gelirse
        message = "Bu alan hakkında bilgi bulunmamaktadır.";
        icon = "warning"; // Varsayılan durum için uyarı ikonu
        break;
    }
    // SweetAlert mesajını göster
    Swal.fire({
      icon: icon, // 'info' ikonu kullanılacak
      title: title,
      html: message,
      position: 'center', // Ekranın ortasında göster
      showCloseButton: true, // Kapatma butonu göster
      showConfirmButton: true, // "Tamam" butonu gösterme
      timer: undefined, // Otomatik kapanma kapalı
      toast: false, // Toast modu kapalı
      allowOutsideClick: true, // Dışarıya tıklayınca kapanmasına izin ver
      allowEscapeKey: true, // ESC tuşuyla kapanmasına izin ver

      width: '55em',              // Kutuyu genişletir
      scrollbarPadding: false,    // Sayfa kaymasını önler
      heightAuto: false,

      // YENİ EKLENEN customClass ÖZELLİKLERİ
      customClass: {
        popup: 'swal2-green-theme-popup', // Tüm kutu için
        header: 'swal2-green-theme-header', // Başlık alanı için
        title: 'swal2-green-theme-title', // Başlık metni için
        icon: 'swal2-green-theme-icon', // İkon için
        closeButton: 'swal2-green-theme-close-button', // Kapatma butonu için
        htmlContainer: 'swal2-green-theme-html-container'
      }
    });
  }

  function updateProgress(step) {
    const progressBar = document.getElementById("progressBar");
    const currentStageText = document.getElementById("current-stage-text"); // current-stage-text id'li span'i doğru al

    if (progressBar && currentStageText) {
      const percent = (step / TOTAL_STEPS) * 100;
      progressBar.style.width = percent + "%";
      progressBar.setAttribute("aria-valuenow", percent);
      currentStageText.textContent = step; // Sadece sayıyı günceller, "Aşama X / Y" metni HTML'de sabit kalır
    }
  }

  function _updateStepDisplay(stepNum) {
    ALL_STEPS_IDS.forEach((id, idx) => {
      const el = document.getElementById(id);
      if (!el) return;
      const controls = el.querySelectorAll("input, select, textarea, button[type='submit']");

      if (idx + 1 === stepNum) {
        el.classList.remove("hidden-step");
        controls.forEach(c => c.disabled = false);
      } else {
        el.classList.add("hidden-step");
        controls.forEach(c => {
          if (c.tagName === 'BUTTON' && (c.type === 'submit' || c.type === 'button')) {
            c.disabled = true;
          } else {
            c.disabled = false; // Input, select, textarea aktif kalsın
          }
        });
      }
    });

    updateProgress(stepNum);

    if (stepNum === 2) {
      setBolge();
      setOranlar();
    } else if (stepNum === 3) {
      setOranlar();
      hesaplaKatkiTutari();
      hesaplaDigerKatkiTutari();
      hesaplaFiiliKatkiTutari();
    } else if (stepNum === 4) {
      hesaplaOncekiKatkiTutari();
      hesaplaKalanVeEndeks();
    } else if (stepNum === 6) {
      toggleDetailedProfitInput();

      const belgeNoInput = document.querySelector('input[name="belge_no"]');
      const belgeTarihiInput = document.querySelector('input[name="belge_tarihi"]');
      const bolgeInput = document.getElementById('bolge');

      if (belgeNoInput) {
        const h = document.querySelector('input[name="belge_no_hidden"]');
        if (h) h.value = belgeNoInput.value;
      }
      if (belgeTarihiInput) {
        const h = document.querySelector('input[name="belge_tarihi_hidden"]');
        if (h) h.value = belgeTarihiInput.value;
      }
      if (bolgeInput) {
        const h = document.getElementById('bolge_hidden');
        if (h) h.value = bolgeInput.value;
      }
    }

    CURRENT_STEP = stepNum;

    // 🔹 Step değiştiğinde her zaman 2025/9903 kararını yeniden uygula
    if (typeof handleKarar9903 === "function") {
      handleKarar9903();
    }

    if (typeof blinkAllInfoIcons === "function") blinkAllInfoIcons();
  }


  function updateDiscountedRatesUI() {
    const vergiOraniEl = document.getElementById("vergi_orani");
    const spanIhr = document.getElementById("ind_kv_ihr");
    const spanIml = document.getElementById("ind_kv_iml");
    const spanDig = document.getElementById("ind_kv_dig");
    if (!vergiOraniEl || !spanIhr || !spanIml || !spanDig) return;

    const p = parseFormattedNumber(vergiOraniEl.value) / 100; // 0..1
    if (isNaN(p)) {
      spanIhr.textContent = "—";
      spanIml.textContent = "—";
      spanDig.textContent = "—";
      return;
    }
    const rIhr = 0.20 - (0.20 * p);
    const rIml = 0.24 - (0.24 * p);
    const rDig = 0.25 - (0.25 * p);

    const fmtPct = (x) => (x * 100).toFixed(2).replace('.', ',') + '%';
    spanIhr.textContent = fmtPct(rIhr);
    spanIml.textContent = fmtPct(rIml);
    spanDig.textContent = fmtPct(rDig);
  }





  // Ayrıntılı kazanç tablosunu sunucuya kaydetmek için AJAX fonksiyonu
  async function saveDetailedProfitData() {
    const ayrTable = document.getElementById('ayrintili-kazanc-table');
    if (!ayrTable) {
      return;
    }
    const formData = new FormData();
    let dataChanged = false;
    ayrTable.querySelectorAll('tbody tr').forEach((rowEl) => {
      rowEl.querySelectorAll('input').forEach(input => {
        if (!input.readOnly) {
          const originalValue = input.getAttribute('data-original-value');
          const currentValue = input.value;
          if (originalValue !== currentValue) {
            formData.append(input.name, currentValue);
            dataChanged = true;
          }
        }
      });
    });
    if (!dataChanged) {
      return;
    }
    try {
      const response = await fetch("{{ url_for('indirimlikurumlar.ayrintili_kazanc') }}", {
        method: "POST",
        body: formData
      });
      if (response.ok) {
        ayrTable.querySelectorAll('tbody input').forEach(input => {
          input.setAttribute('data-original-value', input.value);
        });
        updateSessionStorageRatios();
      } else {
        console.error("Otomatik kaydetme başarısız oldu:", response.status, response.statusText);
      }
    } catch (error) {
      console.error("Otomatik kaydetme sırasında hata oluştu:", error);
    }
  }

  function updateSessionStorageRatios() {
    const ayrTable = document.getElementById('ayrintili-kazanc-table');
    if (!ayrTable) {
      return;
    }
    const C54_input = ayrTable.querySelector('input[name="C_54"]');
    const D54_input = ayrTable.querySelector('input[name="D_54"]');
    const E54_input = ayrTable.querySelector('input[name="E_54"]');
    if (C54_input && D54_input && E54_input) {
      sessionStorage.setItem('ayrintili_C54', C54_input.value);
      sessionStorage.setItem('ayrintili_D54', D54_input.value);
      sessionStorage.setItem('ayrintili_E54', E54_input.value);
    }
  }

  function toggleDetailedProfitInput() {
    const useDetailedCheckbox = document.getElementById("useDetailedProfitRatios");
    if (!useDetailedCheckbox) return;
    const useDetailed = useDetailedCheckbox.checked;
    const brutInput = document.getElementById("brut_satis");
    const ihracatInput = document.getElementById("ihracat");
    const imalatInput = document.getElementById("imalat");
    const digerFaaliyetInput = document.getElementById("diger_faaliyet");
    if (!brutInput || !ihracatInput || !imalatInput || !digerFaaliyetInput) return;
    if (useDetailed) {
      brutInput.setAttribute('readonly', true);
      ihracatInput.setAttribute('readonly', true);
      imalatInput.setAttribute('readonly', true);
      digerFaaliyetInput.setAttribute('readonly', true);
      brutInput.value = '';
      ihracatInput.value = '';
      imalatInput.value = '';
      digerFaaliyetInput.value = '';
      calculateRatios();
    } else {
      brutInput.removeAttribute('readonly');
      ihracatInput.removeAttribute('readonly');
      imalatInput.removeAttribute('readonly');
      digerFaaliyetInput.removeAttribute('readonly');
      calculateRatios();
    }
  }

  function clearProfitTable() {
    Swal.fire({
      title: "Emin misiniz?",
      text: "Tüm ayrıntılı kazanç verilerini silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Evet, sil!",
      cancelButtonText: "İptal"
    }).then((result) => {
      if (result.isConfirmed) {
        const ayrTable = document.getElementById('ayrintili-kazanc-table');
        if (ayrTable) {
          // input değerlerini temizle
          ayrTable.querySelectorAll('tbody input').forEach(input => {
            if (!input.readOnly) {
              isProgrammaticChange = true;
              input.value = '';
              input.setAttribute('data-original-value', '');
              isProgrammaticChange = false;
            }
          });
          // Session Storage'ı temizle
          sessionStorage.removeItem('ayrintili_C54');
          sessionStorage.removeItem('ayrintili_D54');
          sessionStorage.removeItem('ayrintili_E54');

          // Veritabanından temizlemek için AJAX isteği gönder
          // Bu örnekte, Python tarafından özel bir 'temizle' endpoint'i olmadığını varsayıyorum.
          // Eğer Flask'ta bir 'temizle' endpoint'i varsa, onu burada çağırırdık.
          // Şimdilik sadece frontend'i temizledik ve bir mesaj gösterdik.
          showSwalMessage("success", "Temizlendi!", "Ayrıntılı kazanç verileri temizlendi.");
          calculateTable(); // Tabloyu yeniden hesapla ve boş değerleri göster
        }
      }
    });
  }

  // Backend alanlarını form input "name"leriyle eşleştirip doldur
  function fillFormWithParsedData(data) {
    const map = {
      belge_no: 'belge_no',
      karar: 'karar',
      baslama_tarihi: 'belge_tarihi',   // parser 'baslama_tarihi' döndürüyorsa
      belge_tarihi: 'belge_tarihi',     // parser 'belge_tarihi' döndürüyorsa
      yatirim_turu1: 'yatirim_turu1',
      yatirim_turu2: 'yatirim_turu2',
      bolge: 'bolge',

      // oran ve tutarlar
      katki_orani: 'katki_orani',
      vergi_orani: 'vergi_orani',
      ikv_orani: 'diger_oran',
      diger_oran: 'diger_oran',

      toplam_tutar: 'toplam_tutar',
      katki_tutari: 'katki_tutari',
      diger_katki_tutari: 'diger_katki_tutari',
      cari_harcama_tutari: 'cari_harcama_tutari',
      toplam_harcama_tutari: 'toplam_harcama_tutari',
      fiili_katki_tutari: 'fiili_katki_tutari',
      endeks_katki_tutari: 'endeks_katki_tutari',

      onceki_yatirim_katki_tutari: 'onceki_yatirim_katki_tutari',
      onceki_diger_katki_tutari: 'onceki_diger_katki_tutari',
      onceki_katki_tutari: 'onceki_katki_tutari',

      // cari alanlar
      cari_yatirim_katki: 'cari_yatirim_katki',
      cari_diger_katki: 'cari_diger_katki',
      cari_toplam_katki: 'cari_toplam_katki',
      genel_toplam_katki: 'genel_toplam_katki'
    };

    Object.entries(map).forEach(([src, destName]) => {
      const el = document.querySelector(`[name="${destName}"]`);
      if (!el) return;
      const val = data[src];
      el.value = (el.type === 'date')
        ? convertToInputDateFormat(val || '')
        : (val ?? '');
    });

    // Bölge değişince gizli alanı da güncelle (formunla uyumluysa)
    const b = document.getElementById('bolge');
    if (b) {
      b.dispatchEvent(new Event('change'));
      const bh = document.getElementById('bolge_hidden');
      if (bh) bh.value = b.value;
    }

    // İstersen otomatik Aşama 2’ye geç
    if (typeof goToStep2 === 'function') goToStep2();
  }

  async function handleKVUpload(ev) {
    const file = ev.target.files?.[0];
    if (!file) return;

    // aynı dosyayı tekrar seçebilin
    ev.target.value = '';

    const fd = new FormData();
    fd.append('kv_pdf', file);

    // 1) Loading
    Swal.fire({
      title: 'Yükleniyor...',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    let resp;
    try {
      // (opsiyonel) timeout
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), 20000);

      const r = await fetch('{{ url_for("indirimlikurumlar.upload_kv_beyan") }}', {
        method: 'POST',
        body: fd,
        signal: ctrl.signal
      });

      clearTimeout(t);

      const ct = r.headers.get('content-type') || '';
      if (!ct.includes('application/json')) {
        const text = await r.text();
        throw new Error('Beklenmeyen yanıt: ' + ct + ' / ' + text.slice(0, 200));
      }

      resp = await r.json();
    } catch (e) {
      Swal.close();
      Swal.fire('Hata', 'PDF yüklenirken ağ/yanıt hatası oluştu.', 'error');
      return;
    } finally {
      Swal.close();
    }

    console.log('KV upload resp:', resp);

    // 2) Mutlu yollar
    if (resp?.status === 'ok' && resp?.parsed) {
      fillFormWithParsedData(resp.parsed);
      await Swal.fire('Tamam', 'PDF’den bilgiler aktarıldı.', 'success');
      return;
    }

    if (resp.status === 'multiple' && Array.isArray(resp.raw_data) && resp.raw_data.length) {
      // Seçenekleri hazırla
      const inputOptions = {};
      resp.raw_data.forEach((item, i) => {
        const no = (item.belge_no || `Belge ${i + 1}`).toString().trim();
        const karar = item.karar ? ` • ${item.karar}` : '';
        const tarih = item.belge_tarihi ? ` • ${item.belge_tarihi}` : '';
        inputOptions[i] = `${no}${karar}${tarih}`;
      });

      // Kullanıcıya sor
      const { value: idx } = await Swal.fire({
        title: 'Hangi teşvik belgesini içe aktarmak istersiniz?',
        input: 'select',
        inputOptions,
        inputPlaceholder: 'Seçiniz',
        showCancelButton: true,
        confirmButtonText: 'Seç',
        cancelButtonText: 'İptal'
      });

      if (idx !== undefined) {
        fillFormWithParsedData(resp.raw_data[Number(idx)]);
        Swal.fire('Tamam', 'PDF’den bilgiler aktarıldı.', 'success');
      }
      return;
    }


    // 3) Özel: KV sayfası/tablosu bulunamadı senaryosu
    if (
      resp.status === 'not_found' ||     // backend böyle dönüyorsa
      resp.status === 'no_kv' ||     // …veya bu
      resp.status === 'empty' ||     // …veya bu
      (resp.status === 'multiple' && (!resp.raw_data || !resp.raw_data.length || !resp.tablolar || !resp.tablolar.length)) ||
      (resp.status === 'ok' && !resp.parsed)
    ) {
      Swal.fire('Bulunamadı', 'Yüklediğiniz PDF’de “İndirimli Kurumlar” bölümü tespit edilemedi.', 'warning');
      return;
    }

    // 4) Diğer tüm hatalar
    Swal.fire('Hata', resp.message || 'PDF verisi işlenemedi.', 'error');
  }




  // --- 2025/9903 MODU HESAPLAMALARI (TAM VE DENGELİ SÜRÜM) ---

 window.hesaplaKatkiTutari9903Form = function () {
  const karar = document.getElementById("karar")?.value;
  if (karar !== "2025/9903") return;

  const toplamInput = document.getElementById("toplam_tutar");
  const oranInput = document.getElementById("katki_orani");
  const katkiTutariInput = document.getElementById("katki_tutari");
  const donemInput = document.getElementById("donem");
  const baslangicYilInput = document.getElementById("baslangic_yili");

  if (!toplamInput || !oranInput || !katkiTutariInput) return;

  const toplam = parseFormattedNumber(toplamInput.value);
  const oran = parseFormattedNumber(oranInput.value);
  if (isNaN(toplam) || isNaN(oran)) {
    katkiTutariInput.value = "";
    return;
  }

  // 1️⃣ Hesap dönemi verileri
  const donemYil = parseInt((donemInput?.value || "").split(" - ")[0]) || 0;
  const baslangicYil = parseInt(baslangicYilInput?.value || "0");
  const donemFarki = (baslangicYil && donemYil) ? (donemYil - baslangicYil) : 0;

  // 2️⃣ 10 hesap dönemi sınırı (yatırım kazancı)
  if (baslangicYil && donemFarki >= 10) {
    Swal.fire({
      icon: "warning",
      title: "10 Hesap Dönemi Sınırı",
      html: "Yatırımdan elde edilen kazançlarda indirimli kurumlar vergisi uygulanabilecek süre dolmuştur.",
      confirmButtonText: "Tamam"
    });
    document.getElementById('cari_yatirim_katki').value = "0,00";
    return;
  }

  // 3️⃣ Katkı tutarı = yatırım × katkı oranı
  const katkıTutarı = toplam * oran / 100;
  katkiTutariInput.value = katkıTutarı.toLocaleString("tr-TR", { minimumFractionDigits: 2 });

  // 4️⃣ 4 hesap dönemi bilgilendirme (diğer faaliyetler için)
  if (baslangicYil && donemFarki >= 4) {
    Swal.fire({
      icon: "info",
      title: "4 Hesap Dönemi Bilgilendirmesi",
      html: "Diğer faaliyet kazançlarına indirimli kurumlar vergisi uygulama süresi dolmak üzeredir.",
      confirmButtonText: "Tamam"
    });
  }

  // 5️⃣ Ana hesaplama fonksiyonunu çağır (tek adım)
  if (typeof window.hesaplaKatkiTutari9903 === "function") {
    window.hesaplaKatkiTutari9903();
  }

  // 6️⃣ Devredememe kontrolü
  const tevsiKazanc = parseFormattedNumber(document.getElementById('tevsi_yatirim_kazanci')?.value) || 0;
  const cariYatirimKatkisiVal = parseFormattedNumber(document.getElementById('cari_yatirim_katki')?.value) || 0;

  if (tevsiKazanc > 0 && cariYatirimKatkisiVal === 0) {
    Swal.fire({
      icon: "info",
      title: "Kullanılmayan Katkı Devredilemez",
      html: "Kazanç bulunmasına rağmen bu dönemde katkı kullanılmamış. Bu tutar sonraki dönemlere devredilemez.",
      confirmButtonText: "Anladım"
    });
  }
}



  // 🔹 Hak edilen katkı tutarı (gerçekleşen yatırım harcamasına göre)
  window.hesaplaFiiliKatkiTutari9903 = function () {
    const karar = document.getElementById("karar")?.value;
    if (karar !== "2025/9903") return;

    const harcamaInput = document.getElementById("toplam_harcama_tutari");
    const oranInput = document.getElementById("katki_orani");
    const fiiliKatkiTutariInput = document.getElementById("fiili_katki_tutari");

    if (!harcamaInput || !oranInput || !fiiliKatkiTutariInput) return;

    const harcama = parseFormattedNumber(harcamaInput.value);
    const oran = parseFormattedNumber(oranInput.value);

    if (isNaN(harcama) || isNaN(oran)) {
      fiiliKatkiTutariInput.value = "";
      return;
    }

    const sonuc = harcama * oran / 100;
    fiiliKatkiTutariInput.value = sonuc.toLocaleString("tr-TR", { minimumFractionDigits: 2 });
  }


  // 🔸 Diğer faaliyetlerden yararlanılabilecek katkı tutarı
  window.hesaplaDigerKatkiTutari9903 = function () {
    const karar = document.getElementById("karar")?.value;
    if (karar !== "2025/9903") return;

    const donemVal = document.getElementById('donem')?.value || '';
    const donemYil4 = parseInt(donemVal.split(' - ')[0]) || 0;
    const baslangicYil4 = parseInt(document.getElementById('baslangic_yili')?.value || '0');
    const donemFarki4 = (baslangicYil4 && donemYil4) ? (donemYil4 - baslangicYil4) : 0;

    // 1️⃣ 4 hesap dönemi sınırı (diğer faaliyetler)
    if (baslangicYil4 && donemFarki4 >= 4) {
      Swal.fire({
        icon: "warning",
        title: "4 Hesap Dönemi Sınırı",
        html: "Diğer faaliyet kazançlarına indirimli kurumlar vergisi uygulanabilecek dönem sona erdi.",
        confirmButtonText: "Tamam"
      });
      const digerKatkiTutariInput = document.getElementById('diger_katki_tutari');
      if (digerKatkiTutariInput) digerKatkiTutariInput.value = "0,00";
      return;
    }

    const katkiInput = document.getElementById("katki_tutari");
    const digerOranInput = document.getElementById("diger_oran");
    const digerKatkiTutariInput = document.getElementById("diger_katki_tutari");
    const fiiliKatkiTutariInput = document.getElementById("fiili_katki_tutari");

    if (!katkiInput || !digerOranInput || !digerKatkiTutariInput) return;

    const katki = parseFormattedNumber(katkiInput.value);
    const digerOran = parseFormattedNumber(digerOranInput.value);
    const fiiliKatki = parseFormattedNumber(fiiliKatkiTutariInput?.value);

    if (isNaN(katki) || isNaN(digerOran)) {
      digerKatkiTutariInput.value = "";
      return;
    }

    // 2️⃣ Hesaplama
    let sonuc = katki * digerOran / 100;

    // 3️⃣ Çifte tavan kontrolü
    const toplamKatkiTutar = parseFormattedNumber(document.getElementById('katki_tutari')?.value) || 0;
    const hakEdilenKatki = parseFormattedNumber(document.getElementById('fiili_katki_tutari')?.value) || 0;

    // (a) %50 sınırı
    const maxDiger = toplamKatkiTutar * 0.50;
    if (sonuc > maxDiger) {
      sonuc = maxDiger;
      Swal.fire({
        icon: "warning",
        title: "%50 Sınırı",
        html: "Diğer faaliyetlere uygulanacak katkı, toplam katkının %50’sini aşamaz. Değer sınırlandı.",
        confirmButtonText: "Tamam"
      });
    }

    // (b) Hak edilen katkı sınırı
    if (hakEdilenKatki > 0 && sonuc > hakEdilenKatki) {
      sonuc = hakEdilenKatki;
      Swal.fire({
        icon: "warning",
        title: "Hak Edilen Katkı Sınırı",
        html: "Diğer faaliyetlerden kullanılacak katkı, hak edilen katkı tutarını aşamaz. Değer sınırlandı.",
        confirmButtonText: "Anladım"
      });
    }

    // 4️⃣ Sonucu yazdır
    digerKatkiTutariInput.value = sonuc.toLocaleString("tr-TR", { minimumFractionDigits: 2 });
  }






  function hesaplaKatkiTutari() {
    // Eğer karar 2025/9903 ise → özel fonksiyona yönlendir ve çık
    if (document.getElementById("karar")?.value === "2025/9903") {
      hesaplaKatkiTutari9903Form();
      return;
    }
    const toplam = document.getElementById("toplam_tutar");
    const oran = document.getElementById("katki_orani");
    const katkiTutari = document.getElementById("katki_tutari");
    if (toplam && oran && katkiTutari) {
      const parsedToplam = parseFormattedNumber(toplam.value);
      const parsedOran = parseFormattedNumber(oran.value); // ✅
      if (!isNaN(parsedToplam) && !isNaN(parsedOran)) {
        const tutar = parsedToplam * parsedOran / 100;
        katkiTutari.value = tutar.toLocaleString("tr-TR", { minimumFractionDigits: 2 });
        hesaplaDigerKatkiTutari();
      } else {
        katkiTutari.value = "";
      }
    }
  }

  function hesaplaDigerKatkiTutari() {
    // Eğer karar 2025/9903 ise → özel fonksiyona yönlendir ve çık
    if (document.getElementById("karar")?.value === "2025/9903") {
      hesaplaKatkiTutari9903Form();
      return;
    }
    const katkiInput = document.getElementById("katki_tutari");
    const digerOranInput = document.getElementById("diger_oran");
    const digerKatkiTutariInput = document.getElementById("diger_katki_tutari");

    if (katkiInput && digerOranInput && digerKatkiTutariInput) {
      const katki = parseFormattedNumber(katkiInput.value);
      const digerOranText = digerOranInput.value;

      const digerOran = parseFormattedNumber(digerOranText); // ✅ burası kritik
      if (!isNaN(katki) && !isNaN(digerOran)) {
        const sonuc = katki * digerOran / 100;
        digerKatkiTutariInput.value = sonuc.toLocaleString("tr-TR", { minimumFractionDigits: 2 });
      } else {
        digerKatkiTutariInput.value =
          digerOranText.includes("İŞLETME DÖNEMİNDE HESAPLANMAZ") ? "İŞLETME DÖNEMİNDE HESAPLANMAZ" : "";
      }
    }
  }

  function hesaplaFiiliKatkiTutari() {
    // Eğer karar 2025/9903 ise → özel fonksiyona yönlendir ve çık
    if (document.getElementById("karar")?.value === "2025/9903") {
      hesaplaKatkiTutari9903Form();
      return;
    }
    const toplamHarcamaInput = document.getElementById("toplam_harcama_tutari");
    const katkiOraniInput = document.getElementById("katki_orani");
    const fiiliKatkiTutariInput = document.getElementById("fiili_katki_tutari");

    if (toplamHarcamaInput && katkiOraniInput && fiiliKatkiTutariInput) {
      const fiilitoplam = parseFormattedNumber(toplamHarcamaInput.value);
      const oran = parseFormattedNumber(katkiOraniInput.value); // ← önemli
      if (!isNaN(fiilitoplam) && !isNaN(oran)) {
        fiiliKatkiTutariInput.value = (fiilitoplam * oran / 100)
          .toLocaleString("tr-TR", { minimumFractionDigits: 2 });
      } else {
        fiiliKatkiTutariInput.value = "";
      }
    }
  }

  function hesaplaOncekiKatkiTutari() {
    const oncekiYatirimInput = document.getElementById("onceki_yatirim_katki_tutari");
    const oncekiDigerInput = document.getElementById("onceki_diger_katki_tutari");
    const oncekiKatkiInput = document.getElementById("onceki_katki_tutari");
    if (oncekiYatirimInput && oncekiDigerInput && oncekiKatkiInput) {
      const oncekiyatirim = parseFormattedNumber(oncekiYatirimInput.value);
      const oncekidiger = parseFormattedNumber(oncekiDigerInput.value);
      if (!isNaN(oncekiyatirim) && !isNaN(oncekidiger)) {
        const oncekikatki = oncekiyatirim + oncekidiger;
        oncekiKatkiInput.value = oncekikatki.toLocaleString("tr-TR", {
          minimumFractionDigits: 2
        });
      } else {
        oncekiKatkiInput.value = "";
      }
      hesaplaKalanVeEndeks();
    }
  }

  function hesaplaKalanVeEndeks() {
    const toplamKatkiInput = document.getElementById("katki_tutari");
    const oncekiKatkiInput = document.getElementById("onceki_katki_tutari");
    const vizeSelect = document.getElementById("vize_durumu");
    const yenidenDegerlemeOraniInput = document.getElementById("yeniden_degerleme_orani");
    const kalanKatkiInput = document.getElementById("kalan_katki_tutari");
    const endeksKatkiInput = document.getElementById("endeks_katki_tutari");
    if (!toplamKatkiInput || !oncekiKatkiInput || !vizeSelect || !yenidenDegerlemeOraniInput || !kalanKatkiInput || !endeksKatkiInput) {
      return;
    }
    const toplamKatki = parseFormattedNumber(toplamKatkiInput.value);
    const oncekiKatki = parseFormattedNumber(oncekiKatkiInput.value);
    const vize = vizeSelect.value;
    const ydoText = yenidenDegerlemeOraniInput.value;
    const ydo = parseFloat(ydoText.replace(',', '.'));
    const kalan = (!isNaN(toplamKatki) && !isNaN(oncekiKatki)) ? (toplamKatki - oncekiKatki) : 0;
    if (!isNaN(kalan)) {
      kalanKatkiInput.value = kalan.toLocaleString("tr-TR", {
        minimumFractionDigits: 2
      });
    } else {
      kalanKatkiInput.value = "";
    }
    if (vize.includes("Evet")) {
      if (!isNaN(kalan) && !isNaN(ydo)) {
        const endeksli = kalan * ydo / 100;
        endeksKatkiInput.value = endeksli.toLocaleString("tr-TR", {
          minimumFractionDigits: 2
        });
      } else {
        endeksKatkiInput.value = "";
      }
    } else {
      endeksKatkiInput.value = "YATIRIM DÖNEMİNDE OLDUĞUNUZ İÇİN ENDEKSLEME YAPILMAZ";
    }
  }

  function calculateRatios() {
    const useDetailedCheckbox = document.getElementById("useDetailedProfitRatios");
    const useDetailed = useDetailedCheckbox ? useDetailedCheckbox.checked : false;
    const brutInput = document.getElementById("brut_satis");
    const ihracatInput = document.getElementById("ihracat");
    const imalatInput = document.getElementById("imalat");
    const digerFaaliyetInput = document.getElementById("diger_faaliyet");
    const spanIhr = document.getElementById("ratio_ihracat");
    const spanIml = document.getElementById("ratio_imalat");
    const spanDig = document.getElementById("ratio_diger");
    if (!brutInput || !ihracatInput || !imalatInput || !digerFaaliyetInput || !spanIhr || !spanIml || !spanDig) return;
    if (useDetailed) {
      const savedC54 = sessionStorage.getItem('ayrintili_C54');
      const savedD54 = sessionStorage.getItem('ayrintili_D54');
      const savedE54 = sessionStorage.getItem('ayrintili_E54');
      if (savedC54 !== null && savedD54 !== null && savedE54 !== null) {
        spanIhr.textContent = savedC54;
        spanIml.textContent = savedD54;
        spanDig.textContent = savedE54;
      } else {
        spanIhr.textContent = initialRatios.C;
        spanIml.textContent = initialRatios.D;
        spanDig.textContent = initialRatios.E;
      }
    } else {
      const brut = parseFormattedNumber(brutInput.value) || 0;
      const ihracat = parseFormattedNumber(ihracatInput.value) || 0;
      const imalat = parseFormattedNumber(imalatInput.value) || 0;
      const diger = parseFormattedNumber(digerFaaliyetInput.value) || 0;
      let pctIhr = 0,
        pctIml = 0,
        pctDig = 0;
      if (brut > 0) {
        pctIhr = (ihracat / brut) * 100;
        pctIml = (imalat / brut) * 100;
        pctDig = (diger / brut) * 100;
      }
      spanIhr.textContent = brut ? pctIhr.toFixed(2).replace(".", ",") + "%" : "—%";
      spanIml.textContent = brut ? pctIml.toFixed(2).replace(".", ",") + "%" : "—%";
      spanDig.textContent = brut ? pctDig.toFixed(2).replace(".", ",") + "%" : "—%";
    }
    const ayrTable = document.getElementById('ayrintili-kazanc-table');
    if (ayrTable) {
      const updateCell = (rowIndex, col, text) => {
        const selector = `#ayrintili-kazanc-table tbody tr:nth-child(${rowIndex + 1}) input[name="${col}_${rowIndex}"]`;
        const inp = document.querySelector(selector);
        if (inp && inp.readOnly) {
          isProgrammaticChange = true;
          inp.value = text;
          isProgrammaticChange = false;
        }
      };
      updateCell(0, "B", "100%");
      updateCell(0, "C", spanIhr.textContent);
      updateCell(0, "D", spanIml.textContent);
      updateCell(0, "E", spanDig.textContent);
      const b53Input = document.querySelector(`input[name="B_53"]`);
      if (b53Input) {
        const C53 = parseFormattedNumber(document.querySelector(`input[name="C_53"]`).value) || 0;
        const D53 = parseFormattedNumber(document.querySelector(`input[name="D_53"]`).value) || 0;
        const E53 = parseFormattedNumber(document.querySelector(`input[name="E_53"]`).value) || 0;
        const B53 = parseFormattedNumber(b53Input.value) || 0;
        let pct2C = 0,
          pct2D = 0,
          pct2E = 0;
        if (B53 > 0) {
          pct2C = (C53 / B53) * 100;
          pct2D = (D53 / B53) * 100;
          pct2E = (E53 / B53) * 100;
        }
        updateCell(54, "B", "100%");
        updateCell(54, "C", pct2C.toFixed(2).replace(".", ",") + "%");
        updateCell(54, "D", pct2D.toFixed(2).replace(".", ",") + "%");
        updateCell(54, "E", pct2E.toFixed(2).replace(".", ",") + "%");
      }
    }
  }

  function calculateKVMatrah() {
    const t = parseFormattedNumber(document.getElementById('ticari_bilanco_kari')?.value);
    const k = parseFormattedNumber(document.getElementById('kkeg')?.value);
    const out = document.getElementById('kv_matrah');
    if (!out) return;
    const val = (t || 0) + (k || 0);
    out.value = (val || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2 });
  }

  function updateIKVAmountAndRate(ikvMatrah, ihrPct, imlPct, digPct, vergiIndirimOraniFraction) {
    // Güvenli sayılar
    const matrah = Number(ikvMatrah) || 0;
    const pIhr = Number(ihrPct) || 0;   // 0..1
    const pIml = Number(imlPct) || 0;   // 0..1
    const pDig = Number(digPct) || 0;   // 0..1
    const pDisc = Number(vergiIndirimOraniFraction) || 0; // 0..1

    // Matrah kırılımı (Aşama 6’daki satır mantığına uygun)
    const bespuan_matrah = matrah * pIhr; // İhracat
    const birpuan_matrah = matrah * pIml; // İmalat
    const normal_matrah = matrah * pDig; // Diğer + KKEG

    // Genel (indirimsiz) KV oranları
    const rIhrGen = 0.20; // ihracat
    const rImlGen = 0.24; // imalat
    const rDigGen = 0.25; // diğer

    // İndirimli efektif oranlar: r * (1 - indirim)
    const rIhrInd = rIhrGen * (1 - pDisc);
    const rImlInd = rImlGen * (1 - pDisc);
    const rDigInd = rDigGen * (1 - pDisc);

    // Ağırlıklı efektif oran (0..1)
    const effRate = (pIhr * rIhrInd) + (pIml * rImlInd) + (pDig * rDigInd);

    // İndirimli KV (ödenecek vergi)
    const ikvAmount = matrah * effRate;

    // “İndirimli KV olmasaydı” vergi (bilgi satırı için)
    const vergi_olsaydi = (bespuan_matrah * rIhrGen) + (birpuan_matrah * rImlGen) + (normal_matrah * rDigGen);

    // UI yaz
    const ikvEl = document.getElementById('indirimli_kv');
    const ikvRateEl = document.getElementById('indirimli_kv_oran');
    if (ikvEl) ikvEl.value = ikvAmount.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
    if (ikvRateEl) ikvRateEl.value = (effRate * 100).toFixed(2).replace('.', ',') + '%';

    // Eğer step7’de “İndirimli KV Olmasaydı Hesaplanacak Vergi” için bir input eklersen (id: kv_olsaydi),
    // otomatik doldurur. (Yoksa sessizce geçer.)
    const kvOlsaydiEl = document.getElementById('kv_olsaydi');
    if (kvOlsaydiEl) kvOlsaydiEl.value = vergi_olsaydi.toLocaleString('tr-TR', { minimumFractionDigits: 2 });

    // Gerekirse dışarıda kullanman için geri döndür
    return {
      bespuan_matrah,  // ihracat matrahı
      birpuan_matrah,  // imalat matrahı
      normal_matrah,   // diğer matrahı
      vergi_olsaydi,
      effRate,
      ikvAmount
    };
  }


  function hesaplaKatkiTutari9903() {
    console.log("🔹 hesaplaKatkiTutari9903() BAŞLADI");

    const karar = document.getElementById("karar")?.value;
    if (karar !== "2025/9903") return;

    // 1️⃣ Girdi verileri
    const yatirimKazanci = parseFormattedNumber(document.getElementById('tevsi_yatirim_kazanci')?.value) || 0;
    const digerKazanc = parseFormattedNumber(document.getElementById('kv_matrah')?.value) || 0;
    const toplamYatirim = parseFormattedNumber(document.getElementById('toplam_tutar')?.value) || 0;
    const harcamaYatirim = parseFormattedNumber(document.getElementById('toplam_harcama_tutari')?.value) || 0;

    const katkiOrani = parseFormattedNumber(document.getElementById('katki_orani')?.value) / 100 || 0;
    const vergiIndirimOrani = parseFormattedNumber(document.getElementById('vergi_orani')?.value) / 100 || 0;
    const digerOran = parseFormattedNumber(document.getElementById('diger_oran')?.value) / 100 || 0;

    const oncekiToplamKatki = parseFormattedNumber(document.getElementById('onceki_katki_tutari')?.value) || 0;

    // 2️⃣ KV oranları (dinamik)
    const kvOranIhracat = parseFormattedNumber(document.getElementById('kv_oran_ihracat')?.value) / 100 || 0.20;
    const kvOranImalat = parseFormattedNumber(document.getElementById('kv_oran_imalat')?.value) / 100 || 0.24;
    const kvOranDiger = parseFormattedNumber(document.getElementById('kv_oran_diger')?.value) / 100 || 0.25;

    // 3️⃣ Oran kaynağı
    const useDetailedRatios = document.getElementById('useDetailedProfitRatios')?.checked || false;
    let ihracatOraniFinal = 0, imalatOraniFinal = 0, digerOraniFinal = 0;

    if (useDetailedRatios) {
      ihracatOraniFinal = parseFloat(document.getElementById('ratio_ihracat').textContent.replace('%', '').replace(',', '.')) / 100 || 0;
      imalatOraniFinal = parseFloat(document.getElementById('ratio_imalat').textContent.replace('%', '').replace(',', '.')) / 100 || 0;
      digerOraniFinal = parseFloat(document.getElementById('ratio_diger').textContent.replace('%', '').replace(',', '.')) / 100 || 0;
    } else {
      const brutSatis = parseFormattedNumber(document.getElementById('brut_satis')?.value) || 0;
      const ihracatSatis = parseFormattedNumber(document.getElementById('ihracat')?.value) || 0;
      const imalatSatis = parseFormattedNumber(document.getElementById('imalat')?.value) || 0;
      const digerSatis = parseFormattedNumber(document.getElementById('diger_faaliyet')?.value) || 0;

      if (brutSatis > 0) {
        ihracatOraniFinal = ihracatSatis / brutSatis;
        imalatOraniFinal = imalatSatis / brutSatis;
        digerOraniFinal = digerSatis / brutSatis;
      }
    }

    // 4️⃣ Fark oranları (KV - indirimli KV)
    const farkIhr = kvOranIhracat * vergiIndirimOrani;
    const farkIml = kvOranImalat * vergiIndirimOrani;
    const farkDig = kvOranDiger * vergiIndirimOrani;

    // 5️⃣ Katkı tabanları
    const toplamKatki = toplamYatirim * katkiOrani;
    const hakEdilenKatki = harcamaYatirim * katkiOrani;
    const ustSinirDiger = toplamKatki * digerOran;

    // 6️⃣ Cari dönem katkılar (üç senaryo)
    let cariYatirimKatkisi = 0;
    let cariDigerKatkisi = 0;

    if (yatirimKazanci > 0 && digerKazanc === 0) {
      // 🔸 sadece yatırım kazancı (örnek 1 veya yatırım kısmı)
      cariYatirimKatkisi =
        (yatirimKazanci * ihracatOraniFinal * farkIhr) +
        (yatirimKazanci * imalatOraniFinal * farkIml) +
        (yatirimKazanci * digerOraniFinal * farkDig);

    } else if (yatirimKazanci === 0 && digerKazanc > 0) {
      // 🔸 yatırım henüz işletmede değil (örnek 2–3)
      cariDigerKatkisi = Math.min(hakEdilenKatki, ustSinirDiger);

    } else if (yatirimKazanci > 0 && digerKazanc > 0) {
      // 🔸 kısmen işletilen yatırım (örnek 4)
      const yatirimKismi =
        (yatirimKazanci * ihracatOraniFinal * farkIhr) +
        (yatirimKazanci * imalatOraniFinal * farkIml) +
        (yatirimKazanci * digerOraniFinal * farkDig);

      const digerKismi = Math.min(hakEdilenKatki, ustSinirDiger);
      cariYatirimKatkisi = yatirimKismi;
      cariDigerKatkisi = digerKismi;
    }

    // 7️⃣ Toplam katkılar
    const cariToplamKatki = cariYatirimKatkisi + cariDigerKatkisi;
    const genelToplamKatki = oncekiToplamKatki + cariToplamKatki;
    const kalanKatki = Math.max(0, toplamKatki - genelToplamKatki);

    // 8️⃣ UI’ya yaz
    document.getElementById('cari_yatirim_katki').value = cariYatirimKatkisi.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
    document.getElementById('cari_diger_katki').value = cariDigerKatkisi.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
    document.getElementById('cari_toplam_katki').value = cariToplamKatki.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
    document.getElementById('genel_toplam_katki').value = genelToplamKatki.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
    document.getElementById('kalan_katki_tutari').value = kalanKatki.toLocaleString('tr-TR', { minimumFractionDigits: 2 });

    console.log("--- hesaplaKatkiTutari9903() tamamlandı ---", {
      yatirimKazanci,
      digerKazanc,
      cariYatirimKatkisi,
      cariDigerKatkisi,
      genelToplamKatki,
      kalanKatki
    });

    if (typeof _updateStepDisplay === "function") _updateStepDisplay(7);
  }




  function calculateCariAndNext() {
    const karar = document.getElementById("karar")?.value;

    // ✅ Eğer karar 2025/9903 ise iki aşamalı özel hesap fonksiyonlarını çağır
    if (karar === "2025/9903") {
      console.log("⚙️ 2025/9903 aktif — önce form hesapla, sonra detaylı hesap başlatılıyor");

      // 1️⃣ Form tabanlı hesaplama (dönem kontrolü, %50 sınırı, uyarılar vb.)
      if (typeof hesaplaKatkiTutari9903Form === "function") {
        hesaplaKatkiTutari9903Form();
      } else {
        console.warn("⚠️ hesaplaKatkiTutari9903Form() bulunamadı!");
      }

      // 2️⃣ Detaylı hesaplama (oranlar, matrah, Step7 geçişi)
      if (typeof hesaplaKatkiTutari9903 === "function") {
        hesaplaKatkiTutari9903();
      } else {
        console.warn("⚠️ hesaplaKatkiTutari9903() bulunamadı!");
      }

      return; // 🚀 9903 modu tamamen kendi akışını tamamlar, alttaki klasik akışa geçme
    }

    // 🔹 Diğer kararlar (klasik teşvik hesaplama)
    console.log("--- calculateCariAndNext() BAŞLADI ---");

    const vizeDurumuElement = document.getElementById('vize_durumu');
    const vizeDurumuTercihi = vizeDurumuElement ? vizeDurumuElement.value : '';

    const digerKazancUygulama = sessionStorage.getItem('diger_kazanc_uygulama');
    const kucukOlanDigerFaaliyetTutari = parseFormattedNumber(sessionStorage.getItem('kucuk_olan_diger_faaliyet')) || 0;

    console.log("sessionStorage Tercihleri ve HTML Vize Durumu:");
    console.log("  vizeDurumuTercihi:", vizeDurumuTercihi);
    console.log("  digerKazancUygulama:", digerKazancUygulama);
    console.log("  kucukOlanDigerFaaliyetTutari (parsed):", kucukOlanDigerFaaliyetTutari);

    // Doğrudan HTML inputlarından alınan değerler
    const tevsiYatirimKazanci = parseFormattedNumber(document.getElementById('tevsi_yatirim_kazanci').value);
    const vergiIndirimOrani = parseFormattedNumber(document.getElementById('vergi_orani').value) / 100;
    const oncekiToplamKatki = parseFormattedNumber(document.getElementById('onceki_katki_tutari').value);

    console.log("HTML Input Değerleri (parsed):", {
      tevsiYatirimKazanci,
      vergiIndirimOrani,
      oncekiToplamKatki
    });

    // Oranların kaynağı seçimi
    const useDetailedRatiosCheckbox = document.getElementById('useDetailedProfitRatios');
    const useDetailedRatios = useDetailedRatiosCheckbox ? useDetailedRatiosCheckbox.checked : false;
    console.log("useDetailedProfitRatios (Checkbox):", useDetailedRatios);

    let ihracatOraniFinal = 0, imalatOraniFinal = 0, digerOraniFinal = 0;

    if (useDetailedRatios) {
      // span'den oku
      const spanIhr = document.getElementById('ratio_ihracat').textContent;
      const spanIml = document.getElementById('ratio_imalat').textContent;
      const spanDig = document.getElementById('ratio_diger').textContent;

      ihracatOraniFinal = parseFloat(spanIhr.replace('%', '').replace(',', '.')) / 100 || 0;
      imalatOraniFinal = parseFloat(spanIml.replace('%', '').replace(',', '.')) / 100 || 0;
      digerOraniFinal = parseFloat(spanDig.replace('%', '').replace(',', '.')) / 100 || 0;

      console.log("Oran Kaynağı: Ayrıntılı Kazanç Tablosu (span)");
    } else {
      // manuel satış girişleri
      const brutSatis = parseFormattedNumber(document.getElementById('brut_satis').value) || 0;
      const ihracatSatis = parseFormattedNumber(document.getElementById('ihracat').value) || 0;
      const imalatSatis = parseFormattedNumber(document.getElementById('imalat').value) || 0;
      const digerSatis = parseFormattedNumber(document.getElementById('diger_faaliyet').value) || 0;

      if (brutSatis > 0) {
        ihracatOraniFinal = ihracatSatis / brutSatis;
        imalatOraniFinal = imalatSatis / brutSatis;
        digerOraniFinal = digerSatis / brutSatis;
      }
      console.log("Oran Kaynağı: Manuel Satış Girişleri");
    }

    console.log("Nihai Oranlar (Ondalık):", {
      ihracatOraniFinal, imalatOraniFinal, digerOraniFinal
    });

    // Sabit KV oranları
    const kvOranIhracat = 0.20;
    const kvOranImalat = 0.24;
    const kvOranDiger = 0.25;

    let cariYatirimKatkisi = 0;
    let cariDigerKatkisi = 0;
    let indirimliKurumlarVergisiMatrahi = 0;

    // Senaryo seçimleri
    if (vizeDurumuTercihi.includes("Evet")) {
      console.log("Senaryo: Tamamlama Vizesi -> EVET (İşletme Dönemi)");

      indirimliKurumlarVergisiMatrahi = tevsiYatirimKazanci;
      cariYatirimKatkisi =
        (tevsiYatirimKazanci * ihracatOraniFinal * kvOranIhracat * vergiIndirimOrani) +
        (tevsiYatirimKazanci * imalatOraniFinal * kvOranImalat * vergiIndirimOrani) +
        (tevsiYatirimKazanci * digerOraniFinal * kvOranDiger * vergiIndirimOrani);
      cariDigerKatkisi = 0;

    } else if (vizeDurumuTercihi.includes("Hayır")) {
      console.log("Senaryo: Tamamlama Vizesi -> HAYIR (Yatırım Dönemi)");

      if (digerKazancUygulama === "evet") {
        console.log("  Alt Senaryo: Diğer faaliyetlerden indirim -> EVET");

        const kvMatrah = parseFormattedNumber(document.getElementById('kv_matrah')?.value) || 0;
        const kalanKatki = parseFormattedNumber(document.getElementById('kalan_katki_tutari')?.value) || 0;
        const mevzuatTavani = kucukOlanDigerFaaliyetTutari || 0;

        const effRate =
          (ihracatOraniFinal * (0.20 * (1 - vergiIndirimOrani))) +
          (imalatOraniFinal * (0.24 * (1 - vergiIndirimOrani))) +
          (digerOraniFinal * (0.25 * (1 - vergiIndirimOrani)));

        const kvTavanVergi = effRate > 0 ? (kvMatrah * effRate) : 0;
        const cariDigerKatkisiHesap = Math.min(kalanKatki, mevzuatTavani, kvTavanVergi);

        cariDigerKatkisi = Math.max(0, cariDigerKatkisiHesap);
        indirimliKurumlarVergisiMatrahi = (effRate > 0) ? (cariDigerKatkisi / effRate) : 0;
        cariYatirimKatkisi = 0;

      } else {
        console.log("  Alt Senaryo: Diğer faaliyetlerden indirim -> HAYIR");

        indirimliKurumlarVergisiMatrahi = tevsiYatirimKazanci;
        cariYatirimKatkisi =
          (tevsiYatirimKazanci * ihracatOraniFinal * kvOranIhracat * vergiIndirimOrani) +
          (tevsiYatirimKazanci * imalatOraniFinal * kvOranImalat * vergiIndirimOrani) +
          (tevsiYatirimKazanci * digerOraniFinal * kvOranDiger * vergiIndirimOrani);
        cariDigerKatkisi = 0;
      }
    }

    // Hesaplama sonuçları
    console.log("--- Hesaplama Sonuçları ---", {
      cariYatirimKatkisi,
      cariDigerKatkisi,
      indirimliKurumlarVergisiMatrahi
    });

    document.getElementById('cari_yatirim_katki').value = cariYatirimKatkisi.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
    document.getElementById('cari_diger_katki').value = cariDigerKatkisi.toLocaleString('tr-TR', { minimumFractionDigits: 2 });

    const cariToplamKatki = cariYatirimKatkisi + cariDigerKatkisi;
    document.getElementById('cari_toplam_katki').value = cariToplamKatki.toLocaleString('tr-TR', { minimumFractionDigits: 2 });

    const genelToplamKatki = oncekiToplamKatki + cariToplamKatki;
    document.getElementById('genel_toplam_katki').value = genelToplamKatki.toLocaleString('tr-TR', { minimumFractionDigits: 2 });

    document.getElementById('indirimli_matrah').value = indirimliKurumlarVergisiMatrahi.toLocaleString('tr-TR', { minimumFractionDigits: 2 });

    // İndirimli KV tutarı ve efektif oran
    updateIKVAmountAndRate(
      indirimliKurumlarVergisiMatrahi,
      ihracatOraniFinal, imalatOraniFinal, digerOraniFinal,
      vergiIndirimOrani
    );

    console.log("--- calculateCariAndNext() BİTTİ, _updateStepDisplay(7) çağrılıyor ---");
    _updateStepDisplay(7);
  }






  // --- Ayrıntılı Kazanç Tablosu Hesaplaması ---
  function calculateTable(event) {
    const ayrTable = document.getElementById('ayrintili-kazanc-table');
    if (!ayrTable) return;

    const tableData = [];
    ayrTable.querySelectorAll('tbody tr').forEach((rowEl, rowIndex) => {
      const rowVals = {};
      rowEl.querySelectorAll('input').forEach(input => {
        const [col] = input.name.split('_');
        rowVals[col] = parseFormattedNumber(input.value);
      });
      tableData[rowIndex] = rowVals;
    });

    if (event && event.target) {
      const [col, rowStr] = event.target.name.split('_');
      const rowIdx = parseInt(rowStr, 10);
      if ((rowIdx === 20 || rowIdx === 21) && col === 'B') {
        const b = tableData[rowIdx].B;
        const pctC = tableData[0].C / 100;
        const pctD = tableData[0].D / 100;
        const pctE = tableData[0].E / 100;
        ['C', 'D', 'E'].forEach((c, i) => {
          const v = b * [pctC, pctD, pctE][i];
          tableData[rowIdx][c] = v;
          // Programatik atamada sonsuz döngüyü önleyin
          const inp = document.querySelector(`input[name="${c}_${rowIdx}"]`);
          if (inp) {
            isProgrammaticChange = true; // Bayrağı ayarla
            inp.value = v.toLocaleString('tr-TR', {
              minimumFractionDigits: 2
            });
            isProgrammaticChange = false; // Bayrağı sıfırla
          }
        });
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(saveDetailedProfitData, 1500);
        return;
      }
    }

    for (let i = 2; i <= 4; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[1][col] = tableData[2][col] + tableData[3][col] + tableData[4][col];
    });
    const toplamH = tableData[1].B;

    if (toplamH > 0) {
      tableData[0].B = 100;
      ['C', 'D', 'E'].forEach(col => {
        tableData[0][col] = parseFloat(((tableData[1][col] / toplamH) * 100).toFixed(2));
      });
    } else {
      tableData[0] = {
        B: 100,
        C: 0,
        D: 0,
        E: 0
      };
    }

    for (let i = 6; i <= 8; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[5][col] = tableData[6][col] + tableData[7][col] + tableData[8][col];
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[9][col] = tableData[1][col] - tableData[5][col];
    });

    for (let i = 11; i <= 14; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[10][col] =
        tableData[11][col] +
        tableData[12][col] +
        tableData[13][col] +
        tableData[14][col];
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[15][col] = tableData[9][col] - tableData[10][col];
    });

    for (let i = 17; i <= 19; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[16][col] = tableData[17][col] + tableData[18][col] + tableData[19][col];
    });

    [20, 21].forEach(r => {
      const b = tableData[r].B;
      tableData[r].C = b * (tableData[0].C / 100);
      tableData[r].D = b * (tableData[0].D / 100);
      tableData[r].E = b * (tableData[0].E / 100);
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[16][col] =
        tableData[17][col] +
        tableData[18][col] +
        tableData[19][col] +
        tableData[20][col] +
        tableData[21][col];
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[22][col] = tableData[15][col] - tableData[16][col];
    });

    for (let i = 24; i <= 33; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      let sum = 0;
      for (let i = 24; i <= 33; i++) sum += tableData[i][col];
      tableData[23][col] = sum;
    });

    for (let i = 35; i <= 41; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      let sum = 0;
      for (let i = 35; i <= 41; i++) sum += tableData[i][col];
      tableData[34][col] = sum;
    });

    for (let i = 43; i <= 44; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[42][col] = tableData[43][col] + tableData[44][col];
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[45][col] =
        tableData[22][col] +
        tableData[23][col] -
        tableData[34][col] -
        tableData[42][col];
    });

    for (let i = 47; i <= 48; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[46][col] = tableData[47][col] + tableData[48][col];
    });

    for (let i = 50; i <= 52; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[49][col] = tableData[50][col] + tableData[51][col] + tableData[52][col];
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[53][col] =
        tableData[45][col] +
        tableData[46][col] -
        tableData[49][col];
    });

    const B53 = tableData[53].B,
      C53 = tableData[53].C,
      D53 = tableData[53].D,
      E53 = tableData[53].E;
    let pct2C = 0,
      pct2D = 0,
      pct2E = 0;
    if (B53 > 0) {
      pct2C = (C53 / B53) * 100;
      pct2D = (D53 / B53) * 100;
      pct2E = (E53 / B53) * 100;
    }
    tableData[54].B = 100;
    tableData[54].C = parseFloat(pct2C.toFixed(2));
    tableData[54].D = parseFloat(pct2D.toFixed(2));
    tableData[54].E = parseFloat(pct2E.toFixed(2));

    ayrTable.querySelectorAll('tbody tr').forEach((rowEl, idx) => {
      rowEl.querySelectorAll('input').forEach(input => {
        const [col] = input.name.split('_');
        if (input.readOnly) {
          // isProgrammaticChange bayrağını kullanarak sonsuz döngüyü önleyin
          isProgrammaticChange = true;
          let v = tableData[idx][col];
          if (idx === 0 || idx === 54) {
            v = v.toFixed(2).replace('.', ',') + '%';
            if (col === 'B') v = '100%';
          } else {
            v = v.toLocaleString('tr-TR', {
              minimumFractionDigits: 2
            });
          }
          input.value = v; // Değer ataması
          isProgrammaticChange = false; // Bayrağı sıfırla
        }
      });
    });

    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(saveDetailedProfitData, 1500);
  }

  // Tevsi Yatırım Kazancı Otomatik Hesaplama Fonksiyonu
  function calculateTevsiKazancAutomatically() {
    const gerceklesenTevsiElement = document.getElementById('gerceklesen_tevsi_yatirim_tutari');
    const toplamSabitKiymetElement = document.getElementById('toplam_sabit_kiymet_tutari');
    const ticariBilancoKariElement = document.getElementById('ticari_bilanco_kari');
    const tevsiKazancTargetElement = document.getElementById('tevsi_yatirim_kazanci'); // Bu element aslında hesaplanan değeri gösterecek input

    if (!gerceklesenTevsiElement || !toplamSabitKiymetElement || !ticariBilancoKariElement || !tevsiKazancTargetElement) {
      console.error("calculateTevsiKazancAutomatically: Tevsi kazanç hesaplama için gerekli elementler bulunamadı!");
      return;
    }

    const gerceklesenTevsi = parseFormattedNumber(gerceklesenTevsiElement.value);
    const toplamSabitKiymet = parseFormattedNumber(toplamSabitKiymetElement.value);
    const ticariBilancoKari = parseFormattedNumber(ticariBilancoKariElement.value);

    let calculatedKazanc = 0;
    if (toplamSabitKiymet !== 0) {
      calculatedKazanc = (gerceklesenTevsi / toplamSabitKiymet) * ticariBilancoKari;
    } else if (gerceklesenTevsi !== 0 || ticariBilancoKari !== 0) {
      // Eğer toplam sabit kıymet 0 ama diğerleri 0 değilse (tanımsız durumlar için)
      calculatedKazanc = 0;
    }


    if (typeof tevsiMask !== 'undefined' && tevsiMask && tevsiMask.el === tevsiKazancTargetElement) {
      tevsiMask.unmaskedValue = String(calculatedKazanc);
      tevsiMask.updateValue();
    } else {
      tevsiKazancTargetElement.value = calculatedKazanc.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
    }
  }



  // Yardımcı fonksiyonlar: Her bir SweetAlert zincirini ayrı ayrı tanımla
  function askTevsiKazancQuestion() {
    Swal.fire({
      title: 'Tevsi Yatırım Bilgisi',
      html: '<div style="text-align: justify;">Tevsi Yatırımlardan elde edilen kazancı ayrı bir şekilde tespit edebiliyor musunuz?</div>',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Evet',
      cancelButtonText: 'Hayır',
      reverseButtons: true,
      customClass: {
        popup: 'swal2-green-theme-popup',
        header: 'swal2-green-theme-header',
        title: 'swal2-green-theme-title',
        icon: 'swal2-green-theme-icon',
        confirmButton: 'swal2-green-theme-confirm-button',
        cancelButton: 'swal2-green-theme-cancel-button',
        htmlContainer: 'swal2-green-theme-html-container'
      }
    }).then((result) => {
      if (result.isConfirmed) { // Kullanıcı "Evet" dedi (Tevsi kazancını ayrı tespit ediyor)
        Swal.fire({
          title: 'Tevsi Yatırımlardan Elde Edilen Kazanç Tutarını Giriniz (TL)',
          input: 'text',
          inputPlaceholder: '0,00 TL',
          showCancelButton: true,
          confirmButtonText: 'Tamam',
          cancelButtonText: 'Vazgeç',
          reverseButtons: true,
          customClass: {
            popup: 'swal2-green-theme-popup',
            header: 'swal2-green-theme-header',
            title: 'swal2-green-theme-title',
            icon: 'swal2-green-theme-icon',
            confirmButton: 'swal2-green-theme-confirm-button',
            cancelButton: 'swal2-green-theme-cancel-button',
            htmlContainer: 'swal2-green-theme-html-container'
          },
          inputValidator: (value) => {
            if (!value) {
              return 'Bir tutar girmelisiniz!';
            }
            if (isNaN(parseFormattedNumber(value))) {
              return 'Geçerli bir sayı girmelisiniz!';
            }
            return null;
          }
        }).then((inputResult) => {
          if (inputResult.isConfirmed && inputResult.value) {
            const enteredAmount = parseFormattedNumber(inputResult.value);
            document.getElementById('tevsi_yatirim_kazanci').value = enteredAmount.toLocaleString('tr-TR', {
              minimumFractionDigits: 2
            });
            // Bu durumda otomatik tevsi kazanç hesaplamasını kapatmak için alanları temizle
            document.getElementById('gerceklesen_tevsi_yatirim_tutari').value = '';
            document.getElementById('toplam_sabit_kiymet_tutari').value = '';
            document.getElementById('ticari_bilanco_kari').value = '';
          } else if (inputResult.dismiss === Swal.DismissReason.cancel) {
            document.getElementById('tevsi_yatirim_kazanci').value = ''; // İptal edilirse temizle
          }
          _updateStepDisplay(5); // Tevsi Yatırım aşamasına geç (manuel giriş ile)
        });
      } else if (result.dismiss === Swal.DismissReason.cancel) { // Kullanıcı "Hayır" dedi (Tevsi kazancını ayrı tespit edemiyor)
        Swal.fire({
          title: 'Bilgilendirme',
          html: '<div style="text-align: justify;">Gerçekleşen Tevsi Yatırım Tutarını, Toplam Sabit Kıymet Tutarını ve Ticari Bilanço Karını Girmeyi unutmayınız.</div>',
          icon: 'info',
          showConfirmButton: true,
          confirmButtonText: 'Tamam',
          showCancelButton: false,
          customClass: {
            popup: 'swal2-green-theme-popup',
            header: 'swal2-green-theme-header',
            title: 'swal2-green-theme-title',
            icon: 'swal2-green-theme-icon',
            confirmButton: 'swal2-green-theme-confirm-button',
            htmlContainer: 'swal2-green-theme-html-container'
          }
        }).then(() => {
          document.getElementById('tevsi_yatirim_kazanci').value = ''; // Otomatik hesaplama için alanı temizle
          _updateStepDisplay(5); // Tevsi Yatırım aşamasına geç (otomatik hesaplama ile)
        });
      }
    });
  }

  function askOtherActivitiesDiscountQuestion() {
    Swal.fire({
      title: 'Diğer Faaliyetler',
      html: '<div style="text-align: justify;">Diğer faaliyetlerden elde ettiğiniz kazançlarınıza indirimli kurumlar vergisi uygulamak istiyor musunuz?</div>',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Evet, istiyorum.',
      cancelButtonText: 'Hayır, istemiyorum.',
      reverseButtons: true,
      customClass: {
        popup: 'swal2-green-theme-popup',
        header: 'swal2-green-theme-header',
        title: 'swal2-green-theme-title',
        icon: 'swal2-green-theme-icon',
        confirmButton: 'swal2-green-theme-confirm-button',
        cancelButton: 'swal2-green-theme-cancel-button',
        htmlContainer: 'swal2-green-theme-html-container'
      }
    }).then((result) => {
      if (result.isConfirmed) {
        // “Evet” dedi
        sessionStorage.setItem('diger_kazanc_uygulama', 'evet');
        askSmallestAmountQuestionForOtherActivities();
      } else {
        // “Hayır” veya iptal
        sessionStorage.setItem('diger_kazanc_uygulama', 'hayir');
        // Önceki kısıtlı değeri temizle (isteğe bağlı)
        sessionStorage.removeItem('kucuk_olan_diger_faaliyet');
        askTevsiKazancQuestion();
      }
    });
  }

  function askSmallestAmountQuestionForOtherActivities() {
    // Gerekli değerleri DOM'dan veya mevcut hesaplamalardan alalım
    const digerKatkiTutariElement = document.getElementById('diger_katki_tutari');
    const toplamHarcamaTutariElement = document.getElementById('toplam_harcama_tutari');

    // Elementlerin varlığını kontrol et, yoksa varsayılan değer kullan
    const digerKatkiTutari = digerKatkiTutariElement ? parseFormattedNumber(digerKatkiTutariElement.value) : 0;
    const toplamHarcamaTutari = toplamHarcamaTutariElement ? parseFormattedNumber(toplamHarcamaTutariElement.value) : 0;

    let kucukOlanDeger;

    // Küçük olan değeri bulma mantığı
    if (digerKatkiTutari === 0 && toplamHarcamaTutari === 0) {
      kucukOlanDeger = 0; // Her iki değer de sıfırsa küçük olan da sıfırdır.
    } else if (digerKatkiTutari === 0) {
      kucukOlanDeger = toplamHarcamaTutari; // Diğer katkı sıfırsa, toplam harcama küçüktür.
    } else if (toplamHarcamaTutari === 0) {
      kucukOlanDeger = digerKatkiTutari; // Toplam harcama sıfırsa, diğer katkı küçüktür.
    } else {
      kucukOlanDeger = Math.min(digerKatkiTutari, toplamHarcamaTutari); // İki değerden küçük olanı seç.
    }

    // Hesaplanan küçük değeri sessionStorage'a kaydet
    sessionStorage.setItem('kucuk_olan_diger_faaliyet', kucukOlanDeger);

    // Diğer faaliyetlere indirim uygulanacaksa tevsi yatırım alanlarını sıfırla
    // Bu, önceki SweetAlert zincirinde de yapılıyordu, burada tekrar edilmesi garanti sağlar.
    document.getElementById('gerceklesen_tevsi_yatirim_tutari').value = '';
    document.getElementById('toplam_sabit_kiymet_tutari').value = '';
    document.getElementById('ticari_bilanco_kari').value = '';
    document.getElementById('tevsi_yatirim_kazanci').value = '';

    // Kullanıcıya SweetAlert ile bilgilendirme mesajı göster
    Swal.fire({
      title: 'Otomatik Hesaplama Yapıldı!',
      html: `<div style="text-align: justify;">Diğer faaliyetlerinizden elde ettiğiz kazançlarınıza uygulanabilecek maksimum indirimli kurumlar vergisi tutarı:<br><br><b>${kucukOlanDeger.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} TL</b></div>`,
      icon: 'info', // Bilgilendirme ikonu kullan
      showConfirmButton: true, // "Tamam" butonu göster
      confirmButtonText: 'Tamam',
      customClass: {
        popup: 'swal2-green-theme-popup',
        header: 'swal2-green-theme-header',
        title: 'swal2-green-theme-title',
        icon: 'swal2-green-theme-icon',
        confirmButton: 'swal2-green-theme-confirm-button',
        htmlContainer: 'swal2-green-theme-html-container'
      }
    }).then(() => {
      // 6’ya geçmeden önce Ticari Kâr + KKEG’yi iste
      if (typeof promptTicariKariVeKKEGThenGoTo6 === 'function') {
        promptTicariKariVeKKEGThenGoTo6();
      } else {
        _updateStepDisplay(6); // güvenlik için
      }
    });
  }

  async function promptTicariKariVeKKEGThenGoTo6() {
    const formatTL = (n) => (n || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2 });

    const { value: vals, isConfirmed } = await Swal.fire({
      title: 'Cari Dönem Verileri',
      html: `
      <div style="text-align:left">
        <!-- Alan 1: Ticari Bilanço Kârı -->
        <div style="display:flex; flex-direction:column; gap:6px; margin:0 0 14px 0;">
          <label style="font-size:13px; color:#555; display:block;">Ticari Bilanço Kârı (TL)</label>
          <input id="swal_ticari" class="swal2-input" placeholder="0,00 TL" inputmode="decimal" style="margin:0; width:100%;">
        </div>

        <!-- Alan 2: KKEG -->
        <div style="display:flex; flex-direction:column; gap:6px; margin:0 0 14px 0;">
          <label style="font-size:13px; color:#555; display:block;">KKEG (TL)</label>
          <input id="swal_kkeg" class="swal2-input" placeholder="0,00 TL" inputmode="decimal" style="margin:0; width:100%;">
        </div>
      </div>

      <!-- Matrah kutusu -->
      <div style="margin-top:6px; padding:14px; background:#f6faf6; border:1px solid #d5ead5; border-radius:10px;">
        <div style="font-weight:700; font-size:14px; margin-bottom:6px;">Kurumlar Vergisi Matrahı</div>
        <div style="font-size:13px; color:#444; margin-bottom:8px;">
          Matrah = <b>Ticari Bilanço Kârı</b> + <b>KKEG</b>
        </div>
        <input id="swal_matrah" class="swal2-input" placeholder="0,00 TL" readonly
               style="margin:0; background:#f0f0f0; width:100%;">
      </div>
    `,
      focusConfirm: false,
      showCancelButton: false,
      allowOutsideClick: false,
      allowEscapeKey: false,
      confirmButtonText: 'Kaydet ve devam et',
      customClass: {
        popup: 'swal2-green-theme-popup',
        header: 'swal2-green-theme-header',
        title: 'swal2-green-theme-title',
        icon: 'swal2-green-theme-icon',
        confirmButton: 'swal2-green-theme-confirm-button',
        htmlContainer: 'swal2-green-theme-html-container'
      },
      didOpen: () => {
        const tEl = document.getElementById('swal_ticari');
        const kEl = document.getElementById('swal_kkeg');
        const mEl = document.getElementById('swal_matrah');

        const update = () => {
          const t = parseFormattedNumber(tEl.value);
          const k = parseFormattedNumber(kEl.value);
          const sum = (t || 0) + (k || 0);
          mEl.value = formatTL(sum);
        };

        tEl.addEventListener('input', update);
        kEl.addEventListener('input', update);
        update();
      },
      preConfirm: () => {
        const t = parseFormattedNumber(document.getElementById('swal_ticari').value);
        const k = parseFormattedNumber(document.getElementById('swal_kkeg').value);
        if (isNaN(t) || isNaN(k)) {
          Swal.showValidationMessage('Lütfen geçerli sayılar girin.');
          return false;
        }
        return { t, k, m: (t || 0) + (k || 0) };
      }
    });

    if (isConfirmed && vals) {
      const tOut = document.getElementById('ticari_bilanco_kari');
      const kOut = document.getElementById('kkeg');
      const mOut = document.getElementById('kv_matrah');

      if (tOut) tOut.value = formatTL(vals.t);
      if (kOut) kOut.value = formatTL(vals.k);
      if (mOut) mOut.value = formatTL(vals.m);

      if (typeof calculateKVMatrah === 'function') calculateKVMatrah();
    }

    _updateStepDisplay(6);
  }



  function goToStep1() { _updateStepDisplay(1); }

  function goToStep2() {
    // 🔹 Alanları al
    const karar = document.getElementById("karar")?.value.trim();
    const programTuru = document.getElementById("program_turu")?.value.trim();
    const vizeDurumu = document.getElementById("vize_durumu")?.value.trim();

    // 🔹 Genel zorunlu kontroller
    if (!karar) {
      Swal.fire({
        icon: "warning",
        title: "Eksik Bilgi",
        text: "Lütfen 'Teşvik Belgesi Hangi Karara Göre Düzenlendi' alanını seçiniz.",
        confirmButtonText: "Tamam"
      });
      return;
    }

    if (!vizeDurumu) {
      Swal.fire({
        icon: "warning",
        title: "Eksik Bilgi",
        text: "Lütfen 'Tamamlama Vizesi Yapıldı mı?' alanını seçiniz.",
        confirmButtonText: "Tamam"
      });
      return;
    }

    // 🔹 2025/9903 için ek zorunluluk
    if (karar === "2025/9903" && !programTuru) {
      Swal.fire({
        icon: "warning",
        title: "Eksik Bilgi",
        text: "Bu karar için 'Program Türü' seçimi zorunludur.",
        confirmButtonText: "Tamam"
      });
      return;
    }

    // 🔹 Her şey tamamsa bir sonraki adıma geç
    _updateStepDisplay(2);
  }

  function goToStep3() { _updateStepDisplay(3); }

  function goToStep4() { _updateStepDisplay(4); }

  function goToStep5(source) {
    if (source === 'from6') {
      _updateStepDisplay(5);
      return;
    }

    setTimeout(() => {
      const karar = (document.getElementById('karar')?.value || "").trim();
      const vizeDurumu = (document.getElementById('vize_durumu')?.value || "").trim().toLowerCase();

      // 🔹 2025/9903 özel kuralı:
      if (karar === "2025/9903") {
        console.log("✅ 2025/9903 kararı: sorular zorunlu olarak gösteriliyor.");
        askTevsiKazancQuestion();
        askOtherActivitiesDiscountQuestion();
        return;
      }

      // 🔹 Diğer kararlar için mevcut mantık:
      sessionStorage.removeItem('kucuk_olan_diger_faaliyet');

      if (vizeDurumu.includes("evet")) {
        askTevsiKazancQuestion();
      } else if (vizeDurumu.includes("hayır") || vizeDurumu.includes("hayir")) {
        askOtherActivitiesDiscountQuestion();
      } else {
        _updateStepDisplay(5);
      }
    }, 100);
  }


  function goToStep6() { _updateStepDisplay(6); }

  function goToStep7() { _updateStepDisplay(7); }



  const currentBelgeJSData = {{ current_belge | tojson | safe
  }};

  document.addEventListener("DOMContentLoaded", function () {

    // === 2025/9903 Kararı için özel davranışlar ===
    const kararSelect = document.getElementById("karar");
    const ilSelect = document.getElementById("il");
    const programSelect = document.getElementById("program_turu");
    const bolgeInput = document.getElementById("bolge");
    const katkiInput = document.getElementById("katki_orani");
    const vergiInput = document.getElementById("vergi_orani");
    const digerInput = document.getElementById("diger_oran");
    const tur1 = document.getElementById("yatirim_turu1");
    const tur2 = document.getElementById("yatirim_turu2");

    const form = document.getElementById('form-giris');

    // Form-Giriş submit (AJAX)
    if (form) {
      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(form);

        // Hesap alanları da gönderilsin
        formData.append('cari_yatirim_katki', document.getElementById('cari_yatirim_katki')?.value ?? '');
        formData.append('cari_diger_katki', document.getElementById('cari_diger_katki')?.value ?? '');
        formData.append('cari_toplam_katki', document.getElementById('cari_toplam_katki')?.value ?? '');
        formData.append('genel_toplam_katki', document.getElementById('genel_toplam_katki')?.value ?? '');

        // Hangi butonla geldi?
        const submitter = event.submitter;
        let actionType = '';
        if (submitter && submitter.name === 'submit_action') actionType = submitter.value;

        if (actionType === 'new_save') {
          formData.set('tesvik_id', '');
        }

        try {
          const response = await fetch(form.action, { method: 'POST', body: formData });
          const data = await response.json();

          let finalTitle = data.title;
          let finalMessage = data.message;
          let swalIcon = data.status;

          if (data.status === 'success') {
            if (actionType === 'new_save') {
              finalTitle = 'Yeni Belge Kaydı';
              finalMessage = 'Yeni teşvik belgesi başarıyla oluşturuldu.';
              Swal.fire({
                icon: swalIcon,
                title: finalTitle,
                text: finalMessage,
                timer: 3000,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                didClose: () => {
                  window.location.href = "{{ url_for('indirimlikurumlar.index') }}?sekme=form";
                }
              });
              return;
            } else if (actionType === 'update') {
              finalTitle = 'Belge Güncelleme';
              finalMessage = 'Teşvik belgesi başarıyla güncellendi.';
            }
          } else {
            finalTitle = data.title || 'Hata!';
            finalMessage = data.message || 'Bir sorun oluştu.';
          }

          showSwalMessage(swalIcon, finalTitle, finalMessage);
        } catch (err) {
          console.error('Form kaydetme hatası:', err);
          showSwalMessage('error', 'Hata!', 'Veri gönderilirken bir ağ/sunucu hatası oluştu.');
        }
      });
    }


    function blinkAllInfoIcons(attempt = 0) {
      const icons = document.querySelectorAll('.info-icon-styled');
      if (icons.length > 0) {
        // bulunduysa tüm ikonlara 7 kez parlama efekti
        setTimeout(() => {
          icons.forEach(icon => icon.classList.add('blink'));
          setTimeout(() => {
            icons.forEach(icon => icon.classList.remove('blink'));
          }, 7500); // animasyon süresi (7 x 1s)
        }, 800);
      } else if (attempt < 10) {
        // henüz yüklenmediyse tekrar dene (her 300 ms)
        setTimeout(() => blinkAllInfoIcons(attempt + 1), 300);
      }
    }

    // Sayfa yüklenince otomatik başlat
    blinkAllInfoIcons();


    const useDetailedCheckbox = document.getElementById('useDetailedProfitRatios');
    if (useDetailedCheckbox) {
      const savedState = sessionStorage.getItem('use_detailed_profit_ratios') === 'true';
      useDetailedCheckbox.checked = savedState;
      toggleDetailedProfitInput();
      useDetailedCheckbox.addEventListener('change', function () {
        sessionStorage.setItem('use_detailed_profit_ratios', this.checked);
        toggleDetailedProfitInput();
      });
    }

    // 2) Tüm adımları gizle
    ALL_STEPS_IDS.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.add("hidden-step");
    });

    // 3) URL hash varsa ilgili adıma geç
    const hash = window.location.hash;
    if (hash.startsWith("#step")) {
      const stepNum = hash.replace("#step", "");
      const fn = window["goToStep" + stepNum];
      if (typeof fn === "function") {
        fn();
        document.getElementById("step" + stepNum)?.scrollIntoView({
          behavior: "smooth"
        });
      } else {
        _updateStepDisplay(1); // URL hash'i yoksa veya geçersizse Aşama 1'i göster
      }
    } else {
      goToStep1();
    }

    // 4) Diğer init işlemleri
    const clearButton = document.getElementById('clearProfitData');
    if (clearButton) clearButton.addEventListener('click', clearProfitTable);

    const ayrTable = document.getElementById('ayrintili-kazanc-table');
    if (ayrTable) {
      ayrTable.querySelectorAll('tbody input').forEach(input => {
        input.setAttribute('data-original-value', input.value);
        input.addEventListener('input', event => {
          if (!isProgrammaticChange) calculateTable(event);
        });
      });
      calculateTable();
    }

    const calculateBtn = document.getElementById('calculateCariBtn');
    if (calculateBtn) {
      calculateBtn.addEventListener('click', () => {
        calculateRatios();
        calculateKVMatrah();

        const karar = document.getElementById("karar")?.value;
        if (karar === "2025/9903") {
          console.log("⚙️ 2025/9903 aktif — form ve detaylı hesap başlatılıyor");

          // 1️⃣ Form hesaplama (kontroller + uyarılar)
          if (typeof hesaplaKatkiTutari9903Form === "function") hesaplaKatkiTutari9903Form();

          // 2️⃣ Detaylı hesaplama (oranlar, matrah, Step7 geçişi)
          if (typeof hesaplaKatkiTutari9903 === "function") hesaplaKatkiTutari9903();

        } else {
          calculateCariAndNext();
        }
      });
    }


    const tevsiInput = document.getElementById("tevsi_yatirim_kazanci");
    tevsiMask = IMask(tevsiInput, {
      mask: Number,
      scale: 2,
      thousandsSeparator: '.',
      radix: ',',
      mapToRadix: [','],
      normalizeZeros: false,
      padFractionalZeros: false
    });

    [
      "gerceklesen_tevsi_yatirim_tutari",
      "toplam_sabit_kiymet_tutari",
      "ticari_bilanco_kari"
    ].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener("input", calculateTevsiKazancAutomatically);
    });





    const idConfig = {
      "toplam_tutar": "katki",
      "cari_harcama_tutari": "katki",
      "toplam_harcama_tutari": "katki",
      "onceki_yatirim_katki_tutari": "katki",
      "onceki_diger_katki_tutari": "katki",
      "brut_satis": "ratios",
      "ihracat": "ratios",
      "imalat": "ratios",
      "diger_faaliyet": "ratios",
      "gerceklesen_tevsi_yatirim_tutari": "tevsi",
      "toplam_sabit_kiymet_tutari": "tevsi",
      "ticari_bilanco_kari": "tevsi",
      "kkeg": "tevsi",
      "tevsi_yatirim_kazanci": "tevsiOutput"
    };

    ["ticari_bilanco_kari", "kkeg"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener("input", calculateKVMatrah);
    });

    calculateKVMatrah();

    const toplamTutarEl = document.getElementById('toplam_tutar');
    if (toplamTutarEl) {
      toplamTutarEl.addEventListener('input', () => {
        const karar = document.getElementById("karar")?.value;
        if (karar === "2025/9903") {
          hesaplaKatkiTutari9903Form(); // sadece form seviyesi (daha hızlı tepki)
        } else {
          hesaplaKatkiTutari();
          hesaplaDigerKatkiTutari();
          hesaplaFiiliKatkiTutari();
        }
      });
    }

    // oranlar değişirse bağlı alanları tazele
    ['katki_orani', 'diger_oran'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', () => {
        const karar = document.getElementById("karar")?.value;
        if (karar === "2025/9903") {
          hesaplaKatkiTutari9903Form(); // hızlı uyarı ve anlık hesap
        } else {
          hesaplaKatkiTutari();
          hesaplaDigerKatkiTutari();
          hesaplaFiiliKatkiTutari();
        }
      });
    });


    const maskMap = {};

    Object.keys(idConfig).forEach(id => {
      const field = document.getElementById(id);
      if (!field) return;
      // Mask’i oluştur ve sakla
      const mask = IMask(field, {
        mask: Number, scale: 2, thousandsSeparator: '.', radix: ',',
        mapToRadix: [','], normalizeZeros: false, padFractionalZeros: false
      });
      maskMap[id] = mask;


      mask.on("accept", () => {
        const karar = document.getElementById("karar")?.value;
        const type = idConfig[id];

        if (type === "katki") {
          if (karar === "2025/9903") {
            hesaplaKatkiTutari9903Form(); // sadece form seviyesi
          } else {
            hesaplaKatkiTutari();
          }
          hesaplaDigerKatkiTutari();
          hesaplaFiiliKatkiTutari();
          hesaplaOncekiKatkiTutari();
          hesaplaKalanVeEndeks();
        } else if (type === "ratios") {
          calculateRatios();
        } else if (type === "tevsi") {
          calculateTevsiKazancAutomatically();
        }
      });

    });

    function getIndirimSure(karar, belgeTarihi) {
      if (karar === "2025/9903") {
        const tarih = new Date(belgeTarihi);
        const limitDate = new Date("2025-07-24");
        const eskiBasvuruDate = new Date("2025-06-16");
        if (tarih >= limitDate) {
          return 10; // 10 hesap dönemi sınırlı
        } else if (tarih < eskiBasvuruDate) {
          return "Sınırsız"; // Eski belge, sınırsız hak
        }
      }
      return "Eski sistem"; // Diğer kararlar için
    }

    // Karar değiştiğinde özel mod ayarları
    window.handleKarar9903 = function () {
      const karar = kararSelect?.value;

      if (!kararSelect || !programSelect) {
        console.warn("⚠️ kararSelect veya programSelect bulunamadı!");
        return;
      }

      if (karar === "2025/9903") {
        console.log("→ 2025/9903 modu aktif!");

        // Program aktif, yatırım türleri pasif
        programSelect.removeAttribute("disabled"); // <-- daha garantili yöntem
        programSelect.disabled = false;            // <-- yedek
        programSelect.classList.remove("bg-light"); // görünümü temizle

        tur1.disabled = true;
        tur2.disabled = true;
        tur1.value = "";
        tur2.value = "";
        tur1.classList.add("bg-light");
        tur2.classList.add("bg-light");

        // Sabit oranlar
        vergiInput.value = 60;
        digerInput.value = 50;

        // Bölgeyi 9903 haritasından al
        const il = ilSelect.value;
        if (il && bolgeMap9903[il]) {
          bolgeInput.value = bolgeMap9903[il];
        }

        // Katkı oranı da program seçilince güncellensin
        const program = programSelect.value;
        if (program && katkilar9903[program]) {
          katkiInput.value = katkilar9903[program];
        }

      } else {
        console.log("→ Normal teşvik modu aktif");

        programSelect.setAttribute("disabled", "disabled"); // kapat
        programSelect.classList.add("bg-light");
        tur1.disabled = false;
        tur2.disabled = false;
        tur1.classList.remove("bg-light");
        tur2.classList.remove("bg-light");

        vergiInput.value = "";
        digerInput.value = "";
        katkiInput.value = "";

        setBolge();
        setOranlar();
      }
    }

    if (kararSelect) {
      kararSelect.addEventListener("change", handleKarar9903);
      handleKarar9903(); // sayfa yüklenirken kontrol et
    }

    // İl değiştiğinde bölgeyi güncelle
    ilSelect.addEventListener("change", () => {
      const karar = kararSelect.value;
      const il = ilSelect.value;
      if (karar === "2025/9903") {
        bolgeInput.value = bolgeMap9903[il] || "";
      } else {
        setBolge();
      }
    });

    // Program değiştiğinde katkı oranını güncelle
    programSelect.addEventListener("change", () => {
      const karar = kararSelect.value;
      const program = programSelect.value;
      if (karar === "2025/9903") {
        katkiInput.value = katkilar9903[program] || 0;
      } else {
        setOranlar();
      }
    });

    // Karar değişikliğini dinle
    kararSelect.addEventListener("change", handleKarar9903);

    // Sayfa yüklenince de kontrol et
    handleKarar9903();
  });




  // Mevcut belge verisini forma bas (isteğe bağlı kısa yardımcılar)
  const setVal = (sel, v) => { const el = document.querySelector(sel); if (el) el.value = v ?? ''; };
  const fmt = n => (n || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2 });

  // Form sekmesi linki: PDF'den içe aktarmayı sor
  const indirimLink = document.querySelector('a.nav-link[href*="sekme=form"]');
  if (indirimLink) {
    indirimLink.addEventListener('click', (e) => {
      e.preventDefault();
      Swal.fire({
        title: 'PDF’den içe aktarılsın mı?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Evet',
        cancelButtonText: 'Hayır'
      }).then(res => {
        if (res.isConfirmed) {
          document.getElementById('kvUploadInput')?.click();
        } else {
          window.location.href = '{{ url_for("indirimlikurumlar.index") }}?sekme=form#step1';
        }
      });
    });
  }

  // Gizli file input → PDF parser
  const kvInput = document.getElementById('kvUploadInput');
  if (kvInput) kvInput.addEventListener('change', handleKVUpload);

  // currentBelge varsa forma doldur
  if (currentBelgeJSData && window.location.search.includes('sekme=form')) {
    // Step 1
    setVal('input[name="belge_tarihi"]', currentBelgeJSData.belge_tarihi);
    setVal('select[name="karar"]', currentBelgeJSData.karar);
    setVal('select[name="yatirim_turu1"]', currentBelgeJSData.yatirim_turu1);
    setVal('select[name="yatirim_turu2"]', currentBelgeJSData.yatirim_turu2);
    setVal('input[name="belge_no"]', currentBelgeJSData.belge_no);
    setVal('select[name="vize_durumu"]', currentBelgeJSData.vize_durumu);

    // Step 2 (otomatik oranlar için tetikleyelim)
    setVal('select[name="donem"]', currentBelgeJSData.donem);
    setVal('select[name="il"]', currentBelgeJSData.il);
    setVal('select[name="osb"]', currentBelgeJSData.osb);
    setBolge();
    setOranlar();

    // Step 3
    const s3 = id => document.getElementById(id);
    if (s3('toplam_tutar')) s3('toplam_tutar').value = fmt(currentBelgeJSData.toplam_tutar);
    if (s3('cari_harcama_tutari')) s3('cari_harcama_tutari').value = fmt(currentBelgeJSData.cari_harcama_tutari);
    if (s3('toplam_harcama_tutari')) s3('toplam_harcama_tutari').value = fmt(currentBelgeJSData.toplam_harcama_tutari);

    // Step 4
    if (s3('onceki_yatirim_katki_tutari')) s3('onceki_yatirim_katki_tutari').value = fmt(currentBelgeJSData.onceki_yatirim_katki_tutari);
    if (s3('onceki_diger_katki_tutari')) s3('onceki_diger_katki_tutari').value = fmt(currentBelgeJSData.onceki_diger_katki_tutari);

    // Step 6 (satış/dağılım)
    const chk = document.getElementById('useDetailedProfitRatios');
    if (chk) chk.checked = !!currentBelgeJSData.use_detailed_profit_ratios;
    ['brut_satis', 'ihracat', 'imalat', 'diger_faaliyet'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = fmt(currentBelgeJSData[id]);
    });
    toggleDetailedProfitInput();
  }

  // Ayrıntılı Kazanç Formu (AJAX)
  const ayrintiliKazancForm = document.getElementById('ayrintili-kazanc-form');
  if (ayrintiliKazancForm) {
    ayrintiliKazancForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(ayrintiliKazancForm);
      formData.append('save', '1');

      try {
        const response = await fetch(ayrintiliKazancForm.action, { method: 'POST', body: formData });
        const contentType = response.headers.get("content-type");
        if (response.ok && contentType && contentType.includes("application/json")) {
          const data = await response.json();
          showSwalMessage(data.status, data.title, data.message);
        } else {
          const errorText = await response.text();
          console.error('Ayrıntılı kazanç kaydetme yanıtı:', errorText);
          showSwalMessage('error', 'Hata!', `Kaydetme sırasında sunucu sorunu: ${response.status} ${response.statusText}`);
        }
      } catch (err) {
        console.error('Ayrıntılı kazanç kaydetme hatası:', err);
        showSwalMessage('error', 'Hata!', 'Veri gönderilirken bir ağ/istemci hatası oluştu.');
      }
    });
  }

  // MANUEL BELİRLE: Yatırıma Katkı Oranı
  document.getElementById('btn-manual-katki')?.addEventListener('click', async () => {
    const { value: val } = await Swal.fire({
      title: 'Yatırıma Katkı Oranını giriniz (%)',
      input: 'text',
      inputPlaceholder: 'örn: 40',
      showCancelButton: true,
      confirmButtonText: 'Tamam',
      cancelButtonText: 'Vazgeç',
      inputValidator: (v) => {
        const n = parseFormattedNumber(v);
        if (isNaN(n) || n < 0 || n > 100) return '0-100 arasında bir yüzde girin';
        return null;
      }
    });
    if (val !== undefined) {
      const n = parseFormattedNumber(val);
      document.getElementById('katki_orani').value = n.toString().replace('.', ',');
      sessionStorage.setItem('manual_katki', 'true');
      sessionStorage.setItem('manual_katki_value', String(n));
      // aşağıdakiler mevcut hesaplara dokunsun
      hesaplaKatkiTutari(); hesaplaDigerKatkiTutari(); hesaplaFiiliKatkiTutari(); hesaplaOncekiKatkiTutari(); hesaplaKalanVeEndeks();
    }
  });

  // MANUEL BELİRLE: Vergi İndirim Oranı
  document.getElementById('btn-manual-vergi')?.addEventListener('click', async () => {
    const { value: val } = await Swal.fire({
      title: 'Vergi İndirim Oranını giriniz (%)',
      input: 'text',
      inputPlaceholder: 'örn: 80',
      showCancelButton: true,
      confirmButtonText: 'Tamam',
      cancelButtonText: 'Vazgeç',
      inputValidator: (v) => {
        const n = parseFormattedNumber(v);
        if (isNaN(n) || n < 0 || n > 100) return '0-100 arasında bir yüzde girin';
        return null;
      }
    });
    if (val !== undefined) {
      const n = parseFormattedNumber(val);
      document.getElementById('vergi_orani').value = n.toString().replace('.', ',');
      sessionStorage.setItem('manual_vergi', 'true');
      sessionStorage.setItem('manual_vergi_value', String(n));
      updateDiscountedRatesUI();
    }
  });

  // Teşvik belgeleri silme (AJAX)
  document.querySelectorAll('.delete-tesvik-form').forEach(formElement => {
    formElement.addEventListener('submit', async (event) => {
      event.preventDefault();
      Swal.fire({
        title: "Emin misiniz?",
        text: "Bu belge silinecek. Bu işlem geri alınamaz!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "Evet, sil!",
        cancelButtonText: "İptal"
      }).then(async (result) => {
        if (!result.isConfirmed) return;
        try {
          const response = await fetch(formElement.action, {
            method: 'POST',
            body: new FormData(formElement)
          });
          const data = await response.json();
          showSwalMessage(data.status, data.title, data.message);
          if (data.status === "success") {
            formElement.closest('tr')?.remove();
          }
        } catch (err) {
          console.error('Belge silme hatası:', err);
          showSwalMessage('error', 'Hata!', 'Belge silinirken bir sorun oluştu.');
        }
      });
    });
  });
</script>
{% endblock %}