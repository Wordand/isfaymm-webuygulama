{% extends "layout.html" %}
{% block title %}Ä°ndirimli Kurumlar Vergisi{% endblock %}

{% block content %}
<h3 class="text-center my-4">
  <i class="bi bi-bar-chart-fill"></i> Ä°ndirimli Kurumlar Vergisi
</h3>

<ul class="nav nav-tabs mt-4 justify-content-center">
  <li class="nav-item">
    <a class="nav-link {% if sekme == 'form' %}active{% endif %}" href="?sekme=form">ğŸ§¾ Form GiriÅŸi</a>
  </li>

  <li class="nav-item">
    <a class="nav-link {% if sekme == 'ayrintili' %}active{% endif %}" href="?sekme=ayrintili">
      ğŸ“ˆ AyrÄ±ntÄ±lÄ± KazanÃ§ Hesaplama
    </a>
  </li>

  <li class="nav-item">
    <a class="nav-link {% if sekme=='tesvik' %}active{% endif %}" href="?sekme=tesvik">ğŸ“‚ TeÅŸvik Belgelerim</a>
  </li>


  <li class="nav-item">
    <a class="nav-link {% if sekme == 'mevzuat' %}active{% endif %}" href="?sekme=mevzuat">ğŸ“š Mevzuat</a>
  </li>
</ul>

<div class="mt-4">
  {% if sekme == 'tesvik' %}
  {% include 'tesvik.html' %}


  {% elif sekme == 'mevzuat' %}
  <ul>
    <li>5520 sayÄ±lÄ± Kurumlar Vergisi Kanunu Madde 32/A</li>
    <li>YatÄ±rÄ±m TeÅŸvik Belgesi TebliÄŸleri</li>
    <li>Resmi Gazete KararlarÄ± ve YÃ¶netmelikler</li>
  </ul>

  {% elif sekme == 'form' %}
  <form id="form-giris" method="POST" action="{{ url_for('indirimlikurumlar.form_kaydet') }}" novalidate class="mx-auto"
    style="max-width: 600px;">

    <input type="hidden" name="tesvik_id" value="{{ current_belge.id if current_belge else '' }}">
    <input type="hidden" name="belge_no_hidden" value="{{ current_belge.belge_no if current_belge else '' }}">
    <input type="hidden" name="belge_tarihi_hidden" value="{{ current_belge.belge_tarihi if current_belge else '' }}">
    <input type="hidden" name="bolge_hidden" id="bolge_hidden"
      value="{{ current_belge.bolge if current_belge else '' }}">


    <div class="progress mb-4" style="height: 25px;">
      <div id="progressBar" class="progress-bar progress-bar-striped bg-info" role="progressbar" style="width: 20%;"
        aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">
        AÅŸama <span id="current-stage-text">1</span>/7
      </div>
    </div>


    <input id="kvUploadInput" type="file" accept="application/pdf" style="display: none">


    <div id="step1">
      <h5>AÅŸama 1 - Temel Bilgiler</h5>

      <div class="mb-3 text-end">
        <button type="button" class="btn btn-outline-primary"
          onclick="document.getElementById('kvUploadInput').click()">
          ğŸ“‚ PDFâ€™den Ä°Ã§e Aktar
        </button>
      </div>

      <div class="mb-3">
        <label>YatÄ±rÄ±ma BaÅŸlama Tarihi</label>
        <input type="date" name="belge_tarihi" class="form-control" required>
      </div>

      <div class="mb-3">
        <label>TeÅŸvik Belgesi Hangi Karara GÃ¶re DÃ¼zenlendi</label>
        <select id="karar" name="karar" class="form-select" required>
          <option value="">SeÃ§iniz</option>
          <option value="2009/15199">2009/15199</option>
          <option value="2012/3305">2012/3305</option>
          <option value="2009/15199 (2012/3305 sayÄ±lÄ± BKK GeÃ§ici 2. Md.)">
            2009/15199 (2012/3305 sayÄ±lÄ± BKK GeÃ§ici 2. Md.)
          </option>
          <option value="2012/3305 (GeÃ§ici 8. Madde - 1950 sayÄ±lÄ± CumhurbaÅŸkanÄ± KararÄ±)">
            2012/3305 (GeÃ§ici 8. Madde - 1950 sayÄ±lÄ± CumhurbaÅŸkanÄ± KararÄ±)
          </option>
          <option value="2016/9495 (YatÄ±rÄ±mlara Proje BazlÄ± Devlet YardÄ±mÄ± Verilmesine Ä°liÅŸkin Karar)">
            2016/9495 (YatÄ±rÄ±mlara Proje BazlÄ± Devlet YardÄ±mÄ± Verilmesine Ä°liÅŸkin Karar)
          </option>
          <option value="2025/9903">2025/9903</option>
        </select>
      </div>


      <div class="mb-3">
        <label>YatÄ±rÄ±m TÃ¼rÃ¼nÃ¼ SeÃ§iniz (1)</label>
        <select id="yatirim_turu1" name="yatirim_turu1" class="form-select" required>
          <option value="">SeÃ§iniz</option>
          <option value="Komple">Komple</option>
          <option value="Tevsi">Tevsi</option>
          <option value="Modernizasyon">Modernizasyon</option>
          <option value="Entegrasyon">Entegrasyon</option>
          <option value="ÃœrÃ¼n GeliÅŸtirme">ÃœrÃ¼n GeliÅŸtirme</option>
          <option value="DiÄŸer">DiÄŸer</option>
        </select>
      </div>

      <div class="mb-3">
        <label>YatÄ±rÄ±m TÃ¼rÃ¼nÃ¼ SeÃ§iniz (2)</label>
        <select id="yatirim_turu2" name="yatirim_turu2" class="form-select" required>
          <option value="">SeÃ§iniz</option>
          <option value="BÃ¶lgesel">BÃ¶lgesel</option>
          <option value="BÃ¼yÃ¼k Ã–lÃ§ekli">BÃ¼yÃ¼k Ã–lÃ§ekli</option>
          <option value="Stratejik">Stratejik</option>
          <option value="Ã–ncelikli YatÄ±rÄ±m">Ã–ncelikli YatÄ±rÄ±m</option>
          <option value="Proje BazÄ±nda Desteklenen YatÄ±rÄ±mlar (6745 SayÄ±lÄ± Kanun)">Proje BazÄ±nda Desteklenen YatÄ±rÄ±mlar
            (6745 SayÄ±lÄ± Kanun)</option>
        </select>
      </div>

      <div class="mb-4">
        <label>Program TÃ¼rÃ¼</label>
        <div class="input-group">
          <span class="input-group-text info-icon-styled" onclick="showInfo('programTuru')">
            <i class="bi bi-info-circle"></i>
          </span>
          <select name="program_turu" id="program_turu" class="form-select" disabled>
            <option value="">SeÃ§iniz</option>
            <option value="Teknoloji Hamlesi ProgramÄ±">Teknoloji Hamlesi ProgramÄ±</option>
            <option value="Yerel KalkÄ±nma Hamlesi ProgramÄ±">Yerel KalkÄ±nma Hamlesi ProgramÄ±</option>
            <option value="Stratejik Hamle ProgramÄ±">Stratejik Hamle ProgramÄ±</option>
            <option value="Ã–ncelikli YatÄ±rÄ±mlar TeÅŸvik Sistemi">Ã–ncelikli YatÄ±rÄ±mlar TeÅŸvik Sistemi</option>
            <option value="Hedef YatÄ±rÄ±mlar TeÅŸvik Sistemi">Hedef YatÄ±rÄ±mlar TeÅŸvik Sistemi</option>
          </select>
        </div>
      </div>



      <div class="mb-3">
        <label>YatÄ±rÄ±m TeÅŸvik Belgesi NumarasÄ±</label>
        <input type="text" name="belge_no" class="form-control" required>
      </div>

      <div class="mb-3">
        <label>Tamamlama Vizesi YapÄ±ldÄ± mÄ±?</label>
        <select name="vize_durumu" id="vize_durumu" class="form-select" required onchange="setOranlar()">
          <option value="">SeÃ§iniz</option>
          <option value="Evet - Ä°ÅŸletme DÃ¶neminde">Evet - Ä°ÅŸletme DÃ¶neminde</option>
          <option value="HayÄ±r - YatÄ±rÄ±m DÃ¶neminde">HayÄ±r - YatÄ±rÄ±m DÃ¶neminde</option>
        </select>
      </div>
      <button type="button" class="btn btn-primary" onclick="goToStep2()">Devam</button>
    </div>

    <div id="step2" class="hidden-step">
      <hr>
      <h5>AÅŸama 2 - Detaylar</h5>

      <div class="mb-3">
        <label>DÃ¶nem SeÃ§iniz</label>
        <select name="donem" id="donem" class="form-select" required onchange="setOranlar()">
          {% for yil in range(2025, 2014, -1) %}
          <optgroup label="{{ yil }}">
            <option value="{{ yil }} - 1. GEÃ‡Ä°CÄ°">{{ yil }} - 1. GEÃ‡Ä°CÄ°</option>
            <option value="{{ yil }} - 2. GEÃ‡Ä°CÄ°">{{ yil }} - 2. GEÃ‡Ä°CÄ°</option>
            <option value="{{ yil }} - 3. GEÃ‡Ä°CÄ°">{{ yil }} - 3. GEÃ‡Ä°CÄ°</option>
            <option value="{{ yil }} - KURUMLAR">{{ yil }} - KURUMLAR</option>
          </optgroup>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label>Yeniden DeÄŸerleme OranÄ± (%)</label>
        <input type="text" name="yeniden_degerleme_orani" id="yeniden_degerleme_orani" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Ä°li SeÃ§iniz</label>
        <select name="il" id="il" class="form-select" required onchange="setBolge()">
          {% for il in iller %}
          <option value="{{ il }}">{{ il }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label>BÃ¶lge</label>
        <input type="text" name="bolge" id="bolge" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>OSB Durumu</label>
        <select name="osb" id="osb" class="form-select" onchange="setOranlar()">
          <option value="OSB Ä°Ã§inde">OSB Ä°Ã§inde</option>
          <option value="OSB DÄ±ÅŸÄ±nda">OSB DÄ±ÅŸÄ±nda</option>
        </select>
      </div>

      <div class="row g-3 align-items-stretch mb-3">

        <!-- SOL BÄ°LGÄ° KUTUSU -->
        <div class="col-md-5 d-flex">
          <div class="ikv-info-box p-3 bg-light rounded-3 border flex-fill">
            <div class="fw-semibold mb-2">Ä°ndirimli KV OranlarÄ±</div>
            <ul class="list-unstyled small mb-0">
              <li class="d-flex justify-content-between">
                <span>Ä°hracat iÃ§in</span>
                <span id="ind_kv_ihr" class="fw-semibold">â€”%</span>
              </li>
              <li class="d-flex justify-content-between">
                <span>Ä°malat iÃ§in</span>
                <span id="ind_kv_iml" class="fw-semibold">â€”%</span>
              </li>
              <li class="d-flex justify-content-between">
                <span>DiÄŸer Gelirler iÃ§in</span>
                <span id="ind_kv_dig" class="fw-semibold">â€”%</span>
              </li>
            </ul>
          </div>
        </div>

        <!-- SAÄ KONTROLLER -->
        <div class="col-md-7">
          <div class="row g-3 h-100">
            <div class="col-12">
              <label class="form-label">YatÄ±rÄ±ma KatkÄ± OranÄ± (%)</label>
              <div class="input-group fullheight-group">
                <input type="text" name="katki_orani" id="katki_orani" class="form-control" readonly>
                <span class="input-group-text">%</span>
                <button type="button" class="btn btn-outline-secondary" id="btn-manual-katki">Manuel Belirle</button>
              </div>
            </div>

            <div class="col-12">
              <label class="form-label">Vergi Ä°ndirim OranÄ± (%)</label>
              <div class="input-group fullheight-group">
                <input type="text" name="vergi_orani" id="vergi_orani" class="form-control" readonly>
                <span class="input-group-text">%</span>
                <button type="button" class="btn btn-outline-secondary" id="btn-manual-vergi">Manuel Belirle</button>
              </div>
            </div>
          </div>
        </div>

      </div>


      <div class="mb-4">
        <label>DiÄŸer KazanÃ§lara Uygulanacak Oran (%)</label>
        <div class="input-group">
          <span class="input-group-text info-icon-styled" onclick="showInfo('digeroran')">
            <i class="bi bi-info-circle"></i>
          </span>
          <input type="text" name="diger_oran" id="diger_oran" class="form-control" readonly>
        </div>
      </div>

      <!-- ğŸ”¹ ButonlarÄ± ayrÄ± bir satÄ±ra al -->
      <div class="mt-3">
        <button type="button" class="btn btn-secondary me-2" onclick="goToStep1()">â† Geri</button>
        <button type="button" class="btn btn-primary" onclick="goToStep3()">Devam</button>
      </div>
    </div>






    <div id="step3" class="hidden-step">
      <h5>AÅŸama 3 - YatÄ±rÄ±m Bilgileri</h5>

      <div class="mb-3">
        <label>Toplam YatÄ±rÄ±m TutarÄ±nÄ± Giriniz</label>
        <input type="text" name="toplam_tutar" id="toplam_tutar" class="form-control" placeholder="Tutar Giriniz">
      </div>

      <div class="mb-3">
        <label>Toplam YatÄ±rÄ±ma KatkÄ± TutarÄ±</label>
        <input type="text" name="katki_tutari" id="katki_tutari" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>DiÄŸer Faaliyetlerden Elde Edilen KazanÃ§lar Ä°Ã§in KatkÄ± TutarÄ±</label>
        <div class="input-group">
          <span class="input-group-text info-icon-styled" onclick="showInfo('digerkatkitutari')">
            <i class="bi bi-info-circle"></i>
          </span>
          <input type="text" name="diger_katki_tutari" id="diger_katki_tutari" class="form-control" readonly>
        </div>
      </div>

      <div class="mb-3">
        <label>Cari YÄ±lda Fiilen GerÃ§ekleÅŸtirilen YatÄ±rÄ±m HarcamasÄ± TutarÄ±nÄ± Giriniz</label>
        <input type="text" name="cari_harcama_tutari" id="cari_harcama_tutari" class="form-control"
          placeholder="Tutar Giriniz">
      </div>

      <div class="mb-3">
        <label>YatÄ±rÄ±mÄ±n BaÅŸlangÄ±cÄ±ndan Ä°tibaren Fiilen GerÃ§ekleÅŸtirilen YatÄ±rÄ±m HarcamasÄ± TutarÄ±nÄ± Giriniz</label>
        <input type="text" name="toplam_harcama_tutari" id="toplam_harcama_tutari" class="form-control"
          placeholder="Tutar Giriniz">
      </div>

      <div class="mb-3">
        <label>Fiili YatÄ±rÄ±m HarcamasÄ± Nedeniyle Hak KazanÄ±lan YatÄ±rÄ±ma KatkÄ± TutarÄ±</label>
        <input type="text" name="fiili_katki_tutari" id="fiili_katki_tutari" class="form-control" readonly>
      </div>

      <button type="button" class="btn btn-secondary me-2" onclick="goToStep2()">â† Geri</button>
      <button type="button" class="btn btn-primary" onclick="goToStep4()">Devam</button>

    </div>

    <div id="step4" class="hidden-step">
      <h5>AÅŸama 4 - Hesaplamalar</h5>

      <div class="mb-3">
        <label>Ã–nceki DÃ¶nemlerde YararlanÄ±lan YatÄ±rÄ±ma KatkÄ± TutarÄ±nÄ± Giriniz<br>
          (<span class="text-primary fw-bold">YatÄ±rÄ±mdan Elde Edilen KazanÃ§ DolayÄ±sÄ±yla</span>)
          <input type="text" name="onceki_yatirim_katki_tutari" id="onceki_yatirim_katki_tutari" class="form-control"
            placeholder="Tutar Giriniz">
      </div>

      <div class="mb-3">
        <label>Ã–nceki DÃ¶nemlerde YararlanÄ±lan YatÄ±rÄ±ma KatkÄ± TutarÄ±nÄ± Giriniz<br>
          (<span class="text-success fw-bold">DiÄŸer Faaliyetlerden Elde Edilen KazanÃ§ DolayÄ±sÄ±yla</span>)
          <input type="text" name="onceki_diger_katki_tutari" id="onceki_diger_katki_tutari" class="form-control"
            placeholder="Tutar Giriniz">
      </div>

      <div class="mb-3">
        <label>Ã–nceki DÃ¶nemlerde YararlanÄ±lan Toplam YatÄ±rÄ±ma KatkÄ± TutarÄ±</label>
        <input type="text" name="onceki_katki_tutari" id="onceki_katki_tutari" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Cari Hesaplama Ã–ncesi Kalan KatkÄ± TutarÄ±</label>
        <input type="text" name="kalan_katki_tutari" id="kalan_katki_tutari" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>EndekslenmiÅŸ Tutarlar Dahil Fiili YatÄ±rÄ±m HarcamasÄ± Nedeniyle<br>
          Hak KazanÄ±lan YatÄ±rÄ±ma KatkÄ± TutarÄ±</label>
        <input type="text" name="endeks_katki_tutari" id="endeks_katki_tutari" class="form-control" readonly>
      </div>

      <button type="button" class="btn btn-secondary me-2" onclick="goToStep3()">â† Geri</button>
      <button type="button" class="btn btn-primary" onclick="goToStep5()">Devam</button>
    </div>

    <div id="step5" class="hidden-step">
      <h5 class="mb-4">AÅŸama 5 - Tevsi YatÄ±rÄ±m Bilgileri</h5>

      <div class="mb-3">
        <label>GerÃ§ekleÅŸen Tevsi YatÄ±rÄ±m TutarÄ±nÄ± Giriniz (TL):</label>
        <input type="text" name="gerceklesen_tevsi_yatirim_tutari" id="gerceklesen_tevsi_yatirim_tutari"
          class="form-control" placeholder="0,00 TL" oninput="calculateTevsiKazancAutomatically()">
      </div>

      <div class="mb-3">

        <label>Toplam Sabit KÄ±ymet TutarÄ±nÄ± Giriniz (TL):</label>
        <div class="input-group">
          <span class="input-group-text info-icon-styled" onclick="showInfo('toplamSabitKiymetTutari')">
            <i class="bi bi-info-circle"></i>
          </span>
          <input type="text" name="toplam_sabit_kiymet_tutari" id="toplam_sabit_kiymet_tutari" class="form-control"
            placeholder="0,00 TL" oninput="calculateTevsiKazancAutomatically()">
        </div>
      </div>

      <div class="mb-3">
        <label>Ticari BilanÃ§o KarÄ±nÄ± Giriniz (TL):</label>
        <input type="text" name="ticari_bilanco_kari" id="ticari_bilanco_kari" class="form-control"
          placeholder="0,00 TL" oninput="calculateTevsiKazancAutomatically()">

      </div>

      <div class="mb-3">
        <label>KKEG Giriniz (TL):</label>
        <input type="text" name="kkeg" id="kkeg" class="form-control" placeholder="0,00 TL">
      </div>

      <div class="mb-3">
        <label>Kurumlar Vergisi MatrahÄ± (TL)</label>
        <input type="text" name="kv_matrah" id="kv_matrah" class="form-control" placeholder="0,00 TL" readonly>
      </div>

      <div class="mb-3">
        <label>Tevsi YatÄ±rÄ±mlardan Elde Edilen KazanÃ§ TutarÄ± (TL):</label>
        <div class="input-group">
          <span class="input-group-text info-icon-styled" onclick="showInfo('tevsiYatirimdanEldeEdilenKazancTutari')">
            <i class="bi bi-info-circle"></i>
          </span>
          <input type="text" name="tevsi_yatirim_kazanci" id="tevsi_yatirim_kazanci" class="form-control"
            placeholder="0,00 TL" readonly>
        </div>
      </div>

      <button type="button" class="btn btn-secondary me-2" onclick="goToStep4()">â† Geri</button>
      <button type="button" class="btn btn-primary" onclick="goToStep6()">Devam</button>
    </div>

    <div id="step6" class="hidden-step">
      <h5>AÅŸama 6 â€“ SatÄ±ÅŸ & Faaliyet DaÄŸÄ±lÄ±mÄ±</h5>

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="useDetailedProfitRatios" name="use_detailed_profit_ratios"
          onchange="toggleDetailedProfitInput()">
        <label class="form-check-label" for="useDetailedProfitRatios">
          ğŸ“ˆ AyrÄ±ntÄ±lÄ± KazanÃ§ DaÄŸÄ±lÄ±mÄ±nÄ± Kullan
        </label>
      </div>

      <div class="mb-3">
        <label>BrÃ¼t SatÄ±ÅŸlar</label>
        <input type="text" name="brut_satis" id="brut_satis" class="form-control" placeholder="Tutar Giriniz">
      </div>
      <div class="mb-3 row">
        <div class="col">
          <label>Ä°hracat Faaliyeti</label>
          <input type="text" name="ihracat" id="ihracat" class="form-control" placeholder="Tutar Giriniz"
            oninput="calculateRatios()">
        </div>
        <div class="col-auto align-self-end">
          <span id="ratio_ihracat">â€”%</span>
        </div>
      </div>
      <div class="mb-3 row">
        <div class="col">
          <label>Ä°malat Faaliyeti</label>
          <input type="text" name="imalat" id="imalat" class="form-control" placeholder="Tutar Giriniz"
            oninput="calculateRatios()">
        </div>
        <div class="col-auto align-self-end">
          <span id="ratio_imalat">â€”%</span>
        </div>
      </div>
      <div class="mb-3 row">
        <div class="col">
          <label>DiÄŸer Faaliyetler</label>
          <input type="text" name="diger_faaliyet" id="diger_faaliyet" class="form-control" placeholder="Tutar Giriniz"
            oninput="calculateRatios()">
        </div>
        <div class="col-auto align-self-end">
          <span id="ratio_diger">â€”%</span>
        </div>
      </div>



      <button type="button" class="btn btn-secondary me-2" onclick="goToStep5('from6')">â† Geri</button>
      <button id="calculateCariBtn" type="button" class="btn btn-primary">
        CARÄ° KATKI TUTARINI HESAPLA
      </button>

      <div class="mt-5 d-flex justify-content-center">
        <a href="?sekme=ayrintili" class="btn btn-lg text-white text-decoration-none
                                      px-5 py-3 rounded-pill btn-gradient-hover shadow-lg">
          <i class="bi bi-pie-chart-fill me-2"></i>
          KazanÃ§ DaÄŸÄ±lÄ±mÄ±nÄ± <br class="d-none d-md-block">
          AyrÄ±ntÄ±lÄ± Olarak Hesaplamak Ä°stiyorum
          <i class="bi bi-arrow-right ms-2"></i>
        </a>
      </div>
    </div>

    <div id="step7" class="hidden-step">
      <h5>AÅŸama 7 - SonuÃ§lar & Kaydet</h5>


      <div class="mb-3">
        <label>Cari DÃ¶nemde YararlanÄ±lan YatÄ±rÄ±ma KatkÄ± TutarÄ± (YatÄ±rÄ±mdan Elde Edilen KazanÃ§ DolayÄ±sÄ±yla)</label>
        <input type="text" id="cari_yatirim_katki" name="cari_yatirim_katki" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Cari DÃ¶nemde YararlanÄ±lan YatÄ±rÄ±ma KatkÄ± TutarÄ± (DiÄŸer Faaliyetlerden Elde Edilen Gelirler
          DolayÄ±sÄ±yla)</label>
        <input type="text" id="cari_diger_katki" name="cari_diger_katki" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Cari DÃ¶nemde YararlanÄ±lan Toplam YatÄ±rÄ±ma KatkÄ± TutarÄ±</label>
        <input type="text" id="cari_toplam_katki" name="cari_toplam_katki" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Cari DÃ¶nem Dahil Olmak Ãœzere YararlanÄ±lan Toplam YatÄ±rÄ±ma KatkÄ± TutarÄ±</label>
        <input type="text" id="genel_toplam_katki" name="genel_toplam_katki" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Ä°ndirimli Kurumlar Vergisi MatrahÄ±</label>
        <input type="text" id="indirimli_matrah" name="indirimli_matrah" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Ä°ndirimli Kurumlar Vergisi</label>
        <input type="text" id="indirimli_kv" name="indirimli_kv" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Ä°ndirimli Kurumlar Vergisi OranÄ± %</label>
        <input type="text" id="indirimli_kv_oran" name="indirimli_kv_oran" class="form-control" readonly>
      </div>


      <div class="d-flex justify-content-start gap-2 mt-4">
        <button type="button" class="btn btn-secondary" onclick="goToStep6()">â† Geri</button>

        <button type="submit" id="btn-save-step7" name="submit_action" value="new_save" class="btn btn-success">
          ğŸ’¾ Yeni Belge Kaydet
        </button>

        {% if current_belge %}
        <button type="submit" id="btn-guncelle-step7" name="submit_action" value="update" class="btn btn-warning">
          ğŸ”„ GÃ¼ncelle
        </button>
        {% endif %}

      </div>
    </div>
  </form>

  {% elif sekme == 'ayrintili' %}
  <div class="text-center my-4">
    <a href="?sekme=form#step6" class="btn btn-outline-secondary btn-lg text-decoration-none">
      â† AÅŸama 6â€™ya Geri DÃ¶n
    </a>
  </div>

  <h3 class="text-center my-4">ğŸ“Š AyrÄ±ntÄ±lÄ± KazanÃ§ Hesaplama</h3>

  <form method="POST" class="mb-4" id="ayrintili-kazanc-form"
    action="{{ url_for('indirimlikurumlar.ayrintili_kazanc') }}">
    <div class="d-flex justify-content-between mb-3">
      <button name="import" class="btn btn-primary" type="button" id="import-ayrintili">
        ğŸ“‚ Ä°Ã§e Aktar
      </button>
      <button name="export" class="btn btn-success">
        ğŸ“¤ DÄ±ÅŸa Aktar
      </button>
    </div>

    <table class="table table-striped table-bordered" id="ayrintili-kazanc-table">
      <thead class="table-light">
        <tr>
          <th>AÃ§Ä±klama</th>
          <th>Toplam HasÄ±lat (B)</th>
          <th>Ä°hracat (C)</th>
          <th>Ä°malat (D)</th>
          <th>DiÄŸer (E)</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        {# parantez iÃ§indeki kodu al #}
        {% set code = row['AÃ§Ä±klama'].split('(')[-1].split(')')[0] %}
        <tr>
          <td class="
                                {% if code|length == 3 %}
                                    text-end
                                {% else %}
                                    text-start fw-bold
                                {% endif %}
                            ">
            {{ row['AÃ§Ä±klama'] }}
          </td>

          <td><input name="B_{{ loop.index0 }}" class="form-control form-control-sm text-end" value="{{ row['B'] }}"
              placeholder="Tutar Giriniz" {% if loop.index0 in
              [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54]
              %}readonly{% endif %}></td>
          <td><input name="C_{{ loop.index0 }}" class="form-control form-control-sm text-end" value="{{ row['C'] }}"
              placeholder="Tutar Giriniz" {% if loop.index0 in [0,1,5,9,10,15,16,20,21,22,23,34,42,45,46,49,53,54]
              %}readonly{% endif %}></td>
          <td><input name="D_{{ loop.index0 }}" class="form-control form-control-sm text-end" value="{{ row['D'] }}"
              placeholder="Tutar Giriniz" {% if loop.index0 in [0,1,5,9,10,15,16,20,21,22,23,34,42,45,46,49,53,54]
              %}readonly{% endif %}></td>
          <td><input name="E_{{ loop.index0 }}" class="form-control form-control-sm text-end" value="{{ row['E'] }}"
              placeholder="Tutar Giriniz" {% if loop.index0 in [0,1,5,9,10,15,16,20,21,22,23,34,42,45,46,49,53,54]
              %}readonly{% endif %}></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="text-center mt-4">
      <button type="submit" class="btn btn-lg btn-outline-primary" id="save-ayrintili-kazanc">ğŸ’¾ Kaydet</button> {# ID
      eklendi #}
      <button type="button" class="btn btn-lg btn-danger ms-2" id="clearProfitData">ğŸ—‘ï¸ TÃ¼mÃ¼nÃ¼ Temizle</button>
    </div>
  </form>
  {% endif %}
</div>


<style>
  #step1,
  #step2,
  #step3,
  #step4,
  #step5,
  #step6,
  #step7 {
    transition: opacity 0.4s ease-in-out, visibility 0.4s ease-in-out;
    opacity: 1;
    visibility: visible;
  }

  .hidden-step {
    display: none !important;
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none;
    position: absolute;
  }

  .fullheight-group .form-control,
  .fullheight-group .input-group-text,
  .fullheight-group .btn {
    height: 44px;
  }

  .ikv-info-box {
    display: flex;
    flex-direction: column;
    justify-content: center;
    /* kutu iÃ§eriÄŸini ortala */
  }
</style>

<script>
  const bolgeMap = {{ bolge_json | tojson }};
  const katkilar = {{ katkilar_json | tojson }};
  const vergiler = {{ vergiler_json | tojson }};
  const initialRatios = {{ initial_ayrintili_ratios | tojson }};
  const bolgeMap9903 = {{ BOLGE_MAP_9903 | tojson | safe }};
  const katkilar9903 = {{ TESVIK_KATKILAR_9903 | tojson | safe }};

  const yenidenDegerlemeOranlari = {
    "2025 - 3. GEÃ‡Ä°CÄ°": 0,
    "2025 - 2. GEÃ‡Ä°CÄ°": 9.23,
    "2025 - 1. GEÃ‡Ä°CÄ°": 3.30,
    "2025 - KURUMLAR": 0,
    "2024 - 3. GEÃ‡Ä°CÄ°": 34.14,
    "2024 - 2. GEÃ‡Ä°CÄ°": 22.20,
    "2024 - 1. GEÃ‡Ä°CÄ°": 7.55,
    "2024 - KURUMLAR": 43.93,
    "2023 - KURUMLAR": 58.46,
    "2022 - KURUMLAR": 122.93,
    "2021 - KURUMLAR": 36.20,
    "2020 - KURUMLAR": 9.11
  };

  let debounceTimeout = null;
  let isProgrammaticChange = false; // Yeni bayrak: Programatik deÄŸiÅŸiklik mi?


  // AÅŸamalarÄ± temsil eden dizi (global olarak tanÄ±mlÄ±, bu kod bloÄŸunun baÅŸÄ±nda olmalÄ±)
  const ALL_STEPS_IDS = ["step1", "step2", "step3", "step4", "step5", "step6", "step7"];
  const TOTAL_STEPS = 7; // Toplam aÅŸama sayÄ±sÄ±

  let CURRENT_STEP = 1; // Nereden geldiÄŸimizi takip etmek iÃ§in

  let tevsiMask;





  function parseFormattedNumber(value) {
    if (!value) return 0;
    const normalized = value.toString()
      .replace(/\s+/g, '')
      .replace('%', '')
      .replace(/\./g, '')
      .replace(',', '.');
    const num = parseFloat(normalized);
    return isNaN(num) ? 0 : num;
  }

  function normalizeBN(s) { return (s || '').replace(/\D/g, ''); }

  function convertToInputDateFormat(t) {
    const p = (t || '').split('/');
    return p.length === 3 ? `${p[2]}-${p[1].padStart(2, '0')}-${p[0].padStart(2, '0')}` : t;
  }




  function kararDegisti() {
    const karar = document.getElementById("karar")?.value;
    const programSelect = document.getElementById("program_turu");
    const yatirimTuru1 = document.getElementById("yatirim_turu1");
    const yatirimTuru2 = document.getElementById("yatirim_turu2");
    const katkiInput = document.getElementById("katki_orani");
    const vergiInput = document.getElementById("vergi_orani");
    const digerInput = document.getElementById("diger_oran");

    if (karar === "2025/9903") {
      console.log("â†’ 2025/9903 modu aktif!");

      // Program aktif hale getir
      programSelect.removeAttribute("disabled");
      programSelect.disabled = false;
      programSelect.classList.remove("bg-light");

      // YatÄ±rÄ±m tÃ¼rleri pasif
      yatirimTuru1.disabled = true;
      yatirimTuru2.disabled = true;
      yatirimTuru1.value = "";
      yatirimTuru2.value = "";
      yatirimTuru1.classList.add("bg-light");
      yatirimTuru2.classList.add("bg-light");

      // Sabit oranlar
      vergiInput.value = 60;
      digerInput.value = 50;

    } else {
      console.log("â†’ Normal teÅŸvik modu.");

      // Program tÃ¼rÃ¼ tekrar kapat
      programSelect.setAttribute("disabled", "disabled");
      programSelect.classList.add("bg-light");

      // YatÄ±rÄ±m tÃ¼rleri tekrar aktif
      yatirimTuru1.disabled = false;
      yatirimTuru2.disabled = false;
      yatirimTuru1.classList.remove("bg-light");
      yatirimTuru2.classList.remove("bg-light");

      // OranlarÄ± sÄ±fÄ±rla
      vergiInput.value = "";
      digerInput.value = "";
      katkiInput.value = "";

      setBolge();
      setOranlar();
    }
  }



  function setBolge() {
    const karar = document.getElementById("karar")?.value;
    if (karar === "2025/9903") {
      console.log("ğŸ“ 2025/9903 aktif â€” bÃ¶lge ayarÄ± yapÄ±ldÄ± ama katkÄ± oranÄ± deÄŸiÅŸtirilmedi.");
      return;
    }

    const ilSelect = document.getElementById("il");
    const bolgeInput = document.getElementById("bolge");
    if (ilSelect && bolgeInput) {
      const il = ilSelect.value;
      const bolge = bolgeMap[il];
      bolgeInput.value = bolge;

    }
  }

  function setOranlar() {
    const karar = document.getElementById("karar")?.value;
    if (karar === "2025/9903") return;
    const bolgeInput = document.getElementById("bolge");
    const osbSelect = document.getElementById("osb");
    const vizeSelect = document.getElementById("vize_durumu");
    const donemSelect = document.getElementById("donem");
    if (!bolgeInput || !osbSelect || !vizeSelect || !donemSelect) return;

    const bolge = bolgeInput.value;
    const osb = osbSelect.value;
    const key = bolge + "|" + osb;

    const vize = vizeSelect.value;
    const donem = donemSelect.value;
    const donemYil = parseInt(donem.split(" - ")[0]);

    // 1) YDO yaz/temizle
    const yenidenDegerlemeOraniEl = document.getElementById("yeniden_degerleme_orani");
    if (yenidenDegerlemeOraniEl) {
      if (vize.includes("HayÄ±r")) {
        yenidenDegerlemeOraniEl.value = "YATIRIM DÃ–NEMÄ°NDE OLDUÄUNUZ Ä°Ã‡Ä°N ENDEKSLEME YAPILMAZ";
        yenidenDegerlemeOraniEl.classList.add("text-muted");   // opsiyonel: gri gÃ¶ster
      } else {
        const oranAnahtari = donem;
        yenidenDegerlemeOraniEl.value = (yenidenDegerlemeOranlari[oranAnahtari] ?? "");
        yenidenDegerlemeOraniEl.classList.remove("text-muted");
      }
    }

    // 2) KatkÄ± oranÄ±
    const katkiOraniEl = document.getElementById("katki_orani");
    const manualKatki = sessionStorage.getItem('manual_katki') === 'true';
    const manualKatkiVal = sessionStorage.getItem('manual_katki_value');
    if (katkiOraniEl) {
      if (manualKatki && manualKatkiVal !== null) {
        katkiOraniEl.value = manualKatkiVal; // manuel deÄŸeri koru
      } else {
        let v = katkilar[key] ?? "";
        if (v !== "") v = Math.max(0, Math.min(100, Number(v)));
        katkiOraniEl.value = v;
      }
    }

    // 3) Vergi indirim oranÄ±
    const vergiOraniEl = document.getElementById("vergi_orani");
    const manualVergi = sessionStorage.getItem('manual_vergi') === 'true';
    const manualVergiVal = sessionStorage.getItem('manual_vergi_value');
    if (vergiOraniEl) {
      if (manualVergi && manualVergiVal !== null) {
        vergiOraniEl.value = manualVergiVal; // manuel deÄŸeri koru
      } else {
        let v = (donemYil >= 2017 && donemYil <= 2022) ? 100 : (vergiler[key] ?? "");
        if (v !== "") v = Math.max(0, Math.min(100, Number(v)));
        vergiOraniEl.value = v;
      }
    }

    // 4) DiÄŸer kazanÃ§ oranÄ± (manuel deÄŸiÅŸmiyorsa olduÄŸu gibi bÄ±rak)
    const digerOranEl = document.getElementById("diger_oran");
    if (digerOranEl) {
      if (vize.includes("Evet")) {
        digerOranEl.value = "Ä°ÅLETME DÃ–NEMÄ°NDE HESAPLANMAZ";
      } else {
        let v = (donemYil >= 2017 && donemYil <= 2022) ? 100 : 80;
        v = Math.max(0, Math.min(100, Number(v)));
        digerOranEl.value = v;
      }
    }


    // 5) Sol â€œÄ°ndirimli KV OranlarÄ± (bilgi)â€ kutusunu gÃ¼ncelle
    updateDiscountedRatesUI();

    // 6) AÅŸama 3/4â€™te isek baÄŸlÄ± hesaplamalarÄ± tetikle
    const step3El = document.getElementById("step3");
    if (step3El && !step3El.classList.contains("hidden-step")) {
      hesaplaKatkiTutari();
      hesaplaDigerKatkiTutari();
      hesaplaFiiliKatkiTutari();
    }
    const step4El = document.getElementById("step4");
    if (step4El && !step4El.classList.contains("hidden-step")) {
      hesaplaOncekiKatkiTutari();
      hesaplaKalanVeEndeks();
    }
  }





  function showSwalMessage(type, title, text) {
    Swal.fire({
      icon: type,
      title: title,
      text: text,
      timer: 3000,
      toast: true,
      position: "top-end",
      showConfirmButton: false
    });
  }

  function showInfo(key) {
    let title = "Bilgilendirme";
    let message = "Bilgi mesajÄ± mevcut deÄŸil.";
    let icon = "info";
    const createJustifiedMessage = (text) => `<div style='text-align: justify;'>${text}</div>`;
    switch (key) {
      case 'yatirimaBaslamaTarihi':
        message = createJustifiedMessage(
          "<b>YatÄ±rÄ±ma BaÅŸlama Tarihi</b> olarak, YatÄ±rÄ±m TeÅŸvik Belgesi ekinde yer alan 'yatÄ±rÄ±ma baÅŸlama tarihi' esas alÄ±nmalÄ±dÄ±r. <br><br>" +
          "<i>Ã–nemli Not:</i> EÄŸer belgede birden fazla tarih varsa, genellikle yatÄ±rÄ±mÄ±n fiilen baÅŸladÄ±ÄŸÄ± veya belgenin onaylandÄ±ÄŸÄ± tarih kullanÄ±lÄ±r."
        );
        break;

      case 'programTuru':
        title = "2025/9903 GÃ¼ncel Karara Ä°liÅŸkin Bilgilendirme";
        message = createJustifiedMessage(
          "<b>NOT:</b> Kurumlar vergisi oranÄ±, yatÄ±rÄ±m teÅŸvik belgesi kapsamÄ±nda gerÃ§ekleÅŸtirilen yatÄ±rÄ±mlardan elde edilen kazanÃ§lara, " +
          "yatÄ±rÄ±mÄ±n kÄ±smen veya tamamen iÅŸletilmesine baÅŸlanÄ±lan hesap dÃ¶neminden itibaren " +
          "yatÄ±rÄ±ma katkÄ± tutarÄ±na ulaÅŸÄ±ncaya kadar, indirim hakkÄ±nÄ±n kullanÄ±labileceÄŸi ilk hesap dÃ¶nemi dahil " +
          "en fazla <b>10 hesap dÃ¶nemi</b> boyunca <b>%60 indirimli</b> olarak uygulanÄ±r.<br><br>" +

          "Ä°ndirim hakkÄ±nÄ±n kullanÄ±labileceÄŸi ilk hesap dÃ¶nemi dahil en fazla on hesap dÃ¶nemine iliÅŸkin sÄ±nÄ±rlama, " +
          "<b>16/6/2025</b> tarihinden Ã¶nce baÅŸvurusu yapÄ±lmÄ±ÅŸ ve reddedilmemiÅŸ olanlar hariÃ§, " +
          "<b>24/7/2025</b> tarihinden itibaren (bu tarih dahil) alÄ±nan yatÄ±rÄ±m teÅŸvik belgeleri yÃ¶nÃ¼nden geÃ§erli olacaktÄ±r.<br><br>" +

          "<b>NOT:</b> KazanÃ§ bulunmasÄ±na raÄŸmen yararlanÄ±lmayan yatÄ±rÄ±ma katkÄ± tutarlarÄ± mÃ¼teakip dÃ¶nemlerde dikkate alÄ±nmaz.<br><br>" +
          "Buna gÃ¶re, ilgili hesap dÃ¶nemlerinde faydalanma imkÃ¢nÄ± bulunmakta iken, " +
          "<b>faydalanÄ±lmayan yatÄ±rÄ±ma katkÄ± tutarlarÄ±nÄ±n izleyen dÃ¶nemlerde kullanÄ±lmasÄ± mÃ¼mkÃ¼n deÄŸildir.</b>"
        );
        break;

      case 'digeroran':
        message = createJustifiedMessage(
          "YatÄ±rÄ±m dÃ¶neminde diÄŸer faaliyetlerden elde edilen kazanÃ§larda indirimli kurumlar vergisi uygulanmasÄ± mÃ¼mkÃ¼ndÃ¼r."
        );
        break;


      case 'digerkatkitutari':
        message = createJustifiedMessage(
          "MÃ¼kellefler, yatÄ±rÄ±m teÅŸvik belgeleri kapsamÄ±ndaki yatÄ±rÄ±mlarÄ±na fiilen baÅŸladÄ±klarÄ± tarihten itibaren, hesaplanacak yatÄ±rÄ±ma katkÄ± tutarÄ±na mahsuben; <br><br>" +
          "a) Toplam yatÄ±rÄ±ma katkÄ± tutarÄ±nÄ±n Bakanlar Kurulu KararÄ± ile belirlenen oranÄ±nÄ± geÃ§memek ve <br><br>" +
          "b) GerÃ§ekleÅŸtirilen yatÄ±rÄ±m harcamasÄ± tutarÄ±nÄ± aÅŸmamak <br><br>" +
          "Ã¼zere, yatÄ±rÄ±m dÃ¶neminde diÄŸer faaliyetlerinden elde ettikleri kazanÃ§larÄ±na indirimli kurumlar vergisi uygulanabilecektir."
        );
        break;


      case 'toplamSabitKiymetTutari':
        message = createJustifiedMessage(
          "<b>Toplam Sabit KÄ±ymet TutarÄ±</b> ifadesinden, Amortisman mevzuunu oluÅŸturan iktisadi kÄ±ymetlerin anlaÅŸÄ±lmasÄ± gerekir.<br><br>" +
          "DolayÄ±sÄ±yla boÅŸ arazi-arsa ve amortismana tabi olmayan diÄŸer kÄ±ymetlerle ilgili tutarlar bu hesaplamada dikkate alÄ±nmaz.<br><br>" +
          "Sabit KÄ±ymet tutarÄ±nÄ±n hesabÄ±nda bu kÄ±ymetlerin BÄ°RÄ°KMÄ°Å AMORTÄ°SMAN DÃœÅÃœLMEDEN Ã¶nceki brÃ¼t tutarlarÄ±nÄ±n dikkate alÄ±nmasÄ± gerekmektedir.<br><br>" +
          "Bu hesaplama sÄ±rasÄ±nda iÅŸletme aktifinde yer alan sabit kÄ±ymetlerin kayÄ±tlÄ± deÄŸeri olarak, yapÄ±lan ENFLASYON DÃœZELTMESÄ° SONUCU oluÅŸan deÄŸerleri dikkate alÄ±nacaktÄ±r."
        );
        break;

      case 'tevsiYatirimdanEldeEdilenKazancTutari':
        message = createJustifiedMessage(
          "Tevsi yatÄ±rÄ±mlardan elde edilen kazancÄ±n ayrÄ± hesaplarda izlenmek suretiyle tespit edilebilmesi halinde, bu kazanca indirimli vergi oranÄ± uygulanacaktÄ±r. <br><br>" +
          "KazancÄ±n ayrÄ± bir ÅŸekilde tespit edilememesi halinde ise; <br><br>" +
          "Tevsi yatÄ±rÄ±m dolayÄ±sÄ±yla indirimli vergi oranÄ± uygulanacak kazanÃ§ = (GerÃ§ekleÅŸen Tevsi YatÄ±rÄ±m TutarÄ± / Toplam Sabit KÄ±ymet TutarÄ±) X Ticari bilanÃ§o KarÄ± <br><br>" +
          "Tevsi yatÄ±rÄ±mlardan elde edilen kazancÄ±n bu ÅŸekilde oranlama yapÄ±lmak suretiyle belirlenmesi seÃ§imlik bir hak olmayÄ±p, indirimli kurumlar vergisi uygulanacak kazancÄ±n ayrÄ± hesaplarda izlenmek suretiyle mÃ¼kellefÃ§e tespit edilmesi esastÄ±r."
        );
        break;

      default: // VarsayÄ±lan durum: EÄŸer tanÄ±msÄ±z bir anahtar gelirse
        message = "Bu alan hakkÄ±nda bilgi bulunmamaktadÄ±r.";
        icon = "warning"; // VarsayÄ±lan durum iÃ§in uyarÄ± ikonu
        break;
    }
    // SweetAlert mesajÄ±nÄ± gÃ¶ster
    Swal.fire({
      icon: icon, // 'info' ikonu kullanÄ±lacak
      title: title,
      html: message,
      position: 'center', // EkranÄ±n ortasÄ±nda gÃ¶ster
      showCloseButton: true, // Kapatma butonu gÃ¶ster
      showConfirmButton: true, // "Tamam" butonu gÃ¶sterme
      timer: undefined, // Otomatik kapanma kapalÄ±
      toast: false, // Toast modu kapalÄ±
      allowOutsideClick: true, // DÄ±ÅŸarÄ±ya tÄ±klayÄ±nca kapanmasÄ±na izin ver
      allowEscapeKey: true, // ESC tuÅŸuyla kapanmasÄ±na izin ver

      width: '55em',              // Kutuyu geniÅŸletir
      scrollbarPadding: false,    // Sayfa kaymasÄ±nÄ± Ã¶nler
      heightAuto: false,

      // YENÄ° EKLENEN customClass Ã–ZELLÄ°KLERÄ°
      customClass: {
        popup: 'swal2-green-theme-popup', // TÃ¼m kutu iÃ§in
        header: 'swal2-green-theme-header', // BaÅŸlÄ±k alanÄ± iÃ§in
        title: 'swal2-green-theme-title', // BaÅŸlÄ±k metni iÃ§in
        icon: 'swal2-green-theme-icon', // Ä°kon iÃ§in
        closeButton: 'swal2-green-theme-close-button', // Kapatma butonu iÃ§in
        htmlContainer: 'swal2-green-theme-html-container'
      }
    });
  }

  function updateProgress(step) {
    const progressBar = document.getElementById("progressBar");
    const currentStageText = document.getElementById("current-stage-text"); // current-stage-text id'li span'i doÄŸru al

    if (progressBar && currentStageText) {
      const percent = (step / TOTAL_STEPS) * 100;
      progressBar.style.width = percent + "%";
      progressBar.setAttribute("aria-valuenow", percent);
      currentStageText.textContent = step; // Sadece sayÄ±yÄ± gÃ¼nceller, "AÅŸama X / Y" metni HTML'de sabit kalÄ±r
    }
  }

  function _updateStepDisplay(stepNum) {
    ALL_STEPS_IDS.forEach((id, idx) => {
      const el = document.getElementById(id);
      if (!el) return;
      const controls = el.querySelectorAll("input, select, textarea, button[type='submit']");

      if (idx + 1 === stepNum) {
        el.classList.remove("hidden-step");
        controls.forEach(c => c.disabled = false);
      } else {
        el.classList.add("hidden-step");
        controls.forEach(c => {
          if (c.tagName === 'BUTTON' && (c.type === 'submit' || c.type === 'button')) {
            c.disabled = true;
          } else {
            c.disabled = false; // Input, select, textarea aktif kalsÄ±n
          }
        });
      }
    });

    updateProgress(stepNum);

    if (stepNum === 2) {
      setBolge();
      setOranlar();
    } else if (stepNum === 3) {
      setOranlar();
      hesaplaKatkiTutari();
      hesaplaDigerKatkiTutari();
      hesaplaFiiliKatkiTutari();
    } else if (stepNum === 4) {
      hesaplaOncekiKatkiTutari();
      hesaplaKalanVeEndeks();
    } else if (stepNum === 6) {
      toggleDetailedProfitInput();

      const belgeNoInput = document.querySelector('input[name="belge_no"]');
      const belgeTarihiInput = document.querySelector('input[name="belge_tarihi"]');
      const bolgeInput = document.getElementById('bolge');

      if (belgeNoInput) {
        const h = document.querySelector('input[name="belge_no_hidden"]');
        if (h) h.value = belgeNoInput.value;
      }
      if (belgeTarihiInput) {
        const h = document.querySelector('input[name="belge_tarihi_hidden"]');
        if (h) h.value = belgeTarihiInput.value;
      }
      if (bolgeInput) {
        const h = document.getElementById('bolge_hidden');
        if (h) h.value = bolgeInput.value;
      }
    }

    CURRENT_STEP = stepNum;

    // ğŸ”¹ Step deÄŸiÅŸtiÄŸinde her zaman 2025/9903 kararÄ±nÄ± yeniden uygula
    if (typeof handleKarar9903 === "function") {
      handleKarar9903();
    }

    if (typeof blinkAllInfoIcons === "function") blinkAllInfoIcons();
  }


  function updateDiscountedRatesUI() {
    const vergiOraniEl = document.getElementById("vergi_orani");
    const spanIhr = document.getElementById("ind_kv_ihr");
    const spanIml = document.getElementById("ind_kv_iml");
    const spanDig = document.getElementById("ind_kv_dig");
    if (!vergiOraniEl || !spanIhr || !spanIml || !spanDig) return;

    const p = parseFormattedNumber(vergiOraniEl.value) / 100; // 0..1
    if (isNaN(p)) {
      spanIhr.textContent = "â€”";
      spanIml.textContent = "â€”";
      spanDig.textContent = "â€”";
      return;
    }
    const rIhr = 0.20 - (0.20 * p);
    const rIml = 0.24 - (0.24 * p);
    const rDig = 0.25 - (0.25 * p);

    const fmtPct = (x) => (x * 100).toFixed(2).replace('.', ',') + '%';
    spanIhr.textContent = fmtPct(rIhr);
    spanIml.textContent = fmtPct(rIml);
    spanDig.textContent = fmtPct(rDig);
  }





  // AyrÄ±ntÄ±lÄ± kazanÃ§ tablosunu sunucuya kaydetmek iÃ§in AJAX fonksiyonu
  async function saveDetailedProfitData() {
    const ayrTable = document.getElementById('ayrintili-kazanc-table');
    if (!ayrTable) {
      return;
    }
    const formData = new FormData();
    let dataChanged = false;
    ayrTable.querySelectorAll('tbody tr').forEach((rowEl) => {
      rowEl.querySelectorAll('input').forEach(input => {
        if (!input.readOnly) {
          const originalValue = input.getAttribute('data-original-value');
          const currentValue = input.value;
          if (originalValue !== currentValue) {
            formData.append(input.name, currentValue);
            dataChanged = true;
          }
        }
      });
    });
    if (!dataChanged) {
      return;
    }
    try {
      const response = await fetch("{{ url_for('indirimlikurumlar.ayrintili_kazanc') }}", {
        method: "POST",
        body: formData
      });
      if (response.ok) {
        ayrTable.querySelectorAll('tbody input').forEach(input => {
          input.setAttribute('data-original-value', input.value);
        });
        updateSessionStorageRatios();
      } else {
        console.error("Otomatik kaydetme baÅŸarÄ±sÄ±z oldu:", response.status, response.statusText);
      }
    } catch (error) {
      console.error("Otomatik kaydetme sÄ±rasÄ±nda hata oluÅŸtu:", error);
    }
  }

  function updateSessionStorageRatios() {
    const ayrTable = document.getElementById('ayrintili-kazanc-table');
    if (!ayrTable) {
      return;
    }
    const C54_input = ayrTable.querySelector('input[name="C_54"]');
    const D54_input = ayrTable.querySelector('input[name="D_54"]');
    const E54_input = ayrTable.querySelector('input[name="E_54"]');
    if (C54_input && D54_input && E54_input) {
      sessionStorage.setItem('ayrintili_C54', C54_input.value);
      sessionStorage.setItem('ayrintili_D54', D54_input.value);
      sessionStorage.setItem('ayrintili_E54', E54_input.value);
    }
  }

  function toggleDetailedProfitInput() {
    const useDetailedCheckbox = document.getElementById("useDetailedProfitRatios");
    if (!useDetailedCheckbox) return;
    const useDetailed = useDetailedCheckbox.checked;
    const brutInput = document.getElementById("brut_satis");
    const ihracatInput = document.getElementById("ihracat");
    const imalatInput = document.getElementById("imalat");
    const digerFaaliyetInput = document.getElementById("diger_faaliyet");
    if (!brutInput || !ihracatInput || !imalatInput || !digerFaaliyetInput) return;
    if (useDetailed) {
      brutInput.setAttribute('readonly', true);
      ihracatInput.setAttribute('readonly', true);
      imalatInput.setAttribute('readonly', true);
      digerFaaliyetInput.setAttribute('readonly', true);
      brutInput.value = '';
      ihracatInput.value = '';
      imalatInput.value = '';
      digerFaaliyetInput.value = '';
      calculateRatios();
    } else {
      brutInput.removeAttribute('readonly');
      ihracatInput.removeAttribute('readonly');
      imalatInput.removeAttribute('readonly');
      digerFaaliyetInput.removeAttribute('readonly');
      calculateRatios();
    }
  }

  function clearProfitTable() {
    Swal.fire({
      title: "Emin misiniz?",
      text: "TÃ¼m ayrÄ±ntÄ±lÄ± kazanÃ§ verilerini silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Evet, sil!",
      cancelButtonText: "Ä°ptal"
    }).then((result) => {
      if (result.isConfirmed) {
        const ayrTable = document.getElementById('ayrintili-kazanc-table');
        if (ayrTable) {
          // input deÄŸerlerini temizle
          ayrTable.querySelectorAll('tbody input').forEach(input => {
            if (!input.readOnly) {
              isProgrammaticChange = true;
              input.value = '';
              input.setAttribute('data-original-value', '');
              isProgrammaticChange = false;
            }
          });
          // Session Storage'Ä± temizle
          sessionStorage.removeItem('ayrintili_C54');
          sessionStorage.removeItem('ayrintili_D54');
          sessionStorage.removeItem('ayrintili_E54');

          // VeritabanÄ±ndan temizlemek iÃ§in AJAX isteÄŸi gÃ¶nder
          // Bu Ã¶rnekte, Python tarafÄ±ndan Ã¶zel bir 'temizle' endpoint'i olmadÄ±ÄŸÄ±nÄ± varsayÄ±yorum.
          // EÄŸer Flask'ta bir 'temizle' endpoint'i varsa, onu burada Ã§aÄŸÄ±rÄ±rdÄ±k.
          // Åimdilik sadece frontend'i temizledik ve bir mesaj gÃ¶sterdik.
          showSwalMessage("success", "Temizlendi!", "AyrÄ±ntÄ±lÄ± kazanÃ§ verileri temizlendi.");
          calculateTable(); // Tabloyu yeniden hesapla ve boÅŸ deÄŸerleri gÃ¶ster
        }
      }
    });
  }

  // Backend alanlarÄ±nÄ± form input "name"leriyle eÅŸleÅŸtirip doldur
  function fillFormWithParsedData(data) {
    const map = {
      belge_no: 'belge_no',
      karar: 'karar',
      baslama_tarihi: 'belge_tarihi',   // parser 'baslama_tarihi' dÃ¶ndÃ¼rÃ¼yorsa
      belge_tarihi: 'belge_tarihi',     // parser 'belge_tarihi' dÃ¶ndÃ¼rÃ¼yorsa
      yatirim_turu1: 'yatirim_turu1',
      yatirim_turu2: 'yatirim_turu2',
      bolge: 'bolge',

      // oran ve tutarlar
      katki_orani: 'katki_orani',
      vergi_orani: 'vergi_orani',
      ikv_orani: 'diger_oran',
      diger_oran: 'diger_oran',

      toplam_tutar: 'toplam_tutar',
      katki_tutari: 'katki_tutari',
      diger_katki_tutari: 'diger_katki_tutari',
      cari_harcama_tutari: 'cari_harcama_tutari',
      toplam_harcama_tutari: 'toplam_harcama_tutari',
      fiili_katki_tutari: 'fiili_katki_tutari',
      endeks_katki_tutari: 'endeks_katki_tutari',

      onceki_yatirim_katki_tutari: 'onceki_yatirim_katki_tutari',
      onceki_diger_katki_tutari: 'onceki_diger_katki_tutari',
      onceki_katki_tutari: 'onceki_katki_tutari',

      // cari alanlar
      cari_yatirim_katki: 'cari_yatirim_katki',
      cari_diger_katki: 'cari_diger_katki',
      cari_toplam_katki: 'cari_toplam_katki',
      genel_toplam_katki: 'genel_toplam_katki'
    };

    Object.entries(map).forEach(([src, destName]) => {
      const el = document.querySelector(`[name="${destName}"]`);
      if (!el) return;
      const val = data[src];
      el.value = (el.type === 'date')
        ? convertToInputDateFormat(val || '')
        : (val ?? '');
    });

    // BÃ¶lge deÄŸiÅŸince gizli alanÄ± da gÃ¼ncelle (formunla uyumluysa)
    const b = document.getElementById('bolge');
    if (b) {
      b.dispatchEvent(new Event('change'));
      const bh = document.getElementById('bolge_hidden');
      if (bh) bh.value = b.value;
    }

    // Ä°stersen otomatik AÅŸama 2â€™ye geÃ§
    if (typeof goToStep2 === 'function') goToStep2();
  }

  async function handleKVUpload(ev) {
    const file = ev.target.files?.[0];
    if (!file) return;

    // aynÄ± dosyayÄ± tekrar seÃ§ebilin
    ev.target.value = '';

    const fd = new FormData();
    fd.append('kv_pdf', file);

    // 1) Loading
    Swal.fire({
      title: 'YÃ¼kleniyor...',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    let resp;
    try {
      // (opsiyonel) timeout
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), 20000);

      const r = await fetch('{{ url_for("indirimlikurumlar.upload_kv_beyan") }}', {
        method: 'POST',
        body: fd,
        signal: ctrl.signal
      });

      clearTimeout(t);

      const ct = r.headers.get('content-type') || '';
      if (!ct.includes('application/json')) {
        const text = await r.text();
        throw new Error('Beklenmeyen yanÄ±t: ' + ct + ' / ' + text.slice(0, 200));
      }

      resp = await r.json();
    } catch (e) {
      Swal.close();
      Swal.fire('Hata', 'PDF yÃ¼klenirken aÄŸ/yanÄ±t hatasÄ± oluÅŸtu.', 'error');
      return;
    } finally {
      Swal.close();
    }

    console.log('KV upload resp:', resp);

    // 2) Mutlu yollar
    if (resp?.status === 'ok' && resp?.parsed) {
      fillFormWithParsedData(resp.parsed);
      await Swal.fire('Tamam', 'PDFâ€™den bilgiler aktarÄ±ldÄ±.', 'success');
      return;
    }

    if (resp.status === 'multiple' && Array.isArray(resp.raw_data) && resp.raw_data.length) {
      // SeÃ§enekleri hazÄ±rla
      const inputOptions = {};
      resp.raw_data.forEach((item, i) => {
        const no = (item.belge_no || `Belge ${i + 1}`).toString().trim();
        const karar = item.karar ? ` â€¢ ${item.karar}` : '';
        const tarih = item.belge_tarihi ? ` â€¢ ${item.belge_tarihi}` : '';
        inputOptions[i] = `${no}${karar}${tarih}`;
      });

      // KullanÄ±cÄ±ya sor
      const { value: idx } = await Swal.fire({
        title: 'Hangi teÅŸvik belgesini iÃ§e aktarmak istersiniz?',
        input: 'select',
        inputOptions,
        inputPlaceholder: 'SeÃ§iniz',
        showCancelButton: true,
        confirmButtonText: 'SeÃ§',
        cancelButtonText: 'Ä°ptal'
      });

      if (idx !== undefined) {
        fillFormWithParsedData(resp.raw_data[Number(idx)]);
        Swal.fire('Tamam', 'PDFâ€™den bilgiler aktarÄ±ldÄ±.', 'success');
      }
      return;
    }


    // 3) Ã–zel: KV sayfasÄ±/tablosu bulunamadÄ± senaryosu
    if (
      resp.status === 'not_found' ||     // backend bÃ¶yle dÃ¶nÃ¼yorsa
      resp.status === 'no_kv' ||     // â€¦veya bu
      resp.status === 'empty' ||     // â€¦veya bu
      (resp.status === 'multiple' && (!resp.raw_data || !resp.raw_data.length || !resp.tablolar || !resp.tablolar.length)) ||
      (resp.status === 'ok' && !resp.parsed)
    ) {
      Swal.fire('BulunamadÄ±', 'YÃ¼klediÄŸiniz PDFâ€™de â€œÄ°ndirimli Kurumlarâ€ bÃ¶lÃ¼mÃ¼ tespit edilemedi.', 'warning');
      return;
    }

    // 4) DiÄŸer tÃ¼m hatalar
    Swal.fire('Hata', resp.message || 'PDF verisi iÅŸlenemedi.', 'error');
  }




  // --- 2025/9903 MODU HESAPLAMALARI (TAM VE DENGELÄ° SÃœRÃœM) ---

 window.hesaplaKatkiTutari9903Form = function () {
  const karar = document.getElementById("karar")?.value;
  if (karar !== "2025/9903") return;

  const toplamInput = document.getElementById("toplam_tutar");
  const oranInput = document.getElementById("katki_orani");
  const katkiTutariInput = document.getElementById("katki_tutari");
  const donemInput = document.getElementById("donem");
  const baslangicYilInput = document.getElementById("baslangic_yili");

  if (!toplamInput || !oranInput || !katkiTutariInput) return;

  const toplam = parseFormattedNumber(toplamInput.value);
  const oran = parseFormattedNumber(oranInput.value);
  if (isNaN(toplam) || isNaN(oran)) {
    katkiTutariInput.value = "";
    return;
  }

  // 1ï¸âƒ£ Hesap dÃ¶nemi verileri
  const donemYil = parseInt((donemInput?.value || "").split(" - ")[0]) || 0;
  const baslangicYil = parseInt(baslangicYilInput?.value || "0");
  const donemFarki = (baslangicYil && donemYil) ? (donemYil - baslangicYil) : 0;

  // 2ï¸âƒ£ 10 hesap dÃ¶nemi sÄ±nÄ±rÄ± (yatÄ±rÄ±m kazancÄ±)
  if (baslangicYil && donemFarki >= 10) {
    Swal.fire({
      icon: "warning",
      title: "10 Hesap DÃ¶nemi SÄ±nÄ±rÄ±",
      html: "YatÄ±rÄ±mdan elde edilen kazanÃ§larda indirimli kurumlar vergisi uygulanabilecek sÃ¼re dolmuÅŸtur.",
      confirmButtonText: "Tamam"
    });
    document.getElementById('cari_yatirim_katki').value = "0,00";
    return;
  }

  // 3ï¸âƒ£ KatkÄ± tutarÄ± = yatÄ±rÄ±m Ã— katkÄ± oranÄ±
  const katkÄ±TutarÄ± = toplam * oran / 100;
  katkiTutariInput.value = katkÄ±TutarÄ±.toLocaleString("tr-TR", { minimumFractionDigits: 2 });

  // 4ï¸âƒ£ 4 hesap dÃ¶nemi bilgilendirme (diÄŸer faaliyetler iÃ§in)
  if (baslangicYil && donemFarki >= 4) {
    Swal.fire({
      icon: "info",
      title: "4 Hesap DÃ¶nemi Bilgilendirmesi",
      html: "DiÄŸer faaliyet kazanÃ§larÄ±na indirimli kurumlar vergisi uygulama sÃ¼resi dolmak Ã¼zeredir.",
      confirmButtonText: "Tamam"
    });
  }

  // 5ï¸âƒ£ Ana hesaplama fonksiyonunu Ã§aÄŸÄ±r (tek adÄ±m)
  if (typeof window.hesaplaKatkiTutari9903 === "function") {
    window.hesaplaKatkiTutari9903();
  }

  // 6ï¸âƒ£ Devredememe kontrolÃ¼
  const tevsiKazanc = parseFormattedNumber(document.getElementById('tevsi_yatirim_kazanci')?.value) || 0;
  const cariYatirimKatkisiVal = parseFormattedNumber(document.getElementById('cari_yatirim_katki')?.value) || 0;

  if (tevsiKazanc > 0 && cariYatirimKatkisiVal === 0) {
    Swal.fire({
      icon: "info",
      title: "KullanÄ±lmayan KatkÄ± Devredilemez",
      html: "KazanÃ§ bulunmasÄ±na raÄŸmen bu dÃ¶nemde katkÄ± kullanÄ±lmamÄ±ÅŸ. Bu tutar sonraki dÃ¶nemlere devredilemez.",
      confirmButtonText: "AnladÄ±m"
    });
  }
}



  // ğŸ”¹ Hak edilen katkÄ± tutarÄ± (gerÃ§ekleÅŸen yatÄ±rÄ±m harcamasÄ±na gÃ¶re)
  window.hesaplaFiiliKatkiTutari9903 = function () {
    const karar = document.getElementById("karar")?.value;
    if (karar !== "2025/9903") return;

    const harcamaInput = document.getElementById("toplam_harcama_tutari");
    const oranInput = document.getElementById("katki_orani");
    const fiiliKatkiTutariInput = document.getElementById("fiili_katki_tutari");

    if (!harcamaInput || !oranInput || !fiiliKatkiTutariInput) return;

    const harcama = parseFormattedNumber(harcamaInput.value);
    const oran = parseFormattedNumber(oranInput.value);

    if (isNaN(harcama) || isNaN(oran)) {
      fiiliKatkiTutariInput.value = "";
      return;
    }

    const sonuc = harcama * oran / 100;
    fiiliKatkiTutariInput.value = sonuc.toLocaleString("tr-TR", { minimumFractionDigits: 2 });
  }


  // ğŸ”¸ DiÄŸer faaliyetlerden yararlanÄ±labilecek katkÄ± tutarÄ±
  window.hesaplaDigerKatkiTutari9903 = function () {
    const karar = document.getElementById("karar")?.value;
    if (karar !== "2025/9903") return;

    const donemVal = document.getElementById('donem')?.value || '';
    const donemYil4 = parseInt(donemVal.split(' - ')[0]) || 0;
    const baslangicYil4 = parseInt(document.getElementById('baslangic_yili')?.value || '0');
    const donemFarki4 = (baslangicYil4 && donemYil4) ? (donemYil4 - baslangicYil4) : 0;

    // 1ï¸âƒ£ 4 hesap dÃ¶nemi sÄ±nÄ±rÄ± (diÄŸer faaliyetler)
    if (baslangicYil4 && donemFarki4 >= 4) {
      Swal.fire({
        icon: "warning",
        title: "4 Hesap DÃ¶nemi SÄ±nÄ±rÄ±",
        html: "DiÄŸer faaliyet kazanÃ§larÄ±na indirimli kurumlar vergisi uygulanabilecek dÃ¶nem sona erdi.",
        confirmButtonText: "Tamam"
      });
      const digerKatkiTutariInput = document.getElementById('diger_katki_tutari');
      if (digerKatkiTutariInput) digerKatkiTutariInput.value = "0,00";
      return;
    }

    const katkiInput = document.getElementById("katki_tutari");
    const digerOranInput = document.getElementById("diger_oran");
    const digerKatkiTutariInput = document.getElementById("diger_katki_tutari");
    const fiiliKatkiTutariInput = document.getElementById("fiili_katki_tutari");

    if (!katkiInput || !digerOranInput || !digerKatkiTutariInput) return;

    const katki = parseFormattedNumber(katkiInput.value);
    const digerOran = parseFormattedNumber(digerOranInput.value);
    const fiiliKatki = parseFormattedNumber(fiiliKatkiTutariInput?.value);

    if (isNaN(katki) || isNaN(digerOran)) {
      digerKatkiTutariInput.value = "";
      return;
    }

    // 2ï¸âƒ£ Hesaplama
    let sonuc = katki * digerOran / 100;

    // 3ï¸âƒ£ Ã‡ifte tavan kontrolÃ¼
    const toplamKatkiTutar = parseFormattedNumber(document.getElementById('katki_tutari')?.value) || 0;
    const hakEdilenKatki = parseFormattedNumber(document.getElementById('fiili_katki_tutari')?.value) || 0;

    // (a) %50 sÄ±nÄ±rÄ±
    const maxDiger = toplamKatkiTutar * 0.50;
    if (sonuc > maxDiger) {
      sonuc = maxDiger;
      Swal.fire({
        icon: "warning",
        title: "%50 SÄ±nÄ±rÄ±",
        html: "DiÄŸer faaliyetlere uygulanacak katkÄ±, toplam katkÄ±nÄ±n %50â€™sini aÅŸamaz. DeÄŸer sÄ±nÄ±rlandÄ±.",
        confirmButtonText: "Tamam"
      });
    }

    // (b) Hak edilen katkÄ± sÄ±nÄ±rÄ±
    if (hakEdilenKatki > 0 && sonuc > hakEdilenKatki) {
      sonuc = hakEdilenKatki;
      Swal.fire({
        icon: "warning",
        title: "Hak Edilen KatkÄ± SÄ±nÄ±rÄ±",
        html: "DiÄŸer faaliyetlerden kullanÄ±lacak katkÄ±, hak edilen katkÄ± tutarÄ±nÄ± aÅŸamaz. DeÄŸer sÄ±nÄ±rlandÄ±.",
        confirmButtonText: "AnladÄ±m"
      });
    }

    // 4ï¸âƒ£ Sonucu yazdÄ±r
    digerKatkiTutariInput.value = sonuc.toLocaleString("tr-TR", { minimumFractionDigits: 2 });
  }






  function hesaplaKatkiTutari() {
    // EÄŸer karar 2025/9903 ise â†’ Ã¶zel fonksiyona yÃ¶nlendir ve Ã§Ä±k
    if (document.getElementById("karar")?.value === "2025/9903") {
      hesaplaKatkiTutari9903Form();
      return;
    }
    const toplam = document.getElementById("toplam_tutar");
    const oran = document.getElementById("katki_orani");
    const katkiTutari = document.getElementById("katki_tutari");
    if (toplam && oran && katkiTutari) {
      const parsedToplam = parseFormattedNumber(toplam.value);
      const parsedOran = parseFormattedNumber(oran.value); // âœ…
      if (!isNaN(parsedToplam) && !isNaN(parsedOran)) {
        const tutar = parsedToplam * parsedOran / 100;
        katkiTutari.value = tutar.toLocaleString("tr-TR", { minimumFractionDigits: 2 });
        hesaplaDigerKatkiTutari();
      } else {
        katkiTutari.value = "";
      }
    }
  }

  function hesaplaDigerKatkiTutari() {
    // EÄŸer karar 2025/9903 ise â†’ Ã¶zel fonksiyona yÃ¶nlendir ve Ã§Ä±k
    if (document.getElementById("karar")?.value === "2025/9903") {
      hesaplaKatkiTutari9903Form();
      return;
    }
    const katkiInput = document.getElementById("katki_tutari");
    const digerOranInput = document.getElementById("diger_oran");
    const digerKatkiTutariInput = document.getElementById("diger_katki_tutari");

    if (katkiInput && digerOranInput && digerKatkiTutariInput) {
      const katki = parseFormattedNumber(katkiInput.value);
      const digerOranText = digerOranInput.value;

      const digerOran = parseFormattedNumber(digerOranText); // âœ… burasÄ± kritik
      if (!isNaN(katki) && !isNaN(digerOran)) {
        const sonuc = katki * digerOran / 100;
        digerKatkiTutariInput.value = sonuc.toLocaleString("tr-TR", { minimumFractionDigits: 2 });
      } else {
        digerKatkiTutariInput.value =
          digerOranText.includes("Ä°ÅLETME DÃ–NEMÄ°NDE HESAPLANMAZ") ? "Ä°ÅLETME DÃ–NEMÄ°NDE HESAPLANMAZ" : "";
      }
    }
  }

  function hesaplaFiiliKatkiTutari() {
    // EÄŸer karar 2025/9903 ise â†’ Ã¶zel fonksiyona yÃ¶nlendir ve Ã§Ä±k
    if (document.getElementById("karar")?.value === "2025/9903") {
      hesaplaKatkiTutari9903Form();
      return;
    }
    const toplamHarcamaInput = document.getElementById("toplam_harcama_tutari");
    const katkiOraniInput = document.getElementById("katki_orani");
    const fiiliKatkiTutariInput = document.getElementById("fiili_katki_tutari");

    if (toplamHarcamaInput && katkiOraniInput && fiiliKatkiTutariInput) {
      const fiilitoplam = parseFormattedNumber(toplamHarcamaInput.value);
      const oran = parseFormattedNumber(katkiOraniInput.value); // â† Ã¶nemli
      if (!isNaN(fiilitoplam) && !isNaN(oran)) {
        fiiliKatkiTutariInput.value = (fiilitoplam * oran / 100)
          .toLocaleString("tr-TR", { minimumFractionDigits: 2 });
      } else {
        fiiliKatkiTutariInput.value = "";
      }
    }
  }

  function hesaplaOncekiKatkiTutari() {
    const oncekiYatirimInput = document.getElementById("onceki_yatirim_katki_tutari");
    const oncekiDigerInput = document.getElementById("onceki_diger_katki_tutari");
    const oncekiKatkiInput = document.getElementById("onceki_katki_tutari");
    if (oncekiYatirimInput && oncekiDigerInput && oncekiKatkiInput) {
      const oncekiyatirim = parseFormattedNumber(oncekiYatirimInput.value);
      const oncekidiger = parseFormattedNumber(oncekiDigerInput.value);
      if (!isNaN(oncekiyatirim) && !isNaN(oncekidiger)) {
        const oncekikatki = oncekiyatirim + oncekidiger;
        oncekiKatkiInput.value = oncekikatki.toLocaleString("tr-TR", {
          minimumFractionDigits: 2
        });
      } else {
        oncekiKatkiInput.value = "";
      }
      hesaplaKalanVeEndeks();
    }
  }

  function hesaplaKalanVeEndeks() {
    const toplamKatkiInput = document.getElementById("katki_tutari");
    const oncekiKatkiInput = document.getElementById("onceki_katki_tutari");
    const vizeSelect = document.getElementById("vize_durumu");
    const yenidenDegerlemeOraniInput = document.getElementById("yeniden_degerleme_orani");
    const kalanKatkiInput = document.getElementById("kalan_katki_tutari");
    const endeksKatkiInput = document.getElementById("endeks_katki_tutari");
    if (!toplamKatkiInput || !oncekiKatkiInput || !vizeSelect || !yenidenDegerlemeOraniInput || !kalanKatkiInput || !endeksKatkiInput) {
      return;
    }
    const toplamKatki = parseFormattedNumber(toplamKatkiInput.value);
    const oncekiKatki = parseFormattedNumber(oncekiKatkiInput.value);
    const vize = vizeSelect.value;
    const ydoText = yenidenDegerlemeOraniInput.value;
    const ydo = parseFloat(ydoText.replace(',', '.'));
    const kalan = (!isNaN(toplamKatki) && !isNaN(oncekiKatki)) ? (toplamKatki - oncekiKatki) : 0;
    if (!isNaN(kalan)) {
      kalanKatkiInput.value = kalan.toLocaleString("tr-TR", {
        minimumFractionDigits: 2
      });
    } else {
      kalanKatkiInput.value = "";
    }
    if (vize.includes("Evet")) {
      if (!isNaN(kalan) && !isNaN(ydo)) {
        const endeksli = kalan * ydo / 100;
        endeksKatkiInput.value = endeksli.toLocaleString("tr-TR", {
          minimumFractionDigits: 2
        });
      } else {
        endeksKatkiInput.value = "";
      }
    } else {
      endeksKatkiInput.value = "YATIRIM DÃ–NEMÄ°NDE OLDUÄUNUZ Ä°Ã‡Ä°N ENDEKSLEME YAPILMAZ";
    }
  }

  function calculateRatios() {
    const useDetailedCheckbox = document.getElementById("useDetailedProfitRatios");
    const useDetailed = useDetailedCheckbox ? useDetailedCheckbox.checked : false;
    const brutInput = document.getElementById("brut_satis");
    const ihracatInput = document.getElementById("ihracat");
    const imalatInput = document.getElementById("imalat");
    const digerFaaliyetInput = document.getElementById("diger_faaliyet");
    const spanIhr = document.getElementById("ratio_ihracat");
    const spanIml = document.getElementById("ratio_imalat");
    const spanDig = document.getElementById("ratio_diger");
    if (!brutInput || !ihracatInput || !imalatInput || !digerFaaliyetInput || !spanIhr || !spanIml || !spanDig) return;
    if (useDetailed) {
      const savedC54 = sessionStorage.getItem('ayrintili_C54');
      const savedD54 = sessionStorage.getItem('ayrintili_D54');
      const savedE54 = sessionStorage.getItem('ayrintili_E54');
      if (savedC54 !== null && savedD54 !== null && savedE54 !== null) {
        spanIhr.textContent = savedC54;
        spanIml.textContent = savedD54;
        spanDig.textContent = savedE54;
      } else {
        spanIhr.textContent = initialRatios.C;
        spanIml.textContent = initialRatios.D;
        spanDig.textContent = initialRatios.E;
      }
    } else {
      const brut = parseFormattedNumber(brutInput.value) || 0;
      const ihracat = parseFormattedNumber(ihracatInput.value) || 0;
      const imalat = parseFormattedNumber(imalatInput.value) || 0;
      const diger = parseFormattedNumber(digerFaaliyetInput.value) || 0;
      let pctIhr = 0,
        pctIml = 0,
        pctDig = 0;
      if (brut > 0) {
        pctIhr = (ihracat / brut) * 100;
        pctIml = (imalat / brut) * 100;
        pctDig = (diger / brut) * 100;
      }
      spanIhr.textContent = brut ? pctIhr.toFixed(2).replace(".", ",") + "%" : "â€”%";
      spanIml.textContent = brut ? pctIml.toFixed(2).replace(".", ",") + "%" : "â€”%";
      spanDig.textContent = brut ? pctDig.toFixed(2).replace(".", ",") + "%" : "â€”%";
    }
    const ayrTable = document.getElementById('ayrintili-kazanc-table');
    if (ayrTable) {
      const updateCell = (rowIndex, col, text) => {
        const selector = `#ayrintili-kazanc-table tbody tr:nth-child(${rowIndex + 1}) input[name="${col}_${rowIndex}"]`;
        const inp = document.querySelector(selector);
        if (inp && inp.readOnly) {
          isProgrammaticChange = true;
          inp.value = text;
          isProgrammaticChange = false;
        }
      };
      updateCell(0, "B", "100%");
      updateCell(0, "C", spanIhr.textContent);
      updateCell(0, "D", spanIml.textContent);
      updateCell(0, "E", spanDig.textContent);
      const b53Input = document.querySelector(`input[name="B_53"]`);
      if (b53Input) {
        const C53 = parseFormattedNumber(document.querySelector(`input[name="C_53"]`).value) || 0;
        const D53 = parseFormattedNumber(document.querySelector(`input[name="D_53"]`).value) || 0;
        const E53 = parseFormattedNumber(document.querySelector(`input[name="E_53"]`).value) || 0;
        const B53 = parseFormattedNumber(b53Input.value) || 0;
        let pct2C = 0,
          pct2D = 0,
          pct2E = 0;
        if (B53 > 0) {
          pct2C = (C53 / B53) * 100;
          pct2D = (D53 / B53) * 100;
          pct2E = (E53 / B53) * 100;
        }
        updateCell(54, "B", "100%");
        updateCell(54, "C", pct2C.toFixed(2).replace(".", ",") + "%");
        updateCell(54, "D", pct2D.toFixed(2).replace(".", ",") + "%");
        updateCell(54, "E", pct2E.toFixed(2).replace(".", ",") + "%");
      }
    }
  }

  function calculateKVMatrah() {
    const t = parseFormattedNumber(document.getElementById('ticari_bilanco_kari')?.value);
    const k = parseFormattedNumber(document.getElementById('kkeg')?.value);
    const out = document.getElementById('kv_matrah');
    if (!out) return;
    const val = (t || 0) + (k || 0);
    out.value = (val || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2 });
  }

  function updateIKVAmountAndRate(ikvMatrah, ihrPct, imlPct, digPct, vergiIndirimOraniFraction) {
    // GÃ¼venli sayÄ±lar
    const matrah = Number(ikvMatrah) || 0;
    const pIhr = Number(ihrPct) || 0;   // 0..1
    const pIml = Number(imlPct) || 0;   // 0..1
    const pDig = Number(digPct) || 0;   // 0..1
    const pDisc = Number(vergiIndirimOraniFraction) || 0; // 0..1

    // Matrah kÄ±rÄ±lÄ±mÄ± (AÅŸama 6â€™daki satÄ±r mantÄ±ÄŸÄ±na uygun)
    const bespuan_matrah = matrah * pIhr; // Ä°hracat
    const birpuan_matrah = matrah * pIml; // Ä°malat
    const normal_matrah = matrah * pDig; // DiÄŸer + KKEG

    // Genel (indirimsiz) KV oranlarÄ±
    const rIhrGen = 0.20; // ihracat
    const rImlGen = 0.24; // imalat
    const rDigGen = 0.25; // diÄŸer

    // Ä°ndirimli efektif oranlar: r * (1 - indirim)
    const rIhrInd = rIhrGen * (1 - pDisc);
    const rImlInd = rImlGen * (1 - pDisc);
    const rDigInd = rDigGen * (1 - pDisc);

    // AÄŸÄ±rlÄ±klÄ± efektif oran (0..1)
    const effRate = (pIhr * rIhrInd) + (pIml * rImlInd) + (pDig * rDigInd);

    // Ä°ndirimli KV (Ã¶denecek vergi)
    const ikvAmount = matrah * effRate;

    // â€œÄ°ndirimli KV olmasaydÄ±â€ vergi (bilgi satÄ±rÄ± iÃ§in)
    const vergi_olsaydi = (bespuan_matrah * rIhrGen) + (birpuan_matrah * rImlGen) + (normal_matrah * rDigGen);

    // UI yaz
    const ikvEl = document.getElementById('indirimli_kv');
    const ikvRateEl = document.getElementById('indirimli_kv_oran');
    if (ikvEl) ikvEl.value = ikvAmount.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
    if (ikvRateEl) ikvRateEl.value = (effRate * 100).toFixed(2).replace('.', ',') + '%';

    // EÄŸer step7â€™de â€œÄ°ndirimli KV OlmasaydÄ± Hesaplanacak Vergiâ€ iÃ§in bir input eklersen (id: kv_olsaydi),
    // otomatik doldurur. (Yoksa sessizce geÃ§er.)
    const kvOlsaydiEl = document.getElementById('kv_olsaydi');
    if (kvOlsaydiEl) kvOlsaydiEl.value = vergi_olsaydi.toLocaleString('tr-TR', { minimumFractionDigits: 2 });

    // Gerekirse dÄ±ÅŸarÄ±da kullanman iÃ§in geri dÃ¶ndÃ¼r
    return {
      bespuan_matrah,  // ihracat matrahÄ±
      birpuan_matrah,  // imalat matrahÄ±
      normal_matrah,   // diÄŸer matrahÄ±
      vergi_olsaydi,
      effRate,
      ikvAmount
    };
  }


  function hesaplaKatkiTutari9903() {
    console.log("ğŸ”¹ hesaplaKatkiTutari9903() BAÅLADI");

    const karar = document.getElementById("karar")?.value;
    if (karar !== "2025/9903") return;

    // 1ï¸âƒ£ Girdi verileri
    const yatirimKazanci = parseFormattedNumber(document.getElementById('tevsi_yatirim_kazanci')?.value) || 0;
    const digerKazanc = parseFormattedNumber(document.getElementById('kv_matrah')?.value) || 0;
    const toplamYatirim = parseFormattedNumber(document.getElementById('toplam_tutar')?.value) || 0;
    const harcamaYatirim = parseFormattedNumber(document.getElementById('toplam_harcama_tutari')?.value) || 0;

    const katkiOrani = parseFormattedNumber(document.getElementById('katki_orani')?.value) / 100 || 0;
    const vergiIndirimOrani = parseFormattedNumber(document.getElementById('vergi_orani')?.value) / 100 || 0;
    const digerOran = parseFormattedNumber(document.getElementById('diger_oran')?.value) / 100 || 0;

    const oncekiToplamKatki = parseFormattedNumber(document.getElementById('onceki_katki_tutari')?.value) || 0;

    // 2ï¸âƒ£ KV oranlarÄ± (dinamik)
    const kvOranIhracat = parseFormattedNumber(document.getElementById('kv_oran_ihracat')?.value) / 100 || 0.20;
    const kvOranImalat = parseFormattedNumber(document.getElementById('kv_oran_imalat')?.value) / 100 || 0.24;
    const kvOranDiger = parseFormattedNumber(document.getElementById('kv_oran_diger')?.value) / 100 || 0.25;

    // 3ï¸âƒ£ Oran kaynaÄŸÄ±
    const useDetailedRatios = document.getElementById('useDetailedProfitRatios')?.checked || false;
    let ihracatOraniFinal = 0, imalatOraniFinal = 0, digerOraniFinal = 0;

    if (useDetailedRatios) {
      ihracatOraniFinal = parseFloat(document.getElementById('ratio_ihracat').textContent.replace('%', '').replace(',', '.')) / 100 || 0;
      imalatOraniFinal = parseFloat(document.getElementById('ratio_imalat').textContent.replace('%', '').replace(',', '.')) / 100 || 0;
      digerOraniFinal = parseFloat(document.getElementById('ratio_diger').textContent.replace('%', '').replace(',', '.')) / 100 || 0;
    } else {
      const brutSatis = parseFormattedNumber(document.getElementById('brut_satis')?.value) || 0;
      const ihracatSatis = parseFormattedNumber(document.getElementById('ihracat')?.value) || 0;
      const imalatSatis = parseFormattedNumber(document.getElementById('imalat')?.value) || 0;
      const digerSatis = parseFormattedNumber(document.getElementById('diger_faaliyet')?.value) || 0;

      if (brutSatis > 0) {
        ihracatOraniFinal = ihracatSatis / brutSatis;
        imalatOraniFinal = imalatSatis / brutSatis;
        digerOraniFinal = digerSatis / brutSatis;
      }
    }

    // 4ï¸âƒ£ Fark oranlarÄ± (KV - indirimli KV)
    const farkIhr = kvOranIhracat * vergiIndirimOrani;
    const farkIml = kvOranImalat * vergiIndirimOrani;
    const farkDig = kvOranDiger * vergiIndirimOrani;

    // 5ï¸âƒ£ KatkÄ± tabanlarÄ±
    const toplamKatki = toplamYatirim * katkiOrani;
    const hakEdilenKatki = harcamaYatirim * katkiOrani;
    const ustSinirDiger = toplamKatki * digerOran;

    // 6ï¸âƒ£ Cari dÃ¶nem katkÄ±lar (Ã¼Ã§ senaryo)
    let cariYatirimKatkisi = 0;
    let cariDigerKatkisi = 0;

    if (yatirimKazanci > 0 && digerKazanc === 0) {
      // ğŸ”¸ sadece yatÄ±rÄ±m kazancÄ± (Ã¶rnek 1 veya yatÄ±rÄ±m kÄ±smÄ±)
      cariYatirimKatkisi =
        (yatirimKazanci * ihracatOraniFinal * farkIhr) +
        (yatirimKazanci * imalatOraniFinal * farkIml) +
        (yatirimKazanci * digerOraniFinal * farkDig);

    } else if (yatirimKazanci === 0 && digerKazanc > 0) {
      // ğŸ”¸ yatÄ±rÄ±m henÃ¼z iÅŸletmede deÄŸil (Ã¶rnek 2â€“3)
      cariDigerKatkisi = Math.min(hakEdilenKatki, ustSinirDiger);

    } else if (yatirimKazanci > 0 && digerKazanc > 0) {
      // ğŸ”¸ kÄ±smen iÅŸletilen yatÄ±rÄ±m (Ã¶rnek 4)
      const yatirimKismi =
        (yatirimKazanci * ihracatOraniFinal * farkIhr) +
        (yatirimKazanci * imalatOraniFinal * farkIml) +
        (yatirimKazanci * digerOraniFinal * farkDig);

      const digerKismi = Math.min(hakEdilenKatki, ustSinirDiger);
      cariYatirimKatkisi = yatirimKismi;
      cariDigerKatkisi = digerKismi;
    }

    // 7ï¸âƒ£ Toplam katkÄ±lar
    const cariToplamKatki = cariYatirimKatkisi + cariDigerKatkisi;
    const genelToplamKatki = oncekiToplamKatki + cariToplamKatki;
    const kalanKatki = Math.max(0, toplamKatki - genelToplamKatki);

    // 8ï¸âƒ£ UIâ€™ya yaz
    document.getElementById('cari_yatirim_katki').value = cariYatirimKatkisi.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
    document.getElementById('cari_diger_katki').value = cariDigerKatkisi.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
    document.getElementById('cari_toplam_katki').value = cariToplamKatki.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
    document.getElementById('genel_toplam_katki').value = genelToplamKatki.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
    document.getElementById('kalan_katki_tutari').value = kalanKatki.toLocaleString('tr-TR', { minimumFractionDigits: 2 });

    console.log("--- hesaplaKatkiTutari9903() tamamlandÄ± ---", {
      yatirimKazanci,
      digerKazanc,
      cariYatirimKatkisi,
      cariDigerKatkisi,
      genelToplamKatki,
      kalanKatki
    });

    if (typeof _updateStepDisplay === "function") _updateStepDisplay(7);
  }




  function calculateCariAndNext() {
    const karar = document.getElementById("karar")?.value;

    // âœ… EÄŸer karar 2025/9903 ise iki aÅŸamalÄ± Ã¶zel hesap fonksiyonlarÄ±nÄ± Ã§aÄŸÄ±r
    if (karar === "2025/9903") {
      console.log("âš™ï¸ 2025/9903 aktif â€” Ã¶nce form hesapla, sonra detaylÄ± hesap baÅŸlatÄ±lÄ±yor");

      // 1ï¸âƒ£ Form tabanlÄ± hesaplama (dÃ¶nem kontrolÃ¼, %50 sÄ±nÄ±rÄ±, uyarÄ±lar vb.)
      if (typeof hesaplaKatkiTutari9903Form === "function") {
        hesaplaKatkiTutari9903Form();
      } else {
        console.warn("âš ï¸ hesaplaKatkiTutari9903Form() bulunamadÄ±!");
      }

      // 2ï¸âƒ£ DetaylÄ± hesaplama (oranlar, matrah, Step7 geÃ§iÅŸi)
      if (typeof hesaplaKatkiTutari9903 === "function") {
        hesaplaKatkiTutari9903();
      } else {
        console.warn("âš ï¸ hesaplaKatkiTutari9903() bulunamadÄ±!");
      }

      return; // ğŸš€ 9903 modu tamamen kendi akÄ±ÅŸÄ±nÄ± tamamlar, alttaki klasik akÄ±ÅŸa geÃ§me
    }

    // ğŸ”¹ DiÄŸer kararlar (klasik teÅŸvik hesaplama)
    console.log("--- calculateCariAndNext() BAÅLADI ---");

    const vizeDurumuElement = document.getElementById('vize_durumu');
    const vizeDurumuTercihi = vizeDurumuElement ? vizeDurumuElement.value : '';

    const digerKazancUygulama = sessionStorage.getItem('diger_kazanc_uygulama');
    const kucukOlanDigerFaaliyetTutari = parseFormattedNumber(sessionStorage.getItem('kucuk_olan_diger_faaliyet')) || 0;

    console.log("sessionStorage Tercihleri ve HTML Vize Durumu:");
    console.log("  vizeDurumuTercihi:", vizeDurumuTercihi);
    console.log("  digerKazancUygulama:", digerKazancUygulama);
    console.log("  kucukOlanDigerFaaliyetTutari (parsed):", kucukOlanDigerFaaliyetTutari);

    // DoÄŸrudan HTML inputlarÄ±ndan alÄ±nan deÄŸerler
    const tevsiYatirimKazanci = parseFormattedNumber(document.getElementById('tevsi_yatirim_kazanci').value);
    const vergiIndirimOrani = parseFormattedNumber(document.getElementById('vergi_orani').value) / 100;
    const oncekiToplamKatki = parseFormattedNumber(document.getElementById('onceki_katki_tutari').value);

    console.log("HTML Input DeÄŸerleri (parsed):", {
      tevsiYatirimKazanci,
      vergiIndirimOrani,
      oncekiToplamKatki
    });

    // OranlarÄ±n kaynaÄŸÄ± seÃ§imi
    const useDetailedRatiosCheckbox = document.getElementById('useDetailedProfitRatios');
    const useDetailedRatios = useDetailedRatiosCheckbox ? useDetailedRatiosCheckbox.checked : false;
    console.log("useDetailedProfitRatios (Checkbox):", useDetailedRatios);

    let ihracatOraniFinal = 0, imalatOraniFinal = 0, digerOraniFinal = 0;

    if (useDetailedRatios) {
      // span'den oku
      const spanIhr = document.getElementById('ratio_ihracat').textContent;
      const spanIml = document.getElementById('ratio_imalat').textContent;
      const spanDig = document.getElementById('ratio_diger').textContent;

      ihracatOraniFinal = parseFloat(spanIhr.replace('%', '').replace(',', '.')) / 100 || 0;
      imalatOraniFinal = parseFloat(spanIml.replace('%', '').replace(',', '.')) / 100 || 0;
      digerOraniFinal = parseFloat(spanDig.replace('%', '').replace(',', '.')) / 100 || 0;

      console.log("Oran KaynaÄŸÄ±: AyrÄ±ntÄ±lÄ± KazanÃ§ Tablosu (span)");
    } else {
      // manuel satÄ±ÅŸ giriÅŸleri
      const brutSatis = parseFormattedNumber(document.getElementById('brut_satis').value) || 0;
      const ihracatSatis = parseFormattedNumber(document.getElementById('ihracat').value) || 0;
      const imalatSatis = parseFormattedNumber(document.getElementById('imalat').value) || 0;
      const digerSatis = parseFormattedNumber(document.getElementById('diger_faaliyet').value) || 0;

      if (brutSatis > 0) {
        ihracatOraniFinal = ihracatSatis / brutSatis;
        imalatOraniFinal = imalatSatis / brutSatis;
        digerOraniFinal = digerSatis / brutSatis;
      }
      console.log("Oran KaynaÄŸÄ±: Manuel SatÄ±ÅŸ GiriÅŸleri");
    }

    console.log("Nihai Oranlar (OndalÄ±k):", {
      ihracatOraniFinal, imalatOraniFinal, digerOraniFinal
    });

    // Sabit KV oranlarÄ±
    const kvOranIhracat = 0.20;
    const kvOranImalat = 0.24;
    const kvOranDiger = 0.25;

    let cariYatirimKatkisi = 0;
    let cariDigerKatkisi = 0;
    let indirimliKurumlarVergisiMatrahi = 0;

    // Senaryo seÃ§imleri
    if (vizeDurumuTercihi.includes("Evet")) {
      console.log("Senaryo: Tamamlama Vizesi -> EVET (Ä°ÅŸletme DÃ¶nemi)");

      indirimliKurumlarVergisiMatrahi = tevsiYatirimKazanci;
      cariYatirimKatkisi =
        (tevsiYatirimKazanci * ihracatOraniFinal * kvOranIhracat * vergiIndirimOrani) +
        (tevsiYatirimKazanci * imalatOraniFinal * kvOranImalat * vergiIndirimOrani) +
        (tevsiYatirimKazanci * digerOraniFinal * kvOranDiger * vergiIndirimOrani);
      cariDigerKatkisi = 0;

    } else if (vizeDurumuTercihi.includes("HayÄ±r")) {
      console.log("Senaryo: Tamamlama Vizesi -> HAYIR (YatÄ±rÄ±m DÃ¶nemi)");

      if (digerKazancUygulama === "evet") {
        console.log("  Alt Senaryo: DiÄŸer faaliyetlerden indirim -> EVET");

        const kvMatrah = parseFormattedNumber(document.getElementById('kv_matrah')?.value) || 0;
        const kalanKatki = parseFormattedNumber(document.getElementById('kalan_katki_tutari')?.value) || 0;
        const mevzuatTavani = kucukOlanDigerFaaliyetTutari || 0;

        const effRate =
          (ihracatOraniFinal * (0.20 * (1 - vergiIndirimOrani))) +
          (imalatOraniFinal * (0.24 * (1 - vergiIndirimOrani))) +
          (digerOraniFinal * (0.25 * (1 - vergiIndirimOrani)));

        const kvTavanVergi = effRate > 0 ? (kvMatrah * effRate) : 0;
        const cariDigerKatkisiHesap = Math.min(kalanKatki, mevzuatTavani, kvTavanVergi);

        cariDigerKatkisi = Math.max(0, cariDigerKatkisiHesap);
        indirimliKurumlarVergisiMatrahi = (effRate > 0) ? (cariDigerKatkisi / effRate) : 0;
        cariYatirimKatkisi = 0;

      } else {
        console.log("  Alt Senaryo: DiÄŸer faaliyetlerden indirim -> HAYIR");

        indirimliKurumlarVergisiMatrahi = tevsiYatirimKazanci;
        cariYatirimKatkisi =
          (tevsiYatirimKazanci * ihracatOraniFinal * kvOranIhracat * vergiIndirimOrani) +
          (tevsiYatirimKazanci * imalatOraniFinal * kvOranImalat * vergiIndirimOrani) +
          (tevsiYatirimKazanci * digerOraniFinal * kvOranDiger * vergiIndirimOrani);
        cariDigerKatkisi = 0;
      }
    }

    // Hesaplama sonuÃ§larÄ±
    console.log("--- Hesaplama SonuÃ§larÄ± ---", {
      cariYatirimKatkisi,
      cariDigerKatkisi,
      indirimliKurumlarVergisiMatrahi
    });

    document.getElementById('cari_yatirim_katki').value = cariYatirimKatkisi.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
    document.getElementById('cari_diger_katki').value = cariDigerKatkisi.toLocaleString('tr-TR', { minimumFractionDigits: 2 });

    const cariToplamKatki = cariYatirimKatkisi + cariDigerKatkisi;
    document.getElementById('cari_toplam_katki').value = cariToplamKatki.toLocaleString('tr-TR', { minimumFractionDigits: 2 });

    const genelToplamKatki = oncekiToplamKatki + cariToplamKatki;
    document.getElementById('genel_toplam_katki').value = genelToplamKatki.toLocaleString('tr-TR', { minimumFractionDigits: 2 });

    document.getElementById('indirimli_matrah').value = indirimliKurumlarVergisiMatrahi.toLocaleString('tr-TR', { minimumFractionDigits: 2 });

    // Ä°ndirimli KV tutarÄ± ve efektif oran
    updateIKVAmountAndRate(
      indirimliKurumlarVergisiMatrahi,
      ihracatOraniFinal, imalatOraniFinal, digerOraniFinal,
      vergiIndirimOrani
    );

    console.log("--- calculateCariAndNext() BÄ°TTÄ°, _updateStepDisplay(7) Ã§aÄŸrÄ±lÄ±yor ---");
    _updateStepDisplay(7);
  }






  // --- AyrÄ±ntÄ±lÄ± KazanÃ§ Tablosu HesaplamasÄ± ---
  function calculateTable(event) {
    const ayrTable = document.getElementById('ayrintili-kazanc-table');
    if (!ayrTable) return;

    const tableData = [];
    ayrTable.querySelectorAll('tbody tr').forEach((rowEl, rowIndex) => {
      const rowVals = {};
      rowEl.querySelectorAll('input').forEach(input => {
        const [col] = input.name.split('_');
        rowVals[col] = parseFormattedNumber(input.value);
      });
      tableData[rowIndex] = rowVals;
    });

    if (event && event.target) {
      const [col, rowStr] = event.target.name.split('_');
      const rowIdx = parseInt(rowStr, 10);
      if ((rowIdx === 20 || rowIdx === 21) && col === 'B') {
        const b = tableData[rowIdx].B;
        const pctC = tableData[0].C / 100;
        const pctD = tableData[0].D / 100;
        const pctE = tableData[0].E / 100;
        ['C', 'D', 'E'].forEach((c, i) => {
          const v = b * [pctC, pctD, pctE][i];
          tableData[rowIdx][c] = v;
          // Programatik atamada sonsuz dÃ¶ngÃ¼yÃ¼ Ã¶nleyin
          const inp = document.querySelector(`input[name="${c}_${rowIdx}"]`);
          if (inp) {
            isProgrammaticChange = true; // BayraÄŸÄ± ayarla
            inp.value = v.toLocaleString('tr-TR', {
              minimumFractionDigits: 2
            });
            isProgrammaticChange = false; // BayraÄŸÄ± sÄ±fÄ±rla
          }
        });
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(saveDetailedProfitData, 1500);
        return;
      }
    }

    for (let i = 2; i <= 4; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[1][col] = tableData[2][col] + tableData[3][col] + tableData[4][col];
    });
    const toplamH = tableData[1].B;

    if (toplamH > 0) {
      tableData[0].B = 100;
      ['C', 'D', 'E'].forEach(col => {
        tableData[0][col] = parseFloat(((tableData[1][col] / toplamH) * 100).toFixed(2));
      });
    } else {
      tableData[0] = {
        B: 100,
        C: 0,
        D: 0,
        E: 0
      };
    }

    for (let i = 6; i <= 8; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[5][col] = tableData[6][col] + tableData[7][col] + tableData[8][col];
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[9][col] = tableData[1][col] - tableData[5][col];
    });

    for (let i = 11; i <= 14; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[10][col] =
        tableData[11][col] +
        tableData[12][col] +
        tableData[13][col] +
        tableData[14][col];
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[15][col] = tableData[9][col] - tableData[10][col];
    });

    for (let i = 17; i <= 19; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[16][col] = tableData[17][col] + tableData[18][col] + tableData[19][col];
    });

    [20, 21].forEach(r => {
      const b = tableData[r].B;
      tableData[r].C = b * (tableData[0].C / 100);
      tableData[r].D = b * (tableData[0].D / 100);
      tableData[r].E = b * (tableData[0].E / 100);
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[16][col] =
        tableData[17][col] +
        tableData[18][col] +
        tableData[19][col] +
        tableData[20][col] +
        tableData[21][col];
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[22][col] = tableData[15][col] - tableData[16][col];
    });

    for (let i = 24; i <= 33; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      let sum = 0;
      for (let i = 24; i <= 33; i++) sum += tableData[i][col];
      tableData[23][col] = sum;
    });

    for (let i = 35; i <= 41; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      let sum = 0;
      for (let i = 35; i <= 41; i++) sum += tableData[i][col];
      tableData[34][col] = sum;
    });

    for (let i = 43; i <= 44; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[42][col] = tableData[43][col] + tableData[44][col];
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[45][col] =
        tableData[22][col] +
        tableData[23][col] -
        tableData[34][col] -
        tableData[42][col];
    });

    for (let i = 47; i <= 48; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[46][col] = tableData[47][col] + tableData[48][col];
    });

    for (let i = 50; i <= 52; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[49][col] = tableData[50][col] + tableData[51][col] + tableData[52][col];
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[53][col] =
        tableData[45][col] +
        tableData[46][col] -
        tableData[49][col];
    });

    const B53 = tableData[53].B,
      C53 = tableData[53].C,
      D53 = tableData[53].D,
      E53 = tableData[53].E;
    let pct2C = 0,
      pct2D = 0,
      pct2E = 0;
    if (B53 > 0) {
      pct2C = (C53 / B53) * 100;
      pct2D = (D53 / B53) * 100;
      pct2E = (E53 / B53) * 100;
    }
    tableData[54].B = 100;
    tableData[54].C = parseFloat(pct2C.toFixed(2));
    tableData[54].D = parseFloat(pct2D.toFixed(2));
    tableData[54].E = parseFloat(pct2E.toFixed(2));

    ayrTable.querySelectorAll('tbody tr').forEach((rowEl, idx) => {
      rowEl.querySelectorAll('input').forEach(input => {
        const [col] = input.name.split('_');
        if (input.readOnly) {
          // isProgrammaticChange bayraÄŸÄ±nÄ± kullanarak sonsuz dÃ¶ngÃ¼yÃ¼ Ã¶nleyin
          isProgrammaticChange = true;
          let v = tableData[idx][col];
          if (idx === 0 || idx === 54) {
            v = v.toFixed(2).replace('.', ',') + '%';
            if (col === 'B') v = '100%';
          } else {
            v = v.toLocaleString('tr-TR', {
              minimumFractionDigits: 2
            });
          }
          input.value = v; // DeÄŸer atamasÄ±
          isProgrammaticChange = false; // BayraÄŸÄ± sÄ±fÄ±rla
        }
      });
    });

    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(saveDetailedProfitData, 1500);
  }

  // Tevsi YatÄ±rÄ±m KazancÄ± Otomatik Hesaplama Fonksiyonu
  function calculateTevsiKazancAutomatically() {
    const gerceklesenTevsiElement = document.getElementById('gerceklesen_tevsi_yatirim_tutari');
    const toplamSabitKiymetElement = document.getElementById('toplam_sabit_kiymet_tutari');
    const ticariBilancoKariElement = document.getElementById('ticari_bilanco_kari');
    const tevsiKazancTargetElement = document.getElementById('tevsi_yatirim_kazanci'); // Bu element aslÄ±nda hesaplanan deÄŸeri gÃ¶sterecek input

    if (!gerceklesenTevsiElement || !toplamSabitKiymetElement || !ticariBilancoKariElement || !tevsiKazancTargetElement) {
      console.error("calculateTevsiKazancAutomatically: Tevsi kazanÃ§ hesaplama iÃ§in gerekli elementler bulunamadÄ±!");
      return;
    }

    const gerceklesenTevsi = parseFormattedNumber(gerceklesenTevsiElement.value);
    const toplamSabitKiymet = parseFormattedNumber(toplamSabitKiymetElement.value);
    const ticariBilancoKari = parseFormattedNumber(ticariBilancoKariElement.value);

    let calculatedKazanc = 0;
    if (toplamSabitKiymet !== 0) {
      calculatedKazanc = (gerceklesenTevsi / toplamSabitKiymet) * ticariBilancoKari;
    } else if (gerceklesenTevsi !== 0 || ticariBilancoKari !== 0) {
      // EÄŸer toplam sabit kÄ±ymet 0 ama diÄŸerleri 0 deÄŸilse (tanÄ±msÄ±z durumlar iÃ§in)
      calculatedKazanc = 0;
    }


    if (typeof tevsiMask !== 'undefined' && tevsiMask && tevsiMask.el === tevsiKazancTargetElement) {
      tevsiMask.unmaskedValue = String(calculatedKazanc);
      tevsiMask.updateValue();
    } else {
      tevsiKazancTargetElement.value = calculatedKazanc.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
    }
  }



  // YardÄ±mcÄ± fonksiyonlar: Her bir SweetAlert zincirini ayrÄ± ayrÄ± tanÄ±mla
  function askTevsiKazancQuestion() {
    Swal.fire({
      title: 'Tevsi YatÄ±rÄ±m Bilgisi',
      html: '<div style="text-align: justify;">Tevsi YatÄ±rÄ±mlardan elde edilen kazancÄ± ayrÄ± bir ÅŸekilde tespit edebiliyor musunuz?</div>',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Evet',
      cancelButtonText: 'HayÄ±r',
      reverseButtons: true,
      customClass: {
        popup: 'swal2-green-theme-popup',
        header: 'swal2-green-theme-header',
        title: 'swal2-green-theme-title',
        icon: 'swal2-green-theme-icon',
        confirmButton: 'swal2-green-theme-confirm-button',
        cancelButton: 'swal2-green-theme-cancel-button',
        htmlContainer: 'swal2-green-theme-html-container'
      }
    }).then((result) => {
      if (result.isConfirmed) { // KullanÄ±cÄ± "Evet" dedi (Tevsi kazancÄ±nÄ± ayrÄ± tespit ediyor)
        Swal.fire({
          title: 'Tevsi YatÄ±rÄ±mlardan Elde Edilen KazanÃ§ TutarÄ±nÄ± Giriniz (TL)',
          input: 'text',
          inputPlaceholder: '0,00 TL',
          showCancelButton: true,
          confirmButtonText: 'Tamam',
          cancelButtonText: 'VazgeÃ§',
          reverseButtons: true,
          customClass: {
            popup: 'swal2-green-theme-popup',
            header: 'swal2-green-theme-header',
            title: 'swal2-green-theme-title',
            icon: 'swal2-green-theme-icon',
            confirmButton: 'swal2-green-theme-confirm-button',
            cancelButton: 'swal2-green-theme-cancel-button',
            htmlContainer: 'swal2-green-theme-html-container'
          },
          inputValidator: (value) => {
            if (!value) {
              return 'Bir tutar girmelisiniz!';
            }
            if (isNaN(parseFormattedNumber(value))) {
              return 'GeÃ§erli bir sayÄ± girmelisiniz!';
            }
            return null;
          }
        }).then((inputResult) => {
          if (inputResult.isConfirmed && inputResult.value) {
            const enteredAmount = parseFormattedNumber(inputResult.value);
            document.getElementById('tevsi_yatirim_kazanci').value = enteredAmount.toLocaleString('tr-TR', {
              minimumFractionDigits: 2
            });
            // Bu durumda otomatik tevsi kazanÃ§ hesaplamasÄ±nÄ± kapatmak iÃ§in alanlarÄ± temizle
            document.getElementById('gerceklesen_tevsi_yatirim_tutari').value = '';
            document.getElementById('toplam_sabit_kiymet_tutari').value = '';
            document.getElementById('ticari_bilanco_kari').value = '';
          } else if (inputResult.dismiss === Swal.DismissReason.cancel) {
            document.getElementById('tevsi_yatirim_kazanci').value = ''; // Ä°ptal edilirse temizle
          }
          _updateStepDisplay(5); // Tevsi YatÄ±rÄ±m aÅŸamasÄ±na geÃ§ (manuel giriÅŸ ile)
        });
      } else if (result.dismiss === Swal.DismissReason.cancel) { // KullanÄ±cÄ± "HayÄ±r" dedi (Tevsi kazancÄ±nÄ± ayrÄ± tespit edemiyor)
        Swal.fire({
          title: 'Bilgilendirme',
          html: '<div style="text-align: justify;">GerÃ§ekleÅŸen Tevsi YatÄ±rÄ±m TutarÄ±nÄ±, Toplam Sabit KÄ±ymet TutarÄ±nÄ± ve Ticari BilanÃ§o KarÄ±nÄ± Girmeyi unutmayÄ±nÄ±z.</div>',
          icon: 'info',
          showConfirmButton: true,
          confirmButtonText: 'Tamam',
          showCancelButton: false,
          customClass: {
            popup: 'swal2-green-theme-popup',
            header: 'swal2-green-theme-header',
            title: 'swal2-green-theme-title',
            icon: 'swal2-green-theme-icon',
            confirmButton: 'swal2-green-theme-confirm-button',
            htmlContainer: 'swal2-green-theme-html-container'
          }
        }).then(() => {
          document.getElementById('tevsi_yatirim_kazanci').value = ''; // Otomatik hesaplama iÃ§in alanÄ± temizle
          _updateStepDisplay(5); // Tevsi YatÄ±rÄ±m aÅŸamasÄ±na geÃ§ (otomatik hesaplama ile)
        });
      }
    });
  }

  function askOtherActivitiesDiscountQuestion() {
    Swal.fire({
      title: 'DiÄŸer Faaliyetler',
      html: '<div style="text-align: justify;">DiÄŸer faaliyetlerden elde ettiÄŸiniz kazanÃ§larÄ±nÄ±za indirimli kurumlar vergisi uygulamak istiyor musunuz?</div>',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Evet, istiyorum.',
      cancelButtonText: 'HayÄ±r, istemiyorum.',
      reverseButtons: true,
      customClass: {
        popup: 'swal2-green-theme-popup',
        header: 'swal2-green-theme-header',
        title: 'swal2-green-theme-title',
        icon: 'swal2-green-theme-icon',
        confirmButton: 'swal2-green-theme-confirm-button',
        cancelButton: 'swal2-green-theme-cancel-button',
        htmlContainer: 'swal2-green-theme-html-container'
      }
    }).then((result) => {
      if (result.isConfirmed) {
        // â€œEvetâ€ dedi
        sessionStorage.setItem('diger_kazanc_uygulama', 'evet');
        askSmallestAmountQuestionForOtherActivities();
      } else {
        // â€œHayÄ±râ€ veya iptal
        sessionStorage.setItem('diger_kazanc_uygulama', 'hayir');
        // Ã–nceki kÄ±sÄ±tlÄ± deÄŸeri temizle (isteÄŸe baÄŸlÄ±)
        sessionStorage.removeItem('kucuk_olan_diger_faaliyet');
        askTevsiKazancQuestion();
      }
    });
  }

  function askSmallestAmountQuestionForOtherActivities() {
    // Gerekli deÄŸerleri DOM'dan veya mevcut hesaplamalardan alalÄ±m
    const digerKatkiTutariElement = document.getElementById('diger_katki_tutari');
    const toplamHarcamaTutariElement = document.getElementById('toplam_harcama_tutari');

    // Elementlerin varlÄ±ÄŸÄ±nÄ± kontrol et, yoksa varsayÄ±lan deÄŸer kullan
    const digerKatkiTutari = digerKatkiTutariElement ? parseFormattedNumber(digerKatkiTutariElement.value) : 0;
    const toplamHarcamaTutari = toplamHarcamaTutariElement ? parseFormattedNumber(toplamHarcamaTutariElement.value) : 0;

    let kucukOlanDeger;

    // KÃ¼Ã§Ã¼k olan deÄŸeri bulma mantÄ±ÄŸÄ±
    if (digerKatkiTutari === 0 && toplamHarcamaTutari === 0) {
      kucukOlanDeger = 0; // Her iki deÄŸer de sÄ±fÄ±rsa kÃ¼Ã§Ã¼k olan da sÄ±fÄ±rdÄ±r.
    } else if (digerKatkiTutari === 0) {
      kucukOlanDeger = toplamHarcamaTutari; // DiÄŸer katkÄ± sÄ±fÄ±rsa, toplam harcama kÃ¼Ã§Ã¼ktÃ¼r.
    } else if (toplamHarcamaTutari === 0) {
      kucukOlanDeger = digerKatkiTutari; // Toplam harcama sÄ±fÄ±rsa, diÄŸer katkÄ± kÃ¼Ã§Ã¼ktÃ¼r.
    } else {
      kucukOlanDeger = Math.min(digerKatkiTutari, toplamHarcamaTutari); // Ä°ki deÄŸerden kÃ¼Ã§Ã¼k olanÄ± seÃ§.
    }

    // Hesaplanan kÃ¼Ã§Ã¼k deÄŸeri sessionStorage'a kaydet
    sessionStorage.setItem('kucuk_olan_diger_faaliyet', kucukOlanDeger);

    // DiÄŸer faaliyetlere indirim uygulanacaksa tevsi yatÄ±rÄ±m alanlarÄ±nÄ± sÄ±fÄ±rla
    // Bu, Ã¶nceki SweetAlert zincirinde de yapÄ±lÄ±yordu, burada tekrar edilmesi garanti saÄŸlar.
    document.getElementById('gerceklesen_tevsi_yatirim_tutari').value = '';
    document.getElementById('toplam_sabit_kiymet_tutari').value = '';
    document.getElementById('ticari_bilanco_kari').value = '';
    document.getElementById('tevsi_yatirim_kazanci').value = '';

    // KullanÄ±cÄ±ya SweetAlert ile bilgilendirme mesajÄ± gÃ¶ster
    Swal.fire({
      title: 'Otomatik Hesaplama YapÄ±ldÄ±!',
      html: `<div style="text-align: justify;">DiÄŸer faaliyetlerinizden elde ettiÄŸiz kazanÃ§larÄ±nÄ±za uygulanabilecek maksimum indirimli kurumlar vergisi tutarÄ±:<br><br><b>${kucukOlanDeger.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} TL</b></div>`,
      icon: 'info', // Bilgilendirme ikonu kullan
      showConfirmButton: true, // "Tamam" butonu gÃ¶ster
      confirmButtonText: 'Tamam',
      customClass: {
        popup: 'swal2-green-theme-popup',
        header: 'swal2-green-theme-header',
        title: 'swal2-green-theme-title',
        icon: 'swal2-green-theme-icon',
        confirmButton: 'swal2-green-theme-confirm-button',
        htmlContainer: 'swal2-green-theme-html-container'
      }
    }).then(() => {
      // 6â€™ya geÃ§meden Ã¶nce Ticari KÃ¢r + KKEGâ€™yi iste
      if (typeof promptTicariKariVeKKEGThenGoTo6 === 'function') {
        promptTicariKariVeKKEGThenGoTo6();
      } else {
        _updateStepDisplay(6); // gÃ¼venlik iÃ§in
      }
    });
  }

  async function promptTicariKariVeKKEGThenGoTo6() {
    const formatTL = (n) => (n || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2 });

    const { value: vals, isConfirmed } = await Swal.fire({
      title: 'Cari DÃ¶nem Verileri',
      html: `
      <div style="text-align:left">
        <!-- Alan 1: Ticari BilanÃ§o KÃ¢rÄ± -->
        <div style="display:flex; flex-direction:column; gap:6px; margin:0 0 14px 0;">
          <label style="font-size:13px; color:#555; display:block;">Ticari BilanÃ§o KÃ¢rÄ± (TL)</label>
          <input id="swal_ticari" class="swal2-input" placeholder="0,00 TL" inputmode="decimal" style="margin:0; width:100%;">
        </div>

        <!-- Alan 2: KKEG -->
        <div style="display:flex; flex-direction:column; gap:6px; margin:0 0 14px 0;">
          <label style="font-size:13px; color:#555; display:block;">KKEG (TL)</label>
          <input id="swal_kkeg" class="swal2-input" placeholder="0,00 TL" inputmode="decimal" style="margin:0; width:100%;">
        </div>
      </div>

      <!-- Matrah kutusu -->
      <div style="margin-top:6px; padding:14px; background:#f6faf6; border:1px solid #d5ead5; border-radius:10px;">
        <div style="font-weight:700; font-size:14px; margin-bottom:6px;">Kurumlar Vergisi MatrahÄ±</div>
        <div style="font-size:13px; color:#444; margin-bottom:8px;">
          Matrah = <b>Ticari BilanÃ§o KÃ¢rÄ±</b> + <b>KKEG</b>
        </div>
        <input id="swal_matrah" class="swal2-input" placeholder="0,00 TL" readonly
               style="margin:0; background:#f0f0f0; width:100%;">
      </div>
    `,
      focusConfirm: false,
      showCancelButton: false,
      allowOutsideClick: false,
      allowEscapeKey: false,
      confirmButtonText: 'Kaydet ve devam et',
      customClass: {
        popup: 'swal2-green-theme-popup',
        header: 'swal2-green-theme-header',
        title: 'swal2-green-theme-title',
        icon: 'swal2-green-theme-icon',
        confirmButton: 'swal2-green-theme-confirm-button',
        htmlContainer: 'swal2-green-theme-html-container'
      },
      didOpen: () => {
        const tEl = document.getElementById('swal_ticari');
        const kEl = document.getElementById('swal_kkeg');
        const mEl = document.getElementById('swal_matrah');

        const update = () => {
          const t = parseFormattedNumber(tEl.value);
          const k = parseFormattedNumber(kEl.value);
          const sum = (t || 0) + (k || 0);
          mEl.value = formatTL(sum);
        };

        tEl.addEventListener('input', update);
        kEl.addEventListener('input', update);
        update();
      },
      preConfirm: () => {
        const t = parseFormattedNumber(document.getElementById('swal_ticari').value);
        const k = parseFormattedNumber(document.getElementById('swal_kkeg').value);
        if (isNaN(t) || isNaN(k)) {
          Swal.showValidationMessage('LÃ¼tfen geÃ§erli sayÄ±lar girin.');
          return false;
        }
        return { t, k, m: (t || 0) + (k || 0) };
      }
    });

    if (isConfirmed && vals) {
      const tOut = document.getElementById('ticari_bilanco_kari');
      const kOut = document.getElementById('kkeg');
      const mOut = document.getElementById('kv_matrah');

      if (tOut) tOut.value = formatTL(vals.t);
      if (kOut) kOut.value = formatTL(vals.k);
      if (mOut) mOut.value = formatTL(vals.m);

      if (typeof calculateKVMatrah === 'function') calculateKVMatrah();
    }

    _updateStepDisplay(6);
  }



  function goToStep1() { _updateStepDisplay(1); }

  function goToStep2() {
    // ğŸ”¹ AlanlarÄ± al
    const karar = document.getElementById("karar")?.value.trim();
    const programTuru = document.getElementById("program_turu")?.value.trim();
    const vizeDurumu = document.getElementById("vize_durumu")?.value.trim();

    // ğŸ”¹ Genel zorunlu kontroller
    if (!karar) {
      Swal.fire({
        icon: "warning",
        title: "Eksik Bilgi",
        text: "LÃ¼tfen 'TeÅŸvik Belgesi Hangi Karara GÃ¶re DÃ¼zenlendi' alanÄ±nÄ± seÃ§iniz.",
        confirmButtonText: "Tamam"
      });
      return;
    }

    if (!vizeDurumu) {
      Swal.fire({
        icon: "warning",
        title: "Eksik Bilgi",
        text: "LÃ¼tfen 'Tamamlama Vizesi YapÄ±ldÄ± mÄ±?' alanÄ±nÄ± seÃ§iniz.",
        confirmButtonText: "Tamam"
      });
      return;
    }

    // ğŸ”¹ 2025/9903 iÃ§in ek zorunluluk
    if (karar === "2025/9903" && !programTuru) {
      Swal.fire({
        icon: "warning",
        title: "Eksik Bilgi",
        text: "Bu karar iÃ§in 'Program TÃ¼rÃ¼' seÃ§imi zorunludur.",
        confirmButtonText: "Tamam"
      });
      return;
    }

    // ğŸ”¹ Her ÅŸey tamamsa bir sonraki adÄ±ma geÃ§
    _updateStepDisplay(2);
  }

  function goToStep3() { _updateStepDisplay(3); }

  function goToStep4() { _updateStepDisplay(4); }

  function goToStep5(source) {
    if (source === 'from6') {
      _updateStepDisplay(5);
      return;
    }

    setTimeout(() => {
      const karar = (document.getElementById('karar')?.value || "").trim();
      const vizeDurumu = (document.getElementById('vize_durumu')?.value || "").trim().toLowerCase();

      // ğŸ”¹ 2025/9903 Ã¶zel kuralÄ±:
      if (karar === "2025/9903") {
        console.log("âœ… 2025/9903 kararÄ±: sorular zorunlu olarak gÃ¶steriliyor.");
        askTevsiKazancQuestion();
        askOtherActivitiesDiscountQuestion();
        return;
      }

      // ğŸ”¹ DiÄŸer kararlar iÃ§in mevcut mantÄ±k:
      sessionStorage.removeItem('kucuk_olan_diger_faaliyet');

      if (vizeDurumu.includes("evet")) {
        askTevsiKazancQuestion();
      } else if (vizeDurumu.includes("hayÄ±r") || vizeDurumu.includes("hayir")) {
        askOtherActivitiesDiscountQuestion();
      } else {
        _updateStepDisplay(5);
      }
    }, 100);
  }


  function goToStep6() { _updateStepDisplay(6); }

  function goToStep7() { _updateStepDisplay(7); }



  const currentBelgeJSData = {{ current_belge | tojson | safe
  }};

  document.addEventListener("DOMContentLoaded", function () {

    // === 2025/9903 KararÄ± iÃ§in Ã¶zel davranÄ±ÅŸlar ===
    const kararSelect = document.getElementById("karar");
    const ilSelect = document.getElementById("il");
    const programSelect = document.getElementById("program_turu");
    const bolgeInput = document.getElementById("bolge");
    const katkiInput = document.getElementById("katki_orani");
    const vergiInput = document.getElementById("vergi_orani");
    const digerInput = document.getElementById("diger_oran");
    const tur1 = document.getElementById("yatirim_turu1");
    const tur2 = document.getElementById("yatirim_turu2");

    const form = document.getElementById('form-giris');

    // Form-GiriÅŸ submit (AJAX)
    if (form) {
      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(form);

        // Hesap alanlarÄ± da gÃ¶nderilsin
        formData.append('cari_yatirim_katki', document.getElementById('cari_yatirim_katki')?.value ?? '');
        formData.append('cari_diger_katki', document.getElementById('cari_diger_katki')?.value ?? '');
        formData.append('cari_toplam_katki', document.getElementById('cari_toplam_katki')?.value ?? '');
        formData.append('genel_toplam_katki', document.getElementById('genel_toplam_katki')?.value ?? '');

        // Hangi butonla geldi?
        const submitter = event.submitter;
        let actionType = '';
        if (submitter && submitter.name === 'submit_action') actionType = submitter.value;

        if (actionType === 'new_save') {
          formData.set('tesvik_id', '');
        }

        try {
          const response = await fetch(form.action, { method: 'POST', body: formData });
          const data = await response.json();

          let finalTitle = data.title;
          let finalMessage = data.message;
          let swalIcon = data.status;

          if (data.status === 'success') {
            if (actionType === 'new_save') {
              finalTitle = 'Yeni Belge KaydÄ±';
              finalMessage = 'Yeni teÅŸvik belgesi baÅŸarÄ±yla oluÅŸturuldu.';
              Swal.fire({
                icon: swalIcon,
                title: finalTitle,
                text: finalMessage,
                timer: 3000,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                didClose: () => {
                  window.location.href = "{{ url_for('indirimlikurumlar.index') }}?sekme=form";
                }
              });
              return;
            } else if (actionType === 'update') {
              finalTitle = 'Belge GÃ¼ncelleme';
              finalMessage = 'TeÅŸvik belgesi baÅŸarÄ±yla gÃ¼ncellendi.';
            }
          } else {
            finalTitle = data.title || 'Hata!';
            finalMessage = data.message || 'Bir sorun oluÅŸtu.';
          }

          showSwalMessage(swalIcon, finalTitle, finalMessage);
        } catch (err) {
          console.error('Form kaydetme hatasÄ±:', err);
          showSwalMessage('error', 'Hata!', 'Veri gÃ¶nderilirken bir aÄŸ/sunucu hatasÄ± oluÅŸtu.');
        }
      });
    }


    function blinkAllInfoIcons(attempt = 0) {
      const icons = document.querySelectorAll('.info-icon-styled');
      if (icons.length > 0) {
        // bulunduysa tÃ¼m ikonlara 7 kez parlama efekti
        setTimeout(() => {
          icons.forEach(icon => icon.classList.add('blink'));
          setTimeout(() => {
            icons.forEach(icon => icon.classList.remove('blink'));
          }, 7500); // animasyon sÃ¼resi (7 x 1s)
        }, 800);
      } else if (attempt < 10) {
        // henÃ¼z yÃ¼klenmediyse tekrar dene (her 300 ms)
        setTimeout(() => blinkAllInfoIcons(attempt + 1), 300);
      }
    }

    // Sayfa yÃ¼klenince otomatik baÅŸlat
    blinkAllInfoIcons();


    const useDetailedCheckbox = document.getElementById('useDetailedProfitRatios');
    if (useDetailedCheckbox) {
      const savedState = sessionStorage.getItem('use_detailed_profit_ratios') === 'true';
      useDetailedCheckbox.checked = savedState;
      toggleDetailedProfitInput();
      useDetailedCheckbox.addEventListener('change', function () {
        sessionStorage.setItem('use_detailed_profit_ratios', this.checked);
        toggleDetailedProfitInput();
      });
    }

    // 2) TÃ¼m adÄ±mlarÄ± gizle
    ALL_STEPS_IDS.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.add("hidden-step");
    });

    // 3) URL hash varsa ilgili adÄ±ma geÃ§
    const hash = window.location.hash;
    if (hash.startsWith("#step")) {
      const stepNum = hash.replace("#step", "");
      const fn = window["goToStep" + stepNum];
      if (typeof fn === "function") {
        fn();
        document.getElementById("step" + stepNum)?.scrollIntoView({
          behavior: "smooth"
        });
      } else {
        _updateStepDisplay(1); // URL hash'i yoksa veya geÃ§ersizse AÅŸama 1'i gÃ¶ster
      }
    } else {
      goToStep1();
    }

    // 4) DiÄŸer init iÅŸlemleri
    const clearButton = document.getElementById('clearProfitData');
    if (clearButton) clearButton.addEventListener('click', clearProfitTable);

    const ayrTable = document.getElementById('ayrintili-kazanc-table');
    if (ayrTable) {
      ayrTable.querySelectorAll('tbody input').forEach(input => {
        input.setAttribute('data-original-value', input.value);
        input.addEventListener('input', event => {
          if (!isProgrammaticChange) calculateTable(event);
        });
      });
      calculateTable();
    }

    const calculateBtn = document.getElementById('calculateCariBtn');
    if (calculateBtn) {
      calculateBtn.addEventListener('click', () => {
        calculateRatios();
        calculateKVMatrah();

        const karar = document.getElementById("karar")?.value;
        if (karar === "2025/9903") {
          console.log("âš™ï¸ 2025/9903 aktif â€” form ve detaylÄ± hesap baÅŸlatÄ±lÄ±yor");

          // 1ï¸âƒ£ Form hesaplama (kontroller + uyarÄ±lar)
          if (typeof hesaplaKatkiTutari9903Form === "function") hesaplaKatkiTutari9903Form();

          // 2ï¸âƒ£ DetaylÄ± hesaplama (oranlar, matrah, Step7 geÃ§iÅŸi)
          if (typeof hesaplaKatkiTutari9903 === "function") hesaplaKatkiTutari9903();

        } else {
          calculateCariAndNext();
        }
      });
    }


    const tevsiInput = document.getElementById("tevsi_yatirim_kazanci");
    tevsiMask = IMask(tevsiInput, {
      mask: Number,
      scale: 2,
      thousandsSeparator: '.',
      radix: ',',
      mapToRadix: [','],
      normalizeZeros: false,
      padFractionalZeros: false
    });

    [
      "gerceklesen_tevsi_yatirim_tutari",
      "toplam_sabit_kiymet_tutari",
      "ticari_bilanco_kari"
    ].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener("input", calculateTevsiKazancAutomatically);
    });





    const idConfig = {
      "toplam_tutar": "katki",
      "cari_harcama_tutari": "katki",
      "toplam_harcama_tutari": "katki",
      "onceki_yatirim_katki_tutari": "katki",
      "onceki_diger_katki_tutari": "katki",
      "brut_satis": "ratios",
      "ihracat": "ratios",
      "imalat": "ratios",
      "diger_faaliyet": "ratios",
      "gerceklesen_tevsi_yatirim_tutari": "tevsi",
      "toplam_sabit_kiymet_tutari": "tevsi",
      "ticari_bilanco_kari": "tevsi",
      "kkeg": "tevsi",
      "tevsi_yatirim_kazanci": "tevsiOutput"
    };

    ["ticari_bilanco_kari", "kkeg"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener("input", calculateKVMatrah);
    });

    calculateKVMatrah();

    const toplamTutarEl = document.getElementById('toplam_tutar');
    if (toplamTutarEl) {
      toplamTutarEl.addEventListener('input', () => {
        const karar = document.getElementById("karar")?.value;
        if (karar === "2025/9903") {
          hesaplaKatkiTutari9903Form(); // sadece form seviyesi (daha hÄ±zlÄ± tepki)
        } else {
          hesaplaKatkiTutari();
          hesaplaDigerKatkiTutari();
          hesaplaFiiliKatkiTutari();
        }
      });
    }

    // oranlar deÄŸiÅŸirse baÄŸlÄ± alanlarÄ± tazele
    ['katki_orani', 'diger_oran'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', () => {
        const karar = document.getElementById("karar")?.value;
        if (karar === "2025/9903") {
          hesaplaKatkiTutari9903Form(); // hÄ±zlÄ± uyarÄ± ve anlÄ±k hesap
        } else {
          hesaplaKatkiTutari();
          hesaplaDigerKatkiTutari();
          hesaplaFiiliKatkiTutari();
        }
      });
    });


    const maskMap = {};

    Object.keys(idConfig).forEach(id => {
      const field = document.getElementById(id);
      if (!field) return;
      // Maskâ€™i oluÅŸtur ve sakla
      const mask = IMask(field, {
        mask: Number, scale: 2, thousandsSeparator: '.', radix: ',',
        mapToRadix: [','], normalizeZeros: false, padFractionalZeros: false
      });
      maskMap[id] = mask;


      mask.on("accept", () => {
        const karar = document.getElementById("karar")?.value;
        const type = idConfig[id];

        if (type === "katki") {
          if (karar === "2025/9903") {
            hesaplaKatkiTutari9903Form(); // sadece form seviyesi
          } else {
            hesaplaKatkiTutari();
          }
          hesaplaDigerKatkiTutari();
          hesaplaFiiliKatkiTutari();
          hesaplaOncekiKatkiTutari();
          hesaplaKalanVeEndeks();
        } else if (type === "ratios") {
          calculateRatios();
        } else if (type === "tevsi") {
          calculateTevsiKazancAutomatically();
        }
      });

    });

    function getIndirimSure(karar, belgeTarihi) {
      if (karar === "2025/9903") {
        const tarih = new Date(belgeTarihi);
        const limitDate = new Date("2025-07-24");
        const eskiBasvuruDate = new Date("2025-06-16");
        if (tarih >= limitDate) {
          return 10; // 10 hesap dÃ¶nemi sÄ±nÄ±rlÄ±
        } else if (tarih < eskiBasvuruDate) {
          return "SÄ±nÄ±rsÄ±z"; // Eski belge, sÄ±nÄ±rsÄ±z hak
        }
      }
      return "Eski sistem"; // DiÄŸer kararlar iÃ§in
    }

    // Karar deÄŸiÅŸtiÄŸinde Ã¶zel mod ayarlarÄ±
    window.handleKarar9903 = function () {
      const karar = kararSelect?.value;

      if (!kararSelect || !programSelect) {
        console.warn("âš ï¸ kararSelect veya programSelect bulunamadÄ±!");
        return;
      }

      if (karar === "2025/9903") {
        console.log("â†’ 2025/9903 modu aktif!");

        // Program aktif, yatÄ±rÄ±m tÃ¼rleri pasif
        programSelect.removeAttribute("disabled"); // <-- daha garantili yÃ¶ntem
        programSelect.disabled = false;            // <-- yedek
        programSelect.classList.remove("bg-light"); // gÃ¶rÃ¼nÃ¼mÃ¼ temizle

        tur1.disabled = true;
        tur2.disabled = true;
        tur1.value = "";
        tur2.value = "";
        tur1.classList.add("bg-light");
        tur2.classList.add("bg-light");

        // Sabit oranlar
        vergiInput.value = 60;
        digerInput.value = 50;

        // BÃ¶lgeyi 9903 haritasÄ±ndan al
        const il = ilSelect.value;
        if (il && bolgeMap9903[il]) {
          bolgeInput.value = bolgeMap9903[il];
        }

        // KatkÄ± oranÄ± da program seÃ§ilince gÃ¼ncellensin
        const program = programSelect.value;
        if (program && katkilar9903[program]) {
          katkiInput.value = katkilar9903[program];
        }

      } else {
        console.log("â†’ Normal teÅŸvik modu aktif");

        programSelect.setAttribute("disabled", "disabled"); // kapat
        programSelect.classList.add("bg-light");
        tur1.disabled = false;
        tur2.disabled = false;
        tur1.classList.remove("bg-light");
        tur2.classList.remove("bg-light");

        vergiInput.value = "";
        digerInput.value = "";
        katkiInput.value = "";

        setBolge();
        setOranlar();
      }
    }

    if (kararSelect) {
      kararSelect.addEventListener("change", handleKarar9903);
      handleKarar9903(); // sayfa yÃ¼klenirken kontrol et
    }

    // Ä°l deÄŸiÅŸtiÄŸinde bÃ¶lgeyi gÃ¼ncelle
    ilSelect.addEventListener("change", () => {
      const karar = kararSelect.value;
      const il = ilSelect.value;
      if (karar === "2025/9903") {
        bolgeInput.value = bolgeMap9903[il] || "";
      } else {
        setBolge();
      }
    });

    // Program deÄŸiÅŸtiÄŸinde katkÄ± oranÄ±nÄ± gÃ¼ncelle
    programSelect.addEventListener("change", () => {
      const karar = kararSelect.value;
      const program = programSelect.value;
      if (karar === "2025/9903") {
        katkiInput.value = katkilar9903[program] || 0;
      } else {
        setOranlar();
      }
    });

    // Karar deÄŸiÅŸikliÄŸini dinle
    kararSelect.addEventListener("change", handleKarar9903);

    // Sayfa yÃ¼klenince de kontrol et
    handleKarar9903();
  });




  // Mevcut belge verisini forma bas (isteÄŸe baÄŸlÄ± kÄ±sa yardÄ±mcÄ±lar)
  const setVal = (sel, v) => { const el = document.querySelector(sel); if (el) el.value = v ?? ''; };
  const fmt = n => (n || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2 });

  // Form sekmesi linki: PDF'den iÃ§e aktarmayÄ± sor
  const indirimLink = document.querySelector('a.nav-link[href*="sekme=form"]');
  if (indirimLink) {
    indirimLink.addEventListener('click', (e) => {
      e.preventDefault();
      Swal.fire({
        title: 'PDFâ€™den iÃ§e aktarÄ±lsÄ±n mÄ±?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Evet',
        cancelButtonText: 'HayÄ±r'
      }).then(res => {
        if (res.isConfirmed) {
          document.getElementById('kvUploadInput')?.click();
        } else {
          window.location.href = '{{ url_for("indirimlikurumlar.index") }}?sekme=form#step1';
        }
      });
    });
  }

  // Gizli file input â†’ PDF parser
  const kvInput = document.getElementById('kvUploadInput');
  if (kvInput) kvInput.addEventListener('change', handleKVUpload);

  // currentBelge varsa forma doldur
  if (currentBelgeJSData && window.location.search.includes('sekme=form')) {
    // Step 1
    setVal('input[name="belge_tarihi"]', currentBelgeJSData.belge_tarihi);
    setVal('select[name="karar"]', currentBelgeJSData.karar);
    setVal('select[name="yatirim_turu1"]', currentBelgeJSData.yatirim_turu1);
    setVal('select[name="yatirim_turu2"]', currentBelgeJSData.yatirim_turu2);
    setVal('input[name="belge_no"]', currentBelgeJSData.belge_no);
    setVal('select[name="vize_durumu"]', currentBelgeJSData.vize_durumu);

    // Step 2 (otomatik oranlar iÃ§in tetikleyelim)
    setVal('select[name="donem"]', currentBelgeJSData.donem);
    setVal('select[name="il"]', currentBelgeJSData.il);
    setVal('select[name="osb"]', currentBelgeJSData.osb);
    setBolge();
    setOranlar();

    // Step 3
    const s3 = id => document.getElementById(id);
    if (s3('toplam_tutar')) s3('toplam_tutar').value = fmt(currentBelgeJSData.toplam_tutar);
    if (s3('cari_harcama_tutari')) s3('cari_harcama_tutari').value = fmt(currentBelgeJSData.cari_harcama_tutari);
    if (s3('toplam_harcama_tutari')) s3('toplam_harcama_tutari').value = fmt(currentBelgeJSData.toplam_harcama_tutari);

    // Step 4
    if (s3('onceki_yatirim_katki_tutari')) s3('onceki_yatirim_katki_tutari').value = fmt(currentBelgeJSData.onceki_yatirim_katki_tutari);
    if (s3('onceki_diger_katki_tutari')) s3('onceki_diger_katki_tutari').value = fmt(currentBelgeJSData.onceki_diger_katki_tutari);

    // Step 6 (satÄ±ÅŸ/daÄŸÄ±lÄ±m)
    const chk = document.getElementById('useDetailedProfitRatios');
    if (chk) chk.checked = !!currentBelgeJSData.use_detailed_profit_ratios;
    ['brut_satis', 'ihracat', 'imalat', 'diger_faaliyet'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = fmt(currentBelgeJSData[id]);
    });
    toggleDetailedProfitInput();
  }

  // AyrÄ±ntÄ±lÄ± KazanÃ§ Formu (AJAX)
  const ayrintiliKazancForm = document.getElementById('ayrintili-kazanc-form');
  if (ayrintiliKazancForm) {
    ayrintiliKazancForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(ayrintiliKazancForm);
      formData.append('save', '1');

      try {
        const response = await fetch(ayrintiliKazancForm.action, { method: 'POST', body: formData });
        const contentType = response.headers.get("content-type");
        if (response.ok && contentType && contentType.includes("application/json")) {
          const data = await response.json();
          showSwalMessage(data.status, data.title, data.message);
        } else {
          const errorText = await response.text();
          console.error('AyrÄ±ntÄ±lÄ± kazanÃ§ kaydetme yanÄ±tÄ±:', errorText);
          showSwalMessage('error', 'Hata!', `Kaydetme sÄ±rasÄ±nda sunucu sorunu: ${response.status} ${response.statusText}`);
        }
      } catch (err) {
        console.error('AyrÄ±ntÄ±lÄ± kazanÃ§ kaydetme hatasÄ±:', err);
        showSwalMessage('error', 'Hata!', 'Veri gÃ¶nderilirken bir aÄŸ/istemci hatasÄ± oluÅŸtu.');
      }
    });
  }

  // MANUEL BELÄ°RLE: YatÄ±rÄ±ma KatkÄ± OranÄ±
  document.getElementById('btn-manual-katki')?.addEventListener('click', async () => {
    const { value: val } = await Swal.fire({
      title: 'YatÄ±rÄ±ma KatkÄ± OranÄ±nÄ± giriniz (%)',
      input: 'text',
      inputPlaceholder: 'Ã¶rn: 40',
      showCancelButton: true,
      confirmButtonText: 'Tamam',
      cancelButtonText: 'VazgeÃ§',
      inputValidator: (v) => {
        const n = parseFormattedNumber(v);
        if (isNaN(n) || n < 0 || n > 100) return '0-100 arasÄ±nda bir yÃ¼zde girin';
        return null;
      }
    });
    if (val !== undefined) {
      const n = parseFormattedNumber(val);
      document.getElementById('katki_orani').value = n.toString().replace('.', ',');
      sessionStorage.setItem('manual_katki', 'true');
      sessionStorage.setItem('manual_katki_value', String(n));
      // aÅŸaÄŸÄ±dakiler mevcut hesaplara dokunsun
      hesaplaKatkiTutari(); hesaplaDigerKatkiTutari(); hesaplaFiiliKatkiTutari(); hesaplaOncekiKatkiTutari(); hesaplaKalanVeEndeks();
    }
  });

  // MANUEL BELÄ°RLE: Vergi Ä°ndirim OranÄ±
  document.getElementById('btn-manual-vergi')?.addEventListener('click', async () => {
    const { value: val } = await Swal.fire({
      title: 'Vergi Ä°ndirim OranÄ±nÄ± giriniz (%)',
      input: 'text',
      inputPlaceholder: 'Ã¶rn: 80',
      showCancelButton: true,
      confirmButtonText: 'Tamam',
      cancelButtonText: 'VazgeÃ§',
      inputValidator: (v) => {
        const n = parseFormattedNumber(v);
        if (isNaN(n) || n < 0 || n > 100) return '0-100 arasÄ±nda bir yÃ¼zde girin';
        return null;
      }
    });
    if (val !== undefined) {
      const n = parseFormattedNumber(val);
      document.getElementById('vergi_orani').value = n.toString().replace('.', ',');
      sessionStorage.setItem('manual_vergi', 'true');
      sessionStorage.setItem('manual_vergi_value', String(n));
      updateDiscountedRatesUI();
    }
  });

  // TeÅŸvik belgeleri silme (AJAX)
  document.querySelectorAll('.delete-tesvik-form').forEach(formElement => {
    formElement.addEventListener('submit', async (event) => {
      event.preventDefault();
      Swal.fire({
        title: "Emin misiniz?",
        text: "Bu belge silinecek. Bu iÅŸlem geri alÄ±namaz!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "Evet, sil!",
        cancelButtonText: "Ä°ptal"
      }).then(async (result) => {
        if (!result.isConfirmed) return;
        try {
          const response = await fetch(formElement.action, {
            method: 'POST',
            body: new FormData(formElement)
          });
          const data = await response.json();
          showSwalMessage(data.status, data.title, data.message);
          if (data.status === "success") {
            formElement.closest('tr')?.remove();
          }
        } catch (err) {
          console.error('Belge silme hatasÄ±:', err);
          showSwalMessage('error', 'Hata!', 'Belge silinirken bir sorun oluÅŸtu.');
        }
      });
    });
  });
</script>
{% endblock %}