{% extends "layout.html" %}
{% block title %}Mizan YÃ¼kleme{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <h2 class="mb-4 text-center">ðŸ“Š Mizan YÃ¼kle ve YÃ¶net</h2>

        <div class="text-center mb-4">
            <p>Kendi mizan verilerinizi yÃ¼klemek iÃ§in lÃ¼tfen Ã¶rnek ÅŸablonu indirin:</p>
            <a href="{{ url_for('static', filename='templates/mizan_sablonu.xlsx') }}" download="mizan_sablonu.xlsx" class="btn btn-info">
                <i class="bi bi-download me-2"></i>Mizan Åžablonunu Ä°ndir
            </a>
        </div>

        <form id="mizanUploadForm" enctype="multipart/form-data">
            <div id="drop-area" class="border border-primary border-2 rounded p-4 text-center mb-3"
                 ondrop="handleDropMizan(event)" ondragover="event.preventDefault()">
                <p class="mb-2">ðŸ“Ž Mizan Excel dosyalarÄ±nÄ±zÄ± (.xlsx veya .xls) buraya sÃ¼rÃ¼kleyin ya da <strong>seÃ§in</strong></p>
                <input type="file" id="fileElemMizan" name="belgeler" accept=".xlsx,.xls" class="form-control d-none" multiple required>
                <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileElemMizan').click()">Dosya SeÃ§</button>
            </div>
        </form>

        <hr class="my-4">

        <h4 class="text-center mb-3">ðŸ“‚ YÃ¼klenen Mizan DosyalarÄ±</h4>

        {% if yuklenen_mizanlar %}
            <div class="table-responsive">
                <table class="table table-bordered table-hover table-sm">
                    <thead>
                        <tr>
                            <th>Dosya AdÄ±</th>
                            <th>DÃ¶nem</th>
                            <th>VKN</th>
                            <th>YÃ¼kleme Tarihi</th>
                            <th>Ä°ÅŸlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mizan in yuklenen_mizanlar %}
                        <tr>
                            <td>{{ mizan.ad }}</td>
                            <td>{{ mizan.donem }}</td>
                            <td>{{ mizan.vkn }}</td>
                            <td>{{ mizan.tarih }}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-danger btn-delete-mizan"
                                        data-vkn="{{ mizan.vkn }}"
                                        data-donem="{{ mizan.donem }}"
                                        data-belge-turu="mizan"
                                        data-file-name="{{ mizan.ad }}">
                                    <i class="bi bi-trash"></i> Sil
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-muted text-center">HenÃ¼z yÃ¼klenmiÅŸ mizan dosyasÄ± bulunmamaktadÄ±r.</p>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// Mizan Excel YÃ¼kleme
function handleDropMizan(e) {
    e.preventDefault();
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        uploadMizanFiles(files);
    }
}

document.getElementById("fileElemMizan").addEventListener("change", function () {
    if (this.files.length > 0) {
        uploadMizanFiles(this.files);
    }
});

function uploadMizanFiles(files) {
    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
        formData.append("belgeler", files[i]);
    }

    fetch("/yukle-mizan-excel", {
        method: "POST",
        body: formData
    })
    .then(res => res.json())
    .then(messages => {
        if (Array.isArray(messages)) {
            let needsReload = false;
            messages.forEach(msg => {
                if (msg.type === "warning") {
                    Swal.fire({
                        icon: msg.type,
                        title: msg.title,
                        html: `<b>${msg.text}</b><br><small>Bu belge zaten yÃ¼klÃ¼. Ãœzerine yazmak ister misiniz?</small>`,
                        showCancelButton: true,
                        confirmButtonText: "â†» Evet, Ãœzerine Yaz",
                        cancelButtonText: "Ä°ptal",
                        reverseButtons: true
                    }).then(result => {
                        if (result.isConfirmed) {
                            uploadOverwrite({
                                vkn: msg.vkn,
                                donem: msg.donem,
                                belge_turu: 'mizan',
                                dosya: msg.dosya
                            });
                        }
                    });
                } else {
                    showSwalMessage(msg.type, msg.title, msg.text);
                    if (msg.type === "success") needsReload = true;
                }
            });
            if (needsReload) setTimeout(() => location.reload(), 1500);
        }
    })
    .catch(err => {
        Swal.fire({ icon: "error", title: "Sunucu BaÄŸlantÄ± HatasÄ±", text: "Dosya yÃ¼klenirken sunucuya ulaÅŸÄ±lamadÄ± veya bir hata oluÅŸtu." });
        console.error("YÃ¼kleme hatasÄ±:", err);
    });
}

// Mizan Silme
document.querySelectorAll('.btn-delete-mizan').forEach(button => {
    button.addEventListener('click', function() {
        const vkn = this.dataset.vkn;
        const donem = this.dataset.donem;
        const belgeTuru = this.dataset.belgeTuru;
        const fileName = this.dataset.fileName;

        Swal.fire({
            title: 'Emin misiniz?',
            text: `VKN '${vkn}' - '${donem}' dÃ¶nemine ait '${fileName}' mizan dosyasÄ± silinecek.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Evet, Sil!',
            cancelButtonText: 'Ä°ptal'
        }).then((result) => {
            if (result.isConfirmed) {
                const formData = new FormData();
                formData.append('vkn', vkn);
                formData.append('donem', donem);
                formData.append('belge_turu', belgeTuru);

                fetch('/donem-sil', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    showSwalMessage(data.status, data.title, data.message);
                    if (data.status === 'success') setTimeout(() => location.reload(), 1500);
                })
                .catch(error => {
                    Swal.fire('Hata!', 'Dosya silinirken bir hata oluÅŸtu.', 'error');
                    console.error('Silme hatasÄ±:', error);
                });
            }
        });
    });
});
</script>
{% endblock %}
