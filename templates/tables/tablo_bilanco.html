{% extends "layout.html" %}
{% block title %}Bilanço Tablosu{% endblock %}

{% block content %}
<style>
    :root {
        --premium-blue: #4e54c8;
        --premium-gradient: linear-gradient(135deg, #4e54c8 0%, #8f94fb 100%);
        --glass-bg: rgba(255, 255, 255, 0.9);
    }

    .page-header {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        margin-bottom: 2.5rem;
    }

    h2.page-title {
        font-weight: 800;
        background: var(--premium-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
    }

    .table-container {
        background: white;
        border-radius: 24px;
        padding: 2rem;
        box-shadow: 0 10px 40px rgba(0,0,0,0.06);
        border: 1px solid #f1f5f9;
    }

    .bilanco-table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
    }

    .bilanco-table thead th {
        background: #f8fafc;
        color: #64748b;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        padding: 1.2rem 1rem;
        border-bottom: 2px solid #e2e8f0;
    }

    .bilanco-table td {
        padding: 0.8rem 1rem;
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.9rem;
    }

    .active-side { border-right: 2px solid #e2e8f0; }
    .passive-side { border-left: 1px solid #e2e8f0; }

    .group-header {
        background: #f8fafc;
        color: var(--premium-blue);
        font-weight: 800;
    }

    .total-row {
        background: #f1f5f9;
        font-weight: 800;
        font-size: 1rem;
    }

    .badge-period {
        background: var(--premium-gradient);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 10px;
        font-size: 0.85rem;
    }

</style>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-xl-11">
            <div class="page-header text-center">
                <h2 class="page-title">{{ page_title or 'Bilanço Tablosu' }}</h2>
                <div class="mt-3">
                    <span class="badge-period me-2">{{ vkn }}</span>
                    <span class="text-secondary fw-bold">{{ unvan or "" }}</span>
                </div>
                
                <div class="mt-4">
                    <form method="get" class="d-inline-block">
                        <input type="hidden" name="tur" value="bilanco">
                        <input type="hidden" name="vkn" value="{{ vkn }}">
                        <input type="hidden" name="donem" value="{{ donem }}">
                        
                        <div class="input-group input-group-sm">
                            <label class="input-group-text bg-white border-0 text-muted fw-bold">DÖNEM SEÇİMİ:</label>
                            <select name="donem_turu" class="form-select border-0 bg-light shadow-none" onchange="this.form.submit()" style="border-radius: 8px; width: 220px;">
                                {% if donem_mapping.onceki %}
                                    <option value="onceki" {% if secilen_donem == 'onceki' %}selected{% endif %}>
                                        Önceki Dönem ({{ donem_mapping.onceki }})
                                    </option>
                                {% endif %}
                                {% if donem_mapping.cari %}
                                    <option value="cari" {% if secilen_donem == 'cari' %}selected{% endif %}>
                                        Cari Dönem ({{ donem_mapping.cari }})
                                    </option>
                                {% endif %}
                                {% if has_inflation and donem_mapping.cari_enflasyon %}
                                    <option value="cari_enflasyon" {% if secilen_donem == 'cari_enflasyon' %}selected{% endif %}>
                                        Cari Dönem ({{ donem_mapping.cari_enflasyon }})
                                    </option>
                                {% endif %}
                            </select>
                        </div>
                    </form>
                </div>
            </div>

            <div class="table-container">
                <div class="table-responsive">
                    <table class="table bilanco-table align-middle">
                        <thead>
                            <tr class="text-center">
                                <th colspan="3" class="active-side bg-primary-subtle text-primary border-0 fs-6">AKTİF (VARLIKLAR)</th>
                                <th colspan="3" class="passive-side bg-success-subtle text-success border-0 fs-6">PASİF (KAYNAKLAR)</th>
                            </tr>
                            <tr>
                                <th style="width: 80px;">KOD</th>
                                <th>HESAP ADI</th>
                                <th class="text-end active-side">TUTAR</th>
                                <th style="width: 80px; padding-left: 1.5rem;">KOD</th>
                                <th>HESAP ADI</th>
                                <th class="text-end">TUTAR</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set aktif_len = aktif_list | length %}
                            {% set pasif_len = pasif_list | length %}
                            {% set max_len = [aktif_len, pasif_len] | max %}

                            {% for i in range(max_len) %}
                            <tr>
                                <!-- AKTİF -->
                                {% if i < aktif_len %}
                                    {% set row = aktif_list[i] %}
                                    {% set tutar = (
                                        row.get("Önceki Dönem") if secilen_donem == "onceki" else
                                        row.get("Cari Dönem") if secilen_donem == "cari" else
                                        row.get("Cari Dönem (Enflasyonlu)") if secilen_donem == "cari_enflasyon" else
                                        row.get("Cari Dönem")
                                    ) %}
                                    {% if not row["Kod"] %}
                                        <td class="group-header"></td>
                                        <td class="group-header">{{ row["Açıklama"] }}</td>
                                        <td class="text-end group-header active-side">{{ tutar | tlformat }}</td>
                                    {% else %}
                                        <td>{{ row["Kod"] }}</td>
                                        <td>{{ row["Açıklama"] }}</td>
                                        <td class="text-end active-side">{{ tutar | tlformat }}</td>
                                    {% endif %}
                                {% else %}
                                    <td></td><td></td><td class="active-side"></td>
                                {% endif %}

                                <!-- PASİF -->
                                {% if i < pasif_len %}
                                    {% set row = pasif_list[i] %}
                                    {% set tutar = 
                                        (row["Önceki Dönem"] if secilen_donem == "onceki" else
                                        row["Cari Dönem"] if secilen_donem == "cari" else
                                        row["Cari Dönem (Enflasyonlu)"] if secilen_donem == "cari_enflasyon" else
                                        row["Cari Dönem"]) 
                                    %}
                                    {% if not row["Kod"] %}
                                        <td class="group-header" style="padding-left: 1.5rem;"></td>
                                        <td class="group-header">{{ row["Açıklama"] }}</td>
                                        <td class="text-end group-header">{{ tutar | tlformat }}</td>
                                    {% else %}
                                        <td style="padding-left: 1.5rem;">{{ row["Kod"] }}</td>
                                        <td>{{ row["Açıklama"] }}</td>
                                        <td class="text-end">{{ tutar | tlformat }}</td>
                                    {% endif %}
                                {% else %}
                                    <td style="padding-left: 1.5rem;"></td><td></td><td></td>
                                {% endif %}
                            </tr>
                            {% endfor %}

                            <!-- TOPLAMLAR -->
                            <tr class="total-row">
                                <td></td>
                                <td>AKTİF TOPLAMI</td>
                                <td class="text-end active-side text-primary">{{ toplamlar.AKTİF.get(secilen_donem, 0) | tlformat }}</td>
                                <td style="padding-left: 1.5rem;"></td>
                                <td>PASİF TOPLAMI</td>
                                <td class="text-end text-success">{{ toplamlar.PASİF.get(secilen_donem, 0) | tlformat }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="text-center mt-5">
                <a href="{{ url_for('data.veri_giris', vkn=vkn, donem=donem) }}" class="btn btn-outline-secondary px-4 py-2" style="border-radius: 12px;">
                    <i class="bi bi-arrow-left me-2"></i>Veri Yönetimine Dön
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
