<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <title>Admin Paneli - KullanÄ±cÄ± YÃ¶netimi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="p-4 bg-light">
    <div class="container">
        <!-- BaÅŸlÄ±k -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold mb-0">ğŸ‘¤ KullanÄ±cÄ± YÃ¶netim Paneli</h3>
            <div class="d-flex gap-2">
                <a href="{{ url_for('admin.login_logs') }}" class="btn btn-outline-info btn-sm">ğŸ“œ GiriÅŸ LoglarÄ±</a>
                <a href="{{ url_for('main.home') }}" class="btn btn-secondary btn-sm">â† Geri DÃ¶n</a>
            </div>
        </div>

        <!-- Bildirimler -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Filtreleme / Arama -->
        <form class="row g-2 mb-4">
            <div class="col-md-4">
                <input type="text" name="q" placeholder="KullanÄ±cÄ± ara..." value="{{ request.args.get('q','') }}"
                    class="form-control">
            </div>
            <div class="col-md-3">
                <select name="status" class="form-select">
                    <option value="">Durum (TÃ¼mÃ¼)</option>
                    <option value="1" {% if request.args.get('status')=='1' %}selected{% endif %}>OnaylÄ±</option>
                    <option value="0" {% if request.args.get('status')=='0' %}selected{% endif %}>Bekleyen</option>
                </select>
            </div>
            <div class="col-md-3">
                <select name="role" class="form-select">
                    <option value="">Rol (TÃ¼mÃ¼)</option>
                    <option value="editor" {% if request.args.get('role')=='editor' %}selected{% endif %}>EditÃ¶r
                    </option>
                    <option value="user" {% if request.args.get('role')=='user' %}selected{% endif %}>KullanÄ±cÄ±</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Filtrele</button>
            </div>
        </form>

        <!-- KullanÄ±cÄ± Tablosu -->
        <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle bg-white">
                <thead class="table-primary text-center">
                    <tr>
                        <th>ID</th>
                        <th>KullanÄ±cÄ± AdÄ±</th>
                        <th>Durum</th>
                        <th>Rol</th>
                        <th>Son GiriÅŸ</th>
                        <th>KayÄ±t Tarihi</th>
                        <th>Not</th>
                        <th>Ä°ÅŸlemler</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in users %}
                    <tr>
                        <td class="text-center">{{ u.id }}</td>
                        <td>{{ u.username }}</td>
                        <td class="text-center">
                            {% if u.is_approved %}
                            <span class="badge bg-success">OnaylÄ±</span>
                            {% else %}
                            <span class="badge bg-warning text-dark">Bekliyor</span>
                            {% endif %}

                            {% if u.is_suspended %}
                            <span class="badge bg-secondary ms-1">AskÄ±da</span>
                            {% endif %}
                        </td>

                        <!-- Rol -->
                        <td class="text-center">
                            <form method="POST" action="{{ url_for('admin.change_role', user_id=u.id) }}" class="d-inline">
                                <select name="role" onchange="this.form.submit()" class="form-select form-select-sm">
                                    <option value="user" {{ 'selected' if u.role=='user' else '' }}>KullanÄ±cÄ±</option>
                                    <option value="editor" {{ 'selected' if u.role=='editor' else '' }}>EditÃ¶r</option>
                                </select>
                            </form>
                        </td>

                        <!-- Tarihler -->
                        <td class="text-center">{{ u.last_login | safe_date }}</td>
                        <td class="text-center">{{ u.created_at | safe_date }}</td>

                        <!-- Admin Notu -->
                        <td class="text-center">
                            {% if u.admin_notes %}
                            <span class="badge bg-info" data-bs-toggle="tooltip" title="{{ u.admin_notes }}">ğŸ›ˆ</span>
                            {% else %}
                            <span class="text-muted">â€”</span>
                            {% endif %}
                        </td>

                        <!-- Ä°ÅŸlemler -->
                        <td class="text-center">
                            {% if not u.is_approved %}
                            <a href="{{ url_for('admin.approve_user', user_id=u.id) }}"
                                class="btn btn-success btn-sm">Onayla</a>
                            {% endif %}

                            {% if u.username != 'admin' %}
                            <a href="{{ url_for('admin.suspend_user', user_id=u.id) }}"
                                class="btn btn-sm {{ 'btn-outline-secondary' if u.is_suspended else 'btn-dark' }}">
                                {{ 'AskÄ±dan Ã‡Ä±kar' if u.is_suspended else 'AskÄ±ya Al' }}
                            </a>

                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                                data-bs-target="#editModal{{ u.id }}">DÃ¼zenle</button>

                            <a href="{{ url_for('admin.admin_reset_password', user_id=u.id) }}"
                                class="btn btn-sm btn-warning">Åifre SÄ±fÄ±rla</a>

                            <a href="{{ url_for('admin.reject_user', user_id=u.id) }}" class="btn btn-sm btn-danger"
                                onclick="return confirm('Bu kullanÄ±cÄ±yÄ± kalÄ±cÄ± olarak silmek istediÄŸinize emin misiniz?')">
                                Sil
                            </a>
                            {% endif %}
                        </td>
                    </tr>

                    <!-- KullanÄ±cÄ± AdÄ± DÃ¼zenleme ModalÄ± -->
                    <div class="modal fade" id="editModal{{u.id}}" tabindex="-1">
                        <div class="modal-dialog">
                            <form method="POST" action="{{ url_for('admin.update_username', user_id=u.id) }}">
                                <div class="modal-content">
                                    <div class="modal-header bg-primary text-white">
                                        <h5 class="modal-title">KullanÄ±cÄ± AdÄ±nÄ± DÃ¼zenle</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <label>Yeni KullanÄ±cÄ± AdÄ±:</label>
                                        <input type="text" class="form-control" name="new_username"
                                            value="{{ u.username }}" required>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="submit" class="btn btn-primary">Kaydet</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Tooltipleri etkinleÅŸtir
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));
    </script>
</body>

</html>