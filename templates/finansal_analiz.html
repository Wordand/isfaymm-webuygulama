{% extends "layout.html" %}
{% block title %}Finansal Analiz{% endblock %}

{% block content %}
<style>
    /* --- Genel tasar캼m iyile릆irmeleri --- */
    h3.page-title {
        font-weight: 600;
        font-size: 1.6rem;
        color: #0d6efd;
        margin-bottom: 1.5rem;
    }

    .card.oran-card {
        transition: all 0.25s ease;
        border-radius: 14px;
        border: 1px solid #dee2e6;
    }

    .card.oran-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
    }

    .value-badge {
        font-size: 1.4rem;
        font-weight: 700;
        color: #0d6efd;
    }

    .oran-action {
        display: flex;
        gap: 0.6rem;
    }

    .oran-action button {
        border-radius: 50%;
        width: 34px;
        height: 34px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.05rem;
        transition: all 0.2s ease-in-out;
    }

    .oran-action button:hover {
        transform: scale(1.15);
    }

    .btn-info-icon {
        color: #0d6efd;
        border-color: #0d6efd;
    }

    .btn-chart-icon {
        color: #198754;
        border-color: #198754;
    }

    .btn-info-icon:hover {
        background-color: #0d6efd;
        color: #fff;
    }

    .btn-chart-icon:hover {
        background-color: #198754;
        color: #fff;
    }

    .modal-content {
        border-radius: 16px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        animation: fadeInScale 0.3s ease;
    }

    @keyframes fadeInScale {
        from {
            opacity: 0;
            transform: scale(0.9);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }
</style>

<div class="container mt-4 mb-5">
    <h3 class="page-title text-center">游늵 Finansal Oran Analizi</h3>

    <!-- Flash mesaj -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, msg in messages %}
    <div class="alert alert-{{ 'success' if category == 'message' else category }} text-center">
        {{ msg }}
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- Se칞im formu -->
    <form id="finansalForm" method="get" action="{{ url_for('finansal_analiz') }}" class="row gx-3 gy-2 mb-4">
        <div class="col-md-3">
            <label for="vknSelect" class="form-label">M칲kellef (VKN)</label>
            <select id="vknSelect" name="vkn" class="form-select" onchange="this.form.submit()">
                <option value="">Se칞iniz...</option>
                {% for m in unvanlar %}
                <option value="{{ m.vkn }}" {% if secili_vkn==m.vkn %}selected{% endif %}>{{ m.vkn }} - {{ m.unvan }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label for="dataSourceSelect" class="form-label">Veri Kayna캼</label>
            <select id="dataSourceSelect" name="data_source" class="form-select" onchange="this.form.submit()" {% if not
                secili_vkn %}disabled{% endif %}>
                <option value="pdf" {% if data_source=='pdf' %}selected{% endif %}>PDF (Bilan칞o/Gelir)</option>
                <option value="mizan" {% if data_source=='mizan' %}selected{% endif %}>Mizan Excel</option>
            </select>
        </div>

        <div class="col-md-3">
            <label for="inflationMode" class="form-label">Bilan칞o T칲r칲</label>
            <select id="inflationMode" name="inflation_mode" class="form-select" onchange="this.form.submit()">
                <option value="auto" {% if inflation_mode=='auto' %}selected{% endif %}>Otomatik</option>
                <option value="enflasyonsuz" {% if inflation_mode=='enflasyonsuz' %}selected{% endif %}>Enflasyonsuz
                </option>
                <option value="enflasyonlu" {% if inflation_mode=='enflasyonlu' %}selected{% endif %}>Enflasyonlu
                </option>
            </select>
        </div>

        <div class="col-md-3">
            <label for="kategoriSelect" class="form-label">Kategori</label>
            <select id="kategoriSelect" name="kategori" class="form-select" onchange="this.form.submit()">
                {% set categories = [
                ('likidite','Likidite Oranlar캼'),
                ('yapi','Finansal Yap캼 Oranlar캼'),
                ('varlik','Varl캼k Kullan캼m Oranlar캼'),
                ('karlilik','K칙rl캼l캼k Oranlar캼'),
                ('borsa','Borsa Performans Oranlar캼')
                ] %}
                {% for key, label in categories %}
                <option value="{{ key }}" {% if kategori==key %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-6">
            <label for="yearSelect" class="form-label">Analiz Edilecek Y캼llar</label>
            <select id="yearSelect" name="yillar" class="form-select" multiple onchange="this.form.submit()">
                {% for yil in mevcut_yillar %}
                <option value="{{ yil }}" {% if yil in secili_yillar %}selected{% endif %}>{{ yil }}</option>
                {% endfor %}
            </select>
            <small class="text-muted">Ctrl / Cmd ile birden fazla y캼l se칞ebilirsiniz</small>
        </div>
    </form>

    {% if not secili_vkn or not secili_yillar or not kategori %}
    <div class="alert alert-primary text-center mb-5">
        L칲tfen m칲kellef, y캼l(lar) ve kategori se칞in.
    </div>
    {% else %}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-4">
        {% for ad, yil_veri in trend_data.items() %}
        <div class="col">
            <div class="card oran-card h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 fw-semibold">{{ ad }}</h6>
                        <span class="value-badge">
                            {% for yil, deger in yil_veri.items() %}
                            <div>{{ yil }}: {{ "%.2f"|format(deger) if deger is not none else "-" }}</div>
                            {% endfor %}
                        </span>
                    </div>
                    <div class="oran-action">
                        <button type="button" class="btn btn-outline-primary btn-info-icon" data-ratio="{{ ad }}"
                            data-value="{{ yil_veri.values()|list|last }}">
                            <i class="bi bi-info-circle"></i>
                        </button>
                        <button type="button" class="btn btn-outline-success btn-chart-icon"
                            onclick="openChart('{{ ad|escape }}')">
                            <i class="bi bi-graph-up"></i>
                        </button>

                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Bilgi Modal -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="infoModalLabel">Oran Bilgisi</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 id="infoName" class="fw-bold mb-2"></h6>
                <p id="infoDesc" class="mb-0"></p>
                <div id="ratioDetails"></div>
            </div>
        </div>
    </div>
</div>


<!-- Chart Modal -->
<div class="modal fade" id="chartModal" tabindex="-1" aria-labelledby="chartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="chartTitle"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <canvas id="trendChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block extra_scripts %}
<script>

    const TREND_DATA = {{ trend_data | tojson | safe }};



    const definitions = {
        "Cari Oran": {
            formula: "D칬nen Varl캼klar / K캼sa Vadeli Yabanc캼 Kaynaklar",
            meaning: "Cari oran, i륿etmenin k캼sa vadeli bor칞lar캼n캼 칬deme g칲c칲n칲 g칬sterir. Her sekt칬rde farkl캼 olmakla birlikte, bu oran캼n 2 olmas캼 genellikle yeterli kabul edilir.",
            thresholds: { safe: 2.0, adequate: 1.5 },
            advice: {
                safe: "Cari oran캼n캼z g칲칞l칲. 캻륿etmenizin k캼sa vadeli bor칞lar캼n캼 칬deme g칲c칲 y칲ksektir. Ancak oran캼n 칞ok y칲ksek olmas캼, at캼l fon bulundu릇na veya kaynaklar캼n etkin kullan캼lmad캼캼na i르ret edebilir.",
                adequate: "Cari oran캼n캼z yeterli seviyede. Bor칞 칬deme g칲c칲n칲z makul d칲zeydedir. Daha g칲칞l칲 bir likidite i칞in 2'nin 칲zerine 칞캼kmak g칲venli를 art캼rabilir.",
                risky: "Cari oran캼n캼z zay캼f. 캻륿etmenizin d칬nen varl캼klar캼 k캼sa vadeli bor칞lar캼 kar캼lamaya yetmeyebilir ve net 칞al캼릀a sermayesi noksan캼 ile kar캼 kar캼ya kalabilirsiniz. D칬nen varl캼klar캼n캼z캼 ve nakit rezervlerinizi art캼rmay캼 de른rlendirin."
            }
        },
        "Likidite (Asit Test) Oran캼": {
            formula: "(D칬nen Varl캼klar - Stoklar) / K캼sa Vadeli Yabanc캼 Kaynaklar",
            meaning: "Likidite oran캼 i륿etmenin k캼sa vadeli bor칞lar캼n캼 칬deme g칲c칲n칲 g칬sterir. Stoklar캼 d칬nen varl캼klardan ay캼rd캼캼 i칞in daha keskin bir orand캼r. Stoklar캼n paraya 칞evrilmeme riskini ortadan kald캼r캼r. Oran캼n 1 olmas캼 yeterli kabul edilir.",
            thresholds: { safe: 1.0, adequate: 0.8 },
            advice: {
                safe: "Likidite (Asit Test) oran캼n캼z sa륿캼kl캼. 캻륿etmenizin acil bor칞 칬deme g칲c칲 g칲칞l칲d칲r, stoklar캼n paraya 칞evrilme riskine ba캼ml캼l캼k d칲칲kt칲r.",
                adequate: "Likidite (Asit Test) oran캼n캼z makul seviyede. Stok kalitesi ve nakit ile alacak y칬netimini g칲칞lendirmeyi de른rlendirin.",
                risky: "Likidite (Asit Test) oran캼n캼z zay캼f. 캻륿etmenizin k캼sa vadeli bor칞lar캼n캼 칬deme g칲c칲 stoklara ba캼ml캼 olabilir. Stok ve alacak kalitesini g칬zden ge칞irin."
            }
        },
        "Nakit Oran캼": {
            formula: "(Haz캼r De른rler + Menkul K캼ymetler) / K캼sa Vadeli Yabanc캼 Kaynaklar",
            meaning: "Nakit oran캼, i륿etmenin elindeki mevcut haz캼r de른rlerle k캼sa vadeli yabanc캼 kaynaklar캼n ne 칬l칞칲de kar캼land캼캼n캼 g칬sterir. Di른r likidite oranlar캼na g칬re daha hassas bir orand캼r. Genellikle 0,20 olmas캼 yeterli kabul edilir.",
            thresholds: { safe: 0.20, adequate: 0.15 },
            advice: {
                safe: "Nakit oran캼n캼z g칲칞l칲. 캻륿etmenizin acil durumlar i칞in yeterli nakit rezervi bulunmaktad캼r.",
                adequate: "Nakit oran캼n캼z yeterli d칲zeyde. Nakit ak캼캼n캼z캼 ve likiditeyi izlemeye devam edin.",
                risky: "Nakit oran캼n캼z d칲칲k. 캻륿etmenizin para durumunda s캼k캼캼kl캼k do르bilir ve yeni kredi bulma ihtiyac캼 ortaya 칞캼kabilir. Nakit ak캼캼n캼 ve sermaye y칬netimini g칬zden ge칞irin."
            }
        },
        "Stok Ba캼ml캼l캼k Oran캼": {
            formula: "(K캼sa Vadeli Yabanc캼 Kaynaklar - (Haz캼r De른rler + Menkul K캼ymetler + S칲ratle Paraya 칂evrilebilir Varl캼klar)) / Stoklar",
            meaning: "Bu oran, asit test oran캼n캼n 1'den k칲칞칲k 칞캼kmas캼 durumunda i륿etmenin k캼sa vadeli bor칞lar캼n캼 geri 칬demesinde stoklara olan ba캼ml캼l캼캼n캼 칬l칞mede kullan캼l캼r. D칲칲k olmas캼 istenir, negatif olmas캼 stoklara ba캼ml캼l캼k olmad캼캼n캼 g칬sterir.",
            thresholds: { safe: 0, adequate: 0.5 }, // D칲칲k daha iyi
            advice: {
                safe: "Stoklara ba캼ml캼l캼k yok veya 칞ok d칲칲k. Likidite sorunlar캼 ya르nd캼캼nda stoklar캼 satma bask캼s캼 azd캼r.",
                adequate: "Stoklara ba캼ml캼l캼k makul d칲zeyde. Stok devir h캼z캼n캼 art캼rarak likidite riskini azaltmay캼 de른rlendirin.",
                risky: "Stoklara a캼r캼 ba캼ml캼l캼k var; likidite riski y칲ksek. Acil bor칞 칬demeleri i칞in stoklar캼n h캼zla paraya 칞evrilmesi gerekebilir."
            }
        },
        "Yabanc캼 Kaynak Oran캼": {
            formula: "Toplam Yabanc캼 Kaynaklar / Pasif Toplam캼",
            meaning: "Bu oran, i륿etmenin varl캼klar캼n캼n ne kadarl캼k k캼sm캼n캼n yabanc캼 kaynaklarla finanse edildi를ni g칬sterir. Kald캼ra칞 oran캼 olarak da bilinir. Oran캼n %50 civar캼nda olmas캼 normal kar캼lanabilir. Oran캼n y칲ksek olmas캼 i륿etmenin riskli bir 른kilde finanse edildi를ni g칬sterir.",
            thresholds: { safe: 0.50, adequate: 0.60 },
            advice: {
                safe: "Yabanc캼 kaynak oran캼n캼z d칲칲k, finansal riskiniz azd캼r. Varl캼klar캼n캼z b칲y칲k 칬l칞칲de 칬zkaynaklarla finanse ediliyor.",
                adequate: "Yabanc캼 kaynak oran캼n캼z makul seviyede. Bor칞 y칬netiminizi s칲rd칲r칲n. Geli릀ekte olan 칲lkelerde %60 칲zeri g칬r칲lebilir.",
                risky: "Yabanc캼 kaynak oran캼n캼z y칲ksek. 캻륿etmeniz riskli bir 른kilde finanse ediliyor olabilir. Bor칞 azaltma stratejileri uygulay캼n. Kredi verenler i칞in risk art캼r캼c캼d캼r."
            }
        },
        "칐zkaynak Oran캼": {
            formula: "칐zkaynaklar / Pasif Toplam캼",
            meaning: "Bu oran, i륿etme varl캼klar캼ndan y칲zde ka칞캼n캼n ortaklar veya i륿etme sahibince finanse edildi를ni g칬sterir. 캻륿etmenin finansal dayan캼kl캼l캼캼n캼n g칬stergesidir. Oran캼n %50 civar캼nda olmas캼 normal kar캼lanabilir.",
            thresholds: { safe: 0.50, adequate: 0.30 }, // Y칲ksek daha iyi
            advice: {
                safe: "칐zkaynak oran캼n캼z g칲칞l칲; mali yap캼n캼z sa륿캼kl캼 ve finansal dayan캼kl캼l캼캼n캼z y칲ksek.",
                adequate: "칐zkaynak oran캼n캼z makul seviyede. Uzun vadeli kredi analizlerinde i륿etmenin kredi de른rini tespit amac캼yla yayg캼n olarak kullan캼l캼r.",
                risky: "칐zkaynak oran캼n캼z zay캼f; i륿etmenizin y칲k칲ml칲l칲klerini kar캼lamada g칲칞l칲kle kar캼la릀a riski ortaya 칞캼kabilir. Sermaye yap캼n캼z캼 g칲칞lendirmeyi de른rlendirin."
            }
        },
        "Bor칞 / 칐zsermaye Oran캼": {
            formula: "Toplam Yabanc캼 Kaynaklar / 칐zkaynaklar",
            meaning: "Bu oran, i륿etmenin 칬zkaynaklar캼 ile yabanc캼 kaynaklar캼 aras캼ndaki ili륾iyi g칬sterir. Oran캼n 1 olmas캼 칬zkaynak bor칞 dengesi a칞캼s캼ndan yeterli g칬r칲l칲r. Oran k칲칞칲ld칲k칞e i륿etmenin herhangi bir kriz kar캼s캼nda g칲칞 durumda kalma riski azal캼r.",
            thresholds: { safe: 1.0, adequate: 1.5 }, // D칲칲k daha iyi
            advice: {
                safe: "Bor칞/칐zsermaye oran캼n캼z dengeli; finansal riskiniz d칲칲kt칲r. Varl캼klar캼n캼z b칲y칲k 칬l칞칲de 칬zkaynakla finanse ediliyor.",
                adequate: "Bor칞/칐zsermaye oran캼n캼z makul d칲zeyde. Ancak, 칲칞칲nc칲 ki를lerden sa륿anan kaynaklar캼n ortaklardan sa륿anan kaynaklardan daha fazla oldu릇nu g칬sterebilir.",
                risky: "Bor칞/칐zsermaye oran캼n캼z y칲ksek. 캻륿etmenizin bor칞 y칲k칲 fazlad캼r ve herhangi bir kriz durumunda g칲칞l칲k 칞ekme riski artabilir. Bor칞 azaltma stratejileri uygulay캼n."
            }
        },
        "K캼sa Vadeli Yabanc캼 Kaynak Oran캼": {
            formula: "K캼sa Vadeli Yabanc캼 Kaynaklar Toplam캼 / Pasif Toplam캼",
            meaning: "Aktiflerin ne kadarl캼k b칬l칲m칲n칲n k캼sa vadeli yabanc캼 kaynaklarla finanse edildi를ni g칬sterir. Pasif i칞inde k캼sa vadeli yabanc캼 kaynaklar캼n a캼rl캼캼n캼 g칬steren bir orand캼r. Bu oran캼n 1/3 (%33) seviyesini a릀as캼 uygun olur.",
            thresholds: { safe: 0.33, adequate: 0.50 }, // D칲칲k daha iyi
            advice: {
                safe: "K캼sa vadeli bor칞 y칲k칲n칲z d칲칲k; finansal yap캼n캼z sa륿amd캼r.",
                adequate: "K캼sa vadeli bor칞 y칲k칲n칲z makul seviyededir. Ancak %50 dolaylar캼nda olmas캼 geli릀ekte olan 칲lkelerde s캼k g칬r칲lse de riskleri olabilir.",
                risky: "K캼sa vadeli bor칞 y칲k칲n칲z y칲ksek; aktiflerin b칲y칲k b칬l칲m칲 k캼sa vadeli yabanc캼 kaynaklarla finanse ediliyor. 캻륿etmenizin 칬deme darbo르z캼na girme riski olabilir."
            }
        },
        "Uzun Vadeli Yabanc캼 Kaynak Oran캼": {
            formula: "Uzun Vadeli Yabanc캼 Kaynaklar Toplam캼 / Pasif Toplam캼",
            meaning: "Bu oran, i륿etmenin sahip oldu릇 varl캼klar캼n ne kadarl캼k k캼sm캼n캼n uzun vadeli yabanc캼 kaynaklarla finanse edildi를ni g칬sterir. Oran캼n normal 르rtlarda 1/6 (%16-17) olmas캼 gerekmektedir.",
            thresholds: { safe: 0.17, adequate: 0.30 }, // Sekt칬re g칬re de를를r.
            advice: {
                safe: "Uzun vadeli bor칞 yap캼n캼z dengeli.",
                adequate: "Uzun vadeli bor칞 yap캼n캼z makul seviyede. K캼sa vadeli yabanc캼 kaynak oran캼n캼 azaltmak kayd캼yla normal kabul edilebilir.",
                risky: "Uzun vadeli bor칞 y칲k칲n칲z y칲ksek. Dikkatli olunmal캼d캼r."
            }
        },
        "Yabanc캼 Kaynaklar Vade Yap캼s캼 Oran캼": {
            formula: "K캼sa Vadeli Yabanc캼 Kaynaklar Toplam캼 / Toplam Yabanc캼 Kaynaklar",
            meaning: "K캼sa vadeli yabanc캼 kaynaklar캼n, toplam yabanc캼 kaynaklar i칞indeki nispi 칬nemini tespite y칬nelik olarak hesaplan캼r. Bu oran캼n genel standart olarak 2/3 (%66) dolay캼nda olmas캼 kabul edilebilir.",
            thresholds: { safe: 0.66, adequate: 0.80 }, // D칲칲k k캼sa vade pay캼 daha iyi, yani bu e를klerin alt캼 daha iyi
            advice: {
                safe: "Bor칞 vadesi yap캼n캼z dengeli; uzun vadeli kaynak pay캼 yeterli.",
                adequate: "K캼sa vade pay캼 makul; ancak iyile릆irme potansiyeli olabilir.",
                risky: "K캼sa vade pay캼 y칲ksek; likidite riski ve finansman bask캼s캼 artabilir."
            }
        },
        "Alacak Devir H캼z캼": {
            formula: "Net Sat캼륿ar / Ortalama Ticari Alacaklar",
            meaning: "Alacaklar캼n y캼lda ka칞 defa tahsil edildi를ni g칬sterir. H캼z artt캼k칞a alacaklar캼n likidite de른ri artar. Genellikle 4-6 ve 칲zeri iyi kabul edilir.",
            thresholds: { safe: 6, adequate: 4 },
            advice: {
                safe: "Alacak tahsilat캼n캼z h캼zl캼; kredi riskiniz d칲칲kt칲r ve fonlar daha verimli kullan캼l캼r.",
                adequate: "Alacak tahsilat캼n캼z makul seviyede; alacak takibini g칲칞lendirmeyi de른rlendirin.",
                risky: "Alacak tahsilat캼n캼z yava; kredi politikas캼 g칬zden ge칞irmeli ve tahsilat s칲re칞lerinizi h캼zland캼rmal캼s캼n캼z."
            }
        },
        "Stok Devir H캼z캼": {
            formula: "Sat캼륿ar캼n Maliyeti / Ortalama Stoklar",
            meaning: "Stoklar캼n y캼lda ka칞 defa sat캼ld캼캼n캼 g칬sterir. H캼z artt캼k칞a verimlilik artar. Sekt칬re g칬re de를릀ekle birlikte y칲ksek olmas캼 olumludur.",
            thresholds: { safe: 8, adequate: 5 },
            advice: {
                safe: "Stok y칬netiminiz verimli; stoklar h캼zla sat캼lmakta ve maliyetler d칲칲k tutulmaktad캼r.",
                adequate: "Stok devir h캼z캼n캼z makul seviyede; stok rotasyonunu h캼zland캼rma f캼rsatlar캼 olabilir.",
                risky: "Stoklar캼n캼z stoklanm캼 veya yava sat캼lmakta; depolama maliyetleri ve demode olma riski y칲ksek olabilir. Sat캼 stratejilerini g칬zden ge칞irin."
            }
        },
        "Aktif Devir H캼z캼": {
            formula: "Net Sat캼륿ar / Toplam Aktif",
            meaning: "캻륿etmenin aktif varl캼klar캼n캼n ka칞 kat캼 sat캼 yapt캼캼n캼 g칬sterir. Aktif devir h캼z캼n캼n y칲ksek olmas캼 olumludur. Genellikle 1 ve 칲zeri iyidir.",
            thresholds: { safe: 1.0, adequate: 0.8 },
            advice: {
                safe: "Aktifleriniz verimli kullan캼l캼yor; sat캼 yaratma kapasiteniz g칲칞l칲d칲r.",
                adequate: "Aktif devir h캼z캼n캼z makul seviyede; varl캼k kullan캼m캼n캼 optimize etme f캼rsatlar캼 olabilir.",
                risky: "Varl캼klar캼n캼z verimsiz kullan캼l캼yor; yat캼r캼mlar캼n캼z캼n sat캼르 d칬n칲칲m칲 zay캼f olabilir. Varl캼k y칬netim kararlar캼n캼z캼 g칬zden ge칞irin."
            }
        },
        "Br칲t Kar Marj캼": {
            formula: "(Br칲t Sat캼 K칙r캼 / Net Sat캼륿ar) * 100",
            meaning: "Net sat캼륿ar캼n y칲zde ka칞캼 oran캼nda br칲t sat캼 k칙r캼 elde edildi를ni g칬sterir. Y칲ksek olmas캼 istenir ve sekt칬r ortalamalar캼yla kar캼la릆캼r캼lmal캼d캼r.",
            thresholds: { safe: 0.30, adequate: 0.20 }, // Y칲ksek daha iyi
            advice: {
                safe: "Br칲t kar marj캼n캼z g칲칞l칲; ana i faaliyetleriniz olduk칞a karl캼.",
                adequate: "Br칲t kar marj캼n캼z makul seviyede; maliyet kontrol칲 veya fiyatlama stratejileri iyile릆irilebilir.",
                risky: "Br칲t kar marj캼n캼z d칲칲k; 칲r칲n fiyatland캼rman캼z캼, sat캼륿ar캼n maliyetini veya 칲retim verimlili를nizi g칬zden ge칞irin."
            }
        },
        "Faaliyet Kar Marj캼": {
            formula: "(Faaliyet K칙r캼 / Net Sat캼륿ar) * 100",
            meaning: "캻륿etmenin ana faaliyetlerinin ne 칬l칞칲de k칙rl캼 oldu릇nu g칬sterir. Y칲ksek olmas캼 olumludur.",
            thresholds: { safe: 0.05, adequate: 0.02 }, // Y칲ksek daha iyi, sekt칬rden sekt칬re de를를r
            advice: {
                safe: "Faaliyet kar marj캼n캼z g칲칞l칲; ana operasyonlar캼n캼z olduk칞a karl캼 ve verimli.",
                adequate: "Faaliyet kar marj캼n캼z makul seviyede; operasyonel verimlilik art캼r캼labilir.",
                risky: "Faaliyet kar marj캼n캼z d칲칲k; ana faaliyetlerinizin karl캼l캼캼n캼 ve faaliyet giderlerinizi inceleyin."
            }
        },
        "Ola르n Kar Marj캼": {
            formula: "(Ola르n K칙r / Net Sat캼륿ar) * 100",
            meaning: "캻륿etmelerin s칲reklilik g칬steren ana ve yan faaliyetlerinin sonucunu g칬sterir. Y칲ksek olmas캼 istenir.",
            thresholds: { safe: 0.04, adequate: 0.02 }, // Y칲ksek daha iyi
            advice: {
                safe: "Ola르n kar marj캼n캼z g칲칞l칲; i륿etmenizin d칲zenli faaliyetleri karl캼.",
                adequate: "Ola르n kar marj캼n캼z makul seviyede. Yan faaliyetlerin veya finansman giderlerinin karl캼l캼르 etkisini inceleyin.",
                risky: "Ola르n kar marj캼n캼z d칲칲k; i륿etmenizin d칲zenli faaliyetleri beklenenden az karl캼 olabilir."
            }
        },
        "D칬nem Kar Marj캼": {
            formula: "(D칬nem K칙r캼 / Net Sat캼륿ar) * 100",
            meaning: "캻륿etmenin d칬nem k칙r캼 veya zarar캼n캼n net sat캼륿ar i칞indeki oran캼n캼 g칬sterir. Y칲ksek olmas캼 olumludur.",
            thresholds: { safe: 0.05, adequate: 0.03 }, // Y칲ksek daha iyi
            advice: {
                safe: "D칬nem kar marj캼n캼z g칲칞l칲; i륿etmeniz genel olarak karl캼 bir d칬nemi geride b캼rakm캼.",
                adequate: "D칬nem kar marj캼n캼z makul seviyede. Ola르nd캼캼 gelir ve giderlerin etkisini inceleyin.",
                risky: "D칬nem kar marj캼n캼z d칲칲k; i륿etmenizin genel karl캼l캼캼 beklentilerin alt캼nda olabilir."
            }
        },
        "Net Kar Marj캼 (Sat캼륿ar캼n Karl캼l캼캼)": {
            formula: "(D칬nem Net K칙r캼 / Net Sat캼륿ar) * 100",
            meaning: "T칲m faaliyetlerin sonucunda elde edilen net verimlili를 g칬sterir. Y칲ksek olmas캼 istenir. B칲y칲k sanayi i륿etmelerinde %4-6 aras캼nda olmas캼 uygun g칬r칲l칲r.",
            thresholds: { safe: 0.04, adequate: 0.02 }, // Y칲ksek daha iyi
            advice: {
                safe: "Net kar marj캼n캼z sa륿캼kl캼; i륿etmeniz genel olarak y칲ksek bir net verimlilikle 칞al캼캼yor.",
                adequate: "Net kar marj캼n캼z makul seviyede; t칲m faaliyetler sonras캼 verimlili를 izlemeye devam edin.",
                risky: "Net kar marj캼n캼z d칲칲k; genel karl캼l캼k sorunlar캼 veya gider y칬netimi problemleri olabilir."
            }
        },
        "칐zsermaye Karl캼l캼캼": {
            formula: "(D칬nem Net K칙r캼 / 칐zkaynaklar) * 100",
            meaning: "캻륿etme ortaklar캼n캼n yat캼r캼mlar캼n캼n ne 칬l칞칲de verimli kullan캼ld캼캼n캼 g칬sterir. Y칲ksek olmas캼 olumludur. Genellikle %15 ve 칲zeri iyidir.",
            thresholds: { safe: 0.15, adequate: 0.10 },
            advice: {
                safe: "칐zkaynak getirisi y칲ksek; ortaklar캼n캼z캼n yat캼r캼mlar캼 verimli bir 른kilde de른r yarat캼yor.",
                adequate: "칐zkaynak getirisi makul; s칲rd칲r칲lebilir b칲y칲me ve karl캼l캼k i칞in izlemeye devam edin.",
                risky: "칐zkaynak getirisi d칲칲k; sermayenin verimlili를ni art캼rmal캼 veya sermaye yap캼s캼n캼 g칬zden ge칞irmelisiniz."
            }
        },
        "Aktif Karl캼l캼캼": {
            formula: "(D칬nem K칙r캼 / Aktif Toplam캼) * 100",
            meaning: "Aktiflerin i륿etmede ne 칬l칞칲de k칙rl캼 kullan캼ld캼캼n캼 tespit amac캼yla hesaplan캼r. Y칲ksek de른r tercih edilir.",
            thresholds: { safe: 0.10, adequate: 0.07 },
            advice: {
                safe: "Varl캼k karl캼l캼캼 y칲ksek; i륿etmenizin varl캼klar캼 karl캼 ve etkin bir 른kilde kullan캼l캼yor.",
                adequate: "Varl캼k karl캼l캼캼n캼z makul seviyede; varl캼k kullan캼m캼n캼 optimize etme f캼rsatlar캼 olabilir.",
                risky: "Varl캼k karl캼l캼캼n캼z d칲칲k; varl캼klar캼n캼zdan yeterince kar elde edilemiyor. Varl캼k verimlili를ni art캼rma stratejileri geli릆irin."
            }
        },
        "Hisse Ba캼na K칙r (EPS)": {
            formula: "D칬nem Net K칙r캼 / Toplam Hisse Say캼s캼",
            meaning: "Hisse ba캼na d칲른n net kar miktar캼n캼 g칬sterir. Yat캼r캼mc캼lar i칞in 칬nemli bir g칬stergedir.",
            thresholds: { safe: null, adequate: null }, // Bu oran i칞in spesifik e를k de른rleri piyasaya ve 를rketin b칲y칲me evresine g칬re de를를r.
            advice: {
                safe: "EPS de른ri olumlu ve y칲ksek. 룔rket hisse ba캼na iyi bir kazan칞 sa륿am캼.",
                adequate: "EPS de른ri makul seviyede. 룔rketin kazan칞 istikrar캼n캼 ve b칲y칲me potansiyelini de른rlendirin.",
                risky: "EPS de른ri d칲칲k veya negatif. 룔rketin karl캼l캼캼 ve hisse ba캼na kazanc캼 zay캼f olabilir; kar art캼rma stratejileri geli릆irilmelidir."
            }
        },
        "Fiyat Kazan칞 (F/K) Oran캼": {
            formula: "Hisse Fiyat캼 / Hisse Ba캼na K칙r (EPS)",
            meaning: "Hisse senedinin borsa de른ri ile hisse ba캼na k칙r aras캼ndaki ba륿ant캼y캼 g칬sterir. D칲칲k F/K oran캼 genellikle hisse senedinin g칬receli olarak 'ucuz' oldu릇nu i르ret edebilir.",
            thresholds: { safe: 15.0, adequate: 20.0 }, // D칲칲k P/E genellikle daha iyi de른rleme g칬sterir
            advice: {
                safe: "Fiyat/Kazan칞 (F/K) oran캼n캼z makul seviyede; de른rleme dengeli g칬r칲n칲yor.",
                adequate: "F/K oran캼n캼z makul ancak piyasa ko릇llar캼na g칬re daha detayl캼 incelenmelidir.",
                risky: "F/K oran캼n캼z y칲ksek; hisse senedi a캼r캼 de른rlenmi olabilir veya piyasan캼n y칲ksek beklentilerini yans캼tabilir."
            }
        },
        "Piyasa De른ri / Defter De른ri Oran캼": {
            formula: "(Toplam Borsa De른ri) / 칐zkaynaklar",
            meaning: "캻륿etmenin borsa de른rinin 칬zkaynaklar캼n캼n ka칞 kat캼 oldu릇nu g칬sterir. Genellikle 1 칲zeri olmas캼, piyasan캼n 를rketi defter de른rinden daha de른rli g칬rd칲칲n칲 g칬sterir.",
            thresholds: { safe: 1.0, adequate: 0.8 }, // Genellikle 1 ve 칲zeri iyi
            advice: {
                safe: "Piyasa de른ri / Defter de른ri oran캼n캼z olumlu; piyasa 를rketinizi defter de른rinin 칲zerinde fiyatl캼yor.",
                adequate: "Piyasa de른ri / Defter de른ri oran캼n캼z makul seviyede.",
                risky: "Piyasa de른ri / Defter de른ri oran캼n캼z d칲칲k; piyasa 를rketinizi defter de른rinin alt캼nda fiyatl캼yor olabilir, bu da potansiyel sorunlara veya d칲칲k beklentilere i르ret edebilir."
            }
        }
    };


    document.addEventListener('DOMContentLoaded', function () {

        // --- Bilgi butonlar캼 ---
        document.querySelectorAll('.btn-info-icon').forEach(btn => {
            btn.addEventListener('click', () => {

                const ratioName = btn.dataset.ratio;
                const ratioValue = parseFloat(btn.dataset.value);
                const definition = definitions[ratioName];
                const detailsContainer = document.getElementById('ratioDetails');

                // Ba륿캼k ve a칞캼klama
                document.getElementById('infoName').innerText = ratioName;
                
                document.getElementById('infoDesc').innerText = definition
                
                    ? definition.meaning
                    : 'Bu oran i칞in a칞캼klama bulunamad캼.';

                // Tan캼m yoksa uyar캼 g칬ster
                if (!definition) {
                    detailsContainer.innerHTML = `
                    <div class="alert alert-warning">Bu oran i칞in detayl캼 bilgi bulunamad캼.</div>
                `;
                    const modal = new bootstrap.Modal(document.getElementById('infoModal'));
                    modal.show();
                    return;
                }

                // De른rlendirme metni
                let evaluationText = '';
                if (!isNaN(ratioValue) && definition.thresholds) {

                    const lowerIsBetterRatios = [
                        "Stok Ba캼ml캼l캼k Oran캼",
                        "Bor칞 / 칐zsermaye Oran캼",
                        "K캼sa Vadeli Yabanc캼 Kaynak Oran캼",
                        "Yabanc캼 Kaynaklar Vade Yap캼s캼 Oran캼",
                        "Fiyat Kazan칞 (F/K) Oran캼"
                    ];

                    if (lowerIsBetterRatios.includes(ratioName)) {
                        if (ratioValue <= definition.thresholds.safe) {
                            evaluationText = definition.advice.safe;
                        } else if (ratioValue <= definition.thresholds.adequate) {
                            evaluationText = definition.advice.adequate;
                        } else {
                            evaluationText = definition.advice.risky;
                        }
                    } else {
                        if (ratioValue >= definition.thresholds.safe) {
                            evaluationText = definition.advice.safe;
                        } else if (ratioValue >= definition.thresholds.adequate) {
                            evaluationText = definition.advice.adequate;
                        } else {
                            evaluationText = definition.advice.risky;
                        }
                    }

                } else if (isNaN(ratioValue)) {
                    evaluationText = "Bu oran i칞in de른r hesaplanamad캼 veya ge칞ersiz.";
                } else {
                    evaluationText = definition.advice.safe;
                }

                // Modal i칞eri를 olu릆ur
                detailsContainer.innerHTML = `
                <div class="card shadow-sm p-4 animate__animated animate__fadeIn">
                    <h5 class="card-title mb-3">${ratioName} Detaylar캼</h5>
                    <h6>Form칲l:</h6>
                    <p><code>${definition.formula}</code></p>
                    <h6>A칞캼klama:</h6>
                    <p>${definition.meaning}</p>
                    ${evaluationText ? `<h6>Firma 캻칞in De른rlendirme:</h6><p>${evaluationText}</p>` : ''}
                    <button type="button" class="btn btn-sm btn-secondary mt-3"
                        onclick="document.getElementById('ratioDetails').innerHTML = ''">Kapat</button>
                </div>
            `;

                // Modal a칞
                const modal = new bootstrap.Modal(document.getElementById('infoModal'));
                modal.show();
            });
        });

        // --- Grafik butonlar캼 ---
        let chartInstance = null;

        window.openChart = function (ratioName) {
            const chartModalEl = document.getElementById('chartModal');
            const chartTitle = document.getElementById('chartTitle');
            const ctx = document.getElementById('trendChart').getContext('2d');

            // Ba륿캼k
            chartTitle.innerText = `游늳 ${ratioName} - Trend Grafi를`;

            // Veri haz캼rla
            const trendData = TREND_DATA[ratioName] || {};
            const years = Object.keys(trendData).sort();
            const values = years.map(y => trendData[y]);

            // 칐nceki grafik varsa sil
            if (chartInstance) chartInstance.destroy();

            // Yeni grafik olu릆ur
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: ratioName,
                        data: values,
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25,135,84,0.15)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.parsed.y?.toFixed(2)}`
                            }
                        }
                    },
                    scales: { y: { beginAtZero: false } }
                }
            });

            // Modal a칞
            const chartModal = new bootstrap.Modal(chartModalEl);
            chartModal.show();
        };

        // --- Form submit debounce ---
        let timeout;
        document.querySelectorAll('#finansalForm select').forEach(sel => {
            sel.addEventListener('change', () => {
                clearTimeout(timeout);
                timeout = setTimeout(() => document.getElementById('finansalForm').submit(), 500);
            });
        });

        const uyarilar = {{ uyarilar|tojson|safe }};
        if (uyarilar.length > 0) {
        let htmlList = "<ul style='text-align:left'>";
        uyarilar.forEach(u => htmlList += `<li>${u}</li>`);
        htmlList += "</ul>";

            Swal.fire({
                icon: 'warning',
                title: 'Veri Tutars캼zl캼캼 Uyar캼s캼 丘멆잺',
                html: htmlList,
                confirmButtonText: 'Tamam',
                confirmButtonColor: '#d33',
                background: '#fffbe6'
            });
        }

    });
</script>
{% endblock %}