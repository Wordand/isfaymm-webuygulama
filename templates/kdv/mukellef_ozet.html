{% extends "kdv/layout.html" %}

{% block title %}KDV İade Özeti - {{ mukellef.unvan }}{% endblock %}

{% block extra_head %}
<style>
    :root {
        --ozet-primary: #2563eb;
        --ozet-success: #059669;
        --ozet-danger: #ef4444;
        --ozet-warning: #d97706;
    }

    body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; }

    /* Back Button */
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #64748b;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.9rem;
        padding: 8px 16px;
        border-radius: 12px;
        transition: all 0.2s;
        margin-bottom: 24px;
    }
    .back-link:hover { background: white; color: var(--ozet-primary); box-shadow: 0 2px 8px rgba(0,0,0,0.06); }

    /* Page Header */
    .ozet-header {
        background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 50%, #1e293b 100%);
        border-radius: 24px;
        padding: 36px 40px;
        color: white;
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
    }
    .ozet-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(37, 99, 235, 0.15) 0%, transparent 70%);
        border-radius: 50%;
    }
    .ozet-header .company-name {
        font-size: 1.8rem;
        font-weight: 800;
        letter-spacing: -0.5px;
        margin-bottom: 8px;
        position: relative;
    }
    .ozet-header .meta-row {
        display: flex;
        gap: 24px;
        align-items: center;
        flex-wrap: wrap;
        position: relative;
    }
    .ozet-header .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        opacity: 0.8;
    }
    .ozet-header .meta-item i { font-size: 0.85rem; }
    .header-actions {
        position: absolute;
        top: 36px;
        right: 40px;
        display: flex;
        gap: 12px;
    }
    .header-actions .btn-header {
        padding: 10px 20px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 0.85rem;
        text-decoration: none;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    .btn-header.primary {
        background: rgba(37, 99, 235, 0.2);
        color: #93c5fd;
        border: 1px solid rgba(37, 99, 235, 0.3);
    }
    .btn-header.primary:hover {
        background: var(--ozet-primary);
        color: white;
    }

    /* Summary Cards Grid */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 16px;
        margin-bottom: 30px;
    }
    @media (max-width: 1200px) { .summary-cards { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 768px) { .summary-cards { grid-template-columns: repeat(2, 1fr); } }

    .summary-card {
        background: white;
        border-radius: 20px;
        padding: 22px;
        border: 1px solid #e2e8f0;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }
    .summary-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0,0,0,0.06);
    }
    .summary-card .sc-icon {
        width: 42px; height: 42px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        margin-bottom: 14px;
    }
    .summary-card .sc-label {
        font-size: 0.7rem;
        font-weight: 700;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }
    .summary-card .sc-value {
        font-size: 1.3rem;
        font-weight: 800;
        color: #1e293b;
        font-variant-numeric: tabular-nums;
    }
    .sc-icon.blue { background: #eff6ff; color: var(--ozet-primary); }
    .sc-icon.green { background: #ecfdf5; color: var(--ozet-success); }
    .sc-icon.red { background: #fef2f2; color: var(--ozet-danger); }
    .sc-icon.amber { background: #fffbeb; color: var(--ozet-warning); }
    .sc-icon.purple { background: #f5f3ff; color: #7c3aed; }
    .sc-icon.teal { background: #f0fdfa; color: #0d9488; }

    /* Table Container */
    .table-container {
        background: white;
        border-radius: 24px;
        border: 1px solid #e2e8f0;
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
    }
    .table-header {
        padding: 24px 28px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #f1f5f9;
    }
    .table-header h5 {
        font-weight: 800;
        font-size: 1.1rem;
        color: #1e293b;
        margin: 0;
    }
    .table-header .file-count {
        background: #eff6ff;
        color: var(--ozet-primary);
        padding: 6px 14px;
        border-radius: 10px;
        font-weight: 700;
        font-size: 0.82rem;
    }

    /* Data Table */
    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }
    .data-table thead th {
        background: #f8fafc;
        padding: 14px 16px;
        font-weight: 700;
        font-size: 0.72rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
        border-bottom: 2px solid #e2e8f0;
        position: sticky;
        top: 0;
        z-index: 2;
    }
    .data-table tbody td {
        padding: 14px 16px;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
    }
    .data-table tbody tr { transition: background 0.15s; }
    .data-table tbody tr:hover td { background: #f8fafc; }
    .data-table tbody tr:last-child td { border-bottom: none; }

    /* Money Values */
    .money { font-weight: 700; font-variant-numeric: tabular-nums; white-space: nowrap; }
    .money.positive { color: var(--ozet-success); }
    .money.negative { color: var(--ozet-danger); }
    .money.zero { color: #cbd5e1; }

    /* Badges */
    .period-badge {
        font-weight: 800;
        color: #1e293b;
        background: #e2e8f0;
        padding: 5px 12px;
        border-radius: 10px;
        font-size: 0.82rem;
        white-space: nowrap;
    }
    .type-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 700;
    }
    .type-badge.ihracat { background: #dbeafe; color: #1e40af; }
    .type-badge.indirimli { background: #fef3c7; color: #92400e; }
    .type-badge.iade { background: #d1fae5; color: #065f46; }
    .type-badge.diger { background: #f1f5f9; color: #475569; }

    .request-type {
        font-size: 0.8rem;
        font-weight: 600;
        color: #475569;
    }

    .status-pill {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 8px;
        font-size: 0.72rem;
        font-weight: 700;
        white-space: nowrap;
    }
    .status-pill.ongoing { background: #fef3c7; color: #92400e; }
    .status-pill.completed { background: #d1fae5; color: #065f46; }
    .status-pill.problem { background: #fecaca; color: #991b1b; }

    /* Totals Row */
    .totals-row td {
        background: linear-gradient(135deg, #f0fdf4, #ecfdf5) !important;
        font-weight: 800 !important;
        border-top: 2px solid var(--ozet-success) !important;
        font-size: 0.9rem;
        padding: 16px !important;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 80px 30px;
    }
    .empty-state .empty-icon {
        width: 80px; height: 80px;
        background: #f1f5f9;
        border-radius: 24px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #94a3b8;
        margin-bottom: 20px;
    }

    /* Loading Skeleton */
    .skeleton {
        background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 8px;
    }
    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* Action Link */
    .file-link {
        color: var(--ozet-primary);
        text-decoration: none;
        font-weight: 600;
        font-size: 0.8rem;
        transition: 0.2s;
    }
    .file-link:hover { text-decoration: underline; }

    /* New Modal Styles */
    .month-btn {
        flex: 1;
        min-width: 45px;
        padding: 8px 0;
        border: 1px solid #e2e8f0;
        background: white;
        border-radius: 8px;
        color: #64748b;
        font-weight: 600;
        font-size: 0.85rem;
        transition: all 0.2s;
    }
    .month-btn:hover { background: #f8fafc; color: var(--ozet-primary); border-color: #cbd5e1; }
    .month-btn.active {
        background: var(--ozet-primary);
        color: white;
        border-color: var(--ozet-primary);
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
    }
</style>
{% endblock %}

{% block content %}
<div style="padding: 30px 40px;">
    <!-- Back -->
    <a href="{{ url_for('kdv.mukellefler') }}" class="back-link">
        <i class="fa-solid fa-arrow-left"></i> Mükelleflere Dön
    </a>

    <!-- Header -->
    <div class="ozet-header">
        <div class="company-name">{{ mukellef.unvan }}</div>
        <div class="meta-row">
            <div class="meta-item">
                <i class="fa-solid fa-id-card"></i>
                <span>VKN: {{ mukellef.vkn }}</span>
            </div>
            {% if mukellef.vergi_dairesi %}
            <div class="meta-item">
                <i class="fa-solid fa-building"></i>
                <span>{{ mukellef.vergi_dairesi }}</span>
            </div>
            {% endif %}
            {% if mukellef.ilgili_memur %}
            <div class="meta-item">
                <i class="fa-solid fa-user-tie"></i>
                <span>{{ mukellef.ilgili_memur }}</span>
            </div>
            {% endif %}
        </div>
        <div class="header-actions">
            <button class="btn-header primary me-2" data-bs-toggle="modal" data-bs-target="#addFileModal">
                <i class="fa-solid fa-plus"></i> Yeni Dosya Ekle
            </button>
            <a href="{{ url_for('kdv.index') }}?mukellef={{ mukellef.id }}" class="btn-header primary">
                <i class="fa-solid fa-folder-open"></i> Dosyaları İncele
            </a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards" id="summaryCards">
        <div class="summary-card">
            <div class="sc-icon blue"><i class="fa-solid fa-file-invoice"></i></div>
            <div class="sc-label">Aktif Dosya</div>
            <div class="sc-value" id="scFileCount"><div class="skeleton" style="width:50px;height:24px;"></div></div>
        </div>
        <div class="summary-card">
            <div class="sc-icon green"><i class="fa-solid fa-money-bill-trend-up"></i></div>
            <div class="sc-label">Talep Edilen</div>
            <div class="sc-value" id="scRequest"><div class="skeleton" style="width:100px;height:24px;"></div></div>
        </div>
        <div class="summary-card">
            <div class="sc-icon purple"><i class="fa-solid fa-shield-halved"></i></div>
            <div class="sc-label">Teminatlı İade</div>
            <div class="sc-value" id="scGuarantee"><div class="skeleton" style="width:100px;height:24px;"></div></div>
        </div>
        <div class="summary-card">
            <div class="sc-icon amber"><i class="fa-solid fa-scale-balanced"></i></div>
            <div class="sc-label">Tenzil Tutarı</div>
            <div class="sc-value" id="scTenzil"><div class="skeleton" style="width:80px;height:24px;"></div></div>
        </div>
        <div class="summary-card">
            <div class="sc-icon red"><i class="fa-solid fa-ban"></i></div>
            <div class="sc-label">Bloke Tutar</div>
            <div class="sc-value" id="scBloke"><div class="skeleton" style="width:80px;height:24px;"></div></div>
        </div>
        <div class="summary-card">
            <div class="sc-icon teal"><i class="fa-solid fa-circle-check"></i></div>
            <div class="sc-label">Sonuçlanan</div>
            <div class="sc-value" id="scResolved"><div class="skeleton" style="width:100px;height:24px;"></div></div>
        </div>
    </div>

    <!-- Table -->
    <div class="table-container">
        <div class="table-header">
            <h5><i class="fa-solid fa-table-list me-2 text-primary"></i>İade Dosyaları Detay Tablosu</h5>
            <span class="file-count" id="tableFileCount">Yükleniyor...</span>
        </div>
        <div style="overflow-x: auto;">
            <table class="data-table" id="dataTable">
                <thead>
                    <tr>
                        <th>Dönem</th>
                        <th>İade Türü</th>
                        <th>Talep Türü</th>
                        <th style="text-align:right">Talep Edilen İade</th>
                        <th style="text-align:right">Teminatlı İade</th>
                        <th style="text-align:right">Tem. Sonrası İade</th>
                        <th style="text-align:right">Tenzil Tutarı</th>
                        <th style="text-align:right">Bloke Tutarı</th>
                        <th style="text-align:right">Sonuçlanan İade</th>
                        <th>Durum</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="11" class="text-center py-5">
                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                            Veriler yükleniyor...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Edit Amounts Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius:20px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Tutarları Güncelle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="editForm">
                    <input type="hidden" id="editFileId">
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label small fw-bold text-muted">TALEP EDİLEN İADE</label>
                            <input type="number" step="0.01" id="editRequest" class="form-control fw-bold" oninput="calcPostGuarantee()">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label small fw-bold text-muted">TEMİNATLI İADE</label>
                            <input type="number" step="0.01" id="editGuarantee" class="form-control fw-bold text-primary" oninput="calcPostGuarantee()">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">TEMİNAT SONRASI İADE (Otomatik)</label>
                        <input type="text" id="editPostGuarantee" class="form-control fw-bold bg-light" readonly>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label small fw-bold text-muted">TENZİL TUTARI</label>
                            <input type="number" step="0.01" id="editTenzil" class="form-control fw-bold text-warning">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label small fw-bold text-muted">BLOKE TUTARI</label>
                            <input type="number" step="0.01" id="editBloke" class="form-control fw-bold text-danger">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">SONUÇLANAN İADE</label>
                        <input type="number" step="0.01" id="editResolved" class="form-control fw-bold text-success">
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0 px-4 pb-4">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" onclick="saveAmounts()">Kaydet</button>
            </div>
        </div>
    </div>
<!-- Add File Modal (New Design) -->
<div class="modal fade" id="addFileModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius:24px;">
            <div class="modal-header border-0 pb-0 pt-4 px-4">
                <h5 class="modal-title fw-bold text-dark fs-4">Yeni İade Dosyası Tanımla</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="addFileForm">
                    <input type="hidden" id="addMukellefId" value="{{ mukellef.id }}">
                    
                    <!-- Row 1: Mukellef & Year -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <label class="form-label small fw-bold text-muted mb-1">Mükellef Seçimi</label>
                            <input type="text" class="form-control fw-bold bg-light text-muted border-0 py-2" value="{{ mukellef.unvan }}" readonly>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-muted mb-1">Yıl</label>
                            <select id="addYear" class="form-select border-0 bg-light fw-bold py-2">
                                <option value="2026">2026</option>
                                <option value="2025" selected>2025</option>
                                <option value="2024">2024</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 2: Months -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <label class="form-label small fw-bold text-muted mb-0">Ay Seçimi</label>
                            <button type="button" class="btn btn-link btn-sm p-0 text-decoration-none fw-bold" onclick="selectAllMonths()">Tümünü Seç</button>
                        </div>
                        <div class="d-flex flex-wrap gap-2" id="monthSelector">
                            <input type="hidden" id="selectedMonth" value="">
                            {% for m_name in ['Oca', 'Şub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Ağu', 'Eyl', 'Eki', 'Kas', 'Ara'] %}
                            <button type="button" class="month-btn" data-val="{{ loop.index }}" onclick="toggleMonth(this)">{{ m_name }}</button>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- No Refund Checkbox -->
                    <div class="form-check mb-4 p-3 rounded-3" style="background:#f8fafc; border:1px solid #e2e8f0;">
                        <input class="form-check-input" type="checkbox" id="noRefundCheck" onchange="toggleNoRefund()" style="transform: scale(1.2);">
                        <label class="form-check-label fw-bold text-dark ms-2" for="noRefundCheck">
                            BU DÖNEM İADE HAKKI DOĞMAMIŞTIR
                        </label>
                    </div>

                    <div id="refundFields">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted mb-1">İade Konusu</label>
                                <select id="addSubject" class="form-select border-0 bg-light fw-bold py-2 text-dark" style="font-size: 0.9rem;">
                                    <option value="" disabled selected>İade konusunu seçiniz...</option>
                                    <optgroup label="Tam İstisna Kapsamına Giren İşlemler (300 Serisi)">
                                        <option value="301">301 - Mal İhracatı</option>
                                        <option value="302">302 - Hizmet İhracatı</option>
                                        <option value="303">303 - Roaming Hizmetleri</option>
                                        <option value="304">304 - Deniz, Hava ve Demiryolu Taşıma Araçları (13/a)</option>
                                        <option value="305">305 - Liman/Hava Meydanı Hizmetleri (13/b)</option>
                                        <option value="306">306 - Petrol Aramaları ve Boru Hatları (13/c)</option>
                                        <option value="307">307 - Maden Arama, Altın, Gümüş, Platin (13/c)</option>
                                        <option value="308">308 - Teşvikli Yatırım Malları Teslimi (13/d)</option>
                                        <option value="309">309 - Limanlara Bağlantı Demiryolu/Hava Meydanı İnşası (13/e)</option>
                                        <option value="310">310 - Ulusal Güvenlik Amaçlı Teslim/Hizmet (13/f)</option>
                                        <option value="311">311 - Uluslararası Taşımacılık (14/1)</option>
                                        <option value="312">312 - Diplomatik Organ ve Misyonlar (15/a)</option>
                                        <option value="313">313 - Uluslararası Kuruluşlar (15/b)</option>
                                        <option value="314">314 - Uluslararası Anlaşmalar Kapsamındaki İstisnalar (19/2)</option>
                                        <option value="315">315 - İhracat Eşyası Taşıyan Kamyonlara Motorin Teslimi (14/3)</option>
                                        <option value="316">316 - Serbest Bölgelerdeki Müşterilere Fason Hizmetler (11/1-a)</option>
                                        <option value="317">317 - Engelliler İçin Araç-Gereç ve Program (17/4-s)</option>
                                        <option value="318">318 - Yap-İşlet-Devret / Sağlık / Eğitim Projeleri (Geçici 29)</option>
                                        <option value="319">319 - Başbakanlık Merkez Teşkilatına Araç Teslimi (13/g)</option>
                                        <option value="320">320 - İSMEP Kapsamında Yapılacak Teslim/Hizmet (Geçici 16)</option>
                                        <option value="321">321 - BM/NATO/OECD'ye Yapılacak Teslim/Hizmet (Geçici 26)</option>
                                        <option value="322">322 - Özel Fatura ile Yapılan Teslimler (Bavul Ticareti)</option>
                                        <option value="323">323 - Ürün Senetlerinin İlk Teslimi (13/ğ)</option>
                                        <option value="324">324 - Türkiye Kızılay Derneğine Teslim ve Hizmetler (13/h)</option>
                                        <option value="325">325 - Yem Teslimleri (13/ı)</option>
                                        <option value="326">326 - Gübre Teslimleri (13/ı)</option>
                                        <option value="327">327 - Gübre Hammaddesi Teslimi (13/ı)</option>
                                        <option value="328">328 - Konut veya İşyeri Teslimlerinde İstisna (13/i)</option>
                                        <option value="329">329 - FATİH Projesi Kapsamındaki Teslimler (Geçici 38)</option>
                                        <option value="330">330 - OSB ve Küçük Sanayi Siteleri İnşası (13/j)</option>
                                        <option value="331">331 - Ar-Ge ve Tasarım Makine/Teçhizat Teslimi (13/m)</option>
                                        <option value="332">332 - İmalat Sanayine Makine/Teçhizat Teslimi (Geçici 39)</option>
                                        <option value="333">333 - Kamu İdarelerine Bağışlanan Tesislerin İnşası (13/k)</option>
                                        <option value="334">334 - Yabancılara Verilen Sağlık Hizmetleri (13/l)</option>
                                        <option value="335">335 - Basılı Kitap ve Süreli Yayın Teslimi (13/n)</option>
                                        <option value="336">336 - UEFA Süper Kupa ve Şampiyonlar Ligi Müsabakaları (Geçici 40)</option>
                                        <option value="338">338 - İmalatçıların Mal İhracında İade bedeli (32. md)</option>
                                        <option value="339">339 - İmalat/Turizm Belge Kapsamı İnşaat İşleri (Geçici 37)</option>
                                        <option value="340">340 - Elektrikli Taşıt Geliştirme Mühendislik Hizmeti (Geçici 42)</option>
                                        <option value="350">350 - Diğerleri</option>
                                    </optgroup>
                                    <optgroup label="Diğer İade Hakkı Doğuran İşlemler (400 Serisi)">
                                        <option value="405">405 - İndirimli Orana Tabi İhraç Kayıtlı Teslimler (11/1-c)</option>
                                        <option value="406">406 - İndirimli Oran - Yılı İçinde (29/2)</option>
                                        <option value="408">408 - Yolcu Beraberi Eşya İhracatı (11/1-b)</option>
                                        <option value="409">409 - Hurda ve Atık Teslimi Tevkifatı (9/1)</option>
                                        <option value="410">410 - Yapım İşleri ve Mühendislik/Mimarlık Tevkifatı (9/1)</option>
                                        <option value="411">411 - Temizlik Hizmeti Tevkifatı (9/1)</option>
                                        <option value="412">412 - Çevre ve Bahçe Bakım Hizmeti Tevkifatı (9/1)</option>
                                        <option value="413">413 - Özel Güvenlik Hizmeti Tevkifatı (9/1)</option>
                                        <option value="414">414 - Makine/Teçhizat/Taşıt Tadil ve Bakım Tevkifatı (9/1)</option>
                                        <option value="415">415 - Yemek Servis Hizmeti Tevkifatı (9/1)</option>
                                        <option value="416">416 - Danışmanlık ve Denetim Hizmetleri Tevkifatı (9/1)</option>
                                        <option value="418">418 - Bakır/Çinko/Alüminyum/Kurşun Külçe Tevkifatı (9/1)</option>
                                        <option value="419">419 - Bakır/Çinko/Alüminyum Ürünleri Tevkifatı (9/1)</option>
                                        <option value="420">420 - Yapı Denetim Hizmetleri Tevkifatı (9/1)</option>
                                        <option value="421">421 - İşgücü Temin Hizmeti Tevkifatı (9/1)</option>
                                        <option value="423">423 - Fason Tekstil ve Konfeksiyon Tevkifatı (9/1)</option>
                                        <option value="428">428 - Pamuk/Yün/Deri Teslim Tevkifatı (9/1)</option>
                                        <option value="430">430 - Hurda Metalden Külçe Teslimi Tevkifatı (9/1)</option>
                                        <option value="431">431 - Turistik Mağaza Müşteri Bulma Hizmeti Tevkifatı (9/1)</option>
                                        <option value="432">432 - Organizasyon Hizmetleri Tevkifatı (9/1)</option>
                                        <option value="433">433 - Spor Kulüplerinin Yayın/Reklam/İsim Hakkı Tevkifatı (9/1)</option>
                                        <option value="434">434 - Servis Taşımacılığı Hizmeti Tevkifatı (9/1)</option>
                                        <option value="435">435 - Baskı ve Basım Hizmetleri Tevkifatı (9/1)</option>
                                        <option value="436">436 - 5018 SK Eki Cetvel İdarelerine Diğer Hizmetler (9/1)</option>
                                        <option value="437">437 - Atıklardan Elde Edilen Hammadde Tevkifatı (9/1)</option>
                                        <option value="438">438 - Ağaç ve Orman Ürünleri Teslimi Tevkifatı (9/1)</option>
                                        <option value="439">439 - İndirimli Oran - Yılık (29/2)</option>
                                        <option value="440">440 - Stratejik Yatırımlara İlişkin İnşaat (Geçici 30)</option>
                                        <option value="441">441 - Uluslararası Anlaşmalar Kapsamında İade (19/2)</option>
                                        <option value="442">442 - İmalat Sanayi Yatırım Teşvik İnşaat İşleri (Geçici 37)</option>
                                        <option value="443">443 - TürkAkım Projesi Kapsamında Teslim/Hizmet (19/2)</option>
                                        <option value="444">444 - Kamu İdarelerine Bağışlanan Tesislerin İnşası (13/k)</option>
                                        <option value="445">445 - Yük Taşımacılığı Hizmetleri Tevkifatı (9/1)</option>
                                        <option value="446">446 - Ticari Reklam Hizmetleri Tevkifatı (9/1)</option>
                                        <option value="447">447 - Diğer Teslimlerde Tevkifata Tabi Tutulan KDV (9/1)</option>
                                        <option value="448">448 - Demir - Çelik Ürünlerinin Teslimi (9/1)</option>
                                        <option value="450">450 - Diğerleri</option>
                                    </optgroup>
                                    <optgroup label="Tevkifatlı İşlemler (900 Serisi)">
                                        <option value="901">901 - Hurda ve Atık Teslimi Tevkifatı (9/1)</option>
                                        <option value="902">902 - Yapım İşleri Mimarlık/Mühendislik Tevkifatı (9/1)</option>
                                        <option value="903">903 - Temizlik Hizmeti Tevkifatı (9/1)</option>
                                        <option value="904">904 - Çevre ve Bahçe Bakım Hizmeti Tevkifatı (9/1)</option>
                                        <option value="905">905 - Özel Güvenlik Hizmeti Tevkifatı (9/1)</option>
                                        <option value="906">906 - Makine/Teçhizat/Taşıt Bakım Tevkifatı (9/1)</option>
                                        <option value="907">907 - Yemek Servis Hizmeti Tevkifatı (9/1)</option>
                                        <option value="908">908 - Etüt/Proje/Danışmanlık/Denetim Tevkifatı (9/1)</option>
                                        <option value="909">909 - Bakır/Çinko/D-Çelik/Alüminyum Külçe Teslimi (9/1)</option>
                                        <option value="910">910 - Bakır/Çinko/Alüminyum Ürünleri Tevkifatı (9/1)</option>
                                        <option value="911">911 - Yapı Denetim Hizmetleri Tevkifatı (9/1)</option>
                                        <option value="912">912 - İşgücü Temin Hizmeti Tevkifatı (9/1)</option>
                                        <option value="913">913 - Fason Tekstil ve Konfeksiyon Tevkifatı (9/1)</option>
                                        <option value="914">914 - Pamuk/Yün/Deri Teslim Tevkifatı (9/1)</option>
                                        <option value="915">915 - Hurda Metalden Külçe Teslimi Tevkifatı (9/1)</option>
                                        <option value="916">916 - Turistik Mağaza Müşteri Bulma Tevkifatı (9/1)</option>
                                        <option value="917">917 - Organizasyon Hizmetleri Tevkifatı (9/1)</option>
                                        <option value="918">918 - Spor Kulüplerinin Yayın/Reklam/İsim Hakkı Tevkifatı (9/1)</option>
                                        <option value="919">919 - Servis Taşımacılığı Hizmeti Tevkifatı (9/1)</option>
                                        <option value="920">920 - Baskı ve Basım Hizmetleri Tevkifatı (9/1)</option>
                                        <option value="921">921 - Atıklardan Elde Edilen Hammadde Tevkifatı (9/1)</option>
                                        <option value="922">922 - Ağaç ve Orman Ürünleri Teslimi Tevkifatı (9/1)</option>
                                        <option value="923">923 - Yük Taşımacılığı Hizmetleri Tevkifatı (9/1)</option>
                                        <option value="924">924 - Ticari Reklam Hizmetlerinde Tevkifat (9/1)</option>
                                        <option value="925">925 - Demir Çelik Ürünlerinin Teslimi (9/1)</option>
                                    </optgroup>
                                    <optgroup label="Tecil - Terkin İşlemleri (700 Serisi)">
                                        <option value="701">701 - İhracatı Yapılacak Nihai Ürünlerin Teslimi (11/1-c)</option>
                                        <option value="702">702 - DİİB veya GKİB Kapsamında Yapılan Teslim (Geçici 17)</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted mb-1">İade Türü</label>
                                <select id="addType" class="form-select border-0 bg-light fw-bold py-2">
                                    <option value="" disabled selected>Seçiniz...</option>
                                    <option value="Nakit">Nakit</option>
                                    <option value="Mahsup">Mahsup</option>
                                    <option value="Teminatlı">Teminatlı</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted mb-1">Talep Tutarı (₺)</label>
                            <input type="number" step="0.01" id="addAmount" class="form-control border-0 bg-light fw-bold py-2" placeholder="0.00">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0 px-4 pb-4">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" onclick="saveNewFile()">Kaydet ve Başlat</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Move modals to body to fix z-index issues
    document.querySelectorAll('.modal').forEach(modal => {
        if (modal.parentElement !== document.body) {
            document.body.appendChild(modal);
        }
    });

    var MUKELLEF_ID = {{ mukellef.id }};

    function fmtMoney(val) {
        if (!val || val === 0) return '₺0,00';
        return '₺' + Number(val).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function getStatusClass(status) {
        if (!status) return 'ongoing';
        var s = status.toLowerCase();
        if (s.indexOf('tamamlandı') > -1 || s.indexOf('alındı') > -1) return 'completed';
        if (s.indexOf('eksiklik') > -1 || s.indexOf('bloke') > -1) return 'problem';
        return 'ongoing';
    }

    function getTypeClass(subject) {
        if (!subject) return 'diger';
        var s = subject.toLowerCase();
        if (s.indexOf('ihracat') > -1) return 'ihracat';
        if (s.indexOf('indirimli') > -1) return 'indirimli';
        if (s.indexOf('iade') > -1) return 'iade';
        return 'diger';
    }

    function moneyClass(val) {
        if (!val || val === 0) return 'zero';
        return val > 0 ? 'positive' : '';
    }

    function loadSummary() {
        fetch('/api/kdv/mukellef-summary/' + MUKELLEF_ID)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status !== 'success') {
                    showEmpty('Veri yüklenemedi.');
                    return;
                }

                var t = data.totals;

                // Update cards
                document.getElementById('scFileCount').textContent = data.file_count;
                document.getElementById('scRequest').textContent = fmtMoney(t.amount_request);
                document.getElementById('scGuarantee').textContent = fmtMoney(t.amount_guarantee);
                document.getElementById('scTenzil').textContent = fmtMoney(t.amount_tenzil);
                document.getElementById('scBloke').textContent = fmtMoney(t.amount_bloke);
                document.getElementById('scResolved').textContent = fmtMoney(t.amount_resolved);

                // File count badge
                document.getElementById('tableFileCount').textContent = data.file_count + ' aktif dosya';

                if (!data.files || data.files.length === 0) {
                    showEmpty('Bu mükellefte henüz aktif KDV iade dosyası bulunmuyor.');
                    return;
                }

                // Build table rows
                var html = '';
                for (var i = 0; i < data.files.length; i++) {
                    var f = data.files[i];
                    var sc = getStatusClass(f.status);
                    var tc = getTypeClass(f.subject);
                    html += '<tr>';
                    html += '<td><span class="period-badge">' + f.period + '</span></td>';
                    html += '<td><span class="type-badge ' + tc + '">' + f.subject + '</span></td>';
                    html += '<td class="request-type">' + f.type + '</td>';
                    html += '<td class="money ' + moneyClass(f.amount_request) + '" style="text-align:right">' + fmtMoney(f.amount_request) + '</td>';
                    html += '<td class="money ' + moneyClass(f.amount_guarantee) + '" style="text-align:right">' + fmtMoney(f.amount_guarantee) + '</td>';
                    html += '<td class="money ' + moneyClass(f.amount_post_guarantee) + '" style="text-align:right">' + fmtMoney(f.amount_post_guarantee) + '</td>';
                    html += '<td class="money ' + moneyClass(f.amount_tenzil) + '" style="text-align:right">' + fmtMoney(f.amount_tenzil) + '</td>';
                    html += '<td class="money ' + (f.amount_bloke > 0 ? 'negative' : 'zero') + '" style="text-align:right">' + fmtMoney(f.amount_bloke) + '</td>';
                    html += '<td class="money ' + moneyClass(f.amount_resolved) + '" style="text-align:right">' + fmtMoney(f.amount_resolved) + '</td>';
                    html += '<td><span class="status-pill ' + sc + '">' + f.status + '</span></td>';
                    html += '<td>';
                    html += '<div class="btn-group" role="group">';
                    html += '<button class="btn btn-sm btn-light text-primary" onclick=\'openEditModal(' + JSON.stringify(f) + ')\' title="Düzenle"><i class="fa-solid fa-pen-to-square"></i></button>';
                    html += '<a href="/kdv-detay/' + f.id + '" class="btn btn-sm btn-light text-secondary" title="Detay"><i class="fa-solid fa-arrow-up-right-from-square"></i></a>';
                    html += '<button class="btn btn-sm btn-light text-danger" onclick="deleteFile(' + f.id + ')" title="Sil"><i class="fa-solid fa-trash"></i></button>';
                    html += '</div>';
                    html += '</td>';
                    html += '</tr>';
                }

                // Totals
                html += '<tr class="totals-row">';
                html += '<td colspan="3"><i class="fa-solid fa-calculator me-2"></i>GENEL TOPLAM</td>';
                html += '<td style="text-align:right">' + fmtMoney(t.amount_request) + '</td>';
                html += '<td style="text-align:right">' + fmtMoney(t.amount_guarantee) + '</td>';
                html += '<td style="text-align:right">' + fmtMoney(t.amount_post_guarantee) + '</td>';
                html += '<td style="text-align:right">' + fmtMoney(t.amount_tenzil) + '</td>';
                html += '<td style="text-align:right;color:var(--ozet-danger);">' + fmtMoney(t.amount_bloke) + '</td>';
                html += '<td style="text-align:right;color:var(--ozet-success);">' + fmtMoney(t.amount_resolved) + '</td>';
                html += '<td></td>';
                html += '<td></td>';
                html += '</tr>';

                document.getElementById('tableBody').innerHTML = html;
            })
            .catch(function(err) {
                console.error('Summary load error:', err);
                showEmpty('Veriler yüklenirken bir hata oluştu.');
            });
    }

    function showEmpty(msg) {
        document.getElementById('tableBody').innerHTML =
            '<tr><td colspan="11">' +
            '<div class="empty-state">' +
            '<div class="empty-icon"><i class="fa-solid fa-folder-open"></i></div>' +
            '<h5 class="fw-bold mb-2">Dosya Bulunamadı</h5>' +
            '<p class="text-muted">' + msg + '</p>' +
            '</div>' +
            '</td></tr>';
    }

    // Load on page ready
    loadSummary();

    // --- Edit Logic ---
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));

    function openEditModal(f) {
        document.getElementById('editFileId').value = f.id;
        document.getElementById('editRequest').value = f.amount_request;
        document.getElementById('editGuarantee').value = f.amount_guarantee;
        document.getElementById('editTenzil').value = f.amount_tenzil;
        document.getElementById('editBloke').value = f.amount_bloke;
        document.getElementById('editResolved').value = f.amount_resolved;
        calcPostGuarantee(); // Initial calc
        editModal.show();
    }

    function calcPostGuarantee() {
        const req = parseFloat(document.getElementById('editRequest').value) || 0;
        const guar = parseFloat(document.getElementById('editGuarantee').value) || 0;
        const post = Math.max(0, req - guar);
        document.getElementById('editPostGuarantee').value = fmtMoney(post);
    }

    function saveAmounts() {
        const data = {
            file_id: document.getElementById('editFileId').value,
            amount_request: document.getElementById('editRequest').value,
            amount_guarantee: document.getElementById('editGuarantee').value,
            amount_tenzil: document.getElementById('editTenzil').value,
            amount_bloke: document.getElementById('editBloke').value,
            amount_resolved: document.getElementById('editResolved').value
        };

        fetch('/api/kdv/update-file-amounts', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(res => {
            if(res.status === 'success') {
                editModal.hide();
                Swal.fire({
                    icon: 'success',
                    title: 'Güncellendi',
                    text: 'Tutarlar başarıyla güncellendi.',
                    timer: 1500,
                    showConfirmButton: false
                });
                loadSummary(); // Reload table
            } else {
                Swal.fire('Hata', res.message, 'error');
            }
        })
        .catch(() => Swal.fire('Hata', 'İşlem başarısız.', 'error'));
    }

    // --- Add File Logic ---
    const addModal = new bootstrap.Modal(document.getElementById('addFileModal'));

    // --- Add File Functions ---
    // Multi-Select Month Logic
    function toggleMonth(btn) {
        btn.classList.toggle('active');
        updateSelectedMonths();
    }

    function selectAllMonths() {
        const btns = document.querySelectorAll('#addFileModal .month-btn');
        const allActive = Array.from(btns).every(b => b.classList.contains('active'));
        
        btns.forEach(b => {
            if (allActive) b.classList.remove('active');
            else b.classList.add('active');
        });
        updateSelectedMonths();
    }

    function updateSelectedMonths() {
        const selected = [];
        document.querySelectorAll('#addFileModal .month-btn.active').forEach(b => {
            selected.push(b.getAttribute('data-val'));
        });
        document.getElementById('selectedMonth').value = selected.join(',');
    }

    function selectMonth(btn, val) {
        // Deprecated single select, kept for safety but redirected
        toggleMonth(btn);
    }

    function toggleNoRefund() {
        var chk = document.getElementById('noRefundCheck');
        var fields = document.getElementById('refundFields');
        if (chk.checked) {
            fields.style.opacity = '0.4';
            fields.style.pointerEvents = 'none';
        } else {
            fields.style.opacity = '1';
            fields.style.pointerEvents = 'auto';
        }
    }

    function saveNewFile() {
        var year = document.getElementById('addYear').value;
        var monthVal = document.getElementById('selectedMonth').value;
        var subject = document.getElementById('addSubject').value;
        var type = document.getElementById('addType').value;
        var amount = document.getElementById('addAmount').value;
        var noRefund = document.getElementById('noRefundCheck').checked;

        if (!noRefund) {
            if (!subject) { Swal.fire('Hata', 'Lütfen iade konusu seçiniz.', 'warning'); return; }
            if (!type) { Swal.fire('Hata', 'Lütfen iade türü seçiniz.', 'warning'); return; }
            if (!amount) { Swal.fire('Hata', 'Lütfen tutar giriniz.', 'warning'); return; }
        }

        if (!monthVal) { Swal.fire('Hata', 'Lütfen en az bir ay seçiniz.', 'warning'); return; }

        const selectedMonths = monthVal.split(',');
        const periods = selectedMonths.map(m => {
            const mStr = m.toString().padStart(2, '0');
            return `${mStr}/${year}`;
        });

        var payload = {
            mukellef_id: MUKELLEF_ID,
            periods: periods, // Send list of periods
            subject: subject,
            type: type,
            amount_request: amount,
            no_refund: noRefund
        };

        fetch('/api/kdv/add-file', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(async response => {
             const isJson = response.headers.get('content-type')?.includes('application/json');
             const res = isJson ? await response.json() : null;

             if (!response.ok) {
                 const error = (res && res.message) || response.statusText;
                 throw new Error(error);
             }

             return res;
        })
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: 'İşlem Başarılı',
                    text: data.message,
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    location.reload();
                });
            } else {
                throw new Error(data.message);
            }
        })
        .catch(err => {
            console.error(err);
            Swal.fire('Hata', 'İşlem başarısız: ' + err.message, 'error');
        });
    }

    function deleteFile(id) {
        Swal.fire({
            title: 'Dosyayı Sil?',
            text: "Bu işlem geri alınamaz! Dosya silinecek.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Evet, Sil!',
            cancelButtonText: 'İptal'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/kdv/delete-file/${id}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(res => {
                    if (res.status === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Silindi!',
                            text: res.message,
                            timer: 1500,
                            showConfirmButton: false
                        });
                        loadSummary(); // Refresh table
                    } else {
                        Swal.fire('Hata', res.message, 'error');
                    }
                })
                .catch(err => Swal.fire('Hata', 'İşlem başarısız.', 'error'));
            }
        });
    }
</script>
{% endblock %}
