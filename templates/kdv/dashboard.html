{% extends "kdv/layout.html" %}

{% block title %}KDV İade Takip Paneli - İsfa Teknoloji{% endblock %}

{% block extra_head %}
<style>
    /* Premium Dashboard Styles from kdv-yonetim.html */
    .dashboard-header { margin-bottom: 2.5rem; }
    
    /* Stats Grid */
    .stat-card-premium {
        background: white;
        padding: 1.5rem;
        border-radius: 20px;
        border: 1px solid #f1f5f9;
        display: flex;
        align-items: center;
        gap: 1.25rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
        cursor: pointer;
        height: 100%;
    }
    .stat-card-premium:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05);
        border-color: #3b82f633;
    }
    .stat-icon {
        width: 56px; height: 56px;
        border-radius: 14px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.5rem;
    }
    .icon-blue { background: #eff6ff; color: #3b82f6; }
    .icon-green { background: #ecfdf5; color: #10b981; }
    .icon-amber { background: #fff7ed; color: #f59e0b; }
    .icon-purple { background: #f5f3ff; color: #8b5cf6; }

    .stat-meta { flex-grow: 1; }
    .stat-label { font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value { font-size: 1.5rem; font-weight: 800; color: #1e293b; margin: 4px 0; }
    .stat-trend { font-size: 0.75rem; font-weight: 600; display: flex; align-items: center; gap: 4px; }
    .trend-up { color: #10b981; }
    .trend-warning { color: #f59e0b; }

    /* Charts Section */
    .chart-card {
        background: white;
        padding: 1.5rem;
        border-radius: 24px;
        border: 1px solid #f1f5f9;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
        height: 100%;
    }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .chart-header h3 { font-size: 1rem; font-weight: 800; color: #1e293b; margin: 0; }
    .chart-container { position: relative; height: 300px; width: 100%; }

    /* Pipeline Cards */
    .file-card-premium {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        border: 1px solid #f1f5f9;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }
    .file-card-premium::before { content: ''; position: absolute; top:0; left:0; right:0; height:4px; background: #e2e8f0; }
    .card-status-info::before { background: linear-gradient(to right, #3b82f6, #60a5fa); }
    .card-status-success::before { background: linear-gradient(to right, #10b981, #34d399); }
    .card-status-warning::before { background: linear-gradient(to right, #f59e0b, #fbbf24); }
    .card-status-danger::before { background: linear-gradient(to right, #ef4444, #f87171); }

    .progress-pill-container { background: #f1f5f9; height: 6px; border-radius: 10px; margin-top: 8px; overflow: hidden; }
    .progress-pill-pill-fill { height: 100%; background: #3b82f6; transition: width 1s ease; }

    /* Premium Select Styling */
    .select-premium {
        height: auto !important;
        padding-top: 0.75rem !important;
        padding-bottom: 0.75rem !important;
        cursor: pointer;
    }
    .select-premium optgroup {
        font-weight: 800;
        color: #1e3a8a;
        background: #f8fafc;
        margin-top: 10px;
        padding: 8px;
    }
    .select-premium option {
        font-weight: 500;
        color: #475569;
        padding: 8px;
        background: white;
    }
    .select-premium:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }
    .activity-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .activity-item {
        display: flex;
        gap: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #f8fafc;
    }
    .activity-item:last-child { border-bottom: 0; padding-bottom: 0; }
    .activity-icon-box {
        width: 38px; height: 38px;
        border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0;
        background: #f1f5f9;
        color: #64748b;
        font-size: 0.9rem;
    }
    .activity-content { flex-grow: 1; min-width: 0; }
    .activity-title { font-size: 0.85rem; font-weight: 700; color: #1e293b; margin-bottom: 2px; }
    .activity-desc { 
        font-size: 0.75rem; 
        color: #64748b; 
        line-height: 1.4;
        word-wrap: break-word;
        max-width: 85%;
    }
    .activity-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; }
    .activity-user { font-size: 0.7rem; font-weight: 600; color: #3b82f6; text-transform: uppercase; }
    .activity-time { font-size: 0.7rem; color: #94a3b8; }
    
    /* Month Selector Styles */
    .month-btn {
        flex: 1;
        min-width: 45px;
        padding: 8px 0;
        border: 1px solid #e2e8f0;
        background: white;
        border-radius: 8px;
        color: #64748b;
        font-weight: 600;
        font-size: 0.85rem;
        transition: all 0.2s;
    }
    .month-btn:hover { background: #f8fafc; color: var(--ozet-primary); border-color: #cbd5e1; }
    .month-btn.active {
        background: #0d6efd;
        color: white;
        border-color: #0d6efd;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-4">
        <h1 class="h3 fw-bold mb-0">KDV İade Takip Paneli</h1>
        
        <div class="d-flex align-items-center bg-white px-3 py-2 rounded-4 border shadow-sm">
            <span class="small fw-bold text-secondary me-2 text-uppercase" style="font-size: 10px; letter-spacing: 0.5px;">Personel:</span>
            <select class="form-select border-0 p-0 shadow-none fw-bold text-primary" id="dashboardPersonnelFilter" onchange="initDashboard()" style="font-size: 0.9rem; background: transparent; width: auto; min-width: 150px;">
                <option value="">Tüm Ofis (Hepsi)</option>
                {% for u in users_list %}
                <option value="{{ u.id }}">{{ u.username|upper }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary px-4 py-2 rounded-3 fw-bold add-mukellef-redirect">
            <i class="fa-solid fa-user-plus me-2"></i> Yeni Mükellef Ekle
        </button>
        <button class="btn btn-primary px-4 py-2 rounded-3 fw-bold" onclick="openNewFileModal()">
            <i class="fa-solid fa-plus me-2"></i> Yeni İade Dosyası
        </button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const redirectBtn = document.querySelector('.add-mukellef-redirect');
        if (redirectBtn) {
            redirectBtn.addEventListener('click', function() {
                window.location.href = "{{ url_for('kdv.mukellefler') }}?add=1";
            });
        }
    });
</script>

<!-- Stats Grid -->
<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="stat-card-premium">
            <div class="stat-icon icon-blue"><i class="fa-solid fa-wallet"></i></div>
            <div class="stat-meta">
                <span class="stat-label">Toplam Bekleyen İade</span>
                <div class="stat-value" id="stat-pending-amount">₺ 0</div>
                <div class="stat-trend trend-up"><i class="fa-solid fa-arrow-trend-up"></i> Geçen aya göre +12%</div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stat-card-premium">
            <div class="stat-icon icon-green"><i class="fa-solid fa-check-double"></i></div>
            <div class="stat-meta">
                <span class="stat-label">Bu Ay Tamamlanan İade</span>
                <div class="stat-value" id="stat-completed-amount">₺ 0</div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stat-card-premium" onclick="loadModalData('deficiency')" style="cursor: pointer;">
            <div class="stat-icon icon-amber"><i class="fa-solid fa-clock-rotate-left"></i></div>
            <div class="stat-meta">
                <span class="stat-label">Açık Eksiklik Yazıları</span>
                <div class="stat-value" id="stat-missing-count">0 Adet</div>
                <div class="stat-trend trend-warning">İşlem Bekleyen</div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stat-card-premium" onclick="loadModalData('guarantee')" style="cursor: pointer;">
            <div class="stat-icon icon-purple"><i class="fa-solid fa-file-contract"></i></div>
            <div class="stat-meta">
                <span class="stat-label">Teminat Mektubu</span>
                <div class="stat-value" id="stat-guarantee-amount">₺ 0</div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4 mb-5">
    <div class="col-lg-7">
        <div class="chart-card">
            <div class="chart-header">
                <h3>Aylık İade / Tahsilat Trendi</h3>
            </div>
            <div class="chart-container">
                <canvas id="refundTrendChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-5">
        <div class="chart-card">
            <div class="chart-header">
                <h3><i class="fa-solid fa-clock-rotate-left me-2 text-primary"></i> Son 5 Aktivite</h3>
            </div>
            <div class="activity-list" id="recentActivitiesList">
                <div class="text-center py-4 text-muted small">Yükleniyor...</div>
            </div>
        </div>
    </div>
</div>

<!-- Operations Section -->
<div class="section-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="h4 fw-bold mb-1"><i class="fa-solid fa-bolt-lightning text-warning me-2"></i> Aktif Operasyon Takibi</h2>
        <p class="text-secondary small mb-0">Devam eden iade süreçlerinin güncel durum ve öncelik sıralaması.</p>
    </div>
    <a href="{{ url_for('kdv.archive') }}" class="btn btn-outline-secondary rounded-3 fw-semibold">
        <i class="fa-solid fa-list-check me-2"></i> Tüm Arşivi Yönet
    </a>
</div>

<div id="filesListContainer" class="pb-5">
    <!-- Loading Spinner -->
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
</div>

<!-- Modal etc. (kept from previous implementation) -->
<!-- New File Modal (Updated Design) -->
<div class="modal fade" id="newFileModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius:24px;">
            <div class="modal-header border-0 pb-0 pt-4 px-4">
                <h5 class="modal-title fw-bold text-dark fs-4">Yeni İade Dosyası Tanımla</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="newFileForm">
                    <!-- Row 1: Mukellef & Year -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <label class="form-label small fw-bold text-muted mb-1">Mükellef Seçimi</label>
                            <select id="modalClientId" class="form-select border-0 bg-light fw-bold py-2 text-primary" required>
                                <option value="" disabled selected>Mükellef seçiniz...</option>
                                <!-- JS Populates -->
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-muted mb-1">Yıl</label>
                            <select id="modalYear" class="form-select border-0 bg-light fw-bold py-2">
                                <option value="2026">2026</option>
                                <option value="2025" selected>2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 2: Months -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <label class="form-label small fw-bold text-muted mb-0">Ay Seçimi</label>
                            <button type="button" class="btn btn-link btn-sm p-0 text-decoration-none fw-bold" onclick="selectAllMonthsDashboard()">Tümünü Seç</button>
                        </div>
                        <div class="d-flex flex-wrap gap-2" id="monthSelector">
                            <input type="hidden" id="selectedMonth" value="">
                            {% for m_name in ['Oca', 'Şub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Ağu', 'Eyl', 'Eki', 'Kas', 'Ara'] %}
                            <button type="button" class="month-btn" data-val="{{ loop.index }}" onclick="selectMonth(this, '{{ loop.index }}')">{{ m_name }}</button>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- No Refund Checkbox -->
                    <div class="form-check mb-4 p-3 rounded-3" style="background:#f8fafc; border:1px solid #e2e8f0;">
                        <input class="form-check-input" type="checkbox" id="noRefundCheck" onchange="toggleNoRefund()" style="transform: scale(1.2);">
                        <label class="form-check-label fw-bold text-dark ms-2" for="noRefundCheck">
                            BU DÖNEM İADE HAKKI DOĞMAMIŞTIR
                        </label>
                    </div>

                    <div id="refundFields">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted mb-1">İade Konusu</label>
                                <select id="modalSubject" class="form-select border-0 bg-light fw-bold py-2 text-dark" required style="font-size: 0.9rem;">
                                    <option value="" selected disabled>İade kodunu veya konusunu seçiniz...</option>
                                    <optgroup label="Tam İstisna Kapsamına Giren İşlemler (300 Serisi)">
                                        <option value="301">301 - Mal İhracatı</option>
                                        <option value="302">302 - Hizmet İhracatı</option>
                                        <option value="303">303 - Roaming Hizmetleri</option>
                                        <option value="304">304 - Deniz, Hava ve Demiryolu Taşıma Araçları (13/a)</option>
                                        <option value="305">305 - Liman/Hava Meydanı Hizmetleri (13/b)</option>
                                        <option value="306">306 - Petrol Aramaları ve Boru Hatları (13/c)</option>
                                        <option value="307">307 - Maden Arama, Altın, Gümüş, Platin (13/c)</option>
                                        <option value="308">308 - Teşvikli Yatırım Malları Teslimi (13/d)</option>
                                        <option value="309">309 - Limanlara Bağlantı Demiryolu/Hava Meydanı İnşası (13/e)</option>
                                        <option value="310">310 - Ulusal Güvenlik Amaçlı Teslim/Hizmet (13/f)</option>
                                        <option value="311">311 - Uluslararası Taşımacılık (14/1)</option>
                                        <option value="312">312 - Diplomatik Organ ve Misyonlar (15/a)</option>
                                        <option value="313">313 - Uluslararası Kuruluşlar (15/b)</option>
                                        <option value="314">314 - Uluslararası Anlaşmalar Kapsamındaki İstisnalar (19/2)</option>
                                        <option value="315">315 - İhracat Eşyası Taşıyan Kamyonlara Motorin Teslimi (14/3)</option>
                                        <option value="316">316 - Serbest Bölgelerdeki Müşterilere Fason Hizmetler (11/1-a)</option>
                                        <option value="317">317 - Engelliler İçin Araç-Gereç ve Program (17/4-s)</option>
                                        <option value="318">318 - Yap-İşlet-Devret / Sağlık / Eğitim Projeleri (Geçici 29)</option>
                                        <option value="319">319 - Başbakanlık Merkez Teşkilatına Araç Teslimi (13/g)</option>
                                        <option value="320">320 - İSMEP Kapsamında Yapılacak Teslim/Hizmet (Geçici 16)</option>
                                        <option value="321">321 - BM/NATO/OECD'ye Yapılacak Teslim/Hizmet (Geçici 26)</option>
                                        <option value="322">322 - Özel Fatura ile Yapılan Teslimler (Bavul Ticareti)</option>
                                        <option value="323">323 - Ürün Senetlerinin İlk Teslimi (13/ğ)</option>
                                        <option value="324">324 - Türkiye Kızılay Derneğine Teslim ve Hizmetler (13/h)</option>
                                        <option value="325">325 - Yem Teslimleri (13/ı)</option>
                                        <option value="326">326 - Gübre Teslimleri (13/ı)</option>
                                        <option value="327">327 - Gübre Hammaddesi Teslimi (13/ı)</option>
                                        <option value="328">328 - Konut veya İşyeri Teslimlerinde İstisna (13/i)</option>
                                        <option value="329">329 - FATİH Projesi Kapsamındaki Teslimler (Geçici 38)</option>
                                        <option value="330">330 - OSB ve Küçük Sanayi Siteleri İnşası (13/j)</option>
                                        <option value="331">331 - Ar-Ge ve Tasarım Makine/Teçhizat Teslimi (13/m)</option>
                                        <option value="332">332 - İmalat Sanayine Makine/Teçhizat Teslimi (Geçici 39)</option>
                                        <option value="333">333 - Kamu İdarelerine Bağışlanan Tesislerin İnşası (13/k)</option>
                                        <option value="334">334 - Yabancılara Verilen Sağlık Hizmetleri (13/l)</option>
                                        <option value="335">335 - Basılı Kitap ve Süreli Yayın Teslimi (13/n)</option>
                                        <option value="336">336 - UEFA Süper Kupa ve Şampiyonlar Ligi Müsabakaları (Geçici 40)</option>
                                        <option value="338">338 - İmalatçıların Mal İhracında İade bedeli (32. md)</option>
                                        <option value="339">339 - İmalat/Turizm Belge Kapsamı İnşaat İşleri (Geçici 37)</option>
                                        <option value="340">340 - Elektrikli Taşıt Geliştirme Mühendislik Hizmeti (Geçici 42)</option>
                                        <option value="350">350 - Diğerleri</option>
                                    </optgroup>
                                    <optgroup label="Diğer İade Hakkı Doğuran İşlemler (400 Serisi)">
                                        <option value="405">405 - İndirimli Orana Tabi İhraç Kayıtlı Teslimler (11/1-c)</option>
                                        <option value="406">406 - İndirimli Oran - Yılı İçinde (29/2)</option>
                                        <option value="408">408 - Yolcu Beraberi Eşya İhracatı (11/1-b)</option>
                                        <option value="409">409 - Hurda ve Atık Teslimi Tevkifatı (9/1)</option>
                                        <option value="410">410 - Yapım İşleri ve Mühendislik/Mimarlık Tevkifatı (9/1)</option>
                                        <option value="411">411 - Temizlik Hizmeti Tevkifatı (9/1)</option>
                                        <option value="412">412 - Çevre ve Bahçe Bakım Hizmeti Tevkifatı (9/1)</option>
                                        <option value="413">413 - Özel Güvenlik Hizmeti Tevkifatı (9/1)</option>
                                        <option value="414">414 - Makine/Teçhizat/Taşıt Tadil ve Bakım Tevkifatı (9/1)</option>
                                        <option value="415">415 - Yemek Servis Hizmeti Tevkifatı (9/1)</option>
                                        <option value="416">416 - Danışmanlık ve Denetim Hizmetleri Tevkifatı (9/1)</option>
                                        <option value="418">418 - Bakır/Çinko/Alüminyum/Kurşun Külçe Tevkifatı (9/1)</option>
                                        <option value="419">419 - Bakır/Çinko/Alüminyum Ürünleri Tevkifatı (9/1)</option>
                                        <option value="420">420 - Yapı Denetim Hizmetleri Tevkifatı (9/1)</option>
                                        <option value="421">421 - İşgücü Temin Hizmeti Tevkifatı (9/1)</option>
                                        <option value="423">423 - Fason Tekstil ve Konfeksiyon Tevkifatı (9/1)</option>
                                        <option value="428">428 - Pamuk/Yün/Deri Teslim Tevkifatı (9/1)</option>
                                        <option value="430">430 - Hurda Metalden Külçe Teslimi Tevkifatı (9/1)</option>
                                        <option value="431">431 - Turistik Mağaza Müşteri Bulma Hizmeti Tevkifatı (9/1)</option>
                                        <option value="432">432 - Organizasyon Hizmetleri Tevkifatı (9/1)</option>
                                        <option value="433">433 - Spor Kulüplerinin Yayın/Reklam/İsim Hakkı Tevkifatı (9/1)</option>
                                        <option value="434">434 - Servis Taşımacılığı Hizmeti Tevkifatı (9/1)</option>
                                        <option value="435">435 - Baskı ve Basım Hizmetleri Tevkifatı (9/1)</option>
                                        <option value="436">436 - 5018 SK Eki Cetvel İdarelerine Diğer Hizmetler (9/1)</option>
                                        <option value="437">437 - Atıklardan Elde Edilen Hammadde Tevkifatı (9/1)</option>
                                        <option value="438">438 - Ağaç ve Orman Ürünleri Teslimi Tevkifatı (9/1)</option>
                                        <option value="439">439 - İndirimli Oran - Yılık (29/2)</option>
                                        <option value="440">440 - Stratejik Yatırımlara İlişkin İnşaat (Geçici 30)</option>
                                        <option value="441">441 - Uluslararası Anlaşmalar Kapsamında İade (19/2)</option>
                                        <option value="442">442 - İmalat Sanayi Yatırım Teşvik İnşaat İşleri (Geçici 37)</option>
                                        <option value="443">443 - TürkAkım Projesi Kapsamında Teslim/Hizmet (19/2)</option>
                                        <option value="444">444 - Kamu İdarelerine Bağışlanan Tesislerin İnşası (13/k)</option>
                                        <option value="445">445 - Yük Taşımacılığı Hizmetleri Tevkifatı (9/1)</option>
                                        <option value="446">446 - Ticari Reklam Hizmetleri Tevkifatı (9/1)</option>
                                        <option value="447">447 - Diğer Teslimlerde Tevkifata Tabi Tutulan KDV (9/1)</option>
                                        <option value="448">448 - Demir - Çelik Ürünlerinin Teslimi (9/1)</option>
                                        <option value="450">450 - Diğerleri</option>
                                    </optgroup>
                                    <optgroup label="Tevkifatlı İşlemler (900 Serisi)">
                                        <option value="901">901 - Hurda ve Atık Teslimi Tevkifatı (9/1)</option>
                                        <option value="902">902 - Yapım İşleri Mimarlık/Mühendislik Tevkifatı (9/1)</option>
                                        <option value="903">903 - Temizlik Hizmeti Tevkifatı (9/1)</option>
                                        <option value="904">904 - Çevre ve Bahçe Bakım Hizmeti Tevkifatı (9/1)</option>
                                        <option value="905">905 - Özel Güvenlik Hizmeti Tevkifatı (9/1)</option>
                                        <option value="906">906 - Makine/Teçhizat/Taşıt Bakım Tevkifatı (9/1)</option>
                                        <option value="907">907 - Yemek Servis Hizmeti Tevkifatı (9/1)</option>
                                        <option value="908">908 - Etüt/Proje/Danışmanlık/Denetim Tevkifatı (9/1)</option>
                                        <option value="909">909 - Bakır/Çinko/D-Çelik/Alüminyum Külçe Teslimi (9/1)</option>
                                        <option value="910">910 - Bakır/Çinko/Alüminyum Ürünleri Tevkifatı (9/1)</option>
                                        <option value="911">911 - Yapı Denetim Hizmetleri Tevkifatı (9/1)</option>
                                        <option value="912">912 - İşgücü Temin Hizmeti Tevkifatı (9/1)</option>
                                        <option value="913">913 - Fason Tekstil ve Konfeksiyon Tevkifatı (9/1)</option>
                                        <option value="914">914 - Pamuk/Yün/Deri Teslim Tevkifatı (9/1)</option>
                                        <option value="915">915 - Hurda Metalden Külçe Teslimi Tevkifatı (9/1)</option>
                                        <option value="916">916 - Turistik Mağaza Müşteri Bulma Tevkifatı (9/1)</option>
                                        <option value="917">917 - Organizasyon Hizmetleri Tevkifatı (9/1)</option>
                                        <option value="918">918 - Spor Kulüplerinin Yayın/Reklam/İsim Hakkı Tevkifatı (9/1)</option>
                                        <option value="919">919 - Servis Taşımacılığı Hizmeti Tevkifatı (9/1)</option>
                                        <option value="920">920 - Baskı ve Basım Hizmetleri Tevkifatı (9/1)</option>
                                        <option value="921">921 - Atıklardan Elde Edilen Hammadde Tevkifatı (9/1)</option>
                                        <option value="922">922 - Ağaç ve Orman Ürünleri Teslimi Tevkifatı (9/1)</option>
                                        <option value="923">923 - Yük Taşımacılığı Hizmetleri Tevkifatı (9/1)</option>
                                        <option value="924">924 - Ticari Reklam Hizmetlerinde Tevkifat (9/1)</option>
                                        <option value="925">925 - Demir Çelik Ürünlerinin Teslimi (9/1)</option>
                                    </optgroup>
                                    <optgroup label="Tecil - Terkin İşlemleri (700 Serisi)">
                                        <option value="701">701 - İhracatı Yapılacak Nihai Ürünlerin Teslimi (11/1-c)</option>
                                        <option value="702">702 - DİİB veya GKİB Kapsamında Yapılan Teslim (Geçici 17)</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted mb-1">İade Türü</label>
                                <select id="modalType" class="form-select border-0 bg-light fw-bold py-2">
                                    <option value="" disabled selected>Seçiniz...</option>
                                    <option value="Nakit">Nakit</option>
                                    <option value="Mahsup">Mahsup</option>
                                    <option value="Teminatlı">Teminatlı</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted mb-1">Talep Tutarı (₺)</label>
                            <input type="number" step="0.01" id="modalAmount" class="form-control border-0 bg-light fw-bold py-2" placeholder="0.00">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0 px-4 pb-4">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" onclick="saveNewFileDashboard()">Kaydet ve Başlat</button>
            </div>
        </div>
    </div>
</div>
<!-- Deficiency Modal -->
<div class="modal fade" id="deficiencyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header border-0 pb-0">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-warning bg-opacity-10 p-2 rounded-3 text-warning">
                        <i class="fa-solid fa-clock-rotate-left fs-4"></i>
                    </div>
                    <h5 class="modal-title fw-bold text-dark">Açık Eksiklik Yazıları</h5>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="table-responsive">
                    <table class="table align-middle table-hover">
                        <thead class="bg-light">
                            <tr>
                                <th class="border-0 rounded-start-3 text-secondary fw-semibold small ps-3">Mükellef</th>
                                <th class="border-0 text-secondary fw-semibold small">Konu / Dönem</th>
                                <th class="border-0 text-secondary fw-semibold small">Tutar</th>
                                <th class="border-0 text-secondary fw-semibold small">Durum</th>
                                <th class="border-0 rounded-end-3 text-secondary fw-semibold small text-end pe-3">İşlem</th>
                            </tr>
                        </thead>
                        <tbody id="deficiencyTableBody">
                            <!-- JS will populate -->
                        </tbody>
                    </table>
                </div>
                <div class="alert alert-warning border-0 rounded-3 mt-3 d-flex align-items-center gap-3" role="alert">
                    <i class="fa-solid fa-triangle-exclamation fs-5"></i>
                    <div class="small">Uyarı: Eksiklik yazılarına 30 gün içinde cevap verilmesi yasal zorunluluktur.</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Guarantee Modal -->
<div class="modal fade" id="guaranteeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header border-0 pb-0">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-purple bg-opacity-10 p-2 rounded-3 text-purple" style="color: #8b5cf6;">
                        <i class="fa-solid fa-file-shield fs-4"></i>
                    </div>
                    <h5 class="modal-title fw-bold text-dark">Teminat Mektupları Detayı</h5>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="table-responsive">
                    <table class="table align-middle table-hover">
                        <thead class="bg-light">
                            <tr>
                                <th class="border-0 rounded-start-3 text-secondary fw-semibold small ps-3">Mükellef</th>
                                <th class="border-0 text-secondary fw-semibold small">Banka / Konu</th>
                                <th class="border-0 text-secondary fw-semibold small">Teminat Tutarı</th>
                                <th class="border-0 text-secondary fw-semibold small">Tarih</th>
                                <th class="border-0 rounded-end-3 text-secondary fw-semibold small text-end pe-3">İşlem</th>
                            </tr>
                        </thead>
                        <tbody id="guaranteeTableBody">
                            <!-- JS will populate -->
                        </tbody>
                    </table>
                </div>
                <div class="alert alert-light border rounded-3 mt-3 d-flex align-items-center gap-3" role="alert">
                    <i class="fa-solid fa-circle-info text-primary fs-5"></i>
                    <div class="small text-secondary">Not: YMM raporu 6 ay içinde verilmelidir. Süre dolmadan rapor hazırlığını başlatınız.</div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='kdv-logic.js') }}"></script>
<script>
    // Overriding updateStats from kdv-logic.js to handle premium dashboard fields
    async function loadModalData(type) {
        let apiUrl = '/api/kdv/files?active=1';
        const urlParams = new URLSearchParams(window.location.search);
        const mukellefId = urlParams.get('mukellef') || urlParams.get('mukellef_id');
        const userId = document.getElementById('dashboardPersonnelFilter').value;
        
        if (mukellefId) apiUrl += `&mukellef_id=${mukellefId}`;
        if (userId) apiUrl += `&user_id=${userId}`;
        
        let containerId = '';
        let modalId = '';
        
        if (type === 'deficiency') {
            apiUrl += `&status=Eksiklik yazısı geldi`;
            containerId = 'deficiencyTableBody';
            modalId = 'deficiencyModal';
        } else if (type === 'guarantee') {
            apiUrl += `&filter_type=guarantee`;
            containerId = 'guaranteeTableBody';
            modalId = 'guaranteeModal';
        }
        
        const container = document.getElementById(containerId);
        container.innerHTML = `<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></td></tr>`;
        
        const modalEl = document.getElementById(modalId);
        if (modalEl && modalEl.parentElement !== document.body) {
            document.body.appendChild(modalEl);
        }
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        
        try {
            const response = await fetch(apiUrl);
            const files = await response.json();
            
            container.innerHTML = '';
            
            if (files.length === 0) {
                container.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-muted">Kayıt bulunamadı.</td></tr>`;
                return;
            }
            
            files.forEach(file => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="ps-3"><span class="fw-bold text-dark">${file.client_name}</span></td>
                    <td><div class="d-flex flex-column"><span class="fw-medium">${file.subject}</span><span class="small text-muted">${file.period_year}-${file.period_month}</span></div></td>
                    <td><span class="fw-bold text-dark">₺ ${formatMoney(file.amount_request)}</span></td>
                    <td><span class="badge bg-light text-dark border">${file.status || '-'}</span></td>
                    <td class="text-end pe-3">
                        <a href="/kdv-detay/${file.id}" class="btn btn-sm btn-primary rounded-pill px-3">Detay</a>
                    </td>
                `;
                container.appendChild(tr);
            });
            
        } catch (e) {
            console.error(e);
            container.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-danger">Veri yüklenirken hata oluştu.</td></tr>`;
        }
    }

    async function updateStats() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const mukellefId = urlParams.get('mukellef') || urlParams.get('mukellef_id');
            const userId = document.getElementById('dashboardPersonnelFilter').value;
            
            let apiUrl = '/api/kdv/stats';
            const params = new URLSearchParams();
            if (mukellefId) params.append('mukellef_id', mukellefId);
            if (userId) params.append('user_id', userId);
            
            if (params.toString()) apiUrl += '?' + params.toString();

            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('Stats fetch status: ' + response.status);
            const data = await response.json();
            
            // Update Stats Metrix
            if(document.getElementById('stat-pending-amount'))
                document.getElementById('stat-pending-amount').textContent = `₺ ${formatMoney(data.pending_amount)}`;
            
            if(document.getElementById('stat-completed-amount'))
                document.getElementById('stat-completed-amount').textContent = `₺ ${formatMoney(data.completed_amount)}`;
            
            if(document.getElementById('stat-missing-count'))
                document.getElementById('stat-missing-count').textContent = `${data.missing_docs_count} Adet`;
            
            if(document.getElementById('stat-guarantee-amount'))
                document.getElementById('stat-guarantee-amount').textContent = `₺ ${formatMoney(data.guarantee_amount)}`;
                
            // Update Charts
            updateChartsWithData(data);

        } catch (e) {
            console.error('Stats fetch error:', e);
        }
    }

    function updateChartsWithData(data) {
        // Recent Activities List
        const activityContainer = document.getElementById('recentActivitiesList');
        if (activityContainer && data.recent_activities) {
            if (data.recent_activities.length === 0) {
                activityContainer.innerHTML = '<div class="text-center py-4 text-muted small">Henüz aktivite kaydı bulunmuyor.</div>';
            } else {
                activityContainer.innerHTML = data.recent_activities.map(act => {
                    let icon = 'fa-circle-dot';
                    if (act.action.includes('Durum')) icon = 'fa-arrows-rotate';
                    if (act.action.includes('Dosya')) icon = 'fa-file-medical';
                    if (act.action.includes('Yetki')) icon = 'fa-user-shield';
                    if (act.action.includes('Yer')) icon = 'fa-location-dot';

                    return `
                        <div class="activity-item">
                            <div class="activity-icon-box">
                                <i class="fa-solid ${icon}"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">${act.action}</div>
                                <div class="activity-desc" title="${act.description}">${act.description}</div>
                                <div class="activity-meta">
                                    <span class="activity-user">${act.user_name}</span>
                                    <span class="activity-time">${act.date}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Trend Chart
        const trendCtx = document.getElementById('refundTrendChart').getContext('2d');
        if(window.trendChartInstance) window.trendChartInstance.destroy();
        
        const trendLabels = (data.trend_labels && data.trend_labels.length) ? data.trend_labels : ['Veri Yok'];
        const trendValues = (data.trend_data && data.trend_data.length) ? data.trend_data : [0];
        
        window.trendChartInstance = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendLabels,
                datasets: [{
                    label: 'İade Tutarı (TL)',
                    data: trendValues,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.05)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#3b82f6',
                    pointBorderWidth: 2,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { display: false } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    // --- Custom Logic for Premium Dashboard Modal ---
    const newFileModal = new bootstrap.Modal(document.getElementById('newFileModal'));

    function openNewFileModal() {
        // Move modal to body to fix z-index issues if not already done
        const modalEl = document.getElementById('newFileModal');
        if (modalEl && modalEl.parentElement !== document.body) {
            document.body.appendChild(modalEl);
        }

        const clientSelect = document.getElementById('modalClientId');
        const urlParams = new URLSearchParams(window.location.search);
        const urlMukellefId = urlParams.get('mukellef');

        if (clientSelect.options.length <= 1) {
            fetch('/api/kdv/mukellefler')
                .then(r => r.json())
                .then(data => {
                    let html = '<option value="" disabled selected>Mükellef seçiniz...</option>';
                    data.forEach(m => {
                        html += `<option value="${m.id}">${m.unvan}</option>`;
                    });
                    clientSelect.innerHTML = html;
                    
                    if (urlMukellefId) {
                        clientSelect.value = urlMukellefId;
                    }
                });
        } else {
             if (urlMukellefId) {
                clientSelect.value = urlMukellefId;
            }
        }
        newFileModal.show();
    }

    function selectMonth(btn, val) {
        btn.classList.toggle('active');
        updateSelectedMonthsDashboard();
    }

    function selectAllMonthsDashboard() {
        const btns = document.querySelectorAll('#newFileModal .month-btn');
        const allActive = Array.from(btns).every(b => b.classList.contains('active'));
        
        btns.forEach(b => {
             if (allActive) b.classList.remove('active');
             else b.classList.add('active');
        });
        updateSelectedMonthsDashboard();
    }

    function updateSelectedMonthsDashboard() {
        const selected = [];
        document.querySelectorAll('#newFileModal .month-btn.active').forEach(b => {
            selected.push(b.getAttribute('data-val'));
        });
        document.getElementById('selectedMonth').value = selected.join(',');
    }

    function toggleNoRefund() {
        const isChecked = document.getElementById('noRefundCheck').checked;
        const fields = document.getElementById('refundFields');
        if (isChecked) {
            fields.style.opacity = '0.4';
            fields.style.pointerEvents = 'none';
        } else {
            fields.style.opacity = '1';
            fields.style.pointerEvents = 'auto';
        }
    }

    function saveNewFileDashboard() {
        const mid = document.getElementById('modalClientId').value;
        const year = document.getElementById('modalYear').value;
        const monthVal = document.getElementById('selectedMonth').value;
        const noRefund = document.getElementById('noRefundCheck').checked;

        if (!mid) { Swal.fire('Hata', 'Lütfen mükellef seçiniz.', 'warning'); return; }
        if (!monthVal) { Swal.fire('Hata', 'Lütfen en az bir ay seçiniz.', 'warning'); return; }

        let subject, type, amount;

        if (noRefund) {
            subject = 'İADESİ YOK';
            type = '-';
            amount = 0;
        } else {
            subject = document.getElementById('modalSubject').value;
            type = document.getElementById('modalType').value;
            amount = document.getElementById('modalAmount').value;

            if (!subject) { Swal.fire('Hata', 'Lütfen iade konusu seçiniz.', 'warning'); return; }
            if (!type) { Swal.fire('Hata', 'Lütfen talep türü seçiniz.', 'warning'); return; }
            if (!amount) { Swal.fire('Hata', 'Lütfen tutar giriniz.', 'warning'); return; }
        }

        const selectedMonths = monthVal.split(',');
        const periods = selectedMonths.map(m => {
            const mStr = m.toString().padStart(2, '0');
            return `${mStr}/${year}`;
        });

        const data = {
            mukellef_id: mid,
            periods: periods, // Send list
            subject: subject,
            type: type,
            amount_request: amount,
            no_refund: noRefund
        };

        fetch('/api/kdv/add-file', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(async response => {
             const isJson = response.headers.get('content-type')?.includes('application/json');
             const res = isJson ? await response.json() : null;

             if (!response.ok) {
                 const error = (res && res.message) || response.statusText;
                 throw new Error(error);
             }

             return res;
        })
        .then(res => {
            if(res.status === 'success') {
                newFileModal.hide();
                document.getElementById('newFileForm').reset();
                document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('selectedMonth').value = '';
                toggleNoRefund();

                Swal.fire({
                    icon: 'success',
                    title: 'Başarılı',
                    text: res.message, // Shows created count
                    timer: 1500,
                    showConfirmButton: false
                });
                
                // Refresh dashboard stats/list
                initDashboard(); 
            } else {
                throw new Error(res.message);
            }
        })
        .catch(err => {
            console.error('Fetch Error:', err);
            Swal.fire('Hata', 'İşlem başarısız: ' + err.message, 'error');
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (typeof initDashboard === 'function') {
            initDashboard();
        } else {
            console.error("initDashboard function not found in kdv-logic.js");
            updateStats();
        }
    });
</script>
{% endblock %}
