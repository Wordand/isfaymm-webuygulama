{% extends "layout.html" %}
{% block title %}Gelir Vergisi Hesaplama{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="bi bi-bank me-2"></i>Gelir Vergisi Hesaplama</h4>
                </div>
                <div class="card-body p-4">
                    
                    <form id="gelirVergisiForm">
                        
                        <!-- Hesaplama YÄ±lÄ± ve TÃ¼rÃ¼ -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="yilInput" class="form-label fw-bold">Hesaplama YÄ±lÄ±</label>
                                <select class="form-select" id="yilInput" required>
                                    <option value="2026" selected>2026</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                    <option value="2022">2022</option>
                                    <option value="2021">2021</option>
                                    <option value="2020">2020</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="gelirTuru" class="form-label fw-bold">Gelir TÃ¼rÃ¼</label>
                                <select class="form-select" id="gelirTuru" required>
                                    <option value="ucret" selected>Ãœcret (MaaÅŸ)</option>
                                    <option value="normal">Ãœcret DÄ±ÅŸÄ± (Kira, DeÄŸer ArtÄ±ÅŸ vb.)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Tutar ve DÃ¶nem -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="brutUcret" class="form-label fw-bold">KÃ¼mÃ¼latif Vergi MatrahÄ± (â‚º)</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="brutUcret" placeholder="0,00" required>
                                    <span class="input-group-text">â‚º</span>
                                </div>
                                <div class="form-text">Ä°lgili aydaki brÃ¼t geliriniz (kÃ¼mÃ¼latif matrah dahil edilecekse sistem soracaktÄ±r).</div>
                            </div>
                            <div class="col-md-6">
                                <label for="aySecimi" class="form-label fw-bold">DÃ¶nem SeÃ§imi</label>
                                <select class="form-select" id="aySecimi">
                                    <option value="0">YÄ±llÄ±k Toplam</option>
                                    {% set aylar = ["Ocak","Åžubat","Mart","Nisan","MayÄ±s","Haziran","Temmuz","AÄŸustos","EylÃ¼l","Ekim","KasÄ±m","AralÄ±k"] %}
                                    {% for ay in aylar %}
                                    <option value="{{ loop.index }}">{{ ay }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" id="asgariIstisna" checked>
                            <label class="form-check-label" for="asgariIstisna">
                                Asgari Ãœcret Ä°stisnasÄ± UygulansÄ±n
                            </label>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 btn-lg">
                            <i class="bi bi-calculator me-2"></i> Hesapla
                        </button>

                        <hr class="my-4">

                        <!-- SonuÃ§ AlanÄ± -->
                        <div id="sonucAlani" style="display:none;">
                            <h5 class="fw-bold text-primary mb-3">Hesaplama Sonucu</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped">
                                    <tbody>
                                        <tr>
                                            <th class="w-50">Hesaplanan Gelir Vergisi</th>
                                            <td class="text-end text-danger fw-bold fs-5" id="resVergi">0,00 â‚º</td>
                                        </tr>
                                        <tr id="rowIstisna">
                                            <th>Uygulanan Ä°stisna (Asgari Ãœcret)</th>
                                            <td class="text-end text-success fw-bold" id="resIstisna">0,00 â‚º</td>
                                        </tr>
                                        <tr id="rowOdenecek">
                                            <th>Ã–denecek Gelir Vergisi</th>
                                            <td class="text-end fw-bold" id="resOdenecek">0,00 â‚º</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </form>

                    <div class="mt-3">
                        <div class="alert alert-light border small text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            <strong>Bilgi:</strong> Ãœcretliler iÃ§in kÃ¼mÃ¼latif vergi matrahÄ± hesabÄ± yapÄ±lÄ±rken Ã¶nceki aylarÄ±n matrahlarÄ± gerekebilir. Sistem ilgili durumda size soracaktÄ±r.
                        </div>
                    </div>

                </div>
            </div>

            <!-- GeÃ§miÅŸ Hesaplamalar -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">ðŸ“‹ Son Hesaplamalar</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0" id="logTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">YÄ±l</th>
                                    <th>TÃ¼r</th>
                                    <th>Matrah</th>
                                    <th>Vergi</th>
                                    <th>Ä°ÅŸlem</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- JS ile dolacak -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <div class="mt-4">
        {% include "partials/tax_disclaimer.html" %}
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const brutUcretInput = document.getElementById("brutUcret");
    const aySecimi = document.getElementById("aySecimi");
    const gelirTuruInput = document.getElementById("gelirTuru");
    const istisnaCheckbox = document.getElementById("asgariIstisna");
    const sonucAlani = document.getElementById("sonucAlani");

    // Para birimi formatlama
    brutUcretInput.addEventListener("input", function (e) {
        let val = e.target.value.replace(/[^\d]/g, "");
        if (!val) return;
        const number = parseFloat(val) / 100;
        e.target.value = number.toLocaleString("tr-TR", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    });

    function gelirTuruKontrol() {
        const isUcret = gelirTuruInput.value === "ucret";
        istisnaCheckbox.disabled = !isUcret;
        if (!isUcret) {
            istisnaCheckbox.checked = false;
            // Ãœcret dÄ±ÅŸÄ± gelirde "DÃ¶nem" genellikle yÄ±llÄ±k olur ama kullanÄ±cÄ± seÃ§ebilir kalsÄ±n mÄ±?
            // Orijinal kodda disabled yapÄ±lÄ±yordu.
             aySecimi.value = "0";
             aySecimi.disabled = true;
        } else {
            aySecimi.disabled = false;
        }
    }

    gelirTuruInput.addEventListener("change", gelirTuruKontrol);
    gelirTuruKontrol();

    document.getElementById("gelirVergisiForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const brut = parseFloat(
            brutUcretInput.value.replace(/\./g, "").replace(",", ".")
        ) || 0;

        const yil = parseInt(document.getElementById("yilInput").value);
        const ay = parseInt(aySecimi.value);
        const gelirTuru = gelirTuruInput.value;
        const istisna = istisnaCheckbox.checked;

        let oncekiMatrahlar = {};

        // EÄŸer Ã¼cret ve belirli bir ay seÃ§ilmiÅŸse (Ocak hariÃ§), kÃ¼mÃ¼latif matrah sor
        if (ay > 1 && gelirTuru === "ucret") {
            const ayAdlari = ["Ocak","Åžubat","Mart","Nisan","MayÄ±s","Haziran","Temmuz","AÄŸustos","EylÃ¼l","Ekim","KasÄ±m","AralÄ±k"];
            let html = '<div class="text-start small mb-2">Artan oranlÄ± vergi dilimi hesabÄ± iÃ§in Ã¶nceki aylarÄ±n toplam matrahÄ± gereklidir.</div><div style="text-align:left;">';
            
            // KullanÄ±cÄ±yÄ± yormamak iÃ§in tek hane kÃ¼mÃ¼latif sorabiliriz ama orijinal kod her ayÄ± soruyor.
            // Orijinali koruyalÄ±m ama belki basitleÅŸtirebiliriz.
            // Åžimdilik orijinal mantÄ±ÄŸÄ± koruyorum:
            html += '<p class="fw-bold mb-2">Ã–nceki Matrah ToplamÄ± (veya ayrÄ± ayrÄ± giriniz):</p>';
            
            // Pratiklik iÃ§in tek bir "Toplam KÃ¼mÃ¼latif" alanÄ± koyalÄ±m?
            // Ancak backend "onceki_matrahlar" dict bekliyor olabilir.
            // Backend kodunu incelediÄŸimde: for v in onceki_dict.values(): onceki_toplam += float(v)
            // Yani backend sadece deÄŸerlerin toplamÄ±nÄ± alÄ±yor! Dict key'leri Ã¶nemsiz (sadece iterasyon).
            // O zaman kullanÄ±cÄ±dan TEK BÄ°R "Ã–nceki AylarÄ±n Toplam MatrahÄ±" istemek Ã§ok daha UX dostu olur.
            
            html += `
                <div class="mb-2">
                    <label class="form-label">Ã–nceki Aylar Toplam MatrahÄ±</label>
                    <div class="input-group">
                        <input type="text" class="form-control swal2-input onceki-toplam" placeholder="0,00">
                        <span class="input-group-text">â‚º</span>
                    </div>
                </div>`;
            
            html += '</div>';

            const { value } = await Swal.fire({
                title: "KÃ¼mÃ¼latif Matrah Bilgisi",
                html,
                confirmButtonText: "Hesapla",
                showCancelButton: true,
                cancelButtonText: "Ä°ptal",
                preConfirm: () => {
                   const val = document.querySelector(".onceki-toplam").value;
                   return parseFloat(val.replace(/\./g,"").replace(",", ".")) || 0;
                }
            });

            if (value === undefined) return; // Ä°ptal
            
            // Backend'e tek bir deÄŸer gÃ¶nderelim (key=toplam)
            oncekiMatrahlar["toplam"] = value;
        }

        // Hesaplama Ä°steÄŸi
        try {
            const response = await fetch("/vergi-hesapla", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    brut,
                    yil,
                    ay,
                    gelir_turu: gelirTuru,
                    istisna,
                    onceki_matrahlar: oncekiMatrahlar
                })
            });
            
            const d = await response.json();

            if (d.error) {
                Swal.fire("Hata", d.error, "error");
                return;
            }

            // SonuÃ§larÄ± GÃ¶ster
            sonucAlani.style.display = "block";
            
            const vergi = d.vergi;
            const istisnaTutari = d.istisna || 0; 
            // d.istisna backend'den dÃ¶nen istisna tutarÄ± (vergi indirimi).
            // Backend: vergi = max(vergi - istisna, 0) yapÄ±p "vergi"yi dÃ¶nÃ¼yor mu?
            // Backend koduna baktÄ±m: "vergi = max(vergi - istisna, 0)" yapÄ±yor ve bunu "vergi" olarak dÃ¶nÃ¼yor.
            // AyrÄ±ca "istisna"yÄ± da dÃ¶nÃ¼yor.
            // Yani d.vergi = Ã–denecek Vergi (Ä°stisna dÃ¼ÅŸÃ¼lmÃ¼ÅŸ)
            // Ancak kullanÄ±cÄ± "Hesaplanan Vergi" ve "Ã–denecek Vergi"yi ayrÄ± gÃ¶rmek ister mi?
            // Serbest Meslek tablosunda mantÄ±ÄŸÄ±:
            // "Hesaplanan Gelir Vergisi" (Ä°stisna Ã¶ncesi)
            // "Ä°stisna"
            // "Ã–denecek"
            
            const hesaplananVergi = vergi + istisnaTutari;

            document.getElementById('resVergi').textContent = hesaplananVergi.toLocaleString("tr-TR",{minimumFractionDigits:2}) + ' â‚º';
            document.getElementById('resIstisna').textContent = istisnaTutari.toLocaleString("tr-TR",{minimumFractionDigits:2}) + ' â‚º';
            document.getElementById('resOdenecek').textContent = vergi.toLocaleString("tr-TR",{minimumFractionDigits:2}) + ' â‚º';

            if (istisnaTutari > 0) {
                document.getElementById('rowIstisna').style.display = 'table-row';
                document.getElementById('rowOdenecek').style.display = 'table-row';
            } else {
                 document.getElementById('rowIstisna').style.display = 'none';
                 // Sadece vergi gÃ¶rÃ¼nse yeterli, Ã§Ã¼nkÃ¼ Ã¶denecek = hesaplanan.
                 // Ama netlik iÃ§in kalsÄ±n.
                 document.getElementById('rowOdenecek').style.display = 'table-row';
            }

            // Tabloya Ekle
            logToTable(yil, gelirTuru, brut, vergi);

        } catch (err) {
            Swal.fire("Hata", "Sunucu hatasÄ± oluÅŸtu: " + err, "error");
        }
    });

    function logToTable(yil, tur, matrah, vergi) {
        const tbody = document.querySelector("#logTable tbody");
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td class="ps-3">${yil}</td>
            <td>${tur === "ucret" ? '<span class="badge bg-info">Ãœcret</span>' : '<span class="badge bg-warning text-dark">DiÄŸer</span>'}</td>
            <td>${matrah.toLocaleString("tr-TR",{minimumFractionDigits:2})} â‚º</td>
            <td class="fw-bold text-danger">${vergi.toLocaleString("tr-TR",{minimumFractionDigits:2})} â‚º</td>
            <td><button class="btn btn-sm btn-outline-secondary py-0" onclick="this.closest('tr').remove()"><i class="bi bi-x"></i></button></td>
        `;
        tbody.prepend(tr);
    }
});
</script>
{% endblock %}
