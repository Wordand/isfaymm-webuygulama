{% extends "layout.html" %}
{% block title %}Gelir Vergisi Hesaplama{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-9">
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="card-header bg-dark text-white p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="bi bi-bank me-2 text-danger"></i>Gelir Vergisi Hesaplama</h4>
                        <span class="badge bg-danger">2026 GÜNCEL</span>
                    </div>
                </div>
                <div class="card-body p-4 p-md-5">
                    
                    <form id="gelirVergisiForm">
                        <!-- Hesaplama Yılı ve Türü -->
                        <div class="row g-4 mb-4">
                            <div class="col-md-6">
                                <label for="yilInput" class="form-label fw-bold">Hesaplama Yılı</label>
                                <select class="form-select border-0 bg-light rounded-3 p-3" id="yilInput" required>
                                    <option value="2026" selected>2026</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="gelirTuru" class="form-label fw-bold">Gelir Türü</label>
                                <select class="form-select border-0 bg-light rounded-3 p-3" id="gelirTuru" required>
                                    <option value="ucret" selected>Ücret (Maaş)</option>
                                    <option value="normal">Ücret Dışı (Kira, Değer Artış vb.)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Tutar ve Dönem -->
                        <div class="row g-4 mb-4">
                            <div class="col-md-6">
                                <label for="brutUcret" class="form-label fw-bold">Kümülatif Vergi Matrahı (₺)</label>
                                <div class="input-group">
                                    <input type="text" class="form-control border-0 bg-light rounded-start-3 p-3" id="brutUcret" placeholder="0,00" required>
                                    <span class="input-group-text border-0 bg-light rounded-end-3">₺</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="aySecimi" class="form-label fw-bold">Dönem Seçimi</label>
                                <select class="form-select border-0 bg-light rounded-3 p-3" id="aySecimi">
                                    <option value="0">Yıllık Toplam</option>
                                    {% set aylar = ["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"] %}
                                    {% for ay in aylar %}
                                    <option value="{{ loop.index }}">{{ ay }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="form-check mb-4 custom-switch">
                            <input class="form-check-input" type="checkbox" id="asgariIstisna" checked>
                            <label class="form-check-label text-muted" for="asgariIstisna">
                                Asgari Ücret İstisnası Uygulansın
                            </label>
                        </div>

                        <button type="submit" class="btn btn-danger w-100 btn-lg rounded-pill py-3 shadow-sm hover-glow">
                            <i class="bi bi-cpu me-2"></i> Analiz Et ve Hesapla
                        </button>
                    </form>

                    <hr class="my-5">

                    <!-- Sonuç Alanı Visualized -->
                    <div id="sonucAlani" style="display:none;" class="animate__animated animate__fadeIn">
                        <div id="exportArea">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="fw-bold text-dark m-0"><i class="bi bi-pie-chart-fill text-danger me-2"></i>Hesaplama Analizi</h5>
                                <button type="button" class="btn btn-sm btn-outline-dark rounded-pill px-3" onclick="exportToPDF()">
                                    <i class="bi bi-file-earmark-pdf me-1"></i> Rapor Al (PDF)
                                </button>
                            </div>

                            <div class="row g-4 align-items-center">
                                <div class="col-md-6">
                                    <div class="chart-container p-3 bg-light rounded-4" style="position: relative; height:300px;">
                                        <canvas id="resultChart"></canvas>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="table-responsive rounded-4 border overflow-hidden">
                                        <table class="table table-borderless m-0">
                                            <tbody class="align-middle">
                                                <tr class="bg-light">
                                                    <td class="ps-4">Hesaplanan Vergi</td>
                                                    <td class="text-end pe-4 fw-bold text-danger fs-5" id="resVergi">0,00 ₺</td>
                                                </tr>
                                                <tr id="rowIstisna">
                                                    <td class="ps-4">Asgari Ücret İstisnası (-)</td>
                                                    <td class="text-end pe-4 fw-bold text-success" id="resIstisna">0,00 ₺</td>
                                                </tr>
                                                <tr class="border-top">
                                                    <td class="ps-4 fw-bold">Ödenecek Net Vergi</td>
                                                    <td class="text-end pe-4 fw-bold text-dark fs-4" id="resOdenecek">0,00 ₺</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-3 p-3 bg-danger-subtle rounded-3 small">
                                        <i class="bi bi-info-circle-fill me-2 text-danger"></i>
                                        Efektif Vergi Oranı: <span id="effectiveRate" class="fw-bold">0%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Geçmiş Hesaplamalar -->
            <div class="card border-0 shadow-sm mt-4 rounded-4 overflow-hidden">
                <div class="card-header bg-light p-3">
                    <h6 class="mb-0 fw-bold"><i class="bi bi-clock-history me-2"></i>Son Hesaplamalar</h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="logTable">
                        <thead class="bg-light small text-uppercase">
                            <tr>
                                <th class="ps-4">Yıl</th>
                                <th>Tür</th>
                                <th>Matrah</th>
                                <th>Vergi</th>
                                <th class="text-end pe-4">İşlem</th>
                            </tr>
                        </thead>
                        <tbody class="small"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
    <div class="mt-5">
        {% include "partials/tax_disclaimer.html" %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const brutUcretInput = document.getElementById("brutUcret");
    const aySecimi = document.getElementById("aySecimi");
    const gelirTuruInput = document.getElementById("gelirTuru");
    const istisnaCheckbox = document.getElementById("asgariIstisna");
    const sonucAlani = document.getElementById("sonucAlani");

    // Para birimi formatlama (Input mask)
    brutUcretInput.addEventListener("input", function (e) {
        let val = e.target.value.replace(/[^\d]/g, "");
        if (!val) return;
        const number = parseFloat(val) / 100;
        e.target.value = number.toLocaleString("tr-TR", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    });

    function gelirTuruKontrol() {
        const isUcret = gelirTuruInput.value === "ucret";
        istisnaCheckbox.disabled = !isUcret;
        if (!isUcret) {
            istisnaCheckbox.checked = false;
            aySecimi.value = "0";
            aySecimi.disabled = true;
        } else {
            aySecimi.disabled = false;
        }
    }

    gelirTuruInput.addEventListener("change", gelirTuruKontrol);
    gelirTuruKontrol();

    // --- Chart & PDF Logic ---
    let resultChart = null;

    function updateChart(vergi, matrah) {
        const ctx = document.getElementById('resultChart').getContext('2d');
        const net = Math.max(matrah - vergi, 0);

        if (resultChart) resultChart.destroy();

        resultChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Net Gelir', 'Gelir Vergisi'],
                datasets: [{
                    data: [net, vergi],
                    backgroundColor: ['#10b981', '#ef4444'],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
                },
                cutout: '70%'
            }
        });
    }

    window.exportToPDF = async function() {
        const { jsPDF } = window.jspdf;
        const element = document.getElementById('exportArea');
        
        // Hide button during capture
        const btn = element.querySelector('button');
        btn.style.display = 'none';

        try {
            const canvas = await html2canvas(element, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

            pdf.setFontSize(18);
            pdf.text("İSFA YMM - Vergi Hesaplama Raporu", 105, 15, { align: "center" });
            pdf.addImage(imgData, 'PNG', 0, 25, pdfWidth, pdfHeight);
            pdf.save(`ISFA_YMM_Gelir_Vergisi_Raporu_${new Date().getTime()}.pdf`);
        } catch (err) {
            console.error(err);
        } finally {
            btn.style.display = 'block';
        }
    }

    document.getElementById("gelirVergisiForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const brut = parseFloat(
            brutUcretInput.value.replace(/\./g, "").replace(",", ".")
        ) || 0;

        const yil = parseInt(document.getElementById("yilInput").value);
        const ay = parseInt(aySecimi.value);
        const gelirTuru = gelirTuruInput.value;
        const istisna = istisnaCheckbox.checked;

        let oncekiMatrahlar = {};

        if (ay > 1 && gelirTuru === "ucret") {
            const { value } = await Swal.fire({
                title: "Kümülatif Matrah",
                html: '<input type="text" class="form-control swal2-input onceki-toplam" placeholder="Önceki Toplam Matrah">',
                confirmButtonText: "Hesapla",
                preConfirm: () => {
                   const val = document.querySelector(".onceki-toplam").value;
                   return parseFloat(val.replace(/\./g,"").replace(",", ".")) || 0;
                }
            });
            if (value === undefined) return;
            oncekiMatrahlar["toplam"] = value;
        }

        try {
            const response = await fetch("/vergi-hesapla", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ brut, yil, ay, gelir_turu: gelirTuru, istisna, onceki_matrahlar: oncekiMatrahlar })
            });
            
            const d = await response.json();
            if (d.error) { Swal.fire("Hata", d.error, "error"); return; }

            sonucAlani.style.display = "block";
            const vergi = d.vergi;
            const istisnaTutari = d.istisna || 0; 
            const hesaplananVergi = vergi + istisnaTutari;

            document.getElementById('resVergi').textContent = hesaplananVergi.toLocaleString("tr-TR",{minimumFractionDigits:2}) + ' ₺';
            document.getElementById('resIstisna').textContent = istisnaTutari.toLocaleString("tr-TR",{minimumFractionDigits:2}) + ' ₺';
            document.getElementById('resOdenecek').textContent = vergi.toLocaleString("tr-TR",{minimumFractionDigits:2}) + ' ₺';

            const effectiveRate = ((vergi / brut) * 100).toFixed(2);
            document.getElementById('effectiveRate').textContent = `%${effectiveRate}`;

            updateChart(vergi, brut);
            logToTable(yil, gelirTuru, brut, vergi);

        } catch (err) {
            Swal.fire("Hata", "Sunucu hatası oluştu.", "error");
        }
    });

    function logToTable(yil, tur, matrah, vergi) {
        const tbody = document.querySelector("#logTable tbody");
        const tr = document.createElement("tr");
        tr.className = "animate__animated animate__fadeIn";
        tr.innerHTML = `
            <td class="ps-4">${yil}</td>
            <td>${tur === "ucret" ? '<span class="badge bg-info">Ücret</span>' : '<span class="badge bg-warning text-dark">Diğer</span>'}</td>
            <td>${matrah.toLocaleString("tr-TR",{minimumFractionDigits:2})} ₺</td>
            <td class="fw-bold text-danger">${vergi.toLocaleString("tr-TR",{minimumFractionDigits:2})} ₺</td>
            <td class="text-end pe-4"><button class="btn btn-sm btn-link text-muted p-0" onclick="this.closest('tr').remove()"><i class="bi bi-trash"></i></button></td>
        `;
        tbody.prepend(tr);
    }
});
</script>
{% endblock %}
