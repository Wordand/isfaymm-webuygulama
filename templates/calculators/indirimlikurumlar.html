{% extends "layout.html" %}
{% block title %}Ä°ndirimli Kurumlar Vergisi{% endblock %}

{% block content %}
<!-- IMask Library -->
<script src="https://unpkg.com/imask"></script>

<style>
.ikv-header {
    background: linear-gradient(160deg, #2d3a5e 0%, #1e2a47 55%, #161f38 100%);
    position: relative;
    overflow: hidden;
    padding: 2rem 2rem 0 2rem;
}
/* Subtle decorative blobs */
.ikv-header::before {
    content: '';
    position: absolute;
    top: -80px; right: -80px;
    width: 280px; height: 280px;
    border-radius: 50%;
    background: rgba(99,130,255,0.07);
    pointer-events: none;
}
.ikv-header::after {
    content: '';
    position: absolute;
    bottom: 0; left: -60px;
    width: 200px; height: 200px;
    border-radius: 50%;
    background: rgba(99,130,255,0.05);
    pointer-events: none;
}
.ikv-badge {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    color: rgba(255,255,255,0.85);
    font-size: 0.78rem;
    font-weight: 700;
    letter-spacing: 1px;
    padding: 0.35rem 0.9rem;
    border-radius: 50px;
}
.ikv-badge.accent {
    background: rgba(250,117,90,0.15);
    border-color: rgba(250,117,90,0.3);
    color: #fda58a;
}
.ikv-stat-card {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    padding: 0.65rem 1rem;
    min-width: 110px;
    text-align: center;
}
.ikv-stat-card .stat-num {
    font-size: 1.25rem;
    font-weight: 800;
    color: #ffffff;
    line-height: 1;
    letter-spacing: -0.02em;
}
.ikv-stat-card .stat-lbl {
    font-size: 0.65rem;
    color: rgba(255,255,255,0.4);
    text-transform: uppercase;
    letter-spacing: 0.9px;
    margin-top: 4px;
}

/* Visitor / MÃ¼kellef Banner */
.ikv-banner {
    border-radius: 10px;
    padding: 0.65rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-top: 1.25rem;
}
.ikv-banner.visitor {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
}
.ikv-banner.mukellef-ok {
    background: rgba(52,211,153,0.08);
    border: 1px solid rgba(52,211,153,0.18);
}
.ikv-banner.mukellef-warn {
    background: rgba(251,191,36,0.08);
    border: 1px solid rgba(251,191,36,0.2);
}

/* Tab Bar */
.ikv-tabbar {
    display: flex;
    gap: 2px;
    margin-top: 1.5rem;
    background: rgba(0,0,0,0.18);
    padding: 4px;
    border-radius: 12px 12px 0 0;
    position: relative;
    z-index: 1;
}
.ikv-tab {
    flex: 1;
    text-align: center;
    padding: 0.65rem 0.5rem;
    border-radius: 9px;
    font-size: 0.88rem;
    font-weight: 600;
    color: rgba(255,255,255,0.5);
    text-decoration: none;
    transition: all 0.18s ease;
    white-space: nowrap;
    letter-spacing: 0.01em;
}
.ikv-tab:hover { color: rgba(255,255,255,0.85); background: rgba(255,255,255,0.06); }
.ikv-tab.active {
    color: #1e2a47;
    background: #ffffff;
    box-shadow: 0 1px 8px rgba(0,0,0,0.18);
    font-weight: 700;
}
.ikv-tab.active i { color: #3b5bdb; }
.ikv-tab i { margin-right: 5px; }

/* Yeni TeÅŸvik Badge */
.ikv-new-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: rgba(52,211,153,0.1);
    border: 1px solid rgba(52,211,153,0.25);
    border-radius: 50px;
    padding: 0.45rem 1rem;
    animation: ikvBlink 0.7s ease-in-out 5;
    animation-fill-mode: forwards;
}
@keyframes ikvBlink {
    0%,100% { opacity: 1; }
    50%      { opacity: 0.25; }
}
.ikv-pulse-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #34d399;
    flex-shrink: 0;
}
.ikv-new-text {
    font-size: 0.86rem;
    font-weight: 700;
    color: #6ee7b7;
    letter-spacing: 0.02em;
    white-space: nowrap;
}
</style>

<div class="container py-4">
  <div class="card border-0 shadow-lg rounded-4 overflow-hidden">

    <!-- Premium Header -->
    <div class="ikv-header">

      <!-- Top Row: Title + Badge + Stats -->
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-3">
        <div style="position:relative; z-index:1;">
          <div class="d-flex align-items-center gap-2 mb-2">
            <span class="ikv-badge">2026 GÃœNCEL</span>
            <span class="ikv-badge accent">
              <i class="bi bi-star-fill me-1"></i>ÃœCRETSÄ°Z
            </span>
          </div>
          <h3 class="text-white mb-1" style="font-size:1.75rem; font-weight:800; letter-spacing:-0.025em;">
            Ä°ndirimli Kurumlar Vergisi
          </h3>
          <p class="mb-0" style="color:rgba(255,255,255,0.55); font-size:1rem; font-weight:400;">
            YatÄ±rÄ±m teÅŸvik belgesi kapsamÄ±nda vergi avantajÄ± hesaplama
          </p>
        </div>

        <!-- Yeni TeÅŸvik Badge -->
        <div style="position:relative; z-index:1; align-self:center;">
          <div class="ikv-new-badge">
            <span class="ikv-pulse-dot"></span>
            <span class="ikv-new-text">2025/9903 Â· Yeni TeÅŸvik Sistemi</span>
          </div>
        </div>
      </div>

      <!-- MÃ¼kellef / ZiyaretÃ§i Durumu -->
      {% if session.get('aktif_mukellef_unvan') %}
      <div class="ikv-banner mukellef-ok" style="position:relative; z-index:1;">
        <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0"
             style="width:32px; height:32px; background:rgba(34,197,94,0.3);">
          <i class="bi bi-building-check text-success"></i>
        </div>
        <div class="flex-grow-1">
          <span class="text-white fw-semibold" style="font-size:0.95rem;">{{ session.get('aktif_mukellef_unvan') }}</span>
          <span style="color:rgba(255,255,255,0.55); font-size:0.88rem;"> Â· {{ session.get('aktif_mukellef_vkn') }}</span>
        </div>
        {% if session.get('logged_in') %}
        <a href="{{ url_for('mukellef.index') }}"
           class="flex-shrink-0 text-decoration-none px-3 py-1 rounded-pill fw-semibold"
           style="background:rgba(255,255,255,0.15); color:white; font-size:0.85rem; border:1px solid rgba(255,255,255,0.2);">
          <i class="bi bi-arrow-left-right me-1"></i>DeÄŸiÅŸtir
        </a>
        {% endif %}
      </div>

      {% elif session.get('logged_in') %}
      <div class="ikv-banner mukellef-warn" style="position:relative; z-index:1;">
        <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0"
             style="width:32px; height:32px; background:rgba(251,191,36,0.25);">
          <i class="bi bi-exclamation-triangle text-warning"></i>
        </div>
        <div class="flex-grow-1">
          <span class="text-white fw-semibold" style="font-size:0.85rem;">MÃ¼kellef seÃ§ilmedi</span>
          <span style="color:rgba(255,255,255,0.5); font-size:0.78rem;"> â€” hesaplamalar kaydedilmeyecek</span>
        </div>
        <a href="{{ url_for('mukellef.index') }}"
           class="flex-shrink-0 text-decoration-none px-3 py-1 rounded-pill fw-semibold"
           style="background:rgba(251,191,36,0.8); color:#1c1917; font-size:0.78rem;">
          <i class="bi bi-person-check me-1"></i>MÃ¼kellef SeÃ§
        </a>
      </div>

      {% else %}
      <div class="ikv-banner visitor" style="position:relative; z-index:1;">
        <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0"
             style="width:32px; height:32px; background:rgba(96,165,250,0.25);">
          <i class="bi bi-person text-info"></i>
        </div>
        <div class="flex-grow-1">
          <span class="text-white fw-semibold" style="font-size:0.95rem;">ZiyaretÃ§i Modu</span>
          <span style="color:rgba(255,255,255,0.55); font-size:0.88rem;"> â€” hesaplama yapabilirsiniz, kaydetmek iÃ§in giriÅŸ yapÄ±n</span>
        </div>
        <a href="{{ url_for('auth.login') }}"
           class="flex-shrink-0 text-decoration-none px-3 py-1 rounded-pill fw-semibold"
           style="background:rgba(255,255,255,0.15); color:white; font-size:0.85rem; border:1px solid rgba(255,255,255,0.25);">
          <i class="bi bi-box-arrow-in-right me-1"></i>GiriÅŸ Yap
        </a>
      </div>
      {% endif %}

      <!-- Tab Bar -->
      <div class="ikv-tabbar">
        <a href="?sekme=form" class="ikv-tab {% if sekme == 'form' %}active{% endif %}">
          <i class="bi bi-pencil-square"></i>Form GiriÅŸi
        </a>
        <a href="?sekme=ayrintili" class="ikv-tab {% if sekme == 'ayrintili' %}active{% endif %}">
          <i class="bi bi-bar-chart-line"></i>AyrÄ±ntÄ±lÄ± KazanÃ§
        </a>
        <a href="?sekme=tesvik" class="ikv-tab {% if sekme == 'tesvik' %}active{% endif %}">
          <i class="bi bi-folder2-open"></i>TeÅŸvik Belgelerim
        </a>
        <a href="?sekme=mevzuat" class="ikv-tab {% if sekme == 'mevzuat' %}active{% endif %}">
          <i class="bi bi-book-half"></i>Mevzuat & Rehber
        </a>
      </div>
    </div>

    <!-- Content Body -->
    <div class="card-body p-4">




<div class="mt-4">
  {% if sekme == 'tesvik' %}
  {% include 'reports/tesvik.html' %}

  {% elif sekme == 'mevzuat' %}
  {% include 'calculators/indirimlikurumlar_mevzuat.html' %}

  {% elif sekme == 'form' %}
  <form id="form-giris" method="POST" action="{{ url_for('indirimlikurumlar.form_kaydet') }}" novalidate class="mx-auto"
    style="max-width: 600px;">

    <input type="hidden" name="mukellef_id" id="mukellef_id" value="{{ session.get('aktif_mukellef_id', '') }}">

    <input type="hidden" name="tesvik_id" id="tesvik_id"
      value="{{ edit_doc.id if edit_doc else (current_belge.id if current_belge else '') }}">

    <input type="hidden" name="belge_no_hidden" id="belge_no_hidden"
      value="{{ current_belge.belge_no if current_belge else '' }}">

    <input type="hidden" name="belge_tarihi_hidden" id="belge_tarihi_hidden"
      value="{{ current_belge.belge_tarihi if current_belge else '' }}">

    <input type="hidden" name="bolge_hidden" id="bolge_hidden"
      value="{{ current_belge.bolge if current_belge else '' }}">





    <!-- ğŸ§° Form Ä°ÅŸlem ButonlarÄ± -->
    <div class="mb-3 text-end">
      <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('kvUploadInput').click()">
        ğŸ“‚ PDFâ€™den Ä°Ã§e Aktar
      </button>
      <button type="button" class="btn btn-outline-danger ms-2" onclick="clearAllFormData()">
        ğŸ—‘ï¸ Verileri Temizle
      </button>
      <a href="{{ url_for('mukellef.index') }}" class="btn btn-outline-secondary ms-2">
        â†©ï¸ MÃ¼kellef YÃ¶netimine DÃ¶n
      </a>
    </div>

    <!-- ğŸ”„ Modern Stepper -->
    <div class="modern-stepper mb-5">
      <div class="stepper-item active" id="step-i-1">
        <div class="step-counter">1</div>
        <div class="step-name">Temel Bilgiler</div>
      </div>
      <div class="stepper-item" id="step-i-2">
        <div class="step-counter">2</div>
        <div class="step-name">BÃ¶lge & Oran</div>
      </div>
      <div class="stepper-item" id="step-i-3">
        <div class="step-counter">3</div>
        <div class="step-name">YatÄ±rÄ±m TutarÄ±</div>
      </div>
      <div class="stepper-item" id="step-i-4">
        <div class="step-counter">4</div>
        <div class="step-name">Ã–nceki DÃ¶nem</div>
      </div>
      <div class="stepper-item" id="step-i-5">
        <div class="step-counter">5</div>
        <div class="step-name">DÃ¶nem KazancÄ±</div>
      </div>
      <div class="stepper-item" id="step-i-6">
        <div class="step-counter">6</div>
        <div class="step-name">Ä°ndirimli Matrah</div>
      </div>
      <div class="stepper-item" id="step-i-7">
        <div class="step-counter">7</div>
        <div class="step-name">SonuÃ§</div>
      </div>
    </div>

    <input id="kvUploadInput" type="file" accept="application/pdf" style="display: none">

    <!-- Step 1 -->
    <div id="step1" class="corporate-card">

      <h5 class="mb-4 text-primary fw-bold"><i class="bi bi-info-circle me-2"></i>AÅŸama 1 - Temel Bilgiler</h5>

      <div class="mb-3">
        <label>YatÄ±rÄ±m TeÅŸvik Belgesi NumarasÄ±</label>
        <input type="text" id="belge_no" name="belge_no" class="form-control" required>
      </div>

      <div class="mb-3">
        <label>YatÄ±rÄ±ma BaÅŸlama Tarihi</label>
        <input type="date" id="baslangic_yili" name="belge_tarihi" class="form-control" required>
      </div>

      <div class="mb-3">
        <label>TeÅŸvik Belgesi Hangi Karara GÃ¶re DÃ¼zenlendi</label>
        <select id="karar" name="karar" onchange="handleKarar9903()" class="form-select" required>
          <option value="">SeÃ§iniz</option>
          <option value="2009/15199">2009/15199</option>
          <option value="2012/3305">2012/3305</option>
          <option value="2009/15199 (2012/3305 sayÄ±lÄ± BKK GeÃ§ici 2. Md.)">
            2009/15199 (2012/3305 sayÄ±lÄ± BKK GeÃ§ici 2. Md.)
          </option>
          <option value="2012/3305 (GeÃ§ici 8. Madde - 1950 sayÄ±lÄ± CumhurbaÅŸkanÄ± KararÄ±)">
            2012/3305 (GeÃ§ici 8. Madde - 1950 sayÄ±lÄ± CumhurbaÅŸkanÄ± KararÄ±)
          </option>
          <option value="2016/9495 (YatÄ±rÄ±mlara Proje BazlÄ± Devlet YardÄ±mÄ± Verilmesine Ä°liÅŸkin Karar)">
            2016/9495 (YatÄ±rÄ±mlara Proje BazlÄ± Devlet YardÄ±mÄ± Verilmesine Ä°liÅŸkin Karar)
          </option>
          <option value="2025/9903">2025/9903</option>
        </select>
      </div>


      <div class="mb-3">
        <label>YatÄ±rÄ±m TÃ¼rÃ¼nÃ¼ SeÃ§iniz (1)</label>
        <select id="yatirim_turu1" name="yatirim_turu1" class="form-select" onchange="toggleInvestmentIncomeInputs()"
          required>
          <option value="">SeÃ§iniz</option>
          <option value="Komple">Komple</option>
          <option value="Tevsi">Tevsi</option>
          <option value="Modernizasyon">Modernizasyon</option>
          <option value="Entegrasyon">Entegrasyon</option>
          <option value="ÃœrÃ¼n GeliÅŸtirme">ÃœrÃ¼n GeliÅŸtirme</option>
          <option value="DiÄŸer">DiÄŸer</option>
        </select>
      </div>

      <div class="mb-3">
        <label>YatÄ±rÄ±m TÃ¼rÃ¼nÃ¼ SeÃ§iniz (2)</label>
        <select id="yatirim_turu2" name="yatirim_turu2" class="form-select" required>
          <option value="">SeÃ§iniz</option>
          <option value="BÃ¶lgesel">BÃ¶lgesel</option>
          <option value="BÃ¼yÃ¼k Ã–lÃ§ekli">BÃ¼yÃ¼k Ã–lÃ§ekli</option>
          <option value="Stratejik">Stratejik</option>
          <option value="Ã–ncelikli YatÄ±rÄ±m">Ã–ncelikli YatÄ±rÄ±m</option>
          <option value="Proje BazÄ±nda Desteklenen YatÄ±rÄ±mlar (6745 SayÄ±lÄ± Kanun)">Proje BazÄ±nda Desteklenen YatÄ±rÄ±mlar
            (6745 SayÄ±lÄ± Kanun)</option>
        </select>
      </div>

      <div class="mb-4">
        <label>Program TÃ¼rÃ¼</label>
        <div class="input-group">
          <span class="input-group-text info-icon-styled" onclick="showInfo('programTuru')">
            <i class="bi bi-info-circle"></i>
          </span>
          <select name="program_turu" id="program_turu" class="form-select">
            <option value="">SeÃ§iniz</option>
            <option value="Teknoloji Hamlesi ProgramÄ±">Teknoloji Hamlesi ProgramÄ±</option>
            <option value="Yerel KalkÄ±nma Hamlesi ProgramÄ±">Yerel KalkÄ±nma Hamlesi ProgramÄ±</option>
            <option value="Stratejik Hamle ProgramÄ±">Stratejik Hamle ProgramÄ±</option>
            <option value="Ã–ncelikli YatÄ±rÄ±mlar TeÅŸvik Sistemi">Ã–ncelikli YatÄ±rÄ±mlar TeÅŸvik Sistemi</option>
            <option value="Hedef YatÄ±rÄ±mlar TeÅŸvik Sistemi">Hedef YatÄ±rÄ±mlar TeÅŸvik Sistemi</option>
          </select>
        </div>
      </div>





      <div class="mb-3">
        <label>Tamamlama Vizesi YapÄ±ldÄ± mÄ±?</label>
        <select name="vize_durumu" id="vize_durumu" class="form-select" required onchange="setOranlar()">
          <option value="">SeÃ§iniz</option>
          <option value="Evet - Ä°ÅŸletme DÃ¶neminde">Evet - Ä°ÅŸletme DÃ¶neminde</option>
          <option value="HayÄ±r - YatÄ±rÄ±m DÃ¶neminde">HayÄ±r - YatÄ±rÄ±m DÃ¶neminde</option>
        </select>
      </div>
      <div class="mt-4 text-end">
        <button type="button" class="btn btn-modern btn-modern-primary" id="btn-step1-next">
          Devam Et <i class="bi bi-arrow-right"></i>
        </button>
      </div>
    </div>

    <div id="step2" class="hidden-step corporate-card">
      <h5 class="mb-4 text-primary fw-bold"><i class="bi bi-gear-fill me-2"></i>AÅŸama 2 - Detaylar</h5>

      <div class="mb-3">
        <label>DÃ¶nem SeÃ§iniz</label>
        <select name="donem" id="donem" class="form-select" required onchange="setOranlar()">
          {% for yil in range(2025, 2014, -1) %}
          <optgroup label="{{ yil }}">
            <option value="{{ yil }} - 1. GEÃ‡Ä°CÄ°">{{ yil }} - 1. GEÃ‡Ä°CÄ°</option>
            <option value="{{ yil }} - 2. GEÃ‡Ä°CÄ°">{{ yil }} - 2. GEÃ‡Ä°CÄ°</option>
            <option value="{{ yil }} - 3. GEÃ‡Ä°CÄ°">{{ yil }} - 3. GEÃ‡Ä°CÄ°</option>
            {% if yil >= 2025 %}
            <option value="{{ yil }} - 4. GEÃ‡Ä°CÄ°">{{ yil }} - 4. GEÃ‡Ä°CÄ°</option>
            {% endif %}
            <option value="{{ yil }} - KURUMLAR">{{ yil }} - KURUMLAR</option>
          </optgroup>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label>Yeniden DeÄŸerleme OranÄ± (%)</label>
        <input type="text" name="yeniden_degerleme_orani" id="yeniden_degerleme_orani" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Ä°li SeÃ§iniz</label>
        <select name="il" id="il" class="form-select" required onchange="setBolge()">
          {% for il in iller %}
          <option value="{{ il }}">{{ il }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label>BÃ¶lge</label>
        <input type="text" name="bolge" id="bolge" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>OSB Durumu</label>
        <select name="osb" id="osb" class="form-select" onchange="setOranlar()">
          <option value="OSB Ä°Ã§inde">OSB Ä°Ã§inde</option>
          <option value="OSB DÄ±ÅŸÄ±nda">OSB DÄ±ÅŸÄ±nda</option>
        </select>
      </div>

      <div class="row g-3 align-items-stretch mb-3">

        <!-- SOL BÄ°LGÄ° KUTUSU -->
        <div class="col-md-5 d-flex">
          <div class="ikv-info-box p-3 bg-light rounded-3 border flex-fill">
            <div class="fw-semibold mb-2">Ä°ndirimli KV OranlarÄ±</div>
            <ul class="list-unstyled small mb-0">
              <li class="d-flex justify-content-between">
                <span>Ä°hracat iÃ§in</span>
                <span id="ind_kv_ihr" class="fw-semibold">â€”%</span>
              </li>
              <li class="d-flex justify-content-between">
                <span>Ä°malat iÃ§in</span>
                <span id="ind_kv_iml" class="fw-semibold">â€”%</span>
              </li>
              <li class="d-flex justify-content-between">
                <span>DiÄŸer Gelirler iÃ§in</span>
                <span id="ind_kv_dig" class="fw-semibold">â€”%</span>
              </li>
            </ul>
          </div>
        </div>

        <!-- SAÄ KONTROLLER -->
        <div class="col-md-7">
          <div class="row g-3 h-100">
            <div class="col-12">
              <label class="form-label">YatÄ±rÄ±ma KatkÄ± OranÄ± (%)</label>
              <div class="input-group fullheight-group">
                <input type="text" name="katki_orani" id="katki_orani" class="form-control" readonly>
                <span class="input-group-text">%</span>
                <button type="button" class="btn btn-outline-secondary" id="btn-manual-katki">Manuel Belirle</button>
              </div>
            </div>

            <div class="col-12">
              <label class="form-label">Vergi Ä°ndirim OranÄ± (%)</label>
              <div class="input-group fullheight-group">
                <input type="text" name="vergi_orani" id="vergi_orani" class="form-control" readonly>
                <span class="input-group-text">%</span>
                <button type="button" class="btn btn-outline-secondary" id="btn-manual-vergi">Manuel Belirle</button>
              </div>
            </div>
          </div>
        </div>

      </div>


      <div class="mb-4">
        <label>DiÄŸer KazanÃ§lara Uygulanacak Oran (%)</label>
        <div class="input-group">
          <span class="input-group-text info-icon-styled" onclick="showInfo('digeroran')">
            <i class="bi bi-info-circle"></i>
          </span>
          <input type="text" name="diger_oran" id="diger_oran" class="form-control" readonly>
        </div>
      </div>

      <!-- ğŸ”¹ Butonlar -->
      <div class="mt-4 d-flex justify-content-between">
        <button type="button" class="btn btn-modern btn-outline-secondary" onclick="goToStep1()">
          <i class="bi bi-arrow-left"></i> Geri
        </button>
        <button type="button" class="btn btn-modern btn-modern-primary" onclick="goToStep3()">
          Devam Et <i class="bi bi-arrow-right"></i>
        </button>
      </div>
    </div>






    <div id="step3" class="hidden-step corporate-card">
      <h5 class="mb-4 text-primary fw-bold"><i class="bi bi-cash-stack me-2"></i>AÅŸama 3 - YatÄ±rÄ±m Bilgileri</h5>

      <div class="mb-3">
        <label>Toplam YatÄ±rÄ±m TutarÄ±nÄ± Giriniz</label>
        <input type="text" name="toplam_tutar" id="toplam_tutar" class="form-control" placeholder="Tutar Giriniz">
      </div>

      <div class="mb-3">
        <label>Toplam YatÄ±rÄ±ma KatkÄ± TutarÄ±</label>
        <input type="text" name="katki_tutari" id="katki_tutari" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>DiÄŸer Faaliyetlerden Elde Edilen KazanÃ§lar Ä°Ã§in KatkÄ± TutarÄ±</label>
        <div class="input-group">
          <span class="input-group-text info-icon-styled" onclick="showInfo('digerkatkitutari')">
            <i class="bi bi-info-circle"></i>
          </span>
          <input type="text" name="diger_katki_tutari" id="diger_katki_tutari" class="form-control" readonly>
        </div>
      </div>

      <div class="mb-3">
        <label>Cari YÄ±lda Fiilen GerÃ§ekleÅŸtirilen YatÄ±rÄ±m HarcamasÄ± TutarÄ±nÄ± Giriniz</label>
        <input type="text" name="cari_harcama_tutari" id="cari_harcama_tutari" class="form-control"
          placeholder="Tutar Giriniz">
      </div>

      <div class="mb-3">
        <label>YatÄ±rÄ±mÄ±n BaÅŸlangÄ±cÄ±ndan Ä°tibaren Fiilen GerÃ§ekleÅŸtirilen YatÄ±rÄ±m HarcamasÄ± TutarÄ±nÄ± Giriniz</label>
        <input type="text" name="toplam_harcama_tutari" id="toplam_harcama_tutari" class="form-control"
          placeholder="Tutar Giriniz">
      </div>

      <div class="mb-3">
        <label>Fiili YatÄ±rÄ±m HarcamasÄ± Nedeniyle Hak KazanÄ±lan YatÄ±rÄ±ma KatkÄ± TutarÄ±</label>
        <input type="text" name="fiili_katki_tutari" id="fiili_katki_tutari" class="form-control" readonly>
      </div>

      <button type="button" class="btn btn-secondary me-2" onclick="goToStep2()">â† Geri</button>
      <button type="button" class="btn btn-primary" onclick="goToStep4()">Devam</button>

    </div>

    <div id="step4" class="hidden-step corporate-card">
      <h5 class="mb-4 text-primary fw-bold"><i class="bi bi-calculator-fill me-2"></i>AÅŸama 4 - Ã–nceki DÃ¶nem Verileri</h5>

      <div class="mb-3">
        <label>Ã–nceki DÃ¶nemlerde YararlanÄ±lan YatÄ±rÄ±ma KatkÄ± TutarÄ±nÄ± Giriniz<br>
          (<span class="text-primary fw-bold">YatÄ±rÄ±mdan Elde Edilen KazanÃ§ DolayÄ±sÄ±yla</span>)
          <input type="text" name="onceki_yatirim_katki_tutari" id="onceki_yatirim_katki_tutari" class="form-control"
            placeholder="Tutar Giriniz">
      </div>

      <div class="mb-3">
        <label>Ã–nceki DÃ¶nemlerde YararlanÄ±lan YatÄ±rÄ±ma KatkÄ± TutarÄ±nÄ± Giriniz<br>
          (<span class="text-success fw-bold">DiÄŸer Faaliyetlerden Elde Edilen KazanÃ§ DolayÄ±sÄ±yla</span>)
          <input type="text" name="onceki_diger_katki_tutari" id="onceki_diger_katki_tutari" class="form-control"
            placeholder="Tutar Giriniz">
      </div>

      <div class="mb-3">
        <label>Ã–nceki DÃ¶nemlerde YararlanÄ±lan Toplam YatÄ±rÄ±ma KatkÄ± TutarÄ±</label>
        <input type="text" name="onceki_katki_tutari" id="onceki_katki_tutari" class="form-control calculation-result" readonly>
      </div>

      <div class="mb-3">
        <label>Cari Hesaplama Ã–ncesi Kalan KatkÄ± TutarÄ±</label>
        <input type="text" name="kalan_katki_tutari" id="kalan_katki_tutari" class="form-control calculation-result" readonly>
      </div>

      <div class="mb-3">
        <label>EndekslenmiÅŸ Tutarlar Dahil Fiili YatÄ±rÄ±m HarcamasÄ± Nedeniyle<br>
          Hak KazanÄ±lan YatÄ±rÄ±ma KatkÄ± TutarÄ±</label>
        <input type="text" name="endeks_katki_tutari" id="endeks_katki_tutari" class="form-control" readonly>
      </div>

      <div class="mt-4 d-flex justify-content-between">
        <button type="button" class="btn btn-modern btn-outline-secondary" onclick="goToStep3()">
          <i class="bi bi-arrow-left"></i> Geri
        </button>
        <button type="button" class="btn btn-modern btn-modern-primary" onclick="goToStep5()">
          Devam Et <i class="bi bi-arrow-right"></i>
        </button>
      </div>
    </div>

    <div id="step5" class="hidden-step corporate-card">
      <h5 class="mb-4 text-primary fw-bold"><i class="bi bi-graph-up-arrow me-2"></i>AÅŸama 5 - Cari DÃ¶nem KazanÃ§ Bilgileri</h5>

      <div class="mb-3">
        <label>YatÄ±rÄ±mdan Elde Edilen KazanÃ§ (TL):</label>
        <input type="text" name="yatirimdan_elde_edilen_kazanc" id="yatirimdan_elde_edilen_kazanc" class="form-control"
          placeholder="0,00 TL">
      </div>




      <div class="mb-3">
        <label>Ticari BilanÃ§o KarÄ±nÄ± Giriniz (TL):</label>
        <input type="text" name="ticari_bilanco_kari" id="ticari_bilanco_kari" class="form-control"
          placeholder="0,00 TL" oninput="calculateTevsiKazancAutomatically(); calculateKVMatrah();">
      </div>

      <div class="mb-3">
        <label>KKEG Giriniz (TL):</label>
        <input type="text" name="kkeg" id="kkeg" class="form-control" placeholder="0,00 TL" oninput="calculateKVMatrah();">
      </div>

      <div class="mb-3">
        <label>Kurumlar Vergisi MatrahÄ± (TL)</label>
        <div class="input-group">
          <input type="text" name="kv_matrah" id="kv_matrah" class="form-control calculation-result" placeholder="0,00 TL" readonly>
          <button type="button" class="btn btn-outline-secondary" id="btn-manual-matrah">
            Manuel Belirle
          </button>
        </div>
      </div>




      <div class="mb-3">
        <label>GerÃ§ekleÅŸen Tevsi YatÄ±rÄ±m TutarÄ±nÄ± Giriniz (TL):</label>
        <input type="text" name="gerceklesen_tevsi_yatirim_tutari" id="gerceklesen_tevsi_yatirim_tutari"
          class="form-control" placeholder="0,00 TL" oninput="calculateTevsiKazancAutomatically()">
      </div>



      <div class="mb-3">
        <label>Toplam Sabit KÄ±ymet TutarÄ±nÄ± Giriniz (TL):</label>
        <div class="input-group">
          <span class="input-group-text info-icon-styled" onclick="showInfo('toplamSabitKiymetTutari')">
            <i class="bi bi-info-circle"></i>
          </span>
          <input type="text" name="toplam_sabit_kiymet_tutari" id="toplam_sabit_kiymet_tutari" class="form-control"
            placeholder="0,00 TL" oninput="calculateTevsiKazancAutomatically()">
        </div>
      </div>


      <div class="mb-3">
        <label>Tevsi YatÄ±rÄ±mlardan Elde Edilen KazanÃ§ TutarÄ± (TL):</label>
        <div class="input-group">
          <span class="input-group-text info-icon-styled" onclick="showInfo('tevsiYatirimdanEldeEdilenKazancTutari')">
            <i class="bi bi-info-circle"></i>
          </span>
          <input type="text" name="tevsi_yatirim_kazanci" id="tevsi_yatirim_kazanci" class="form-control calculation-result"
            placeholder="0,00 TL" readonly>
        </div>
      </div>

      <div class="mt-4 d-flex justify-content-between">
        <button type="button" class="btn btn-modern btn-outline-secondary" onclick="goToStep4()">
          <i class="bi bi-arrow-left"></i> Geri
        </button>
        <button type="button" class="btn btn-modern btn-modern-primary" onclick="goToStep6()">
          Devam Et <i class="bi bi-arrow-right"></i>
        </button>
      </div>
    </div>

    <div id="step6" class="hidden-step corporate-card">
      <h5 class="mb-4 text-primary fw-bold"><i class="bi bi-diagram-3-fill me-2"></i>AÅŸama 6 â€“ SatÄ±ÅŸ & Faaliyet DaÄŸÄ±lÄ±mÄ±</h5>

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="useDetailedProfitRatios" name="use_detailed_profit_ratios"
          onchange="toggleDetailedProfitInput()">
        <label class="form-check-label" for="useDetailedProfitRatios">
          ğŸ“ˆ AyrÄ±ntÄ±lÄ± KazanÃ§ DaÄŸÄ±lÄ±mÄ±nÄ± Kullan
        </label>
      </div>

      <div class="mb-3">
        <label>BrÃ¼t SatÄ±ÅŸlar</label>
        <input type="text" name="brut_satis" id="brut_satis" class="form-control" placeholder="Tutar Giriniz">
      </div>
      <div class="mb-3 row">
        <div class="col">
          <label>Ä°hracat Faaliyeti</label>
          <input type="text" name="ihracat" id="ihracat" class="form-control" placeholder="Tutar Giriniz"
            oninput="calculateRatios()">
        </div>
        <div class="col-auto align-self-end">
          <span id="ratio_ihracat">â€”%</span>
        </div>
      </div>
      <div class="mb-3 row">
        <div class="col">
          <label>Ä°malat Faaliyeti</label>
          <input type="text" name="imalat" id="imalat" class="form-control" placeholder="Tutar Giriniz"
            oninput="calculateRatios()">
        </div>
        <div class="col-auto align-self-end">
          <span id="ratio_imalat">â€”%</span>
        </div>
      </div>
      <div class="mb-3 row">
        <div class="col">
          <label>DiÄŸer Faaliyetler</label>
          <input type="text" name="diger_faaliyet" id="diger_faaliyet" class="form-control" placeholder="Tutar Giriniz"
            oninput="calculateRatios()">
        </div>
        <div class="col-auto align-self-end">
          <span id="ratio_diger">â€”%</span>
        </div>
      </div>



      <div class="mt-4 d-flex justify-content-between">
        <button type="button" class="btn btn-modern btn-outline-secondary" onclick="goToStep5('from6')">
          <i class="bi bi-arrow-left"></i> Geri
        </button>
        <button id="calculateCariBtn" type="button" class="btn btn-modern btn-modern-primary">
          <i class="bi bi-calculator"></i> CARÄ° KATKI TUTARINI HESAPLA
        </button>
      </div>

      <div class="mt-5 d-flex justify-content-center">
        <a href="?sekme=ayrintili" class="btn btn-modern btn-modern-primary px-5 py-3 shadow-lg">
          <i class="bi bi-pie-chart-fill me-2"></i>
          KazanÃ§ DaÄŸÄ±lÄ±mÄ±nÄ± AyrÄ±ntÄ±lÄ± Olarak Hesaplamak Ä°stiyorum
          <i class="bi bi-arrow-right ms-2"></i>
        </a>
      </div>
    </div>

    <div id="step7" class="hidden-step corporate-card">
      <h5 class="mb-4 text-primary fw-bold"><i class="bi bi-check-circle-fill me-2"></i>AÅŸama 7 - SonuÃ§lar & Kaydet</h5>


      <div id="info-9903-limits" class="alert alert-warning small mb-3 shadow-sm" style="display: none; border-left: 5px solid #ffc107;">
        <div class="fw-bold mb-1"><i class="bi bi-exclamation-triangle-fill"></i> 2025/9903 KararÄ± Ã–zel SÄ±nÄ±rlarÄ± (DiÄŸer Faaliyetler):</div>
        <ul class="mb-0 ps-3">
          <li>1. SÄ±nÄ±r (Toplam KatkÄ±nÄ±n %50â€™si - Kalan): <span id="span-limit1-9903" class="fw-semibold text-dark">0,00 TL</span></li>
          <li>2. SÄ±nÄ±r (Fiili Harcama / Hak Edilen Bakiye): <span id="span-limit2-9903" class="fw-semibold text-dark">0,00 TL</span></li>
          <li>Uygulanan SÄ±nÄ±r: <span class="fw-bold text-danger" id="span-limit-used-9903">0,00 TL</span></li>
        </ul>
      </div>

      <div class="mb-3">
        <label>Cari DÃ¶nemde YararlanÄ±lan YatÄ±rÄ±ma KatkÄ± TutarÄ± (YatÄ±rÄ±mdan Elde Edilen KazanÃ§ DolayÄ±sÄ±yla)</label>
        <input type="text" id="cari_yatirim_katki" name="cari_yatirim_katki" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Cari DÃ¶nemde YararlanÄ±lan YatÄ±rÄ±ma KatkÄ± TutarÄ± (DiÄŸer Faaliyetlerden Elde Edilen Gelirler
          DolayÄ±sÄ±yla)</label>
        <input type="text" id="cari_diger_katki" name="cari_diger_katki" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Cari DÃ¶nemde YararlanÄ±lan Toplam YatÄ±rÄ±ma KatkÄ± TutarÄ±</label>
        <input type="text" id="cari_toplam_katki" name="cari_toplam_katki" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Cari DÃ¶nem Dahil Olmak Ãœzere YararlanÄ±lan Toplam YatÄ±rÄ±ma KatkÄ± TutarÄ±</label>
        <input type="text" id="genel_toplam_katki" name="genel_toplam_katki" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Ä°ndirimli Kurumlar Vergisi MatrahÄ±</label>
        <input type="text" id="indirimli_matrah" name="indirimli_matrah" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Ä°ndirimli Kurumlar Vergisi</label>
        <input type="text" id="indirimli_kv" name="indirimli_kv" class="form-control" readonly>
      </div>

      <div class="mb-3">
        <label>Ä°ndirimli Kurumlar Vergisi OranÄ± %</label>
        <input type="text" id="indirimli_kv_oran" name="indirimli_kv_oran" class="form-control" readonly>
      </div>


      <div class="d-flex justify-content-start gap-2 mt-4">
        <button type="button" class="btn btn-secondary" onclick="goToStep6()">â† Geri</button>

        <button type="submit" class="btn btn-primary" onclick="submitFullFormAndDonem()">
          ğŸ’¾ Kaydet / GÃ¼ncelle
        </button>
      </div>

    </div>
  </form>

  {% elif sekme == 'ayrintili' %}
  <div class="text-center my-4">
    <a href="?sekme=form#step6" class="btn btn-outline-secondary btn-lg text-decoration-none">
      â† AÅŸama 6â€™ya Geri DÃ¶n
    </a>
  </div>

  <h3 class="text-center my-4">ğŸ“Š AyrÄ±ntÄ±lÄ± KazanÃ§ Hesaplama</h3>

  <form method="POST" class="mb-4" id="ayrintili-kazanc-form"
    action="{{ url_for('indirimlikurumlar.ayrintili_kazanc') }}">
    <div class="d-flex justify-content-between mb-3">
      <button name="export" class="btn btn-success" type="submit" value="1">
        ğŸ“¤ DÄ±ÅŸa Aktar
      </button>
    </div>

    <table class="table table-striped table-bordered" id="ayrintili-kazanc-table">
      <thead class="table-light">
        <tr>
          <th>AÃ§Ä±klama</th>
          <th>Toplam HasÄ±lat (B)</th>
          <th>Ä°hracat (C)</th>
          <th>Ä°malat (D)</th>
          <th>DiÄŸer (E)</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        {# parantez iÃ§indeki kodu al #}
        {% set code = row['AÃ§Ä±klama'].split('(')[-1].split(')')[0] %}
        <tr>
          <td class="
                                {% if code|length == 3 %}
                                    text-end
                                {% else %}
                                    text-start fw-bold
                                {% endif %}
                            ">
            {{ row['AÃ§Ä±klama'] }}
          </td>

          <td><input name="B_{{ loop.index0 }}" class="form-control form-control-sm text-end" value="{{ row['B'] }}"
              placeholder="Tutar Giriniz" {% if loop.index0 in
              [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54]
              %}readonly{% endif %}></td>
          <td><input name="C_{{ loop.index0 }}" class="form-control form-control-sm text-end" value="{{ row['C'] }}"
              placeholder="Tutar Giriniz" {% if loop.index0 in [0,1,5,9,10,15,16,20,21,22,23,34,42,45,46,49,53,54]
              %}readonly{% endif %}></td>
          <td><input name="D_{{ loop.index0 }}" class="form-control form-control-sm text-end" value="{{ row['D'] }}"
              placeholder="Tutar Giriniz" {% if loop.index0 in [0,1,5,9,10,15,16,20,21,22,23,34,42,45,46,49,53,54]
              %}readonly{% endif %}></td>
          <td><input name="E_{{ loop.index0 }}" class="form-control form-control-sm text-end" value="{{ row['E'] }}"
              placeholder="Tutar Giriniz" {% if loop.index0 in [0,1,5,9,10,15,16,20,21,22,23,34,42,45,46,49,53,54]
              %}readonly{% endif %}></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="text-center mt-4">
      <button type="submit" class="btn btn-lg btn-outline-primary" id="save-ayrintili-kazanc">ğŸ’¾ Kaydet</button> {# ID
      eklendi #}
      <button type="button" class="btn btn-lg btn-danger ms-2" id="clearProfitData">ğŸ—‘ï¸ TÃ¼mÃ¼nÃ¼ Temizle</button>
    </div>
  </form>
  {% endif %}
</div>

{% set extra_disclaimer = True %}
{% include 'partials/tax_disclaimer.html' %}



<style>
  #step1,
  #step2,
  #step3,
  #step4,
  #step5,
  #step6,
  #step7 {
    transition: opacity 0.4s ease-in-out, visibility 0.4s ease-in-out;
    opacity: 1;
    visibility: visible;
  }

  .hidden-step {
    display: none;
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    position: absolute;
  }

  .fullheight-group .form-control,
  .fullheight-group .input-group-text,
  .fullheight-group .btn {
    height: 44px;
  }

  .ikv-info-box {
    display: flex;
    flex-direction: column;
    justify-content: center;
    /* kutu iÃ§eriÄŸini ortala */
  }
</style>

<script>


  let programmaticMaskUpdate = false;
  let RESTORE_MODE = false;

  const maskMap = {};
  const userTyped = {};

  // 2) MASK INPUT CONFIG
  const idConfig = {
    "toplam_tutar": "katki",
    "cari_harcama_tutari": "katki",
    "toplam_harcama_tutari": "katki",

    "onceki_yatirim_katki_tutari": "katki",
    "onceki_diger_katki_tutari": "katki",

    "katki_orani": "percent",
    "vergi_orani": "percent",
    "diger_oran": "percent",


    "brut_satis": "ratios",
    "ihracat": "ratios",
    "imalat": "ratios",
    "diger_faaliyet": "ratios",
    "gerceklesen_tevsi_yatirim_tutari": "tevsi",
    "toplam_sabit_kiymet_tutari": "tevsi",
    "ticari_bilanco_kari": "kv",
    "kkeg": "kv",

    // SAFE OUTPUTS â†’ hesaplayÄ±cÄ±lar tarafÄ±ndan yazÄ±lÄ±r, mask tetiklemez
    "tevsi_yatirim_kazanci": "none",
    "katki_tutari": "none",
    "diger_katki_tutari": "none",
    "fiili_katki_tutari": "none",
    "onceki_katki_tutari": "none",
    "kalan_katki_tutari": "none",
    "endeks_katki_tutari": "none",

    "kv_matrah": "none",
    "cari_yatirim_katki": "none",
    "cari_diger_katki": "none",
    "cari_toplam_katki": "none",
    "genel_toplam_katki": "none",
    "indirimli_matrah": "none",
    "indirimli_kv": "none",
    "indirimli_kv_oran": "none",
  };





  // 5) Tevsi IMask referansÄ±
  let tevsiMask = null;


  const bolgeMap = {{ bolge_json | tojson }};
  const katkilar = {{ katkilar_json | tojson }};
  const vergiler = {{ vergiler_json | tojson }};
  const initialRatios = {{ initial_ayrintili_ratios | tojson }};
  const bolgeMap9903 = {{ BOLGE_MAP_9903 | tojson | safe }};
  const katkilar9903 = {{ TESVIK_KATKILAR_9903 | tojson | safe }};
  const yenidenDegerlemeOranlari = {
    "2025 - KURUMLAR": 25.49,
    "2025 - 4. GEÃ‡Ä°CÄ°": 25.49,
    "2025 - 3. GEÃ‡Ä°CÄ°": 16.60,
    "2025 - 2. GEÃ‡Ä°CÄ°": 9.23,
    "2025 - 1. GEÃ‡Ä°CÄ°": 3.30,
    "2024 - 3. GEÃ‡Ä°CÄ°": 34.14,
    "2024 - 2. GEÃ‡Ä°CÄ°": 22.20,
    "2024 - 1. GEÃ‡Ä°CÄ°": 7.55,
    "2024 - KURUMLAR": 43.93,
    "2023 - KURUMLAR": 58.46,
    "2022 - KURUMLAR": 122.93,
    "2021 - KURUMLAR": 36.20,
    "2020 - KURUMLAR": 9.11
  };

  let debounceTimeout = null;
  let isProgrammaticChange = false; // Yeni bayrak: Programatik deÄŸiÅŸiklik mi?


  // AÅŸamalarÄ± temsil eden dizi (global olarak tanÄ±mlÄ±, bu kod bloÄŸunun baÅŸÄ±nda olmalÄ±)
  const ALL_STEPS_IDS = ["step1", "step2", "step3", "step4", "step5", "step6", "step7"];
  const TOTAL_STEPS = 7; // Toplam aÅŸama sayÄ±sÄ±

  let CURRENT_STEP = 1; // Nereden geldiÄŸimizi takip etmek iÃ§in









  function getVal(id) {
    const mask = maskMap[id];
    const el = document.getElementById(id);
    if (!el) return 0;

    // 1) EÄŸer IMask uygulanmÄ±ÅŸsa -> typedValue doÄŸrudan Number dÃ¶ner
    if (mask) {
      const v = mask.typedValue;
      if (v === null || v === undefined || v === "") return 0;
      return typeof v === "number" ? v : (Number(v) || 0);
    }

    // 2) EÄŸer IMask yoksa -> TÃ¼rk formatlÄ± parse
    return parseFormattedNumber(el.value);
  }





  function formatTL(num) {
    if (isNaN(num) || num === null || num === undefined) return "0,00";
    return Number(num).toLocaleString("tr-TR", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }


  function parseFormattedNumber(value) {
    if (value === null || value === undefined) return 0;
    if (typeof value === 'number') return value;

    let v = value.toString().trim();
    // % ve TL ve boÅŸluk temizle
    v = v.replace(/[%â‚º\s]/g, '');

    if (v === "") return 0;

    // 1) Ä°Ã§inde virgÃ¼l varsa (TÃ¼rk standardÄ±: 1.234,56)
    if (v.indexOf(',') > -1) {
      // TÃ¼m noktalarÄ± sil (binlik), virgÃ¼lÃ¼ nokta yap (ondalÄ±k)
      v = v.replace(/\./g, '').replace(',', '.');
    }
    // 2) VirgÃ¼l Yok, Nokta Var
    else if (v.indexOf('.') > -1) {
      const parts = v.split('.');
      // a) Birden Ã§ok nokta varsa (1.000.000) -> Binliktir, sil.
      if (parts.length > 2) {
        v = v.replace(/\./g, '');
      }
      // b) Tek nokta varsa
      else {
         // NoktanÄ±n saÄŸÄ±ndaki kÄ±sÄ±m (kuruÅŸ mu binlik mi?)
         // EÄŸer saÄŸ taraf tam 3 haneli ise (1.000 veya 100.000) -> Binlik kabul et
         // (Risk: 1.234 diye ondalÄ±k yazan olursa binlik sanÄ±lÄ±r. Ama TR uygulamasÄ±nda 1.234 bindir.)
         const decimals = parts[1];
         if (decimals && decimals.length === 3) {
             v = v.replace(/\./g, ''); // Binlik, sil.
         } else {
             // DiÄŸer durumlar (10.5, 10.50) -> OndalÄ±k kalsÄ±n (Nokta olarak kalsÄ±n)
         }
      }
    }
    // 3) Ne nokta ne virgÃ¼l -> DÃ¼z sayÄ± (1000)

    const num = parseFloat(v);
    return isNaN(num) ? 0 : num;
  }




  function safeSet(id, val) {
    const el = document.getElementById(id);
    if (!el) return;

    const mask = maskMap[id];

    // Numerik gÃ¼venlik
    let numVal = Number(val);
    if (isNaN(numVal)) numVal = 0;

    // 1) EÄŸer IMask varsa -> typedValue Ã¼zerinden set et
    if (mask) {
      programmaticMaskUpdate = true;
      mask.typedValue = numVal;
      programmaticMaskUpdate = false;
    } else {
      // 2) Maskesiz Alanlar -> Yerel format (tr-TR)
      el.value = numVal.toLocaleString("tr-TR", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    // âœ¨ GÃ¶rsel Geri Bildirim (Flash Efekti)
    if (el.classList.contains("calculation-result")) {
      el.classList.add("flash");
      setTimeout(() => el.classList.remove("flash"), 600);
    }
  }




  function normalizeBN(s) { return (s || '').replace(/\D/g, ''); }

  function convertToInputDateFormat(t) {
    const p = (t || '').split('/');
    return p.length === 3 ? `${p[2]}-${p[1].padStart(2, '0')}-${p[0].padStart(2, '0')}` : t;
  }





  function showSwalMessage(type, title, text) {
    Swal.fire({
      icon: type,
      title: title,
      text: text,
      timer: 3000,
      toast: true,
      position: "top-end",
      showConfirmButton: false
    });
  }

  function showInfo(key) {
    let title = "Bilgilendirme";
    let message = "Bilgi mesajÄ± mevcut deÄŸil.";
    let icon = "info";
    const createJustifiedMessage = (text) => `<div style='text-align: justify;'>${text}</div>`;
    switch (key) {
      case 'yatirimaBaslamaTarihi':
        message = createJustifiedMessage(
          "<b>YatÄ±rÄ±ma BaÅŸlama Tarihi</b> olarak, YatÄ±rÄ±m TeÅŸvik Belgesi ekinde yer alan 'yatÄ±rÄ±ma baÅŸlama tarihi' esas alÄ±nmalÄ±dÄ±r. <br><br>" +
          "<i>Ã–nemli Not:</i> EÄŸer belgede birden fazla tarih varsa, genellikle yatÄ±rÄ±mÄ±n fiilen baÅŸladÄ±ÄŸÄ± veya belgenin onaylandÄ±ÄŸÄ± tarih kullanÄ±lÄ±r."
        );
        break;

      case 'programTuru':
        title = "2025/9903 GÃ¼ncel Karara Ä°liÅŸkin Bilgilendirme";
        message = createJustifiedMessage(
          "<b>NOT:</b> Kurumlar vergisi oranÄ±, yatÄ±rÄ±m teÅŸvik belgesi kapsamÄ±nda gerÃ§ekleÅŸtirilen yatÄ±rÄ±mlardan elde edilen kazanÃ§lara, " +
          "yatÄ±rÄ±mÄ±n kÄ±smen veya tamamen iÅŸletilmesine baÅŸlanÄ±lan hesap dÃ¶neminden itibaren " +
          "yatÄ±rÄ±ma katkÄ± tutarÄ±na ulaÅŸÄ±ncaya kadar, indirim hakkÄ±nÄ±n kullanÄ±labileceÄŸi ilk hesap dÃ¶nemi dahil " +
          "en fazla <b>10 hesap dÃ¶nemi</b> boyunca <b>%60 indirimli</b> olarak uygulanÄ±r.<br><br>" +

          "Ä°ndirim hakkÄ±nÄ±n kullanÄ±labileceÄŸi ilk hesap dÃ¶nemi dahil en fazla on hesap dÃ¶nemine iliÅŸkin sÄ±nÄ±rlama, " +
          "<b>16/6/2025</b> tarihinden Ã¶nce baÅŸvurusu yapÄ±lmÄ±ÅŸ ve reddedilmemiÅŸ olanlar hariÃ§, " +
          "<b>24/7/2025</b> tarihinden itibaren (bu tarih dahil) alÄ±nan yatÄ±rÄ±m teÅŸvik belgeleri yÃ¶nÃ¼nden geÃ§erli olacaktÄ±r.<br><br>" +

          "<b>NOT:</b> KazanÃ§ bulunmasÄ±na raÄŸmen yararlanÄ±lmayan yatÄ±rÄ±ma katkÄ± tutarlarÄ± mÃ¼teakip dÃ¶nemlerde dikkate alÄ±nmaz.<br><br>" +
          "Buna gÃ¶re, ilgili hesap dÃ¶nemlerinde faydalanma imkÃ¢nÄ± bulunmakta iken, " +
          "<b>faydalanÄ±lmayan yatÄ±rÄ±ma katkÄ± tutarlarÄ±nÄ±n izleyen dÃ¶nemlerde kullanÄ±lmasÄ± mÃ¼mkÃ¼n deÄŸildir.</b>"
        );
        break;

      case 'digeroran':
        message = createJustifiedMessage(
          "YatÄ±rÄ±m dÃ¶neminde diÄŸer faaliyetlerden elde edilen kazanÃ§larda indirimli kurumlar vergisi uygulanmasÄ± mÃ¼mkÃ¼ndÃ¼r."
        );
        break;


      case 'digerkatkitutari':
        message = createJustifiedMessage(
          "MÃ¼kellefler, yatÄ±rÄ±m teÅŸvik belgeleri kapsamÄ±ndaki yatÄ±rÄ±mlarÄ±na fiilen baÅŸladÄ±klarÄ± tarihten itibaren, hesaplanacak yatÄ±rÄ±ma katkÄ± tutarÄ±na mahsuben; <br><br>" +
          "a) Toplam yatÄ±rÄ±ma katkÄ± tutarÄ±nÄ±n Bakanlar Kurulu KararÄ± ile belirlenen oranÄ±nÄ± geÃ§memek ve <br><br>" +
          "b) GerÃ§ekleÅŸtirilen yatÄ±rÄ±m harcamasÄ± tutarÄ±nÄ± aÅŸmamak <br><br>" +
          "Ã¼zere, yatÄ±rÄ±m dÃ¶neminde diÄŸer faaliyetlerinden elde ettikleri kazanÃ§larÄ±na indirimli kurumlar vergisi uygulanabilecektir."
        );
        break;


      case 'toplamSabitKiymetTutari':
        message = createJustifiedMessage(
          "<b>Toplam Sabit KÄ±ymet TutarÄ±</b> ifadesinden, Amortisman mevzuunu oluÅŸturan iktisadi kÄ±ymetlerin anlaÅŸÄ±lmasÄ± gerekir.<br><br>" +
          "DolayÄ±sÄ±yla boÅŸ arazi-arsa ve amortismana tabi olmayan diÄŸer kÄ±ymetlerle ilgili tutarlar bu hesaplamada dikkate alÄ±nmaz.<br><br>" +
          "Sabit KÄ±ymet tutarÄ±nÄ±n hesabÄ±nda bu kÄ±ymetlerin BÄ°RÄ°KMÄ°Å AMORTÄ°SMAN DÃœÅÃœLMEDEN Ã¶nceki brÃ¼t tutarlarÄ±nÄ±n dikkate alÄ±nmasÄ± gerekmektedir.<br><br>" +
          "Bu hesaplama sÄ±rasÄ±nda iÅŸletme aktifinde yer alan sabit kÄ±ymetlerin kayÄ±tlÄ± deÄŸeri olarak, yapÄ±lan ENFLASYON DÃœZELTMESÄ° SONUCU oluÅŸan deÄŸerleri dikkate alÄ±nacaktÄ±r."
        );
        break;

      case 'tevsiYatirimdanEldeEdilenKazancTutari':
        message = createJustifiedMessage(
          "Tevsi yatÄ±rÄ±mlardan elde edilen kazancÄ±n ayrÄ± hesaplarda izlenmek suretiyle tespit edilebilmesi halinde, bu kazanca indirimli vergi oranÄ± uygulanacaktÄ±r. <br><br>" +
          "KazancÄ±n ayrÄ± bir ÅŸekilde tespit edilememesi halinde ise; <br><br>" +
          "Tevsi yatÄ±rÄ±m dolayÄ±sÄ±yla indirimli vergi oranÄ± uygulanacak kazanÃ§ = (GerÃ§ekleÅŸen Tevsi YatÄ±rÄ±m TutarÄ± / Toplam Sabit KÄ±ymet TutarÄ±) X Ticari bilanÃ§o KarÄ± <br><br>" +
          "Tevsi yatÄ±rÄ±mlardan elde edilen kazancÄ±n bu ÅŸekilde oranlama yapÄ±lmak suretiyle belirlenmesi seÃ§imlik bir hak olmayÄ±p, indirimli kurumlar vergisi uygulanacak kazancÄ±n ayrÄ± hesaplarda izlenmek suretiyle mÃ¼kellefÃ§e tespit edilmesi esastÄ±r."
        );
        break;

      default: // VarsayÄ±lan durum: EÄŸer tanÄ±msÄ±z bir anahtar gelirse
        message = "Bu alan hakkÄ±nda bilgi bulunmamaktadÄ±r.";
        icon = "warning"; // VarsayÄ±lan durum iÃ§in uyarÄ± ikonu
        break;
    }
    // SweetAlert mesajÄ±nÄ± gÃ¶ster
    Swal.fire({
      icon: icon, // 'info' ikonu kullanÄ±lacak
      title: title,
      html: message,
      position: 'center', // EkranÄ±n ortasÄ±nda gÃ¶ster
      showCloseButton: true, // Kapatma butonu gÃ¶ster
      showConfirmButton: true, // "Tamam" butonu gÃ¶sterme
      timer: undefined, // Otomatik kapanma kapalÄ±
      toast: false, // Toast modu kapalÄ±
      allowOutsideClick: true, // DÄ±ÅŸarÄ±ya tÄ±klayÄ±nca kapanmasÄ±na izin ver
      allowEscapeKey: true, // ESC tuÅŸuyla kapanmasÄ±na izin ver

      width: '55em',              // Kutuyu geniÅŸletir
      scrollbarPadding: false,    // Sayfa kaymasÄ±nÄ± Ã¶nler
      heightAuto: false,

      // YENÄ° EKLENEN customClass Ã–ZELLÄ°KLERÄ°
      customClass: {
        popup: 'swal2-green-theme-popup', // TÃ¼m kutu iÃ§in
        header: 'swal2-green-theme-header', // BaÅŸlÄ±k alanÄ± iÃ§in
        title: 'swal2-green-theme-title', // BaÅŸlÄ±k metni iÃ§in
        icon: 'swal2-green-theme-icon', // Ä°kon iÃ§in
        closeButton: 'swal2-green-theme-close-button', // Kapatma butonu iÃ§in
        htmlContainer: 'swal2-green-theme-html-container'
      }
    });
  }






  function toggleInvestmentIncomeInputs() {
    const karar = (document.getElementById('karar')?.value || "").trim();
    const yatirimTuru = (document.getElementById('yatirim_turu1')?.value || "").trim().toLowerCase();

    const yatirimKazanciInput = document.getElementById('yatirimdan_elde_edilen_kazanc');
    const tevsiKazanciInput = document.getElementById('tevsi_yatirim_kazanci');
    const toplamSabitInput = document.getElementById('toplam_sabit_kiymet_tutari');
    const gerceklesenTevsiInput = document.getElementById('gerceklesen_tevsi_yatirim_tutari');

    if (!yatirimKazanciInput || !tevsiKazanciInput) return;

    // ğŸ”´ Ã–nce HER ÅEYÄ° kapat
    const allInputs = [
      yatirimKazanciInput,
      tevsiKazanciInput,
      toplamSabitInput,
      gerceklesenTevsiInput
    ];

    allInputs.forEach(el => {
      if (!el) return;
      el.setAttribute("readonly", true);
      el.classList.add("disabled-input");

      const m = maskMap[el.id];
      if (m) m.updateOptions({ readonly: true });
    });

    // ğŸ’¡ YENÄ°: KullanÄ±cÄ± sadece "DiÄŸer Faaliyetler" seÃ§tiyse yatÄ±rÄ±m kazancÄ± giriÅŸini kapalÄ± tut
    const choice = sessionStorage.getItem("gelir_uygulama_tipi");
    if (choice === 'diger') {
      console.log("ğŸ”’ Sadece 'DiÄŸer Faaliyetler' seÃ§ili, yatÄ±rÄ±m kazancÄ± giriÅŸi pasif.");
      return; 
    }

    // ğŸŸ¥ 9903 â†’ TEVSÄ° YOK! SADECE yatÄ±rÄ±m kazancÄ± aÃ§Ä±k
    if (karar === "2025/9903") {
      yatirimKazanciInput.removeAttribute("readonly");
      yatirimKazanciInput.classList.remove("disabled-input");

      const m = maskMap["yatirimdan_elde_edilen_kazanc"];
      if (m) m.updateOptions({ readonly: false });

      return; // kesin blokaj â†’ tevsi asla Ã§alÄ±ÅŸmasÄ±n
    }

    // ğŸŸ¦ Klasik karar â†’ Tevsi tÃ¼rÃ¼nde Tevsi kazancÄ± aktif
    if (yatirimTuru === "tevsi") {
      // Tevsi kazancÄ± aktif
      tevsiKazanciInput.removeAttribute("readonly");
      tevsiKazanciInput.classList.remove("disabled-input");

      const m1 = maskMap["tevsi_yatirim_kazanci"];
      if (m1) m1.updateOptions({ readonly: false });

      // Tevsi girdileri aktif
      [toplamSabitInput, gerceklesenTevsiInput].forEach(el => {
        if (!el) return;
        el.removeAttribute("readonly");
        el.classList.remove("disabled-input");
        const m = maskMap[el.id];
        if (m) m.updateOptions({ readonly: false });
      });

      return;
    }

    // ğŸŸ© Klasik â†’ tevsi deÄŸil â†’ sadece yatÄ±rÄ±m kazancÄ± aÃ§Ä±k
    yatirimKazanciInput.removeAttribute("readonly");
    yatirimKazanciInput.classList.remove("disabled-input");

    const m3 = maskMap["yatirimdan_elde_edilen_kazanc"];
    if (m3) m3.updateOptions({ readonly: false });
  }





  function setBolge() {
    const karar = document.getElementById("karar")?.value;

    // 2025/9903 â†’ BÃ¶lge deÄŸiÅŸtirilmez
    if (karar === "2025/9903") {
      console.log("ğŸ“ 2025/9903 aktif â€” setBolge() pasif bÄ±rakÄ±ldÄ±.");
      return;
    }

    const ilSelect = document.getElementById("il");
    const bolgeInput = document.getElementById("bolge");
    if (!ilSelect || !bolgeInput) return;

    const il = ilSelect.value;
    const bolge = bolgeMap[il] ?? "";
    bolgeInput.value = bolge;
  }



  function setOranlar() {
    const karar = document.getElementById("karar")?.value;

    // ğŸ”¥ 1) 2025/9903 â†’ ORAN HESABI YOK, HESAP TETÄ°KLEME YOK
    if (karar === "2025/9903") {
      console.log("âšª setOranlar() 9903 modunda pasif.");
      return;
    }

    // Gerekli alanlar
    const bolgeInput = document.getElementById("bolge");
    const osbSelect = document.getElementById("osb");
    const vizeSelect = document.getElementById("vize_durumu");
    const donemSelect = document.getElementById("donem");

    if (!bolgeInput || !osbSelect || !vizeSelect || !donemSelect) return;

    const bolge = bolgeInput.value;
    const osb = osbSelect.value;
    const key = bolge + "|" + osb;

    const vize = vizeSelect.value;
    const donem = donemSelect.value;
    const donemYil = parseInt(donem.split(" - ")[0]);

    // ============================================================
    //   ğŸ“Œ 2) SADECE ORAN DEÄERLERÄ°NÄ° INPUTLARA YAZ (HESAP YOK!)
    // ============================================================

    // Yeniden deÄŸerleme oranÄ±
    const ydo = document.getElementById("yeniden_degerleme_orani");
    if (ydo) {
      if (vize.includes("HayÄ±r")) {
        ydo.value = "YATIRIM DÃ–NEMÄ°NDE OLDUÄUNUZ Ä°Ã‡Ä°N ENDEKSLEME YOK";
      } else {
        ydo.value = yenidenDegerlemeOranlari[donem] ?? "";
      }
    }

    // KatkÄ± oranÄ±
    const katkiEl = document.getElementById("katki_orani");
    const manualKatki = sessionStorage.getItem("manual_katki") === "true";
    const manualKatkiVal = sessionStorage.getItem("manual_katki_value");

    if (katkiEl) {
      if (manualKatki) {
        safeSet("katki_orani", manualKatkiVal);
      } else {
        let v = katkilar[key] ?? "";
        safeSet("katki_orani", v);
      }
    }

    // Vergi indirim oranÄ±
    const vergiEl = document.getElementById("vergi_orani");
    const manualVergi = sessionStorage.getItem("manual_vergi") === "true";
    const manualVergiVal = sessionStorage.getItem("manual_vergi_value");

    if (vergiEl) {
      if (manualVergi) {
        safeSet("vergi_orani", manualVergiVal);
      } else {
        let v = (donemYil >= 2017 && donemYil <= 2022) ? 100 : (vergiler[key] ?? "");
        safeSet("vergi_orani", v);
      }
    }

    // DiÄŸer kazanÃ§ oranÄ±
    const digerEl = document.getElementById("diger_oran");
    if (digerEl) {
      if (vize.includes("Evet")) {
        safeSet("diger_oran", 0);
      } else {
        safeSet("diger_oran", (donemYil >= 2017 && donemYil <= 2022) ? 100 : 80);
      }
    }

    // Sol bilgi paneli gÃ¼ncelle
    updateDiscountedRatesUI();

    // ============================================================
    //   ğŸ“Œ 3) HesaplamalarÄ± sadece Step 3 veya Step 4 aktifse Ã§alÄ±ÅŸtÄ±r
    // ============================================================

    const step3Active = !document.getElementById("step3")?.classList.contains("hidden-step");
    const step4Active = !document.getElementById("step4")?.classList.contains("hidden-step");

    if (step3Active) {
      hesaplaKatkiTutari();
      hesaplaDigerKatkiTutari();
      hesaplaFiiliKatkiTutari();
    }

    if (step4Active) {
      hesaplaOncekiKatkiTutari();
      hesaplaKalanVeEndeks();
    }
  }

  window.handleKarar9903 = function () {

    const kararSelect = document.getElementById("karar");
    const programSelect = document.getElementById("program_turu");
    const ilSelect = document.getElementById("il");
    const osbSelect = document.getElementById("osb");
    const bolgeInput = document.getElementById("bolge");

    const katkiInput = document.getElementById("katki_orani");
    const vergiInput = document.getElementById("vergi_orani");
    const digerInput = document.getElementById("diger_oran");

    const tur1 = document.getElementById("yatirim_turu1");
    const tur2 = document.getElementById("yatirim_turu2");

    if (!kararSelect) return;

    const karar = kararSelect.value;

    const makeSelectReadonly = (sel) => {
      if (!sel) return;
      sel.dataset.readonly = "1";
      sel.addEventListener("mousedown", e => {
        if (sel.dataset.readonly === "1") e.preventDefault();
      });
      sel.style.pointerEvents = "none";
      sel.classList.add("bg-light");
    };

    const makeSelectWritable = (sel) => {
      if (!sel) return;
      sel.dataset.readonly = "0";
      sel.style.pointerEvents = "auto";
      sel.classList.remove("bg-light");
    };

    // ======================================================
    //            2025 / 9903  Ã–ZEL MODU
    // ======================================================
    if (karar === "2025/9903") {

      console.log("â†’ 2025/9903 modu aktif!");

      makeSelectReadonly(ilSelect);
      makeSelectReadonly(osbSelect);

      if (bolgeInput) {
        bolgeInput.readOnly = true;
        bolgeInput.classList.add("bg-light");
        bolgeInput.value = "0";   // gerÃ§ek bÃ¶lge deÄŸeri
      }

      programSelect.readOnly = false;
      programSelect.style.pointerEvents = "auto";
      programSelect.classList.remove("bg-light");

      // tur1 ve tur2 (YatÄ±rÄ±m TÃ¼rleri) kilitli olsun (Sadece Program TÃ¼rÃ¼ aktif)
      [tur1, tur2].forEach(el => {
          if (!el) return;
          el.readOnly = true;
          el.style.pointerEvents = "none";
          el.classList.add("bg-light");
          el.value = ""; // SeÃ§imi temizle
      });

      safeSet("vergi_orani", 60);
      safeSet("diger_oran", 50);

      const program = programSelect.value;
      if (katkilar9903) {
        safeSet("katki_orani", katkilar9903[program] || 0);
      }

      toggleInvestmentIncomeInputs();
      return;
    }

    // ======================================================
    //            KLASÄ°K TEÅVÄ°K MODU
    // ======================================================
    console.log("â†’ Normal teÅŸvik modu aktif");

    // 9903 iÃ§in Ã¶zel kutuyu gizle
    const infoBox9903 = document.getElementById("info-9903-limits");
    if (infoBox9903) infoBox9903.style.display = "none";

    makeSelectWritable(ilSelect);
    makeSelectWritable(osbSelect);

    if (bolgeInput) {
      bolgeInput.readOnly = false;
      bolgeInput.classList.remove("bg-light");
    }

    // Program tÃ¼rÃ¼ kilit
    programSelect.readOnly = true;
    programSelect.style.pointerEvents = "none";
    programSelect.classList.add("bg-light");

    [tur1, tur2].forEach(el => {
      if (!el) return;
      el.readOnly = false;
      el.style.pointerEvents = "auto";
      el.classList.remove("bg-light");
    });

    safeSet("katki_orani", 0);
    safeSet("vergi_orani", 0);
    safeSet("diger_oran", 0);

    if (typeof setBolge === 'function') setBolge();
    if (typeof setOranlar === 'function') setOranlar();

    toggleInvestmentIncomeInputs();
  };





  function updateProgress(step) {
    const currentStageText = document.getElementById("current-stage-text");
    if (currentStageText) currentStageText.textContent = step;

    // Modern Stepper GÃ¼ncelle
    for (let i = 1; i <= 7; i++) {
      const item = document.getElementById(`step-i-${i}`);
      if (!item) continue;

      item.classList.remove("active", "completed");
      if (i === step) {
        item.classList.add("active");
      } else if (i < step) {
        item.classList.add("completed");
      }
    }
  }


  function _updateStepDisplay(stepNum) {

    // 1) Step gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ yÃ¶netimi
    ALL_STEPS_IDS.forEach((id, idx) => {
      const el = document.getElementById(id);
      if (!el) return;

      if (idx + 1 === stepNum) el.classList.remove("hidden-step");
      else el.classList.add("hidden-step");
    });

    // 2) Progress bar gÃ¼ncelle
    updateProgress(stepNum);

    // 3) Son step kaydÄ± (geri dÃ¶nÃ¼ÅŸte restore iÃ§in)
    sessionStorage.setItem('last_step', stepNum);

    const karar = document.getElementById("karar")?.value || "";

    // ======================================================
    //   STEP-BASED TRIGGERLAR â€” 9903 KONTROLÃœ EKLENDÄ°
    // ======================================================

    // ---- STEP 2: BÃ¶lge ve oranlar (9903 DEÄÄ°LSE!)
    if (stepNum === 2) {
      if (karar !== "2025/9903") {
        setBolge();
        setOranlar();
      }
    }

    // ---- STEP 5: YatÄ±rÄ±m giriÅŸi pasiflik kontrolÃ¼
    if (stepNum === 5) {
      if (typeof toggleInvestmentIncomeInputs === 'function') {
          toggleInvestmentIncomeInputs();
      }
    }

    // ---- STEP 4: Ã–nceki katkÄ± + endeks hesaplamalarÄ±
    if (stepNum === 4) {
      hesaplaOncekiKatkiTutari();
      hesaplaKalanVeEndeks();
    }

    // ---- STEP 6: Detailed Profit toggle, hidden input eÅŸitleme
    if (stepNum === 6) {

      // IMask + deÄŸerler hazÄ±rlandÄ±ktan sonra Ã§aÄŸÄ±r
      setTimeout(() => {
        if (typeof toggleDetailedProfitInput === "function") {
          toggleDetailedProfitInput();
        }
      }, 50);

      const belgeNoInput = document.querySelector('input[name="belge_no"]');
      const belgeTarihiInput = document.querySelector('input[name="belge_tarihi"]');
      const bolgeInput = document.getElementById('bolge');

      const h1 = document.querySelector('input[name="belge_no_hidden"]');
      if (h1 && belgeNoInput) h1.value = belgeNoInput.value;

      const h2 = document.querySelector('input[name="belge_tarihi_hidden"]');
      if (h2 && belgeTarihiInput) h2.value = belgeTarihiInput.value;

      const h3 = document.getElementById('bolge_hidden');
      if (h3 && bolgeInput) h3.value = bolgeInput.value;
    }

    // DeÄŸiÅŸik bilgi ikonlarÄ±nÄ± blink et (isteÄŸe baÄŸlÄ±)
    if (typeof blinkAllInfoIcons === "function") blinkAllInfoIcons();

    // Global CURRENT_STEP gÃ¼ncelle
    CURRENT_STEP = stepNum;
  }






  // updateDiscountedRatesUI(): Vergi indirim oranÄ±na gÃ¶re ihracat, imalat ve diÄŸer kazanÃ§lara ait indirimli KV oranlarÄ±nÄ± hesaplayÄ±p bilgi alanÄ±nda gÃ¶sterir.
  function updateDiscountedRatesUI() {
    const vergiOraniEl = document.getElementById("vergi_orani");
    const spanIhr = document.getElementById("ind_kv_ihr");
    const spanIml = document.getElementById("ind_kv_iml");
    const spanDig = document.getElementById("ind_kv_dig");
    if (!vergiOraniEl || !spanIhr || !spanIml || !spanDig) return;

    const p = parseFormattedNumber(vergiOraniEl.value) / 100; // 0..1
    if (isNaN(p)) {
      spanIhr.textContent = "â€”";
      spanIml.textContent = "â€”";
      spanDig.textContent = "â€”";
      return;
    }
    const rIhr = 0.20 - (0.20 * p);
    const rIml = 0.24 - (0.24 * p);
    const rDig = 0.25 - (0.25 * p);

    const fmtPct = (x) => (x * 100).toFixed(2).replace('.', ',') + '%';
    spanIhr.textContent = fmtPct(rIhr);
    spanIml.textContent = fmtPct(rIml);
    spanDig.textContent = fmtPct(rDig);
  }



  function calculateRatios() {
    const useDetailedCheckbox = document.getElementById("useDetailedProfitRatios");
    const useDetailed = useDetailedCheckbox ? useDetailedCheckbox.checked : false;
    const brutInput = document.getElementById("brut_satis");
    const ihracatInput = document.getElementById("ihracat");
    const imalatInput = document.getElementById("imalat");
    const digerFaaliyetInput = document.getElementById("diger_faaliyet");
    const spanIhr = document.getElementById("ratio_ihracat");
    const spanIml = document.getElementById("ratio_imalat");
    const spanDig = document.getElementById("ratio_diger");
    if (!brutInput || !ihracatInput || !imalatInput || !digerFaaliyetInput || !spanIhr || !spanIml || !spanDig) return;
    if (useDetailed) {
      const savedC54 = sessionStorage.getItem('ayrintili_C54');
      const savedD54 = sessionStorage.getItem('ayrintili_D54');
      const savedE54 = sessionStorage.getItem('ayrintili_E54');
      if (savedC54 !== null && savedD54 !== null && savedE54 !== null) {
        spanIhr.textContent = savedC54;
        spanIml.textContent = savedD54;
        spanDig.textContent = savedE54;
      } else {
        spanIhr.textContent = initialRatios.C;
        spanIml.textContent = initialRatios.D;
        spanDig.textContent = initialRatios.E;
      }
    } else {
      const brut = getVal("brut_satis");
      const ihracat = getVal("ihracat");
      const imalat = getVal("imalat");
      const diger = getVal("diger_faaliyet");
      let pctIhr = 0,
        pctIml = 0,
        pctDig = 0;
      if (brut > 0) {
        pctIhr = (ihracat / brut) * 100;
        pctIml = (imalat / brut) * 100;
        pctDig = (diger / brut) * 100;
      }
      spanIhr.textContent = brut ? pctIhr.toFixed(2).replace(".", ",") + "%" : "â€”%";
      spanIml.textContent = brut ? pctIml.toFixed(2).replace(".", ",") + "%" : "â€”%";
      spanDig.textContent = brut ? pctDig.toFixed(2).replace(".", ",") + "%" : "â€”%";
    }
    const ayrTable = document.getElementById('ayrintili-kazanc-table');
    if (ayrTable) {
      const updateCell = (rowIndex, col, text) => {
        const selector = `#ayrintili-kazanc-table tbody tr:nth-child(${rowIndex + 1}) input[name="${col}_${rowIndex}"]`;
        const inp = document.querySelector(selector);
        if (inp && inp.readOnly) {
          isProgrammaticChange = true;
          inp.value = text;
          isProgrammaticChange = false;
        }
      };
      updateCell(0, "B", "100%");
      updateCell(0, "C", spanIhr.textContent);
      updateCell(0, "D", spanIml.textContent);
      updateCell(0, "E", spanDig.textContent);
      const b53Input = document.querySelector(`input[name="B_53"]`);
      if (b53Input) {
        const C53 = parseFormattedNumber(document.querySelector(`input[name="C_53"]`).value) || 0;
        const D53 = parseFormattedNumber(document.querySelector(`input[name="D_53"]`).value) || 0;
        const E53 = parseFormattedNumber(document.querySelector(`input[name="E_53"]`).value) || 0;
        const B53 = parseFormattedNumber(b53Input.value) || 0;
        let pct2C = 0,
          pct2D = 0,
          pct2E = 0;
        if (B53 > 0) {
          pct2C = (C53 / B53) * 100;
          pct2D = (D53 / B53) * 100;
          pct2E = (E53 / B53) * 100;
        }
        updateCell(54, "B", "100%");
        updateCell(54, "C", pct2C.toFixed(2).replace(".", ",") + "%");
        updateCell(54, "D", pct2D.toFixed(2).replace(".", ",") + "%");
        updateCell(54, "E", pct2E.toFixed(2).replace(".", ",") + "%");
      }
    }
  }




  // --- AyrÄ±ntÄ±lÄ± KazanÃ§ Tablosu HesaplamasÄ± ---
  function calculateTable(event) {
    const ayrTable = document.getElementById('ayrintili-kazanc-table');
    if (!ayrTable) return;

    const tableData = [];
    ayrTable.querySelectorAll('tbody tr').forEach((rowEl, rowIndex) => {
      const rowVals = {};
      rowEl.querySelectorAll('input').forEach(input => {
        const [col] = input.name.split('_');
        rowVals[col] = parseFormattedNumber(input.value);
      });
      tableData[rowIndex] = rowVals;
    });

    if (event && event.target) {
      const [col, rowStr] = event.target.name.split('_');
      const rowIdx = parseInt(rowStr, 10);
      if ((rowIdx === 20 || rowIdx === 21) && col === 'B') {
        const b = tableData[rowIdx].B;
        const pctC = tableData[0].C / 100;
        const pctD = tableData[0].D / 100;
        const pctE = tableData[0].E / 100;
        ['C', 'D', 'E'].forEach((c, i) => {
          const v = b * [pctC, pctD, pctE][i];
          tableData[rowIdx][c] = v;
          // Programatik atamada sonsuz dÃ¶ngÃ¼yÃ¼ Ã¶nleyin
          const inp = document.querySelector(`input[name="${c}_${rowIdx}"]`);
          if (inp) {
            isProgrammaticChange = true; // BayraÄŸÄ± ayarla
            inp.value = v.toLocaleString('tr-TR', {
              minimumFractionDigits: 2
            });
            isProgrammaticChange = false; // BayraÄŸÄ± sÄ±fÄ±rla
          }
        });
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(saveDetailedProfitData, 1500);
        return;
      }
    }

    for (let i = 2; i <= 4; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[1][col] = tableData[2][col] + tableData[3][col] + tableData[4][col];
    });
    const toplamH = tableData[1].B;

    if (toplamH > 0) {
      tableData[0].B = 100;
      ['C', 'D', 'E'].forEach(col => {
        tableData[0][col] = parseFloat(((tableData[1][col] / toplamH) * 100).toFixed(2));
      });
    } else {
      tableData[0] = {
        B: 100,
        C: 0,
        D: 0,
        E: 0
      };
    }

    for (let i = 6; i <= 8; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[5][col] = tableData[6][col] + tableData[7][col] + tableData[8][col];
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[9][col] = tableData[1][col] - tableData[5][col];
    });

    for (let i = 11; i <= 14; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[10][col] =
        tableData[11][col] +
        tableData[12][col] +
        tableData[13][col] +
        tableData[14][col];
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[15][col] = tableData[9][col] - tableData[10][col];
    });

    for (let i = 17; i <= 19; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[16][col] = tableData[17][col] + tableData[18][col] + tableData[19][col];
    });

    [20, 21].forEach(r => {
      const b = tableData[r].B;
      tableData[r].C = b * (tableData[0].C / 100);
      tableData[r].D = b * (tableData[0].D / 100);
      tableData[r].E = b * (tableData[0].E / 100);
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[16][col] =
        tableData[17][col] +
        tableData[18][col] +
        tableData[19][col] +
        tableData[20][col] +
        tableData[21][col];
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[22][col] = tableData[15][col] - tableData[16][col];
    });

    for (let i = 24; i <= 33; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      let sum = 0;
      for (let i = 24; i <= 33; i++) sum += tableData[i][col];
      tableData[23][col] = sum;
    });

    for (let i = 35; i <= 41; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      let sum = 0;
      for (let i = 35; i <= 41; i++) sum += tableData[i][col];
      tableData[34][col] = sum;
    });

    for (let i = 43; i <= 44; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[42][col] = tableData[43][col] + tableData[44][col];
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[45][col] =
        tableData[22][col] +
        tableData[23][col] -
        tableData[34][col] -
        tableData[42][col];
    });

    for (let i = 47; i <= 48; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[46][col] = tableData[47][col] + tableData[48][col];
    });

    for (let i = 50; i <= 52; i++) {
      tableData[i].B = tableData[i].C + tableData[i].D + tableData[i].E;
    }
    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[49][col] = tableData[50][col] + tableData[51][col] + tableData[52][col];
    });

    ['B', 'C', 'D', 'E'].forEach(col => {
      tableData[53][col] =
        tableData[45][col] +
        tableData[46][col] -
        tableData[49][col];
    });

    const B53 = tableData[53].B,
      C53 = tableData[53].C,
      D53 = tableData[53].D,
      E53 = tableData[53].E;
    let pct2C = 0,
      pct2D = 0,
      pct2E = 0;
    if (B53 > 0) {
      pct2C = (C53 / B53) * 100;
      pct2D = (D53 / B53) * 100;
      pct2E = (E53 / B53) * 100;
    }
    tableData[54].B = 100;
    tableData[54].C = parseFloat(pct2C.toFixed(2));
    tableData[54].D = parseFloat(pct2D.toFixed(2));
    tableData[54].E = parseFloat(pct2E.toFixed(2));

    ayrTable.querySelectorAll('tbody tr').forEach((rowEl, idx) => {
      rowEl.querySelectorAll('input').forEach(input => {
        const [col] = input.name.split('_');
        if (input.readOnly) {
          // isProgrammaticChange bayraÄŸÄ±nÄ± kullanarak sonsuz dÃ¶ngÃ¼yÃ¼ Ã¶nleyin
          isProgrammaticChange = true;
          let v = tableData[idx][col];
          if (idx === 0 || idx === 54) {
            v = v.toFixed(2).replace('.', ',') + '%';
            if (col === 'B') v = '100%';
          } else {
            v = v.toLocaleString('tr-TR', {
              minimumFractionDigits: 2
            });
          }
          input.value = v; // DeÄŸer atamasÄ±
          isProgrammaticChange = false; // BayraÄŸÄ± sÄ±fÄ±rla
        }
      });
    });

    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(saveDetailedProfitData, 1500);
  }


  // AyrÄ±ntÄ±lÄ± kazanÃ§ tablosunu sunucuya kaydetmek iÃ§in AJAX fonksiyonu
  async function saveDetailedProfitData() {
    const ayrTable = document.getElementById('ayrintili-kazanc-table');
    if (!ayrTable) {
      return;
    }
    const formData = new FormData();
    let dataChanged = false;
    ayrTable.querySelectorAll('tbody tr').forEach((rowEl) => {
      rowEl.querySelectorAll('input').forEach(input => {
        if (!input.readOnly) {
          const originalValue = input.getAttribute('data-original-value');
          const currentValue = input.value;
          if (originalValue !== currentValue) {
            formData.append(input.name, currentValue);
            dataChanged = true;
          }
        }
      });
    });
    if (!dataChanged) {
      return;
    }
    try {
      const response = await fetch("{{ url_for('indirimlikurumlar.ayrintili_kazanc') }}", {
        method: "POST",
        body: formData
      });
      if (response.ok) {
        ayrTable.querySelectorAll('tbody input').forEach(input => {
          input.setAttribute('data-original-value', input.value);
        });
        updateSessionStorageRatios();
      } else {
        console.error("Otomatik kaydetme baÅŸarÄ±sÄ±z oldu:", response.status, response.statusText);
      }
    } catch (error) {
      console.error("Otomatik kaydetme sÄ±rasÄ±nda hata oluÅŸtu:", error);
    }
  }

  function updateSessionStorageRatios() {
    const ayrTable = document.getElementById('ayrintili-kazanc-table');
    if (!ayrTable) {
      return;
    }
    const C54_input = ayrTable.querySelector('input[name="C_54"]');
    const D54_input = ayrTable.querySelector('input[name="D_54"]');
    const E54_input = ayrTable.querySelector('input[name="E_54"]');
    if (C54_input && D54_input && E54_input) {
      sessionStorage.setItem('ayrintili_C54', C54_input.value);
      sessionStorage.setItem('ayrintili_D54', D54_input.value);
      sessionStorage.setItem('ayrintili_E54', E54_input.value);
    }
  }

  function toggleDetailedProfitInput() {
    const useDetailedCheckbox = document.getElementById("useDetailedProfitRatios");
    if (!useDetailedCheckbox) return;
    const useDetailed = useDetailedCheckbox.checked;
    const brutInput = document.getElementById("brut_satis");
    const ihracatInput = document.getElementById("ihracat");
    const imalatInput = document.getElementById("imalat");
    const digerFaaliyetInput = document.getElementById("diger_faaliyet");
    if (!brutInput || !ihracatInput || !imalatInput || !digerFaaliyetInput) return;
    if (useDetailed) {
      brutInput.setAttribute('readonly', true);
      ihracatInput.setAttribute('readonly', true);
      imalatInput.setAttribute('readonly', true);
      digerFaaliyetInput.setAttribute('readonly', true);
      brutInput.value = '';
      ihracatInput.value = '';
      imalatInput.value = '';
      digerFaaliyetInput.value = '';
      calculateRatios();
    } else {
      brutInput.removeAttribute('readonly');
      ihracatInput.removeAttribute('readonly');
      imalatInput.removeAttribute('readonly');
      digerFaaliyetInput.removeAttribute('readonly');
      calculateRatios();
    }
  }

  function clearProfitTable() {
    Swal.fire({
      title: "Emin misiniz?",
      text: "TÃ¼m ayrÄ±ntÄ±lÄ± kazanÃ§ verilerini silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Evet, sil!",
      cancelButtonText: "Ä°ptal"
    }).then((result) => {
      if (result.isConfirmed) {
        const ayrTable = document.getElementById('ayrintili-kazanc-table');
        if (ayrTable) {
          // input deÄŸerlerini temizle
          ayrTable.querySelectorAll('tbody input').forEach(input => {
            if (!input.readOnly) {
              isProgrammaticChange = true;
              input.value = '';
              input.setAttribute('data-original-value', '');
              isProgrammaticChange = false;
            }
          });
          // Session Storage'Ä± temizle
          sessionStorage.removeItem('ayrintili_C54');
          sessionStorage.removeItem('ayrintili_D54');
          sessionStorage.removeItem('ayrintili_E54');

          // VeritabanÄ±ndan temizlemek iÃ§in AJAX isteÄŸi gÃ¶nder
          // Bu Ã¶rnekte, Python tarafÄ±ndan Ã¶zel bir 'temizle' endpoint'i olmadÄ±ÄŸÄ±nÄ± varsayÄ±yorum.
          // EÄŸer Flask'ta bir 'temizle' endpoint'i varsa, onu burada Ã§aÄŸÄ±rÄ±rdÄ±k.
          // Åimdilik sadece frontend'i temizledik ve bir mesaj gÃ¶sterdik.
          showSwalMessage("success", "Temizlendi!", "AyrÄ±ntÄ±lÄ± kazanÃ§ verileri temizlendi.");
          calculateTable(); // Tabloyu yeniden hesapla ve boÅŸ deÄŸerleri gÃ¶ster
        }
      }
    });
  }




  function fillFormWithParsedData(data) {
    const map = {
      belge_no: 'belge_no',
      karar: 'karar',
      baslama_tarihi: 'belge_tarihi',   // parser 'baslama_tarihi' dÃ¶ndÃ¼rÃ¼yorsa
      belge_tarihi: 'belge_tarihi',     // parser 'belge_tarihi' dÃ¶ndÃ¼rÃ¼yorsa
      yatirim_turu1: 'yatirim_turu1',
      yatirim_turu2: 'yatirim_turu2',
      bolge: 'bolge',

      // oran ve tutarlar
      katki_orani: 'katki_orani',
      vergi_orani: 'vergi_orani',
      ikv_orani: 'diger_oran',
      diger_oran: 'diger_oran',

      toplam_tutar: 'toplam_tutar',
      katki_tutari: 'katki_tutari',
      diger_katki_tutari: 'diger_katki_tutari',
      cari_harcama_tutari: 'cari_harcama_tutari',
      toplam_harcama_tutari: 'toplam_harcama_tutari',
      fiili_katki_tutari: 'fiili_katki_tutari',
      endeks_katki_tutari: 'endeks_katki_tutari',

      onceki_yatirim_katki_tutari: 'onceki_yatirim_katki_tutari',
      onceki_diger_katki_tutari: 'onceki_diger_katki_tutari',
      onceki_katki_tutari: 'onceki_katki_tutari',

      // cari alanlar
      cari_yatirim_katki: 'cari_yatirim_katki',
      cari_diger_katki: 'cari_diger_katki',
      cari_toplam_katki: 'cari_toplam_katki',
      genel_toplam_katki: 'genel_toplam_katki'
    };

    Object.entries(map).forEach(([src, destName]) => {
      const el = document.querySelector(`[name="${destName}"]`);
      if (!el) return;
      const val = data[src];
      const v = (el.type === 'date')
        ? convertToInputDateFormat(val || '')
        : (val ?? '');
      el.value = v;

      // â• PDFâ€™den geleni kalÄ±cÄ±laÅŸtÄ±r
      sessionStorage.setItem(`form_${destName}`, v);
    });

    // BÃ¶lge gizli alanÄ±
    const b = document.getElementById('bolge');
    if (b) {
      b.dispatchEvent(new Event('change'));
      const bh = document.getElementById('bolge_hidden');
      if (bh) {
        bh.value = b.value;
        sessionStorage.setItem('form_bolge', b.value);
        sessionStorage.setItem('form_bolge_hidden', b.value);
      }
    }

    // KaldÄ±ÄŸÄ±n adÄ±mÄ± da kaydet (Ã¶r: otomatik Step 2â€™ye geÃ§eceksen)
    sessionStorage.setItem('last_step', '2');

    if (typeof goToStep2 === 'function') goToStep2();
  }


  // PDF yÃ¼kleme ve parse iÅŸlemi: KullanÄ±cÄ±nÄ±n seÃ§tiÄŸi KV beyannamesi PDF'ini backend'e gÃ¶nderir,
  // gelen verileri kontrol eder ve uygun form alanlarÄ±na otomatik olarak doldurur.
  // Ã‡oklu belge varsa seÃ§im yaptÄ±rÄ±r, hata veya eksik durumlarÄ±nda uyarÄ± gÃ¶sterir.
  async function handleKVUpload(ev) {
    const file = ev.target.files?.[0];
    if (!file) return;

    // aynÄ± dosyayÄ± tekrar seÃ§ebilin
    ev.target.value = '';

    const fd = new FormData();
    fd.append('kv_pdf', file);

    // 1) Loading
    Swal.fire({
      title: 'YÃ¼kleniyor...',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    let resp;
    try {
      // (opsiyonel) timeout
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), 20000);

      const r = await fetch('{{ url_for("indirimlikurumlar.upload_kv_beyan") }}', {
        method: 'POST',
        body: fd,
        signal: ctrl.signal
      });

      clearTimeout(t);

      const ct = r.headers.get('content-type') || '';
      if (!ct.includes('application/json')) {
        const text = await r.text();
        throw new Error('Beklenmeyen yanÄ±t: ' + ct + ' / ' + text.slice(0, 200));
      }

      resp = await r.json();
    } catch (e) {
      Swal.close();
      Swal.fire('Hata', 'PDF yÃ¼klenirken aÄŸ/yanÄ±t hatasÄ± oluÅŸtu.', 'error');
      return;
    } finally {
      Swal.close();
    }

    console.log('KV upload resp:', resp);

    // 2) Mutlu yollar
    if (resp?.status === 'ok' && resp?.parsed) {
      fillFormWithParsedData(resp.parsed);
      await Swal.fire('Tamam', 'PDFâ€™den bilgiler aktarÄ±ldÄ±.', 'success');
      return;
    }

    if (resp.status === 'multiple' && Array.isArray(resp.raw_data) && resp.raw_data.length) {
      // SeÃ§enekleri hazÄ±rla
      const inputOptions = {};
      resp.raw_data.forEach((item, i) => {
        const no = (item.belge_no || `Belge ${i + 1}`).toString().trim();
        const karar = item.karar ? ` â€¢ ${item.karar}` : '';
        const tarih = item.belge_tarihi ? ` â€¢ ${item.belge_tarihi}` : '';
        inputOptions[i] = `${no}${karar}${tarih}`;
      });

      // KullanÄ±cÄ±ya sor
      const { value: idx } = await Swal.fire({
        title: 'Hangi teÅŸvik belgesini iÃ§e aktarmak istersiniz?',
        input: 'select',
        inputOptions,
        inputPlaceholder: 'SeÃ§iniz',
        showCancelButton: true,
        confirmButtonText: 'SeÃ§',
        cancelButtonText: 'Ä°ptal'
      });

      if (idx !== undefined) {
        fillFormWithParsedData(resp.raw_data[Number(idx)]);
        Swal.fire('Tamam', 'PDFâ€™den bilgiler aktarÄ±ldÄ±.', 'success');
      }
      return;
    }


    // 3) Ã–zel: KV sayfasÄ±/tablosu bulunamadÄ± senaryosu
    if (
      resp.status === 'not_found' ||     // backend bÃ¶yle dÃ¶nÃ¼yorsa
      resp.status === 'no_kv' ||     // â€¦veya bu
      resp.status === 'empty' ||     // â€¦veya bu
      (resp.status === 'multiple' && (!resp.raw_data || !resp.raw_data.length || !resp.tablolar || !resp.tablolar.length)) ||
      (resp.status === 'ok' && !resp.parsed)
    ) {
      Swal.fire('BulunamadÄ±', 'YÃ¼klediÄŸiniz PDFâ€™de â€œÄ°ndirimli Kurumlarâ€ bÃ¶lÃ¼mÃ¼ tespit edilemedi.', 'warning');
      return;
    }

    // 4) DiÄŸer tÃ¼m hatalar
    Swal.fire('Hata', resp.message || 'PDF verisi iÅŸlenemedi.', 'error');

  }








  function hesaplaKatkiTutari9903({ advance = false } = {}) {
    const karar = document.getElementById("karar")?.value;
    if (karar !== "2025/9903") return;

    console.log("ğŸ”¹ hesaplaKatkiTutari9903() [GÃœNCELLENMÄ°Å] BAÅLADI");

    const safe = (x) => (isNaN(x) ? 0 : x);
    const val = (id) => safe(getVal(id));

    // 1ï¸âƒ£ Temel Girdiler
    const toplamYatirim = val("toplam_tutar");
    const harcamaYatirim = val("toplam_harcama_tutari");
    const katkiOraniInput = val("katki_orani");
    const vergiIndirimOraniInput = val("vergi_orani");
    const digerOranInput = val("diger_oran");
    
    // OranlarÄ± 0-1 aralÄ±ÄŸÄ±na Ã§ek
    const katkiOrani = val("katki_orani") / 100;
    const vergiIndirimOrani = val("vergi_orani") / 100;
    const digerOranBudgetOrani = val("diger_oran") / 100;

    const oncekiYatirimKatkisi = val("onceki_yatirim_katki_tutari");
    const oncekiDigerKatkisi = val("onceki_diger_katki_tutari");
    const oncekiToplamKatki = oncekiYatirimKatkisi + oncekiDigerKatkisi;

    // 2ï¸âƒ£ KatkÄ± HavuzlarÄ±
    const toplamKatkiPotansiyeli = toplamYatirim * katkiOrani;
    const hakEdilenKatkiBirikmis = harcamaYatirim * katkiOrani;
    
    // DiÄŸer faaliyetler iÃ§in "BÃ¼tÃ§e": (Toplam * %50) - Daha Ã¶nce kullanÄ±lan
    const digerFaaliyetButcesi = (toplamKatkiPotansiyeli * digerOranBudgetOrani) - oncekiDigerKatkisi;
    
    // KullanÄ±labilir toplam "Hak Edilen" bakiyesi: BirikmiÅŸ - Toplam KullanÄ±lan
    const kullanilabilirHakEdilenBakiye = Math.max(0, hakEdilenKatkiBirikmis - oncekiToplamKatki);

    // 3ï¸âƒ£ KazanÃ§lar ve Zaman SÄ±nÄ±rÄ±
    const donemYil = parseInt((document.getElementById("donem")?.value || "").split(" - ")[0]) || 0;
    const baslangicYil = parseInt(document.getElementById("baslangic_yili")?.value || "0");
    const donemFarki = (baslangicYil && donemYil) ? (donemYil - baslangicYil) : 0;

    let yatirimKazanci = 0;
    if (getVal("yatirimdan_elde_edilen_kazanc") > 0) {
      yatirimKazanci = val("yatirimdan_elde_edilen_kazanc");
    } else if (getVal("tevsi_yatirim_kazanci") > 0) {
      yatirimKazanci = val("tevsi_yatirim_kazanci");
    }

    const kvMatrah = val("kv_matrah");
    const gelirTipi = sessionStorage.getItem("gelir_uygulama_tipi"); // 'yatirim', 'diger', 'karma'
    let digerFaaliyetKazanci = (gelirTipi === "yatirim") ? 0 : kvMatrah;

    // 4ï¸âƒ£ Vergi FarklarÄ± (KV OranÄ± - Ä°ndirimli Oran)
    const kvOranIhracat = safe(val("kv_oran_ihracat") / 100) || 0.20;
    const kvOranImalat = safe(val("kv_oran_imalat") / 100) || 0.24;
    const kvOranDiger = safe(val("kv_oran_diger") / 100) || 0.25;

    const farkIhr = kvOranIhracat * vergiIndirimOrani;
    const farkIml = kvOranImalat * vergiIndirimOrani;
    const farkDig = kvOranDiger * vergiIndirimOrani;

    // 5ï¸âƒ£ SatÄ±ÅŸ OranlarÄ±
    const useDetailedRatios = document.getElementById("useDetailedProfitRatios")?.checked || false;
    let ihrOran = 0, imlOran = 0, digOran = 0;

    if (useDetailedRatios) {
      ihrOran = safe(parseFloat(document.getElementById("ratio_ihracat")?.textContent.replace("%", "").replace(",", "."))) / 100;
      imlOran = safe(parseFloat(document.getElementById("ratio_imalat")?.textContent.replace("%", "").replace(",", "."))) / 100;
      digOran = safe(parseFloat(document.getElementById("ratio_diger")?.textContent.replace("%", "").replace(",", "."))) / 100;
    } else {
      const brut = val("brut_satis");
      if (brut > 0) {
        ihrOran = val("ihracat") / brut;
        imlOran = val("imalat") / brut;
        digOran = val("diger_faaliyet") / brut;
      } else { digOran = 1; }
    }

    // 6ï¸âƒ£ HESAPLAMA: YatÄ±rÄ±m KazancÄ± TarafÄ± (10 YÄ±l SÄ±nÄ±rÄ±)
    let cariYatirimKatkisi = 0;
    if (yatirimKazanci > 0 && donemFarki < 10) {
      // YatÄ±rÄ±m kazancÄ± katkÄ±sÄ± iÃ§in birikmiÅŸ harcama (hak edilen) sÄ±nÄ±rÄ± var mÄ±? 
      // Mevzuat "on yÄ±llÄ±k sÃ¼reyle sÄ±nÄ±rlÄ± kaydÄ±yla hak kazanÄ±lan katki tutarÄ±na ulaÅŸÄ±lÄ±ncaya kadar" diyor.
      const potansiyelYatirimKatkisi = yatirimKazanci * (ihrOran * farkIhr + imlOran * farkIml + digOran * farkDig);
      cariYatirimKatkisi = Math.min(potansiyelYatirimKatkisi, kullanilabilirHakEdilenBakiye);
    }

    // 7ï¸âƒ£ HESAPLAMA: DiÄŸer Faaliyet KazancÄ± TarafÄ± (4 YÄ±l SÄ±nÄ±rÄ±)
    let cariDigerKatkisi = 0;
    if (digerFaaliyetKazanci > 0 && donemFarki < 4) {
      // Kalan Hak Edilen Bakiye (YatÄ±rÄ±m katkÄ±sÄ± dÃ¼ÅŸÃ¼ldÃ¼kten sonra)
      const bakiyeSonraYatirim = Math.max(0, kullanilabilirHakEdilenBakiye - cariYatirimKatkisi);
      
      // Ãœst SÄ±nÄ±r: min(BÃ¼tÃ§e, Kalan Hak Edilen)
      const azamiDigerKatkiLimit = Math.min(digerFaaliyetButcesi, bakiyeSonraYatirim);
      
      const potansiyelDigerKatkisi = digerFaaliyetKazanci * (ihrOran * farkIhr + imlOran * farkIml + digOran * farkDig);
      
      cariDigerKatkisi = Math.min(potansiyelDigerKatkisi, azamiDigerKatkiLimit);
    }

    // 8ï¸âƒ£ Final DeÄŸerler
    const cariToplamKatki = cariYatirimKatkisi + cariDigerKatkisi;
    const genelToplamKatki = oncekiToplamKatki + cariToplamKatki;
    const kalanKatkiTutari = Math.max(0, toplamKatkiPotansiyeli - genelToplamKatki);

    // 9ï¸âƒ£ UI SET
    safeSet("cari_yatirim_katki", cariYatirimKatkisi);
    safeSet("cari_diger_katki", cariDigerKatkisi);
    safeSet("cari_toplam_katki", cariToplamKatki);
    safeSet("genel_toplam_katki", genelToplamKatki);
    safeSet("kalan_katki_tutari", kalanKatkiTutari);
    
    // Alt Bilgi AlanlarÄ±
    safeSet("katki_tutari", toplamKatkiPotansiyeli);
    safeSet("diger_katki_tutari", (toplamKatkiPotansiyeli * digerOranBudgetOrani)); // Toplam BÃ¼tÃ§e (Statik)
    safeSet("fiili_katki_tutari", hakEdilenKatkiBirikmis); // Toplam Hak Edilen (Statik)

    // UI SET for Limits (2025/9903 specific feedback)
    const infoBox = document.getElementById("info-9903-limits");
    if (infoBox) {
      infoBox.style.display = "block";
      const fNum = (v) => v.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " TL";
      
      document.getElementById("span-limit1-9903").textContent = 
        fNum(toplamKatkiPotansiyeli * digerOranBudgetOrani) + " - KullanÄ±lan (" + fNum(oncekiDigerKatkisi) + ") = " + fNum(digerFaaliyetButcesi);
      
      const bakiyeSonraYatirim = Math.max(0, kullanilabilirHakEdilenBakiye - cariYatirimKatkisi);
      document.getElementById("span-limit2-9903").textContent = fNum(bakiyeSonraYatirim);
      document.getElementById("span-limit-used-9903").textContent = fNum(Math.min(digerFaaliyetButcesi, bakiyeSonraYatirim));
    }

    // ğŸ”Ÿ Matrah ve Vergi SonuÃ§larÄ±
    // Matrah = KullanÄ±lan KatkÄ± / Efektif Vergi AvantajÄ±
    const efektifFark = (ihrOran * farkIhr + imlOran * farkIml + digOran * farkDig);
    
    const matrahYatirim = yatirimKazanci; // YatÄ±rÄ±m kazancÄ± zaten matrahÄ±n kendisidir (indirimli orana tabi olan kÄ±sÄ±m)
    const matrahDiger = efektifFark > 0 ? (cariDigerKatkisi / efektifFark) : 0;
    
    const indirimliMatrah = matrahYatirim + matrahDiger;
    const indirimliKV = (matrahYatirim + matrahDiger) * (kvOranDiger * (1 - vergiIndirimOrani));
    const indirimliKVOran = (indirimliMatrah > 0) ? (indirimliKV / indirimliMatrah) * 100 : 0;

    safeSet("indirimli_matrah", indirimliMatrah);
    safeSet("indirimli_kv", indirimliKV);
    safeSet("indirimli_kv_oran", indirimliKVOran);

    console.log("âœ… 9903 Hesaplama Tamam:", {
      cariYatirimKatkisi,
      cariDigerKatkisi,
      indirimliMatrah,
      digerFaaliyetButcesi,
      kullanilabilirHakEdilenBakiye
    });

    if (advance && typeof _updateStepDisplay === "function") {
      _updateStepDisplay(7);
    }
  }



  function hesaplaKatkiTutari() {
    const karar = document.getElementById("karar")?.value;

    // 1) 9903 KararÄ± â†’ Ã¶zel fonksiyon Ã§alÄ±ÅŸÄ±r
    if (karar === "2025/9903") {
      if (typeof hesaplaKatkiTutari9903 === "function") {
        hesaplaKatkiTutari9903();
      }
      return;
    }

    // 2) Girdiler
    const toplam = getVal("toplam_tutar");
    const oran = getVal("katki_orani") / 100;

    // 3) GeÃ§ersiz Kontrol
    if (isNaN(toplam) || isNaN(oran)) {
      safeSet("katki_tutari", 0);
      return;
    }

    // 4) Hesaplama
    const tutar = toplam * oran;

    // 5) Sonucu yaz
    safeSet("katki_tutari", tutar);

    // 6) BaÄŸlÄ± fonksiyonlar
    if (typeof hesaplaDigerKatkiTutari === "function") hesaplaDigerKatkiTutari();
    if (typeof hesaplaFiiliKatkiTutari === "function") hesaplaFiiliKatkiTutari();
    if (typeof hesaplaOncekiKatkiTutari === "function") hesaplaOncekiKatkiTutari();
    if (typeof hesaplaKalanVeEndeks === "function") hesaplaKalanVeEndeks();
  }






  function hesaplaDigerKatkiTutari() {

    // 1) 9903 â†’ klasik hesaplama yok
    if (document.getElementById("karar")?.value === "2025/9903") {
      if (typeof hesaplaKatkiTutari9903 === "function") hesaplaKatkiTutari9903();
      return;
    }

    // 2) Oran metinsel engel kontrolÃ¼
    const digerOranRaw = document.getElementById("diger_oran")?.value || "";

    if (digerOranRaw.includes("HESAPLANMAZ") || digerOranRaw.includes("YOK")) {
      const input = document.getElementById("diger_katki_tutari");
      if (input) input.value = "Ä°ÅLETME DÃ–NEMÄ°NDE HESAPLANMAZ";
      return;
    }

    // 3) SayÄ±sal deÄŸerler
    const katki = getVal("katki_tutari");
    const digerOran = getVal("diger_oran");

    if (isNaN(katki) || isNaN(digerOran)) {
      safeSet("diger_katki_tutari", 0);
      return;
    }

    // 4) Hesap
    const sonuc = katki * digerOran / 100;

    // 5) SonuÃ§ yaz
    safeSet("diger_katki_tutari", sonuc);
  }







  function hesaplaFiiliKatkiTutari() {

    // 9903 modunda fiili katkÄ± hesaplanmaz
    if (document.getElementById("karar")?.value === "2025/9903") {
      return;
    }

    // 1) DeÄŸerleri IMask uyumlu olarak oku
    const toplamHarcama = getVal("toplam_harcama_tutari");
    const oran = getVal("katki_orani");

    // 2) GeÃ§ersiz kontrol
    if (isNaN(toplamHarcama) || isNaN(oran)) {
      safeSet("fiili_katki_tutari", 0);
      return;
    }

    // 3) Hesap
    const fiiliKatki = toplamHarcama * (oran / 100);

    // 4) Sonucu yaz
    safeSet("fiili_katki_tutari", fiiliKatki);
  }




  function hesaplaOncekiKatkiTutari() {

    // 9903 modunda da bu hesaplama (basit toplama) yapÄ±lmalÄ±
    // Engel kaldÄ±rÄ±ldÄ±.
    
    const y = getVal("onceki_yatirim_katki_tutari");
    const d = getVal("onceki_diger_katki_tutari");

    const oncekiToplam = (isNaN(y) ? 0 : y) + (isNaN(d) ? 0 : d);

    safeSet("onceki_katki_tutari", oncekiToplam);

    if (typeof hesaplaKalanVeEndeks === "function") {
      hesaplaKalanVeEndeks();
    }
  }





  function hesaplaKalanVeEndeks() {
    const karar = document.getElementById("karar")?.value || "";

    const toplamKatkiInput = document.getElementById("katki_tutari");
    const oncekiKatkiInput = document.getElementById("onceki_katki_tutari");
    const vizeSelect = document.getElementById("vize_durumu");
    const ydoInput = document.getElementById("yeniden_degerleme_orani");
    const endeksInput = document.getElementById("endeks_katki_tutari");

    if (!toplamKatkiInput || !oncekiKatkiInput || !endeksInput) return;

    const toplam = parseFormattedNumber(toplamKatkiInput.value);
    const onceki = parseFormattedNumber(oncekiKatkiInput.value);
    const kalan = (!isNaN(toplam) && !isNaN(onceki)) ? (toplam - onceki) : 0;

    // ğŸ“Œ Kalan katkÄ± NUMERÄ°K olarak yazÄ±lÄ±r
    safeSet("kalan_katki_tutari", kalan);

    // ============================================================
    // ğŸŸ¥ 2025/9903 â†’ Endeksleme yok â†’ maskeyi kaldÄ±r, text yaz
    // ============================================================
    if (karar === "2025/9903") {

      if (maskMap["endeks_katki_tutari"]) {
        maskMap["endeks_katki_tutari"].destroy();
        delete maskMap["endeks_katki_tutari"];
      }

      endeksInput.value = "2025/9903 KAPSAMINDA ENDEKSLEME YOKTUR";
      return;
    }

    // ============================================================
    // ğŸŸ¦ 3305 / 15199 â†’ Endeksleme kontrolÃ¼
    // ============================================================
    const vize = vizeSelect?.value || "";
    const ydo = parseFloat((ydoInput?.value || "").replace(",", "."));

    // ------------------------------------------------------------
    // âœ” Ä°ÅŸletme DÃ¶nemi (Evet) â†’ Endeksleme VAR â†’ SayÄ±sal hesap
    // ------------------------------------------------------------
    if (vize.includes("Evet")) {

      // maske yoksa geri kur
      if (!maskMap["endeks_katki_tutari"]) {
        maskMap["endeks_katki_tutari"] = IMask(endeksInput, {
          mask: Number,
          scale: 2,
          thousandsSeparator: ".",
          radix: ",",
          mapToRadix: ["."],
          lazy: false
        });
      }

      if (!isNaN(kalan) && !isNaN(ydo)) {
        const endeksli = (kalan * ydo) / 100;
        safeSet("endeks_katki_tutari", endeksli);
      } else {
        safeSet("endeks_katki_tutari", 0);
      }

      return;
    }

    // ------------------------------------------------------------
    // âœ” YatÄ±rÄ±m DÃ¶nemi (HayÄ±r) â†’ Endeksleme YOK â†’ Text yaz
    // ------------------------------------------------------------
    if (maskMap["endeks_katki_tutari"]) {
      maskMap["endeks_katki_tutari"].destroy();
      delete maskMap["endeks_katki_tutari"];
    }

    endeksInput.value = "YATIRIM DÃ–NEMÄ°NDE ENDEKSLEME YAPILMAZ";
  }



  function calculateKVMatrah() {

    // getVal â†’ hem masked hem unmasked alanlarÄ± otomatik Ã§Ã¶zer
    const t = getVal("ticari_bilanco_kari");
    const k = getVal("kkeg");

    const toplam = (isNaN(t) ? 0 : t) + (isNaN(k) ? 0 : k);

    safeSet("kv_matrah", toplam);
  }


  function updateIKVAmountAndRate(ikvMatrah, ihrPct, imlPct, digPct, vergiIndirimOraniFraction) {

    // ğŸ”¹ GÃ¼venli matrah (negatifse 0)
    const matrahRaw = Number(ikvMatrah) || 0;
    const matrah = matrahRaw < 0 ? 0 : matrahRaw;

    // ğŸ”¹ Oranlar 0â€“1 formatÄ±na (zaten caller tarafÄ±ndan bÃ¶yle gÃ¶nderilir)
    const pIhr = Number(ihrPct) || 0;
    const pIml = Number(imlPct) || 0;
    const pDig = Number(digPct) || 0;

    // ğŸ”¹ Vergi indirim oranÄ± 0â€“1
    const pDisc = Number(vergiIndirimOraniFraction) || 0;

    // ğŸ”¹ Matrah kÄ±rÄ±lÄ±mÄ± (AÅŸama 6â€™ya uyumlu)
    const bespuan_matrah = matrah * pIhr;
    const birpuan_matrah = matrah * pIml;
    const normal_matrah = matrah * pDig;

    // ğŸ”¹ Genel KV oranlarÄ±
    const rIhrGen = 0.20;
    const rImlGen = 0.24;
    const rDigGen = 0.25;

    // ğŸ”¹ Ä°ndirimli oranlar
    const rIhrInd = rIhrGen * (1 - pDisc);
    const rImlInd = rImlGen * (1 - pDisc);
    const rDigInd = rDigGen * (1 - pDisc);

    // ğŸ”¹ AÄŸÄ±rlÄ±klÄ± efektif vergi oranÄ±
    const effRate =
      (pIhr * rIhrInd) +
      (pIml * rImlInd) +
      (pDig * rDigInd);

    // ğŸ”¹ Ä°ndirimli KV (Ã¶denecek vergi)
    const ikvAmount = matrah * effRate;

    // ğŸ”¹ Ä°ndirimli KV olmasaydÄ± Ã¶denecek vergi
    const vergi_olsaydi =
      (bespuan_matrah * rIhrGen) +
      (birpuan_matrah * rImlGen) +
      (normal_matrah * rDigGen);

    // ğŸ”¹ UI YAZ (IMask uyumlu)
    safeSet("indirimli_kv", ikvAmount);
    safeSet("indirimli_kv_oran", effRate * 100);

    const kvOlsaydiEl = document.getElementById('kv_olsaydi');
    if (kvOlsaydiEl) {
      kvOlsaydiEl.value = vergi_olsaydi.toLocaleString("tr-TR", {
        minimumFractionDigits: 2
      });
    }

    return {
      bespuan_matrah,
      birpuan_matrah,
      normal_matrah,
      vergi_olsaydi,
      effRate,
      ikvAmount
    };
  }



  function calculateCariAndNext() {
    const karar = document.getElementById("karar")?.value;

    // ============================================================
    // ğŸŸ¥ 2025/9903 Ã–ZEL AKIÅ
    // ============================================================
    if (karar === "2025/9903") {
      console.log("âš™ï¸ 2025/9903 aktif â€” Ã¶zel hesap fonksiyonu Ã§alÄ±ÅŸÄ±yor");

      if (typeof hesaplaKatkiTutari9903 === "function") {
        hesaplaKatkiTutari9903({ advance: true });
      }
      return;
    }

    // ============================================================
    // ğŸŸ¦ KLASÄ°K AKIÅ
    // ============================================================
    console.log("--- calculateCariAndNext() BAÅLADI ---");

    const vizeDurumuTercihi = document.getElementById("vize_durumu")?.value || "";
    const digerKazancUygulama = sessionStorage.getItem("diger_kazanc_uygulama") || "hayir";

    // sessionStorage'taki rakam da formatlÄ± olabilir â†’ getVal yerine manuel temizliyoruz
    const kucukOlanDigerFaaliyetTutari =
      Number((sessionStorage.getItem("kucuk_olan_diger_faaliyet") || "0")
        .replace(/\./g, "")
        .replace(",", ".")) || 0;

    // ------------------------------------------------------------
    // YATIRIM/TEVSÄ° KAZANÃ‡ OKUMA (getVal)
    // ------------------------------------------------------------
    const tevsiVal = getVal("tevsi_yatirim_kazanci");
    const klasikVal = getVal("yatirimdan_elde_edilen_kazanc");
    let tevsiYatirimKazanci = tevsiVal > 0 ? tevsiVal : klasikVal;

    tevsiYatirimKazanci = Math.max(0, tevsiYatirimKazanci);

    const vergiIndirimOrani = getVal("vergi_orani") / 100;
    const oncekiToplamKatki = getVal("onceki_katki_tutari");

    // ------------------------------------------------------------
    // ORANLAR
    // ------------------------------------------------------------
    const useDetailedRatios =
      document.getElementById("useDetailedProfitRatios")?.checked || false;

    let ihracatOraniFinal = 0;
    let imalatOraniFinal = 0;
    let digerOraniFinal = 0;

    if (useDetailedRatios) {
      ihracatOraniFinal = (Number(document.getElementById("ratio_ihracat").textContent.replace("%", "").replace(",", ".")) || 0) / 100;
      imalatOraniFinal = (Number(document.getElementById("ratio_imalat").textContent.replace("%", "").replace(",", ".")) || 0) / 100;
      digerOraniFinal = (Number(document.getElementById("ratio_diger").textContent.replace("%", "").replace(",", ".")) || 0) / 100;
    } else {
      const brutSatis = getVal("brut_satis");
      const ihracatSatis = getVal("ihracat");
      const imalatSatis = getVal("imalat");
      const digerSatis = getVal("diger_faaliyet");

      if (brutSatis > 0) {
        ihracatOraniFinal = ihracatSatis / brutSatis;
        imalatOraniFinal = imalatSatis / brutSatis;
        digerOraniFinal = digerSatis / brutSatis;
      }
    }

    const kvOranIhracat = 0.20;
    const kvOranImalat = 0.24;
    const kvOranDiger = 0.25;

    let cariYatirimKatkisi = 0;
    let cariDigerKatkisi = 0;
    let indirimliKurumlarVergisiMatrahi = 0;

    // ============================================================
    // ğŸŸ© 1) Ä°ÅŸletme DÃ¶nemi â€” EVET
    // ============================================================
    if (vizeDurumuTercihi.includes("Evet")) {

      indirimliKurumlarVergisiMatrahi = tevsiYatirimKazanci;

      cariYatirimKatkisi =
        tevsiYatirimKazanci *
        (ihracatOraniFinal * kvOranIhracat +
          imalatOraniFinal * kvOranImalat +
          digerOraniFinal * kvOranDiger) *
        vergiIndirimOrani;

      cariDigerKatkisi = 0;
    }

    // ============================================================
    // ğŸŸ¨ 2) YatÄ±rÄ±m DÃ¶nemi â€” HAYIR
    // ============================================================
    else if (vizeDurumuTercihi.includes("HayÄ±r")) {

      // -------------------------
      // A) DiÄŸer faaliyet kullanÄ±lacak
      // -------------------------
      if (digerKazancUygulama === "evet") {

        const kvMatrah = getVal("kv_matrah");
        const kalanKatki = getVal("kalan_katki_tutari");

        const mevzuatTavani = kucukOlanDigerFaaliyetTutari;

        const effRate =
          ihracatOraniFinal * kvOranIhracat * (1 - vergiIndirimOrani) +
          imalatOraniFinal * kvOranImalat * (1 - vergiIndirimOrani) +
          digerOraniFinal * kvOranDiger * (1 - vergiIndirimOrani);

        const kvTavanVergi = effRate > 0 ? kvMatrah * effRate : 0;

        const cariDigerHesap = Math.min(kalanKatki, mevzuatTavani, kvTavanVergi);

        cariDigerKatkisi = Math.max(0, cariDigerHesap);

        indirimliKurumlarVergisiMatrahi =
          effRate > 0 ? cariDigerKatkisi / effRate : 0;

        cariYatirimKatkisi = 0;
      }

      // -------------------------
      // B) DiÄŸer faaliyet kullanÄ±lmayacak
      // -------------------------
      else {
        indirimliKurumlarVergisiMatrahi = tevsiYatirimKazanci;

        cariYatirimKatkisi =
          tevsiYatirimKazanci *
          (ihracatOraniFinal * kvOranIhracat +
            imalatOraniFinal * kvOranImalat +
            digerOraniFinal * kvOranDiger) *
          vergiIndirimOrani;

        cariDigerKatkisi = 0;
      }
    }

    // ============================================================
    // ğŸ”¥ SONUÃ‡LAR
    // ============================================================
    const cariToplamKatki = cariYatirimKatkisi + cariDigerKatkisi;
    const genelToplamKatki = oncekiToplamKatki + cariToplamKatki;

    safeSet("cari_yatirim_katki", cariYatirimKatkisi);
    safeSet("cari_diger_katki", cariDigerKatkisi);
    safeSet("cari_toplam_katki", cariToplamKatki);
    safeSet("genel_toplam_katki", genelToplamKatki);
    safeSet("indirimli_matrah", indirimliKurumlarVergisiMatrahi);

    updateIKVAmountAndRate(
      indirimliKurumlarVergisiMatrahi,
      ihracatOraniFinal,
      imalatOraniFinal,
      digerOraniFinal,
      vergiIndirimOrani
    );

    console.log("--- calculateCariAndNext() BÄ°TTÄ°, _updateStepDisplay(7) Ã§aÄŸrÄ±lÄ±yor ---");
    _updateStepDisplay(7);
  }









  async function askWhichIncomeToApplyDiscount() {
    const karar = (document.getElementById('karar')?.value || "").trim();
    const vizeRaw = (document.getElementById('vize_durumu')?.value || '').trim().toLowerCase();
    const isIsletme = vizeRaw.includes('evet') || vizeRaw.includes('iÅŸletme');

    let html = `
    <div style="display: flex; flex-direction: column; gap: 12px;">
      <button id="btn-yatirim" class="swal-choice-btn">
        ğŸ’¼ <b>Sadece YatÄ±rÄ±mdan Elde Edilen KazanÃ§lar iÃ§in</b><br>
        <small>(TeÅŸvik belgesi kapsamÄ±ndaki yatÄ±rÄ±m kazanÃ§larÄ±na uygulanÄ±r)</small>
      </button>

      <button id="btn-diger" class="swal-choice-btn ${isIsletme && karar !== '2025/9903' ? 'disabled-btn' : ''}">
        ğŸ¢ <b>Sadece DiÄŸer Faaliyetlerden Elde Edilen KazanÃ§lar iÃ§in</b><br>
        <small>(Mevzuatta belirtilen sÃ¼re ve oran sÄ±nÄ±rlamalarÄ±yla)</small>
      </button>

      <button id="btn-herikisi" class="swal-choice-btn ${isIsletme && karar !== '2025/9903' ? 'disabled-btn' : ''}">
        âš–ï¸ <b>Her Ä°kisi Ä°Ã§in de Uygulamak Ä°stiyorum</b><br>
        <small>(Hem yatÄ±rÄ±m hem de diÄŸer kazanÃ§lara indirim uygulanacak)</small>
      </button>
    </div>
  `;

    Swal.fire({
      title: 'Ä°ndirimli kurumlar vergisini hangi kazanÃ§ iÃ§in hesaplamak istediÄŸinizi seÃ§iniz.',
      html,
      showConfirmButton: false,
      showCancelButton: true,
      cancelButtonText: 'Ä°ptal',
      width: 600,
      customClass: {
        popup: 'swal2-green-theme-popup',
        header: 'swal2-green-theme-header',
        title: 'swal2-green-theme-title',
        htmlContainer: 'swal2-green-theme-html-container',
        cancelButton: 'swal2-green-theme-cancel-button'
      },
      didOpen: () => {
        const style = document.createElement('style');
        style.innerHTML = `
        .swal-choice-btn {
          background-color: #f8f9fa;
          border: 1px solid #d1d1d1;
          border-radius: 8px;
          padding: 12px 14px;
          text-align: left;
          font-size: 14px;
          transition: all 0.2s ease;
          cursor: pointer;
        }
        .swal-choice-btn:hover {
          background-color: #e9f7ef;
          border-color: #28a745;
          transform: scale(1.02);
        }
        .swal-choice-btn small { color: #555; }

        /* ğŸ”’ Pasif buton stili */
        .disabled-btn {
          background-color: #f0f0f0 !important;
          color: #999 !important;
          border-color: #ccc !important;
          cursor: not-allowed !important;
          pointer-events: none !important;
          opacity: 0.7 !important;
        }
      `;
        document.head.appendChild(style);

        const waitForButtons = () => new Promise(resolve => {
          const check = () => {
            const btnY = document.getElementById('btn-yatirim');
            const btnD = document.getElementById('btn-diger');
            const btnH = document.getElementById('btn-herikisi');
            if (btnY && btnD && btnH) resolve({ btnY, btnD, btnH });
            else setTimeout(check, 50);
          };
          check();
        });

        (async () => {
          const { btnY, btnD, btnH } = await waitForButtons();
          if (btnY) btnY.addEventListener('click', async () => await handleIncomeSelection('yatirim'));
          if (btnD && !btnD.classList.contains('disabled-btn')) btnD.addEventListener('click', async () => await handleIncomeSelection('diger'));
          if (btnH && !btnH.classList.contains('disabled-btn')) btnH.addEventListener('click', async () => await handleIncomeSelection('herikisi'));
        })();
      }
    });

    // ğŸ”¹ SeÃ§im sonrasÄ± yÃ¶nlendirme
    async function handleIncomeSelection(choice) {
      Swal.close();
      
      // SeÃ§imi kaydet
      sessionStorage.setItem("gelir_uygulama_tipi", choice);
      // Klasik hesaplama iÃ§in:
      sessionStorage.setItem("diger_kazanc_uygulama", (choice === 'diger' || choice === 'herikisi') ? "evet" : "hayir");

      await new Promise(r => setTimeout(r, 100));

      if (choice === 'yatirim') {
        await handleInvestmentIncomeFlow(); 
        return;
      }

      if (choice === 'diger') {
        startOtherActivitiesFlow9903();
        return;
      }

      if (choice === 'herikisi') {
        // Karar ayrÄ±mÄ± yok -> Genel fonksiyona git (Tevsi kontrolÃ¼ orada yapÄ±lacak)
        await handleInvestmentIncomeFlow();
        
        // ArdÄ±ndan diÄŸer faaliyet akÄ±ÅŸÄ±
        await startOtherActivitiesFlow9903();
        return;
      }
    }
  }





  async function handleInvestmentIncomeFlow() {
    const karar = (document.getElementById('karar')?.value || "").trim();
    const yatirimKazancInput = document.getElementById('yatirimdan_elde_edilen_kazanc');
    
    // YardÄ±mcÄ± fonksiyonlar main scope'tan gelir (formatTL, parseFormattedNumber, safeSet)

    console.log("ğŸ”¹ handleInvestmentIncomeFlow() Step 1 BaÅŸlatÄ±ldÄ±");

    // 1ï¸âƒ£ SORU: AyrÄ± Hesaplayabiliyor musunuz? (Her durumda sorulur)
    const result = await Swal.fire({
      title: 'YatÄ±rÄ±m KazancÄ± Tespiti',
      html: '<div style="text-align: justify;">YatÄ±rÄ±m kazancÄ±nÄ± ayrÄ± bir ÅŸekilde belirleyebiliyor musunuz?</div>',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Evet',
      cancelButtonText: 'HayÄ±r',
      reverseButtons: true
    });

    // 2ï¸âƒ£ EVET: Manuel GiriÅŸ
    if (result.isConfirmed) {
      let popupTitle = 'YatÄ±rÄ±mdan Elde Edilen KazanÃ§ (TL)';
      if (karar === "2025/9903") popupTitle = 'YatÄ±rÄ±mdan Elde Edilen KazanÃ§ (2025/9903)';

      const inputResult = await Swal.fire({
        title: popupTitle,
        input: 'text',
        inputPlaceholder: '0,00 TL',
        showCancelButton: true,
        confirmButtonText: 'Kaydet',
        cancelButtonText: 'VazgeÃ§',
        reverseButtons: true,
        didOpen: () => {
             // 1. Madde Ã‡Ã¶zÃ¼mÃ¼: Manuel giriÅŸ popup'Ä±nda da cursor sorunu olmasÄ±n
             const input = Swal.getInput();
             if (input) {
                 input.addEventListener('input', (e) => {
                     // AnlÄ±k formatlama yapma, kullanÄ±cÄ±nÄ±n yazmasÄ±na izin ver
                 });
                 input.addEventListener('blur', (e) => {
                     const val = parseFormattedNumber(e.target.value);
                     e.target.value = formatTL(val);
                 });
             }
        }
      });

      if (inputResult.isConfirmed && inputResult.value && yatirimKazancInput) {
        const val = parseFormattedNumber(inputResult.value);
        // GÃ¼venli set (IMask varsa internal state gÃ¼ncellenir)
        safeSet('yatirimdan_elde_edilen_kazanc', val);
        
        // Tevsi alanlarÄ±nÄ± temizle (Ã‡Ã¼nkÃ¼ manuel giriÅŸ yapÄ±ldÄ±)
        safeSet('gerceklesen_tevsi_yatirim_tutari', 0);
        safeSet('toplam_sabit_kiymet_tutari', 0);
        safeSet('tevsi_yatirim_kazanci', 0); 
      }
      
      // Evet diyenler iÃ§in standart akÄ±ÅŸ (Matrah/KKEG sorusu GELÄ°R)
      if (typeof promptTicariKariVeKKEGThenGoTo6 === 'function') {
          promptTicariKariVeKKEGThenGoTo6();
      }
      _updateStepDisplay(5);
      
    } 
    // 3ï¸âƒ£ HAYIR: Tevsi Hesaplama Popup (YENÄ° Ä°STEK)
    else if (result.dismiss === Swal.DismissReason.cancel) {

       // Bilgilendirme
       await Swal.fire({
          title: 'Bilgilendirme',
          text: 'YatÄ±rÄ±m kazancÄ± ayrÄ± hesaplanamadÄ±ÄŸÄ± iÃ§in oranlama yapÄ±lacaktÄ±r.',
          icon: 'info',
          timer: 2000,
          showConfirmButton: false
       });

       // Harcama TutarÄ±nÄ± mantÄ±klÄ± bir sÄ±rayla bul
       let harcamaEl = document.getElementById('toplam_harcama_tutari');
       // Alternatif: Cari Harcama TutarÄ± (Step 3'teki diÄŸer alan)
       if (!harcamaEl || !harcamaEl.value) {
            harcamaEl = document.getElementById('cari_harcama_tutari'); 
       }
       
       let harcamaVal = 0;
       if (harcamaEl) {
           // Varsa maskeden ham veriyi Ã§ek (En gÃ¼venli yÃ¶ntem)
           if (typeof maskMap !== 'undefined' && maskMap[harcamaEl.id]) {
               harcamaVal = parseFloat(maskMap[harcamaEl.id].unmaskedValue) || 0;
           } else {
               // Yoksa value parse et
               harcamaVal = parseFormattedNumber(harcamaEl.value);
           }
       }
       const harcamaStr = formatTL(harcamaVal);

       const formResult = await Swal.fire({
        title: 'Tevsi KazanÃ§ Hesaplama Verileri',
        html: `
            <div style="text-align:left; font-size:14px;">
                <div style="margin-bottom:10px;">
                    <label>Ticari BilanÃ§o KÃ¢rÄ± (TL)</label>
                    <input id="swal_new_ticari" class="swal2-input" placeholder="0,00" style="width:100%; margin:5px 0;">
                </div>
                
                <div style="margin-bottom:10px;">
                    <label>Toplam Sabit KÄ±ymet TutarÄ± (TL)</label>
                    <input id="swal_new_sabit" class="swal2-input" placeholder="0,00" style="width:100%; margin:5px 0;">
                </div>
                
                <div style="margin-bottom:10px;">
                    <label>GerÃ§ekleÅŸen Toplam YatÄ±rÄ±m/Harcama (TL)</label>
                    <div style="display:flex; gap:5px; align-items:center;">
                       <input id="swal_new_harcama" class="swal2-input" value="${harcamaStr}" readonly style="width:100%; margin:0; background:#f0f0f0;">
                       <button type="button" id="btn-edit-harcama" class="btn btn-sm btn-outline-secondary" title="DÃ¼zenle">
                         <i class="bi bi-pencil-fill"></i>
                       </button>
                    </div>
                </div>
                
                <div style="margin-bottom:10px; padding:10px; background:#e8f5e9; border-radius:5px;">
                    <label style="font-weight:bold; color:#2e7d32;">Tevsi YatÄ±rÄ±mdan Elde Edilen KazanÃ§ (TL)</label>
                    <input id="swal_new_kazanc" class="swal2-input" placeholder="0,00" readonly style="width:100%; margin:5px 0; background:#fff; border-color:#2e7d32; font-weight:bold;">
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Kaydet ve Ä°lerle',
        cancelButtonText: 'VazgeÃ§',
        customClass: {
          popup: 'swal2-green-theme-popup'
        },
        didOpen: () => {
            const popup = Swal.getPopup();
            const tEl = popup.querySelector('#swal_new_ticari');
            const sEl = popup.querySelector('#swal_new_sabit');
            const hEl = popup.querySelector('#swal_new_harcama');
            const kEl = popup.querySelector('#swal_new_kazanc');
            const editBtn = popup.querySelector('#btn-edit-harcama');
            
            if (!tEl || !sEl || !kEl) return;

            // IMask ile anlÄ±k format ve gÃ¼venli giriÅŸ
            const maskOp = {
                mask: Number,
                scale: 2,
                signed: false,
                thousandsSeparator: '.',
                padFractionalZeros: true,
                normalizeZeros: true,
                radix: ','
            };

            const tMask = IMask(tEl, maskOp);
            const sMask = IMask(sEl, maskOp);
            const hMask = IMask(hEl, maskOp);

            // DÃ¼zenle butonu
            if (editBtn) {
                editBtn.addEventListener('click', () => {
                   hEl.readOnly = false;
                   hEl.style.backgroundColor = '#fff';
                   hEl.focus();
                });
            }

            const calc = () => {
               // En gÃ¼venli ve kesin yÃ¶ntem: IMask'Ä±n sayÄ±sal deÄŸerini kullanmak
               // (unmaskedValue nokta ondalÄ±klÄ± string dÃ¶ner: "80000.50")
               const ticari = Number(tMask.unmaskedValue) || 0;
               const sabit = Number(sMask.unmaskedValue) || 0;
               const harcama = Number(hMask.unmaskedValue) || 0;
               
               let kazanc = 0;
               if (sabit > 0) {
                   // FormÃ¼l: (Harcama / Sabit) * Ticari
                   let oran = harcama / sabit;
                   kazanc = oran * ticari;
                   
                   // KazanÃ§, Ticari Kardan bÃ¼yÃ¼k olamaz (MantÄ±ken)
                   if (kazanc > ticari) kazanc = ticari;
                   if (kazanc < 0) kazanc = 0;
                   
                   kEl.value = formatTL(kazanc);
               } else {
                   kEl.value = "0,00";
               }
            };
            
            tMask.on("accept", calc);
            sMask.on("accept", calc);
            hMask.on("accept", calc);
            
            // Ä°lk aÃ§Ä±lÄ±ÅŸta hesapla
            tMask.updateValue();
            sMask.updateValue();
            
            // Harcama deÄŸerini number olarak set et (String parse hatasÄ±nÄ± Ã¶nlemek iÃ§in)
            if (typeof harcamaVal !== 'undefined') {
                hMask.typedValue = Number(harcamaVal);
            } else {
                 hMask.updateValue();
            }
            
            calc();
        },
        preConfirm: () => {
            const popup = Swal.getPopup();
            return {
                ticari: popup.querySelector('#swal_new_ticari').value,
                sabit: popup.querySelector('#swal_new_sabit').value,
                kazanc: popup.querySelector('#swal_new_kazanc').value
            };
        }
       });

       if (formResult.isConfirmed) {
           const { ticari, sabit, kazanc } = formResult.value;
           
           safeSet('ticari_bilanco_kari', parseFormattedNumber(ticari));
           safeSet('toplam_sabit_kiymet_tutari', parseFormattedNumber(sabit));
           safeSet('gerceklesen_tevsi_yatirim_tutari', harcamaVal); 
           safeSet('tevsi_yatirim_kazanci', parseFormattedNumber(kazanc));
           
           if (yatirimKazancInput) yatirimKazancInput.value = "";

           Swal.fire('âœ… HesaplandÄ±', 'Tevsi kazancÄ± baÅŸarÄ±yla hesaplandÄ±.', 'success');
           
           // DOÄRUDAN STEP 5'e GEÃ‡ (Matrah/KKEG sorusu ATLANIR)
           _updateStepDisplay(5);
       }
    }
  }




  function calculateTevsiKazancAutomatically(attempt = 0) {
    // 1) Elementleri bul
    const elGerceklesen = document.getElementById("gerceklesen_tevsi_yatirim_tutari");
    const elSabit = document.getElementById("toplam_sabit_kiymet_tutari");
    const elKar = document.getElementById("ticari_bilanco_kari");
    const elTarget = document.getElementById("tevsi_yatirim_kazanci");

    // Eksikse Ã§Ä±k (retry ile)
    if (!elGerceklesen || !elSabit || !elKar || !elTarget) {
      if (attempt < 5) {
        setTimeout(() => calculateTevsiKazancAutomatically(attempt + 1), 500);
      }
      return;
    }

    // 2) DeÄŸerleri al (getVal gÃ¼venli deÄŸilse parseLocal kullan)
    const parseLocal = (id) => {
      // Mask map varsa onu kullan
      if (typeof maskMap !== 'undefined' && maskMap[id] && maskMap[id].unmaskedValue) {
        return parseFloat(maskMap[id].unmaskedValue);
      }
      // Yoksa DOM value
      const el = document.getElementById(id);
      let val = el ? el.value : "";
      if (!val) return 0;
      // 1.000,00 -> 1000.00
      val = val.replace(/\./g, "").replace(",", ".");
      return parseFloat(val) || 0;
    };

    // getVal global varsa onu kullan, yoksa local
    const getV = (typeof getVal === 'function') ? getVal : parseLocal;

    const gerceklesen = getV("gerceklesen_tevsi_yatirim_tutari");
    const sabit = getV("toplam_sabit_kiymet_tutari");
    const kar = getV("ticari_bilanco_kari");

    console.log("Tevsi Hesap:", { gerceklesen, sabit, kar });

    let kazanc = 0;
    if (sabit > 0) {
      kazanc = (gerceklesen / sabit) * kar;
    }

    // Sonucu yaz
    if (typeof safeSet === 'function') {
      safeSet("tevsi_yatirim_kazanci", kazanc);
    } else {
      // Fallback
      if (typeof maskMap !== 'undefined' && maskMap["tevsi_yatirim_kazanci"]) {
        maskMap["tevsi_yatirim_kazanci"].unmaskedValue = String(kazanc);
      } else {
        elTarget.value = kazanc.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
      }
    }

    // BaÄŸÄ±mlÄ± hesaplamayÄ± tetikle
    if (typeof calculateKVMatrah === 'function') calculateKVMatrah();
  }









  function startOtherActivitiesFlow9903() {
    sessionStorage.setItem('diger_kazanc_uygulama', 'evet');

    const digerKatkiEl = document.getElementById('diger_katki_tutari');
    const harcamaEl = document.getElementById('toplam_harcama_tutari');

    const digerKatki = digerKatkiEl ? parseFormattedNumber(digerKatkiEl.value) : 0;
    const harcama = harcamaEl ? parseFormattedNumber(harcamaEl.value) : 0;
    const kucukOlan = Math.min(digerKatki || 0, harcama || 0);

    sessionStorage.setItem('kucuk_olan_diger_faaliyet', kucukOlan);

    Swal.fire({
      title: 'DiÄŸer Faaliyetler Ä°Ã§in Ãœst SÄ±nÄ±r',
      html: `Bu dÃ¶nemde diÄŸer faaliyet kazanÃ§larÄ±na uygulanabilecek azami katkÄ± tutarÄ±:<br><br>
       <b>${kucukOlan.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} TL</b>`,
      icon: 'info',
      confirmButtonText: 'Tamam'
    }).then(() => {
      // ğŸ”¹ Ticari bilanÃ§o + KKEG popupâ€™Ä±nÄ± gÃ¶ster, ardÄ±ndan Step 5â€™e geÃ§
      if (typeof promptTicariKariVeKKEGThenGoTo6 === 'function') {
        // popupâ€™Ä± yine aÃ§, ama yÃ¶nlendirme 5â€™e
        promptTicariKariVeKKEGThenGoTo6();
      }
      _updateStepDisplay(5);
    });
  }



  function askSmallestAmountQuestionForOtherActivities() {
    // Gerekli deÄŸerleri DOM'dan veya mevcut hesaplamalardan alalÄ±m
    const digerKatkiTutariElement = document.getElementById('diger_katki_tutari');
    const toplamHarcamaTutariElement = document.getElementById('toplam_harcama_tutari');

    // Elementlerin varlÄ±ÄŸÄ±nÄ± kontrol et, yoksa varsayÄ±lan deÄŸer kullan
    const digerKatkiTutari = digerKatkiTutariElement ? parseFormattedNumber(digerKatkiTutariElement.value) : 0;
    const toplamHarcamaTutari = toplamHarcamaTutariElement ? parseFormattedNumber(toplamHarcamaTutariElement.value) : 0;

    let kucukOlanDeger;

    // KÃ¼Ã§Ã¼k olan deÄŸeri bulma mantÄ±ÄŸÄ±
    if (digerKatkiTutari === 0 && toplamHarcamaTutari === 0) {
      kucukOlanDeger = 0; // Her iki deÄŸer de sÄ±fÄ±rsa kÃ¼Ã§Ã¼k olan da sÄ±fÄ±rdÄ±r.
    } else if (digerKatkiTutari === 0) {
      kucukOlanDeger = toplamHarcamaTutari; // DiÄŸer katkÄ± sÄ±fÄ±rsa, toplam harcama kÃ¼Ã§Ã¼ktÃ¼r.
    } else if (toplamHarcamaTutari === 0) {
      kucukOlanDeger = digerKatkiTutari; // Toplam harcama sÄ±fÄ±rsa, diÄŸer katkÄ± kÃ¼Ã§Ã¼ktÃ¼r.
    } else {
      kucukOlanDeger = Math.min(digerKatkiTutari, toplamHarcamaTutari); // Ä°ki deÄŸerden kÃ¼Ã§Ã¼k olanÄ± seÃ§.
    }

    // Hesaplanan kÃ¼Ã§Ã¼k deÄŸeri sessionStorage'a kaydet
    sessionStorage.setItem('kucuk_olan_diger_faaliyet', kucukOlanDeger);

    // DiÄŸer faaliyetlere indirim uygulanacaksa tevsi yatÄ±rÄ±m alanlarÄ±nÄ± sÄ±fÄ±rla
    // Bu, Ã¶nceki SweetAlert zincirinde de yapÄ±lÄ±yordu, burada tekrar edilmesi garanti saÄŸlar.
    document.getElementById('gerceklesen_tevsi_yatirim_tutari').value = '';
    document.getElementById('toplam_sabit_kiymet_tutari').value = '';
    document.getElementById('ticari_bilanco_kari').value = '';
    document.getElementById('tevsi_yatirim_kazanci').value = '';

    // KullanÄ±cÄ±ya SweetAlert ile bilgilendirme mesajÄ± gÃ¶ster
    Swal.fire({
      title: 'Otomatik Hesaplama YapÄ±ldÄ±!',
      html: `<div style="text-align: justify;">DiÄŸer faaliyetlerinizden elde ettiÄŸiz kazanÃ§larÄ±nÄ±za uygulanabilecek maksimum indirimli kurumlar vergisi tutarÄ±:<br><br><b>${kucukOlanDeger.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} TL</b></div>`,
      icon: 'info', // Bilgilendirme ikonu kullan
      showConfirmButton: true, // "Tamam" butonu gÃ¶ster
      confirmButtonText: 'Tamam',
      customClass: {
        popup: 'swal2-green-theme-popup',
        header: 'swal2-green-theme-header',
        title: 'swal2-green-theme-title',
        icon: 'swal2-green-theme-icon',
        confirmButton: 'swal2-green-theme-confirm-button',
        htmlContainer: 'swal2-green-theme-html-container'
      }
    }).then(() => {
      // 6â€™ya geÃ§meden Ã¶nce Ticari KÃ¢r + KKEGâ€™yi iste
      if (typeof promptTicariKariVeKKEGThenGoTo6 === 'function') {
        promptTicariKariVeKKEGThenGoTo6();
      }
      _updateStepDisplay(5); // gÃ¼venlik iÃ§in

    });
  }



  async function promptTicariKariVeKKEGThenGoTo6() {
    // ğŸ”¹ TÃ¼rk formatÄ±nda TL yazdÄ±ran fonksiyon (Python'daki tlformat eÅŸdeÄŸeri)
    const formatTL = (num) => {
      if (isNaN(num) || num === null) return "0,00";
      return num
        .toFixed(2)
        .replace(".", ",")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    };

    // ğŸ”¹ VirgÃ¼l/nokta iÃ§eren string'i parse eden fonksiyon
    const parseFormattedNumber = (val) => {
      if (!val) return 0;
      return parseFloat(val.replace(/\./g, "").replace(",", "."));
    };

    const { value: vals, isConfirmed, isDismissed } = await Swal.fire({
      title: 'Cari DÃ¶nem Verileri',
      html: `
      <div style="text-align:left">
        <!-- Ticari BilanÃ§o KÃ¢rÄ± -->
        <div style="margin-bottom:14px;">
          <label style="font-size:13px; color:#555;">Ticari BilanÃ§o KÃ¢rÄ± (TL)</label>
          <input id="swal_ticari" class="swal2-input" placeholder="0,00" inputmode="decimal" style="margin:0; width:100%;">
        </div>

        <!-- KKEG -->
        <div style="margin-bottom:14px;">
          <label style="font-size:13px; color:#555;">KKEG (TL)</label>
          <input id="swal_kkeg" class="swal2-input" placeholder="0,00" inputmode="decimal" style="margin:0; width:100%;">
        </div>

        <!-- Matrah kutusu -->
        <div style="margin-top:6px; padding:14px; background:#f6faf6; border:1px solid #d5ead5; border-radius:10px;">
          <div style="font-weight:700; font-size:14px; margin-bottom:6px;">Kurumlar Vergisi MatrahÄ±</div>
          <div style="font-size:13px; color:#444; margin-bottom:8px;">
            Matrah = <b>Ticari BilanÃ§o KÃ¢rÄ±</b> + <b>KKEG</b>
          </div>
          <input id="swal_matrah" class="swal2-input" placeholder="0,00" readonly
                 style="margin:0; background:#f0f0f0; width:100%;">
        </div>
      </div>
    `,
      focusConfirm: false,
      showCancelButton: true, // ğŸ”¹ Ä°PTAL butonu eklendi
      cancelButtonText: 'Ä°ptal',
      confirmButtonText: 'Kaydet ve devam et',
      allowOutsideClick: false,
      allowEscapeKey: true,
      reverseButtons: true, // ğŸ”¹ buton sÄ±rasÄ±nÄ± ters Ã§evir: Ä°ptal solda, Kaydet saÄŸda
      customClass: {
        popup: 'swal2-green-theme-popup',
        confirmButton: 'swal2-green-theme-confirm-button',
        cancelButton: 'swal2-green-theme-cancel-button'
      },
      didOpen: () => {
        const popup = Swal.getPopup();
        const tEl = popup.querySelector('#swal_ticari');
        const kEl = popup.querySelector('#swal_kkeg');
        const mEl = popup.querySelector('#swal_matrah');

        if (!tEl || !kEl || !mEl) return;

        // IMask ile anlÄ±k format ve gÃ¼venli giriÅŸ
        const maskOp = {
            mask: Number,
            scale: 2,
            signed: false,
            thousandsSeparator: '.',
            padFractionalZeros: true,
            normalizeZeros: true,
            radix: ','
        };

        const tMask = IMask(tEl, maskOp);
        const kMask = IMask(kEl, maskOp);

        // ğŸ’¡ YENÄ°: EÄŸer formda zaten bir deÄŸer varsa (Ã¶rn. Tevsi popup'Ä±ndan geldi) buraya Ã¶n tanÄ±mlÄ± getir
        const existingTicari = getVal('ticari_bilanco_kari');
        const existingKKEG = getVal('kkeg');
        if (existingTicari > 0) tMask.typedValue = Number(existingTicari);
        if (existingKKEG > 0) kMask.typedValue = Number(existingKKEG);

        const update = () => {
          const t = tMask.typedValue || 0;
          const k = kMask.typedValue || 0;
          const sum = t + k;
          mEl.value = formatTL(sum);
        };

        tMask.on("accept", update);
        kMask.on("accept", update);

        update();
      },
      preConfirm: () => {
        const t = parseFormattedNumber(document.getElementById('swal_ticari').value);
        const k = parseFormattedNumber(document.getElementById('swal_kkeg').value);
        if (isNaN(t) || isNaN(k)) {
          Swal.showValidationMessage('LÃ¼tfen geÃ§erli sayÄ±lar girin.');
          return false;
        }
        return { t, k, m: (t || 0) + (k || 0) };
      }
    });

    // ğŸ”¹ Ä°ptal durumunda hiÃ§bir ÅŸey yapÄ±lmaz
    if (isDismissed) {
      console.log("âŒ KullanÄ±cÄ± cari dÃ¶nem giriÅŸini iptal etti.");
      return;
    }

    if (isConfirmed && vals) {
      const tOut = document.getElementById('ticari_bilanco_kari');
      const kOut = document.getElementById('kkeg');
      const mOut = document.getElementById('kv_matrah');

      if (tOut) safeSet('ticari_bilanco_kari', vals.t);
      if (kOut) safeSet('kkeg', vals.k);
      if (mOut) safeSet('kv_matrah', vals.m);

      if (typeof calculateKVMatrah === 'function') calculateKVMatrah();

      _updateStepDisplay(5);
    }
  }



  function goToStep1() { _updateStepDisplay(1); }

  function goToStep2() {
    // ğŸ”¹ AlanlarÄ± al
    const karar = document.getElementById("karar")?.value.trim();
    const programTuru = document.getElementById("program_turu")?.value.trim();
    const vizeDurumu = (document.getElementById("vize_durumu")?.value || "").trim();

    // ğŸ”¹ Genel zorunlu kontroller
    if (!karar) {
      Swal.fire({
        icon: "warning",
        title: "Eksik Bilgi",
        text: "LÃ¼tfen 'TeÅŸvik Belgesi Hangi Karara GÃ¶re DÃ¼zenlendi' alanÄ±nÄ± seÃ§iniz.",
        confirmButtonText: "Tamam"
      });
      return;
    }

    if (!vizeDurumu || vizeDurumu === "SeÃ§iniz") {
      Swal.fire({
        icon: "warning",
        title: "Eksik Bilgi",
        text: "LÃ¼tfen 'Tamamlama Vizesi YapÄ±ldÄ± mÄ±?' alanÄ±nÄ± seÃ§iniz.",
        confirmButtonText: "Tamam"
      });
      return;
    }

    // ğŸ”¹ 2025/9903 iÃ§in ek zorunluluk
    if (karar === "2025/9903" && !programTuru) {
      Swal.fire({
        icon: "warning",
        title: "Eksik Bilgi",
        text: "Bu karar iÃ§in 'Program TÃ¼rÃ¼' seÃ§imi zorunludur.",
        confirmButtonText: "Tamam"
      });
      return;
    }

    // ğŸ”¹ AÅŸama 1â€™deki deÄŸerleri gizli alanlara kopyala
    const belgeNo = document.querySelector('[name="belge_no"]')?.value || '';
    const belgeTarihi = document.querySelector('[name="belge_tarihi"]')?.value || '';
    const bolge = document.querySelector('[name="bolge"]')?.value || '';

    const hiddenBelgeNo = document.querySelector('[name="belge_no_hidden"]');
    const hiddenBelgeTarihi = document.querySelector('[name="belge_tarihi_hidden"]');
    const hiddenBolge = document.querySelector('[name="bolge_hidden"]');

    if (hiddenBelgeNo) hiddenBelgeNo.value = belgeNo;
    if (hiddenBelgeTarihi) hiddenBelgeTarihi.value = belgeTarihi;
    if (hiddenBolge) hiddenBolge.value = bolge;

    console.log("ğŸŸ¢ Gizli alanlar gÃ¼ncellendi:", { belgeNo, belgeTarihi, bolge });

    // ğŸ”¹ Her ÅŸey tamamsa bir sonraki adÄ±ma geÃ§
    _updateStepDisplay(2);
    setTimeout(() => {
      // ğŸ’¡ YENÄ°: BoÅŸ alanlara varsayÄ±lan deÄŸerleri bas
      const il = document.getElementById("il");
      const osb = document.getElementById("osb");
      const donem = document.getElementById("donem");

      if (il && (!il.value || il.value === "")) il.value = "Ä°stanbul";
      if (osb && (!osb.value || osb.value === "")) osb.value = "OSB Ä°Ã§inde";
      
      if (donem && (!donem.value || donem.value === "")) {
         const y = new Date().getFullYear();
         donem.value = `${y} - 1. GEÃ‡Ä°CÄ°`;
      }
    
      if(typeof setBolge === 'function') setBolge();
      if(typeof setOranlar === 'function') setOranlar();
    }, 50);
  }

  function goToStep3() {
    const donem = document.getElementById("donem")?.value;

    if (!donem) {
      Swal.fire("Eksik Bilgi", "LÃ¼tfen hesap dÃ¶nemi seÃ§iniz.", "warning");
      return; // step3'e geÃ§me!
    }

    _updateStepDisplay(3);
  }

  function goToStep4() { _updateStepDisplay(4); }

  async function goToStep5(source) {
    if (source === 'from6') {
      _updateStepDisplay(5);
      return;
    }

    setTimeout(async () => {
      const karar = (document.getElementById('karar')?.value || "").trim();
      const vizeDurumu = (document.getElementById('vize_durumu')?.value || "").trim().toLowerCase();

      try {
        if (karar === "2025/9903") {
          console.log("âœ… 2025/9903 kararÄ±: yeni kazanÃ§ seÃ§imi sorusu gÃ¶steriliyor.");
          await askWhichIncomeToApplyDiscount();
        } else if (vizeDurumu.includes("evet") || vizeDurumu.includes("hayÄ±r") || vizeDurumu.includes("hayir")) {
          console.log("ğŸ“˜ 2025/9903 dÄ±ÅŸÄ± karar: klasik kazanÃ§ seÃ§imi sorusu gÃ¶steriliyor.");
          await askWhichIncomeToApplyDiscount();
        } else {
          console.log("âšª Vize durumu boÅŸ, doÄŸrudan aÅŸama 5â€™e geÃ§iliyor.");
        }
      } catch (e) {
        console.warn("âš ï¸ Soru akÄ±ÅŸÄ± hata verdi:", e);
      } finally {
        // ğŸŸ© Her durumda aÅŸama 5â€™e geÃ§
        _updateStepDisplay(5);
      }
    }, 100);
  }




  function goToStep6() {
    // ğŸŸ© EÄŸer mevcut aÅŸama 4'ten geliniyorsa (sorularÄ±n ardÄ±ndan),
    // otomatik olarak 5. aÅŸamaya geÃ§
    if (CURRENT_STEP === 4) {
      console.log("ğŸ” AÅŸama 4'ten gelindi â†’ 6 yerine 5'e yÃ¶nlendiriliyor.");
      _updateStepDisplay(5);
      return;
    }

    // DiÄŸer durumlarda (Ã¶r. 5 â†’ 6 veya 6 â†’ 7) normal akÄ±ÅŸta ilerle
    _updateStepDisplay(6);
  }

  function goToStep7() { _updateStepDisplay(7); }



  const currentBelgeJSData = {{ current_belge | tojson | safe if current_belge else 'null' }};

  function clearAllFormData() {
    Swal.fire({
      title: "TÃ¼m veriler temizlensin mi?",
      text: "Belge numarasÄ± ve belge tarihi korunacaktÄ±r.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Evet, temizle",
      cancelButtonText: "VazgeÃ§",
    }).then((result) => {
      if (!result.isConfirmed) return;

      // ğŸ›‘ Ã–nce korunacak deÄŸerleri al
      const belgeNoVal =
        document.getElementById("belge_no")?.value ||
        document.getElementById("belge_no_hidden")?.value ||
        "";
      const belgeTarihiVal =
        document.getElementById("belge_tarihi")?.value ||
        document.getElementById("belge_tarihi_hidden")?.value ||
        "";

      // ğŸ”’ SessionStorage'da da saklÄ±yoruz ki restore sÄ±rasÄ±nda kaybolmasÄ±n
      sessionStorage.setItem("KEEP_belge_no", belgeNoVal);
      sessionStorage.setItem("KEEP_belge_tarihi", belgeTarihiVal);

      // ğŸ”„ TÃ¼m inputlarÄ± temizle ama belge no + tarihi HARÄ°Ã‡
      document.querySelectorAll("input, select, textarea").forEach(el => {
        if (el.type === "file") return;

        const name = el.name || el.id;
        if (!name) return;

        const safeNames = [
          "belge_no",
          "belge_no_hidden",
          "belge_tarihi",
          "belge_tarihi_hidden"
        ];

        if (safeNames.includes(name) || safeNames.includes(el.id)) {
          return; // dokunma
        }

        // âœ”ï¸ DiÄŸer alanlarÄ± temizle
        if (el.type === "checkbox" || el.type === "radio") el.checked = false;
        else el.value = "";

        // Session'dan da temizle
        sessionStorage.removeItem(`form_${name}`);
      });

      // ğŸ”„ SessionStorage'dan tÃ¼m aÅŸama verilerini sil
      sessionStorage.removeItem("last_step");
      sessionStorage.removeItem("manual_katki");
      sessionStorage.removeItem("manual_katki_value");
      sessionStorage.removeItem("manual_vergi");
      sessionStorage.removeItem("manual_vergi_value");
      sessionStorage.removeItem("manual_kv_matrah");
      sessionStorage.removeItem("manual_kv_matrah_value");
      sessionStorage.removeItem("use_detailed_profit_ratios");

      Swal.fire({
        icon: "success",
        title: "Form temizlendi (Belge No ve Tarihi korundu)",
        showConfirmButton: false,
        timer: 1200,
        toast: true,
        position: "top-end"
      });

      // ğŸ“Œ Temizleme sonrasÄ± Step 1'e dÃ¶n
      if (typeof _updateStepDisplay === "function") {
        _updateStepDisplay(1);
      }
    });
  }




  function getBelgeNo() {
    // 1ï¸âƒ£ Step 1'deki input
    const fromInput = document.getElementById("belge_no")?.value?.trim();
    if (fromInput) return fromInput;

    // 2ï¸âƒ£ Hidden input â†’ mevcut belgeyi dÃ¼zenlerken
    const fromHidden = document.getElementById("belge_no_hidden")?.value?.trim();
    if (fromHidden) return fromHidden;

    // 3ï¸âƒ£ SessionStorage (restore iÃ§in)
    const fromFormSession = sessionStorage.getItem("form_belge_no");
    if (fromFormSession) return fromFormSession;

    // 4ï¸âƒ£ AÅŸamalar arasÄ± geÃ§iÅŸte kullanÄ±lan deÄŸer
    const fromSession = sessionStorage.getItem("belge_no");
    if (fromSession) return fromSession;

    return "";
  }






  function collectDonemUsageData() {
    const belgeNo = getBelgeNo();
    const donemSecimi = document.getElementById("donem")?.value || "";

    let hesap_donemi = null;
    let donem_turu = null;

    const match = donemSecimi.match(/(\d{4})\s*-\s*(.+)/);
    if (match) {
      hesap_donemi = parseInt(match[1]);
      donem_turu = match[2].trim().toUpperCase();
    }

    return {
      belge_no: belgeNo || "",
      hesap_donemi,
      donem_turu,


      // ğŸ”µ Sadece tesvik_kullanim tablosunda OLAN kolonlar
      yatirimdan_elde_edilen_kazanc: parseFormattedNumber(document.getElementById("yatirimdan_elde_edilen_kazanc")?.value),
      tevsi_yatirim_kazanci: parseFormattedNumber(document.getElementById("tevsi_yatirim_kazanci")?.value),
      diger_faaliyet: parseFormattedNumber(document.getElementById("diger_faaliyet")?.value),

      cari_yatirim_katki: parseFormattedNumber(document.getElementById("cari_yatirim_katki")?.value),
      cari_diger_katki: parseFormattedNumber(document.getElementById("cari_diger_katki")?.value),
      cari_toplam_katki: parseFormattedNumber(document.getElementById("cari_toplam_katki")?.value),

      genel_toplam_katki: parseFormattedNumber(document.getElementById("genel_toplam_katki")?.value),
      kalan_katki_tutari: parseFormattedNumber(document.getElementById("kalan_katki_tutari")?.value),

      indirimli_matrah: parseFormattedNumber(document.getElementById("indirimli_matrah")?.value),
      indirimli_kv: parseFormattedNumber(document.getElementById("indirimli_kv")?.value),
      indirimli_kv_oran: parseFormattedNumber(document.getElementById("indirimli_kv_oran")?.value),
    };
  }



  async function submitFullFormAndDonem() {
    const form = document.getElementById('form-giris');

    Swal.fire({
      title: 'Kaydediliyor...',
      html: 'LÃ¼tfen bekleyin.',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    // ============================================
    // 1) TESVIK ID'YI DOÄRU AL
    // ============================================
    const tesvikFromInput = document.getElementById("tesvik_id")?.value?.trim();
    const tesvikFromSession = sessionStorage.getItem("current_tesvik_id");

    const tesvikId = tesvikFromInput || tesvikFromSession;

    // Tesvik ID yoksa (yeni kayÄ±t) devam etmeli, backend oluÅŸturacak.
    if (!tesvikId) {
      console.log("â„¹ï¸ Yeni belge kaydÄ± yapÄ±lÄ±yor (ID henÃ¼z yok).");
    }

    // ============================================
    // 2) ANA BELGEYÄ° KAYDET
    // ============================================
    let belgeId = null;
    const formData = new FormData(form);

    try {
      const res = await fetch(form.action + `?view=${tesvikId}`, {
        method: "POST",
        body: formData
      });

      const data = await res.json();

      if (data.status !== "success") {
        Swal.fire(data.title || "Hata", data.message, "error");
        return;
      }

      // Backendâ€™in gÃ¶nderdiÄŸi gÃ¼ncel teÅŸvik ID
      belgeId = data.tesvik_id;
      document.getElementById("tesvik_id").value = belgeId;

      // Sessionâ€™da da gÃ¼ncelle
      sessionStorage.setItem("current_tesvik_id", belgeId);

    } catch (e) {
      Swal.fire("Sunucu HatasÄ±", "Ana belge kaydÄ± baÅŸarÄ±sÄ±z oldu.", "error");
      return;
    }

    // ============================================
    // 3) DÃ–NEMÄ° KAYDET
    // ============================================
    try {
      const donemData = collectDonemUsageData();

      const donemRes = await fetch("/indirimlikurumlar/save_tesvik_kullanim", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(donemData)
      });

      const result = await donemRes.json();

      Swal.fire({
        icon: "success",
        title: "Kaydedildi!",
        html: "Belge ve dÃ¶nem baÅŸarÄ±yla kaydedildi. Liste gÃ¼ncelleniyor...",
        timer: 2000,
        showConfirmButton: false
      });

      sessionStorage.removeItem("last_step");

      setTimeout(() => {
        window.location.href = "/indirimlikurumlar/?sekme=tesvik";
      }, 1500);

    } catch (e) {
      Swal.fire("Hata", "DÃ¶nem kaydÄ± sÄ±rasÄ±nda bir hata oluÅŸtu.", "error");
    }
  }








  document.addEventListener("DOMContentLoaded", () => {

    // ============================================================
    // 0) MODÃœL 0 â€” FORM MODU GUARD
    // ============================================================
    function initGuard() {
      // âœ… URL yerine DOM elementini kontrol et (URL'de parametre olmasa bile varsayÄ±lan sayfa form olabilir)
      if (!document.getElementById("form-giris")) {
        console.log("â†© Form giriÅŸ elementi bulunamadÄ±, form modÃ¼lleri yÃ¼klenmiyor.");
        return false;
      }
      return true;
    }
    if (!initGuard()) return;



    // ============================================================
    // 1) MODÃœL 1 â€” ELEMENT REFERANSLARI (TEK MERKEZ)
    // ============================================================
    const refs = {
      kararSelect: document.getElementById("karar"),
      ilSelect: document.getElementById("il"),
      programSelect: document.getElementById("program_turu"),
      bolgeInput: document.getElementById("bolge"),
      katkiInput: document.getElementById("katki_orani"),
      vergiInput: document.getElementById("vergi_orani"),
      digerInput: document.getElementById("diger_oran"),
      tur1: document.getElementById("yatirim_turu1"),
      tur2: document.getElementById("yatirim_turu2"),
      form: document.getElementById("form-giris"),
      calculateBtn: document.getElementById("calculateCariBtn"),
      ayrTable: document.getElementById("ayrintili-kazanc-table"),
      clearButton: document.getElementById("clearProfitData")
    };



    // ============================================================
    // 2) MODÃœL 2 â€” DEFAULT DEÄERLER
    // ============================================================
    function initDefaultValues() {
      const karar = refs.kararSelect?.value;
      if (karar === "2025/9903") return;

      const il = document.getElementById("il");
      const osb = document.getElementById("osb");
      const donem = document.getElementById("donem");

      if (il && (!il.value || il.value === "")) il.value = "Ä°stanbul";
      if (osb && (!osb.value || osb.value === "")) osb.value = "OSB Ä°Ã§inde";

      if (donem && (!donem.value || donem.value === "")) {
        const y = new Date().getFullYear();
        donem.value = `${y} - 1. GEÃ‡Ä°CÄ°`;
      }

      if (typeof setBolge === "function") setBolge();
      if (typeof setOranlar === "function") setOranlar();
    }



    // ============================================================
    // 3) MODÃœL 3 â€” 9903 KARARI Ã–ZEL DAVRANIÅLARI
    // ============================================================
    function init9903Logic() {
      const { kararSelect, ilSelect, programSelect, katkiInput } = refs;

      if (!kararSelect) return;

      kararSelect.addEventListener("change", handleKarar9903);


      if (ilSelect) {
        ilSelect.addEventListener("change", () => {
          const karar = kararSelect.value;
          const il = ilSelect.value;

          if (karar === "2025/9903") {
            refs.bolgeInput.value = bolgeMap9903[il] || "";
          } else if (typeof setBolge === "function") {
            setBolge();
          }
        });
      }

      programSelect.addEventListener("change", () => {
        const karar = kararSelect.value;
        const program = programSelect.value;

        if (karar === "2025/9903") {
          safeSet("katki_orani", katkilar9903?.[program] || 0);
        } else if (typeof setOranlar === "function") {
          setOranlar();
        }
      });
    }



    // ============================================================
    // 4) MODÃœL 4 â€” KLASÄ°K KARARLAR (3305 / 15199)
    // ============================================================
    function initClassicLogic() {
      // Åu anda ek Ã¶zel iÅŸlem yok.
      // Gerekirse buraya ekleriz.
    }



    // ============================================================
    // 5) MODÃœL 5 â€” TEVSÄ° HESAPLAMA BLOÄU
    // ============================================================
    function initTevsiLogic() {
      const { tur1 } = refs;

      if (tur1) {
        tur1.addEventListener("change", () => {
          if (tur1.value.toLowerCase() === "tevsi") {
            setTimeout(calculateTevsiKazancAutomatically, 500);
          } else {
            const el = document.getElementById("tevsi_yatirim_kazanci");
            if (el) el.value = "";
          }
        });
      }

      ["gerceklesen_tevsi_yatirim_tutari", "toplam_sabit_kiymet_tutari", "ticari_bilanco_kari"]
        .forEach(id => {
          const el = document.getElementById(id);
          if (el) el.addEventListener("input", calculateTevsiKazancAutomatically);
        });

      const tevsiInput = document.getElementById("tevsi_yatirim_kazanci");
      if (tevsiInput) {
        try {
          tevsiMask = IMask(tevsiInput, {
            mask: Number,
            scale: 2,
            thousandsSeparator: '.',
            radix: ',',
            mapToRadix: [','],
            normalizeZeros: false,
            padFractionalZeros: false
          });
        } catch (e) {
          console.warn("Tevsi IMask error:", e);
        }
      }
    }



    // ============================================================
    // 6) MODÃœL 6 â€” MASK SÄ°STEMÄ°
    // ============================================================
    function initMaskSystem() {
      Object.keys(idConfig).forEach(id => {
        const field = document.getElementById(id);
        if (!field) return;

        const type = idConfig[id];

        /* ============================================================
           1) YÃœZDE ALANLARI MASKESÄ° (%)
           ============================================================ */
        if (type === "percent") {
          try {
            const mask = IMask(field, {
              mask: Number,
              scale: 2,
              thousandsSeparator: '.',
              radix: ',',
              mapToRadix: [','],
              padFractionalZeros: true,
              normalizeZeros: true,
              min: 0,
              max: 100
            });

            maskMap[id] = mask;

            field.addEventListener("input", () => (userTyped[id] = true));

            mask.on("complete", () => {
              if (RESTORE_MODE) return;
              if (programmaticMaskUpdate) return;
            });

          } catch (err) {
            console.warn(`Percent IMask oluÅŸturulamadÄ± (#${id}):`, err);
          }

          return; // â— YÃ¼zde alanlarÄ± baÅŸka maskeye girmesin
        }

        /* ============================================================
           2) PARA ALANLARI MASKESÄ° (TL)
           ============================================================ */
        if (type !== "none") {
          // Ortak hesaplama mantÄ±ÄŸÄ±
          const runLogic = () => {
            const karar = refs.kararSelect?.value;
            const t = type;

            if (t === "none") return;

            if (karar === "2025/9903") {
              if (t === "katki") hesaplaKatkiTutari9903();
              if (t === "ratios") calculateRatios();
              if (t === "kv") calculateKVMatrah();
              return;
            }

            // klasik mod
            if (t === "katki") {
              hesaplaKatkiTutari();
              hesaplaDigerKatkiTutari();
              hesaplaFiiliKatkiTutari();
              hesaplaOncekiKatkiTutari();
              hesaplaKalanVeEndeks();
            } else if (t === "ratios") calculateRatios();
            else if (t === "tevsi") calculateTevsiKazancAutomatically();
            else if (t === "kv") calculateKVMatrah();
          };

          try {
            const mask = IMask(field, {
              mask: Number,
              scale: 2,
              thousandsSeparator: '.',
              radix: ',',
              mapToRadix: [','],
              normalizeZeros: false,
              padFractionalZeros: false
            });

            maskMap[id] = mask;

            field.addEventListener("input", () => {
              userTyped[id] = true;
            });

            // "complete" yerine "accept" kullanÄ±yoruz (daha seri tepki iÃ§in)
            mask.on("accept", () => {
              if (RESTORE_MODE) return;
              if (programmaticMaskUpdate) return;
              if (!userTyped[id]) return;
              runLogic();
            });

          } catch (err) {
            console.warn(`IMask oluÅŸturulamadÄ± (#${id}), fallback input listener ekleniyor:`, err);
            // Fallback: Maske Ã§alÄ±ÅŸmazsa standart input event'i dinle
            field.addEventListener("input", runLogic);
          }
        }

      });

      // 9903 modu restore sonrasÄ± oranlarÄ± set etsin
      setTimeout(() => {
        if (typeof handleKarar9903 === "function") {
          handleKarar9903();
        }
      }, 50);
    }




    // ============================================================
    // 7) MODÃœL 7 â€” FORM RESTORE / SESSION SYSTEM
    // ============================================================
    function initRestoreSystem() {
      const params = new URLSearchParams(window.location.search);
      const isViewMode = params.has("view") || params.has("id") || params.get("sekme") === "form" && currentBelgeJSData;

      // 1) input â€“ select restore (VIEW MODUNDA DEÄÄ°LSEK YAP)
      if (!isViewMode) {
        document.querySelectorAll("input, select, textarea").forEach(el => {
          if (el.type === "file") return;
          const name = el.name || el.id;
          const saved = sessionStorage.getItem(`form_${name}`);
          if (saved !== null) el.value = saved;
        });
      }

      // 2) deÄŸiÅŸiklikleri her zaman kaydet
      document.querySelectorAll("input, select, textarea").forEach(el => {
        if (el.type === "file") return;
        el.addEventListener("input", () => {
          const name = el.name || el.id;
          if (name) sessionStorage.setItem(`form_${name}`, el.value);
        });
      });

      // 3) belge no & tarih restore (VIEW MODUNDA DEÄÄ°LSEK YAP)
      if (!isViewMode) {
        const bNo = sessionStorage.getItem("belge_no");
        const bTarih = sessionStorage.getItem("belge_tarihi");

        if (bNo) {
          const el = document.querySelector("input[name='belge_no']");
          if (el) el.value = bNo;
        }
        if (bTarih) {
          const el = document.querySelector("input[name='belge_tarihi']");
          if (el) el.value = bTarih;
        }
        if (bNo || bTarih) {
          sessionStorage.removeItem("belge_no");
          sessionStorage.removeItem("belge_tarihi");
        }
      }

      // ğŸ”¥ 4) IMask restore sonrasÄ± MUTLAKA senkronize et
      setTimeout(() => {
        if (typeof safeSet === "function") {
          safeSet("katki_orani", getVal("katki_orani"));
          safeSet("vergi_orani", getVal("vergi_orani"));
          safeSet("diger_oran", getVal("diger_oran"));
        }
      }, 200);
    }




    // ============================================================
    // 8) MODÃœL 8 â€” INFO BLINK
    // ============================================================
    function initInfoBlink() {
      function blink(attempt = 0) {
        const icons = document.querySelectorAll(".info-icon-styled");
        if (icons.length > 0) {
          setTimeout(() => {
            icons.forEach(icon => icon.classList.add("blink"));
            setTimeout(() => icons.forEach(i => i.classList.remove("blink")), 7500);
          }, 800);
        } else if (attempt < 10) {
          setTimeout(() => blink(attempt + 1), 300);
        }
      }
      blink();
    }



    // ============================================================
    // 9) PROFIT TABLE MODÃœLÃœ
    // ============================================================
    function initProfitTable() {
      const { ayrTable, clearButton } = refs;
      if (ayrTable) {
        ayrTable.querySelectorAll('tbody input').forEach(input => {
          input.setAttribute('data-original-value', input.value);
          input.addEventListener('input', e => {
            if (!isProgrammaticChange) {
              if (typeof calculateTable === "function") calculateTable(e);
            }
          });
        });
        if (typeof calculateTable === "function") calculateTable();
      }
      if (clearButton) clearButton.addEventListener('click', clearProfitTable);
    }



    // ============================================================
    // 10) HESAPLA BUTONU
    // ============================================================
    function initCalculateButton() {
      const { calculateBtn } = refs;
      if (!calculateBtn) return;

      calculateBtn.addEventListener("click", () => {

        if (typeof calculateRatios === "function") calculateRatios();
        if (typeof calculateKVMatrah === "function") calculateKVMatrah();

        const karar = refs.kararSelect?.value || "";

        if (karar === "2025/9903") {
          if (typeof hesaplaKatkiTutari9903 === "function")
            hesaplaKatkiTutari9903({ advance: true });

          if (typeof goToStep7 === "function") goToStep7();
          return;
        }

        if (typeof calculateCariAndNext === "function") calculateCariAndNext();
      });
    }



    // ============================================================
    // 11) FORM SUBMIT MODÃœLÃœ
    // ============================================================
    function initFormSubmit() {
      const { form } = refs;
      if (!form) return;

      form.addEventListener("submit", e => {
        e.preventDefault();

        const map = [
          ["belge_no", "belge_no_hidden"],
          ["belge_tarihi", "belge_tarihi_hidden"],
          ["bolge", "bolge_hidden"]
        ];

        map.forEach(([name, hiddenId]) => {
          const input = form.querySelector(`[name="${name}"]`);
          const hidden = document.getElementById(hiddenId);
          if (input && hidden) input.value = hidden.value || input.value;
        });

        fetch(form.action, {
          method: "POST",
          body: new FormData(form)
        })
          .then(r => r.json())
          .then(data => {
            Swal.fire({
              icon: data.status,
              title: data.title,
              text: data.message,
              timer: 1500,
              showConfirmButton: false
            }).then(() => {
              if (data.status === "success" && data.redirect) {
                window.location.href = data.redirect;
              }
            });
          })
          .catch(err => {
            Swal.fire("Hata", "KayÄ±t sÄ±rasÄ±nda bir hata oluÅŸtu.", "error");
            console.error("Kaydetme hatasÄ±:", err);
          });
      });
    }



    // ============================================================
    // 12) AÅAMA YÃ–NETÄ°CÄ°SÄ°
    // ============================================================
    function initStepManager() {
      const params = new URLSearchParams(window.location.search);
      const isEditingDonem = params.get("editdonem") === "1";
      const viewId = params.get("view");
      const hash = window.location.hash;
      const cameFromNewDoc = sessionStorage.getItem("belge_no") !== null;

      let targetStep = parseInt(sessionStorage.getItem("last_step") || "1");

      if (isEditingDonem || cameFromNewDoc) {
        targetStep = 1;
        sessionStorage.removeItem("last_step");
      }

      else if (hash.startsWith("#step")) {
        const sn = hash.replace("#step", "");
        const fn = window["goToStep" + sn];

        if (typeof fn === "function") {
          fn();
          document.getElementById("step" + sn)?.scrollIntoView({ behavior: "smooth" });
          return;
        }
      }

      _updateStepDisplay(targetStep);
    }



    // ============================================================
    // 13) GLOBAL EVENT LÄ°STENERLAR (YARDIMCI)
    // ============================================================
    function initGlobalListeners() {
      const btn = document.getElementById("btn-step1-next");
      if (btn) btn.addEventListener("click", () => goToStep2());
    }



    // ============================================================
    // 14) TÃœM MODÃœLLERÄ° BAÅLAT
    // ============================================================
    toggleInvestmentIncomeInputs();
    
    // âš ï¸ HIDE ALL kaldÄ±rÄ±ldÄ±: JS hatasÄ± olursa en azÄ±ndan Step 1 gÃ¶rÃ¼nsÃ¼n diye.
    // initStepManager zaten gerekli olanÄ± aÃ§Ä±p diÄŸerlerini kapatÄ±yor.

    initMaskSystem();
    initRestoreSystem();
    initDefaultValues();
    init9903Logic();
    initClassicLogic();
    initTevsiLogic();
    initProfitTable();
    initCalculateButton();
    initFormSubmit();
    initStepManager();
    initInfoBlink();
    initGlobalListeners();

    // ============================================================
    // 15) BELGE Ä°NCELEME (VIEW) VERÄ° YÃœKLEME
    // ============================================================
    if (currentBelgeJSData && window.location.search.includes('sekme=form')) {
      console.log("ğŸ“‚ Belge verileri forma yÃ¼kleniyor...");
      
      const smartSet = (id, val) => {
        if (!id) return;
        const config = idConfig[id];
        if (config && config !== "none") {
          safeSet(id, val);
        } else {
          // name attribute'u veya ID ile bul
          const el = document.querySelector(`[name="${id}"], #${id}`);
          if (el) el.value = val ?? '';
        }
      };

      try {
        // Step 1
        const formattedDate = convertToInputDateFormat(currentBelgeJSData.belge_tarihi);
        smartSet('belge_tarihi', formattedDate);
        smartSet('karar', currentBelgeJSData.karar);
        
        if (typeof handleKarar9903 === "function") handleKarar9903();

        smartSet('program_turu', currentBelgeJSData.program_turu);
        smartSet('yatirim_turu1', currentBelgeJSData.yatirim_turu1);
        smartSet('yatirim_turu2', currentBelgeJSData.yatirim_turu2);
        smartSet('belge_no', currentBelgeJSData.belge_no);
        smartSet('vize_durumu', currentBelgeJSData.vize_durumu);
        
        if (typeof toggleInvestmentIncomeInputs === "function") toggleInvestmentIncomeInputs();

        // Step 2
        smartSet('donem', currentBelgeJSData.donem);
        smartSet('il', currentBelgeJSData.il);
        smartSet('osb', currentBelgeJSData.osb);
        smartSet('katki_orani', currentBelgeJSData.katki_orani);
        smartSet('vergi_orani', currentBelgeJSData.vergi_orani);
        smartSet('diger_oran', currentBelgeJSData.diger_oran);
        
        if (typeof setBolge === "function") setBolge();
        if (typeof setOranlar === "function") setOranlar();

        // Step 3
        smartSet('toplam_tutar', currentBelgeJSData.toplam_tutar);
        smartSet('cari_harcama_tutari', currentBelgeJSData.cari_harcama_tutari);
        smartSet('toplam_harcama_tutari', currentBelgeJSData.toplam_harcama_tutari);

        // Step 4
        smartSet('onceki_yatirim_katki_tutari', currentBelgeJSData.onceki_yatirim_katki_tutari);
        smartSet('onceki_diger_katki_tutari', currentBelgeJSData.onceki_diger_katki_tutari);

        // Step 6
        const chk = document.getElementById('useDetailedProfitRatios');
        if (chk) chk.checked = !!currentBelgeJSData.use_detailed_profit_ratios;
        
        ['brut_satis', 'ihracat', 'imalat', 'diger_faaliyet'].forEach(id => {
          smartSet(id, currentBelgeJSData[id]);
        });
        
        if (typeof toggleDetailedProfitInput === "function") toggleDetailedProfitInput();
        
        console.log("âœ… Belge verileri baÅŸarÄ±yla yÃ¼klendi.");
      } catch (err) {
        console.error("âŒ Veri yÃ¼kleme hatasÄ±:", err);
      }
    }

  });




  // Mevcut belge verisini forma bas (isteÄŸe baÄŸlÄ± kÄ±sa yardÄ±mcÄ±lar)
  const setVal = (sel, v) => { const el = document.querySelector(sel); if (el) el.value = v ?? ''; };
  const fmt = n => (n || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2 });



  // Gizli file input â†’ PDF parser
  const kvInput = document.getElementById('kvUploadInput');
  if (kvInput) kvInput.addEventListener('change', handleKVUpload);


  // AyrÄ±ntÄ±lÄ± KazanÃ§ Formu (gÃ¼venli dÄ±ÅŸa aktar + AJAX kayÄ±t)
  const ayrintiliKazancForm = document.getElementById('ayrintili-kazanc-form');
  if (ayrintiliKazancForm) {
    const exportButton = ayrintiliKazancForm.querySelector('button[name="export"]');

    ayrintiliKazancForm.addEventListener('submit', async (event) => {
      // EÄŸer "DÄ±ÅŸa Aktar" butonuna basÄ±ldÄ±ysa, normal form gÃ¶nderimine izin ver
      if (document.activeElement === exportButton) {
        ayrintiliKazancForm.removeAttribute('data-action');
        return; // preventDefault yapma â†’ tarayÄ±cÄ± indirmeyi baÅŸlatÄ±r
      }

      // ğŸ’¾ Normal kayÄ±t iÅŸlemi iÃ§in AJAX kullan
      event.preventDefault();
      const formData = new FormData(ayrintiliKazancForm);
      formData.append("action", "save");

      try {
        const response = await fetch(ayrintiliKazancForm.action, {
          method: 'POST',
          body: formData
        });

        const contentType = response.headers.get("content-type");
        if (response.ok && contentType && contentType.includes("application/json")) {
          const data = await response.json();
          if (typeof showSwalMessage === "function")
            showSwalMessage(data.status, data.title, data.message);
        } else {
          console.error('AyrÄ±ntÄ±lÄ± kazanÃ§ kaydetme hatasÄ±:', response.statusText);
          if (typeof showSwalMessage === "function")
            showSwalMessage('error', 'Hata!', 'Sunucu hatasÄ± oluÅŸtu.');
        }
      } catch (err) {
        console.error('AyrÄ±ntÄ±lÄ± kazanÃ§ kaydetme hatasÄ±:', err);
        if (typeof showSwalMessage === "function")
          showSwalMessage('error', 'Hata!', 'AÄŸ hatasÄ± oluÅŸtu.');
      }
    });
  }



  // MANUEL BELÄ°RLE: YatÄ±rÄ±ma KatkÄ± OranÄ±
  document.getElementById('btn-manual-katki')?.addEventListener('click', async () => {
    const { value: val } = await Swal.fire({
      title: 'YatÄ±rÄ±ma KatkÄ± OranÄ±nÄ± giriniz (%)',
      input: 'text',
      inputPlaceholder: 'Ã¶rn: 40',
      showCancelButton: true,
      confirmButtonText: 'Tamam',
      cancelButtonText: 'VazgeÃ§',
      inputValidator: (v) => {
        const n = parseFormattedNumber(v);
        if (isNaN(n) || n < 0 || n > 100) return '0-100 arasÄ±nda bir yÃ¼zde girin';
        return null;
      }
    });
    if (val !== undefined) {
      const n = parseFormattedNumber(val);
      document.getElementById('katki_orani').value = n.toString().replace('.', ',');
      sessionStorage.setItem('manual_katki', 'true');
      sessionStorage.setItem('manual_katki_value', String(n));
      // aÅŸaÄŸÄ±dakiler mevcut hesaplara dokunsun
      hesaplaKatkiTutari(); hesaplaDigerKatkiTutari(); hesaplaFiiliKatkiTutari(); hesaplaOncekiKatkiTutari(); hesaplaKalanVeEndeks();
    }
  });

  // MANUEL BELÄ°RLE: Vergi Ä°ndirim OranÄ±
  document.getElementById('btn-manual-vergi')?.addEventListener('click', async () => {
    const { value: val } = await Swal.fire({
      title: 'Vergi Ä°ndirim OranÄ±nÄ± giriniz (%)',
      input: 'text',
      inputPlaceholder: 'Ã¶rn: 80',
      showCancelButton: true,
      confirmButtonText: 'Tamam',
      cancelButtonText: 'VazgeÃ§',
      inputValidator: (v) => {
        const n = parseFormattedNumber(v);
        if (isNaN(n) || n < 0 || n > 100) return '0-100 arasÄ±nda bir yÃ¼zde girin';
        return null;
      }
    });
    if (val !== undefined) {
      const n = parseFormattedNumber(val);
      document.getElementById('vergi_orani').value = n.toString().replace('.', ',');
      sessionStorage.setItem('manual_vergi', 'true');
      sessionStorage.setItem('manual_vergi_value', String(n));
      updateDiscountedRatesUI();
    }
  });



  // === MANUEL BELÄ°RLE: Kurumlar Vergisi MatrahÄ± ===
  document.getElementById('btn-manual-matrah')?.addEventListener('click', async () => {
    const { value: val } = await Swal.fire({
      title: 'Kurumlar Vergisi MatrahÄ±nÄ± giriniz (TL)',
      input: 'text',
      inputPlaceholder: 'Ã¶rn: 2.500.000,00',
      showCancelButton: true,
      confirmButtonText: 'Kaydet',
      cancelButtonText: 'VazgeÃ§',
      reverseButtons: true,
      allowOutsideClick: false,
      customClass: {
        popup: 'swal2-green-theme-popup',
        confirmButton: 'swal2-green-theme-confirm-button',
        cancelButton: 'swal2-green-theme-cancel-button'
      },
      didOpen: () => {
        const inputEl = Swal.getInput();
        // Yazarken sadece sayÄ±, nokta ve virgÃ¼l izin ver
        inputEl.addEventListener('input', (e) => {
          e.target.value = e.target.value.replace(/[^\d.,]/g, '');
        });
      },
      inputValidator: (v) => {
        const n = parseFormattedNumber(v);
        if (isNaN(n) || n <= 0) return 'GeÃ§erli bir tutar giriniz.';
        return null;
      }
    });

    // --- KaydedildiÄŸinde biÃ§imlendir ---
    if (val !== undefined) {
      const n = parseFormattedNumber(val);
      const formatted = n
        .toFixed(2)
        .replace('.', ',')
        .replace(/\B(?=(\d{3})+(?!\d))/g, '.');

      document.getElementById('kv_matrah').value = formatted;
      sessionStorage.setItem('manual_kv_matrah', 'true');
      sessionStorage.setItem('manual_kv_matrah_value', String(n));

      Swal.fire('âœ… Kaydedildi', `Kurumlar Vergisi MatrahÄ±: <b>${formatted} TL</b> olarak gÃ¼ncellendi.`, 'success');
    }
  });







  // TeÅŸvik belgeleri silme (AJAX)
  document.querySelectorAll('.delete-tesvik-form').forEach(formElement => {
    formElement.addEventListener('submit', async (event) => {
      event.preventDefault();
      Swal.fire({
        title: "Emin misiniz?",
        text: "Bu belge silinecek. Bu iÅŸlem geri alÄ±namaz!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "Evet, sil!",
        cancelButtonText: "Ä°ptal"
      }).then(async (result) => {
        if (!result.isConfirmed) return;
        try {
          const response = await fetch(formElement.action, {
            method: 'POST',
            body: new FormData(formElement)
          });
          const data = await response.json();
          showSwalMessage(data.status, data.title, data.message);
          if (data.status === "success") {
            formElement.closest('tr')?.remove();
          }
        } catch (err) {
          console.error('Belge silme hatasÄ±:', err);
          showSwalMessage('error', 'Hata!', 'Belge silinirken bir sorun oluÅŸtu.');
        }
      });
    });
  });

  // --- OTO HESAPLAMA BAÄLAYICILARI (SAFE LINK) ---
  // Sayfa yÃ¼klendiÄŸinde hesaplama fonksiyonlarÄ±nÄ± event'lere baÄŸlar
  document.addEventListener("DOMContentLoaded", () => {
      const inputs = ["onceki_yatirim_katki_tutari", "onceki_diger_katki_tutari", "toplam_tutar", "katki_orani"];
      
      inputs.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
              el.addEventListener("input", () => {
                  if (typeof hesaplaOncekiKatkiTutari === "function") hesaplaOncekiKatkiTutari();
                  if (typeof hesaplaKalanVeEndeks === "function") hesaplaKalanVeEndeks(); 
              });
              
              // EÄŸer IMask varsa 'accept' eventine de baÄŸla (daha gÃ¼venilir)
              if (typeof maskMap !== 'undefined' && maskMap[id]) {
                  maskMap[id].on("accept", () => {
                      if (typeof hesaplaOncekiKatkiTutari === "function") hesaplaOncekiKatkiTutari();
                      if (typeof hesaplaKalanVeEndeks === "function") hesaplaKalanVeEndeks();
                  });
              }
          }
      });
  });
</script>

    </div><!-- /card-body -->
  </div><!-- /card -->
</div><!-- /container -->

{% endblock %}
