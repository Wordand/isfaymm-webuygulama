{% extends "layout.html" %}
{% block title %}Gecikme ZammÄ± Hesaplama{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0"><i class="bi bi-hourglass-split me-2"></i>Gecikme ZammÄ± Hesaplama</h4>
                </div>
                <div class="card-body p-4">

                    <form id="gecikmeForm">
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="borcTuru" class="form-label fw-bold">BorÃ§ TÃ¼rÃ¼</label>
                                <select id="borcTuru" class="form-select" required>
                                    <option value="vergi_asli" selected>Vergi AslÄ±</option>
                                    <option value="vergi_ziyasi">Vergi ZiyaÄ± CezasÄ±</option>
                                    <option value="mahkeme_cezasi">Mahkeme CezasÄ±</option>
                                    <option value="usulsuzluk">UsulsÃ¼zlÃ¼k CezasÄ±</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="borc" class="form-label fw-bold">BorÃ§ TutarÄ± (TL)</label>
                                <div class="input-group">
                                    <input type="number" id="borc" class="form-control" placeholder="0.00" step="0.01" required>
                                    <span class="input-group-text">â‚º</span>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="vade" class="form-label fw-bold">Vade Tarihi</label>
                                <input type="date" id="vade" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label for="odeme" class="form-label fw-bold">Ã–deme Tarihi</label>
                                <input type="date" id="odeme" class="form-control" required>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-danger w-100 btn-lg" id="hesaplaBtn">
                            <i class="bi bi-calculator me-2"></i> Gecikme ZammÄ±nÄ± Hesapla
                        </button>

                        <hr class="my-4">

                        <!-- SonuÃ§ AlanÄ± -->
                        <div id="sonucAlani" style="display:none;">
                            <h5 class="fw-bold text-danger mb-3">Hesaplama Sonucu</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped">
                                    <tbody>
                                        <tr>
                                            <th class="w-50">Hesaplanan Gecikme ZammÄ±</th>
                                            <td class="text-end text-danger fw-bold fs-5" id="resGecikme">0,00 â‚º</td>
                                        </tr>
                                        <tr>
                                            <th>Toplam Ã–denecek Tutar (BorÃ§ + Zam)</th>
                                            <td class="text-end fw-bold fs-4 text-dark" id="resToplam">0,00 â‚º</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </form>

                    <div class="mt-3">
                        <div class="alert alert-light border small text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            <strong>Bilgi:</strong> Hesaplama 6183 sayÄ±lÄ± Kanun md.51 kapsamÄ±nda yapÄ±lÄ±r. UsulsÃ¼zlÃ¼k (md. 352) ve Ã–zel UsulsÃ¼zlÃ¼k (md. 353) cezalarÄ±na gecikme zammÄ± uygulanmaz.
                        </div>
                    </div>

                </div>
            </div>

            <!-- GeÃ§miÅŸ Hesaplamalar -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">ðŸ“‹ Son Hesaplamalar</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0" id="logTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">BorÃ§ TÃ¼rÃ¼</th>
                                    <th>Tutar</th>
                                    <th>Vade / Ã–deme</th>
                                    <th>Gecikme ZammÄ±</th>
                                    <th>Ä°ÅŸlem</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <div class="mt-4">
        {% include "partials/tax_disclaimer.html" %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const borcTuruSelect = document.getElementById("borcTuru");
    
    // VarsayÄ±lan tarihleri ayarla
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("odeme").value = today;

    document.getElementById("gecikmeForm").addEventListener("submit", async function(e) {
        e.preventDefault();

        const borc = parseFloat(document.getElementById("borc").value);
        const borcTuru = borcTuruSelect.value;
        const vade = document.getElementById("vade").value;
        const odeme = document.getElementById("odeme").value;
        const logTableBody = document.querySelector("#logTable tbody");
        const sonucAlani = document.getElementById("sonucAlani");

        if (borc <= 0) {
            Swal.fire("UyarÄ±", "BorÃ§ tutarÄ± 0'dan bÃ¼yÃ¼k olmalÄ±dÄ±r.", "warning");
            return;
        }

        if (borcTuru === "usulsuzluk") {
            Swal.fire("Bilgi", "UsulsÃ¼zlÃ¼k cezalarÄ±na gecikme zammÄ± uygulanmaz.", "info");
            return;
        }

        try {
            const response = await fetch("/gecikme-zammi-hesapla", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ borc, vade, odeme, borc_turu: borcTuru })
            });

            if (!response.ok) throw new Error("Sunucu hatasÄ±");
            const data = await response.json();

            // SonuÃ§larÄ± gÃ¶ster
            sonucAlani.style.display = "block";
            const gecikme = parseFloat(data.gecikme_zammi);
            const toplam = parseFloat(data.toplam_borc);

            document.getElementById("resGecikme").textContent = gecikme.toLocaleString("tr-TR", {minimumFractionDigits:2}) + " â‚º";
            document.getElementById("resToplam").textContent = toplam.toLocaleString("tr-TR", {minimumFractionDigits:2}) + " â‚º";

            // Tabloya ekle (Log)
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="ps-3">${borcTuruSelect.options[borcTuruSelect.selectedIndex].text}</td>
                <td>${borc.toLocaleString("tr-TR", {minimumFractionDigits:2})} â‚º</td>
                <td class="small">${vade} <br> ${odeme}</td>
                <td class="fw-bold text-danger">${gecikme.toLocaleString("tr-TR", {minimumFractionDigits:2})} â‚º</td>
                <td><button class="btn btn-sm btn-outline-secondary py-0" onclick="this.closest('tr').remove()"><i class="bi bi-x"></i></button></td>
            `;
            logTableBody.prepend(tr);

        } catch (err) {
            console.error(err);
            Swal.fire("Hata", "Hesaplama yapÄ±lamadÄ±. LÃ¼tfen tarihleri kontrol ediniz (Vade > Ã–deme olamaz).", "error");
        }
    });

    // BorÃ§ tÃ¼rÃ¼ deÄŸiÅŸince uyarÄ±
    borcTuruSelect.addEventListener("change", function() {
        if (this.value === "usulsuzluk") {
            Swal.fire("Bilgi", "UsulsÃ¼zlÃ¼k cezalarÄ± iÃ§in gecikme zammÄ± hesaplanmaz, ancak tarh tarihinden itibaren indirim sÃ¼resi geÃ§tikten sonra tahsil edilirse Gecikme Faizi uygulanabilir. Bu araÃ§ sadece Gecikme ZammÄ± hesaplar.", "info");
        }
    });
});
</script>
{% endblock %}
