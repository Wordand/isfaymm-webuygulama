{# tesvik.html #}

<table class="table table-striped" id="tesvik-belgeleri-table"> {# ID eklendi #}
  <thead>
    <tr>
      <th>ID</th>
      <th>Belge No</th>
      <th>Belge Tarihi</th>
      <th>Tamamlama Vizesi Durumu</th>
      <th>Cari Toplam Katkı</th>
      <th>Genel Toplam Katkı</th>
      <th>İşlemler</th>
    </tr>
  </thead>
  <tbody>
    {% for d in docs %}
    <tr>
      <td>{{ d.id }}</td>
      <td>{{ d.belge_no }}</td>
      <td>{{ d.belge_tarihi }}</td>
      <td>{{ d.vize_durumu }}</td>
      <td>{{ '%.2f'|format(d.cari_toplam_katki) }}</td>
      <td>{{ '%.2f'|format(d.genel_toplam_katki) }}</td>
      <td>
        
        <a href="?sekme=tesvik&view={{ d.id }}" class="btn btn-sm btn-info">Detay</a>
        <a href="{{ url_for('indirimlikurumlar.index', sekme='form', view=d.id) }}" class="btn btn-sm btn-warning me-1">Güncelle</a>
        <form class="delete-tesvik-form d-inline" action="{{ url_for('indirimlikurumlar.delete_tesvik', doc_id=d.id) }}"
          method="post">
          <button type="submit" class="btn btn-sm btn-danger">Sil</button>
        </form>
        <a href="{{ url_for('indirimlikurumlar.download_tesvik_pdf', doc_id=d.id) }}"
          class="btn btn-sm btn-secondary">PDF İndir</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% if edit_doc %}
<hr>
<h4 class="mt-4 text-center">{{ edit_doc.id }} nolu Belge Detayı</h4>

{# PDF şablonundaki macro ile aynı yapıyı kullanıyoruz #}
{% macro row(label, value) -%}
<tr>
  <td class="label">{{ label }}</td>
  <td class="value">{{ value }}</td>
</tr>
{%- endmacro %}

<table class="table table-bordered mx-auto" style="max-width:600px;">
  <tbody>
    {{ row("Teşvik Belgesi Numarası", edit_doc.belge_no) }}
    {{ row("Belge Tarihi", edit_doc.belge_tarihi) }}
    {{ row("Karar", edit_doc.karar) }}
    {{ row("Yatırıma Başlama Tarihi", edit_doc.belge_tarihi) }}
    {{ row("Yatırım Türü 1", edit_doc.yatirim_turu1) }}
    {{ row("Yatırım Türü 2", edit_doc.yatirim_turu2) }}
    {{ row("Tamamlama Vizesi Durumu", edit_doc.vize_durumu) }}
    {{ row("Toplam Yatırım Tutarı", edit_doc.toplam_tutar | default("-", true) ) }}
    {{ row("Yatırıma Katkı Oranı", edit_doc.katki_orani is not none and (edit_doc.katki_orani ~ "%") or "-") }}
    {{ row("Vergi İndirim Oranı", edit_doc.vergi_orani is not none and (edit_doc.vergi_orani ~ "%") or "-") }}
    {{ row("Yatırımın Yapıldığı Bölge", edit_doc.bolge | default("-", true)) }}
    {{ row("Diğer Oran", edit_doc.diger_oran is not none and (edit_doc.diger_oran ~ "%") or "-") }}
    {{ row("Toplam Katkı Tutarı", edit_doc.katki_tutari | default("-", true)) }}
    {{ row("Diğer Faaliyet Katkı Tutarı", edit_doc.diger_katki_tutari | default("-", true)) }}
    {{ row("Cari Harcama Tutarı", edit_doc.cari_harcama_tutari | default("-", true)) }}
    {{ row("Toplam Harcama Tutarı", edit_doc.toplam_harcama_tutari | default("-", true)) }}
    {{ row("Fiili Katkı Tutarı", edit_doc.fiili_katki_tutari | default("-", true)) }}
    {{ row("Endekslenmiş Katkı Tutarı", edit_doc.endeks_katki_tutari | default("-", true)) }}
    {{ row("Önceki Yatırım Katkı Tutarı", edit_doc.onceki_yatirim_katki_tutari | default("-", true)) }}
    {{ row("Önceki Diğer Katkı Tutarı", edit_doc.onceki_diger_katki_tutari | default("-", true)) }}
    {{ row("Önceki Toplam Katkı", edit_doc.onceki_katki_tutari | default("-", true)) }}
    {{ row("Cari Yatırım Katkı Tutarı", edit_doc.cari_yatirim_katki | default("-", true)) }}
    {{ row("Cari Diğer Katkı Tutarı", edit_doc.cari_diger_katki | default("-", true)) }}
    {{ row("Cari Toplam Katkı Tutarı", edit_doc.cari_toplam_katki | default("-", true)) }}
    {{ row("Genel Toplam Katkı Tutarı", edit_doc.genel_toplam_katki | default("-", true)) }}
  </tbody>
</table>
{% endif %}

{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.delete-tesvik-form').forEach(form => {
      form.addEventListener('submit', async ev => {
        ev.preventDefault();

        const result = await Swal.fire({
          title: "Emin misiniz?",
          text: "Bu belge silinecek. Bu işlem geri alınamaz!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Evet, sil!",
          cancelButtonText: "İptal"
        });

        if (!result.isConfirmed) return;

        try {
          const resp = await fetch(form.action, {
            method: 'POST',
            body: new FormData(form)
          });
          const data = await resp.json();

          // Başarı / hata mesajını toast ile göster
          Swal.fire({
            icon: data.status,
            title: data.title,
            text: data.message,
            toast: true,
            position: 'top-end',
            timer: 2000,
            showConfirmButton: false
          });

          if (data.status === 'success') {
            // Satırı DOM'dan kaldır
            form.closest('tr')?.remove();
          }

        } catch (err) {
          Swal.fire({
            icon: 'error',
            title: 'Hata',
            text: 'Silme işlemi sırasında bir hata oluştu.'
          });
        }
      });
    });
  });
</script>
{% endblock %}