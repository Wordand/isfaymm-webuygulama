{% extends "layout.html" %}
{% block title %}TeÅŸvik Belgeleri | Ä°SFA YMM{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  <h3 class="mb-4 text-center text-primary fw-bold">ðŸ“„ TeÅŸvik Belgelerim</h3>

  <!-- ========================= -->
  <!-- ðŸ”· TEÅžVÄ°K BELGELERÄ° TABLOSU -->
  <!-- ========================= -->
  <div class="table-responsive shadow-sm rounded">
    <table class="table table-hover align-middle">
      <thead class="table-primary text-center">
        <tr>
          <th>Belge No</th>
          <th>Belge Tarihi</th>
          <th>Karar</th>
          <th>Toplam YatÄ±rÄ±m</th>
          <th>Ä°ÅŸlemler</th>
        </tr>
      </thead>

      <tbody>
        {% for d in docs %}

        <!-- ========================== -->
        <!-- ðŸ”½ Belge SatÄ±rÄ± (Accordion Trigger) -->
        <!-- ========================== -->
        <tr class="text-center accordion-toggle"
            data-bs-toggle="collapse"
            data-bs-target="#belge_{{ d.id }}"
            style="cursor:pointer;">
          <td class="fw-bold">{{ d.belge_no }}</td>
          <td>{{ d.belge_tarihi | safe_date }}</td>
          <td>{{ d.karar }}</td>
          <td>{{ d.toplam_tutar | tlformat }}</td>

          <td>
            <div class="btn-group btn-group-sm">

              <!-- GÃ¼ncelle -->
              <a href="{{ url_for('indirimlikurumlar.index', sekme='form', view=d.id) }}"
                 class="btn btn-warning">GÃ¼ncelle</a>

              <!-- PDF -->
              <a href="{{ url_for('indirimlikurumlar.download_tesvik_pdf', doc_id=d.id) }}"
                 class="btn btn-secondary">PDF</a>

              <!-- Sil -->
              <form method="post"
                    action="{{ url_for('indirimlikurumlar.delete_tesvik', doc_id=d.id) }}"
                    class="delete-tesvik-form d-inline">
                <button class="btn btn-danger">Sil</button>
              </form>

            </div>
          </td>
        </tr>

        <!-- ========================== -->
        <!-- ðŸ”½ Belge AltÄ± â€” YÄ±llara GÃ¶re DÃ¶nem Akordiyonu -->
        <!-- ========================== -->
        <tr>
          <td colspan="5" class="p-0">
            <div id="belge_{{ d.id }}" class="collapse">

              <div class="p-3 bg-light border-top">

                <h6 class="fw-bold mb-2">ðŸ“™ DÃ¶nemler</h6>

                {% set groups = d.donemler | groupby("hesap_donemi") %}

                {% for year, items in groups %}
                <div class="mt-2">

                  <!-- â–º YÄ±l Butonu -->
                  <button class="btn btn-outline-primary w-100 text-start"
                          data-bs-toggle="collapse"
                          data-bs-target="#yil_{{ d.id }}_{{ year }}">
                    {{ year }} DÃ¶nemleri
                  </button>

                  <!-- â–º YÄ±l Ä°Ã§eriÄŸi -->
                  <div id="yil_{{ d.id }}_{{ year }}" class="collapse ms-3 mt-2">

                    {% for donem in items %}
                    <div class="border rounded p-2 bg-white d-flex justify-content-between align-items-center mb-2"
                         style="min-width:260px;">

                      <span>{{ donem.hesap_donemi }} - {{ donem.donem_turu }}</span>

                      <div class="btn-group btn-group-sm">

                        <!-- DÃ¶nemi Formda DÃ¼zenle -->
                        <a href="{{ url_for('indirimlikurumlar.edit_tesvik_kullanim',
                                            belge_no=d.belge_no,
                                            yil=donem.hesap_donemi,
                                            turu=donem.donem_turu) }}"
                           class="btn btn-warning">
                          <i class="bi bi-pencil-square"></i>
                        </a>

                        <!-- DÃ¶nem Detay (Modal) -->
                        <button class="btn btn-outline-primary view-donem"
                                data-belge="{{ d.belge_no }}"
                                data-yil="{{ donem.hesap_donemi }}"
                                data-turu="{{ donem.donem_turu }}">
                          <i class="bi bi-eye"></i>
                        </button>

                        <!-- Klonla -->
                        <button class="btn btn-outline-secondary clone-donem"
                                data-belge="{{ d.belge_no }}"
                                data-yil="{{ donem.hesap_donemi }}"
                                data-turu="{{ donem.donem_turu }}">
                          <i class="bi bi-layers"></i>
                        </button>

                        <!-- Sil -->
                        <button class="btn btn-outline-danger delete-donem"
                                data-belge="{{ d.belge_no }}"
                                data-yil="{{ donem.hesap_donemi }}"
                                data-turu="{{ donem.donem_turu }}">
                          <i class="bi bi-trash"></i>
                        </button>

                      </div>

                    </div>
                    {% endfor %}

                  </div>

                </div>
                {% endfor %}

                <!-- Yeni DÃ¶nem -->
                <button class="btn btn-outline-success btn-sm mt-3 add-donem-btn"
                        data-belge="{{ d.belge_no }}">
                  + Yeni DÃ¶nem Ekle
                </button>

              </div>

            </div>
          </td>
        </tr>

        {% endfor %}
      </tbody>

    </table>
  </div>

</div>

<!-- Modal -->
<div class="modal fade" id="donemModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">DÃ¶nem DetayÄ±</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="donemModalContent">YÃ¼kleniyor...</div>
    </div>
  </div>
</div>

{% endblock %}


{% block extra_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {

    // ============================
    // ðŸ—‘ Belge Silme
    // ============================
    document.querySelectorAll(".delete-tesvik-form").forEach(form => {
      form.addEventListener("submit", async e => {
        e.preventDefault();

        const ok = await Swal.fire({
          title: "Emin misiniz?",
          text: "Bu belge tamamen silinecek!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Evet, sil",
          cancelButtonText: "VazgeÃ§"
        });

        if (!ok.isConfirmed) return;

        const resp = await fetch(form.action, { method: "POST", body: new FormData(form) });
        const data = await resp.json();

        Swal.fire(data.title, data.message, data.status);
        if (data.status === "success") location.reload();
      });
    });



    document.querySelectorAll(".add-donem-btn").forEach(btn => {
      btn.addEventListener("click", async () => {

        const { value } = await Swal.fire({
          title: "Yeni DÃ¶nem",
          input: "text",
          inputLabel: "Ã–rn: 2025 - Kurumlar",
          showCancelButton: true
        });

        if (!value) return;

        const res = await fetch("/indirimlikurumlar/clone_tesvik_donem", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ belge_no: btn.dataset.belge, donem_text: value })
        });

        const data = await res.json();
        Swal.fire(data.title, data.message, data.status);
        if (data.status === "success") location.reload();

      });
    });


    document.querySelectorAll(".delete-donem").forEach(btn => {
      btn.addEventListener("click", async () => {

        const belge = btn.dataset.belge;
        const yil = btn.dataset.yil;
        const tur = btn.dataset.turu;

        if (!tur) {
          Swal.fire("Hata", "DÃ¶nem tÃ¼rÃ¼ alÄ±namadÄ±!", "error");
          return;
        }

        const ok = await Swal.fire({
          title: "DÃ¶nem silinsin mi?",
          text: `${belge} (${yil} - ${tur})`,
          icon: "warning",
          showCancelButton: true
        });

        if (!ok.isConfirmed) return;

        const resp = await fetch("/indirimlikurumlar/delete_tesvik_donem", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            belge_no: belge,
            hesap_donemi: yil,
            donem_turu: tur
          })
        });

        const data = await resp.json();

        Swal.fire(data.title, data.message, data.status);

        if (data.status === "success") location.reload();
      });
    });



    document.querySelectorAll(".clone-donem").forEach(btn => {
      btn.addEventListener("click", async () => {

        const belge = btn.dataset.belge;
        const yil = btn.dataset.yil;
        const tur = btn.dataset.turu;

        // Ã–nce uyarÄ±
        const ok = await Swal.fire({
          title: "DÃ¶nemi Klonla?",
          text: `${belge} (${yil}) dÃ¶nemi kopyalanacak.`,
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "Evet, klonla",
          cancelButtonText: "VazgeÃ§"
        });

        if (!ok.isConfirmed) return;

        // âœ” DOÄžRU OLAN â€” fetch yapÄ±lÄ±yor
        const res = await fetch("/indirimlikurumlar/clone_tesvik_donem", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            belge_no: belge,
            donem_text: `${yil} - ${tur}`
          })
        });

        const data = await res.json();

        Swal.fire(data.title, data.message, data.status);

        if (data.status === "success") location.reload();
      });
    });


    document.querySelectorAll(".view-donem").forEach(btn => {
      btn.addEventListener("click", async () => {

        const belge = btn.dataset.belge;
        const yil = btn.dataset.yil;
        const tur = btn.dataset.turu;

        // ðŸ”¥ KRÄ°TÄ°K DÃœZELTME 1: apiUrl'yi tanÄ±mla ve fetch Ã§aÄŸrÄ±sÄ±nÄ± yap
        const apiUrl = `/indirimlikurumlar/api/get_tesvik_kullanim/${belge}/${yil}/${tur}`;
        const res = await fetch(apiUrl);

        // KRÄ°TÄ°K DÃœZELTME 2: 404/HTML hatasÄ±nÄ± yakalamak iÃ§in kontrol
        if (!res.ok) {
          Swal.fire("Hata", "Sunucuya ulaÅŸÄ±lamadÄ± veya API hatasÄ± oluÅŸtu (Hata Kodu: " + res.status + ")", "error");
          return;
        }

        const data = await res.json();

        if (data.status !== "success") {
          Swal.fire("Hata", data.message, "error");
          return;
        }

        document.getElementById("donemModalContent").innerHTML = data.html;
        new bootstrap.Modal(document.getElementById("donemModal")).show();
      });
    });

  });
</script>
{% endblock %}