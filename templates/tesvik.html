{# tesvik.html #}

<table class="table table-striped align-middle" id="tesvik-belgeleri-table">
  <thead>
    <tr>
      <th>Belge No</th>
      <th>Belge Tarihi</th>
      <th>Karar</th>
      <th>Toplam YatÄ±rÄ±m TutarÄ±</th>
      <th>Tamamlama Vizesi Durumu</th>
      <th>Cari Toplam KatkÄ±</th>
      <th>Genel Toplam KatkÄ±</th>
      <th>Ä°ÅŸlemler</th>
    </tr>
  </thead>
  <tbody>
    {% for d in docs %}
    <tr>
      <td>{{ d.belge_no }}</td>
      <td>{{ d.belge_tarihi | safe_date }}</td>
      <td>{{ d.karar }}</td>
      <td>{{ d.toplam_tutar | tlformat }}</td>
      <td>{{ d.vize_durumu }}</td>
      <td>{{ d.cari_toplam_katki | tlformat }}</td>
      <td>{{ d.genel_toplam_katki | tlformat }}</td>
      <td>
        <div class="btn-group btn-group-sm">
          <a href="{{ url_for('indirimlikurumlar.index', sekme='tesvik', view=d.id) }}" class="btn btn-info">Detay</a>


          <a href="{{ url_for('indirimlikurumlar.index', sekme='form', view=d.id|int) }}"
            class="btn btn-warning">GÃ¼ncelle</a>
          <a href="{{ url_for('indirimlikurumlar.download_tesvik_pdf', doc_id=d.id|int) }}"
            class="btn btn-secondary">PDF Ä°ndir</a>
          <form class="delete-tesvik-form d-inline"
            action="{{ url_for('indirimlikurumlar.delete_tesvik', doc_id=d.id|int) }}" method="post">
            <button type="submit" class="btn btn-danger">Sil</button>
          </form>
        </div>
      </td>
    </tr>
    {# ğŸ”¹ Yeni satÄ±r: belgeye ait dÃ¶nemleri gÃ¶ster #}
    <tr class="bg-light">
      <td colspan="8">
        <div class="p-2">
          <strong>DÃ¶nemler:</strong>
          <div class="d-flex flex-wrap gap-2 mt-2">
            {% for donem in d.donemler %}
            <div class="border rounded p-2 bg-white d-flex align-items-center justify-content-between"
              style="min-width:230px;">
              <span>{{ donem.hesap_donemi }} - {{ donem.donem_turu }}</span>
              <div class="btn-group btn-group-sm">
                <a href="{{ url_for('indirimlikurumlar.edit_tesvik_kullanim', belge_no=d.belge_no, yil=donem.hesap_donemi, turu=donem.donem_turu) }}"
                  class="btn btn-outline-primary" title="DÃ¶nemi GÃ¶rÃ¼ntÃ¼le"><i class="bi bi-eye"></i></a>

                <button class="btn btn-outline-secondary clone-donem" data-belge="{{ d.belge_no }}"
                  data-yil="{{ donem.hesap_donemi }}" title="Bu DÃ¶nemi Klonla">
                  <i class="bi bi-layers"></i>
                </button>

                <button class="btn btn-outline-danger delete-donem" data-belge="{{ d.belge_no }}"
                  data-yil="{{ donem.hesap_donemi }}" title="Sil">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
            {% else %}
            <span class="text-muted">HenÃ¼z dÃ¶nem eklenmemiÅŸ.</span>
            {% endfor %}
          </div>

          <button class="btn btn-outline-danger btn-sm mt-3 add-donem-btn" data-belge="{{ d.belge_no }}">
            <i class="bi bi-layers"></i> Yeni DÃ¶nem Ekle
          </button>
        </div>
      </td>
    </tr>

    {% endfor %}
  </tbody>
</table>

{% if edit_doc %}
<hr>
<h4 class="mt-4 text-center text-primary">{{ edit_doc.belge_no or edit_doc.id }} Nolu Belge DetayÄ±</h4>

{% macro row(label, value) -%}
<tr>
  <td class="fw-semibold text-end" style="width:45%;">{{ label }}</td>
  <td class="text-start">{{ value or '-' }}</td>
</tr>
{%- endmacro %}

<div class="table-responsive mx-auto" style="max-width:700px;">
  <table class="table table-bordered table-hover align-middle">
    <tbody>
      {{ row("TeÅŸvik Belgesi NumarasÄ±", edit_doc.belge_no) }}
      {{ row("Belge Tarihi", edit_doc.belge_tarihi) }}
      {{ row("Karar", edit_doc.karar) }}
      {{ row("Program TÃ¼rÃ¼", edit_doc.program_turu) }}
      {{ row("YatÄ±rÄ±ma BaÅŸlama Tarihi", edit_doc.belge_tarihi) }}
      {{ row("YatÄ±rÄ±m TÃ¼rÃ¼ 1", edit_doc.yatirim_turu1) }}
      {{ row("YatÄ±rÄ±m TÃ¼rÃ¼ 2", edit_doc.yatirim_turu2) }}
      {{ row("Tamamlama Vizesi Durumu", edit_doc.vize_durumu) }}
      {{ row("Toplam YatÄ±rÄ±m TutarÄ±", edit_doc.toplam_tutar | tlformat) }}
      {{ row("YatÄ±rÄ±ma KatkÄ± OranÄ±", (edit_doc.katki_orani|string + ' %') if edit_doc.katki_orani is not none else '-')
      }}
      {{ row("Vergi Ä°ndirim OranÄ±", (edit_doc.vergi_orani|string + ' %') if edit_doc.vergi_orani is not none else '-')
      }}
      {{ row("DiÄŸer Oran", (edit_doc.diger_oran|string + ' %') if edit_doc.diger_oran is not none else '-') }}
      {{ row("YatÄ±rÄ±mÄ±n YapÄ±ldÄ±ÄŸÄ± BÃ¶lge", edit_doc.bolge) }}
      {{ row("Cari YÄ±lda Fiilen GerÃ§ekleÅŸen Harcama", edit_doc.cari_harcama_tutari | tlformat) }}
      {{ row("Toplam KatkÄ± TutarÄ±", edit_doc.katki_tutari | tlformat) }}
      {{ row("DiÄŸer Faaliyet KatkÄ± TutarÄ±", edit_doc.diger_katki_tutari | tlformat) }}
      {{ row("Fiili KatkÄ± TutarÄ±", edit_doc.fiili_katki_tutari | tlformat) }}
      {{ row("EndekslenmiÅŸ KatkÄ± TutarÄ±", edit_doc.endeks_katki_tutari | tlformat) }}
      {{ row("Ã–nceki YatÄ±rÄ±m KatkÄ± TutarÄ±", edit_doc.onceki_yatirim_katki_tutari | tlformat) }}
      {{ row("Ã–nceki DiÄŸer KatkÄ± TutarÄ±", edit_doc.onceki_diger_katki_tutari | tlformat) }}
      {{ row("Ã–nceki Toplam KatkÄ±", edit_doc.onceki_katki_tutari | tlformat) }}
      {{ row("Cari YatÄ±rÄ±m KatkÄ± TutarÄ±", edit_doc.cari_yatirim_katki | tlformat) }}
      {{ row("Cari DiÄŸer KatkÄ± TutarÄ±", edit_doc.cari_diger_katki | tlformat) }}
      {{ row("Cari Toplam KatkÄ± TutarÄ±", edit_doc.cari_toplam_katki | tlformat) }}
      {{ row("Genel Toplam KatkÄ± TutarÄ±", edit_doc.genel_toplam_katki | tlformat) }}
    </tbody>
  </table>
</div>

<div class="text-center mt-4">
  <a href="?sekme=tesvik" class="btn btn-secondary px-4">â† Listeye DÃ¶n</a>
  <a href="{{ url_for('indirimlikurumlar.index', sekme='form', view=edit_doc.id|int) }}"
    class="btn btn-warning px-4">GÃ¼ncelle</a>
  <a href="{{ url_for('indirimlikurumlar.download_tesvik_pdf', doc_id=edit_doc.id|int) }}"
    class="btn btn-primary px-4">PDF Ä°ndir</a>
</div>
{% endif %}

{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.delete-tesvik-form').forEach(form => {
      form.addEventListener('submit', async ev => {
        ev.preventDefault();

        const result = await Swal.fire({
          title: "Emin misiniz?",
          text: "Bu belge silinecek. Bu iÅŸlem geri alÄ±namaz!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Evet, sil!",
          cancelButtonText: "Ä°ptal"
        });

        if (!result.isConfirmed) return;

        try {
          const resp = await fetch(form.action, {
            method: 'POST',
            body: new FormData(form)
          });
          const data = await resp.json();

          Swal.fire({
            icon: data.status,
            title: data.title,
            text: data.message,
            toast: true,
            position: 'top-end',
            timer: 2000,
            showConfirmButton: false
          });

          if (data.status === 'success') {
            form.closest('tr')?.remove();
          }

        } catch (err) {
          Swal.fire({
            icon: 'error',
            title: 'Hata',
            text: 'Silme iÅŸlemi sÄ±rasÄ±nda bir hata oluÅŸtu.'
          });
        }
      });
    });
  });
</script>
{% endblock %}